import{_ as g,o as l,c as d,a as u,F as x,D as T,p as W,t as S,e as N,i as E,r as v,m as q,E as H,G as M,H as O,I as B,b as $,n as C,l as I,y as J,J as A,g as D,j as R}from"./CC1fXFig.js";const j={class:"chat-sidebar"},L=["onClick"],P={class:"chat-name"},F={class:"chat-preview"},V={__name:"ChatSidebar",props:{chats:{type:Array,required:!0},activeChatId:{type:[String,Number],required:!0}},setup(m){return(h,n)=>(l(),d("aside",j,[n[0]||(n[0]=u("h2",{class:"sidebar-header"},"Cartório 360",-1)),(l(!0),d(x,null,T(m.chats,t=>(l(),d("button",{key:t.id,class:W(["chat-item",{active:t.id===m.activeChatId}]),onClick:r=>h.$emit("select",t.id)},[u("span",P,S(t.name.split("_").slice(1).join("_")),1),u("span",F,S(t.preview),1)],10,L))),128))]))}},z=g(V,[["__scopeId","data-v-5ea6e85d"]]),K={class:"chat-history"},Q=["innerHTML"],U={__name:"ChatHistory",props:{messages:Array},setup(m){const h=/(https?:\/\/[^\s]+)/g,n=N("userName");function t(r){return r.replace(h,c=>`<a href="${c}" target="_blank" class="chat-link">${c}</a>`)}return(r,c)=>(l(),d("div",K,[(l(!0),d(x,null,T(m.messages,(o,_)=>(l(),d("div",{key:_,class:W(["chat-bubble",o.from===E(n)?"from-user":"from-server"]),innerHTML:t(o.text)},null,10,Q))),128))]))}},G=g(U,[["__scopeId","data-v-21f8e4e4"]]),X={class:"chat-input-area"},Y={__name:"ChatInput",emits:["send"],setup(m,{emit:h}){const n=h,t=v("");function r(){t.value.trim()&&(n("send",t.value.trim()),t.value="")}return(c,o)=>(l(),d("footer",X,[q(u("input",{"onUpdate:modelValue":o[0]||(o[0]=_=>t.value=_),class:"chat-input",placeholder:"Digite sua mensagem…",onKeyup:M(r,["enter"])},null,544),[[H,t.value]]),u("button",{class:"chat-send-button",onClick:r},"📤")]))}},Z=g(Y,[["__scopeId","data-v-ba83fe0b"]]),ee={class:"chat-window"},te={class:"chat-header"},se={class:"chat-title"},oe={__name:"ChatWindow",props:{chat:{type:Object,required:!0},userName:{type:String,required:!0},cartorioToken:{type:String,required:!0}},emits:["close","end"],setup(m,{emit:h}){const n=N("userName"),t=m,r=h,c=v([]);let o=null;const _=I();function k(){o&&o.close();const s=`${_.public.chat_bot}?user_name=${n.value}&room_id=${t.chat.room}`;console.log("Conectando no chat:",s),o=new WebSocket(s),o.addEventListener("message",i)}function i(s){try{const e=JSON.parse(s.data);e.type==="chat_message"&&e.username!==n.value&&c.value.push({from:e.username===n.value,text:e.message}),e.message.state==="MenuPrincipal"&&(console.log("📜 Carregando histórico..."),c.value=[],console.log("📜 Histórico carregado:",e.history),p(e.history))}catch{}C(()=>f())}function y(s){if(!o||o.readyState!==WebSocket.OPEN)return;const e={type:"chat_message",message:s,cartorio_token:t.cartorioToken,isHumanized:!0};c.value.push({from:n.value,text:s}),o.send(JSON.stringify(e)),C(()=>f())}function f(){var e;const s=((e=a.value)==null?void 0:e.$el)||a.value;s&&(s.scrollTop=s.scrollHeight)}function b(){o&&o.close(4001,"EncerraAtendimento"),o=null,c.value.push({from:"server",text:"🛑 Atendimento encerrado."}),r("end")}const a=v(null);O(()=>t.chat.room,k,{immediate:!0}),B(()=>o&&o.close());function p(s){console.log("📜 Processando histórico:",s),s.forEach(e=>{if(e.type==="chat_message"){var w=e.username===n.value?n.value:e.username;c.value.push({from:w,text:e.message})}else e.type==="bot_message"?c.value.push({from:"server",text:e.message.message||e.message}):console.warn("⚠️ Tipo de mensagem desconhecido:",e.type)}),C(()=>{a.value&&(a.value.scrollTop=a.value.scrollHeight)})}return(s,e)=>(l(),d("section",ee,[u("header",te,[u("h3",se,S(m.chat.name.split("_").slice(1).join("_")),1),u("div",null,[u("button",{class:"chat-button end",onClick:b},"Encerrar"),u("button",{class:"chat-close",onClick:e[0]||(e[0]=w=>s.$emit("close"))},"✖")])]),$(G,{ref:"history",messages:c.value,class:"history"},null,8,["messages"]),$(Z,{onSend:y})]))}},ae=g(oe,[["__scopeId","data-v-4b3b5bf4"]]),ne={class:"chat-app"},ce={key:1,class:"placeholder"},re={__name:"index",setup(m){const h=N("userName"),n=I(),t=v([]),r=v(null);v(!1);const c=J(()=>t.value.find(a=>a.id===r.value)),_=A().query.cartorio_token??"",k=v("");let i=null;function y(a){r.value=a}function f(){i=new WebSocket(`${n.public.chat_bot}?user_name='${h.value}'&room_id=notifications`),i.onopen=()=>{console.log("🔌 WebSocket conectado"),b()},i.onmessage=a=>{console.log("Mensagem recebida:",JSON.parse(a.data));try{const p=JSON.parse(a.data);console.log("Data Queue:",p),t.value=[],p.queue.forEach(s=>{const e={id:s.id,name:s.name,room:s.room,preview:s.preview};t.value.push(e)})}catch(p){console.error("Falha ao parsear mensagem:",p)}},i.onclose=()=>{console.warn("WebSocket desconectado — reconectando em 5 s…"),setTimeout(f,5e3)},i.onerror=a=>{console.error("Erro WebSocket:",a),i.close()}}function b(){if(i&&i.readyState===WebSocket.OPEN){const a={type:"queue_list",message:"1",id:"notifications"};i.send(JSON.stringify(a)),console.log("📤 Evento enviado ao WebSocket:",a)}else console.warn("⚠️ WebSocket não está conectado. Tentando novamente em 1 segundo..."),setTimeout(b,1e3)}return D(()=>{f()}),(a,p)=>(l(),d("div",ne,[$(z,{chats:t.value,"active-chat-id":r.value,onSelect:y},null,8,["chats","active-chat-id"]),c.value?(l(),R(ae,{key:0,chat:c.value,"user-name":k.value,"cartorio-token":E(_),onClose:p[0]||(p[0]=s=>r.value=null)},null,8,["chat","user-name","cartorio-token"])):(l(),d("div",ce," Selecione um chat à esquerda "))]))}},le=g(re,[["__scopeId","data-v-41e67ff6"]]);export{le as default};
