import{P as X,C as ge,g as Ee,i as C,d as J,L as Pt,a as Ie,s as St,B as w,c as $e,E as I,b as Ae,e as et,f as we,h as je,K as It,j as Re,k as ue,A as ke,l as re,S as tt,m as it,n as At,o as zt,p as xe,q as be,t as Lt,u as M,N as wt,v as xt,w as f,x as F,D as Je,T as ie,y as rt,z as q,F as Rt,G as Xt,H as Me,I as ve,J as Yt,M as Et,O as Mt,Q as De,R as Dt,r as Bt}from"./DzFSz5n_.js";import{o as jt,c as Ht,b as Wt,s as qt,q as Ut,_ as Zt,p as _t}from"./BFOPKTQQ.js";var Ye=function(){var d=function(e,i){return d=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,r){t.__proto__=r}||function(t,r){for(var o in r)r.hasOwnProperty(o)&&(t[o]=r[o])},d(e,i)};return function(e,i){d(e,i);function t(){this.constructor=e}e.prototype=i===null?Object.create(i):(t.prototype=i.prototype,new t)}}(),Y=function(d,e,i,t){var r=arguments.length,o=r<3?e:t===null?t=Object.getOwnPropertyDescriptor(e,i):t,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(d,e,i,t);else for(var n=d.length-1;n>=0;n--)(a=d[n])&&(o=(r<3?a(o):r>3?a(e,i,o):a(e,i))||o);return r>3&&o&&Object.defineProperty(e,i,o),o},Nt="e-upload e-control-wrapper",ot="e-file-select",Be="e-file-drop",Vt="e-file-select-wrap",at="e-upload-files",ze="e-upload-file-list",N="e-file-status",Jt="e-upload-actions",Qt="e-file-upload-btn e-css e-btn e-flat e-primary",Gt="e-file-clear-btn e-css e-btn e-flat",nt="e-file-name",st="e-file-type",lt="e-file-size",ee="e-file-remove-btn",oe="e-file-delete-btn",pt="e-spinner-pane",_="e-file-abort-btn",de="e-file-reload-btn",He="e-upload-drag-hover",Ce="e-upload-progress-wrap",Le="e-upload-progress-bar",We="e-progress-bar-text",ae="e-upload-progress",le="e-upload-success",ne="e-upload-fails",qe="e-file-container",ht="e-validation-fails",dt="e-rtl",Ue="e-disabled",ut="e-rtl-container",Ze="e-clear-icon-focus",Kt="e-progress-inner-wrap",te="e-file-pause-btn",me="e-file-play-btn",Fe="e-restrict-retry",ct=["title","style","class"],ft="e-form-upload",$t="e-hidden-file-input",ye="e-file-invalid",ei="e-file-information",ti=function(d){Ye(e,d);function e(){return d!==null&&d.apply(this,arguments)||this}return Y([X("")],e.prototype,"name",void 0),Y([X(null)],e.prototype,"size",void 0),Y([X("")],e.prototype,"type",void 0),e}(ge),ii=function(d){Ye(e,d);function e(){return d!==null&&d.apply(this,arguments)||this}return Y([X("Browse...")],e.prototype,"browse",void 0),Y([X("Upload")],e.prototype,"upload",void 0),Y([X("Clear")],e.prototype,"clear",void 0),e}(ge),ri=function(d){Ye(e,d);function e(){return d!==null&&d.apply(this,arguments)||this}return Y([X("")],e.prototype,"saveUrl",void 0),Y([X("")],e.prototype,"removeUrl",void 0),Y([X(0)],e.prototype,"chunkSize",void 0),Y([X(3)],e.prototype,"retryCount",void 0),Y([X(500)],e.prototype,"retryAfterDelay",void 0),e}(ge),Pe=function(d){Ye(e,d);function e(i,t){var r=d.call(this,i,t)||this;return r.initialAttr={accept:null,multiple:!1,disabled:!1},r.uploadedFilesData=[],r.base64String=[],r.isForm=!1,r.allTypes=!1,r.pausedData=[],r.uploadMetaData=[],r.tabIndex="0",r.btnTabIndex="0",r.disableKeyboardNavigation=!1,r.count=-1,r.actionCompleteCount=0,r.flag=!0,r.selectedFiles=[],r.uploaderName="UploadFiles",r.fileStreams=[],r.newFileRef=0,r.isFirstFileOnSelection=!1,r.dragCounter=0,r.fileList=[],r.filesData=[],r.uploaderOptions=i,r}return e.prototype.onPropertyChanged=function(i,t){for(var r=0,o=Object.keys(i);r<o.length;r++){var a=o[r];switch(a){case"allowedExtensions":this.setExtensions(this.allowedExtensions),this.clearAll();break;case"enabled":this.setControlStatus();break;case"multiple":this.setMultipleSelection();break;case"enableRtl":this.setRTL(),this.reRenderFileList();break;case"buttons":this.buttons.browse=C(this.buttons.browse)?"":this.buttons.browse,this.buttons.clear=C(this.buttons.clear)?"":this.buttons.clear,this.buttons.upload=C(this.buttons.upload)?"":this.buttons.upload,this.renderButtonTemplates();break;case"dropArea":this.unBindDropEvents(),this.updateDropArea();break;case"htmlAttributes":this.updateHTMLAttrToElement(),this.updateHTMLAttrToWrapper(),this.checkHTMLAttributes(!0);break;case"files":this.renderPreLoadFiles();break;case"directoryUpload":this.updateDirectoryAttributes();break;case"template":this.isReact?this.reRenderFileList():this.clearAll();break;case"minFileSize":case"maxFileSize":case"autoUpload":this.clearAll();break;case"sequentialUpload":this.clearAll();break;case"locale":this.l10n.setLocale(this.locale),this.setLocalizedTexts(),this.preLocaleObj=Ee("currentLocale",this.l10n);break;case"cssClass":this.setCSSClass(t.cssClass);break}}},e.prototype.setLocalizedTexts=function(){C(this.template)&&(typeof this.buttons.browse=="string"&&(this.browseButton.innerText=this.buttons.browse==="Browse..."?this.localizedTexts("Browse"):this.buttons.browse,this.browseButton.setAttribute("title",this.browseButton.innerText),this.uploadWrapper&&!C(this.uploadWrapper.querySelector("."+Be))&&(this.uploadWrapper.querySelector("."+Be).innerHTML=this.localizedTexts("dropFilesHint"))),this.updateFileList())},e.prototype.getKeyValue=function(i){for(var t,r=0,o=Object.keys(this.preLocaleObj);r<o.length;r++){var a=o[r];this.preLocaleObj[""+a]===i&&(t=a)}return t},e.prototype.updateFileList=function(){var i;if(this.fileList.length>0&&!C(this.uploadWrapper.querySelector("."+at)))for(var t=0;t<this.fileList.length;t++)i=this.fileList[t].querySelector(".e-file-status"),i.innerHTML=this.localizedTexts(this.getKeyValue(this.filesData[t].status)),this.filesData[t].status=this.localizedTexts(this.getKeyValue(this.filesData[t].status)),this.fileList[t].classList.contains(le)&&this.fileList[t].querySelector(".e-icons").setAttribute("title",this.localizedTexts("delete")),this.fileList[t].querySelector(".e-file-play-btn")&&this.fileList[t].querySelector(".e-icons").setAttribute("title",this.localizedTexts("resume")),this.fileList[t].querySelector(".e-file-remove-btn")&&this.fileList[t].querySelector(".e-icons").setAttribute("title",this.localizedTexts("remove")),this.fileList[t].querySelector(".e-file-reload-btn")&&this.fileList[t].querySelector(".e-icons").setAttribute("title",this.localizedTexts("retry")),this.autoUpload||(this.uploadButton.innerText=this.buttons.upload==="Upload"?this.localizedTexts("Upload"):this.buttons.upload,this.uploadButton.setAttribute("title",this.localizedTexts("Upload")),this.clearButton.innerText=this.buttons.clear==="Clear"?this.localizedTexts("Clear"):this.buttons.clear,this.clearButton.setAttribute("title",this.localizedTexts("Clear")))},e.prototype.reRenderFileList=function(){this.listParent&&(J(this.listParent),this.listParent=null,this.fileList=[],this.internalCreateFileList(this.filesData),this.actionButtons&&(this.removeActionButtons(),this.renderActionButtons(),this.checkActionButtonStatus()))},e.prototype.preRender=function(){this.localeText={Browse:"Browse...",Clear:"Clear",Upload:"Upload",invalidFileName:"File Name is not allowed",dropFilesHint:"Or drop files here",invalidMaxFileSize:"File size is too large",invalidMinFileSize:"File size is too small",invalidFileType:"File type is not allowed",uploadFailedMessage:"File failed to upload",uploadSuccessMessage:"File uploaded successfully",removedSuccessMessage:"File removed successfully",removedFailedMessage:"Unable to remove file",inProgress:"Uploading",readyToUploadMessage:"Ready to upload",abort:"Abort",remove:"Remove",cancel:"Cancel",delete:"Delete file",pauseUpload:"File upload paused",pause:"Pause",resume:"Resume",retry:"Retry",fileUploadCancel:"File upload canceled",invalidFileSelection:"Invalid files selected",totalFiles:"Total files",size:"Size"},this.l10n=new Pt("uploader",this.localeText,this.locale),this.preLocaleObj=Ee("currentLocale",this.l10n),this.formRendered(),this.updateHTMLAttrToElement(),this.checkHTMLAttributes(!1);var i=Ee("ej2_instances",this.element);if(this.element.tagName==="EJS-UPLOADER"){var t=this.createElement("input",{attrs:{type:"file"}}),r=0;for(r;r<this.element.attributes.length;r++)this.element.attributes[r].nodeName!=="id"?t.setAttribute(this.element.attributes[r].nodeName,this.element.attributes[r].nodeValue):this.element.attributes[r].nodeName==="id"&&t.setAttribute(this.element.attributes[r].nodeName,Ie("uploader")),t.innerHTML=this.element.innerHTML;t.hasAttribute("name")||t.setAttribute("name","UploadFiles"),this.element.appendChild(t),this.element=t,St("ej2_instances",i,this.element)}i[0].isPureReactComponent&&(C(i[0].props.name)?!C(i[0].props.id)&&C(i[0].props.name)?this.element.setAttribute("name",i[0].props.id):this.element.setAttribute("name","UploadFiles"):this.element.setAttribute("name",i[0].props.name)),C(this.element.getAttribute("name"))&&this.element.setAttribute("name",this.element.getAttribute("id")),this.element.hasAttribute("type")||this.element.setAttribute("type","file"),this.updateDirectoryAttributes(),this.keyConfigs={enter:"enter"},this.element.hasAttribute("tabindex")&&(this.tabIndex=this.element.getAttribute("tabindex")),this.browserName=w.info.name,this.uploaderName=this.element.getAttribute("name")},e.prototype.formRendered=function(){var i=$e(this.element,"form");if(!C(i))for(;i&&i!==document.documentElement;i=i.parentElement)i.tagName==="FORM"&&(this.isForm=!0,this.formElement=i,i.setAttribute("enctype","multipart/form-data"),i.setAttribute("encoding","multipart/form-data"))},e.prototype.getPersistData=function(){return this.addOnPersist(["filesData"])},e.prototype.getModuleName=function(){return"uploader"},e.prototype.updateDirectoryAttributes=function(){this.directoryUpload?(this.element.setAttribute("directory","true"),this.element.setAttribute("webkitdirectory","true")):(this.element.removeAttribute("directory"),this.element.removeAttribute("webkitdirectory"))},e.prototype.render=function(){this.renderBrowseButton(),this.initializeUpload(),this.updateHTMLAttrToWrapper(),this.wireEvents(),this.setMultipleSelection(),this.setExtensions(this.allowedExtensions),this.setRTL(),this.renderPreLoadFiles(),this.setControlStatus(),this.setCSSClass()},e.prototype.renderBrowseButton=function(){this.browseButton=this.createElement("button",{className:"e-css e-btn",attrs:{type:"button"}}),this.browseButton.setAttribute("tabindex",this.tabIndex),typeof this.buttons.browse=="string"?(this.browseButton.textContent=this.buttons.browse==="Browse..."?this.localizedTexts("Browse"):this.buttons.browse,this.browseButton.setAttribute("title",this.browseButton.innerText)):this.browseButton.appendChild(this.buttons.browse),this.element.setAttribute("aria-label","Uploader")},e.prototype.renderActionButtons=function(){this.element.setAttribute("tabindex","-1"),this.actionButtons=this.createElement("div",{className:Jt}),this.uploadButton=this.createElement("button",{className:Qt,attrs:{type:"button",tabindex:this.btnTabIndex,"aria-label":this.localizedTexts("Upload")}}),this.clearButton=this.createElement("button",{className:Gt,attrs:{type:"button",tabindex:this.btnTabIndex,"aria-label":this.localizedTexts("Clear")}}),this.actionButtons.appendChild(this.clearButton),this.actionButtons.appendChild(this.uploadButton),this.renderButtonTemplates(),this.uploadWrapper.appendChild(this.actionButtons),this.browseButton.blur(),this.isPreloadFiles||this.uploadButton.focus(),this.wireActionButtonEvents()},e.prototype.serverActionButtonsEventBind=function(i){i&&!this.isForm&&(this.browseButton.blur(),this.actionButtons=i,this.uploadButton=this.actionButtons.querySelector(".e-file-upload-btn"),this.clearButton=this.actionButtons.querySelector(".e-file-clear-btn"),this.uploadButton.focus(),this.unwireActionButtonEvents(),this.wireActionButtonEvents(),this.checkActionButtonStatus())},e.prototype.wireActionButtonEvents=function(){I.add(this.uploadButton,"click",this.uploadButtonClick,this),I.add(this.clearButton,"click",this.clearButtonClick,this)},e.prototype.unwireActionButtonEvents=function(){I.remove(this.uploadButton,"click",this.uploadButtonClick),I.remove(this.clearButton,"click",this.clearButtonClick)},e.prototype.removeActionButtons=function(){this.actionButtons&&(this.unwireActionButtonEvents(),J(this.actionButtons),this.actionButtons=null)},e.prototype.renderButtonTemplates=function(){if(typeof this.buttons.browse=="string"?(this.browseButton.textContent=this.buttons.browse==="Browse..."?this.localizedTexts("Browse"):this.buttons.browse,this.browseButton.setAttribute("title",this.browseButton.textContent)):(this.browseButton.innerHTML="",this.browseButton.appendChild(this.buttons.browse)),this.uploadButton){var i=C(this.buttons.upload)?"Upload":this.buttons.upload;this.buttons.upload=i,typeof this.buttons.upload=="string"?(this.uploadButton.textContent=this.buttons.upload==="Upload"?this.localizedTexts("Upload"):this.buttons.upload,this.uploadButton.setAttribute("title",this.uploadButton.textContent)):(this.uploadButton.innerHTML="",this.uploadButton.appendChild(this.buttons.upload))}if(this.clearButton){var t=C(this.buttons.clear)?"Clear":this.buttons.clear;this.buttons.clear=t,typeof this.buttons.clear=="string"?(this.clearButton.textContent=this.buttons.clear==="Clear"?this.localizedTexts("Clear"):this.buttons.clear,this.clearButton.setAttribute("title",this.clearButton.textContent)):(this.clearButton.innerHTML="",this.clearButton.appendChild(this.buttons.clear))}},e.prototype.initializeUpload=function(){this.element.setAttribute("tabindex","-1");var i=this.createElement("span",{className:ot});this.element.parentElement.insertBefore(i,this.element),this.dropAreaWrapper=this.createElement("div",{className:Vt}),this.element.parentElement.insertBefore(this.dropAreaWrapper,this.element),i.appendChild(this.element),this.dropAreaWrapper.appendChild(this.browseButton),this.dropAreaWrapper.appendChild(i),this.uploadWrapper=this.createElement("div",{className:Nt}),this.dropAreaWrapper.parentElement.insertBefore(this.uploadWrapper,this.dropAreaWrapper),this.uploadWrapper.appendChild(this.dropAreaWrapper),this.setDropArea()},e.prototype.renderPreLoadFiles=function(){if(this.files.length){if(this.enablePersistence&&this.filesData.length){this.internalCreateFileList(this.filesData);return}if(C(this.files[0].size))return;this.isPreloadFiles=!0;var i=[].slice.call(this.files),t=[];this.multiple||(this.clearData(),i=[i[0]]);for(var r=0,o=i;r<o.length;r++){var a=o[r],n={name:a.name+"."+a.type.split(".")[a.type.split(".").length-1],rawFile:"",size:a.size,status:this.localizedTexts("uploadSuccessMessage"),type:a.type,validationMessages:{minSize:"",maxSize:""},statusCode:"2"};t.push(n),this.filesData.push(n)}this.internalCreateFileList(t),!this.autoUpload&&this.listParent&&!this.actionButtons&&(!this.isForm||this.allowUpload())&&this.showFileList&&this.renderActionButtons(),this.checkActionButtonStatus(),this.sequentialUpload&&(this.count=this.filesData.length-1),this.isPreloadFiles=!1}},e.prototype.checkActionButtonStatus=function(){if(this.actionButtons){var i=this.uploadWrapper.querySelectorAll("."+ht).length+this.uploadWrapper.querySelectorAll(".e-upload-fails:not(.e-upload-progress)").length+this.uploadWrapper.querySelectorAll("span."+le).length+this.uploadWrapper.querySelectorAll("span."+ae).length;i>0&&i===this.uploadWrapper.querySelectorAll("li").length?this.uploadButton.setAttribute("disabled","disabled"):this.uploadButton.removeAttribute("disabled")}},e.prototype.setDropArea=function(){var i=this.dropAreaWrapper.querySelector(".e-file-drop");if(this.dropArea){this.dropZoneElement=typeof this.dropArea!="string"?this.dropArea:Ae(this.dropArea,document);for(var t=this.element,r=!1;t.parentNode;)t=t.parentNode,t===this.dropZoneElement&&(r=!0,i?i.innerHTML=this.localizedTexts("dropFilesHint"):this.createDropTextHint());!r&&i&&et(i)}else!C(this.uploaderOptions)&&this.uploaderOptions.dropArea===void 0&&(this.createDropTextHint(),this.dropZoneElement=this.uploadWrapper,this.setProperties({dropArea:this.uploadWrapper},!0));this.bindDropEvents()},e.prototype.updateDropArea=function(){if(this.dropArea)this.setDropArea();else{this.dropZoneElement=null;var i=this.dropAreaWrapper.querySelector(".e-file-drop");i&&et(i)}},e.prototype.createDropTextHint=function(){var i=this.createElement("span",{className:Be});i.innerHTML=this.localizedTexts("dropFilesHint"),this.dropAreaWrapper.appendChild(i)},e.prototype.updateHTMLAttrToElement=function(){if(!C(this.htmlAttributes))for(var i=0,t=Object.keys(this.htmlAttributes);i<t.length;i++){var r=t[i];ct.indexOf(r)<0&&this.element.setAttribute(r,this.htmlAttributes[""+r])}},e.prototype.updateHTMLAttrToWrapper=function(){if(!C(this.htmlAttributes))for(var i=0,t=Object.keys(this.htmlAttributes);i<t.length;i++){var r=t[i];if(ct.indexOf(r)>-1)if(r==="class"){var o=this.htmlAttributes[""+r].replace(/\s+/g," ").trim();o!==""&&we([this.uploadWrapper],o.split(" "))}else if(r==="style"){var a=this.uploadWrapper.getAttribute(r);a=C(a)?this.htmlAttributes[""+r]:a+this.htmlAttributes[""+r],this.uploadWrapper.setAttribute(r,a)}else this.uploadWrapper.setAttribute(r,this.htmlAttributes[""+r])}},e.prototype.setMultipleSelection=function(){if(this.multiple&&!this.element.hasAttribute("multiple")){var i=document.createAttribute("multiple");i.value="multiple",this.element.setAttributeNode(i)}else this.multiple||this.element.removeAttribute("multiple")},e.prototype.checkAutoUpload=function(i){this.autoUpload?(this.sequentialUpload?this.sequenceUpload(i):this.upload(i),this.removeActionButtons()):this.actionButtons||this.renderActionButtons(),this.checkActionButtonStatus()},e.prototype.sequenceUpload=function(i){if(this.filesData.length-i.length===0||this.filesData[this.filesData.length-i.length-1].statusCode!=="1"){(this.multiple||this.count<0)&&++this.count;var t=!this.showFileList;typeof this.filesData[this.count]=="object"?(this.isFirstFileOnSelection=!1,this.upload(this.filesData[this.count],t),this.filesData[this.count].statusCode==="0"&&this.sequenceUpload(i)):--this.count}},e.prototype.setCSSClass=function(i){var t=i;C(i)||(t=i.replace(/\s+/g," ").trim()),!C(i)&&t!==""&&je([this.uploadWrapper],t.split(" "));var r=this.cssClass;!C(this.cssClass)&&this.cssClass!==""&&(r=this.cssClass.replace(/\s+/g," ").trim()),!C(this.cssClass)&&r!==""&&we([this.uploadWrapper],r.split(r.indexOf(",")>-1?",":" "))},e.prototype.wireEvents=function(){I.add(this.browseButton,"click",this.browseButtonClick,this),I.add(this.element,"change",this.onSelectFiles,this),I.add(document,"click",this.removeFocus,this),this.keyboardModule=new It(this.uploadWrapper,{keyAction:this.keyActionHandler.bind(this),keyConfigs:this.keyConfigs,eventName:"keydown"}),this.isForm&&I.add(this.formElement,"reset",this.resetForm,this)},e.prototype.unWireEvents=function(){I.remove(this.browseButton,"click",this.browseButtonClick),I.remove(this.element,"change",this.onSelectFiles),I.remove(document,"click",this.removeFocus),this.isForm&&I.remove(this.formElement,"reset",this.resetForm),this.keyboardModule&&this.keyboardModule.destroy()},e.prototype.resetForm=function(){this.clearAll()},e.prototype.keyActionHandler=function(i){var t=i.target;switch(i.action){case"enter":if(i.target===this.clearButton)this.clearButtonClick();else if(i.target===this.uploadButton)this.uploadButtonClick();else if(i.target===this.browseButton)this.browseButtonClick();else if(t.classList.contains(te)){var r=this.getCurrentMetaData(null,i);r.file.statusCode="4",r.file.status=this.localizedTexts("pauseUpload"),this.abortUpload(r,!1)}else if(t.classList.contains(me))this.resumeUpload(this.getCurrentMetaData(null,i),i);else if(t.classList.contains(de)){var r=this.getCurrentMetaData(null,i);if(!C(r))r.file.statusCode="1",r.file.status=this.localizedTexts("readyToUploadMessage"),this.chunkUpload(r.file);else{var o=i.target.parentElement,a=this.filesData[this.fileList.indexOf(o)];this.retry(a)}}else this.removeFiles(i),t.classList.contains(_)||this.browseButton.focus();i.preventDefault(),i.stopPropagation();break}},e.prototype.getCurrentMetaData=function(i,t){var r,o;if(C(i)){var a=t.target.parentElement;r=this.filesData[this.fileList.indexOf(a)]}else r=i;for(var n=0;n<this.uploadMetaData.length;n++)this.uploadMetaData[n].file.name===r.name&&(o=this.uploadMetaData[n]);return o},e.prototype.removeFocus=function(){this.uploadWrapper&&this.listParent&&this.listParent.querySelector("."+Ze)&&(document.activeElement.blur(),this.listParent.querySelector("."+Ze).classList.remove(Ze))},e.prototype.browseButtonClick=function(){this.element.click()},e.prototype.uploadButtonClick=function(){this.sequentialUpload?this.sequenceUpload(this.filesData):this.upload(this.filesData)},e.prototype.clearButtonClick=function(){this.clearAll(),this.sequentialUpload&&(this.count=-1),this.actionCompleteCount=0},e.prototype.bindDropEvents=function(){this.dropZoneElement&&(I.add(this.dropZoneElement,"drop",this.dropElement,this),I.add(this.dropZoneElement,"dragover",this.dragHover,this),I.add(this.dropZoneElement,"dragleave",this.onDragLeave,this),I.add(this.dropZoneElement,"paste",this.onPasteFile,this),I.add(this.dropZoneElement,"dragenter",this.onDragEnter,this))},e.prototype.unBindDropEvents=function(){this.dropZoneElement&&(I.remove(this.dropZoneElement,"drop",this.dropElement),I.remove(this.dropZoneElement,"dragover",this.dragHover),I.remove(this.dropZoneElement,"dragleave",this.onDragLeave),I.remove(this.dropZoneElement,"dragenter",this.onDragEnter))},e.prototype.onDragEnter=function(i){this.enabled&&(this.dropZoneElement.classList.add(He),this.dragCounter=this.dragCounter+1,i.preventDefault(),i.stopPropagation())},e.prototype.onDragLeave=function(){this.enabled&&(this.dragCounter=this.dragCounter-1,this.dragCounter||this.dropZoneElement.classList.remove(He))},e.prototype.dragHover=function(i){this.enabled&&(this.dropEffect!=="Default"&&(i.dataTransfer.dropEffect=this.dropEffect.toLowerCase()),i.preventDefault(),i.stopPropagation())},e.prototype.dropElement=function(i){this.dragCounter=0,this.dropZoneElement.classList.remove(He),this.onSelectFiles(i),i.preventDefault(),i.stopPropagation()},e.prototype.onPasteFile=function(i){var t=i.clipboardData.items;if(i.type==="paste"&&this.browserName!=="msie"&&this.browserName!=="edge"&&this.browserName!=="safari"&&(this.element.files=i.clipboardData.files),!(t.length!==1&&!this.multiple))for(var r=0;r<t.length;r++){var o=[].slice.call(t)[r];!C(o.getAsFile())&&(o.kind==="file"||o.type.match("^image/"))&&this.renderSelectedFiles(i,[o.getAsFile()],!1,!0)}},e.prototype.getSelectedFiles=function(i){for(var t=[],r=this.fileList[i],o=this.getFilesData(),a=+r.getAttribute("data-files-count"),n=0,s=0;s<i;s++)n+=+this.fileList[s].getAttribute("data-files-count");for(var l=n;l<n+a;l++)t.push(o[l]);return t},e.prototype.removeFiles=function(i){if(this.enabled){var t=i.target.parentElement,r=this.fileList.indexOf(t),o=this.fileList[r],a=this.isFormUpload(),n=a?this.getSelectedFiles(r):this.getFilesInArray(this.filesData[r]);if(!C(n)){if(i.target.classList.contains(_)&&!a){if(n[0].statusCode="5",!C(o)){var s=o.querySelector("."+_);Re({target:s,width:"20px"}),ue(s)}this.sequentialUpload&&this.uploadSequential(),o.classList.contains(Fe)||this.checkActionComplete(!0)}else $e(i.target,"."+pt)||this.remove(n,!1,!1,!0,i);if(this.isForm&&o&&o.classList.contains(ye)&&(this.element.value=""),this.checkActionButtonStatus(),this.actionButtons&&this.clearButton&&this.uploadWrapper){var l=this.uploadWrapper.querySelectorAll(".e-upload-progress-bar.e-upload-progress:not(.e-upload-success):not(.e-upload-fails)");l.length===1&&t.contains(l[0])&&this.clearButton.hasAttribute("disabled")&&this.clearButton.removeAttribute("disabled")}}}},e.prototype.removeFilesData=function(i,t){var r;if(t){this.showFileList||(r=this.filesData.indexOf(i),this.filesData.splice(r,1));return}var o=this.getLiElement(i);C(o)||(this.element.value="",J(o),r=this.fileList.indexOf(o),this.fileList.splice(r,1),this.filesData.splice(r,1),this.fileList.length===0&&!C(this.listParent)&&(J(this.listParent),this.listParent=null,this.removeActionButtons()),this.sequentialUpload&&r<=this.count&&--this.count)},e.prototype.removeUploadedFile=function(i,t,r,o){var a=this,n=i,s=new ke(this.asyncSettings.removeUrl,"POST",!0,null);s.emitError=!1;var l=new FormData;s.beforeSend=function(p){t.currentRequest=s.httpRequest,r?a.removingEventCallback(t,l,n,i):a.trigger("removing",t,function(h){h.cancel?p.cancel=!0:a.removingEventCallback(h,l,n,i)})},s.onLoad=function(p){return a.removeCompleted(p,n,o),{}},s.onError=function(p){return a.removeFailed(p,n,o),{}},s.send(l)},e.prototype.removingEventCallback=function(i,t,r,o){var a=this.element.getAttribute("name"),n=this.getLiElement(o);if(!C(n)&&(!C(n.querySelector("."+oe))||!C(n.querySelector("."+ee)))){var s=n.querySelector("."+oe)?n.querySelector("."+oe):n.querySelector("."+ee);Re({target:s,width:"20px"}),ue(s)}i.postRawFile&&!C(r.rawFile)&&r.rawFile!==""?t.append(a,r.rawFile,r.name):t.append(a,r.name),this.updateFormData(t,i.customFormData)},e.prototype.updateFormData=function(i,t){if(t.length>0&&t[0])for(var r=function(a){var n=t[a],s=Object.keys(n).map(function(l){return n[""+l]});i.append(Object.keys(n)[0],s)},o=0;o<t.length;o++)r(o)},e.prototype.updateCustomheader=function(i,t){if(t.length>0&&t[0])for(var r=function(a){var n=t[a],s=Object.keys(n).map(function(l){return n[""+l]});i.setRequestHeader(Object.keys(n)[0],s)},o=0;o<t.length;o++)r(o)},e.prototype.removeCompleted=function(i,t,r){var o=i&&i.currentTarget?this.getResponse(i):null,a=i.target;if(a.readyState===4&&a.status>=200&&a.status<=299){var n={e:i,response:o,operation:"remove",file:this.updateStatus(t,this.localizedTexts("removedSuccessMessage"),"2")};this.trigger("success",n),this.removeFilesData(t,r);var s=this.uploadedFilesData.indexOf(t);this.uploadedFilesData.splice(s,1),this.trigger("change",{files:this.uploadedFilesData})}else this.removeFailed(i,t,r)},e.prototype.removeFailed=function(i,t,r){var o=i&&i.currentTarget?this.getResponse(i):null,a={e:i,response:o,operation:"remove",file:this.updateStatus(t,this.localizedTexts("removedFailedMessage"),"0")};if(!r){var n=this.filesData.indexOf(t),s=this.fileList[n];if(s){s.classList.remove(le),s.classList.add(ne);var l=s.querySelector("."+N);l&&(l.classList.remove(le),l.classList.add(ne))}this.checkActionButtonStatus()}this.trigger("failure",a);var p=this.getLiElement(t);if(!C(p)&&!C(p.querySelector("."+oe))){var h=p.querySelector("."+oe);re(h),J(p.querySelector(".e-spinner-pane"))}},e.prototype.getFilesFromFolder=function(i){this.filesEntries=[];var t=this.multiple?i.dataTransfer.items:[i.dataTransfer.items[0]],r=this.checkDirectoryUpload(t);if(r)for(var o=function(s){var l=t[s].webkitGetAsEntry();if(l.isFile){var p=[];l.file(function(h){var u=l.fullPath;p.push({path:u,file:h})}),a.renderSelectedFiles(i,p,!0)}else l.isDirectory&&a.traverseFileTree(l,i)},a=this,n=0;n<t.length;n++)o(n)},e.prototype.checkDirectoryUpload=function(i){for(var t=0;i&&t<i.length;t++){var r=i[t].webkitGetAsEntry();if(r.isDirectory)return!0}return!1},e.prototype.traverseFileTree=function(i,t){if(i.isFile)this.filesEntries.push(i);else if(i.isDirectory){var r=i.createReader();this.readFileFromDirectory(r,t)}},e.prototype.readFileFromDirectory=function(i,t){var r=this;i.readEntries(function(o){for(var a=0;a<o.length;a++)r.traverseFileTree(o[a],t);r.pushFilesEntries(t),o.length&&r.readFileFromDirectory(i)})},e.prototype.pushFilesEntries=function(i){for(var t=this,r=[],o=function(s){a.filesEntries[s].file(function(l){if(t.filesEntries.length){var p=t.filesEntries[s].fullPath;r.push({path:p,file:l}),s===t.filesEntries.length-1&&(t.filesEntries=[],t.renderSelectedFiles(i,r,!0))}})},a=this,n=0;n<this.filesEntries.length;n++)o(n)},e.prototype.onSelectFiles=function(i){if(this.enabled){var t;if(i.type==="drop")if(this.directoryUpload)this.getFilesFromFolder(i);else{var r=this.sortFilesList=i.dataTransfer.files;this.browserName!=="msie"&&this.browserName!=="edge"&&this.browserName!=="safari"&&(this.element.files=r),r.length>0&&(t=this.multiple?this.sortFileList(r):[r[0]],this.renderSelectedFiles(i,t))}else t=[].slice.call(i.target.files),this.renderSelectedFiles(i,t);(this.isAngular||this.isReact)&&i.stopPropagation()}},e.prototype.getBase64=function(i){return new Promise(function(t,r){var o=new FileReader;o.readAsDataURL(i),o.onload=function(){return t(o.result)},o.onerror=function(a){return r(a)}})},e.prototype.renderSelectedFiles=function(i,t,r,o){var a=this;this.base64String=[];var n={event:i,cancel:!1,filesData:[],isModified:!1,modifiedFilesData:[],progressInterval:"",isCanceled:!1,currentRequest:null,customFormData:null};if(t.length<1){n.isCanceled=!0,this.trigger("selected",n);return}this.flag=!0;var s=[];this.multiple||(this.clearData(!0),this.actionCompleteCount=0,t=[t[0]]);for(var l=0;l<t.length;l++){var p=r?t[l].file:t[l];this.updateInitialFileDetails(i,t,p,l,s,r,o)}if(n.filesData=s,!C(this.allowedExtensions)&&this.allowedExtensions.indexOf("*")>-1&&(this.allTypes=!0),this.enableHtmlSanitizer)for(var l=0;l<s.length;l++){for(var h=tt.beforeSanitize(),u=tt.serializeValue(h,s[parseInt(l.toString(),10)].name),c=s[parseInt(l.toString(),10)].name,g=!1,v=0;v<c.length;v++)if(c.charCodeAt(v)>127){g=!0;break}var b=/<([a-z][a-z0-9]*)\b[^>]*>(.*?)<\/\1>/i,m=b.test(c);if(u!==s[parseInt(l.toString(),10)].name&&!(g&&!m)){var y=t[parseInt(l.toString(),10)].name.replace(/[\u00A0-\u9999<>\\&]/g,function(S){return"&#"+S.charCodeAt(0)+";"});s[parseInt(l.toString(),10)].name=y,s[parseInt(l.toString(),10)].status=this.localizedTexts("invalidFileName"),s[parseInt(l.toString(),10)].statusCode="0"}}this.allTypes||(s=this.checkExtension(s)),this.trigger("selected",n,function(P){a._internalRenderSelect(P,s)})},e.prototype.updateInitialFileDetails=function(i,t,r,o,a,n,s){var l=n?t[o].path.substring(1,t[o].path.length):s?Ie(r.name.substring(0,r.name.lastIndexOf(".")))+"."+this.getFileType(r.name):this.directoryUpload?t[o].webkitRelativePath:r.name,p={name:l,rawFile:r,size:r.size,status:this.localizedTexts("readyToUploadMessage"),type:this.getFileType(r.name),validationMessages:this.validatedFileSize(r.size),statusCode:"1",id:Ie(r.name.substring(0,r.name.lastIndexOf(".")))+"."+this.getFileType(r.name)};s&&(p.fileSource="paste"),p.status=p.validationMessages.minSize!==""?this.localizedTexts("invalidMinFileSize"):p.validationMessages.maxSize!==""?this.localizedTexts("invalidMaxFileSize"):p.status,(p.validationMessages.minSize!==""||p.validationMessages.maxSize!=="")&&(p.statusCode="0",this.checkActionComplete(!0)),a.push(p)},e.prototype._internalRenderSelect=function(i,t){if(!i.cancel){if(this.selectedFiles=this.selectedFiles.concat(t),this.btnTabIndex=this.disableKeyboardNavigation?"-1":"0",this.showFileList){if(i.isModified&&i.modifiedFilesData.length>0){for(var r=0;r<i.modifiedFilesData.length;r++)for(var o=0;o<t.length;o++)i.modifiedFilesData[r].id===t[o].id&&(i.modifiedFilesData[r].rawFile=t[o].rawFile);var a=this.allTypes?i.modifiedFilesData:this.checkExtension(i.modifiedFilesData);this.updateSortedFileList(a),this.filesData=this.filesData.concat(a),(!this.isForm||this.allowUpload())&&this.checkAutoUpload(a)}else{if(this.internalCreateFileList(t),this.autoUpload&&this.sequenceUpload&&this.sequentialUpload&&this.filesData.length>0&&this.filesData[this.filesData.length-1].statusCode!=="2"&&this.filesData[this.filesData.length-1].statusCode!=="0"){this.filesData=this.filesData.concat(t);return}this.filesData=this.filesData.concat(t),(!this.isForm||this.allowUpload())&&this.checkAutoUpload(t)}!C(i.progressInterval)&&i.progressInterval!==""&&(this.progressInterval=i.progressInterval)}else this.filesData=this.filesData.concat(t),this.autoUpload&&this.upload(this.filesData,!0);this.raiseActionComplete(),this.isFirstFileOnSelection=!0}},e.prototype.allowUpload=function(){var i=!1;return this.isForm&&!C(this.asyncSettings.saveUrl)&&this.asyncSettings.saveUrl!==""&&(i=!0),i},e.prototype.isFormUpload=function(){var i=!1;return this.isForm&&(C(this.asyncSettings.saveUrl)||this.asyncSettings.saveUrl==="")&&(C(this.asyncSettings.removeUrl)||this.asyncSettings.removeUrl==="")&&(i=!0),i},e.prototype.clearData=function(i){C(this.listParent)||(J(this.listParent),this.listParent=null),this.browserName!=="msie"&&!i&&(this.element.value=""),this.fileList=[],this.filesData=[],this.removeActionButtons()},e.prototype.updateSortedFileList=function(i){var t=this.createElement("div",{id:"clonewrapper"}),r=-1;if(this.listParent){for(var o=0;o<this.listParent.querySelectorAll("li").length;o++){var a=this.listParent.querySelectorAll("li")[o];t.appendChild(a.cloneNode(!0))}this.removeActionButtons();var n=[].slice.call(t.childNodes);this.createParentUL();for(var s=0;s<i.length;s++){for(var l=0;l<this.filesData.length;l++)this.filesData[l].name===i[s].name&&(this.listParent.appendChild(n[l]),I.add(n[l].querySelector(".e-icons"),"click",this.removeFiles,this),this.fileList.push(n[l]),r=s);r!==s&&this.internalCreateFileList([i[s]])}}else this.internalCreateFileList(i)},e.prototype.isBlank=function(i){return!i||/^\s*$/.test(i)},e.prototype.checkGenericExtension=function(i,t){var r=[];switch(i.toLowerCase()){case"image/*":r.push("jpg","jpeg","png","gif","bmp","tiff","svg","webp","heic");break;case"audio/*":r.push("mp3","wav","aac","flac","ogg","m4a");break;case"video/*":r.push("mp4","mov","avi","mkv","flv","wmv","webm","mpeg");break;case"application/*":r.push("doc","docx","xls","xlsx","ppt","pptx","zip","rar","7z","tar","pdf");break;case"text/*":r.push("txt","csv","html","css","js","json","xml","md");break}return r.includes(t.toLowerCase())},e.prototype.checkExtension=function(i){var t=i;if(!this.isBlank(this.allowedExtensions)){for(var r=[],o=C(r)?[""]:this.allowedExtensions.split(","),a=0,n=o;a<n.length;a++){var s=n[a];r.push(s.trim().toLocaleLowerCase())}for(var l=0;l<i.length;l++){var p=i[l].type.indexOf(".")!==-1?i[l].type.replace(".",""):i[l].type;if(r[0].indexOf("/*")!==-1){var h=this.checkGenericExtension(r[0],p);h||(i[l].status=this.localizedTexts("invalidFileType"),i[l].statusCode="0")}else r.indexOf(("."+p).toLocaleLowerCase())===-1&&(i[l].status=this.localizedTexts("invalidFileType"),i[l].statusCode="0")}}return t},e.prototype.validatedFileSize=function(i){var t="",r="";i<this.minFileSize?t=this.localizedTexts("invalidMinFileSize"):i>this.maxFileSize?r=this.localizedTexts("invalidMaxFileSize"):(t="",r="");var o={minSize:t,maxSize:r};return o},e.prototype.isPreLoadFile=function(i){for(var t=!1,r=0;r<this.files.length;r++)this.files[r].name===i.name.slice(0,i.name.lastIndexOf("."))&&this.files[r].type===i.type&&(t=!0);return t},e.prototype.createCustomfileList=function(i){this.createParentUL();for(var t=0,r=i;t<r.length;t++){var o=r[t],a=this.createElement("li",{className:ze,attrs:{"data-file-name":o.name}});this.uploadTemplateFn=this.templateComplier(this.template);var n=this.uploadTemplateFn(o,this,"template",this.element.id+"Template",this.isStringTemplate,null,a);if(n){var s=[].slice.call(n);it(s,a)}var l=i.indexOf(o),p={element:a,fileInfo:o,index:l,isPreload:this.isPreLoadFile(o)},h={element:a,fileInfo:o,index:l,isPreload:this.isPreLoadFile(o)};this.trigger("rendering",p),this.trigger("fileListRendering",h),this.listParent.appendChild(a),this.fileList.push(a)}this.renderReactTemplates()},e.prototype.createParentUL=function(){C(this.listParent)&&(this.listParent=this.createElement("ul",{className:at}),this.uploadWrapper.appendChild(this.listParent))},e.prototype.formFileList=function(i,t){var r=this.createElement("li",{className:ze});r.setAttribute("data-files-count",i.length+"");for(var o=this.createElement("span",{className:qe}),a,n=0,s=i;n<s.length;n++){var l=s[n],p=this.createElement("span",{className:nt});p.innerHTML=this.getFileNameOnly(l.name);var h=this.createElement("span",{className:st}),u=this.getFileType(l.name);if(h.innerHTML="."+u,u||h.classList.add("e-hidden"),!this.enableRtl)o.appendChild(p),o.appendChild(h);else{var c=this.createElement("span",{className:ut});c.appendChild(h),c.appendChild(p),o.appendChild(c)}this.truncateName(p),a=this.formValidateFileInfo(l,r)}r.appendChild(o),this.setListToFileInfo(i,r);var g=this.listParent.querySelectorAll("li").length,v=this.createElement("span");if(r.classList.contains(ye)?(v.classList.add(N),v.classList.add(ye),v.innerText=i.length>1?this.localizedTexts("invalidFileSelection"):a):(v.classList.add(i.length>1?ei:lt),v.innerText=i.length>1?this.localizedTexts("totalFiles")+": "+i.length+" , "+this.localizedTexts("size")+": "+this.bytesToSize(this.getFileSize(i)):this.bytesToSize(i[0].size),this.createFormInput(i)),o.appendChild(v),C(r.querySelector(".e-icons"))){var b=this.createElement("span",{className:"e-icons",attrs:{tabindex:this.btnTabIndex}});this.browserName==="msie"&&b.classList.add("e-msie"),b.setAttribute("title",this.localizedTexts("remove")),r.appendChild(o),r.appendChild(b),I.add(b,"click",this.removeFiles,this),b.classList.add(ee)}var m={element:r,fileInfo:this.mergeFileInfo(i,r),index:g,isPreload:this.isPreLoadFile(this.mergeFileInfo(i,r))},y={element:r,fileInfo:this.mergeFileInfo(i,r),index:g,isPreload:this.isPreLoadFile(this.mergeFileInfo(i,r))};this.trigger("rendering",m),this.trigger("fileListRendering",y),this.listParent.appendChild(r),this.fileList.push(r)},e.prototype.formValidateFileInfo=function(i,t){var r=i.status,o=this.validatedFileSize(i.size);(o.minSize!==""||o.maxSize!=="")&&(this.addInvalidClass(t),r=o.minSize!==""?this.localizedTexts("invalidMinFileSize"):o.maxSize!==""?this.localizedTexts("invalidMaxFileSize"):r);var a=this.checkExtension(this.getFilesInArray(i))[0].status;return a===this.localizedTexts("invalidFileType")&&(this.addInvalidClass(t),r=a),r},e.prototype.addInvalidClass=function(i){i.classList.add(ye)},e.prototype.createFormInput=function(i){if(this.browserName!=="safari"){var t=this.element.cloneNode(!0);t.classList.add($t);for(var r=0,o=i;r<o.length;r++){var a=o[r];a.input=t}t.setAttribute("id",Ie("hiddenUploader")),t.setAttribute("name",this.uploaderName),this.uploadWrapper.querySelector("."+ot).appendChild(t),this.browserName!=="msie"&&this.browserName!=="edge"&&(this.element.value="")}},e.prototype.getFileSize=function(i){for(var t=0,r=0,o=i;r<o.length;r++){var a=o[r];t+=a.size}return t},e.prototype.mergeFileInfo=function(i,t){for(var r={name:"",rawFile:"",size:0,status:"",type:"",validationMessages:{minSize:"",maxSize:""},statusCode:"1",list:t},o=[],a="",n=0,s=i;n<s.length;n++){var l=s[n];o.push(l.name),a=l.type}return r.name=o.join(", "),r.size=this.getFileSize(i),r.type=a,r.status=this.statusForFormUpload(i,t),r},e.prototype.statusForFormUpload=function(i,t){for(var r=!0,o,a=0,n=i;a<n.length;a++){var s=n[a];o=s.status;var l=this.validatedFileSize(s.size);(l.minSize!==""||l.maxSize!=="")&&(r=!1,o=l.minSize!==""?this.localizedTexts("invalidMinFileSize"):l.maxSize!==""?this.localizedTexts("invalidMaxFileSize"):o);var p=this.checkExtension(this.getFilesInArray(s))[0].status;p===this.localizedTexts("invalidFileType")&&(r=!1,o=p)}return r?o=this.localizedTexts("totalFiles")+": "+i.length+" , "+this.localizedTexts("size")+": "+this.bytesToSize(this.getFileSize(i)):(t.classList.add(ye),o=i.length>1?this.localizedTexts("invalidFileSelection"):o),o},e.prototype.formCustomFileList=function(i,t){this.createParentUL();var r=this.createElement("li",{className:ze});r.setAttribute("data-files-count",i.length+""),this.setListToFileInfo(i,r);var o=this.mergeFileInfo(i,r);r.setAttribute("data-file-name",o.name),this.uploadTemplateFn=this.templateComplier(this.template);var a=this.uploadTemplateFn(o,this,"template",this.element.id+"Template",this.isStringTemplate,null,r);if(a){var n=[].slice.call(a);it(n,r)}var s=this.listParent.querySelectorAll("li").length;r.classList.contains(ye)||this.createFormInput(i);var l={element:r,fileInfo:o,index:s,isPreload:this.isPreLoadFile(o)},p={element:r,fileInfo:o,index:s,isPreload:this.isPreLoadFile(o)};this.trigger("rendering",l),this.trigger("fileListRendering",p),this.listParent.appendChild(r),this.fileList.push(r),this.renderReactTemplates()},e.prototype.createFileList=function(i){this.filesData=this.filesData&&this.filesData.length>0?this.filesData.concat(i):i,this.internalCreateFileList(i)},e.prototype.internalCreateFileList=function(i){if(this.createParentUL(),this.template!==""&&!C(this.template))this.isFormUpload()?(this.uploadWrapper.classList.add(ft),this.formCustomFileList(i,this.element.files)):this.createCustomfileList(i);else if(this.isFormUpload())this.uploadWrapper.classList.add(ft),this.formFileList(i,this.element.files);else for(var t=0,r=i;t<r.length;t++){var o=r[t],a=this.createElement("li",{className:ze,attrs:{"data-file-name":o.name,"data-files-count":"1"}}),n=this.createElement("span",{className:qe}),s=this.createElement("span",{className:nt,attrs:{title:o.name}});s.innerHTML=this.getFileNameOnly(o.name);var l=this.createElement("span",{className:st}),p=this.getFileType(o.name);if(l.innerHTML="."+p,p||l.classList.add("e-hidden"),!this.enableRtl)n.appendChild(s),n.appendChild(l);else{var h=this.createElement("span",{className:ut});h.appendChild(l),h.appendChild(s),n.appendChild(h)}var u=this.createElement("span",{className:lt});u.innerHTML=this.bytesToSize(o.size),n.appendChild(u);var c=this.createElement("span",{className:N});n.appendChild(c),c.innerHTML=o.status,a.appendChild(n);var g=this.createElement("span",{className:" e-icons",attrs:{tabindex:this.btnTabIndex}});this.browserName==="msie"&&g.classList.add("e-msie"),g.setAttribute("title",this.localizedTexts("remove")),a.appendChild(g),I.add(g,"click",this.removeFiles,this),o.statusCode==="2"?(c.classList.add(le),g.classList.add(oe),g.setAttribute("title",this.localizedTexts("delete")),g.setAttribute("aria-label",this.localizedTexts("delete"))):o.statusCode!=="1"&&(c.classList.remove(le),c.classList.add(ht)),this.autoUpload&&o.statusCode==="1"&&this.asyncSettings.saveUrl!==""&&(c.innerHTML=""),g.classList.contains(oe)||(g.classList.add(ee),g.setAttribute("aria-label",this.localizedTexts("remove")));var v=i.indexOf(o),b={element:a,fileInfo:o,index:v,isPreload:this.isPreLoadFile(o)},m={element:a,fileInfo:o,index:v,isPreload:this.isPreLoadFile(o)};this.trigger("rendering",b),this.trigger("fileListRendering",m),this.listParent.appendChild(a),this.fileList.push(a),this.truncateName(s);var y=this.flag;this.isPreLoadFile(o)&&(this.flag=!1,this.checkActionComplete(!0),this.flag=y)}},e.prototype.getSlicedName=function(i){var t=i.textContent;i.dataset.tail=t.slice(t.length-10)},e.prototype.setListToFileInfo=function(i,t){for(var r=0,o=i;r<o.length;r++){var a=o[r];a.list=t}},e.prototype.truncateName=function(i){var t=i;this.browserName!=="edge"&&t.offsetWidth<t.scrollWidth?this.getSlicedName(t):t.offsetWidth+1<t.scrollWidth&&this.getSlicedName(t)},e.prototype.getFileType=function(i){var t,r=i.lastIndexOf(".");return r>=0&&(t=i.substring(r+1)),t||""},e.prototype.getFileNameOnly=function(i){var t=this.getFileType(i),r=i.split("."+t);return t=r[0]},e.prototype.setInitialAttributes=function(){if(this.initialAttr.accept&&this.element.setAttribute("accept",this.initialAttr.accept),this.initialAttr.disabled&&this.element.setAttribute("disabled","disabled"),this.initialAttr.multiple){var i=document.createAttribute("multiple");this.element.setAttributeNode(i)}},e.prototype.filterfileList=function(i){for(var t=[],r,o=0;o<i.length;o++)r=this.getLiElement(i[o]),(!C(r)&&!r.classList.contains(le)||!this.showFileList&&i[o].status!=="File uploaded successfully")&&t.push(i[o]);return t},e.prototype.updateStatus=function(i,t,r,o){if(o===void 0&&(o=!0),!(t===""||C(t))&&!(r===""||C(r))&&(i.status=t,i.statusCode=r),o){var a=this.getLiElement(i);C(a)||!C(a.querySelector("."+N))&&!(t===""||C(t))&&(a.querySelector("."+N).textContent=t)}return i},e.prototype.getLiElement=function(i){for(var t,r=0;r<this.filesData.length;r++)!C(i)&&(!C(this.filesData[r].id)&&!C(i.id)?this.filesData[r].name===i.name&&this.filesData[r].id===i.id:this.filesData[r].name===i.name)&&(t=r);return this.fileList[t]},e.prototype.createProgressBar=function(i){var t=this.createElement("span",{className:Ce}),r=this.createElement("progressbar",{className:Le,attrs:{value:"0",max:"100"}}),o=this.createElement("span",{className:Kt});r.setAttribute("style","width: 0%");var a=this.createElement("span",{className:We});a.textContent="0%",o.appendChild(r),t.appendChild(o),t.appendChild(a),i.querySelector("."+qe).appendChild(t)},e.prototype.updateProgressbar=function(i,t){if(!isNaN(Math.round(i.loaded/i.total*100))&&!C(t.querySelector("."+Le)))if(!C(this.progressInterval)&&this.progressInterval!==""){var r=Math.round(i.loaded/i.total*100)%parseInt(this.progressInterval,10);(r===0||r===100)&&this.changeProgressValue(t,Math.round(i.loaded/i.total*100).toString()+"%")}else this.changeProgressValue(t,Math.round(i.loaded/i.total*100).toString()+"%")},e.prototype.changeProgressValue=function(i,t){i.querySelector("."+Le).setAttribute("style","width:"+t),i.querySelector("."+We).textContent=t},e.prototype.uploadInProgress=function(i,t,r,o){var a=this.getLiElement(t);if(!(C(a)&&!r)){if(C(a))this.cancelUploadingFile(t,i,o);else{t.statusCode==="5"&&this.cancelUploadingFile(t,i,o,a),!(a.querySelectorAll("."+Ce).length>0)&&a.querySelector("."+N)&&(a.querySelector("."+N).classList.add(ae),this.createProgressBar(a),this.updateProgressBarClasses(a,ae),a.querySelector("."+N).classList.remove(ne)),this.updateProgressbar(i,a);var n=a.querySelector("."+ee);C(n)||(n.classList.add(_,ae),n.setAttribute("title",this.localizedTexts("abort")),n.classList.remove(ee))}var s={e:i,operation:"upload",file:this.updateStatus(t,this.localizedTexts("inProgress"),"3")};this.trigger("progress",s)}},e.prototype.cancelUploadingFile=function(i,t,r,o){var a=this;if(i.statusCode==="5"){var n={event:t,fileData:i,cancel:!1,customFormData:[],currentRequest:null};this.trigger("canceling",n,function(s){if(s.cancel){if(i.statusCode="3",!C(o)){var l=o.querySelector("."+_);C(l)||(re(l),J(o.querySelector(".e-spinner-pane")))}}else{r.emitError=!1,r.httpRequest.abort();var p=new FormData;if(i.statusCode==="5"){var h=a.element.getAttribute("name");p.append(h,i.name),p.append("cancel-uploading",i.name),a.updateFormData(p,s.customFormData);var u=new ke(a.asyncSettings.removeUrl,"POST",!0,null);u.emitError=!1,u.beforeSend=function(c){s.currentRequest&&a.updateCustomheader(u.httpRequest,s.currentRequest)},u.onLoad=function(c){return a.removecanceledFile(c,i),{}},u.send(p)}}})}},e.prototype.removecanceledFile=function(i,t){var r=this.getLiElement(t);if(!(C(r)||r.querySelector("."+de)||C(r.querySelector("."+_)))){this.updateStatus(t,this.localizedTexts("fileUploadCancel"),"5"),this.renderFailureState(i,t,r);var o=r.querySelector("."+ee);C(r)||(re(o),C(r.querySelector(".e-spinner-pane"))||J(r.querySelector(".e-spinner-pane")));var a=i&&i.currentTarget?this.getResponse(i):null,n={event:i,response:a,operation:"cancel",file:t};this.trigger("success",n)}},e.prototype.renderFailureState=function(i,t,r){var o=this;this.updateProgressBarClasses(r,ne),this.removeProgressbar(r,"failure"),C(r.querySelector(".e-file-status"))||r.querySelector(".e-file-status").classList.add(ne);var a=r.querySelector("."+_);if(!C(a)){a.classList.remove(_,ae),a.classList.add(ee),a.setAttribute("title",this.localizedTexts("remove")),this.pauseButton=this.createElement("span",{className:"e-icons e-file-reload-btn",attrs:{tabindex:this.btnTabIndex}}),a.parentElement.insertBefore(this.pauseButton,a),this.pauseButton.setAttribute("title",this.localizedTexts("retry")),this.pauseButton.setAttribute("aria-label",this.localizedTexts("retry"));var n=r.querySelector("."+de);n.addEventListener("click",function(s){o.reloadcanceledFile(s,t,r,!1)},!1)}},e.prototype.reloadcanceledFile=function(i,t,r,o){t.statusCode="1",t.status=this.localizedTexts("readyToUploadMessage"),o||(C(r.querySelector("."+N))||r.querySelector("."+N).classList.remove(ne),C(r.querySelector("."+de))||J(r.querySelector("."+de)),this.pauseButton=null),C(r)||r.classList.add(Fe),this.upload([t])},e.prototype.uploadComplete=function(i,t,r){var o=i.target;if(o.readyState===4&&o.status>=200&&o.status<=299){var a=this.getLiElement(t);if(C(a)&&(!r||C(r))&&this.showFileList)return;if(!C(a)){this.updateProgressBarClasses(a,le),this.removeProgressbar(a,"success");var n=a.querySelector("."+_);C(n)||(n.classList.add(oe),n.setAttribute("title",this.localizedTexts("delete")),n.setAttribute("aria-label",this.localizedTexts("delete")),n.classList.remove(_),n.classList.remove(ae))}this.raiseSuccessEvent(i,t)}else this.uploadFailed(i,t)},e.prototype.getResponse=function(i){var t=i.currentTarget,r={readyState:t.readyState,statusCode:t.status,statusText:t.statusText,headers:t.getAllResponseHeaders(),withCredentials:t.withCredentials};return r},e.prototype.raiseSuccessEvent=function(i,t){var r=this,o=i&&i.currentTarget?this.getResponse(i):null,a=this.localizedTexts("uploadSuccessMessage"),n={e:i,response:o,operation:"upload",file:this.updateStatus(t,a,"2",!1),statusText:a},s=this.getLiElement(t);if(!C(s)){var l=s.querySelector("."+pt);C(l)||(re(s),J(l))}this.trigger("success",n,function(p){r.updateStatus(t,p.statusText,"2"),r.multiple?r.uploadedFilesData.push(t):r.uploadedFilesData=[t],r.trigger("change",{file:r.uploadedFilesData}),r.checkActionButtonStatus(),r.fileList.length>0?r.getLiElement(t).classList.contains(Fe)?r.getLiElement(t).classList.remove(Fe):(r.uploadSequential(),r.checkActionComplete(!0)):r.showFileList||r.checkActionComplete(!0)})},e.prototype.uploadFailed=function(i,t){var r=this,o=this.getLiElement(t),a=i&&i.currentTarget?this.getResponse(i):null,n=this.localizedTexts("uploadFailedMessage"),s={e:i,response:a,operation:"upload",file:this.updateStatus(t,n,"0",!1),statusText:n};C(o)||this.renderFailureState(i,t,o),this.trigger("failure",s,function(l){r.updateStatus(t,l.statusText,"0"),r.checkActionButtonStatus(),r.uploadSequential(),r.checkActionComplete(!0)})},e.prototype.uploadSequential=function(){this.sequentialUpload&&(this.autoUpload?this.checkAutoUpload(this.filesData):this.uploadButtonClick())},e.prototype.checkActionComplete=function(i){i?++this.actionCompleteCount:--this.actionCompleteCount,this.raiseActionComplete()},e.prototype.raiseActionComplete=function(){if(this.filesData.length===this.actionCompleteCount&&this.flag){this.flag=!1;var i={fileData:[]};i.fileData=this.getSelectedFileStatus(this.selectedFiles),this.trigger("actionComplete",i)}},e.prototype.getSelectedFileStatus=function(i){for(var t=[],r=0,o=0;o<i.length;o++)for(var a=i[o],n=0;n<this.filesData.length;n++)if(this.filesData[n].name===a.name&&this.filesData[n].status===a.status){t[r]=this.filesData[n],++r;break}return t},e.prototype.updateProgressBarClasses=function(i,t){var r=i.querySelector("."+Le);C(r)||(r.classList.add(t),this.actionButtons&&this.clearButton&&this.uploadWrapper&&(t==="e-upload-progress"&&!this.clearButton.hasAttribute("disabled")?this.clearButton.setAttribute("disabled","disabled"):(t==="e-upload-success"||t==="e-upload-fails")&&this.uploadWrapper.querySelectorAll(".e-upload-progress-bar.e-upload-progress:not(.e-upload-success):not(.e-upload-fails)").length===0&&this.clearButton.hasAttribute("disabled")&&this.clearButton.removeAttribute("disabled")))},e.prototype.removeProgressbar=function(i,t){var r=this;C(i.querySelector("."+Ce))||(this.progressAnimation=new At({duration:1250}),this.progressAnimation.animate(i.querySelector("."+Ce),{name:"FadeOut"}),this.progressAnimation.animate(i.querySelector("."+We),{name:"FadeOut"}),setTimeout(function(){r.animateProgressBar(i,t)},750))},e.prototype.animateProgressBar=function(i,t){t==="success"?(i.classList.add(le),C(i.querySelector("."+N))||(i.querySelector("."+N).classList.remove(ae),this.progressAnimation.animate(i.querySelector("."+N),{name:"FadeIn"}),i.querySelector("."+N).classList.add(le))):C(i.querySelector("."+N))||(i.querySelector("."+N).classList.remove(ae),this.progressAnimation.animate(i.querySelector("."+N),{name:"FadeIn"}),i.querySelector("."+N).classList.add(ne)),i.querySelector("."+Ce)&&J(i.querySelector("."+Ce))},e.prototype.setExtensions=function(i){i!==""&&!C(i)?this.element.setAttribute("accept",i):this.element.removeAttribute("accept")},e.prototype.templateComplier=function(i){if(i)try{return typeof i!="function"&&zt(i,document).length?xe(Ae(i,document).innerHTML.trim()):xe(i)}catch{return xe(i)}},e.prototype.setRTL=function(){this.enableRtl?we([this.uploadWrapper],dt):je([this.uploadWrapper],dt)},e.prototype.localizedTexts=function(i){return this.l10n.setLocale(this.locale),this.l10n.getConstant(i)},e.prototype.setControlStatus=function(){this.enabled?(this.uploadWrapper.classList.contains(Ue)&&this.uploadWrapper.classList.remove(Ue),!C(this.browseButton)&&this.element.hasAttribute("disabled")&&(this.element.removeAttribute("disabled"),this.browseButton.removeAttribute("disabled")),!C(this.clearButton)&&this.clearButton.hasAttribute("disabled")&&this.clearButton.removeAttribute("disabled"),!C(this.uploadButton)&&this.uploadButton.hasAttribute("disabled")&&this.uploadButton.hasAttribute("disabled")):(this.uploadWrapper.classList.add(Ue),this.element.setAttribute("disabled","disabled"),this.browseButton.setAttribute("disabled","disabled"),C(this.clearButton)||this.clearButton.setAttribute("disabled","disabled"),C(this.uploadButton)||this.uploadButton.setAttribute("disabled","disabled"))},e.prototype.checkHTMLAttributes=function(i){for(var t=i?C(this.htmlAttributes)?[]:Object.keys(this.htmlAttributes):["accept","multiple","disabled"],r=0,o=t;r<o.length;r++){var a=o[r];if(!C(this.element.getAttribute(a)))switch(a){case"accept":(C(this.uploaderOptions)||this.uploaderOptions.allowedExtensions===void 0||i)&&(this.setProperties({allowedExtensions:this.element.getAttribute("accept")},!i),this.initialAttr.accept=this.allowedExtensions);break;case"multiple":if(C(this.uploaderOptions)||this.uploaderOptions.multiple===void 0||i){var n=this.element.getAttribute(a)==="multiple"||this.element.getAttribute(a)===""||this.element.getAttribute(a)==="true";this.setProperties({multiple:n},!i),this.initialAttr.multiple=!0}break;case"disabled":if(C(this.uploaderOptions)||this.uploaderOptions.enabled===void 0||i){var s=!(this.element.getAttribute(a)==="disabled"||this.element.getAttribute(a)===""||this.element.getAttribute(a)==="true");this.setProperties({enabled:s},!i),this.initialAttr.disabled=!0}}}},e.prototype.chunkUpload=function(i,t,r){var o=0,a=Math.min(this.asyncSettings.chunkSize,i.size),n=0,s=i.rawFile.slice(o,a),l={chunkIndex:n,blob:s,file:i,start:o,end:a,retryCount:0,request:null};this.sendRequest(i,l,t,r)},e.prototype.sendRequest=function(i,t,r,o){var a=this,n=new FormData,s=i.rawFile.slice(t.start,t.end);n.append(this.uploaderName,s,i.name),n.append("chunk-index",t.chunkIndex.toString()),n.append("chunkIndex",t.chunkIndex.toString());var l=Math.max(Math.ceil(i.size/this.asyncSettings.chunkSize),1);n.append("total-chunk",l.toString()),n.append("totalChunk",l.toString());var p=new ke({url:this.asyncSettings.saveUrl,type:"POST",async:!0,contentType:null});p.emitError=!1,p.onLoad=function(u){return a.chunkUploadComplete(u,t,r),{}},p.onUploadProgress=function(u){return a.chunkUploadInProgress(u,t,r),{}};var h={fileData:i,customFormData:[],cancel:!1,chunkSize:this.asyncSettings.chunkSize===0?null:this.asyncSettings.chunkSize};p.beforeSend=function(u){h.currentRequest=p.httpRequest,h.currentChunkIndex=t.chunkIndex,h.currentChunkIndex===0?a.trigger("uploading",h,function(c){a.uploadingEventCallback(n,c,u,i)}):a.trigger("chunkUploading",h,function(c){a.uploadingEventCallback(n,c,u,i)})},p.onError=function(u){return a.chunkUploadFailed(u,t,r),{}},p.send(n),t.request=p},e.prototype.uploadingEventCallback=function(i,t,r,o){t.cancel?this.eventCancelByArgs(r,t,o):this.updateFormData(i,t.customFormData)},e.prototype.eventCancelByArgs=function(i,t,r){var o=this;if(i.cancel=!0,t.fileData.statusCode!=="5"){t.fileData.statusCode="5",t.fileData.status=this.localizedTexts("fileUploadCancel");var a=this.getLiElement(t.fileData);if(a){C(a.querySelector("."+N))||(a.querySelector("."+N).innerHTML=this.localizedTexts("fileUploadCancel"),a.querySelector("."+N).classList.add(ne)),this.pauseButton=this.createElement("span",{className:"e-icons e-file-reload-btn",attrs:{tabindex:this.btnTabIndex}});var n=a.querySelector("."+ee);n&&n.parentElement.insertBefore(this.pauseButton,n),this.pauseButton.setAttribute("title",this.localizedTexts("retry")),this.pauseButton.addEventListener("click",function(s){o.reloadcanceledFile(s,r,a)},!1),this.checkActionButtonStatus()}}},e.prototype.checkChunkUpload=function(){return!(this.asyncSettings.chunkSize<=0||C(this.asyncSettings.chunkSize))},e.prototype.chunkUploadComplete=function(i,t,r){var o=this,a=i.target,n;if(a.readyState===4&&a.status>=200&&a.status<300){var s=i&&i.currentTarget?this.getResponse(i):null,l=Math.max(Math.ceil(t.file.size/this.asyncSettings.chunkSize),1),p={event:i,file:t.file,chunkIndex:t.chunkIndex,totalChunk:l,chunkSize:this.asyncSettings.chunkSize,response:s};if(this.trigger("chunkSuccess",p),(C(r)||!r)&&(n=this.getLiElement(t.file)),this.updateMetaData(t),t.end===t.file.size&&(t.file.statusCode="3"),t.file.statusCode==="5"){var h={event:i,fileData:t.file,cancel:!1,customFormData:[]};this.trigger("canceling",h,function(c){if(c.cancel){t.file.statusCode="3";var g=n.querySelector("."+_);!C(n)&&!C(g)&&(re(g),J(n.querySelector(".e-spinner-pane"))),o.sendNextRequest(t)}else{t.request.emitError=!1,a.abort();var v=new FormData,b=o.element.getAttribute("name");v.append(b,t.file.name),v.append("cancel-uploading",t.file.name),v.append("cancelUploading",t.file.name),o.updateFormData(v,c.customFormData);var m=new ke(o.asyncSettings.removeUrl,"POST",!0,null);m.emitError=!1,m.onLoad=function(y){return o.removeChunkFile(y,t,r),{}},m.send(v)}})}else{if(l-1===t.chunkIndex&&l>t.chunkIndex){var u=this.pausedData.indexOf(t);u>=0&&this.pausedData.splice(u,1),C(this.template)&&(C(r)||!r)&&n&&(n&&!C(n.querySelector("."+te))&&J(n.querySelector("."+te)),this.removeChunkProgressBar(t)),this.raiseSuccessEvent(i,t.file);return}t.file.statusCode!=="4"&&this.sendNextRequest(t)}}else this.chunkUploadFailed(i,t)},e.prototype.sendNextRequest=function(i){i.start=i.end,i.end+=this.asyncSettings.chunkSize,i.end=Math.min(i.end,i.file.size),i.chunkIndex+=1,this.sendRequest(i.file,i)},e.prototype.removeChunkFile=function(i,t,r){if(C(this.template)&&C(r)&&!r){var o=this.getLiElement(t.file),a=o.querySelector("."+_),n=a;this.updateStatus(t.file,this.localizedTexts("fileUploadCancel"),"5"),this.updateProgressBarClasses(o,ne),this.removeProgressbar(o,"failure"),a&&(a.classList.remove(_),a.classList.add(ee),a.setAttribute("title",this.localizedTexts("remove")));var s=o.querySelector("."+te);s&&(s.classList.add(de),s.classList.remove(te),s.setAttribute("title",this.localizedTexts("retry"))),!C(o)&&!C(a)&&!C(o.querySelector(".e-spinner-pane"))&&(re(n),J(o.querySelector(".e-spinner-pane")))}},e.prototype.pauseUpload=function(i,t,r){i.file.statusCode="4",i.file.status=this.localizedTexts("pause"),this.updateMetaData(i);var o={event:t||null,file:i.file,chunkIndex:i.chunkIndex,chunkCount:Math.round(i.file.size/this.asyncSettings.chunkSize),chunkSize:this.asyncSettings.chunkSize};this.abortUpload(i,r,o),this.sequentialUpload&&this.uploadSequential()},e.prototype.abortUpload=function(i,t,r){i.file.statusCode!=="4"&&(i.request.emitError=!1,i.request.httpRequest.abort());var o=this.getLiElement(i.file);if(C(this.template)&&(C(t)||!t)){var a=o.querySelector("."+te);a.classList.remove(te),a.classList.add(me),a.setAttribute("title",this.localizedTexts("resume")),a.nextElementSibling.classList.add(ee),a.nextElementSibling.classList.remove(_),a.nextElementSibling.setAttribute("title",this.localizedTexts("remove"))}for(var n=0;n<this.pausedData.length;n++)this.pausedData[n].file.name===i.file.name&&this.pausedData.splice(n,1);this.pausedData.push(i),this.trigger("pausing",r)},e.prototype.resumeUpload=function(i,t,r){var o=this.getLiElement(i.file),a;C(o)||(a=o.querySelector("."+me)),!C(a)&&(C(r)||!r)&&(a.classList.remove(me),a.classList.add(te),a.setAttribute("title",this.localizedTexts("pause")),a.nextElementSibling.classList.remove(ee),a.nextElementSibling.classList.add(_),a.nextElementSibling.setAttribute("title",this.localizedTexts("abort"))),i.file.status=this.localizedTexts("inProgress"),i.file.statusCode="3",this.updateMetaData(i);var n={event:t||null,file:i.file,chunkIndex:i.chunkIndex,chunkCount:Math.round(i.file.size/this.asyncSettings.chunkSize),chunkSize:this.asyncSettings.chunkSize};this.trigger("resuming",n);for(var s=0;s<this.pausedData.length;s++)this.pausedData[s].end===this.pausedData[s].file.size?this.chunkUploadComplete(t,i,r):this.pausedData[s].file.name===i.file.name&&(this.pausedData[s].start=this.pausedData[s].end,this.pausedData[s].end=this.pausedData[s].end+this.asyncSettings.chunkSize,this.pausedData[s].end=Math.min(this.pausedData[s].end,this.pausedData[s].file.size),this.pausedData[s].chunkIndex=this.pausedData[s].chunkIndex+1,this.sendRequest(this.pausedData[s].file,this.pausedData[s],r))},e.prototype.updateMetaData=function(i){this.uploadMetaData.indexOf(i)===-1?this.uploadMetaData.push(i):(this.uploadMetaData.splice(this.uploadMetaData.indexOf(i),1),this.uploadMetaData.push(i))},e.prototype.removeChunkProgressBar=function(i){var t=this.getLiElement(i.file);if(!C(t)){this.updateProgressBarClasses(t,le),this.removeProgressbar(t,"success");var r=t.querySelector("."+_);C(r)||(r.classList.add(oe),r.setAttribute("title",this.localizedTexts("delete")),r.classList.remove(_,ae))}},e.prototype.chunkUploadFailed=function(i,t,r){var o=this,a=Math.max(Math.ceil(t.file.size/this.asyncSettings.chunkSize),1),n;C(this.template)&&(C(r)||!r)&&(n=this.getLiElement(t.file));var s=i&&i.currentTarget?this.getResponse(i):null,l={event:i,file:t.file,chunkIndex:t.chunkIndex,totalChunk:a,chunkSize:this.asyncSettings.chunkSize,cancel:!1,response:s};this.trigger("chunkFailure",l,function(p){if(!p.cancel)if(t.retryCount<o.asyncSettings.retryCount)setTimeout(function(){o.retryRequest(n,t,r)},o.asyncSettings.retryAfterDelay);else{if(!C(n)){var h=n.querySelector("."+te)?n.querySelector("."+te):n.querySelector("."+me);C(h)||(h.classList.add(de),h.classList.remove(te,me)),o.updateProgressBarClasses(n,ne),o.removeProgressbar(n,"failure"),n.querySelector(".e-icons").classList.remove(ae);var u=n.querySelector("."+_)?n.querySelector("."+_):n.querySelector("."+ee);u.classList.remove(_),C(n.querySelector("."+te))||J(n.querySelector("."+te)),t.start>0?(u.classList.add(oe),u.setAttribute("title",o.localizedTexts("delete"))):(u.classList.add(ee),u.setAttribute("title",o.localizedTexts("remove")))}t.retryCount=0;var c=t.file,g=o.localizedTexts("uploadFailedMessage"),v={e:i,response:s,operation:"upload",file:o.updateStatus(c,g,"0",!1),statusText:g};o.trigger("failure",v,function(b){o.updateStatus(c,b.statusText,"0"),o.uploadSequential(),o.checkActionComplete(!0)})}})},e.prototype.retryRequest=function(i,t,r){C(this.template)&&(C(r)||!r)&&i&&this.updateProgressBarClasses(i,ne),t.retryCount+=1,this.sendRequest(t.file,t)},e.prototype.checkPausePlayAction=function(i){var t=i.target,r=i.target.parentElement,o=this.fileList.indexOf(r),a=this.filesData[o],n=this.getCurrentMetaData(a);t.classList.contains(te)?this.pauseUpload(n,i):t.classList.contains(me)?this.resumeUpload(n,i):t.classList.contains(de)&&(n.file.status===this.localizedTexts("fileUploadCancel")?this.retryUpload(n,!1):this.retryUpload(n,!0))},e.prototype.retryUpload=function(i,t){t?(i.end=i.end+this.asyncSettings.chunkSize,i.start=i.start+this.asyncSettings.chunkSize,this.sendRequest(i.file,i)):(i.file.statusCode="1",i.file.status=this.localizedTexts("readyToUploadMessage"),this.chunkUpload(i.file)),this.getLiElement(i.file).classList.add(Fe)},e.prototype.chunkUploadInProgress=function(i,t,r){var o=this;if(t.file.statusCode!=="4"){t.file.statusCode!=="4"&&t.file.statusCode!=="5"&&(t.file.statusCode="3",t.file.status=this.localizedTexts("inProgress")),this.updateMetaData(t);var a=this.getLiElement(t.file);if(!C(a)){var n=a.querySelector("."+de);if(C(n)||(n.classList.add(te),n.setAttribute("title",this.localizedTexts("pause")),n.classList.remove(de)),!C(a)){if(!(a.querySelectorAll("."+Ce).length>0)){var s=a.querySelector("."+N);C(this.template)&&(s.classList.add(ae),s.classList.remove(ne),this.createProgressBar(a),this.updateProgressBarClasses(a,ae));var l=a.querySelector("."+ee)?a.querySelector("."+ee):a.querySelector("."+oe);C(l)||(l.classList.add(_),l.setAttribute("title",this.localizedTexts("abort")),l.classList.remove(ee))}if(!isNaN(Math.round(i.loaded/i.total*100))&&C(this.template)&&t.file.statusCode!=="4"){var p=void 0,h=Math.ceil(t.file.size/this.asyncSettings.chunkSize)-1;this.asyncSettings.chunkSize&&h&&(p=Math.round(t.chunkIndex/h*100),this.changeProgressValue(a,p.toString()+"%"))}t.chunkIndex===0&&this.checkActionButtonStatus()}if(C(a.querySelector("."+te))&&C(this.template)&&C(a.querySelector("."+oe))){this.pauseButton=this.createElement("span",{className:"e-icons e-file-pause-btn",attrs:{tabindex:this.btnTabIndex}}),this.browserName==="msie"&&this.pauseButton.classList.add("e-msie");var u=a.querySelector("."+_);u.parentElement.insertBefore(this.pauseButton,u),this.pauseButton.setAttribute("title",this.localizedTexts("pause")),this.pauseButton.addEventListener("click",function(c){o.checkPausePlayAction(c)},!1)}}}},e.prototype.bytesToSize=function(i){var t=-1;if(!i)return"0.0 KB";do i=i/1024,t++;while(i>99);return t>=2&&(i=i*1024,t=1),Math.max(i,0).toFixed(1)+" "+["KB","MB"][t]},e.prototype.sortFileList=function(i){i=i||this.sortFilesList;for(var t=i,r=[],o=0;o<t.length;o++)r.push(t[o].name);for(var a=r.sort(),n=[],s=0,l=a;s<l.length;s++)for(var p=l[s],o=0;o<t.length;o++)p===t[o].name&&n.push(t[o]);return n},e.prototype.destroy=function(){this.element.value=null,this.clearTemplate(),this.clearAll(),this.unWireEvents(),this.unBindDropEvents(),this.multiple&&this.element.removeAttribute("multiple"),this.enabled||this.element.removeAttribute("disabled"),this.element.removeAttribute("accept"),this.setInitialAttributes();for(var i=["aria-label","directory","webkitdirectory","tabindex"],t=0,r=i;t<r.length;t++){var o=r[t];this.element.removeAttribute(o)}C(this.uploadWrapper)||(this.uploadWrapper.parentElement.appendChild(this.element),J(this.uploadWrapper)),this.uploadWrapper=null,this.uploadWrapper=null,this.browseButton=null,this.dropAreaWrapper=null,this.dropZoneElement=null,this.dropArea=null,this.keyboardModule=null,this.clearButton=null,this.uploadButton=null,d.prototype.destroy.call(this)},e.prototype.upload=function(i,t){var r=this;if(i=i||this.filesData,this.sequentialUpload&&(this.isFirstFileOnSelection||t))this.sequenceUpload(i);else{var o=this.getFilesInArray(i),a={customFormData:[],currentRequest:null,cancel:!1};this.trigger("beforeUpload",a,function(n){n.cancel||(r.customFormDatas=n.customFormData&&n.customFormData.length>0?n.customFormData:r.customFormDatas,r.uploadFiles(o,t))})}},e.prototype.getFilesInArray=function(i){var t=[];return i&&(i instanceof Array?t=i:t.push(i)),t},e.prototype.serverReadFileBase64=function(i,t,r){var o=this;return new Promise(function(a,n){var s=o.fileStreams[i].rawFile;try{var l=new FileReader;l.onload=function(p){return function(){try{var h=p.result,u=h?h.split(";base64,")[1]:null;a(u)}catch(c){n(c)}}}(l),l.readAsDataURL(s.slice(t,t+r))}catch(p){n(p)}})},e.prototype.uploadFileCount=function(i){var t=this.filesData;if(!t||t.length===0)return-1;var r=t.length;return r},e.prototype.getFileRead=function(i,t){var r=this.filesData;if(!r||r.length===0)return-1;var o=r[i],a=this.newFileRef++;return this.fileStreams[a]=o,a},e.prototype.uploadFiles=function(i,t){var r=[];if(!(this.asyncSettings.saveUrl===""||C(this.asyncSettings.saveUrl))){if(!t||C(t))if(this.multiple)r=this.filterfileList(i);else{var o=[];o.push(i[0]),r=this.filterfileList(o)}else r=i;for(var a=0;a<r.length;a++)this.uploadFilesRequest(r,a,t)}},e.prototype.uploadFilesRequest=function(i,t,r){var o=this,a=this.checkChunkUpload(),n=new ke(this.asyncSettings.saveUrl,"POST",!0,null);n.emitError=!1;var s={fileData:i[t],customFormData:[],cancel:!1},l=new FormData;if(n.beforeSend=function(h){s.currentRequest=n.httpRequest,o.trigger("uploading",s,function(u){u.cancel&&o.eventCancelByArgs(h,u,i[t]),o.customFormDatas&&o.customFormDatas.length>0&&o.updateFormData(l,o.customFormDatas),o.updateFormData(l,u.customFormData)})},i[t].statusCode==="1"){var p=this.element.getAttribute("name");l.append(p,i[t].rawFile,i[t].name),a&&i[t].size>this.asyncSettings.chunkSize?this.chunkUpload(i[t],r,t):(n.onLoad=function(h){return s.cancel?{}:(o.uploadComplete(h,i[t],r),{})},n.onUploadProgress=function(h){return s.cancel?{}:(o.uploadInProgress(h,i[t],r,n),{})},n.onError=function(h){return o.uploadFailed(h,i[t]),{}},n.send(l))}},e.prototype.spliceFiles=function(i){for(var t=this.fileList[i],r=this.getFilesData(),o=+t.getAttribute("data-files-count"),a=0,n=0;n<i;n++)a+=+this.fileList[n].getAttribute("data-files-count");for(var s=a+o-1,l=s;l>=a;l--)r.splice(l,1)},e.prototype.remove=function(i,t,r,o,a){var n=this;C(o)&&(o=!0);var s={event:a,cancel:!1,filesData:[],customFormData:[],postRawFile:o,currentRequest:null},l={cancel:!1,customFormData:[],currentRequest:null};this.trigger("beforeRemove",l,function(p){if(!p.cancel)if(n.isFormUpload())s.filesData=i,n.trigger("removing",s,function(y){if(!y.cancel)for(var P=n.getFilesInArray(i),S=!1,O=void 0,j=0,x=P;j<x.length;j++){var k=x[j];if(S||(O=n.fileList.indexOf(k.list)),O>-1){var T=C(k.input)?null:k.input;T&&J(T),n.spliceFiles(O),J(n.fileList[O]),n.fileList.splice(O,1),S=!0,O=-1}}});else if(n.isForm&&(C(n.asyncSettings.removeUrl)||n.asyncSettings.removeUrl===""))s.filesData=n.getFilesData(),n.trigger("removing",s,function(y){y.cancel||n.clearAll()});else{var h=[];i=C(i)?n.filesData:i,i instanceof Array?h=i:h.push(i),s.filesData=h;for(var u=n.asyncSettings.removeUrl,c=!(u===""||C(u)),g=function(y){var P=n.uploadedFilesData.indexOf(y);(y.statusCode==="2"||y.statusCode==="4"||y.statusCode==="0"&&P!==-1)&&c?n.removeUploadedFile(y,s,r,t):r?n.removeFilesData(y,t):n.trigger("removing",s,function(S){S.cancel||n.removeFilesData(y,t)}),a&&!a.target.classList.contains(ee)&&n.checkActionComplete(!1)},v=0,b=h;v<b.length;v++){var m=b[v];g(m)}}})},e.prototype.clearAll=function(){var i=this;if(C(this.listParent)){this.browserName!=="msie"&&(this.element.value=""),this.filesData=[];return}var t={cancel:!1,filesData:this.filesData};this.trigger("clearing",t,function(r){r.cancel||(i.clearData(),i.actionCompleteCount=0,i.count=-1)})},e.prototype.getFilesData=function(i){return C(i)?this.filesData:this.getSelectedFiles(i)},e.prototype.pause=function(i,t){i=i||this.filesData;var r=this.getFilesInArray(i);this.pauseUploading(r,t)},e.prototype.pauseUploading=function(i,t){for(var r=this.getFiles(i),o=0;o<r.length;o++)r[o].statusCode==="3"&&this.pauseUpload(this.getCurrentMetaData(r[o],null),null,t)},e.prototype.getFiles=function(i){var t=[];return!C(i)&&!(i instanceof Array)?t.push(i):t=i,t},e.prototype.resume=function(i,t){i=i||this.filesData;var r=this.getFilesInArray(i);this.resumeFiles(r,t)},e.prototype.resumeFiles=function(i,t){for(var r=this.getFiles(i),o=0;o<r.length;o++)r[o].statusCode==="4"&&this.resumeUpload(this.getCurrentMetaData(r[o],null),null,t)},e.prototype.retry=function(i,t,r){i=i||this.filesData;var o=this.getFilesInArray(i);this.sequentialUpload&&this.isFirstFileOnSelection&&(this.isFirstFileOnSelection=!1),this.retryFailedFiles(o,t,r)},e.prototype.retryFailedFiles=function(i,t,r){for(var o=this.getFiles(i),a=0;a<o.length;a++)if(o[a].statusCode==="5"||o[a].statusCode==="0")if(this.asyncSettings.chunkSize>0&&this.getCurrentMetaData(o[a],null))this.retryUpload(this.getCurrentMetaData(o[a],null),t);else{var n=void 0;r||(n=this.fileList[this.filesData.indexOf(o[a])]),this.reloadcanceledFile(null,o[a],n,r)}},e.prototype.cancel=function(i){i=i||this.filesData;var t=this.getFilesInArray(i);this.cancelUpload(t)},e.prototype.cancelUpload=function(i){var t=this.getFiles(i);if(this.asyncSettings.chunkSize>0){for(var r=0;r<t.length;r++)if(t[r].statusCode==="3"){var o=this.getCurrentMetaData(t[r],null);o.file.statusCode="5",o.file.status=this.localizedTexts("fileUploadCancel"),this.updateMetaData(o),this.showHideUploadSpinner(t[r])}}else for(var r=0;r<t.length;r++)t[r].statusCode==="3"&&(t[r].statusCode="5",t[r].status=this.localizedTexts("fileUploadCancel"),this.showHideUploadSpinner(t[r]))},e.prototype.showHideUploadSpinner=function(i){var t=this.getLiElement(i);if(!C(t)&&C(this.template)){var r=t.querySelector("."+_);Re({target:r,width:"20px"}),ue(r)}},Y([be({saveUrl:"",removeUrl:""},ri)],e.prototype,"asyncSettings",void 0),Y([X(!1)],e.prototype,"sequentialUpload",void 0),Y([X({})],e.prototype,"htmlAttributes",void 0),Y([X("")],e.prototype,"cssClass",void 0),Y([X(!0)],e.prototype,"enabled",void 0),Y([X(null)],e.prototype,"template",void 0),Y([X(!0)],e.prototype,"multiple",void 0),Y([X(!0)],e.prototype,"autoUpload",void 0),Y([X(!0)],e.prototype,"enableHtmlSanitizer",void 0),Y([be({},ii)],e.prototype,"buttons",void 0),Y([X("")],e.prototype,"allowedExtensions",void 0),Y([X(0)],e.prototype,"minFileSize",void 0),Y([X(3e7)],e.prototype,"maxFileSize",void 0),Y([X(null)],e.prototype,"dropArea",void 0),Y([Lt([{}],ti)],e.prototype,"files",void 0),Y([X(!0)],e.prototype,"showFileList",void 0),Y([X(!1)],e.prototype,"directoryUpload",void 0),Y([X("Default")],e.prototype,"dropEffect",void 0),Y([M()],e.prototype,"created",void 0),Y([M()],e.prototype,"actionComplete",void 0),Y([M()],e.prototype,"rendering",void 0),Y([M()],e.prototype,"beforeUpload",void 0),Y([M()],e.prototype,"fileListRendering",void 0),Y([M()],e.prototype,"selected",void 0),Y([M()],e.prototype,"uploading",void 0),Y([M()],e.prototype,"success",void 0),Y([M()],e.prototype,"failure",void 0),Y([M()],e.prototype,"removing",void 0),Y([M()],e.prototype,"beforeRemove",void 0),Y([M()],e.prototype,"clearing",void 0),Y([M()],e.prototype,"progress",void 0),Y([M()],e.prototype,"change",void 0),Y([M()],e.prototype,"chunkSuccess",void 0),Y([M()],e.prototype,"chunkFailure",void 0),Y([M()],e.prototype,"chunkUploading",void 0),Y([M()],e.prototype,"canceling",void 0),Y([M()],e.prototype,"pausing",void 0),Y([M()],e.prototype,"resuming",void 0),e=Y([wt],e),e}(xt),oi=function(){function d(e){this.croppedDegree=0,this.cropDestPoints={startX:0,startY:0,width:0,height:0},this.tempFlipPanPoint={x:0,y:0},this.isPreventScaling=!1,this.isInitCrop=!1,this.isTransformCrop=!1,this.parent=e,this.addEventListener()}return d.prototype.destroy=function(){this.parent.isDestroyed||this.removeEventListener()},d.prototype.addEventListener=function(){this.parent.on("crop",this.cropping,this),this.parent.on("destroyed",this.destroy,this)},d.prototype.removeEventListener=function(){this.parent.off("crop",this.cropping),this.parent.off("destroyed",this.destroy)},d.prototype.cropping=function(e){switch(this.updateCropPvtVar(),e.prop){case"cropCircle":this.cropCircle(e.value.context,e.value.isSave,e.value.isFlip);break;case"setCurrSelPoints":this.setCurrSelPoints(e.value.isSetDimension);break;case"updateRotatePan":this.updateRotatePan();break;case"crop":this.crop(e.value.obj);break;case"calcRatio":this.calcRatio(e.value.obj,e.value.dimension);break;case"getCurrFlipState":this.getCurrFlipState(e.value.panObj);break;case"getPreviousCropCurrentObj":e.value.obj.prevObj=this.prevCropCurrObj;break;case"setPreviousCropCurrentObj":this.prevCropCurrObj=e.value.obj;break;case"setCropDestPoints":this.cropDestPoints=e.value.point;break;case"getTempFlipPanPoint":e.value.obj.point=this.tempFlipPanPoint;break;case"setTempFlipPanPoint":C(e.value.isAdd)?this.tempFlipPanPoint=e.value.point:(this.tempFlipPanPoint.x+=e.value.point.x,this.tempFlipPanPoint.y+=e.value.point.y);break;case"getPreventScaling":e.value.obj.bool=this.isPreventScaling;break;case"adjustStraightenForShapes":this.adjustStraightenForShapes(e.value.type,e.value.isInitialRotated);break;case"resizeWrapper":this.resizeWrapper();break;case"setTransformCrop":this.isTransformCrop=e.value.bool;break;case"setInitCrop":this.isInitCrop=e.value.bool;break;case"resetZoom":this.resetZoom();break;case"revertTransform":this.revertTransform(e.value.type,e.value.coll);break;case"reset":this.reset();break}},d.prototype.getModuleName=function(){return"crop"},d.prototype.updateCropPvtVar=function(){var e=this.parent;e.lowerCanvas&&(this.lowerContext=e.lowerCanvas.getContext("2d")),e.upperCanvas&&(this.upperContext=e.upperCanvas.getContext("2d"))},d.prototype.reset=function(){this.prevCropCurrObj=null,this.croppedDegree=0,this.cropDestPoints={startX:0,startY:0,width:0,height:0},this.tempFlipPanPoint={x:0,y:0},this.isPreventScaling=!1,this.isInitCrop=!1,this.isTransformCrop=!1},d.prototype.cropImg=function(e){for(var i=this.parent,t=C(e),r=i.element.querySelector("#"+i.element.id+"_nonaspectratio"),o=i.activeObj.activePoint,a=i.img,n=!1,s=0,l=i.rotateFlipColl.length;s<l;s++){var p=i.rotateFlipColl[s];(p===90||p===-90)&&(n=!0)}if(i.notify("draw",{prop:"setImageEdited",onPropertyChange:!1}),(t||r)&&(this.croppedDegree=i.transform.degree),t&&i.transform.degree!==0||n){this.updateCropObj();var h={startX:a.destLeft,startY:a.destTop,width:a.destWidth,height:a.destHeight};i.notify("transform",{prop:"setCurrDestinationPoint",onPropertyChange:!1,value:{point:h}}),this.rotateCrop()}else if(t&&i.transform.currFlipState!==""){this.updateCropObj();var h={startX:a.destLeft,startY:a.destTop,width:a.destWidth,height:a.destHeight};i.notify("transform",{prop:"setCurrDestinationPoint",onPropertyChange:!1,value:{point:h}}),this.flipCrop()}else{this.adjustStraightenForShapes("initial",!1),i.notify("draw",{prop:"setTempZoomFactor",onPropertyChange:!1,value:{tempZoomFactor:i.transform.zoomFactor}});var u=this.calcRatio();if(t||!e){this.updateCropObj(),i.notify("draw",{prop:"resetPanPoints",onPropertyChange:!1}),i.notify("shape",{prop:"updImgRatioForActObj",onPropertyChange:!1});var h={startX:a.destLeft,startY:a.destTop,width:a.destWidth,height:a.destHeight};i.notify("transform",{prop:"setCurrDestinationPoint",onPropertyChange:!1,value:{point:h}}),i.currSelectionPoint=f({},i.activeObj,{},!0),this.cropDestPoints={startX:a.destLeft,startY:a.destTop,width:a.destWidth,height:a.destHeight}}var c={width:0,height:0};i.notify("transform",{prop:"calcMaxDimension",onPropertyChange:!1,value:{width:o.width*u.width,height:o.height*u.height,obj:c,isImgShape:null}});var g=c;this.upperContext.clearRect(0,0,i.upperCanvas.width,i.upperCanvas.height),this.lowerContext.clearRect(0,0,i.lowerCanvas.width,i.lowerCanvas.height),i.img={srcLeft:o.startX*u.width-a.destLeft*u.width,srcTop:o.startY*u.height-a.destTop*u.height,srcWidth:o.width*u.width,srcHeight:o.height*u.height,destLeft:(i.lowerCanvas.clientWidth-g.width)/2,destTop:(i.lowerCanvas.clientHeight-g.height+1)/2,destWidth:g.width,destHeight:g.height};var v=this.lowerContext.filter;i.notify("draw",{prop:"drawImage",onPropertyChange:!1}),this.lowerContext.filter="none";var b=f({},i.activeObj,{},!0);this.cropObjColl(),i.transform.straighten=0,i.activeObj=b,this.cropFreehandDrawColl(),i.shapeColl=[],i.notify("shape",{prop:"updateShapeColl",onPropertyChange:!1}),i.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),i.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),i.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.upperContext}}),i.currSelectionPoint&&i.currSelectionPoint.shape==="crop-circle"?this.cropCircle(this.lowerContext):i.isCircleCrop=!1,this.lowerContext.filter=v,i.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),i.currObjType.isCustomCrop=!1,i.pan(!1),i.transform.defaultZoomFactor=0}},d.prototype.adjustStraightenForShapes=function(e,i){for(var t=this.parent,r={x:t.img.destLeft+t.img.destWidth/2,y:t.img.destTop+t.img.destHeight/2},o=0,a=t.objColl;o<a.length;o++){var n=a[o];if(["rectangle","ellipse","text","image","redact"].indexOf(n.shape)!==-1&&(i||n.rotatedAngle!==0)){var s=n.activePoint,l=s.startX,p=s.startY,h=s.width,u=s.height,c=e==="initial"?n.rotatedAngle:-n.rotatedAngle,g=l+h/2-r.x,v=p+u/2-r.y,b=Math.cos(c),m=Math.sin(c),y=b*g-m*v+r.x,P=m*g+b*v+r.y,S=y-l-h/2,O=P-p-u/2;n.activePoint.startX+=S,n.activePoint.startY+=O,n.activePoint.endX+=S,n.activePoint.endY+=O}}},d.prototype.updateCropObj=function(){this.parent.afterCropActions=[];var e={currObj:{}};this.parent.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:e}});var i=e.currObj;i.straighten=this.parent.transform.straighten,this.parent.cropObj=f({},i,{},!0)},d.prototype.rotateCrop=function(){var e=this.parent,i=this.getCurrFlipState(),t=e.activeObj.shape||"";e.notify("shape",{prop:"updImgRatioForActObj",onPropertyChange:!1}),e.currSelectionPoint=f({},e.activeObj,{},!0),e.objColl.push(e.activeObj),e.activeObj=f({},e.objColl[e.objColl.length-1],{},!0);var r=f({},e.objColl[e.objColl.length-1],{},!0),o=f({},e.currSelectionPoint,{},!0),a={bool:null};e.notify("transform",{prop:"getPreventSelect",onPropertyChange:!1,value:{obj:a}}),e.notify("transform",{prop:"setPreventSelect",onPropertyChange:!1,value:{bool:!0}});var n=f([],e.rotateFlipColl,[],!0);this.panToSelRangle(!0),r=f({},e.objColl[e.objColl.length-1],{},!0),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),e.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:r}}),e.objColl.pop(),e.notify("shape",{prop:"updImgRatioForActObj",onPropertyChange:!1}),e.objColl.push(e.activeObj);var s=e.transform.straighten;s!==0&&(e.transform.straighten=0,e.straightenBaseImageCanvas(),e.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),e.notify("draw",{prop:"render-image",value:{isMouseWheel:!1}})),this.resetZoom();var l=f([],e.afterCropActions,[],!0);this.revertTransform("initial",n),s!==0&&(e.transform.straighten=i==="horizontal"||i==="vertical"?-s:s,e.straightenBaseImageCanvas(),e.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),e.notify("draw",{prop:"render-image",value:{isMouseWheel:!1}}),e.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}})),r=f({},e.objColl[e.objColl.length-1],{},!0),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),e.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:r}}),e.objColl.pop(),e.transform.degree=0;var p={isIntersect:null};e.notify("draw",{prop:"updateImgCanvasPoints",onPropertyChange:!1}),e.notify("draw",{prop:"isLinesIntersect",onPropertyChange:!1,value:{obj:p}});for(var h=0;s!==0&&p.isIntersect&&(h++,h!==50);)e.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:.025,zoomPoint:null},isResize:null}),e.notify("draw",{prop:"updateImgCanvasPoints",onPropertyChange:!1}),e.notify("draw",{prop:"isLinesIntersect",onPropertyChange:!1,value:{obj:p}});this.cropImg(!0),this.revertTransform("reverse",n),e.afterCropActions=l,e.currSelectionPoint=o,e.notify("transform",{prop:"setPreventSelect",onPropertyChange:!1,value:{bool:a.bool}}),e.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),e.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.upperContext}}),t==="crop-circle"&&this.cropCircle(this.lowerContext),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),e.notify("draw",{prop:"resetPanPoints",onPropertyChange:!1})},d.prototype.revertTransform=function(e,i){var t=this.parent,r={isRotate:!1};if(e==="initial")for(var o=i.length-1;o>=0;o--){var a=i[o];switch(a){case 90:t.notify("transform",{prop:"rotate",value:{degree:-90,obj:r}});break;case-90:t.notify("transform",{prop:"rotate",value:{degree:90,obj:r}});break;default:t.notify("transform",{prop:"flipImage",value:{direction:t.toPascalCase(a.toString())}});break}}else{this.updateFlipState();for(var o=0,n=i.length;o<n;o++){var a=i[o];switch(a){case 90:t.notify("transform",{prop:"rotate",value:{degree:90,obj:r}});break;case-90:t.notify("transform",{prop:"rotate",value:{degree:-90,obj:r}});break;default:t.notify("transform",{prop:"flipImage",value:{direction:t.toPascalCase(a.toString())}});break}}}},d.prototype.updateFlipState=function(){for(var e=this.parent,i=e.objColl,t=0,r=i.length;t<r;t++)i[t].shapeFlip="";for(var o=e.pointColl,t=0;t<e.freehandCounter;t++)o[t].shapeFlip=""},d.prototype.resetZoom=function(){var e=this.parent;if(e.transform.zoomFactor>0){var i=e.transform.zoomFactor,t=e.isUndoRedo;e.setProperties({zoomSettings:{zoomFactor:i*10}},!0),e.notify("transform",{prop:"setPreviousZoomValue",onPropertyChange:!1,value:{previousZoomValue:e.zoomSettings.zoomFactor}});for(var r=0;r<i*10;r++)e.isUndoRedo=!0,e.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-.1,zoomPoint:null},isResize:null});e.isUndoRedo=t,e.notify("draw",{prop:"resetPanPoints",onPropertyChange:!1})}},d.prototype.flipCrop=function(){var e=this.parent;e.notify("transform",{prop:"setReverseFlip",onPropertyChange:!1,value:{isReverseFlip:!0}}),e.panPoint.totalPannedPoint.x+=this.tempFlipPanPoint.x,e.panPoint.totalPannedPoint.y+=this.tempFlipPanPoint.y;var i=e.transform.currFlipState,t={flipColl:null};e.notify("transform",{prop:"getFlipColl",onPropertyChange:!1,value:{obj:t}});var r=t.flipColl;if(e.notify("transform",{prop:"setFlipColl",onPropertyChange:!1,value:{flipColl:[]}}),e.notify("shape",{prop:"updImgRatioForActObj",onPropertyChange:!1}),e.objColl.push(e.activeObj),e.transform.degree===0){var o=-e.cropObj.totalPannedPoint.x,a=-e.cropObj.totalPannedPoint.y;e.img.destLeft+=o,e.img.destTop+=a,e.notify("transform",{prop:"drawPannImage",value:{point:{x:o,y:a}}}),e.activeObj=f({},e.objColl[e.objColl.length-1],{},!0),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),e.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:e.activeObj}}),e.objColl.pop(),e.notify("shape",{prop:"updImgRatioForActObj",onPropertyChange:!1}),e.objColl.push(e.activeObj)}this.resetZoom(),e.currSelectionPoint=f({},e.objColl[e.objColl.length-1],{},!0),this.lowerContext.clearRect(0,0,e.lowerCanvas.width,e.lowerCanvas.height),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height);var n=this.lowerContext.filter;e.notify("draw",{prop:"drawImage",onPropertyChange:!1}),this.updateFlipState(),e.notify("shape",{prop:"redrawObj",onPropertyChange:!1,value:{degree:this.getCurrFlipState()}}),e.notify("freehand-draw",{prop:"flipFHDColl",onPropertyChange:!1,value:{value:this.getCurrFlipState()}}),e.activeObj=f({},e.objColl[e.objColl.length-1],{},!0),e.objColl.pop(),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),e.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}}),this.cropImg(!0),e.notify("transform",{prop:"setReverseRotate",onPropertyChange:!1,value:{bool:!0}}),this.lowerContext.setTransform(1,0,0,1,0,0),e.notify("draw",{prop:"setDestPoints",onPropertyChange:!1}),e.notify("draw",{prop:"currTransState",onPropertyChange:!1,value:{type:"initial",isPreventDestination:null,context:null,isPreventCircleCrop:null}}),e.notify("draw",{prop:"drawImage",onPropertyChange:!1}),this.lowerContext.filter=n,e.notify("draw",{prop:"setRotateZoom",onPropertyChange:!1,value:{isRotateZoom:!1}}),e.notify("draw",{prop:"currTransState",onPropertyChange:!1,value:{type:"reverse",isPreventDestination:null,context:null,isPreventCircleCrop:null}}),e.transform.currFlipState=i,e.notify("transform",{prop:"setFlipColl",onPropertyChange:!1,value:{flipColl:r}}),this.lowerContext.filter="none",this.updateFlipState(),e.notify("shape",{prop:"redrawObj",onPropertyChange:!1,value:{degree:this.getCurrFlipState()}}),e.notify("freehand-draw",{prop:"flipFHDColl",onPropertyChange:!1,value:{value:this.getCurrFlipState()}}),e.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),this.lowerContext.filter=n,(e.currSelectionPoint&&e.currSelectionPoint.shape==="crop-circle"||e.isCircleCrop)&&this.cropCircle(this.lowerContext),e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),e.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),e.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.upperContext}}),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),e.notify("transform",{prop:"setReverseFlip",onPropertyChange:!1,value:{isReverseFlip:!1}}),e.notify("draw",{prop:"resetPanPoints",onPropertyChange:!1}),this.tempFlipPanPoint={x:0,y:0}},d.prototype.cropObjColl=function(){var e=this.parent,i,t,r;if(e.objColl.length>0)for(var o=0,a=e.objColl.length;o<a;o++){r=e.objColl[o],i=r.activePoint;var n=e.activeObj.activePoint,s=n.startX,l=n.startY,p=n.width,h=n.height;t=r.shape,r.imageRatio={startX:(i.startX-s)/p,startY:(i.startY-l)/h,endX:(i.endX-s)/p,endY:(i.endY-l)/h,width:p/i.width,height:h/i.height};var u=void 0,c=void 0;switch(t){case"text":u=r.shapeDegree===0?e.transform.degree:e.transform.degree-r.shapeDegree,c=u===0||Math.abs(u)===180?i.width:i.height,r.textSettings.fontRatio=c/r.textSettings.fontSize;break;case"line":case"arrow":this.cropPointCollection(o),t==="arrow"&&e.notify("shape",{prop:"updateArrowRatio",onPropertyChange:!1,value:{obj:r}});break;case"path":this.cropPointCollection(o);break}}},d.prototype.cropPointCollection=function(e){var i=this.parent,t=i.objColl[e].shape,r,o,a,n,s=i.activeObj.activePoint,l=i.img,p=l.destLeft,h=l.destTop,u=l.destWidth,c=l.destHeight;t==="path"?(r=s.startX,o=s.startY,a=s.width,n=s.height):(r=p,o=h,a=u,n=c);for(var g=i.objColl[e].pointColl,v=0,b=g.length;v<b;v++)g[v].ratioX=(g[v].x-r)/a,g[v].ratioY=(g[v].y-o)/n},d.prototype.cropFreehandDrawColl=function(){for(var e=this.parent,i=e.activeObj.activePoint,t=i.startX,r=i.startY,o=i.width,a=i.height,n=0;n<e.freehandCounter;n++){e.points=f([],e.pointColl[n].points,[]),e.notify("freehand-draw",{prop:"setPointCounter",onPropertyChange:!1,value:{value:0}});for(var s=e.points.length,l=0;l<s;l++)e.points[l].ratioX=(e.points[l].x-t)/o,e.points[l].ratioY=(e.points[l].y-r)/a}e.notify("freehand-draw",{prop:"updateCropPtsForSel",onPropertyChange:!1})},d.prototype.resetAnnotations=function(){var e=this.parent;e.objColl=[],e.pointColl=[],e.freehandCounter=0,e.notify("freehand-draw",{prop:"resetStraightenPoint"})},d.prototype.setCurrSelPoints=function(e){var i=this.parent;i.allowDownScale=!1;var t=this.cropDestPoints,r=this.lowerContext.filter,o=i.isCropTab;i.img={srcLeft:0,srcTop:0,srcWidth:i.baseImgCanvas.width,srcHeight:i.baseImgCanvas.height,destLeft:t.startX,destTop:t.startY,destWidth:t.width,destHeight:t.height};var a=i.img,n=i.currSelectionPoint;this.lowerContext.clearRect(0,0,i.lowerCanvas.width,i.lowerCanvas.height),e&&i.notify("draw",{prop:"setDestPoints",onPropertyChange:!1}),i.notify("draw",{prop:"currTransState",onPropertyChange:!1,value:{type:"initial",isPreventDestination:null,context:null,isPreventCircleCrop:null}}),this.croppedDegree===0&&i.transform.degree===0&&n&&n.shape!=="crop-circle"&&n.shape!=="crop-square"&&(a.destLeft=t.startX,a.destTop=t.startY,a.destWidth=t.width,a.destHeight=t.height),i.transform.degree===0&&(a.destLeft+=i.panPoint.totalPannedInternalPoint.x,a.destTop+=i.panPoint.totalPannedInternalPoint.y),i.notify("draw",{prop:"drawImage",onPropertyChange:!1}),this.lowerContext.filter=r,i.notify("draw",{prop:"currTransState",onPropertyChange:!1,value:{type:"reverse",isPreventDestination:null,context:null,isPreventCircleCrop:!0}});var s=f([],i.objColl,null,!0),l=f([],i.pointColl,null,!0),p={straightenPoint:null};if(i.notify("freehand-draw",{prop:"getStraightenPoint",onPropertyChange:!1,value:{obj:p}}),this.resetAnnotations(),C(i.activeObj.shape)&&i.cropObj.activeObj.shape&&(i.activeObj=f({},i.cropObj.activeObj,null,!0)),this.panToSelRangle(),i.isCropTab=o,i.objColl=s,i.pointColl=l,i.freehandCounter=i.pointColl.length,p.straightenPoint.x&&p.straightenPoint.y&&i.notify("freehand-draw",{prop:"setStraightenPoint",onPropertyChange:!1,value:{x:p.straightenPoint.x,y:p.straightenPoint.y,ratioX:p.straightenPoint.ratioX,ratioY:p.straightenPoint.ratioY}}),i.cropObj.activeObj.shape){var h={startX:a.destLeft,startY:a.destTop,width:a.destWidth,height:a.destHeight};if(n&&n.activePoint){var u=n.activePoint,c=u.startX,g=u.startY,v=u.width,b=u.height;a.destLeft=c,a.destTop=g,a.destWidth=v,a.destHeight=b}i.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),a.destLeft=h.startX,a.destTop=h.startY,a.destWidth=h.width,a.destHeight=h.height,i.notify("freehand-draw",{prop:"updateFHDColl",onPropertyChange:!1}),s=f([],i.objColl,null,!0),l=f([],i.pointColl,null,!0),i.notify("freehand-draw",{prop:"getStraightenPoint",onPropertyChange:!1,value:{obj:p}}),this.resetAnnotations();var m={selPointColl:null};i.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:m}});var y=m.selPointColl;i.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:[]}}}),i.cropObj.filter=this.lowerContext.filter;var P=f({},i.currSelectionPoint,null,!0);i.notify("draw",{prop:"setCurrentObj",onPropertyChange:!1,value:{obj:null}}),i.activeObj=f({},P,null,!0);var S=f({},i.activeObj,null,!0);if(i.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),i.currSelectionPoint=null,i.isCircleCrop=!1,i.transform.degree!==0&&(C(i.activeObj.shape)&&i.cropObj.activeObj.shape&&(i.activeObj=f({},i.cropObj.activeObj,null,!0)),i.notify("transform",{prop:"drawPannedImage",value:{xDiff:0,yDiff:0}}),i.panPoint.currentPannedPoint={x:0,y:0}),i.objColl=s,i.pointColl=l,i.freehandCounter=i.pointColl.length,p.straightenPoint.x&&p.straightenPoint.y&&i.notify("freehand-draw",{prop:"setStraightenPoint",onPropertyChange:!1,value:{x:p.straightenPoint.x,y:p.straightenPoint.y,ratioX:p.straightenPoint.ratioX,ratioY:p.straightenPoint.ratioY}}),i.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:y}}}),i.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"iterate",pen:"iterate",isPreventApply:null}}),this.adjustStraightenForShapes("reverse",!1),i.notify("freehand-draw",{prop:"updateFHDColl",onPropertyChange:!1,value:{isPreventApply:!0}}),i.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),i.transform.degree===0?i.notify("transform",{prop:"drawPannImage",onPropertyChange:!1,value:{point:{x:0,y:0}}}):(C(i.activeObj.shape)&&i.cropObj.activeObj.shape&&(i.activeObj=f({},i.cropObj.activeObj,null,!0)),i.notify("transform",{prop:"drawPannedImage",value:{xDiff:0,yDiff:0}}),i.panPoint.currentPannedPoint={x:0,y:0}),i.activeObj=S,i.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}}),i.notify("transform",{prop:"setTempPanMove",onPropertyChange:!1,value:{point:null}}),!this.isInitCrop&&i.transform.degree===0&&i.cropObj.currFlipState!==""&&i.cropObj.cropZoom!==0){this.isInitCrop=!0;var O={activeObj:null};i.notify("draw",{prop:"getStraightenActObj",onPropertyChange:!1,value:{obj:O}}),i.notify("draw",{prop:"performCancel",value:{isContextualToolbar:null}}),i.notify("draw",{prop:"setStraightenActObj",onPropertyChange:!1,value:{activeObj:O.activeObj}}),i.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"croptransform",isApplyBtn:!1,isCropping:null,isZooming:null,cType:null}})}else this.isInitCrop=!1}else{this.adjustStraightenForShapes("reverse",!0),i.notify("freehand-draw",{prop:"updateFHDColl",onPropertyChange:!1,value:{isPreventApply:!0}});var j=this.lowerContext.filter;this.lowerContext.filter="none",i.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"iterate",pen:"iterate",isPreventApply:null}}),this.lowerContext.filter=j,i.currSelectionPoint=null}document.querySelector(".e-ie-straighten-value-span")&&(document.querySelector(".e-ie-straighten-value-span").innerHTML=i.transform.straighten.toString()+"&#176")},d.prototype.panToSelRangle=function(e){var i=this.parent,t=i.cropObj.totalPannedClientPoint,r=i.transform.degree!==0?e?-t.x:t.x:0,o=i.transform.degree!==0?e?-t.y:t.y:0;i.transform.degree!==0&&(i.panPoint.currentPannedPoint={x:r,y:o},i.notify("transform",{prop:"drawPannedImage",value:{xDiff:r,yDiff:o}}),i.panPoint.currentPannedPoint={x:0,y:0})},d.prototype.cropCircle=function(e,i,t){var r=this.parent,o=r.img,a=o.destLeft,n=o.destTop,s=o.destWidth,l=o.destHeight;t&&r.transform.currFlipState!==""&&r.notify("draw",{prop:"setTransform",onPropertyChange:!1,value:{context:e,value:r.transform.currFlipState,isReverse:null}});var p=e.filter;e.filter="none",e.globalCompositeOperation="destination-in",e.beginPath();var h=C(i)?a+s/2:e.canvas.width/2,u=C(i)?n+l/2:e.canvas.height/2,c=i?e.canvas.width/2:s/2;e.arc(h,u,c,0,Math.PI*2),e.closePath(),e.fill(),e.restore(),e.globalCompositeOperation="source-over",r.currObjType.isActiveObj=r.isCircleCrop=!0,e.filter=p,t&&r.transform.currFlipState!==""&&r.notify("draw",{prop:"setTransform",onPropertyChange:!1,value:{context:e,value:r.transform.currFlipState,isReverse:null}})},d.prototype.getCurrCropState=function(){var e=this.parent,i="",t={flipColl:null};return e.notify("transform",{prop:"getFlipColl",onPropertyChange:!1,value:{obj:t}}),i=this.getCurrFlipState(),(e.transform.degree===-90||e.transform.degree===-270)&&(i==="horizontal"?i="vertical":i==="vertical"&&(i="horizontal")),i===""&&(i=t.flipColl.length>1?this.getCurrFlipState():e.transform.currFlipState),i},d.prototype.updateRotatePan=function(){var e=this.parent;if(!C(e.panPoint.currentPannedPoint)){var i="",t=e.transform.degree,r=e.panPoint.currentPannedPoint,o=r.x,a=r.y;e.rotateFlipColl.length>0&&typeof e.rotateFlipColl[0]=="number"&&t<0?i=this.getCurrCropState():i=this.getCurrFlipState(),t%90===0&&t%180!==0?t===90||t===-90&&(i==="horizontal"||i==="vertical")||t===-270&&(i===""||i==="verticalHorizontal"||i==="horizontalVertical")?(i==="horizontal"||i===""?e.img.destLeft+=a:e.img.destLeft-=a,i===""||i==="vertical"?e.img.destTop-=o:e.img.destTop+=o):(t===270||t===-270&&(i==="horizontal"||i==="vertical")||t===-90&&(i===""||i==="verticalHorizontal"||i==="horizontalVertical"))&&(i===""||i==="horizontal"?e.img.destLeft-=a:e.img.destLeft+=a,i===""||i==="vertical"?e.img.destTop+=o:e.img.destTop-=o):(t===180||t===-180)&&(i===""||i==="vertical"?e.img.destLeft-=o:e.img.destLeft+=o,i===""||i==="horizontal"?e.img.destTop-=a:e.img.destTop+=a)}},d.prototype.crop=function(e){var i=this.parent,t=i.activeObj.activePoint,r=t.startX,o=t.startY,a=t.endX,n=t.endY;if(!i.disabled&&i.isImageLoaded){var s={isCropToolbar:i.isCropToolbar};i.currObjType.isUndoAction&&!s.isCropToolbar&&i.notify("undo-redo",{prop:"refreshUrc",value:{bool:null}});var l={cancel:!1,startPoint:{x:r,y:o},endPoint:{x:a,y:n},preventScaling:!1};s.isCropToolbar||(i.trigger("cropping",l),i.editCompleteArgs=l),this.cropEvent(l,e,s)}},d.prototype.cropEvent=function(e,i,t){var r=this.parent,o;if(!e.cancel&&(o=r.activeObj.shape?r.activeObj.shape.split("-"):[],!r.disabled&&r.activeObj.horTopLine&&(r.currObjType.isCustomCrop||o.length>0&&o[0]==="crop"))){i.isCrop=!0;var a=f({},r.cropObj,{},!0),n=f({},this.prevCropCurrObj,{},!0);e.preventScaling?this.isPreventScaling=!0:this.isPreventScaling=!1,this.cropImg(),this.isPreventScaling&&(r.aspectWidth=r.img.destWidth,r.aspectHeight=r.img.destHeight),r.notify("freehand-draw",{prop:"resetStraightenPoint"}),r.isCropTab=!1,r.transform.zoomFactor=0,r.setProperties({zoomSettings:{zoomFactor:1}},!0),r.notify("transform",{prop:"setPreviousZoomValue",onPropertyChange:!1,value:{previousZoomValue:r.zoomSettings.zoomFactor}}),w.isDevice||this.updateUndoRedoColl(n,a,t),r.notify("transform",{prop:"setCropDimension",onPropertyChange:!1,value:{width:r.cropObj.destPoints.width,height:r.cropObj.destPoints.height}});var s=r.element.querySelector("#"+r.element.id+"_aspectratio"),l=r.element.querySelector("#"+r.element.id+"_nonaspectratio");r.notify("draw",{prop:"render-image",value:{isMouseWheel:!1}}),!t.isCropToolbar&&C(s)&&C(l)&&r.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:!1,isCropping:!1,isZooming:null,cType:null}}),this.resizeWrapper(),w.isDevice&&this.updateUndoRedoColl(n,a,t)}},d.prototype.updateUndoRedoColl=function(e,i,t){var r=this.parent,o={prevCurrSelectionPoint:r.prevCurrSelectionPoint};e.currSelectionPoint=f({},o.prevCurrSelectionPoint,{},!0),r.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"crop",previousObj:e,previousObjColl:e.objColl,previousPointColl:e.pointColl,previousSelPointColl:e.selPointColl,previousCropObj:i,previousText:null,currentText:null,previousFilter:null,isCircleCrop:r.isCircleCrop}}),t.isCropToolbar||r.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}})},d.prototype.resizeWrapper=function(){var e=this.parent;if(w.isDevice){var i=e.element,t=i.querySelector("#"+i.id+"_contextualToolbarArea");t&&t.style.position===""&&!this.isTransformCrop&&(t.style.position="absolute",e.isStraightening=!1,e.update(),e.notify("filter",{prop:"setAdjustmentValue",value:{adjustmentValue:e.canvasFilter}}))}},d.prototype.calcRatio=function(e,i){var t=this.parent,r=t.transform.degree,o=t.img,a=o.destWidth,n=o.destHeight,s=i||t.baseImgCanvas,l=s.width,p=s.height,h=r===0||r%180===0?l/a:p/a,u=r===0||r%180===0?p/n:l/n;return e&&(e.width=h,e.height=u),{width:h,height:u}},d.prototype.getCurrFlipState=function(e){var i=this.parent,t={panRegion:""},r={collection:i.rotateFlipColl};i.notify("shape",{prop:"alignRotateFlipColl",onPropertyChange:!1,value:{collection:i.rotateFlipColl,isRotateFlipCollection:!0,obj:r}}),i.rotateFlipColl=r.collection;for(var o=0,a=i.rotateFlipColl.length;o<a;o++)i.notify("transform",{prop:"setCurrPanRegion",onPropertyChange:!1,value:{region:t.panRegion,type:i.rotateFlipColl[o],obj:t}});return e&&(e.panRegion=t.panRegion),t.panRegion},d}(),ai=function(d,e,i,t){return new(i||(i=Promise))(function(r,o){function a(l){try{s(t.next(l))}catch(p){o(p)}}function n(l){try{s(t.throw(l))}catch(p){o(p)}}function s(l){l.done?r(l.value):new i(function(p){p(l.value)}).then(a,n)}s((t=t.apply(d,e||[])).next())})},ni=function(d,e){var i={label:0,sent:function(){if(o[0]&1)throw o[1];return o[1]},trys:[],ops:[]},t,r,o,a;return a={next:n(0),throw:n(1),return:n(2)},typeof Symbol=="function"&&(a[Symbol.iterator]=function(){return this}),a;function n(l){return function(p){return s([l,p])}}function s(l){if(t)throw new TypeError("Generator is already executing.");for(;i;)try{if(t=1,r&&(o=l[0]&2?r.return:l[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,l[1])).done)return o;switch(r=0,o&&(l=[l[0]&2,o.value]),l[0]){case 0:case 1:o=l;break;case 4:return i.label++,{value:l[1],done:!1};case 5:i.label++,r=l[1],l=[0];continue;case 7:l=i.ops.pop(),i.trys.pop();continue;default:if(o=i.trys,!(o=o.length>0&&o[o.length-1])&&(l[0]===6||l[0]===2)){i=0;continue}if(l[0]===3&&(!o||l[1]>o[0]&&l[1]<o[3])){i.label=l[1];break}if(l[0]===6&&i.label<o[1]){i.label=o[1],o=l;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(l);break}o[2]&&i.ops.pop(),i.trys.pop();continue}l=e.call(d,i)}catch(p){l=[6,p],r=0}finally{t=o=0}if(l[0]&5)throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}},si=function(){function d(e){this.isInitialLoading=!1,this.fileName="",this.isErrorImage=!1,this.isShapeTextInserted=!1,this.isRotateZoom=!1,this.tempStrokeSettings={strokeColor:"#fff",fillColor:"",strokeWidth:null,outlineColor:"",radius:null,outlineWidth:null},this.tempTextSettings={text:"Enter Text",fontFamily:"",fontSize:null,fontRatio:null,bold:!1,italic:!1,underline:!1},this.tempAdjValue="",this.tempFilter="",this.tempUndoRedoStep=0,this.tempFreehandCounter=0,this.tempCurrFhdIndex=0,this.tempZoomFactor=null,this.isCancelAction=!1,this.rotatedFlipCropSel=!1,this.zoomCrop={width:0,height:0},this.isImageEdited=!1,this.isFileChanged=!1,this.isNewPath=!1,this.isResizeSelect=!1,this.arrowDimension={bar:{width:10,height:32,ratioX:null,ratioY:null},arrow:{width:24,height:24,ratioX:null,ratioY:null},arrowSolid:{width:32,height:32,ratioX:null,ratioY:null},circle:{width:10,height:10,ratioX:null,ratioY:null},square:{width:20,height:20,ratioX:null,ratioY:null}},this.origDim={width:0,height:0},this.isImageApply=!1,this.imgCanvasPoints=[],this.isCropSelect=!1,this.isDownScale=!1,this.preventStraightening=!1,this.tempObjColl=[],this.tempPointColl={},this.imageBackgroundColor="",this.allowRedactStraighten=!0,this.isNullExtension=!0,this.isRedactStraighten=!1,this.parent=e,this.addEventListener()}return d.prototype.destroy=function(){this.parent.isDestroyed||this.removeEventListener()},d.prototype.addEventListener=function(){this.parent.on("draw",this.draw,this),this.parent.on("destroyed",this.destroy,this)},d.prototype.removeEventListener=function(){this.parent.off("draw",this.draw),this.parent.off("destroyed",this.destroy)},d.prototype.draw=function(e){switch(this.updatePrivateVariables(),e.prop){case"drawObject":this.drawObject(e.value.canvas,e.value.obj,e.value.isCropRatio,e.value.points,e.value.isPreventDrag,e.value.saveContext,e.value.isPreventSelection);break;case"updateActiveObject":this.updateActiveObject(e.value.actPoint,e.value.obj,e.value.isMouseMove,e.value.x,e.value.y);break;case"clearOuterCanvas":this.clearOuterCanvas(e.value.context);break;case"setDestPoints":this.setDestPoints();break;case"updateCurrTransState":this.updateCurrTransState(e.value.type,e.value.isPreventDestination,e.value.isRotatePan);break;case"currTransState":this.currTransState(e.value.type,e.value.isPreventDestination,e.value.context,e.value.isPreventCircleCrop);break;case"setTransform":this.setTransform(e.value.context,e.value.value,e.value.isReverse);break;case"render-image":this.renderImage(e.value.isMouseWheel,e.value.isPreventClearRect,e.value.isFrame,e.value.isStraighten);break;case"draw-image-to-canvas":this.drawImgToCanvas(e.value.dimension);break;case"update-canvas":this.updateCanvas();break;case"performCancel":this.performCancel(e.value.isContextualToolbar,e.value.isUndoRedo,e.value.isFinalCancel);break;case"updateFlipPan":this.updateFlipPan(e.value.tempSelectionObj);break;case"select":this.select(e.value.type,e.value.startX,e.value.startY,e.value.width,e.value.height);break;case"callUpdateCurrTransState":this.callUpdateCurrTransState();break;case"resetPanPoints":this.resetPanPoints();break;case"setClientTransDim":this.setClientTransDim(e.value.isPreventDimension);break;case"redrawImgWithObj":this.redrawImgWithObj();break;case"setCurrentObj":this.setCurrentObj(e.value.obj,e.value.isUndoRedo,e.value.isCircleCrop);break;case"performPointZoom":this.performPointZoom(e.value.x,e.value.y,e.value.type,e.value.isResize);break;case"open":this.open(e.value.data);break;case"isInitialLoading":this.isInitialLoading=e.value.isInitialLoading;break;case"isInitialLoaded":this.getInitialLoaded(e.value.object);break;case"fileSelect":this.fileSelect(e.value.inputElement,e.value.args);break;case"getFileName":e.value.obj.fileName=this.fileName,e.value.obj.fileType=this.fileType;break;case"getErrorImage":e.value.obj.isErrorImage=this.isErrorImage;break;case"getInitialZoomValue":e.value.obj.initialZoomValue=this.initZoomValue;break;case"setShapeTextInsert":this.isShapeTextInserted=e.value.bool;break;case"resetCurrentSelectionPoint":this.currSelPoint=null;break;case"setRotateZoom":this.isRotateZoom=e.value.isRotateZoom;break;case"setTempStrokeSettings":this.tempStrokeSettings=e.value.tempStrokeSettings;break;case"setTempTextSettings":this.tempTextSettings=e.value.tempTextSettings;break;case"setTempAdjustmentValue":this.tempAdjValue=e.value.tempAdjustmentValue;break;case"getTempAdjustmentValue":e.value.obj.value=this.tempAdjValue;break;case"setTempFilter":this.tempFilter=e.value.tempFilter;break;case"setTempUndoRedoStep":this.tempUndoRedoStep=e.value.tempUndoRedoStep;break;case"setTempFreehandCounter":this.tempFreehandCounter=e.value.tempFreehandCounter;break;case"setTempCurrentFreehandDrawIndex":this.tempCurrFhdIndex=e.value.tempCurrentFreehandDrawIndex;break;case"setTempZoomFactor":this.tempZoomFactor=e.value.tempZoomFactor;break;case"setCancelAction":this.isCancelAction=e.value.bool;break;case"getRotatedFlipCropSelection":e.value.bool.isSelected=this.rotatedFlipCropSel;break;case"getPrevActObj":e.value.obj.prevActObj=this.prevActObj;break;case"setPrevActObj":this.prevActObj=e.value.prevActObj;break;case"setZoomCropWidth":this.zoomCrop.width=e.value.width,this.zoomCrop.height=e.value.height;break;case"setImageEdited":this.isImageEdited=!0;break;case"reset":this.reset();break;case"setNewPath":this.isNewPath=e.value.bool;break;case"getNewPath":e.value.obj.isNewPath=this.isNewPath;break;case"getArrowDimension":e.value.obj.arrowDimension=f({},this.arrowDimension,{},!0);break;case"setArrowDimension":this.arrowDimension=e.value.arrowDimension;break;case"moveToSelectionRange":this.moveToSelectionRange(e.value.type,e.value.activeObj);break;case"setResizeSelect":this.isResizeSelect=e.value.bool;break;case"applyFrame":this.applyFrame(e.value.ctx,e.value.frame,e.value.preventImg);break;case"drawImage":this.drawImage();break;case"downScaleImgCanvas":this.downScaleImgCanvas(e.value.ctx,e.value.isImgAnnotation,e.value.isHFlip,e.value.isVFlip);break;case"downScale":this.downScale(e.value.canvas,e.value.width,e.value.height);break;case"resetFrameZoom":this.resetFrameZoom(e.value.isOk);break;case"triggerFrameChange":e.value.obj.frameChangeEventArgs=this.triggerFrameChange(e.value.prevFrameSettings);break;case"setImageApply":this.isImageApply=e.value.bool;break;case"zoomToSel":this.zoomToSel(e.value.activeObj,e.value.isToolbar);break;case"getStraightenActObj":e.value.obj.activeObj=this.straightenActObj;break;case"setStraightenActObj":this.straightenActObj=e.value.activeObj;break;case"updateImgCanvasPoints":this.updateImgCanvasPoints();break;case"isLinesIntersect":e.value.obj.isIntersect=this.isLinesIntersect(e.value.obj);break;case"getImageCanvasPoints":e.value.obj.points=this.imgCanvasPoints;break;case"setDestForStraighten":this.setDestForStraighten();break;case"setTempDestForStraighten":this.tempStraightenDestPoints=f({},this.straightenDestPoints,{},!0);break;case"getStraightenInitZoom":e.value.obj.zoomFactor=this.straightenInitZoom;break;case"setStraightenInitZoom":this.straightenInitZoom=e.value.zoomFactor;break;case"isPointsInsideImg":e.value.obj.bool=this.checkPointPosition(e.value.x,e.value.y,this.imgCanvasPoints[0].x,this.imgCanvasPoints[0].y,this.imgCanvasPoints[1].x,this.imgCanvasPoints[1].y,this.imgCanvasPoints[2].x,this.imgCanvasPoints[2].y,this.imgCanvasPoints[3].x,this.imgCanvasPoints[3].y)!=="inside";break;case"setIsCropSelect":this.isCropSelect=e.value.bool;break;case"updateCropSelection":this.updateCropSelection();break;case"updateCropSelObj":this.updateCropSelObj();break;case"redrawDownScale":this.redrawDownScale();break;case"updateFinetune":this.updateFinetune();break;case"isSelOutsideImg":e.value.obj.bool=this.isSelOutsideImg();break;case"resetStraightenDestPoints":this.straightenDestPoints=null;break;case"checkPointPosition":e.value.obj.position=this.checkPointPosition(e.value.obj.x,e.value.obj.y,e.value.obj.x1,e.value.obj.y1,e.value.obj.x2,e.value.obj.y2,e.value.obj.x3,e.value.obj.y3,e.value.obj.x4,e.value.obj.y4);break;case"updateTempObjColl":this.tempObjColl=f([],this.parent.objColl,[],!0);break;case"resetTempObjColl":this.tempObjColl=null;break;case"updateTempPointColl":this.tempPointColl=f({},this.parent.pointColl,{},!0);break;case"resetTempPointColl":this.tempPointColl={};break;case"showDialogPopup":this.showDialogPopup();break;case"imageBackgroundColor":this.imageBackgroundColor=e.value.color;break;case"getImageBackgroundColor":e.value.obj.color=this.imageBackgroundColor;break;case"setTempStrokeWidth":this.tempStrokeWidth=e.value.strokeWidth;break;case"setNullExtension":this.isNullExtension=e.value.extension;break;case"setRedactStraighten":this.isRedactStraighten=e.value.bool;break}},d.prototype.getModuleName=function(){return"draw"},d.prototype.updatePrivateVariables=function(){var e=this.parent;e.lowerCanvas&&(this.lowerContext=e.lowerCanvas.getContext("2d")),e.upperCanvas&&(this.upperContext=e.upperCanvas.getContext("2d")),C(this.tempZoomFactor)&&(this.tempZoomFactor=e.transform.zoomFactor),this.tempTextSettings.fontFamily===""&&(this.tempTextSettings.fontFamily=e.fontFamily.default)},d.prototype.reset=function(){this.isInitialLoading=this.isErrorImage=this.isNewPath=this.isResizeSelect=!1,this.isShapeTextInserted=!1,this.isImageApply=!1,this.isNullExtension=!0,this.initZoomValue=null,this.tempFilter="",this.origDim={width:0,height:0},this.currSelPoint=null,this.isRotateZoom=!1,this.tempAdjValue="",this.tempStrokeSettings={strokeColor:"#fff",fillColor:"",strokeWidth:null,radius:null,outlineColor:"",outlineWidth:null},this.tempTextSettings={text:"Enter Text",fontFamily:this.parent.fontFamily.default,fontSize:null,fontRatio:null,bold:!1,italic:!1,underline:!1},this.tempUndoRedoStep=this.tempFreehandCounter=this.tempCurrFhdIndex=0,this.tempZoomFactor=null,this.isCancelAction=!1,this.rotatedFlipCropSel=!1,this.prevActObj=null,this.tempStraightenDestPoints=null,this.arrowDimension={bar:{width:10,height:32,ratioX:null,ratioY:null},arrow:{width:24,height:24,ratioX:null,ratioY:null},arrowSolid:{width:32,height:32,ratioX:null,ratioY:null},circle:{width:10,height:10,ratioX:null,ratioY:null},square:{width:20,height:20,ratioX:null,ratioY:null}},this.straightenActObj=null,this.imgCanvasPoints=[],this.straightenInitZoom=null,this.allowRedactStraighten=!0,this.tempObjColl=[],this.tempPointColl={},this.imageBackgroundColor="",this.tempStrokeWidth=null,this.straightenDestPoints=null,this.isCropSelect=this.isDownScale=this.preventStraightening=!1,this.isRedactStraighten=!1},d.prototype.redrawDownScale=function(){var e=this.parent;if(e.transform.zoomFactor&&e.transform.zoomFactor<0){var i=f({},e.activeObj,{},!0);e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.isDownScale=!0,this.renderImage(),this.isDownScale=!1,i.shape&&this.drawObject("duplicate",i)}},d.prototype.updateFinetune=function(){var e=this.parent;if(e.transform.zoomFactor&&e.transform.zoomFactor<0){var i=this.lowerContext.filter;this.lowerContext.filter="none",e.notify("draw",{prop:"redrawDownScale"});var t=e.inMemoryCanvas.getContext("2d"),r=this.lowerContext,o=r.getImageData(0,0,r.canvas.width,r.canvas.height);e.inMemoryCanvas.width=o.width,e.inMemoryCanvas.height=o.height,t.putImageData(o,0,0),this.lowerContext.filter=i,e.notify("draw",{prop:"redrawDownScale"})}},d.prototype.drawImage=function(){this.applyFrame(this.lowerContext,this.parent.frameObj.type)},d.prototype.drawObject=function(e,i,t,r,o,a,n){var s=this.parent,l=s.activeObj,p=s.activeObj.activePoint;this.upperContext.clearRect(0,0,s.upperCanvas.width,s.upperCanvas.height);var h;if(e=e.toLowerCase(),e==="original"?h=this.lowerContext:e==="duplicate"?h=this.upperContext:a&&(h=a),!o&&l.shape&&this.setDragLimit(),s.currObjType.shape){var u=s.currObjType.shape.split("-");u[0].toLowerCase()==="crop"&&t&&this.drawCropRatio()}if(l=s.activeObj,p=s.activeObj.activePoint,C(l.strokeSettings)){var c={strokeSettings:{}};s.notify("shape",{prop:"getStrokeSettings",onPropertyChange:!1,value:{obj:c}}),l.strokeSettings=c.strokeSettings}if(C(l.strokeSettings.strokeWidth)&&(l.strokeSettings.strokeWidth=2),i&&(s.activeObj=f({},i,{},!0)),r&&r.startX&&r.startY&&r.endX&&r.endY&&r.width&&r.height&&(p.startX=r.startX,p.startY=r.startY,p.endX=r.endX,p.endY=r.endY,p.width=r.width,p.height=r.height),this.updateActiveObject(),l=s.activeObj,p=s.activeObj.activePoint,!(C(p.startX)&&C(p.startY))){if(s.currObjType.isText){var g={keyHistory:""};s.notify("shape",{prop:"getKeyHistory",onPropertyChange:!1,value:{obj:g}}),l.keyHistory=g.keyHistory}var v=!1;if(e!=="original"){var u=void 0;l.shape&&(u=l.shape.split("-"),u[0]==="crop"&&(v=!0)),v&&(r&&r.startX&&r.startY&&r.endX&&r.endY&&r.width&&r.height?(p.startX=r.startX,p.startY=r.startY,p.endX=r.endX,p.endY=r.endY,p.width=r.width,p.height=r.height):p=l.activePoint,this.upperContext.fillStyle="rgb(0, 0, 0, 0.25)",this.upperContext.fillRect(0,0,s.lowerCanvas.width,s.lowerCanvas.height),this.upperContext.clearRect(p.startX,p.startY,p.width,p.height)),C(n)&&(h===this.lowerContext||h===this.upperContext)&&(this.rotateContext("initial",h),this.drawOuterSelection(h),this.rotateContext("reverse",h))}s.currObjType.isActiveObj=!0;var b={keyHistory:""};s.notify("shape",{prop:"getKeyHistory",onPropertyChange:!1,value:{obj:b}}),i?this.drawShapeObj(e,i.shape,a,n):b.keyHistory!==""&&s.currObjType.isText?this.drawShapeObj(e,"text",a,n):l.shape?this.drawShapeObj(e,l.shape,a,n):this.drawShapeObj(e,void 0,a,n),e==="duplicate"&&v&&l.shape!=="crop-circle"&&s.frameObj.type!=="none"&&(this.applyFrame(this.upperContext,s.frameObj.type),this.drawCornerCircles(this.upperContext))}},d.prototype.rotateContext=function(e,i){var t=this.parent,r=t.activeObj,o=r.shape,a=r.rotatedAngle,n=t.img,s=n.destLeft,l=n.destTop,p=n.destWidth,h=n.destHeight,u=t.activeObj.activePoint,c=u.startX,g=u.startY,v=u.width,b=u.height;if(!(o==="line"||o==="arrow")){var m=e==="initial"?a:-a,y,P;t.transform.straighten===0&&!t.isCropTab?(y=c+v/2,P=g+b/2):(y=s+p/2,P=l+h/2),i.translate(y,P),i.rotate(m),i.translate(-y,-P)}},d.prototype.setDragLimit=function(){var e=this.parent,i=e.activeObj.activePoint,t=e.activeObj,r=t.shape,o=t.rotatedAngle;if(i&&r!=="image"&&r!=="line"&&o===0&&e.activeObj.preventShapeDragOut){var a=e.img,n=a.destLeft,s=a.destTop,l=a.destWidth,p=a.destHeight;i.startX<n?(i.startX=n,i.endX=Math.min(i.startX+i.width,n+l)):i.endX>n+l&&(i.endX=n+l,i.startX=Math.max(i.endX-i.width,n)),i.startY<s?i.startY=s:i.endY>s+p&&(i.endY=s+p,i.startY=Math.max(i.endY-i.height,s)),e.activeObj=this.updateWidthHeight(e.activeObj)}},d.prototype.drawCropRatio=function(){var e=this.parent,i=e.activeObj.activePoint,t,r,o,a,n=e.img,s=n.destLeft,l=n.destTop,p=n.destWidth,h=n.destHeight;if(e.transform.zoomFactor>0&&this.currSelPoint){var u=f({},e.activeObj,{},!0);this.drawCustomSelection("crop-custom",null,null,null,null),e.transform.straighten!==0&&(i=e.activeObj.activePoint),e.transform.degree%90===0&&e.transform.degree%180!==0?(o=i.width<i.height?i.width:i.height,a=o):(o=i.width,a=i.height),e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),e.activeObj=u,e.currObjType.shape=u.shape,this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),e.currObjType.isCustomCrop=!1}else o=p,a=h,s<0&&(o+=s),l<0&&(a+=l),s+p>e.lowerCanvas.width&&(o-=s+p-e.lowerCanvas.width),l+h>e.lowerCanvas.height&&(a-=l+h-e.lowerCanvas.height);switch(e.currObjType.shape.toLowerCase()){case"crop-square":case"crop-circle":e.notify("selection",{prop:"setDragDirection",onPropertyChange:!1,value:{width:o,height:a}}),i=e.activeObj.activePoint,e.lowerCanvas.width<i.endX-i.startX&&(i.startX=7.5,i.endX=e.lowerCanvas.width-7.5),e.lowerCanvas.height<i.endY-i.startY&&(i.startY=7.5,i.endY=e.lowerCanvas.height-7.5),o===p&&a===h&&(i.startX+=s,i.startY+=l,i.endX+=s,i.endY+=l),e.lowerCanvas.width>e.lowerCanvas.height?(i.height=i.endY-i.startY,i.width=i.height,i.endX=i.startX+i.width):(i.width=i.endX-i.startX,i.height=i.width,i.endY=i.startY+i.height);break;case"crop-3:2":t=3,r=2;break;case"crop-4:3":t=4,r=3;break;case"crop-5:4":t=5,r=4;break;case"crop-7:5":t=7,r=5;break;case"crop-16:9":t=16,r=9;break;case"crop-2:3":t=2,r=3;break;case"crop-3:4":t=3,r=4;break;case"crop-4:5":t=4,r=5;break;case"crop-5:7":t=5,r=7;break;case"crop-9:16":t=9,r=16;break;default:t=parseInt(e.currObjType.shape.toLowerCase().split("crop-")[1].split(":")[0]),r=parseInt(e.currObjType.shape.toLowerCase().split("crop-")[1].split(":")[1]);break}if(t!==void 0&&r!==void 0&&(e.notify("selection",{prop:"calcShapeRatio",onPropertyChange:!1,value:{x:t,y:r,imgWidth:o,imgHeight:a}}),o===p&&a===h&&this.updatePoints(),i=e.activeObj.activePoint),i.startX<s){var c=s-i.startX+7.5;i.startX+=c,i.endX+=c}if(i.startY<l){var c=l-i.startY+7.5;i.startY+=c,i.endY+=c}e.activeObj=this.updateWidthHeight(e.activeObj),this.adjToCenter(),this.enlargeToImg(),e.transform.straighten!==0&&(this.adjToStraighten(),this.updateActiveObject(e.activeObj.activePoint,e.activeObj));var g={isIntersect:null,arr:null},v=0;if(i=e.activeObj.activePoint,e.transform.straighten!==0)for(;this.isLinesIntersect(g)&&v<100;){v++;var c=i.width*1/100;i.startX+=c,i.endX-=c,c=i.height*1/100,i.startY+=c,i.endY-=c,i.width=i.endX-i.startX,i.height=i.endY-i.startY,this.updateActiveObject(i,e.activeObj)}this.straightenInitZoom=e.transform.zoomFactor,this.straightenActObj=f({},e.activeObj,{},!0),e.notify("draw",{prop:"resetStraightenDestPoints"}),e.notify("draw",{prop:"setDestForStraighten"})},d.prototype.adjToCenter=function(){var e=this.parent,i=e.activeObj.activePoint,t=e.img,r=t.destLeft,o=t.destTop,a=t.destWidth,n=t.destHeight,s=e.lowerCanvas.width/2-(i.endX-i.width/2),l=e.lowerCanvas.height/2-(i.endY-i.height/2);if(i.startX+=s,i.endX+=s,i.startY+=l,i.endY+=l,i.startX<(r>=7.5?r:7.5)){var p=(r>=7.5?r:0)-i.startX;i.startX+=p,i.endX+=p}else if(i.endX>r+a){var p=i.endX-(r+a);i.startX-=p,i.endX-=p}if(i.startY<(o>=7.5?o:7.5)){var p=(o>=7.5?o:0)-i.startY;i.startY+=p,i.endY+=p}else if(i.endY>o+n){var p=i.endY-(o+n);i.startY-=p,i.endY-=p}},d.prototype.enlargeToImg=function(){var e=this.parent;if(e.transform.straighten!==0&&e.transform.degree%90===0&&e.transform.degree%180!==0)for(var i=e.activeObj.activePoint,t=f({},i,{},!0),r=0;;){r++;var o=i.width*5/100;i.startX-=o,i.endX+=o,o=i.height*5/100,i.startY-=o,i.endY+=o,i.width=i.endX-i.startX,i.height=i.endY-i.startY,this.updateActiveObject(i,e.activeObj);var a={isIntersect:null,arr:null};if(this.updateImgCanvasPoints(),this.isLinesIntersect(a),a.arr[0]||a.arr[1]||a.arr[2]||a.arr[3]||i.startX<7.5||i.startY<7.5||r===100){i=f({},t,{},!0),o=i.width*1/100,i.startX+=o,i.endX-=o,o=i.height*1/100,i.startY+=o,i.endY-=o,i.width=i.endX-i.startX,i.height=i.endY-i.startY,this.updateActiveObject(i,e.activeObj);break}t=f({},i,{},!0)}},d.prototype.updateActiveObject=function(e,i,t,r,o){var a=this.parent;e=e||f({},a.activeObj.activePoint,{},!0),i=i||f({},a.activeObj,{},!0),e.width=e.endX-e.startX,e.height=e.endY-e.startY;var n=e.startX,s=e.startY,l=e.endX,p=e.endY,h=e.width,u=e.height;r=r||0,o=o||0;var c=h/2,g=u/2,v=7.5;i.horTopLine={startX:n+r,startY:s-o,endX:l+r,endY:p+o},i.horBottomLine={startX:n-r,startY:p-o,endX:l-r,endY:p+o},i.verLeftLine={startX:n+r,startY:s-o,endX:n-o,endY:p-o},i.verRightLine={startX:l+r,startY:s+o,endX:l-r,endY:p+o},i.topLeftCircle={startX:n,startY:s,radius:i.horTopLine.endX?v:0},i.topCenterCircle={startX:n+c,startY:s,radius:i.horTopLine.endX?v:0},i.topRightCircle={startX:l,startY:s,radius:i.horTopLine.endX?v:0},i.centerLeftCircle={startX:n,startY:s+g,radius:i.horTopLine.endX?v:0},i.centerRightCircle={startX:l,startY:s+g,radius:i.horTopLine.endX?v:0},i.bottomLeftCircle={startX:n,startY:p,radius:i.horTopLine.endX?v:0},i.bottomCenterCircle={startX:n+c,startY:p,radius:i.horTopLine.endX?v:0},i.bottomRightCircle={startX:l,startY:p,radius:i.horTopLine.endX?v:0},i.rotatedAngle===0&&(i.rotationCirclePoint={x:i.bottomCenterCircle.startX,y:i.bottomCenterCircle.startY+25},i.rotationCirclePoint.ratioX=(i.rotationCirclePoint.x-a.img.destLeft)/a.img.destWidth,i.rotationCirclePoint.ratioY=(i.rotationCirclePoint.y-a.img.destTop)/a.img.destHeight),i.activePoint=e,C(t)&&(a.activeObj=f({},i,{},!0))},d.prototype.drawOuterSelection=function(e,i){var t,r=this.parent,o=r.activeObj.activePoint,a=r.activeObj;e.lineWidth=.5;var n=f({},a,{},!0);if(a.shape&&(t=a.shape.split("-")),(t&&t[0]==="crop"||a.shape===void 0)&&!i&&(this.upperContext.fillStyle="rgb(0, 0, 0, 0.25)",this.upperContext.fillRect(0,0,r.lowerCanvas.width,r.lowerCanvas.height),this.upperContext.clearRect(o.startX,o.startY,o.width,o.height)),e.strokeStyle=r.themeColl[r.theme].primaryColor,e.fillStyle=r.themeColl[r.theme].secondaryColor,n.shapeDegree===0?r.transform.degree:r.transform.degree-n.shapeDegree,a.shape==="arrow"||a.shape==="line")e.beginPath(),e.moveTo(o.startX,o.startY),e.lineTo(o.endX,o.endY),e.stroke();else if(a.shape==="path"){e.beginPath();var s=f({},r.activeObj,{},!0);if(s.pointColl[0]&&(e.moveTo(s.pointColl[0].x,s.pointColl[0].y),s.pointColl.length>1))for(var l=1,p=s.pointColl.length;l<p;l++)o.endX=s.pointColl[l].x,o.endY=s.pointColl[l].y,e.lineTo(o.endX,o.endY);var h={shape:null};r.notify("selection",{prop:"getCurrentDrawingShape",value:{obj:h}}),h.shape==="path"&&(r.activeObj=a=s),e.lineTo(o.endX,o.endY),e.stroke()}else this.drawCornerCircles(e);if(r.selectionSettings.showCircle&&(t===void 0||t[0]!=="crop")){var u=e.strokeStyle,c=e.fillStyle;e.strokeStyle=r.selectionSettings.strokeColor,e.fillStyle=r.selectionSettings.fillColor,a.shape==="text"?(e.lineWidth*=2,e.beginPath(),this.drawRotationArcLine(e),e.lineTo(a.rotationCirclePoint.x,a.rotationCirclePoint.y),e.stroke(),e.fill(),e.closePath(),e.beginPath(),e.moveTo(a.rotationCirclePoint.x,a.rotationCirclePoint.y),e.arc(a.rotationCirclePoint.x,a.rotationCirclePoint.y,a.bottomCenterCircle.radius,0,2*Math.PI),e.stroke(),e.fill(),e.closePath(),e.lineWidth/=2):r.activeObj.shape!=="redact"&&this.drawCenterCircles(e),e.strokeStyle=u,e.fillStyle=c}n.rotationCircleLine=a.rotationCircleLine,r.activeObj=f({},n,{},!0)},d.prototype.drawArrowHead=function(e,i){var t=i?this.parent.activeObj.start:this.parent.activeObj.end;switch(t){case"arrowSolid":i?this.arrowSolid(e,!0):this.arrowSolid(e,!1);break;case"arrow":i?this.arrow(e,!0):this.arrow(e,!1);break;case"circleSolid":i?this.arrowCircleSolid(e,!0):this.arrowCircleSolid(e,!1);break;case"circle":i?this.arrowCircle(e,!0):this.arrowCircle(e,!1);break;case"bar":i?this.arrowBar(e,!0):this.arrowBar(e,!1);break;case"square":case"squareSolid":i?this.arrowSquareStart(e):this.arrowSquareEnd(e);break}},d.prototype.drawShapeObj=function(e,i,t,r){var o=this.parent,a=o.activeObj.activePoint,n=o.activeObj,s=n.strokeSettings,l=s.strokeColor,p=s.fillColor,h=s.strokeWidth,u=i!==void 0?i:o.currObjType.shape;o.currObjType.shape=u;var c;e.toLowerCase()==="original"?c=this.lowerContext:e.toLowerCase()==="duplicate"?c=this.upperContext:t&&(c=t);var g=o.currObjType.shape.toLowerCase(),v=["rectangle","ellipse","line","arrow","path","image","redact"];v.indexOf(g)!==-1&&(n.shape=o.currObjType.shape),c.strokeStyle=l,i==="text"||i==="freehanddraw"?c.fillStyle=l:c.fillStyle=p;var b=a.width/3,m=a.height/3,y=a.endX-a.startX,P=a.endY-a.startY;this.rotateContext("initial",c);var S=c.fillStyle,O;switch(o.currObjType.shape.toLowerCase()){case"rectangle":this.drawSquareLines(c),C(r)&&c===this.upperContext&&this.drawOuterSelection(c);break;case"redact":this.drawRedact(c,n),C(r)&&c===this.upperContext&&this.drawOuterSelection(c),o.currObjType.isRedact=!0;break;case"ellipse":y=Math.abs(y),P=Math.abs(P),c.beginPath(),c.ellipse(a.startX+y/2,a.startY+P/2,y/2,P/2,0,0,2*Math.PI,!1),p!==""&&(c.fillStyle=p,c.fill()),c.ellipse(a.startX+y/2,a.startY+P/2,Math.abs(y/2-h),Math.abs(P/2-h),0,0,2*Math.PI,!1),c.fillStyle=l,c.fill("evenodd"),c.closePath(),C(r)&&c===this.upperContext&&this.drawOuterSelection(c);break;case"crop-circle":this.shapeCircle(c,y,P);break;case"line":this.shapeLine(c,a.startX,a.startY,a.endX,a.endY),C(r)&&c===this.upperContext&&this.drawOuterSelection(c);break;case"arrow":n.shapeDegree===0?o.transform.degree:o.transform.degree-n.shapeDegree,c.fillStyle=c.strokeStyle,C(n.triangleDirection)&&(n.triangleDirection="right"),C(n.start)&&(n.start="none"),C(n.end)&&(n.end="arrowSolid"),this.drawArrowHead(c,!0),this.drawArrowHead(c,!1),n.end==="none"&&n.start!=="circle"&&n.start!=="square"&&this.shapeLine(c,a.startX,a.startY,a.endX,a.endY),c.fillStyle=S,C(r)&&c===this.upperContext&&this.drawOuterSelection(c);break;case"path":if(O=f({},o.activeObj,{},!0),O.pointColl.length>1){var j={shape:null};if(o.notify("selection",{prop:"getCurrentDrawingShape",value:{obj:j}}),j.shape==="path"&&o.isShapeDrawing)for(var x={x:0,y:0},k=0,T=O.pointColl.length;k<T;k++)C(O.pointColl[k+1])?(x.x=O.activePoint.endX,x.y=O.activePoint.endY):(x.x=O.pointColl[k+1].x,x.y=O.pointColl[k+1].y),a.startX=O.pointColl[k].x,a.startY=O.pointColl[k].y,a.endX=x.x,a.endY=x.y,o.activeObj=this.updateWidthHeight(o.activeObj),this.shapeLine(c,a.startX,a.startY,a.endX,a.endY),w.isDevice&&(O.activePoint.endX=x.x,O.activePoint.endY=x.y);else for(var k=1,T=O.pointColl.length;k<T;k++)a.startX=O.pointColl[k-1].x,a.startY=O.pointColl[k-1].y,a.endX=O.pointColl[k].x,a.endY=O.pointColl[k].y,o.activeObj=this.updateWidthHeight(o.activeObj),this.shapeLine(c,a.startX,a.startY,a.endX,a.endY);o.activeObj=n=O}else this.shapeLine(c,a.startX,a.startY,a.endX,a.endY);c===this.upperContext&&this.drawOuterSelection(c);break;case"text":this.shapeText(c);break;case"image":this.shapeImage(c),C(r)&&c===this.upperContext&&this.drawOuterSelection(c);break;case"crop-square":case"crop-3:4":case"crop-4:3":case"crop-6:9":case"crop-9:6":case"crop-9:16":case"crop-16:9":c===this.lowerContext&&(c=this.upperContext),this.drawSelection(b,m),o.currObjType.shape="";break;default:this.drawSelection(b,m);break}this.rotateContext("reverse",c)},d.prototype.updatePoints=function(){var e=this.parent,i=e.activeObj.activePoint,t=e.img,r=t.destLeft,o=t.destTop;i.startX+=r,i.startY+=o,i.endX+=r,i.endY+=o,e.activeObj=this.updateWidthHeight(e.activeObj)},d.prototype.updateWidthHeight=function(e){var i=e.activePoint,t=i.startX,r=i.startY,o=i.endX,a=i.endY;return e.activePoint.width=o-t,e.activePoint.height=a-r,e},d.prototype.drawCornerCircles=function(e){var i=this.parent,t=i.activeObj;if(e.beginPath(),e.rect(t.activePoint.startX,t.activePoint.startY,t.activePoint.width,t.activePoint.height),e.stroke(),e.closePath(),i.selectionSettings.showCircle){var r=e.strokeStyle,o=e.fillStyle;e.strokeStyle=i.selectionSettings.strokeColor,e.fillStyle=i.selectionSettings.fillColor,e.lineWidth*=2,e.beginPath(),e.moveTo(t.topLeftCircle.startX,t.topLeftCircle.startY),e.arc(t.topLeftCircle.startX,t.topLeftCircle.startY,t.topLeftCircle.radius,0,2*Math.PI),e.moveTo(t.topRightCircle.startX,t.topRightCircle.startY),e.arc(t.topRightCircle.startX,t.topRightCircle.startY,t.topRightCircle.radius,0,2*Math.PI),e.moveTo(t.bottomLeftCircle.startX,t.bottomLeftCircle.startY),e.arc(t.bottomLeftCircle.startX,t.bottomLeftCircle.startY,t.bottomLeftCircle.radius,0,2*Math.PI),e.moveTo(t.bottomRightCircle.startX,t.bottomRightCircle.startY),e.arc(t.bottomRightCircle.startX,t.bottomRightCircle.startY,t.bottomRightCircle.radius,0,2*Math.PI),e.stroke(),e.fill(),e.closePath(),e.lineWidth/=2,e.strokeStyle=r,e.fillStyle=o}},d.prototype.drawCenterCircles=function(e){var i=this.parent,t=i.activeObj.activePoint,r=i.activeObj;if(e.lineWidth*=2,e.beginPath(),r.shape==="arrow"||r.shape==="line")e.moveTo(t.startX,t.startY),e.arc(t.startX,t.startY,r.topCenterCircle.radius,0,2*Math.PI),e.moveTo(t.endX,t.endY),e.arc(t.endX,t.endY,r.bottomCenterCircle.radius,0,2*Math.PI);else if(r.shape==="path"){var o=f({},i.activeObj,{},!0);if(o.pointColl.length>1)for(var a=1,n=o.pointColl.length;a<n;a++)t.startX=o.pointColl[a-1].x,t.startY=o.pointColl[a-1].y,t.endX=o.pointColl[a].x,t.endY=o.pointColl[a].y,e.moveTo(t.startX,t.startY),e.arc(t.startX,t.startY,r.topCenterCircle.radius,0,2*Math.PI),e.moveTo(t.endX,t.endY),e.arc(t.endX,t.endY,r.bottomCenterCircle.radius,0,2*Math.PI);var s={shape:null};i.notify("selection",{prop:"getCurrentDrawingShape",value:{obj:s}}),s.shape==="path"&&(i.activeObj=r=o),e.moveTo(t.startX,t.startY),e.arc(t.startX,t.startY,r.topCenterCircle.radius,0,2*Math.PI),e.moveTo(t.endX,t.endY),e.arc(t.endX,t.endY,r.bottomCenterCircle.radius,0,2*Math.PI)}else this.drawRotationArcLine(e),e.lineTo(r.rotationCirclePoint.x,r.rotationCirclePoint.y);e.stroke(),e.fill(),e.closePath(),r.shape!=="arrow"&&r.shape!=="line"&&r.shape!=="path"&&(e.beginPath(),e.moveTo(r.rotationCirclePoint.x,r.rotationCirclePoint.y),e.arc(r.rotationCirclePoint.x,r.rotationCirclePoint.y,r.bottomCenterCircle.radius,0,2*Math.PI),e.stroke(),e.fill(),e.closePath()),e.lineWidth/=2},d.prototype.drawRotationArcLine=function(e){var i=this.parent,t=i.activeObj;C(t.rotationCircleLine)&&(t.rotationCircleLine=22.5);var r,o=!1,a=!1;if(t.shapeDegree===0?r=i.transform.degree:r=i.transform.degree-t.shapeDegree,r<0&&(r=360+r),t.flipObjColl)for(var n=0,s=t.flipObjColl.length;n<s;n++){var l=t.flipObjColl[n].toLowerCase();l==="horizontal"?o=!0:l==="vertical"&&(a=!0)}switch(r){case 0:case 360:a?(t.rotationCirclePoint={x:t.topCenterCircle.startX,y:t.topCenterCircle.startY-t.rotationCircleLine},e.moveTo(t.rotationCirclePoint.x,t.rotationCirclePoint.y+t.rotationCircleLine)):(t.rotationCirclePoint={x:t.bottomCenterCircle.startX,y:t.bottomCenterCircle.startY+t.rotationCircleLine},e.moveTo(t.rotationCirclePoint.x,t.rotationCirclePoint.y-t.rotationCircleLine));break;case 90:case-270:o?(t.rotationCirclePoint={x:t.centerRightCircle.startX+t.rotationCircleLine,y:t.centerLeftCircle.startY},e.moveTo(t.rotationCirclePoint.x-t.rotationCircleLine,t.rotationCirclePoint.y)):(t.rotationCirclePoint={x:t.centerLeftCircle.startX-t.rotationCircleLine,y:t.centerLeftCircle.startY},e.moveTo(t.rotationCirclePoint.x+t.rotationCircleLine,t.rotationCirclePoint.y));break;case 180:case-180:a?(t.rotationCirclePoint={x:t.bottomCenterCircle.startX,y:t.bottomCenterCircle.startY+t.rotationCircleLine},e.moveTo(t.rotationCirclePoint.x,t.rotationCirclePoint.y-t.rotationCircleLine)):(t.rotationCirclePoint={x:t.topCenterCircle.startX,y:t.topCenterCircle.startY-t.rotationCircleLine},e.moveTo(t.rotationCirclePoint.x,t.rotationCirclePoint.y+t.rotationCircleLine));break;case 270:case-90:o?(t.rotationCirclePoint={x:t.centerLeftCircle.startX-t.rotationCircleLine,y:t.centerLeftCircle.startY},e.moveTo(t.rotationCirclePoint.x+t.rotationCircleLine,t.rotationCirclePoint.y)):(t.rotationCirclePoint={x:t.centerRightCircle.startX+t.rotationCircleLine,y:t.centerLeftCircle.startY},e.moveTo(t.rotationCirclePoint.x-t.rotationCircleLine,t.rotationCirclePoint.y));break}},d.prototype.drawSquareLines=function(e){var i,t=this.parent,r=t.activeObj,o=r.activePoint,a=o.startX,n=o.startY,s=o.width,l=o.height,p=r.strokeSettings,h=p.fillColor,u=p.strokeColor,c=p.strokeWidth,g=p.radius;r.shape&&(i=r.shape.split("-")),i[0]==="crop"?e.strokeStyle="#fff":e.strokeStyle=u,e.beginPath();var v={width:0,height:0},b={width:1,height:1};t.notify("crop",{prop:"calcRatio",onPropertyChange:!1,value:{obj:v,dimension:{width:e.canvas.width,height:e.canvas.height}}}),b=v;var m=e.canvas.id===t.element.id+"_tempCanvas",y=t.transform.zoomFactor,P=m?g*10*((b.width+b.height)/2):g*10,S=P+P*y;g!==null?t.isSafari?this.drawRoundedRect(e,a,n,s,l,S):e.roundRect(a,n,s,l,S):e.rect(a,n,s,l),h!==""&&(e.fillStyle=h,e.fill()),g!==null?t.isSafari?this.drawRoundedRect(e,a+c,n+c,s-2*c,l-2*c,S):e.roundRect(a+c,n+c,s-2*c,l-2*c,S):e.rect(a+c,n+c,s-2*c,l-2*c),e.fillStyle=u,e.fill("evenodd"),e.closePath()},d.prototype.drawRoundedRect=function(e,i,t,r,o,a){var n=Math.max(0,Math.min(a,r/2,o/2));e.moveTo(i+n,t),e.arcTo(i+r,t,i+r,t+o,n),e.arcTo(i+r,t+o,t,t+o,n),e.arcTo(i,t+o,i,t,n),e.arcTo(i,t,i+r,t,n),e.closePath()},d.prototype.drawSelection=function(e,i){var t=this.parent,r=t.activeObj,o=r.activePoint,a=o.startX,n=o.startY,s=o.endX,l=o.endY;this.upperContext.strokeStyle=t.themeColl[t.theme].primaryColor,this.upperContext.beginPath(),r.horTopInnerLine={startX:a,startY:n+i,endX:s,endY:l+i},r.horBottomInnerLine={startX:a,startY:n+2*i,endX:s,endY:l+2*i},r.verLeftInnerLine={startX:a+e,startY:n,endX:a+e,endY:l},r.verRightInnerLine={startX:a+2*e,startY:n,endX:a+2*e,endY:l},this.upperContext.moveTo(r.horTopInnerLine.startX,r.horTopInnerLine.startY),this.upperContext.lineTo(r.horTopInnerLine.endX,r.horTopInnerLine.startY),this.upperContext.moveTo(r.horBottomInnerLine.startX,r.horBottomInnerLine.startY),this.upperContext.lineTo(r.horBottomInnerLine.endX,r.horBottomInnerLine.startY),this.upperContext.moveTo(r.verLeftInnerLine.startX,r.verLeftInnerLine.startY),this.upperContext.lineTo(r.verLeftInnerLine.endX,r.verLeftInnerLine.endY),this.upperContext.moveTo(r.verRightInnerLine.startX,r.verRightInnerLine.startY),this.upperContext.lineTo(r.verRightInnerLine.endX,r.verRightInnerLine.endY),this.upperContext.stroke(),this.upperContext.closePath()},d.prototype.shapeCircle=function(e,i,t){var r=this.parent,o=r.activeObj.activePoint,a=o.startX,n=o.startY,s=o.endX,l=o.endY,p=o.width;e.strokeStyle=r.themeColl[r.theme].primaryColor,e.clearRect(0,0,r.lowerCanvas.width,r.lowerCanvas.height),e.fillStyle="rgb(0, 0, 0, 0.25)",e.fillRect(0,0,r.lowerCanvas.width,r.lowerCanvas.height);var h=e.lineWidth;e.lineWidth=2,e.beginPath(),e.ellipse(r.activeObj.horTopLine.startX+i/2,r.activeObj.horTopLine.startY+t/2,i/2,t/2,0,0,2*Math.PI,!1),e.stroke(),e.closePath(),e.save(),e.beginPath(),e.arc((s-a)/2+a,(l-n)/2+n,p/2,0,Math.PI*2),e.closePath(),e.clip(),e.clearRect(0,0,r.lowerCanvas.width,r.lowerCanvas.height),e.restore(),e.lineWidth=h,this.drawOuterSelection(e,!0),r.currObjType.shape=""},d.prototype.shapeLine=function(e,i,t,r,o){var a=e.lineWidth;e.lineWidth=this.parent.activeObj.strokeSettings.strokeWidth,e.beginPath(),e.moveTo(i,t),e.lineTo(r,o),e.stroke(),e.lineWidth=a},d.prototype.manipulateSaveCtx=function(e,i,t){if(e!==this.lowerContext&&e!==this.upperContext){var r={width:0,height:0};this.parent.notify("crop",{prop:"calcRatio",onPropertyChange:!1,value:{obj:r,dimension:{width:e.canvas.width,height:e.canvas.height}}});var o=r;i&&(i*=o.width),t&&(t*=o.height)}return{x:i,y:t}},d.prototype.arrow=function(e,i){var t=this.parent,r=t.activeObj,o=r.activePoint,a=o.startX,n=o.startY,s=o.endX,l=o.endY,p=r.strokeSettings.strokeWidth;e.lineWidth=p;var h=this.arrowDimension.arrow.width,u=this.arrowDimension.arrow.height,c=this.manipulateSaveCtx(e,h,u);h=c.x+p,u=c.y+p,this.dx=s-a,this.dy=l-n,e.fillStyle=r.strokeSettings.strokeColor;var g=Math.atan2(this.dy,this.dx),v=r.start==="arrow",b=r.end==="arrow",m=r.end==="circle"||r.end==="square",y=r.start==="circle"||r.start==="square";((i&&r.triangleDirection==="left"||r.triangleDirection==="right")&&(v&&r.end==="none"||v&&!m&&!y)||!i&&(b&&r.start==="none"||!v&&!m&&!y))&&this.shapeLine(e,a,n,s,l),i&&r.triangleDirection==="left"||!i&&r.triangleDirection==="right"?(e.translate(s,l),e.rotate(g),this.shapeLine(e,0,0,-h,u/2),this.shapeLine(e,0,0,-h,-u/2),e.rotate(-g),e.translate(-s,-l)):(i&&r.triangleDirection==="right"||!i&&r.triangleDirection==="left")&&(e.translate(a,n),e.rotate(g),this.shapeLine(e,0,0,h,u/2),this.shapeLine(e,0,0,h,-u/2),e.rotate(-g),e.translate(-a,-n))},d.prototype.arrowSolid=function(e,i){var t=this.parent,r=t.activeObj,o=r.strokeSettings.strokeWidth,a=r.activePoint,n=a.startX,s=a.startY,l=a.endX,p=a.endY,h=this.arrowDimension.arrowSolid.width,u=this.arrowDimension.arrowSolid.height,c=this.manipulateSaveCtx(e,h,u);h=c.x+o,u=c.y+o,this.dx=l-n,this.dy=p-s;var g=Math.atan2(this.dy,this.dx),v=r.start==="arrowSolid",b=r.end==="arrowSolid",m=r.end==="circle"||r.end==="square",y=r.start==="circle"||r.start==="square";(i&&v&&r.end==="none"||v&&!m&&!y||!i&&(b&&r.start==="none"||!v&&!m&&!y))&&this.shapeLine(e,n,s,l,p),i&&r.triangleDirection==="left"||!i&&r.triangleDirection==="right"?(e.translate(l,p),e.rotate(g),e.beginPath(),e.moveTo(o,0),e.lineTo(-h+u/2,u/2),e.lineTo(-h+u/2,-u/2),e.closePath(),e.fill(),e.rotate(-g),e.translate(-l,-p),r.rotatedAngle=g):(i&&r.triangleDirection==="right"||!i&&r.triangleDirection==="left")&&(e.translate(n,s),e.rotate(g),e.beginPath(),e.moveTo(0-o,0),e.lineTo(h-u/2,u/2),e.lineTo(h-u/2,-u/2),e.closePath(),e.fill(),e.rotate(-g),e.translate(-n,-s),r.rotatedAngle=g)},d.prototype.arrowSquareStart=function(e){var i=this.parent,t=i.activeObj,r=t.strokeSettings.strokeWidth,o=t.activePoint,a=o.startX,n=o.startY,s=o.endX,l=o.endY,p=t.start==="square",h=t.end==="circle",u=t.start==="squareSolid",c=t.end==="circleSolid";(p&&t.end==="none"||p&&!h&&t.start!=="square"||u&&c)&&this.shapeLine(e,a,n,s,l),e.lineWidth=r,e.beginPath(),e.fillStyle=t.strokeSettings.strokeColor;var g=this.arrowDimension.square.width,v=this.arrowDimension.square.height,b=this.manipulateSaveCtx(e,g,v);g=b.x+r,v=b.y+r,this.dx=s-a,this.dy=l-n;var m=Math.atan2(this.dy,this.dx);t.triangleDirection==="left"?(e.translate(s,l),e.rotate(m),t.start==="squareSolid"&&e.fillRect(-g+v/2,-v/2,g,v),e.strokeRect(-g+v/2,-v/2,g,v),e.rotate(-m),e.translate(-s,-l),this.squareStartIntersectX1=s-v/2*Math.cos(m),this.squareStartIntersectY1=l-v/2*Math.sin(m),t.start==="square"&&t.end!=="square"&&t.end!=="circle"?this.shapeLine(e,a,n,this.squareStartIntersectX1,this.squareStartIntersectY1):t.start==="square"&&t.end==="circle"?this.shapeLine(e,this.endCircleIntersectX1,this.endCircleIntersectY1,this.squareStartIntersectX1,this.squareStartIntersectY1):t.start==="squareSolid"&&t.end==="squareSolid"&&this.shapeLine(e,a,n,s,l)):t.triangleDirection==="right"&&(e.lineWidth=r,e.fillStyle=t.strokeSettings.strokeColor,t.start==="squareSolid"&&t.end==="squareSolid"&&this.shapeLine(e,a,n,s,l),e.translate(a,n),e.rotate(m),t.start==="squareSolid"&&e.fillRect(v/2-g,-v/2,g,v),e.strokeRect(v/2-g,-v/2,g,v),e.rotate(-m),e.translate(-a,-n),t.rotatedAngle=m,this.squareStartIntersectX1=a+v/2*Math.cos(m),this.squareStartIntersectY1=n+v/2*Math.sin(m),t.start==="square"&&t.end!=="square"&&t.end!=="circle"&&this.shapeLine(e,s,l,this.squareStartIntersectX1,this.squareStartIntersectY1),t.start==="square"&&t.end==="circle"&&this.shapeLine(e,this.endCircleIntersectX1,this.endCircleIntersectY1,this.squareStartIntersectX1,this.squareStartIntersectY1))},d.prototype.arrowSquareEnd=function(e){var i=this.parent,t=i.activeObj,r=t.activePoint,o=r.startX,a=r.startY,n=r.endX,s=r.endY,l=t.strokeSettings.strokeWidth,p=this.arrowDimension.square.width,h=this.arrowDimension.square.height,u=this.manipulateSaveCtx(e,p,h);p=u.x+l,h=u.y+l,this.dx=n-o,this.dy=s-a;var c=Math.atan2(this.dy,this.dx);e.lineWidth=l,t.triangleDirection==="right"?(e.fillStyle=t.strokeSettings.strokeColor,t.end==="squareSolid"&&t.start==="none"&&this.shapeLine(e,o,a,n,s),e.translate(n,s),e.rotate(c),t.end==="squareSolid"&&e.fillRect(-p+h/2,-h/2,p,h),e.strokeRect(-p+h/2,-h/2,p,h),e.rotate(-c),e.translate(-n,-s),t.rotatedAngle=c,this.squareEndIntersectX1=n-h/2*Math.cos(c),this.squareEndIntersectY1=s-h/2*Math.sin(c),t.end==="square"&&t.start!=="square"&&t.start!=="circle"?this.shapeLine(e,o,a,this.squareEndIntersectX1,this.squareEndIntersectY1):t.start==="circle"&&t.end==="square"?this.shapeLine(e,this.squareEndIntersectX1,this.squareEndIntersectY1,this.startCircleIntersectX1,this.startCircleIntersectY1):t.start==="square"&&t.end==="square"&&this.shapeLine(e,this.squareEndIntersectX1,this.squareEndIntersectY1,this.squareStartIntersectX1,this.squareStartIntersectY1)):t.triangleDirection==="left"&&(e.translate(o,a),e.rotate(c),t.end==="squareSolid"&&e.fillRect(h/2-p,-h/2,p,h),e.strokeRect(h/2-p,-h/2,p,h),e.rotate(-c),e.translate(-o,-a),t.rotatedAngle=c,this.squareEndIntersectX1=o+h/2*Math.cos(c),this.squareEndIntersectY1=a+h/2*Math.sin(c),t.end==="square"&&t.start!=="square"&&t.start!=="circle"?this.shapeLine(e,n,s,this.squareEndIntersectX1,this.squareEndIntersectY1):t.start==="circle"&&t.end==="square"?this.shapeLine(e,this.squareEndIntersectX1,this.squareEndIntersectY1,this.startCircleIntersectX1,this.startCircleIntersectY1):t.start==="square"&&t.end==="square"?this.shapeLine(e,this.squareEndIntersectX1,this.squareEndIntersectY1,this.squareStartIntersectX1,this.squareStartIntersectY1):t.end==="squareSolid"&&t.start==="none"&&this.shapeLine(e,o,a,n,s))},d.prototype.arrowCircle=function(e,i){var t=this.parent,r=t.activeObj,o=r.activePoint,a=o.startX,n=o.startY,s=o.endX,l=o.endY,p=r.strokeSettings.strokeWidth;if(i&&r.triangleDirection==="left"||!i&&r.triangleDirection==="right"){e.lineWidth=p;var h=this.arrowDimension.circle.width,u=this.manipulateSaveCtx(e,h,null);h=u.x+p,e.beginPath(),e.arc(s,l,h,0,2*Math.PI),e.stroke(),e.closePath(),this.dx=s-a,this.dy=l-n;var c=this.dx*this.dx+this.dy*this.dy,g=2*(this.dx*(a-s)+this.dy*(n-l)),v=(a-s)*(a-s)+(n-l)*(n-l)-h*h,b=g*g-4*c*v;if(b>=0){e.fillStyle=r.strokeSettings.strokeColor;var m=(-g-Math.sqrt(b))/(2*c),y=a+this.dx*m,P=n+this.dy*m;i?(this.startCircleIntersectX1=y,this.startCircleIntersectY1=P,this.endCircleIntersectX1=s-this.dx*m,this.endCircleIntersectY1=l-this.dy*m,e.beginPath(),e.fill(),e.beginPath(),r.start==="circle"&&r.end==="circle"?this.shapeLine(e,this.startCircleIntersectX1,this.startCircleIntersectY1,this.endCircleIntersectX1,this.endCircleIntersectY1):r.start==="circle"&&r.end!=="circle"&&r.end!=="square"&&this.shapeLine(e,a,n,this.startCircleIntersectX1,this.startCircleIntersectY1),e.stroke(),e.closePath()):(this.endCircleIntersectX1=y,this.endCircleIntersectY1=P,r.end==="circle"&&r.start!=="circle"&&r.start!=="square"&&this.shapeLine(e,a,n,this.endCircleIntersectX1,this.endCircleIntersectY1))}var S=Math.atan2(this.dy,this.dx);t.activeObj.rotatedAngle=S}else if(i&&r.triangleDirection==="right"||!i&&r.triangleDirection==="left"){e.lineWidth=p;var h=this.arrowDimension.circle.width,u=this.manipulateSaveCtx(e,h,null);h=u.x+p,e.beginPath(),e.arc(a,n,h,0,2*Math.PI),e.stroke(),e.closePath(),this.dx=a-s,this.dy=n-l;var c=this.dx*this.dx+this.dy*this.dy,g=2*(this.dx*(s-a)+this.dy*(l-n)),v=(s-a)*(s-a)+(l-n)*(l-n)-h*h,b=g*g-4*c*v;if(b>=0){e.fillStyle=r.strokeSettings.strokeColor;var m=(-g-Math.sqrt(b))/(2*c),y=s+this.dx*m,P=l+this.dy*m;i?(this.startCircleIntersectX1=y,this.startCircleIntersectY1=P,this.endCircleIntersectX1=a-this.dx*m,this.endCircleIntersectY1=n-this.dy*m,r.start==="circle"&&r.end==="circle"?this.shapeLine(e,this.endCircleIntersectX1,this.endCircleIntersectY1,this.startCircleIntersectX1,this.startCircleIntersectY1):r.start==="circle"&&r.end!=="circle"&&r.end!=="square"&&this.shapeLine(e,s,l,this.startCircleIntersectX1,this.startCircleIntersectY1)):(this.endCircleIntersectX1=y,this.endCircleIntersectY1=P,e.beginPath(),e.fill(),e.beginPath(),r.end==="circle"&&r.start!=="circle"&&r.start!=="square"&&this.shapeLine(e,s,l,this.endCircleIntersectX1,this.endCircleIntersectY1))}var S=Math.atan2(this.dy,this.dx);t.activeObj.rotatedAngle=S}},d.prototype.arrowCircleSolid=function(e,i){var t=this.parent,r=t.activeObj,o=r.activePoint,a=o.startX,n=o.startY,s=o.endX,l=o.endY,p=r.start==="circleSolid",h=r.strokeSettings.strokeWidth;if(i&&r.triangleDirection==="left"||!i&&r.triangleDirection==="right"){e.lineWidth=h,e.beginPath(),e.fillStyle=r.strokeSettings.strokeColor,(i&&p&&r.end==="none"||p&&r.end!=="circle"&&r.end!=="square"||!i&&r.end==="circleSolid"&&r.start==="none")&&this.shapeLine(e,a,n,s,l);var u=this.arrowDimension.circle.width,c=this.manipulateSaveCtx(e,u,null);u=c.x+h,this.dx=s-a,this.dy=l-n,e.save(),e.beginPath(),e.arc(s,l,u,0,2*Math.PI),e.stroke(),e.fill(),e.closePath(),r.rotatedAngle=Math.atan2(this.dy,this.dx)}else if(i&&r.triangleDirection==="right"||!i&&r.triangleDirection==="left"){e.lineWidth=h,e.beginPath(),e.fillStyle=r.strokeSettings.strokeColor,(i&&p&&r.end==="none"||p&&r.end!=="circle"&&r.end!=="square"||!i&&r.end==="circleSolid"&&r.start==="none")&&this.shapeLine(e,a,n,s,l);var u=this.arrowDimension.circle.width,c=this.manipulateSaveCtx(e,u,null);u=c.x+h,this.dx=s-a,this.dy=l-n,e.save(),e.beginPath(),e.arc(a,n,u,0,2*Math.PI),e.stroke(),e.fill(),e.closePath(),r.rotatedAngle=Math.atan2(this.dy,this.dx)}},d.prototype.arrowBar=function(e,i){var t=this.parent,r=t.activeObj,o=r.activePoint,a=o.startX,n=o.startY,s=o.endX,l=o.endY,p=r.strokeSettings.strokeWidth;if(i&&r.triangleDirection==="left"||!i&&r.triangleDirection==="right"){e.lineWidth=p,e.beginPath(),e.fillStyle=r.strokeSettings.strokeColor,(i&&r.start==="bar"&&r.end==="none"||r.start==="bar"&&r.end!=="circle"&&r.end!=="square"||!i&&(r.end==="bar"&&r.start==="none"||r.end==="bar"&&r.start!=="circle"&&r.start!=="square"))&&this.shapeLine(e,a,n,s,l);var h=this.arrowDimension.bar.width,u=this.arrowDimension.bar.height,c=this.manipulateSaveCtx(e,h,u);h=c.x+p,u=c.y+p,this.dx=s-a,this.dy=l-n;var g=Math.atan2(this.dy,this.dx);e.translate(s,l),e.rotate(g),e.fillRect(-h+u/4,-u/2,h,u),e.rotate(-g),e.translate(-s,-l),r.rotatedAngle=g}else if(i&&r.triangleDirection==="right"||!i&&r.triangleDirection==="left"){e.lineWidth=p,e.beginPath(),e.fillStyle=r.strokeSettings.strokeColor,(i&&r.start==="bar"&&r.end==="none"||r.start==="bar"&&r.end!=="circle"&&r.end!=="square"||!i&&r.end==="bar"&&r.start==="none")&&this.shapeLine(e,a,n,s,l);var h=this.arrowDimension.bar.width,u=this.arrowDimension.bar.height,c=this.manipulateSaveCtx(e,h,u);h=c.x+p,u=c.y+p,this.dx=s-a,this.dy=l-n;var g=Math.atan2(this.dy,this.dx);e.translate(a,n),e.rotate(g),e.fillRect(u/4-h,-u/2,h,u),e.rotate(-g),e.translate(-a,-n),t.activeObj.rotatedAngle=g}},d.prototype.shapeImage=function(e){var i=this.parent,t=i.activeObj,r=t.activePoint,o=r.startX,a=r.startY,n=r.width,s=r.height,l=t.imageCanvas.getContext("2d");if(e===this.lowerContext&&this.isImageApply){var p={width:0,height:0};i.notify("transform",{prop:"calcMaxDimension",onPropertyChange:!1,value:{width:t.imageElement.width,height:t.imageElement.height,obj:p,isImgShape:null}}),(n<p.width/5||s<p.height/5)&&(l.clearRect(0,0,t.imageCanvas.width,t.imageCanvas.height),i.notify("selection",{prop:"applyTransformToImg",onPropertyChange:!1,value:{ctx:l}}),i.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}}),this.upperContext.clearRect(0,0,i.upperCanvas.width,i.upperCanvas.height),i.notify("selection",{prop:"setImageClarity",onPropertyChange:!1,value:{bool:!1}}),this.isImageApply=!1)}var h={startX:0,startY:0,width:0,height:0};h.width=n,h.height=s,t.flipObjColl.length===4&&(t.flipObjColl=[],t.shapeFlip=""),h.startX=(n-h.width)/2+o,h.startY=(s-h.height)/2+a;var u=e.globalAlpha;e.globalAlpha=t.opacity,t.rotateFlipColl&&t.rotateFlipColl.length>0?this.rotateImage(e):e.drawImage(t.imageCanvas,h.startX,h.startY,h.width,h.height),e.globalAlpha=u,i.currObjType.isText=!1},d.prototype.shapeText=function(e){var i=this.parent,t=e.filter,r=i.activeObj,o=r.activePoint,a=o.startX,n=o.startY,s=o.width,l=o.height,p=r.keyHistory.split(`
`),h=r.textSettings,u=h.fontFamily,c=h.bold,g=h.italic,v=r.textSettings.fontSize,b=v+v*.25,m=(b*p.length-v*p.length)/p.length;e.filter="none";var y=e.fillStyle;r.strokeSettings.fillColor!==""&&(e.fillStyle=r.strokeSettings.fillColor,e.fillRect(r.activePoint.startX,r.activePoint.startY,r.activePoint.width,r.activePoint.height)),e.fillStyle=y;for(var P=0;P<p.length;P++){var S=p[P],O=(P+1)*v*.85+P*m;i.transform.degree===-360&&(i.transform.degree=0),i.transform.degree===0||i.transform.degree===180?v>l&&(v=r.textSettings.fontSize=l-l*.1):v>s&&(v=r.textSettings.fontSize=s-s*.1),e.strokeStyle=r.strokeSettings.outlineColor,e.fillStyle=r.strokeSettings.strokeColor;var j=e.lineWidth,x={width:0,height:0},k={width:1,height:1};i.notify("crop",{prop:"calcRatio",onPropertyChange:!1,value:{obj:x,dimension:{width:e.canvas.width,height:e.canvas.height}}}),k=x;var T=e.canvas.id===i.element.id+"_tempCanvas",A=Math.max(1,r.strokeSettings.outlineWidth/2);/^#([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6}|[0-9A-Fa-f]{8})$|^[a-zA-Z]+$/.test(r.strokeSettings.outlineColor)?(e.lineWidth=A*(Math.floor(T?(v-1)/60:(v-1)/16)*.5+.5),T&&(e.lineWidth*=(k.width+k.height)/2,i.transform.degree!==0&&(e.lineWidth/=1.8))):e.lineWidth=1;var L="";c&&(L="bold "),g&&(L="italic "),c&&g&&(L="italic bold "),e.font=L+v+"px "+u,r.flipObjColl.length===4&&(r.flipObjColl=[],r.shapeFlip=""),r.rotateFlipColl&&r.rotateFlipColl.length>0?this.rotateText(e):(e.strokeText(S,a+v*.1,n+O),e.fillText(S,a+v*.1,n+O)),e.lineWidth=j}e.filter=t,i.currObjType.isText=!1,this.upperContext===e&&this.drawOuterSelection(e)},d.prototype.updateActPoint=function(e,i){var t=this.parent,r=t.activeObj,o=r.activePoint;return e.toLowerCase()==="horizontal"?o.startX<=i.canvas.width/2?(o.startX=i.canvas.width/2+(i.canvas.width/2-o.endX),o.endX=o.startX+o.width,this.updateActiveObject(o,r),t.activeObj=r):o.startX>=i.canvas.width/2&&(o.startX=i.canvas.width-o.endX,o.endX=o.startX+o.width,this.updateActiveObject(o,r),t.activeObj=r):e.toLowerCase()==="vertical"&&(o.startY<=i.canvas.height/2?(o.startY=i.canvas.height/2+(i.canvas.height/2-o.endY),o.endY=o.startY+o.height,this.updateActiveObject(o,r),t.activeObj=r):o.startY>=i.canvas.height/2&&(o.startY=i.canvas.height-o.endY,o.endY=o.startY+o.height,this.updateActiveObject(o,r),t.activeObj=r)),o},d.prototype.rotateImage=function(e){var i=this.parent,t,r=i.activeObj,o=f({},i.activeObj,null,!0);r.shapeDegree===0?t=i.transform.degree:t=i.transform.degree-r.shapeDegree,t===-450&&(t=-90),t<0&&(t=360+t);var a={startX:0,startY:0,width:0,height:0};a.width=t%90===0&&t%180!==0?r.activePoint.height:r.activePoint.width,a.height=t%90===0&&t%180!==0?r.activePoint.width:r.activePoint.height,a.startX=r.activePoint.startX,a.startY=r.activePoint.startY;var n=a.startX,s=a.startY,l;e.save();for(var p=0,h=r.rotateFlipColl.length;p<h;p++){var u=r.rotateFlipColl[p];typeof u=="number"?(l=u,l===-450&&(l=-90),l<0&&(l=360+l),a.width=l%90===0&&l%180!==0?r.activePoint.height:r.activePoint.width,a.height=l%90===0&&l%180!==0?r.activePoint.width:r.activePoint.height,e.translate(e.canvas.width/2,e.canvas.height/2),e.rotate(Math.PI/180*u),e.translate(-e.canvas.height/2,-e.canvas.width/2),l%90===0&&l%270!==0||l===0?(s=e.canvas.width-(r.activePoint.startX+r.activePoint.width),s+=(r.activePoint.width-a.height)/2,n=a.startY):l%270===0&&(n=e.canvas.height-(r.activePoint.startY+r.activePoint.height),n+=(r.activePoint.height-a.width)/2,s=a.startX),a.startX=n,a.startY=s,r.activePoint.startX=n,r.activePoint.startY=s,r.activePoint.endX=r.activePoint.startX+a.width,r.activePoint.endY=r.activePoint.startY+a.height,r=this.updateWidthHeight(r)):(u==="horizontal"&&t%90===0&&t%180!==0?u="vertical":u==="vertical"&&t%90===0&&t%180!==0&&(u="horizontal"),u==="horizontal"?(e.translate(e.canvas.width,0),e.scale(-1,1),r.activePoint=this.updateActPoint("horizontal",e)):u==="vertical"&&(e.translate(0,e.canvas.height),e.scale(1,-1),r.activePoint=this.updateActPoint("vertical",e)),a.startX=r.activePoint.startX,a.startY=r.activePoint.startY),a.startX=r.activePoint.startX,a.startY=r.activePoint.startY,n=a.startX,s=a.startY}r.rotatedAngle!==0&&i.notify("shape",{prop:"setPointCollForShapeRotation",onPropertyChange:!1,value:{obj:r}}),e.drawImage(r.imageCanvas,a.startX,a.startY,a.width,a.height),e.restore(),i.activeObj=o,(i.transform.degree===360||i.transform.degree===-360)&&(i.transform.degree=0)},d.prototype.rotateText=function(e){var i=this.parent,t,r=i.activeObj,o=f({},i.activeObj,null,!0),a=i.activeObj.activePoint;r.shapeDegree===0?t=i.transform.degree:t=i.transform.degree-r.shapeDegree,t===-450&&(t=-90),t<0&&(t=360+t);var n={startX:0,startY:0,width:0,height:0};n.width=t%90===0&&t%180!==0?a.height:a.width,n.height=t%90===0&&t%180!==0?a.width:a.height,n.startX=a.startX,n.startY=a.startY;var s=n.startX,l=n.startY,p;e.save();for(var h=0,u=r.rotateFlipColl.length;h<u;h++){var c=r.rotateFlipColl[h];typeof c=="number"?(p=c,p===-450&&(p=-90),p<0&&(p=360+p),n.width=p%90===0&&p%180!==0?a.height:a.width,n.height=p%90===0&&p%180!==0?a.width:a.height,e.translate(e.canvas.width/2,e.canvas.height/2),e.rotate(Math.PI/180*c),e.translate(-e.canvas.height/2,-e.canvas.width/2),p%90===0&&p%270!==0||p===0?(l=e.canvas.width-a.endX,s=a.startY):p%270===0&&(s=e.canvas.height-a.endY,l=a.startX),n.startX=s,n.startY=l,a.startX=s,a.startY=l,a.endX=a.startX+n.width,a.endY=a.startY+n.height,r=this.updateWidthHeight(r)):(c==="horizontal"&&t%90===0&&t%180!==0?c="vertical":c==="vertical"&&t%90===0&&t%180!==0&&(c="horizontal"),c==="horizontal"?(e.translate(e.canvas.width,0),e.scale(-1,1)):c==="vertical"&&(e.translate(0,e.canvas.height),e.scale(1,-1)),r.activePoint=a=this.updateActPoint(c,e),n.startX=a.startX,n.startY=a.startY),n.startX=a.startX,n.startY=a.startY,s=n.startX,l=n.startY}r.rotatedAngle!==0&&i.notify("shape",{prop:"setPointCollForShapeRotation",onPropertyChange:!1,value:{obj:r}}),l+=r.textSettings.fontSize*.4,this.textFlipDegree(e,s,l),e.restore(),i.activeObj=o,(i.transform.degree===360||i.transform.degree===-360)&&(i.transform.degree=0)},d.prototype.textFlipDegree=function(e,i,t){for(var r=this.parent,o=r.activeObj,a=o.keyHistory.split(`
`),n=o.textSettings.fontSize,s=(n*a.length-n*a.length)/a.length,l=n*.85+s,p=0,h=a.length;p<h;p++){var u=a[p];p>0&&(p===1&&(l-=n*.85),l+=n+n*.15),e.strokeText(u,i+n*.15,t+l+(p>0?n*.25:-n*.35)),e.fillText(u,i+n*.15,t+l+(p>0?n*.25:-n*.35))}},d.prototype.clearOuterCanvas=function(e){var i=this.parent,t=i.img,r=t.destLeft,o=t.destTop,a=t.destWidth,n=t.destHeight,s=r>0?r:0,l=o>0?o:0;e.clearRect(0,0,s,i.lowerCanvas.height),e.clearRect(r+a,0,i.lowerCanvas.width-(r+a),i.lowerCanvas.height),e.clearRect(0,0,i.lowerCanvas.width,l),e.clearRect(0,o+n,i.lowerCanvas.width,i.lowerCanvas.height-(o+n)),i.transform.currFlipState!==""&&(i.img.destLeft=r,i.img.destTop=o)},d.prototype.setDestPoints=function(){var e,i=this.parent,t=i.transform,r=t.degree,o=t.zoomFactor;if(r%90===0&&r%180!==0){var a={width:0,height:0};i.notify("transform",{prop:"calcMaxDimension",onPropertyChange:!1,value:{width:i.img.srcHeight,height:i.img.srcWidth,obj:a,isImgShape:null}}),e=a,this.isRotateZoom&&(e.width+=e.width*o,e.height+=e.height*o,i.img.destWidth=e.height,i.img.destHeight=e.width),i.img.destLeft=(i.lowerCanvas.clientWidth-e.height)/2,i.img.destTop=(i.lowerCanvas.clientHeight-e.width)/2,i.img.destWidth=e.height,i.img.destHeight=e.width}else{var a={width:0,height:0};i.notify("transform",{prop:"calcMaxDimension",onPropertyChange:!1,value:{width:i.img.srcWidth,height:i.img.srcHeight,obj:a,isImgShape:null}}),e=a,this.isRotateZoom&&(e.width+=e.width*o,e.height+=e.height*o,i.img.destWidth=e.width,i.img.destHeight=e.height),i.img.destLeft=(i.lowerCanvas.clientWidth-e.width)/2,r===0?i.img.destTop=(i.lowerCanvas.clientHeight-e.height+1)/2:i.img.destTop=(i.lowerCanvas.clientHeight-e.height)/2,i.img.destWidth=e.width,i.img.destHeight=e.height}},d.prototype.updateCurrTransState=function(e,i,t,r){var o=this.parent,a=o.img.destLeft,n=o.img.destTop;e==="initial"&&(this.lowerContext.setTransform(1,0,0,1,0,0),C(i)&&this.setDestPoints()),o.isCircleCrop||o.currSelectionPoint&&o.currSelectionPoint.shape==="crop-circle"?(this.currTransState(e,!0,null,t),o.transform.degree===0&&o.transform.currFlipState===""&&o.transform.straighten===0&&C(r)&&(o.img.destLeft=a,o.img.destTop=n),t&&(o.img.destLeft+=o.panPoint.totalPannedClientPoint.x,o.img.destTop+=o.panPoint.totalPannedClientPoint.y),o.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),t&&(o.img.destLeft-=o.panPoint.totalPannedClientPoint.x,o.img.destTop-=o.panPoint.totalPannedClientPoint.y)):(this.currTransState(e,null,null,t),o.transform.degree===0&&o.transform.currFlipState===""&&o.transform.straighten===0&&C(r)&&(o.img.destLeft=a,o.img.destTop=n))},d.prototype.currTransState=function(e,i,t,r){var o=this.parent;t=t||this.lowerContext,e==="initial"?this.setTransformColl(t,e):e==="reverse"&&(this.setTransformColl(t,e),this.setClientTransDim(i),(o.isCircleCrop||o.currSelectionPoint&&o.currSelectionPoint.shape==="crop-circle"&&C(r))&&(r&&(o.img.destLeft+=o.panPoint.totalPannedClientPoint.x,o.img.destTop+=o.panPoint.totalPannedClientPoint.y),o.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),r&&(o.img.destLeft-=o.panPoint.totalPannedClientPoint.x,o.img.destTop-=o.panPoint.totalPannedClientPoint.y)))},d.prototype.setTransformColl=function(e,i){var t=this.parent;if(i==="initial")for(var r=0,o=t.rotateFlipColl.length;r<o;r++)this.setTransform(e,t.rotateFlipColl[r]);else if(i==="reverse")for(var r=t.rotateFlipColl.length-1;r>=0;r--)this.setTransform(e,t.rotateFlipColl[r],!0)},d.prototype.setTransform=function(e,i,t){var r=this.parent;switch(t&&i===90?i=-90:t&&i===-90&&(i=90),i==="horizontal"&&r.transform.degree%90===0&&r.transform.degree%180!==0?i="vertical":i==="vertical"&&r.transform.degree%90===0&&r.transform.degree%180!==0&&(i="horizontal"),r.notify("transform",{prop:"setReverseRotate",onPropertyChange:!1,value:{bool:!0}}),r.notify("transform",{prop:"setReverseFlip",onPropertyChange:!1,value:{isReverseFlip:!0}}),C(t)&&e.clearRect(0,0,e.canvas.width,e.canvas.height),i){case 90:case-90:e.translate(e.canvas.width/2,e.canvas.height/2),e.rotate(Math.PI/180*i),e.translate(-e.canvas.width/2,-e.canvas.height/2);break;case"horizontal":e.translate(e.canvas.width,0),e.scale(-1,1);break;case"vertical":e.translate(0,e.canvas.height),e.scale(1,-1);break}r.notify("transform",{prop:"setReverseRotate",onPropertyChange:!1,value:{bool:!1}}),r.notify("transform",{prop:"setReverseFlip",onPropertyChange:!1,value:{isReverseFlip:!1}})},d.prototype.drawImgToCanvas=function(e){var i=this.parent;this.lowerContext.clearRect(0,0,i.lowerCanvas.width,i.lowerCanvas.height),i.img.destWidth=e.width,i.img.destHeight=e.height,this.isInitialLoading&&(i.notify("filter",{prop:"initFilter",onPropertyChange:!1}),this.isInitialLoading=!1);var t=this.lowerContext.filter;this.lowerContext.clearRect(0,0,i.lowerCanvas.width,i.lowerCanvas.height),this.drawImage(),(i.currSelectionPoint&&i.currSelectionPoint.shape==="crop-circle"||i.isCircleCrop)&&i.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),this.lowerContext.filter=t},d.prototype.renderImage=function(e,i,t,r){var o=this.parent;o.notify("shape",{prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:null}}),C(i)&&(this.upperContext.clearRect(0,0,o.lowerCanvas.width,o.lowerCanvas.height),this.lowerContext.clearRect(0,0,o.lowerCanvas.width,o.lowerCanvas.height)),e?this.setTransformColl(this.lowerContext,"initial"):(o.transform.zoomFactor!==0&&(this.isRotateZoom=!0),this.updateCurrTransState("initial",null,null,r)),o.notify("transform",{prop:"setDestPointsForFlipState",onPropertyChange:!1}),this.drawImage(),o.notify("transform",{prop:"setDestPointsForFlipState",onPropertyChange:!1}),e?this.setTransformColl(this.lowerContext,"reverse"):(this.updateCurrTransState("reverse",null,null,r),this.isRotateZoom=!1),t?o.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}):o.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"iterate",pen:"iterate",isPreventApply:null}}),this.clearOuterCanvas(this.lowerContext),(o.isCircleCrop||o.currSelectionPoint&&o.currSelectionPoint.shape==="crop-circle")&&o.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}})},d.prototype.imageOnLoad=function(e){var i=this,t=this.parent,r=this;t.baseImg.src=e,t.baseImg.onload=function(){t.imgSrc=e,t.isUndoRedo||t.notify("filter",{prop:"update-finetunes",onPropertyChange:!1}),r.lowerContext.drawImage(t.baseImg,0,0,r.parent.lowerCanvas.width,r.parent.lowerCanvas.height);var o=!1,a=!1;if(t.isImageUpdated){var n=t.img,s=n.srcWidth,l=n.srcHeight,p=t.baseImgCanvas,h=p.width,u=p.height;o=s!==h||l!==u,a=t.baseImg.width===h&&t.baseImg.height===u}re(t.element),t.element.style.opacity="1",r.updateBaseImgCanvas();var c={fileName:i.fileName,fileType:i.fileType,isValidImage:!0};if(r.updateCanvas(o,a),t.currObjType.isUndoZoom&&(t.currObjType.isUndoZoom=!1,r.parent.lowerCanvas.style.display="block"),t.isUndoRedo=i.isErrorImage=!1,w.isDevice){t.notify("toolbar",{prop:"destroy-top-toolbar",onPropertyChange:!1}),t.notify("toolbar",{prop:"destroy-bottom-toolbar",onPropertyChange:!1});var g={isApplyBtn:!1,isDevice:w.isDevice,isOkBtn:null,isResize:null,isFrame:null,isMainToolbar:!0};t.notify("toolbar",{prop:"init-main-toolbar",onPropertyChange:!1,value:g}),t.notify("toolbar",{prop:"create-bottom-toolbar",onPropertyChange:!1})}else{t.notify("toolbar",{prop:"destroy-top-toolbar",onPropertyChange:!1});var g={isApplyBtn:!1,isDevice:!1,isOkBtn:null};t.notify("toolbar",{prop:"init-main-toolbar",onPropertyChange:!1,value:g})}if(t.isImageLoaded&&t.element.style.opacity!=="0.5"){t.trigger("fileOpened",c);var v={action:"file-open",actionEventArgs:c};t.triggerEditCompleteEvent(v)}},t.baseImg.onerror=function(){re(t.element),r.isErrorImage=!0,r.errorLoading()}},d.prototype.errorLoading=function(){var e=this.parent,i={fileName:null,fileType:null,isValidImage:!1};e.trigger("fileOpened",i)},d.prototype.updateBaseImgCanvas=function(){var e=this.parent;e.baseImgCanvas.width=e.baseImg.width,e.baseImgCanvas.height=e.baseImg.height,e.baseImgCanvas.getContext("2d").drawImage(e.baseImg,0,0)},d.prototype.updateCanvas=function(e,i){var t=this.parent;!t.isImageUpdated||!e?(t.img.srcWidth=t.baseImgCanvas.width,t.img.srcHeight=t.baseImgCanvas.height):!i&&e&&(t.img.srcLeft=0,t.img.srcTop=0,t.img.srcWidth=t.baseImgCanvas.width,t.img.srcHeight=t.baseImgCanvas.height,t.currSelectionPoint=null,t.cropObj={cropZoom:0,defaultZoom:0,totalPannedPoint:{x:0,y:0},totalPannedClientPoint:{x:0,y:0},totalPannedInternalPoint:{x:0,y:0},tempFlipPanPoint:{x:0,y:0},activeObj:{},rotateFlipColl:[],degree:0,currFlipState:"",straighten:0,destPoints:{startX:0,startY:0,width:0,height:0},srcPoints:{startX:0,startY:0,width:0,height:0},filter:"",isBrightAdjust:!1,zoomFactor:0,previousZoomValue:0,aspectWidth:null,aspectHeight:null,frame:"none",straightenZoom:0,adjustmentLevel:{brightness:0,contrast:0,hue:0,opacity:100,saturation:0,blur:0,exposure:0,transparency:100,sharpen:!1,bw:!1},currentFilter:""});var r={width:0,height:0};t.notify("transform",{prop:"calcMaxDimension",onPropertyChange:!1,value:{width:t.img.srcWidth,height:t.img.srcHeight,obj:r,isImgShape:null}});var o=r;t.img.destLeft=(t.lowerCanvas.clientWidth-o.width)/2,t.img.destTop=(t.lowerCanvas.clientHeight-o.height+1)/2,this.drawImgToCanvas(o),this.origDim.width=t.img.destWidth,this.origDim.height=t.img.destHeight,this.zoomCrop.width=t.img.destWidth,this.zoomCrop.height=t.img.destHeight,t.notify("transform",{prop:"setCropDimension",onPropertyChange:!1,value:{width:t.img.destWidth,height:t.img.destHeight}});var a={startX:t.img.destLeft,startY:t.img.destTop,width:t.img.destWidth,height:t.img.destHeight};t.notify("crop",{prop:"setCropDestPoints",onPropertyChange:!1,value:{point:a}});var n=this.lowerContext.filter;this.lowerContext.filter="none",t.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"iterate",pen:"zoom",isPreventApply:null}}),this.lowerContext.filter=n,t.img.destWidth>0&&t.img.destHeight>0&&(t.isImageLoaded=!0),t.isUndoRedo&&t.transform.currFlipState!==""&&t.notify("transform",{prop:"flipImage",onPropertyChange:!1,value:{direction:t.toPascalCase(t.transform.currFlipState)}}),t.disabled&&t.element.setAttribute("class","e-disabled"),(t.zoomSettings.zoomFactor!==1||t.zoomSettings.zoomPoint)&&t.zoom(t.zoomSettings.zoomFactor,t.zoomSettings.zoomPoint),C(this.initZoomValue)&&(this.initZoomValue=t.zoomSettings.zoomFactor),this.isImageEdited=!1},d.prototype.resetFrameZoom=function(e){var i=this.parent;if(!C(i.tempFrameZoomLevel)){var t=i.tempFrameZoomLevel;i.tempFrameZoomLevel=null,i.notify("transform",{prop:"resetZoom",onPropertyChange:!1}),i.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:t,zoomPoint:null,isResize:!0}});var r=i.cancelCropSelection;e&&r&&(r.previousObj.frameObj=f({},i.frameObj,null,!0),r.currentObj.frameObj=f({},i.frameObj,null,!0),r.previousObj.frame=r.currentObj.frame=i.frameObj.type),this.updateCropSelObj(),i.cancelCropSelection=null}},d.prototype.performCancel=function(e,i,t){var r=this.parent;t&&(r.noPushUndo=!1);var o={bool:r.isStraightening};e=e||!1;var a={bool:!1};r.allowDownScale=!0,r.notify("selection",{prop:"getFreehandDrawEditing",onPropertyChange:!1,value:{obj:a}}),C(i)&&JSON.stringify(r.frameObj)!==JSON.stringify(r.tempFrameObj)&&(f(r.frameObj,r.tempFrameObj),this.renderImage(null,null,!0)),this.resetFrameZoom(!1);var n={action:""};if(a.bool)n.action="freehand-draw",r.notify("freehand-draw",{prop:"cancelFhd",onPropertyChange:!1}),r.notify("toolbar",{prop:"destroy-qa-toolbar",onPropertyChange:!1}),r.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}});else if(r.textArea.style.display==="block"||r.textArea.style.display==="inline-block")n.action="text-editing",r.textArea.style.display="none",r.textArea.value="",r.textArea.style.transform="",this.prevActObj?(r.activeObj=this.prevActObj,this.prevActObj=null):(r.activeObj.strokeSettings=this.tempStrokeSettings,r.activeObj.textSettings=this.tempTextSettings),r.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"cancel"}}),this.isShapeTextInserted&&r.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),r.notify("shape",{prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:!0}}),r.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1}),r.notify("selection",{prop:"setTempActObj",onPropertyChange:!1,value:{obj:r.activeObj}}),r.drawingShape&&r.enableShapeDrawing(r.toPascalCase(r.drawingShape),!0);else if((!r.activeObj.shape||r.activeObj.shape!=="redact")&&((!w.isDevice||w.isDevice&&!o.bool)&&document.querySelector("#"+r.element.id+"_sliderWrapper")||r.currObjType.isFiltered)){n.action=r.isFinetuneBtnClick?"fine-tune":"filter",this.lowerContext.filter=this.tempAdjValue,r.canvasFilter=this.tempAdjValue,r.notify("filter",{prop:"setAdjustmentValue",onPropertyChange:!1,value:{adjustmentValue:this.tempAdjValue}}),r.initialAdjustmentValue=this.tempAdjValue,this.lowerContext.filter.split(" ").length>1&&this.lowerContext.filter.split(" ")[0].split("(")[1].split(")")[0]==="1"&&r.notify("filter",{prop:"setBrightnessAdjusted",onPropertyChange:!1,value:{isBrightnessAdjusted:!1}}),r.currentFilter=this.tempFilter,r.notify("filter",{prop:"setBevelFilter",onPropertyChange:!1,value:{bevelFilter:this.lowerContext.filter}}),this.lowerContext.clearRect(0,0,r.lowerCanvas.width,r.lowerCanvas.height),this.redrawImgWithObj(),r.currObjType.isFiltered=!1;var s={tempAdjustmentLevel:null};r.notify("filter",{prop:"getTempAdjustmentLevel",onPropertyChange:!1,value:{obj:s}}),r.notify("filter",{prop:"setAdjustmentLevel",onPropertyChange:!1,value:{adjustmentLevel:f({},s.tempAdjustmentLevel,{},!0)}}),r.notify("undo-redo",{prop:"setUndoRedoStep",onPropertyChange:!1,value:{step:this.tempUndoRedoStep}}),r.upperCanvas.style.cursor=r.cursor="default",r.currObjType.isCustomCrop=!1,this.tempStrokeSettings={strokeColor:"#fff",fillColor:"",strokeWidth:null,radius:null,outlineColor:"",outlineWidth:null},this.clearOuterCanvas(this.lowerContext),(r.currSelectionPoint&&r.currSelectionPoint.shape==="crop-circle"||r.isCircleCrop)&&r.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}});var l={type:"main",isApplyBtn:null,isCropping:null,isZooming:null};r.element.querySelector(".e-contextual-toolbar-wrapper").classList.add("e-hide"),r.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:l}),r.activeObj.shape&&r.activeObj.shape==="image"&&r.notify("toolbar",{prop:"destroy-qa-toolbar",onPropertyChange:!1}),r.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"cancel"}}),r.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,r.upperCanvas.width,r.upperCanvas.height),r.drawingShape&&(r.drawingShape=null,r.notify("selection",{prop:"setCurrentDrawingShape",onPropertyChange:!1,value:{value:""}}))}else if((!r.activeObj.shape||r.activeObj.shape!=="redact")&&e&&(!w.isDevice||w.isDevice&&!o.bool)){var l={type:"main",isApplyBtn:null,isCropping:null,isZooming:null};r.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:l})}else this.cancelItems(n),r.transform.zoomFactor>0?(r.togglePan=!0,r.notify("selection",{prop:"setDragCanvas",value:{bool:!0}})):(r.togglePan=!1,r.notify("selection",{prop:"setDragCanvas",value:{bool:!1}}));this.isShapeTextInserted=!1,this.isNewPath=!1,r.notify("toolbar",{prop:"refresh-dropdown-btn",value:{isDisabled:!1}}),r.notify("toolbar",{prop:"setCurrentToolbar",value:{type:"main"}}),t&&(r.noPushUndo=!1),r.drawingShape=null,r.notify("draw",{prop:"resetTempObjColl"}),r.notify("draw",{prop:"resetTempPointColl"}),r.isMaskImage=r.isFinetuneBtnClick=!1;var p={action:"cancel",actionEventArgs:n};r.triggerEditCompleteEvent(p)},d.prototype.cancelItems=function(e){var i=this.parent,t=!1,r=i.element.id,o=i.element.querySelector("#"+r+"_aspectratio"),a=i.element.querySelector("#"+r+"_nonaspectratio"),n,s=["rectangle","ellipse","line","arrow","path","image","redact"];if(i.activeObj.shape!==void 0&&(n=i.activeObj.shape.split("-")),(n===void 0&&i.currObjType.isCustomCrop||n!==void 0&&n[0]==="crop")&&(t=!0),t&&i.isCropTab&&(i.isCropTab=!1,i.transform.zoomFactor=i.transform.defaultZoomFactor),i.isResize&&(o||a||i.currentToolbar==="resize-toolbar")){e.action="resize";var l={width:null,height:null};i.notify("selection",{prop:"getNumTextValue",onPropertyChange:!1,value:{obj:l}});var p={x:l.width,y:l.height},h=i.element.querySelector("#"+i.element.id+"_aspectratio"),u=i.element.querySelector(".e-ie-toolbar-aspect-ratio-btn");if(p&&p.x&&p.y&&!C(i.aspectWidth))if(h||u&&!u.classList.contains("e-hidden"))i.notify("transform",{prop:"resizeImage",value:{width:i.aspectWidth,height:i.aspectHeight}});else{var c=i.currObjType.isUndoAction;i.currObjType.isUndoAction=!1,i.notify("transform",{prop:"resizeCrop",value:{width:i.aspectWidth,height:i.aspectHeight}}),i.currObjType.isUndoAction=c}var g={prevCropObj:i.prevCropObj},v={prevObj:i.prevObj};if(i.notify("toolbar",{prop:"getPrevCropObj",onPropertyChange:!1,value:{obj:g}}),i.notify("toolbar",{prop:"getPrevObj",onPropertyChange:!1,value:{obj:v}}),g.prevCropObj&&v.prevObj){i.objColl=[],i.pointColl=[],i.freehandCounter=0,i.cropObj=f({},g.prevCropObj,{},!0),this.setCurrentObj(v.prevObj),i.objColl=v.prevObj.objColl,i.pointColl=v.prevObj.pointColl,i.freehandCounter=i.pointColl.length,i.transform.straighten=0,i.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}});var b=i.currSelectionPoint?f({},i.currSelectionPoint,{},!0):null;i.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-i.transform.zoomFactor,zoomPoint:null,isResize:!0}}),i.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:v.prevObj.defaultZoom,zoomPoint:null,isResize:!0}}),i.currSelectionPoint=b,v.prevObj.zoomFactor&&i.setProperties({zoomSettings:{zoomFactor:v.prevObj.zoomFactor}},!0),i.notify("transform",{prop:"setPreviousZoomValue",onPropertyChange:!1,value:{previousZoomValue:i.zoomSettings.zoomFactor}})}i.isResize=!1,i.notify("transform",{prop:"setResizedImgAngle",onPropertyChange:!1,value:{angle:null}});var m=i.isCropTab;i.isCropTab=!1,this.updateCropSelObj(),i.cancelCropSelection=null,i.isCropTab=m}switch(!0){case i.togglePen:e.action="freehand-draw",this.cancelPen();break;case i.activeObj.shape==="text":e.action="text",this.cancelText();break;case s.indexOf(i.activeObj.shape)!==-1:e.action=i.activeObj.shape,this.cancelShape(),i.currObjType.isRedact=!1;break;case t:e.action="crop-selection",this.cancelSelection();break;default:i.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,i.upperCanvas.width,i.upperCanvas.height),i.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"cancel"}});break}i.notify("selection",{prop:"setCurrentDrawingShape",onPropertyChange:!1,value:{value:""}}),i.upperCanvas.style.cursor=i.cursor="default",i.currObjType.isCustomCrop=!1,this.tempStrokeSettings={strokeColor:"#fff",fillColor:"",strokeWidth:null,radius:null,outlineColor:"",outlineWidth:null};var y={type:"main",isApplyBtn:null,isCropping:!1,isZooming:null};i.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:y})},d.prototype.cancelPen=function(){var e=this.parent;this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),e.togglePen=!1,e.upperCanvas.style.cursor=e.cursor="default";var i=f([],e.pointColl,[],!0);e.pointColl={};for(var t=0;t<this.tempFreehandCounter;t++)e.pointColl[t]=i[t];e.freehandCounter=this.tempFreehandCounter,e.notify("freehand-draw",{prop:"setCurrentFreehandDrawIndex",value:{value:this.tempCurrFhdIndex}}),e.activeObj.strokeSettings=this.tempStrokeSettings,e.notify("shape",{prop:"setStrokeSettings",value:{strokeSettings:e.activeObj.strokeSettings,strokeColor:null,fillColor:null,strokeWidth:null,radius:null}}),e.notify("freehand-draw",{prop:"setPenStrokeWidth",onPropertyChange:!1,value:{value:this.tempStrokeWidth}}),e.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"cancel"}}),e.notify("selection",{prop:"setFreehandDrawCustomized",value:{isFreehandDrawCustomized:!1}}),e.objColl=f([],this.tempObjColl,[],!0),e.pointColl=f([],this.tempPointColl,[],!0),e.freehandCounter=e.pointColl.length,this.tempPointColl={},this.renderImage(),e.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok",isCancel:!0}})},d.prototype.cancelText=function(){var e=this.parent;if(e.notify("shape",{prop:"setTextSettings",onPropertyChange:!1,value:{textSettings:this.tempTextSettings,fontFamily:null,fontSize:null}}),e.notify("shape",{prop:"setStrokeSettings",value:{strokeSettings:this.tempStrokeSettings,strokeColor:null,fillColor:null,strokeWidth:null,radius:null}}),C(e.activeObj.currIndex))e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height);else{var i={appliedUndoRedoColl:[]};e.notify("undo-redo",{prop:"getAppliedUndoRedoColl",value:{obj:i}});var t=i.appliedUndoRedoColl.length,r=i.appliedUndoRedoColl[t-1];this.prevActObj&&r&&r.currentObjColl.length&&r.currentObjColl[r.currentObjColl.length-1].currIndex===this.prevActObj.currIndex?(e.activeObj=this.prevActObj,this.prevActObj=null):(e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height))}e.notify("toolbar",{prop:"destroy-qa-toolbar",onPropertyChange:!1}),this.tempTextSettings={text:"Enter Text",fontFamily:e.fontFamily.default,fontSize:null,fontRatio:null,bold:!1,italic:!1,underline:!1},e.objColl=f([],this.tempObjColl,[],!0),e.pointColl=f([],this.tempPointColl,[],!0),this.renderImage(),this.tempObjColl=[],e.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok",isCancel:!0}})},d.prototype.cancelShape=function(){var e=this.parent;if(e.notify("shape",{prop:"setStrokeSettings",value:{strokeSettings:this.tempStrokeSettings,strokeColor:null,fillColor:null,strokeWidth:null,radius:null}}),C(e.activeObj.currIndex))e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height);else if(this.isNewPath)e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),this.renderImage();else{var i={appliedUndoRedoColl:[]};e.notify("undo-redo",{prop:"getAppliedUndoRedoColl",value:{obj:i}});for(var t=void 0,r=0,o=i.appliedUndoRedoColl.length;r<o;r++)for(var a=i.appliedUndoRedoColl[r].currentObjColl,n=0,s=a.length;n<s;n++)if(this.prevActObj&&this.prevActObj.currIndex&&a[n].currIndex===this.prevActObj.currIndex){t=a[0];break}this.prevActObj&&t?(e.activeObj=this.prevActObj,this.prevActObj=null,e.notify("selection",{prop:"redrawShape",onPropertyChange:!1,value:{obj:e.activeObj}}),e.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"cancel"}}),e.notify("shape",{prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:!0}})):(e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height));var l={undoRedoStep:null};e.notify("undo-redo",{prop:"getUndoRedoStep",value:{obj:l}}),i.appliedUndoRedoColl[l.undoRedoStep-1]?e.objColl=f([],i.appliedUndoRedoColl[l.undoRedoStep-1].currentObjColl,[],!0):e.objColl=[],this.renderImage()}e.currObjType.isDragging=!1,e.notify("toolbar",{prop:"destroy-qa-toolbar",onPropertyChange:!1}),e.objColl=f([],this.tempObjColl,[],!0),e.pointColl=f([],this.tempPointColl,[],!0),this.renderImage(),this.tempObjColl=[],e.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok",isCancel:!0}})},d.prototype.cancelSelection=function(){var e=this.parent;if(e.cancelCropSelection){var i={value:e.tempStraighten};e.transform.straighten=i.value,e.straightenBaseImageCanvas(),e.notify("freehand-draw",{prop:"resetStraightenPoint"}),e.notify("draw",{prop:"render-image",value:{isMouseWheel:!1}}),e.notify("draw",{prop:"setStraightenActObj",value:{activeObj:e.activeObj}}),e.notify("crop",{prop:"resizeWrapper"}),this.updateCropSelObj(),this.tempStraightenDestPoints&&JSON.stringify(this.tempStraightenDestPoints)!==JSON.stringify(this.straightenDestPoints)&&(this.straightenDestPoints=f({},this.tempStraightenDestPoints,{},!0))}},d.prototype.updateCropSelObj=function(){var e=this.parent;e.cancelCropSelection&&(e.cropObj=f({},e.cancelCropSelection.previousCropObj,{},!0),e.afterCropActions=e.cancelCropSelection.previousObj.afterCropActions,e.notify("undo-redo",{prop:"undoDefault",onPropertyChange:!1,value:{obj:e.cancelCropSelection}}),e.currSelectionPoint=f({},e.cancelCropSelection.previousCropObj.activeObj,!0),e.currSelectionPoint&&C(e.currSelectionPoint.shape)&&(e.currSelectionPoint=null),this.clearOuterCanvas(this.lowerContext),(e.isCircleCrop||e.currSelectionPoint&&e.currSelectionPoint.shape==="crop-circle")&&e.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}))},d.prototype.updateCropSelection=function(){var e=this.parent,i={currObj:{}};e.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:i}});var t=i.currObj;t.objColl=f([],e.objColl,[],!0),t.pointColl=f([],e.pointColl,[],!0),t.afterCropActions=f([],e.afterCropActions,[],!0);var r={selPointColl:null};e.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:r}}),t.selPointColl=f([],r.selPointColl,[],!0),e.cancelCropSelection={operation:"cropTransform",previousObj:t,currentObj:t,previousObjColl:t.objColl,currentObjColl:t.objColl,previousPointColl:t.pointColl,currentPointColl:t.pointColl,previousSelPointColl:t.selPointColl,currentSelPointColl:t.selPointColl,previousCropObj:f({},e.cropObj,{},!0),currentCropObj:f({},e.cropObj,{},!0),previousText:null,currentText:null,filter:null,isCircleCrop:e.isCircleCrop}},d.prototype.updateFlipPan=function(e){var i=this.parent;if(i.transform.currFlipState!==""){var t=this.lowerContext.filter;i.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),i.notify("transform",{prop:"rotatedFlip",onPropertyChange:!1}),this.lowerContext.filter="none",i.notify("freehand-draw",{prop:"freehandRedraw",onPropertyChange:!1,value:{context:this.lowerContext,points:null}}),this.lowerContext.filter=t,this.upperContext.clearRect(0,0,i.upperCanvas.width,i.upperCanvas.height),e&&this.drawObject("duplicate",e)}},d.prototype.select=function(e,i,t,r,o){var a=this.parent;if(e=e.toLowerCase(),!a.disabled&&a.isImageLoaded){a.allowDownScale=!1;var n={currObj:{}};a.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:n}});var s=n.currObj;s.objColl=f([],a.objColl,[],!0),s.pointColl=f([],a.pointColl,[],!0),s.afterCropActions=a.afterCropActions;var l={selPointColl:null};a.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:l}}),s.selPointColl=f([],l.selPointColl,[],!0),a.notify("crop",{prop:"setPreviousCropCurrentObj",onPropertyChange:!1,value:{obj:s}}),a.transform.zoomFactor>0&&a.activeObj.shape&&a.activeObj.shape.split("-")[0]==="crop"&&C(this.currSelPoint)&&(this.currSelPoint=f({},a.activeObj,{},!0));var p=!1,h=void 0;a.activeObj.shape!==void 0&&(h=a.activeObj.shape.split("-")),(h===void 0&&a.currObjType.isCustomCrop||h!==void 0&&h[0]==="crop")&&(p=!0);var u={currObj:{}};a.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:u}});var c=u.currObj;if(c.objColl=f([],a.objColl,[],!0),c.pointColl=f([],a.pointColl,[],!0),c.afterCropActions=f([],a.afterCropActions,[],!0),a.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:null}}),a.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),a.notify("shape",{prop:"setKeyHistory",onPropertyChange:!1,value:{keyHistory:""}}),this.upperContext.clearRect(0,0,a.upperCanvas.width,a.upperCanvas.height),a.upperCanvas.style.display="block",a.currSelectionPoint||a.transform.defaultZoomFactor!==0||a.transform.degree!==0&&a.panPoint.totalPannedInternalPoint.x!==0&&a.panPoint.totalPannedInternalPoint.y!==0&&!p){if(a.isCircleCrop=!1,a.transform.defaultZoomFactor!==0&&!this.isResizeSelect){var g=a.isCropTab;a.isCropTab=!1,a.notify("transform",{prop:"resetZoom",onPropertyChange:!1}),a.isCropTab=g,this.resetPanPoints()}a.notify("freehand-draw",{prop:"updateFHDColl",onPropertyChange:!1}),a.isCropTab=!0,a.isCircleCrop=!1,this.isResizeSelect||a.notify("crop",{prop:"setCurrSelPoints",onPropertyChange:!1,value:{isSetDimension:!0}}),a.transform.zoomFactor=a.transform.cropZoomFactor,C(a.cropObj.activeObj.shape)&&(a.currObjType.shape="crop-"+e,this.drawNewSelection(e,i,t,r,o))}else this.isCropSelect?this.isCropSelect=!1:(a.notify("crop",{prop:"adjustStraightenForShapes",onPropertyChange:!1,value:{type:"reverse",isInitialRotated:!0}}),a.notify("freehand-draw",{prop:"updateFHDColl",onPropertyChange:!1}),this.renderImage()),e==="custom"&&(a.currObjType.shape=""),this.drawNewSelection(e,i,t,r,o)}},d.prototype.drawNewSelection=function(e,i,t,r,o){var a=this.parent,n,s="crop-"+e.toLowerCase();s==="crop-custom"?(a.currObjType.shape===""||a.currObjType.shape==="crop-custom")&&(this.drawCustomSelection("crop-custom",i,t,r,o),this.adjToStraighten(),this.updateSelectionInsert(),a.isStraightening&&(this.straightenActObj=f({},a.activeObj,{},!0),this.straightenInitZoom=a.transform.zoomFactor)):s==="crop-canvas"?(a.upperCanvas.style.display="block",a.notify("selection",{prop:"setDragCanvas",value:{bool:!0}})):(a.currObjType.isCustomCrop=!1,a.currObjType.shape=s,r&&o?n={startX:i,startY:t,endX:i+r,endY:t+o,width:r,height:o}:r&&s==="crop-circle"&&(n={startX:i,startY:t,endX:i+r,endY:t+r,width:r,height:r}),a.activeObj.shape=s,this.updateSelectionInsert(n))},d.prototype.updateSelectionInsert=function(e){var i=this.parent,t=i.activeObj.activePoint,r={shapeSettingsObj:{}};i.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:r}});var o={type:i.getSelectionType(r.shapeSettingsObj.type),startX:r.shapeSettingsObj.startX,startY:r.shapeSettingsObj.startY,width:r.shapeSettingsObj.width,height:r.shapeSettingsObj.height},a={action:"insert",previousSelectionSettings:o,currentSelectionSettings:o};i.trigger("selectionChanging",a),i.editCompleteArgs=a,i.notify("shape",{prop:"updSelChangeEventArgs",onPropertyChange:!1,value:{selectionSettings:a.currentSelectionSettings}}),a.currentSelectionSettings.type==="Custom"?this.drawObject("duplicate",i.activeObj,null,null,!0):((t.startX!==0||t.startY!==0||t.width!==0||t.height!==0)&&(e={startX:t.startX,startY:t.startY,endX:t.endX,endY:t.endY,width:t.width,height:t.height}),this.drawObject("duplicate",null,!0,e))},d.prototype.drawCustomSelection=function(e,i,t,r,o){var a=this.parent,n=a.activeObj.activePoint;if(a.currObjType.isCustomCrop=!0,this.upperContext.clearRect(0,0,a.upperCanvas.width,a.upperCanvas.height),a.currObjType.shape=a.activeObj.shape=e.toLowerCase(),!C(i)&&!C(t)&&!C(r)&&!C(o))n.startX=i,n.startY=t,n.endX=i+r,n.endY=t+o,n.width=r,n.height=o;else if(r&&o){var s=a.img,l=s.destLeft,p=s.destTop,h=s.destWidth,u=s.destHeight;n.width=r,n.height=o,n.startX=l+(h/2-r/2),n.startY=p+(u/2-o/2)}else{if(C(a.transform.zoomFactor)||a.transform.zoomFactor===0){var c=a.img,g=c.destLeft,v=c.destTop,b=c.destWidth,m=c.destHeight,y=a.lowerCanvas.width,P=a.lowerCanvas.height,S=n;g>=0&&v>=0?(S.startX=g,S.startY=v,S.endX=g+b,S.endY=v+m):g>=0?(S.startX=g,S.startY=7.5,S.endX=g+b,S.endY=P-15):v>=0?(S.startX=7.5,S.startY=v,S.endX=y-15,S.endY=v+m):(S.startX=7.5,S.startY=7.5,S.endX=y-15,S.endY=P-15)}else{var O=a.img,j=O.destLeft,x=O.destTop,k=O.destWidth,T=O.destHeight,A=a.lowerCanvas.width,L=a.lowerCanvas.height,H=n;H.startX=Math.max(j>0?j:7.5,j),H.startY=Math.max(x>0?x:7.5,x),H.endX=Math.min(j+k+15<A?j+k-15:A-15,j+k),H.endY=Math.min(x+T+15<L?x+T-15:L-15,x+T)}var B=a.img,l=B.destLeft,p=B.destTop,h=B.destWidth,u=B.destHeight,D=a.lowerCanvas.clientWidth,E=a.lowerCanvas.clientHeight,R=n;if(R.startX=Math.max(R.startX,l),R.startY=Math.max(R.startY,p),R.endX=Math.min(R.endX,l+h),R.endY=Math.min(R.endY,p+u),a.transform.straighten>0?(this.imgCanvasPoints[0].x>R.startX&&(R.startX=this.imgCanvasPoints[0].x),this.imgCanvasPoints[0].y>R.startY&&(R.startY=this.imgCanvasPoints[0].y),this.imgCanvasPoints[2].x<R.endX&&(R.endX=this.imgCanvasPoints[2].x),this.imgCanvasPoints[2].y<R.endY&&(R.endY=this.imgCanvasPoints[2].x)):a.transform.straighten<0&&(this.imgCanvasPoints[3].x>R.startX&&(R.startX=this.imgCanvasPoints[3].x),this.imgCanvasPoints[3].y<R.startY&&(R.startY=this.imgCanvasPoints[3].y),this.imgCanvasPoints[1].x<R.endX&&(R.endX=this.imgCanvasPoints[1].x),this.imgCanvasPoints[1].y>R.endY&&(R.endY=this.imgCanvasPoints[1].x)),R.startX===l&&l+h>D&&(R.endX=D-15),R.startY===p&&p+u>E&&(R.endY=E-15),a.activeObj.activePoint.startX>a.activeObj.activePoint.endX){var Q=a.activeObj.activePoint.startX;a.activeObj.activePoint.startX=a.activeObj.activePoint.endX,a.activeObj.activePoint.endX=Q}if(a.activeObj.activePoint.startY>a.activeObj.activePoint.endY){var Q=a.activeObj.activePoint.startY;a.activeObj.activePoint.startY=a.activeObj.activePoint.endY,a.activeObj.activePoint.endY=Q}a.activeObj=this.updateWidthHeight(a.activeObj),this.updateActiveObject(n,a.activeObj),this.adjActObj()}this.updateSelectionInsert()},d.prototype.adjToStraighten=function(){var e=this.parent;if(e.transform.straighten!==0&&e.isStraightening){var i=e.activeObj.activePoint;i.startX+=7.5,i.startY+=7.5,i.endX-=7.5,i.endY-=7.5,e.activeObj=this.updateWidthHeight(e.activeObj)}},d.prototype.adjActObj=function(){var e=this.parent;if(e.transform.straighten!==0)for(var i=e.activeObj.activePoint,t=f({},i,{},!0),r=0;;){r++;var o={isIntersect:null,arr:null};if(e.notify("draw",{prop:"updateImgCanvasPoints",onPropertyChange:!1}),e.notify("draw",{prop:"isLinesIntersect",onPropertyChange:!1,value:{obj:o}}),o.arr[0]||o.arr[1]||o.arr[2]||o.arr[3]||r===100){i=f({},t,{},!0);break}t=f({},i,{},!0),i.startX-=5,i.endX+=5,i.width=i.endX-i.startX,this.updateActiveObject(i,e.activeObj)}},d.prototype.callUpdateCurrTransState=function(){var e=this.parent,i=f([],e.objColl,[],!0),t=f({},e.activeObj,{},!0);e.objColl=[],e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.isRotateZoom=!0,this.updateCurrTransState("initial"),this.lowerContext.clearRect(0,0,e.lowerCanvas.width,e.lowerCanvas.height),e.transform.degree===0&&e.rotateFlipColl.length>0&&(e.img.destLeft+=e.panPoint.totalPannedPoint.x,e.img.destTop+=e.panPoint.totalPannedPoint.y),e.img.destLeft+=e.panPoint.totalPannedInternalPoint.x,e.img.destTop+=e.panPoint.totalPannedInternalPoint.y;var r=this.lowerContext.filter;e.transform.degree===0&&e.notify("transform",{prop:"setDestPointsForFlipState",onPropertyChange:!1}),this.drawImage(),this.updateCurrTransState("reverse"),e.transform.degree===0&&e.rotateFlipColl.length>0&&(e.img.destLeft+=e.panPoint.totalPannedPoint.x,e.img.destTop+=e.panPoint.totalPannedPoint.y),this.isRotateZoom=!1,e.objColl=i;var o=e.togglePen;e.togglePen=!1,this.lowerContext.filter="none";var a={penStrokeWidth:null};e.notify("freehand-draw",{prop:"getPenStrokeWidth",onPropertyChange:!1,value:{obj:a}}),e.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"iterate",pen:"iterate",isPreventApply:null}}),e.notify("freehand-draw",{prop:"setPenStrokeWidth",onPropertyChange:!1,value:{value:a.penStrokeWidth}}),e.img.destLeft+=e.panPoint.totalPannedInternalPoint.x,e.img.destTop+=e.panPoint.totalPannedInternalPoint.y,e.img.destLeft-=e.panPoint.totalPannedInternalPoint.x,e.img.destTop-=e.panPoint.totalPannedInternalPoint.y,e.togglePen=o,this.lowerContext.filter=r,e.activeObj=t},d.prototype.resetPanPoints=function(){this.parent.panPoint.totalPannedPoint={x:0,y:0},this.parent.panPoint.totalPannedClientPoint={x:0,y:0},this.parent.panPoint.totalPannedInternalPoint={x:0,y:0}},d.prototype.setClientTransDim=function(e){var i=this.parent;if(i.transform.degree%90===0&&i.transform.degree%180!==0){i.img.destLeft=(i.lowerCanvas.clientWidth-i.img.destHeight)/2,i.img.destTop=(i.lowerCanvas.clientHeight-i.img.destWidth+1)/2;var t=i.img.destWidth;i.img.destWidth=i.img.destHeight,i.img.destHeight=t}else C(e)&&(i.img.destLeft=(i.lowerCanvas.clientWidth-i.img.destWidth)/2,i.img.destTop=(i.lowerCanvas.clientHeight-i.img.destHeight+1)/2)},d.prototype.redrawImgWithObj=function(){var e=this.parent,i={canvasFilter:e.canvasFilter};if(this.lowerContext.filter=i.canvasFilter,e.rotateFlipColl.length!==0){var t=f({},e.panPoint.totalPannedInternalPoint,{},!0),r={startX:e.img.destLeft,startY:e.img.destTop,width:e.img.destWidth,height:e.img.destHeight};this.callUpdateCurrTransState(),e.panPoint.totalPannedInternalPoint=t,e.img.destLeft=r.startX,e.img.destTop=r.startY,e.img.destWidth=r.width,e.img.destHeight=r.height}else this.callUpdateCurrTransState();e.isCircleCrop&&e.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}})},d.prototype.setCurrentObj=function(e,i,t){var r=this.parent,o=!!e;o||(r.cropObj.aspectWidth=r.aspectWidth,r.cropObj.aspectHeight=r.aspectHeight,r.cropObj.frame=r.frameObj.type),e=e||r.cropObj,r.transform.cropZoomFactor=e.cropZoom,r.transform.defaultZoomFactor=e.defaultZoom,this.straightenInitZoom=e.straightenZoom,o?e.activeObj.shape&&e.activeObj.shape.split("-")[0]==="crop"?r.transform.zoomFactor=e.cropZoom:r.transform.zoomFactor=e.defaultZoom:r.transform.zoomFactor=e.cropZoom,r.setProperties({zoomSettings:{zoomFactor:e.zoomFactor}},!0),r.notify("transform",{prop:"setPreviousZoomValue",onPropertyChange:!1,value:{previousZoomValue:e.previousZoomValue}}),r.panPoint.totalPannedPoint=f({},e.totalPannedPoint,{},!0),r.panPoint.totalPannedClientPoint=f({},e.totalPannedClientPoint,{},!0),r.panPoint.totalPannedInternalPoint=f({},e.totalPannedInternalPoint,{},!0);var a=f({},e.tempFlipPanPoint,{},!0);r.notify("crop",{prop:"setTempFlipPanPoint",onPropertyChange:!1,value:{point:a}}),r.rotateFlipColl=f([],e.rotateFlipColl,[],!0),r.transform.degree=e.degree,r.frameObj.type=e.frame,r.transform.currFlipState=e.currFlipState,r.notify("filter",{prop:"setAdjustmentLevel",onPropertyChange:!1,value:{adjustmentLevel:e.adjustmentLevel}}),r.notify("filter",{prop:"setTempAdjVal"}),r.currentFilter=e.currentFilter,r.notify("filter",{prop:"setTempFilVal"}),(r.transform.straighten!==e.straighten||i)&&(r.transform.straighten=e.straighten,r.straightenBaseImageCanvas()),r.img={destLeft:e.destPoints.startX,destTop:e.destPoints.startY,destWidth:e.destPoints.width,destHeight:e.destPoints.height,srcLeft:e.srcPoints.startX,srcTop:e.srcPoints.startY,srcWidth:e.srcPoints.width,srcHeight:e.srcPoints.height},r.aspectWidth=e.aspectWidth,r.aspectHeight=e.aspectHeight,e.afterCropActions&&(r.afterCropActions=e.afterCropActions),this.lowerContext.filter=e.filter,r.notify("filter",{prop:"setBrightnessAdjusted",onPropertyChange:!1,value:{isBrightnessAdjusted:e.isBrightAdjust}}),r.notify("draw",{prop:"imageBackgroundColor",onPropertyChange:!1,value:{color:e.bgColor}});var n=r.isCircleCrop,s;C(r.currSelectionPoint)?s=null:(s=f({},r.currSelectionPoint,{},!0),r.currSelectionPoint=null),r.isCircleCrop=!1,t&&(r.frameObj.type="none"),this.drawCropSelectionImage(e,!1),r.transform.degree!==0&&(r.transform.currFlipState===""?r.notify("transform",{prop:"rotatePan",onPropertyChange:!1,value:{isCropSelection:null,isDefaultZoom:null}}):r.notify("transform",{prop:"drawPannedImage",value:{xDiff:0,yDiff:0}}),r.img.destLeft=e.destPoints.startX,r.img.destTop=e.destPoints.startY,r.panPoint.totalPannedClientPoint=f({},e.totalPannedClientPoint,{},!0),r.panPoint.totalPannedInternalPoint=f({},e.totalPannedInternalPoint,{},!0)),r.activeObj=f({},e.activeObj,{},!0),this.upperContext.clearRect(0,0,r.upperCanvas.width,r.upperCanvas.height),r.activeObj.activePoint.width!==0&&r.activeObj.activePoint.height!==0&&this.drawObject("duplicate",null,null,null,!0);var l=f({},e.activeObj,{},!0),p=!1;if(r.afterCropActions.length>0){var h={collection:r.afterCropActions};r.notify("shape",{prop:"alignRotateFlipColl",onPropertyChange:!1,value:{collection:r.afterCropActions,isRotateFlipCollection:null,obj:h}}),r.afterCropActions=h.collection}var u=f([],r.afterCropActions,[],!0);if(!o&&u.length>0){p=!0;for(var c=0,g=u.length;c<g;c++)(u[c]==="horizontalflip"||u[c]==="verticalflip")&&(r.activeObj=f({},s,{},!0),this.rotatedFlipCropSel=!0),r.notify("transform",{prop:"updateTransform",onPropertyChange:!1,value:{text:u[c]}});l=f({},r.activeObj,{},!0),this.resetPanPoints(),r.activeObj=l,this.upperContext.clearRect(0,0,r.upperCanvas.width,r.upperCanvas.height),r.activeObj.activePoint.width!==0&&r.activeObj.activePoint.height!==0&&this.drawObject("duplicate",null,null,null,!0),e.degree!==r.transform.degree&&(r.transform.cropZoomFactor=null,r.transform.zoomFactor=0),r.notify("freehand-draw",{prop:"updateFHDColl",onPropertyChange:!1}),this.rotatedFlipCropSel&&(this.rotatedFlipCropSel=!1)}r.afterCropActions=u,!this.isCancelAction&&!p&&(r.notify("freehand-draw",{prop:"updateFHDColl",onPropertyChange:!1}),r.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),r.img.destLeft=e.destPoints.startX,r.img.destTop=e.destPoints.startY),r.activeObj=l,r.isCircleCrop=n,C(s)?r.currSelectionPoint=null:(r.currSelectionPoint=f({},s,{},!0),r.currSelectionPoint&&C(r.currSelectionPoint.shape)&&(r.currSelectionPoint=null))},d.prototype.drawCropSelectionImage=function(e,i){var t=this.parent,r=this.lowerContext.filter;t.clearContext(this.lowerContext),t.clearContext(this.upperContext),this.lowerContext.setTransform(1,0,0,1,0,0),i?this.updateCurrTransState("initial"):this.setTransformColl(this.lowerContext,"initial"),t.notify("transform",{prop:"setDestPointsForFlipState",onPropertyChange:!1}),this.drawImage(),i?this.updateCurrTransState("reverse"):this.setTransformColl(this.lowerContext,"reverse"),t.img.destLeft=t.cropObj.destPoints.startX,t.img.destTop=t.cropObj.destPoints.startY;var o=f({},e.activeObj,{},!0);if(this.lowerContext.filter="none",t.img={destLeft:e.destPoints.startX,destTop:e.destPoints.startY,destWidth:e.destPoints.width,destHeight:e.destPoints.height,srcLeft:e.srcPoints.startX,srcTop:e.srcPoints.startY,srcWidth:e.srcPoints.width,srcHeight:e.srcPoints.height},e.activeObj.activePoint.width!==0&&e.activeObj.activePoint.height!==0){var a={startX:t.img.destLeft,startY:t.img.destTop,width:t.img.destWidth,height:t.img.destHeight};t.img.destLeft=e.activeObj.activePoint.startX,t.img.destTop=e.activeObj.activePoint.startY,t.img.destWidth=e.activeObj.activePoint.width,t.img.destHeight=e.activeObj.activePoint.height,t.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),t.img.destLeft=a.startX,t.img.destTop=a.startY,t.img.destWidth=a.width,t.img.destHeight=a.height}t.activeObj=o,this.lowerContext.filter=r},d.prototype.performPointZoom=function(e,i,t,r,o){var a=this.parent,n=a.img,s=n.destLeft,l=n.destTop,p=n.destWidth,h=n.destHeight,u=!1;a.activeObj.shape&&a.activeObj.shape.indexOf("crop-")>-1&&(u=!0),a.element.querySelector(".e-contextual-toolbar-wrapper")&&!u&&(a.element.querySelector(".e-contextual-toolbar-wrapper").classList.contains("e-hide")||(a.okBtn(),a.element.querySelector(".e-contextual-toolbar-wrapper").classList.add("e-hide")));var c=(e-s)/p,g=(i-l)/h,v=a.isUndoRedo;a.isUndoRedo=!0,a.setProperties({zoomSettings:{zoomPoint:{x:e,y:i}}},!0);var b=o||(t==="zoomIn"?.1:-.1);a.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:b,zoomPoint:null,isResize:r}}),a.isUndoRedo=v,this.panToPoint(e,i,c,g)},d.prototype.panToPoint=function(e,i,t,r){var o=this.parent;if(o.transform.zoomFactor>0){var a=o.img.destLeft,n=o.img.destTop,s=f({},o.activeObj,{},!0);if(o.transform.degree===0)o.img.destLeft=e-t*o.img.destWidth,o.img.destTop=i-r*o.img.destHeight,this.drawZoomPanImage(o.img.destLeft-a,o.img.destTop-n);else{var l=o.isCropTab;o.isCropTab=!0;var p=f([],o.objColl,[],!0),h=f([],o.pointColl,[],!0),u={straightenPoint:null};o.notify("freehand-draw",{prop:"getStraightenPoint",onPropertyChange:!1,value:{obj:u}}),o.objColl=[],o.pointColl=[],o.freehandCounter=0,o.notify("freehand-draw",{prop:"setStraightenPoint",onPropertyChange:!1,value:{x:null,y:null,ratioX:null,ratioY:null}});var c={selPointColl:null};o.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:c}});var g=c.selPointColl;o.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:[]}}}),o.panPoint.currentPannedPoint={x:e-t*o.img.destWidth-a,y:i-r*o.img.destHeight-n},o.notify("transform",{prop:"rotatePan",onPropertyChange:!1,value:{isCropSelection:null,isDefaultZoom:null}}),o.isCropTab=l,o.objColl=p,o.pointColl=h,o.freehandCounter=o.pointColl.length,u.straightenPoint.x&&u.straightenPoint.y&&o.notify("freehand-draw",{prop:"setStraightenPoint",onPropertyChange:!1,value:{x:u.straightenPoint.x,y:u.straightenPoint.y,ratioX:u.straightenPoint.ratioX,ratioY:u.straightenPoint.ratioY}}),o.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:g}}}),o.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"pan",pen:"pan",x:o.panPoint.currentPannedPoint.x,y:o.panPoint.currentPannedPoint.y,panRegion:""}})}this.adjustPanning(s);for(var v=!1,b=0;b<o.objColl.length;b++)if(JSON.stringify(s.activePoint)===JSON.stringify(o.objColl[b].activePoint)){v=!0;break}v||(o.activeObj=s),o.activeObj.activePoint.width!==0&&o.activeObj.activePoint.height!==0&&this.drawObject("duplicate",null,null,null,!0)}},d.prototype.adjustPanning=function(e){var i=this.parent,t=e.activePoint,r=t.startX,o=t.startY,a=t.width,n=t.height;if(a!==0&&n!==0){var s=i.img,l=s.destLeft,p=s.destTop,h=s.destWidth,u=s.destHeight,c={x:0,y:0};if(l>r?c.x=l-r:l+h<r+a&&(c.x=l+h-(r+a)),p>o?c.y=p-o:p+u<o+n&&(c.y=p+u-(o+n)),i.transform.degree===0)i.img.destLeft-=c.x,i.img.destTop-=c.y,this.drawZoomPanImage(i.img.destLeft-l,i.img.destTop-p);else{var g=i.isCropTab;i.isCropTab=!0;var v=f([],i.objColl,[],!0),b=f([],i.pointColl,[],!0);i.objColl=[],i.pointColl=[],i.freehandCounter=0;var m={selPointColl:null};i.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:m}});var y=m.selPointColl;i.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:[]}}}),i.img.destLeft-=c.x,i.img.destTop-=c.y,i.panPoint.currentPannedPoint={x:i.img.destLeft-l,y:i.img.destTop-p},i.notify("transform",{prop:"rotatePan",onPropertyChange:!1,value:{isCropSelection:null,isDefaultZoom:null}}),i.isCropTab=g,i.objColl=v,i.pointColl=b,i.freehandCounter=i.pointColl.length,i.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:y}}}),i.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"pan",pen:"pan",x:i.panPoint.currentPannedPoint.x,y:i.panPoint.currentPannedPoint.y,panRegion:""}})}}},d.prototype.panToSel=function(){var e=this.parent,i=f({},e.activeObj,{},!0),t=i.activePoint,r=t.startX,o=t.startY,a=t.width,n=t.height;this.allowRedactStraighten=!0;var s={straightenPoint:null};if(e.notify("freehand-draw",{prop:"getStraightenPoint",onPropertyChange:!1,value:{obj:s}}),s.straightenPoint.x&&s.straightenPoint.y){var l=r+a/2-s.straightenPoint.x,p=o+n/2-s.straightenPoint.y;e.transform.degree===0?(e.img.destLeft+=l,e.img.destTop+=p,e.notify("transform",{prop:"drawPannImage",value:{point:{x:l,y:p}}})):(e.panPoint.currentPannedPoint={x:l,y:p},e.notify("transform",{prop:"drawPannedImage",value:{xDiff:l,yDiff:p}}),e.panPoint.currentPannedPoint={x:0,y:0},e.notify("transform",{prop:"setTempPanMove",value:{point:null}})),e.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:i}});var h=e.img,u=h.destLeft,c=h.destTop,g=h.destWidth,v=h.destHeight,b=this.imgCanvasPoints;b.forEach(function(P){P.x=P.ratioX*g+u,P.y=P.ratioY*v+c}),this.imgCanvasPoints=b;var m=0;if(e.transform.straighten===3&&!this.preventStraightening){this.preventStraightening=!0;var y=e.prevStraightenedDegree;e.prevStraightenedDegree=e.transform.straighten,e.setStraighten(0),e.setStraighten(3),e.prevStraightenedDegree=y,this.preventStraightening=!1}for(;this.isLinesIntersect()&&e.transform.straighten!==0&&e.transform.straighten!==360&&m<100;)m++,this.performPointZoom(e.activeObj.activePoint.startX+e.activeObj.activePoint.width/2,e.activeObj.activePoint.startY+e.activeObj.activePoint.height/2,"zoomIn",!1,.025),this.updateImgCanvasPoints()}},d.prototype.drawZoomPanImage=function(e,i){var t=this.parent;t.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"pan",pen:"pan",x:e,y:i,panRegion:""}}),this.renderImage(!0);var r={width:0,height:0};t.notify("transform",{prop:"calcMaxDimension",onPropertyChange:!1,value:{width:t.img.srcWidth,height:t.img.srcHeight,obj:r,isImgShape:null}});var o=r;o.width+=o.width*t.transform.zoomFactor,o.height+=o.height*t.transform.zoomFactor,t.panPoint.totalPannedPoint.x+=e,t.panPoint.totalPannedPoint.y+=i,t.notify("crop",{prop:"setTempFlipPanPoint",onPropertyChange:!1,value:{point:{x:0,y:0}}})},d.prototype.openNewImage=function(){var e=this,i=this.parent,t=i.element.id,r=i.inMemoryCanvas.getContext("2d");ue(i.element),i.element.style.opacity="0.5";var o=document.querySelector("#"+t+"_currPos");o&&(o.style.display="none");var a={defToolbarItems:null};if(i.notify("toolbar",{prop:"getDefToolbarItems",value:{obj:a}}),a.defToolbarItems&&a.defToolbarItems.length===0&&C(document.getElementById(t+"_toolbar"))&&i.element.querySelector("#"+t+"_toolbarArea")){var n=i.element.querySelector("#"+t+"_toolbarArea").clientHeight;i.notify("toolbar",{prop:"setToolbarHeight",value:{height:n}})}i.reset(),i.update(),i.transform.degree=0,i.transform.zoomFactor=0,i.isImageLoaded=!1,i.currSelectionPoint=null;var s=typeof this.openURL;if(s==="string"){var l=this.openURL.split(".");if(l.length>1?(l=l[l.length-2].split("/"),this.fileName=l[l.length-1]):this.fileName="ImageEditor",this.fileType=this.getFileExtensionFromURL(this.openURL),this.fileType){this.fileType=i.toPascalCase(this.fileType);var p=this.fileType.toLowerCase();(p==="jpg"||p==="jpeg")&&(this.fileType="Jpeg",p="jpeg"),p!=="jpeg"&&p!=="png"&&p!=="svg"&&p!=="webp"&&(this.fileType=null)}this.imageOnLoad(this.openURL),(typeof this.openURL!="string"||this.openURL.indexOf("localhost")===-1)&&this.getImageSizeFromURL(this.openURL.toString(),function(h){h!==null&&e.parent.notify("toolbar",{prop:"setInitialSize",value:{value:+h}})})}else this.fileName="ImageEditor",this.fileType=null,i.lowerCanvas=document.querySelector("#"+t+"_lowerCanvas"),i.upperCanvas=document.querySelector("#"+t+"_upperCanvas"),this.lowerContext=i.lowerCanvas.getContext("2d"),this.upperContext=i.upperCanvas.getContext("2d"),i.clearContext(this.lowerContext),i.clearContext(this.upperContext),i.clearContext(r),i.inMemoryCanvas.width=this.openURL.width,i.inMemoryCanvas.height=this.openURL.height,r.putImageData(this.openURL,0,0),i.baseImg.src=i.inMemoryCanvas.toDataURL()},d.prototype.getImageSizeFromURL=function(e,i){return ai(this,void 0,void 0,function(){var t,r,o,a;return ni(this,function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,fetch(e,{method:"HEAD"})];case 1:return t=n.sent(),r=parseInt(t.headers.get("content-length")||"0",10),o=r,i(o),[3,3];case 2:return a=n.sent(),console.log(a.message),[3,3];case 3:return[2]}})})},d.prototype.dlgBtnClick=function(){this.parent.export(),this.applyDialogOption()},d.prototype.dlgCloseBtnClick=function(){this.applyDialogOption()},d.prototype.applyDialogOption=function(){var e=this.parent;this.isFileChanged?(e.isImageLoaded=this.isFileChanged=!1,e.reset(),this.checkToolbarTemplate(this.inputElem,this.openURL)):(this.reset(),this.openNewImage()),F(document.getElementById(e.element.id+"_dialog"),"dialog").destroy(),this.isImageEdited=!1},d.prototype.showDialogPopup=function(){var e=this.parent,i={key:"ConfirmDialogHeader"};e.notify("toolbar",{prop:"getLocaleText",onPropertyChange:!1,value:{obj:i}});var t={key:"ConfirmDialogContent"};e.notify("toolbar",{prop:"getLocaleText",onPropertyChange:!1,value:{obj:t}});var r={key:"Yes"};e.notify("toolbar",{prop:"getLocaleText",onPropertyChange:!1,value:{obj:r}});var o={key:"No"};e.notify("toolbar",{prop:"getLocaleText",onPropertyChange:!1,value:{obj:o}}),e.element.querySelector("#"+e.element.id+"_dialog").style.display="block";var a=new Je({header:i.value,closeOnEscape:!0,content:"<span>"+t.value+"</span>",target:document.getElementById("target"),width:"285px",isModal:!0,animationSettings:{effect:"Zoom"},close:this.dlgCloseBtnClick.bind(this),buttons:[{click:this.dlgCloseBtnClick.bind(this),buttonModel:{content:o.value,iconCss:"e-icons e-close"}},{click:this.dlgBtnClick.bind(this),buttonModel:{content:r.value,isPrimary:!0,iconCss:"e-icons e-check"}}]});a.appendTo("#"+e.element.id+"_dialog")},d.prototype.restoreOldImage=function(){var e=this,i=this.parent,t=document.getElementById(this.parent.element.id+"_dropArea"),r=i.getExtensionArray(),o=typeof this.openURL;if(o!=="string"){this.openImageData(t);return}var a=this.getFileExtensionFromURL(this.openURL);a&&(a=a.toLowerCase(),a=a==="jpg"||a==="jpeg"?"jpeg":a);var n=(a?r.indexOf(a)>-1||a==="jpeg"&&(i.uploadSettings.allowedExtensions.indexOf("jpg")>-1||i.uploadSettings.allowedExtensions.indexOf("jpeg")>-1):!1)||this.isNullExtension;this.openURL.indexOf("data:image/")>-1&&this.openURL.indexOf("base64")>-1||this.openURL.indexOf("blob")>-1?this.openImageData(t,!0):i.uploadSettings.minFileSize||i.uploadSettings.maxFileSize?this.getImageSizeFromURL(this.openURL.toString(),function(s){var l=i.uploadSettings.minFileSize&&s<i.uploadSettings.minFileSize||i.uploadSettings.maxFileSize&&s>i.uploadSettings.maxFileSize;e.handleFileSize(!n||l,t,!n)}):this.handleFileSize(!n,t,!n)},d.prototype.handleFileSize=function(e,i,t){var r=this.parent;e?(this.errorLoading(),r.showDialogPopup("unsupported",t),i&&!r.isImageLoaded&&(i.style.display="block")):(i&&(i.style.display="none"),this.parent.isImageLoaded&&this.reset(),this.openNewImage())},d.prototype.openImageData=function(e,i){var t=this.parent,r=this,o=t.createElement("canvas"),a=o.getContext("2d");if(!t.uploadSettings.minFileSize&&!t.uploadSettings.maxFileSize){this.handleFileSize(!1,e,!1);return}if(i){var n=new Image;n.src=this.openURL,n.onload=function(){a.canvas.width=n.width,a.canvas.height=n.height,a.drawImage(n,0,0),r.getImageSize(o,e)}}else o.width=this.openURL.width,o.height=this.openURL.height,a.putImageData(this.openURL,0,0),this.getImageSize(o,e)},d.prototype.getImageSize=function(e,i){var t=this.parent;e.toBlob((function(r){t.uploadSettings.minFileSize&&r.size<t.uploadSettings.minFileSize||t.uploadSettings.maxFileSize&&r.size>t.uploadSettings.maxFileSize?this.handleFileSize(!0,i,!1):this.handleFileSize(!1,i,!1)}).bind(this),"image/jpeg",1)},d.prototype.open=function(e){this.parent.disabled||(this.openURL=e,this.restoreOldImage())},d.prototype.getInitialLoaded=function(e){e.isInitialLoaded=this.isInitialLoading},d.prototype.getFileExtensionFromURL=function(e){var i=e.lastIndexOf(".");return i!==-1?e.slice(i+1).toLowerCase():e.indexOf("base64")!==-1?e.slice(e.indexOf("/")+1,e.indexOf(";")).toLowerCase():null},d.prototype.fileSelect=function(e,i){var t=this.parent,r=document.getElementById(t.element.id+"_dropArea");if(r&&(r.style.display="none"),!t.disabled){var o=void 0,a=void 0;i.target?(o=i.target.files[0],a=o):o=a=i.filesData[0].rawFile;var n=void 0;if(a.name){var s=a.name.split(".");n=s[s.length-1].toLowerCase()}var l=t.getExtensionArray(),p=(n==="jpg"||n==="jpeg")&&(t.uploadSettings.allowedExtensions.indexOf("jpg")>-1||t.uploadSettings.allowedExtensions.indexOf("jpeg")>-1);if(n&&l.indexOf(n)===-1&&!p||t.uploadSettings.minFileSize&&a.size<t.uploadSettings.minFileSize||t.uploadSettings.maxFileSize&&a.size>t.uploadSettings.maxFileSize){this.errorLoading();return}if(ue(t.element),t.element.style.opacity="0.5",this.inputElem=e,n=a.name&&a.name.split(".")[1],n){var h=t.toPascalCase(n);h==="JPG"||h==="Jpg"?this.fileType="Jpeg":this.fileType=h}else this.fileType=null;var u=window.URL,c=u.createObjectURL(o);this.openURL=c,t.isImageLoaded&&!t.isChangesSaved&&(this.isImageEdited||t.pointColl.length>0||t.objColl.length>0)?(this.isFileChanged=!0,this.showDialogPopup()):this.checkToolbarTemplate(e,c)}},d.prototype.checkToolbarTemplate=function(e,i){var t=this.parent;C(t.toolbarTemplate)&&(t.reset(),t.update()),this.fileName=e.value.split("\\")[e.value.split("\\").length-1],this.fileName=this.fileName.split(".")[0],this.imageOnLoad(i.toString()),e.value=""},d.prototype.moveToSelectionRange=function(e,i){var t=this.parent;if(t.activeObj.shape){for(var r=!1,o=0,a=t.rotateFlipColl.length;o<a;o++){var n=t.rotateFlipColl[o];if(n===90||n===-90){r=!0;break}}if(r){if(t.transform.degree===0)return;var s=t.transform.zoomFactor;t.objColl.push(t.activeObj),t.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1});var l=t.objColl[t.objColl.length-1];if(e==="rotateleft"||e==="rotateright")if(t.transform.degree%90===0&&t.transform.degree%180!==0)if(l.activePoint.width<i.activePoint.height)for(var o=2;o<t.zoomSettings.maxZoomFactor;o++){if(l.activePoint.width>=i.activePoint.height||this.isSelectionBiggerThanCanvas(l)||this.isSelectionOutsideCanvas(l)){C(s)||t.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-.1,zoomPoint:null},isResize:null});break}s+=.1,t.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:s,zoomPoint:null},isResize:null})}else for(var o=2;o<t.zoomSettings.maxZoomFactor;o++){if(l.activePoint.width>=i.activePoint.height||this.isSelectionBiggerThanCanvas(l)||this.isSelectionOutsideCanvas(l)){C(s)||t.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:.1,zoomPoint:null,isResize:null}});break}s-=.1,t.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:s,zoomPoint:null},isResize:null})}else if(l.activePoint.height<i.activePoint.width)for(var o=2;o<t.zoomSettings.maxZoomFactor;o++){if(l.activePoint.height>=i.activePoint.width||this.isSelectionBiggerThanCanvas(l)||this.isSelectionOutsideCanvas(l)){C(s)||t.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-.1,zoomPoint:null},isResize:null});break}s+=.1,t.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:s,zoomPoint:null},isResize:null})}else for(var o=2;o<t.zoomSettings.maxZoomFactor;o++){if(l.activePoint.height>=i.activePoint.width||this.isSelectionBiggerThanCanvas(l)||this.isSelectionOutsideCanvas(l)){C(s)||t.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:.1,zoomPoint:null},isResize:null});break}s-=.1,t.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:s,zoomPoint:null},isResize:null})}var p=t.lowerCanvas.clientWidth/2-(l.activePoint.startX+l.activePoint.width/2),h=(t.lowerCanvas.clientHeight+1)/2-(l.activePoint.startY+l.activePoint.height/2);C(t.activeObj.shape)&&(t.activeObj=f({},i,{},!0)),t.transform.degree===0?(t.img.destLeft+=p,t.img.destTop+=h,t.notify("transform",{prop:"drawPannImage",value:{point:{x:p,y:h}}})):(t.panPoint.currentPannedPoint={x:p,y:h},t.notify("transform",{prop:"drawPannedImage",value:{xDiff:p,yDiff:h}}),t.panPoint.currentPannedPoint={x:0,y:0}),t.notify("transform",{prop:"setTempPanMove",onPropertyChange:!1,value:{point:null}}),t.activeObj=f({},t.objColl[t.objColl.length-1]),t.objColl.pop(),t.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:t.activeObj}})}}},d.prototype.isSelectionBiggerThanCanvas=function(e){var i=!1,t=this.parent,r=e.activePoint,o=r.startX,a=r.startY,n=r.endX,s=r.endY,l=t.img,p=l.destLeft,h=l.destTop,u=l.destWidth,c=l.destHeight;return(o<=p||a<=h||n>=p+u||s>=h+c)&&(i=!0),i},d.prototype.isSelectionOutsideCanvas=function(e){var i=!1,t=this.parent;return(e.activePoint.height<t.lowerCanvas.height-t.toolbarHeight||e.activePoint.width<t.lowerCanvas.width)&&(i=!0),i},d.prototype.downScaleImgCanvas=function(e,i,t,r){var o=this.parent,a=i?o.activeObj.imageCanvas:o.baseImgCanvas,n=i?o.activeObj.imageElement:o.baseImg,s=i?o.activeObj.activePoint.width:o.img.destWidth,l=i?o.activeObj.activePoint.height:o.img.destHeight,p={width:0,height:0};if(o.transform.degree%90===0&&o.transform.degree%180!==0?o.notify("transform",{prop:"calcMaxDimension",onPropertyChange:!1,value:{width:n.height,height:n.width,obj:p,isImgShape:i}}):o.notify("transform",{prop:"calcMaxDimension",onPropertyChange:!1,value:{width:n.width,height:n.height,obj:p,isImgShape:i}}),i||o.allowDownScale&&!o.isCropTab&&!o.isCropToolbar&&n.width!==0&&n.height!==0&&p.width*.75>s&&p.height*.75>l){var h=o.createElement("canvas",{id:o.element.id+"_downScaleCanvas",attrs:{name:"canvasImage"}});h.width=i?n.width:o.img.srcWidth,h.height=i?n.height:o.img.srcHeight,i?h.getContext("2d").drawImage(n,0,0,h.width,h.height):(this.imageBackgroundColor!==""&&(e.fillStyle=this.imageBackgroundColor,e.fillRect(o.img.destLeft,o.img.destTop,o.img.destWidth,o.img.destHeight)),h.getContext("2d").drawImage(a,o.img.srcLeft,o.img.srcTop,o.img.srcWidth,o.img.srcHeight,0,0,h.width,h.height)),(i||this.isDownScale)&&this.downScale(h,s,l,i),i?(e.canvas.width=h.width,e.canvas.height=h.height,t&&r?(e.translate(o.activeObj.imageCanvas.width,0),e.scale(-1,1),e.translate(0,o.activeObj.imageCanvas.height),e.scale(1,-1)):t?(C(o.activeObj.isHorImageFlip)||!o.activeObj.isHorImageFlip?(o.activeObj.isHorImageFlip=!0,e.translate(o.activeObj.imageCanvas.width,0),e.scale(-1,1)):o.activeObj.isHorImageFlip&&(o.activeObj.isHorImageFlip=!1),o.activeObj.isVerImageFlip&&(e.translate(0,o.activeObj.imageCanvas.height),e.scale(1,-1))):r&&(C(o.activeObj.isVerImageFlip)||!o.activeObj.isVerImageFlip?(o.activeObj.isVerImageFlip=!0,e.translate(0,o.activeObj.imageCanvas.height),e.scale(1,-1)):o.activeObj.isVerImageFlip&&(o.activeObj.isVerImageFlip=!1),o.activeObj.isHorImageFlip&&(e.translate(o.activeObj.imageCanvas.width,0),e.scale(-1,1))),e.drawImage(h,0,0),e.setTransform(1,0,0,1,0,0)):o.isFinetuning?(e.save(),e.setTransform(1,0,0,1,0,0),e.drawImage(o.inMemoryCanvas,0,0),e.restore()):e.drawImage(h,0,0,h.width,h.height,o.img.destLeft,o.img.destTop,h.width,h.height)}else(C(i)||!i)&&o.baseImgCanvas.width!==0&&o.baseImgCanvas.height!==0&&(this.imageBackgroundColor!==""&&(e.fillStyle=this.imageBackgroundColor,e.fillRect(o.img.destLeft,o.img.destTop,o.img.destWidth,o.img.destHeight)),e.drawImage(o.baseImgCanvas,o.img.srcLeft,o.img.srcTop,o.img.srcWidth,o.img.srcHeight,o.img.destLeft,o.img.destTop,o.img.destWidth,o.img.destHeight));o.isSafari&&o.notify("filter",{prop:"apply-filter",onPropertyChange:!1,value:{context:e}})},d.prototype.downScale=function(e,i,t,r){var o=this.parent;if(!(r&&o.isStraightening)){var a=e.width,n=e.height;i=Math.round(i),t=Math.round(t);for(var s=a/i,l=n/t,p=Math.ceil(s/2),h=Math.ceil(l/2),u=e.getContext("2d"),c=u.getImageData(0,0,a,n),g=u.createImageData(i,t),v=c.data,b=g.data,m=0;m<t;m++)for(var y=0;y<i;y++){for(var P=(y+m*i)*4,S=0,O=0,j=0,x=0,k=0,T=0,A=0,L=(m+.5)*l,H=Math.floor(m*l),B=Math.ceil((m+1)*l),D=H;D<B;D++)for(var E=Math.abs(L-(D+.5))/h,R=(y+.5)*s,Q=E*E,V=Math.floor(y*s),G=Math.ceil((y+1)*s),W=V;W<G;W++){var K=Math.abs(R-(W+.5))/p,$=Math.sqrt(Q+K*K);if(!($>=1)){S=2*$*$*$-3*$*$+1;var Z=4*(W+D*a);A+=S*v[Z+3],j+=S,S=S*v[Z+3]/250,x+=S*v[Z],k+=S*v[Z+1],T+=S*v[Z+2],O+=S}}b[P]=x/O,b[P+1]=k/O,b[P+2]=T/O,b[P+3]=A/j}e.width=r?o.activeObj.activePoint.width:o.lowerCanvas.width,e.height=r?o.activeObj.activePoint.height:o.lowerCanvas.height,u.putImageData(g,0,0)}},d.prototype.drawImgToCtx=function(e,i){var t=this.parent;e.canvas.id!==t.element.id+"_tempCanvas"&&e!==this.upperContext&&C(i)&&this.downScaleImgCanvas(e,null,null,null)},d.prototype.getFrameColor=function(e,i,t){var r=this.parent,o=r.frameObj.color;if(e.gradientColor){var a=i.createLinearGradient(t.startX,t.startY,t.startX+t.width,t.startY+t.height);a.addColorStop(0,e.color),a.addColorStop(1,e.gradientColor),o=a}else o=e.color;return o},d.prototype.applyFrame=function(e,i,t){var r=this.parent;r.frameObj.type=i;var o,a={width:1,height:1},n={startX:r.img.destLeft-e.lineWidth,startY:r.img.destTop-e.lineWidth,width:r.img.destWidth+2*e.lineWidth,height:r.img.destHeight+2*e.lineWidth},s={type:r.frameObj.type,color:r.frameObj.color,size:r.frameObj.size,inset:r.frameObj.inset,offset:r.frameObj.offset/2,radius:r.frameObj.radius,amount:r.frameObj.amount,border:r.frameObj.border,gradientColor:r.frameObj.gradientColor},l=r.transform.zoomFactor;if(e.canvas.id===r.element.id+"_tempCanvas"){var p=e.canvas.width,h=e.canvas.height,u={width:0,height:0};r.notify("crop",{prop:"calcRatio",onPropertyChange:!1,value:{obj:u,dimension:{width:p,height:h}}}),a=u,s.size*=(a.width+a.height)/2,s.inset*=(a.width+a.height)/2,s.offset*=(a.width+a.height)/2,s.radius*=(a.width+a.height)/2,n={startX:0,startY:0,width:e.canvas.width,height:e.canvas.height},r.notify("export",{prop:"updateSaveContext",onPropertyChange:!1,value:{context:e}})}else e===this.upperContext&&r.activeObj.shape?n={startX:r.activeObj.activePoint.startX-e.lineWidth,startY:r.activeObj.activePoint.startY-e.lineWidth,width:r.activeObj.activePoint.width+2*e.lineWidth,height:r.activeObj.activePoint.height+2*e.lineWidth}:C(t)&&e.clearRect(0,0,e.canvas.width,e.canvas.height);var c=40*((a.width+a.height)/2),g=50*((a.width+a.height)/2);if(e!==this.upperContext&&(s.size+=s.size*l,s.inset+=s.inset*l,s.offset+=s.offset*l,s.radius+=s.radius*l,c+=c*l,g+=g*l),!(e===this.upperContext&&r.activeObj.shape&&(i==="mat"&&(n.width-2*s.size<0||n.height-2*s.size<0)||i==="bevel"&&(n.width-2*s.size<40||n.height-2*s.size<40)||i==="inset"&&(n.startX+n.width-s.offset-(n.startX+s.offset)<0||n.startY+n.height-s.offset-(n.startY+s.offset)<0)||i==="hook"&&(n.width-2*s.size<50||n.height-2*s.size<50)))){var v={bevelFilter:e.filter},b=e.filter;if(r.currSelectionPoint&&r.currSelectionPoint.shape==="crop-circle"||r.isCircleCrop||e===this.lowerContext&&r.isCropTab)this.drawImgToCtx(e,t);else{switch(i){case"none":this.drawImgToCtx(e,t);break;case"mat":for(this.drawImgToCtx(e,t);(n.width-2*s.size<0||n.height-2*s.size<0)&&s.size>0;)s.size-=20;e.filter="none",e.fillStyle=this.getFrameColor(s,e,n),e.beginPath(),e.rect(n.startX,n.startY,n.width,n.height),e.rect(n.startX+s.size,n.startY+s.size,n.width-2*s.size,n.height-2*s.size),e.fill("evenodd"),e.closePath();break;case"bevel":for(e.filter="none",e.fillStyle=this.getFrameColor(s,e,n),e.beginPath(),e.fillRect(n.startX,n.startY,n.width,n.height),e.closePath(),n.startX+=s.size,n.startY+=s.size,n.width-=2*s.size,n.height-=2*s.size;(n.width-2*s.size<40||n.height-2*s.size<40)&&s.size>0;)n.startX-=s.size,n.startY-=s.size,n.width+=2*s.size,n.height+=2*s.size,s.size-=20,n.startX+=s.size,n.startY+=s.size,n.width-=2*s.size,n.height-=2*s.size;e.fillStyle=this.getFrameColor(s,e,n),e.save(),e.beginPath(),e.moveTo(n.startX+c,n.startY),e.lineTo(n.startX+n.width-c,n.startY),e.quadraticCurveTo(n.startX+n.width,n.startY,n.startX+n.width,n.startY+c),e.lineTo(n.startX+n.width,n.startY+n.height-c),e.quadraticCurveTo(n.startX+n.width,n.startY+n.height,n.startX+n.width-c,n.startY+n.height),e.lineTo(n.startX+c,n.startY+n.height),e.quadraticCurveTo(n.startX,n.startY+n.height,n.startX,n.startY+n.height-c),e.lineTo(n.startX,n.startY+c),e.quadraticCurveTo(n.startX,n.startY,n.startX+c,n.startY),e.closePath(),e.clip(),e.filter=b==="none"?r.canvasFilter:b,e.canvas.id===r.element.id+"_tempCanvas"?(t=null,e.filter="none",e.drawImage(r.inMemoryCanvas,0,0),e.filter=b==="none"?r.canvasFilter:b):(e.clearRect(0,0,e.canvas.width,e.canvas.height),t?(t=null,r.transform.zoomFactor!==0&&(this.isRotateZoom=!0),r.notify("filter",{prop:"getBevelFilter",onPropertyChange:!1,value:{obj:v}}),e.filter=v.bevelFilter,this.updateCurrTransState("initial"),this.drawImgToCtx(e,t),this.updateCurrTransState("reverse"),this.isRotateZoom=!1,r.frameObj.type="none",e.filter="none",r.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:e,shape:"iterate",pen:"iterate",isPreventApply:null}}),r.frameObj.type="bevel",e.filter=b==="none"?r.canvasFilter:b):(r.notify("filter",{prop:"getBevelFilter",onPropertyChange:!1,value:{obj:v}}),e.filter=v.bevelFilter,this.drawImgToCtx(e,t))),e.restore();break;case"line":this.drawImgToCtx(e,t),o=e.lineWidth,e.lineWidth=s.size/10;for(var m=0;m<r.frameObj.amount;m++){m>0&&(n.startX+=s.offset,n.startY+=s.offset,n.width-=2*s.offset,n.height-=2*s.offset);var y=n.startY+n.height-s.inset-s.radius,P=n.startY+s.inset+s.radius,S=n.startX+n.width-s.inset-s.radius,O=n.startX+s.inset+s.radius,j=n.startX+s.inset+s.radius,x=n.startX+n.width-s.inset-s.radius,k=n.startY+s.inset+s.radius,T=n.startY+n.height-s.inset-s.radius;y>=P&&S>=O&&j<=x&&k<=T&&(e.filter="none",e.strokeStyle=this.getFrameColor(s,e,n),s.border==="dashed"?e.setLineDash([e.lineWidth*2.5,e.lineWidth*1.5]):s.border==="dotted"&&e.setLineDash([e.lineWidth,e.lineWidth]),e.beginPath(),e.moveTo(n.startX+s.inset+s.radius,n.startY+s.inset),e.lineTo(n.startX+n.width-s.inset-s.radius,n.startY+s.inset),e.arcTo(n.startX+n.width-s.inset,n.startY+s.inset,n.startX+n.width-s.inset,n.startY+s.inset+s.radius,s.radius),e.lineTo(n.startX+n.width-s.inset,n.startY+n.height-s.inset-s.radius),e.arcTo(n.startX+n.width-s.inset,n.startY+n.height-s.inset,n.startX+n.width-s.inset-s.radius,n.startY+n.height-s.inset,s.radius),e.lineTo(n.startX+s.inset+s.radius,n.startY+n.height-s.inset),e.arcTo(n.startX+s.inset,n.startY+n.height-s.inset,n.startX+s.inset,n.startY+n.height-s.inset-s.radius,s.radius),e.lineTo(n.startX+s.inset,n.startY+s.inset+s.radius),e.arcTo(n.startX+s.inset,n.startY+s.inset,n.startX+s.inset+s.radius,n.startY+s.inset,s.radius),e.closePath(),e.stroke(),e.setLineDash([]))}e.lineWidth=o;break;case"inset":this.drawImgToCtx(e,t),e.filter="none",e.strokeStyle=this.getFrameColor(s,e,n),o=e.lineWidth,e.lineWidth=s.size/10,e.beginPath(),e.moveTo(n.startX+s.offset,n.startY+s.inset),e.lineTo(n.startX+n.width-s.offset,n.startY+s.inset),e.moveTo(n.startX+n.width-s.inset,n.startY+s.offset),e.lineTo(n.startX+n.width-s.inset,n.startY+n.height-s.offset),e.moveTo(n.startX+n.width-s.offset,n.startY+n.height-s.inset),e.lineTo(n.startX+s.offset,n.startY+n.height-s.inset),e.moveTo(n.startX+s.inset,n.startY+n.height-s.offset),e.lineTo(n.startX+s.inset,n.startY+s.offset),e.stroke(),e.closePath(),e.lineWidth=o;break;case"hook":this.drawImgToCtx(e,t),e.filter="none",e.strokeStyle=this.getFrameColor(s,e,n),o=e.lineWidth,e.lineWidth=s.size/10,e.beginPath(),e.moveTo(n.startX+s.inset+g,n.startY+s.inset),e.lineTo(n.startX+s.inset,n.startY+s.inset),e.lineTo(n.startX+s.inset,n.startY+s.inset+g),e.moveTo(n.startX+n.width-s.inset-g,n.startY+s.inset),e.lineTo(n.startX+n.width-s.inset,n.startY+s.inset),e.lineTo(n.startX+n.width-s.inset,n.startY+s.inset+g),e.moveTo(n.startX+n.width-s.inset-g,n.startY+n.height-s.inset),e.lineTo(n.startX+n.width-s.inset,n.startY+n.height-s.inset),e.lineTo(n.startX+n.width-s.inset,n.startY+n.height-s.inset-g),e.moveTo(n.startX+s.inset+g,n.startY+n.height-s.inset),e.lineTo(n.startX+s.inset,n.startY+n.height-s.inset),e.lineTo(n.startX+s.inset,n.startY+n.height-s.inset-g),e.stroke(),e.lineWidth=o;break}(r.isCircleCrop||r.currSelectionPoint&&r.currSelectionPoint.shape==="crop-circle")&&r.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:e,isSave:e.canvas.id===r.element.id+"_tempCanvas"?!0:null,isFlip:null}}),e.filter=b}}},d.prototype.triggerFrameChange=function(e){var i=this.parent,t={type:i.toPascalCase(i.frameObj.type),color:i.frameObj.color,gradientColor:i.frameObj.gradientColor,size:i.frameObj.size,inset:i.frameObj.inset,offset:i.frameObj.offset,borderRadius:i.frameObj.radius,frameLineStyle:i.toPascalCase(i.frameObj.border),lineCount:i.frameObj.amount},r={cancel:!1,previousFrameSetting:e,currentFrameSetting:t};return i.trigger("frameChange",r),i.editCompleteArgs=r,r.cancel||this.setFrameObj(r.currentFrameSetting),r},d.prototype.setFrameObj=function(e){var i=this.parent;i.frameObj.type=e.type.toLowerCase(),i.frameObj.color=e.color,i.frameObj.gradientColor=e.gradientColor,i.frameObj.size=e.size,i.frameObj.inset=e.inset,i.frameObj.offset=e.offset,i.frameObj.radius=e.borderRadius,i.frameObj.border=e.frameLineStyle.toLowerCase(),i.frameObj.amount=e.lineCount},d.prototype.zoomToSel=function(e,i){var t=this.parent;if(this.straightenActObj&&JSON.stringify(this.straightenActObj.activePoint)===JSON.stringify(e.activePoint))if(t.activeObj=f({},this.straightenActObj,null,!0),this.allowRedactStraighten=!1,t.transform.straighten===0){var r=t.img.destWidth,o=t.img.destHeight;for(t.transform.straighten=360;;)if(!C(this.straightenInitZoom)&&Math.round(t.transform.zoomFactor*Math.pow(10,3))/Math.pow(10,3)>Math.round(this.straightenInitZoom*Math.pow(10,3))/Math.pow(10,3)){if(this.setZoomPan("out"),r===t.img.destWidth&&o===t.img.destHeight){this.performDummyZoom();break}t.transform.degree===0&&(t.transform.zoomFactor-=.025,t.transform.cropZoomFactor-=.025)}else{this.performDummyZoom();break}t.transform.straighten=0,t.img={destLeft:t.img.destLeft,destTop:t.img.destTop,destWidth:t.img.destWidth,destHeight:t.img.destHeight,srcLeft:t.img.srcLeft,srcTop:t.img.srcTop,srcWidth:t.img.srcWidth,srcHeight:t.img.srcHeight}}else C(this.straightenInitZoom)&&(this.straightenInitZoom=t.transform.zoomFactor),this.straightenInitZoom-t.transform.zoomFactor>0?t.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-(this.straightenInitZoom-t.transform.zoomFactor),zoomPoint:null,isResize:!0}}):this.straightenInitZoom-t.transform.zoomFactor<0&&t.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:this.straightenInitZoom-t.transform.zoomFactor,zoomPoint:null,isResize:!0}}),t.activeObj=f({},e,null,!0),t.transform.zoomFactor+=.001,this.calcStraightenedPoints(i);else this.straightenActObj=f({},e,null,!0),t.activeObj=f({},this.straightenActObj,null,!0),this.straightenInitZoom=t.transform.zoomFactor,this.calcStraightenedPoints(i)},d.prototype.isDestPointSmall=function(){var e=this.parent,i=e.img,t={startX:i.destLeft,startY:i.destTop,width:i.destWidth,height:i.destHeight};e.notify("shape",{prop:"straightenShapes",onPropertyChange:!1});var r=!1;return this.straightenDestPoints.destWidth&&this.straightenDestPoints.destHeight&&(i.destWidth<this.straightenDestPoints.destWidth||i.destHeight<this.straightenDestPoints.destHeight)&&(r=!0),i.destLeft=t.startX,i.destTop=t.startY,i.destWidth=t.width,i.destHeight=t.height,e.img=i,r},d.prototype.calcStraightenedPoints=function(e){var i=this.parent,t=i.img.destWidth,r=i.img.destHeight;C(i.transform.zoomFactor)&&(i.transform.zoomFactor+=.025),this.updateImgCanvasPoints();for(var o=function(){if(a.isLinesIntersect()||a.isSelOutsideImg()||e&&a.isDestPointSmall()){if(i.activeObj=f({},a.straightenActObj,null,!0),a.setZoomPan("in"),t===i.img.destWidth&&r===i.img.destHeight)return a.performDummyZoom(),"break";i.transform.degree===0&&(i.transform.zoomFactor+=.025,i.transform.cropZoomFactor+=.025);var s=a.imgCanvasPoints,l=i.img.destLeft,p=i.img.destTop,h=i.img.destWidth,u=i.img.destHeight;s.forEach(function(c){c.x=c.ratioX*h+l,c.y=c.ratioY*u+p}),a.imgCanvasPoints=s}else return a.performDummyZoom(),"break"},a=this;;){var n=o();if(n==="break")break}},d.prototype.performDummyZoom=function(){var e=this.parent;e.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:.025,zoomPoint:null,isResize:!0}}),e.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-.025,zoomPoint:null,isResize:!0}});var i=e.transform.zoomFactor*10;i<1&&(i=1+i/10),e.setProperties({zoomSettings:{zoomFactor:i}},!0),e.notify("transform",{prop:"setPreviousZoomValue",onPropertyChange:!1,value:{previousZoomValue:i}}),this.panToSel()},d.prototype.setZoomPan=function(e){var i=this.parent,t={maxDimension:null};i.transform.degree===0?(i.notify("transform",{prop:"cropZoom",onPropertyChange:!1,value:{value:e==="in"?.025:-.025,selectionObj:i.activeObj,obj:t}}),i.img.destWidth=t.maxDimension.width,i.img.destHeight=t.maxDimension.height):(i.transform.zoomFactor+=e==="in"?.025:-.025,i.transform.cropZoomFactor+=e==="in"?.025:-.025,this.updateCurrTransState("initial"),this.isRotateZoom=!0,this.setDestPoints(),this.isRotateZoom=!1,this.updateCurrTransState("reverse"))},d.prototype.updateImgCanvasPoints=function(){var e=this.parent,i=this.getImagePoints(),t={width:0,height:0},r=e.baseImgCanvas.width,o=e.baseImgCanvas.height;e.notify("crop",{prop:"calcRatio",onPropertyChange:!1,value:{obj:t,dimension:{width:r,height:o}}});var a=t;r=e.transform.degree%90===0&&e.transform.degree%180!==0?a.height:a.width,o=e.transform.degree%90===0&&e.transform.degree%180!==0?a.width:a.height;var n,s,l,p,h=e.img,u=h.destLeft,c=h.destTop,g=h.destWidth,v=h.destHeight;e.transform.straighten>0?(n={x:u+i[0].x/r,y:c},s={x:u+g,y:c+i[1].y/o},l={x:u+g-i[0].x/r,y:c+v},p={x:u,y:c+v-i[1].y/o}):e.transform.straighten<0?(n={x:u,y:c+i[0].y/o},s={x:u+i[1].x/r,y:c},l={x:u+g,y:c+v-i[0].y/o},p={x:u+g-i[1].x/r,y:c+v}):e.transform.straighten===0&&(n={x:u,y:c},s={x:u+g,y:c},l={x:u+g,y:c+v},p={x:u,y:c+v}),n.ratioX=(n.x-u)/g,n.ratioY=(n.y-c)/v,s.ratioX=(s.x-u)/g,s.ratioY=(s.y-c)/v,l.ratioX=(l.x-u)/g,l.ratioY=(l.y-c)/v,p.ratioX=(p.x-u)/g,p.ratioY=(p.y-c)/v,this.imgCanvasPoints=[n,s,l,p]},d.prototype.isLinesIntersect=function(e){var i=this.parent,t=i.activeObj.activePoint;if(i.activeObj.rotatedAngle!==0){var r=i.activeObj.activePoint,o=r.startX,a=r.startY,n=r.endX,s=r.endY,l=r.width,p=r.height,h={x:o+l/2,y:a+p/2},u=Math.cos(i.activeObj.rotatedAngle),c=Math.sin(i.activeObj.rotatedAngle),g={x:u*(o-h.x)-c*(a-h.y)+h.x,y:c*(o-h.x)+u*(a-h.y)+h.y},v={x:u*(n-h.x)-c*(a-h.y)+h.x,y:c*(n-h.x)+u*(a-h.y)+h.y},b={x:u*(o-h.x)-c*(s-h.y)+h.x,y:c*(o-h.x)+u*(s-h.y)+h.y},m={x:u*(n-h.x)-c*(s-h.y)+h.x,y:c*(n-h.x)+u*(s-h.y)+h.y},y=this.imgCanvasPoints,P=this.doIntersect(g,v,y[0],y[1]),S=this.doIntersect(v,m,y[1],y[2]),O=this.doIntersect(b,m,y[2],y[3]),j=this.doIntersect(g,b,y[3],y[0]);return e&&(e.arr=[P,S,O,j]),P||S||O||j}var x=this.imgCanvasPoints,k=this.doIntersect({x:t.startX,y:t.startY},{x:t.endX,y:t.startY},x[0],x[1]),T=this.doIntersect({x:t.endX,y:t.startY},{x:t.endX,y:t.endY},x[1],x[2]),A=this.doIntersect({x:t.startX,y:t.endY},{x:t.endX,y:t.endY},x[2],x[3]),L=this.doIntersect({x:t.startX,y:t.startY},{x:t.startX,y:t.endY},x[3],x[0]),H=this.isInsideRect(x[0]),B=this.isInsideRect(x[1]),D=this.isInsideRect(x[2]),E=this.isInsideRect(x[3]);return e&&(e.arr=[k,T,A,L]),k||T||A||L||H||B||D||E||x[0].x>t.startX&&x[1].x<t.endX&&x[2].x<t.endX&&x[3].x>t.startX&&x[0].y<t.startY&&x[1].y<t.startY&&x[2].y>t.endY&&x[3].y>t.endY||x[0].x<t.startX&&x[1].x>t.endX&&x[2].x>t.endX&&x[3].x<t.startX&&x[0].y>t.startY&&x[1].y>t.startY&&x[2].y<t.endY&&x[3].y<t.endY},d.prototype.isSelOutsideImg=function(){var e=this.parent,i=this.imgCanvasPoints,t=e.activeObj.activePoint;return this.checkPointPosition(t.startX,t.startY,i[0].x,i[0].y,i[1].x,i[1].y,i[2].x,i[2].y,i[3].x,i[3].y)!=="inside"||this.checkPointPosition(t.endX,t.startY,i[0].x,i[0].y,i[1].x,i[1].y,i[2].x,i[2].y,i[3].x,i[3].y)!=="inside"||this.checkPointPosition(t.startX,t.endY,i[0].x,i[0].y,i[1].x,i[1].y,i[2].x,i[2].y,i[3].x,i[3].y)!=="inside"||this.checkPointPosition(t.endX,t.endY,i[0].x,i[0].y,i[1].x,i[1].y,i[2].x,i[2].y,i[3].x,i[3].y)!=="inside"},d.prototype.calcTriangleArea=function(e,i,t,r,o,a){return Math.abs((e*(r-a)+t*(a-i)+o*(i-r))/2)},d.prototype.checkPointPosition=function(e,i,t,r,o,a,n,s,l,p){var h=this.calcTriangleArea(e,i,t,r,l,p),u=this.calcTriangleArea(e,i,l,p,n,s),c=this.calcTriangleArea(e,i,n,s,o,a),g=this.calcTriangleArea(e,i,o,a,t,r),v=this.calcTriangleArea(t,r,o,a,n,s)+this.calcTriangleArea(n,s,l,p,t,r);return h+u+c+g>v?"outside":h+u+c+g===v&&(h===0||u===0||c===0||g===0)?"on":"inside"},d.prototype.getImagePoints=function(){var e=[],i=this.parent,t=i.transform.degree,r=i.baseImg.width,o=i.baseImg.height,a={dim:null,width:o,height:r,angle:i.transform.straighten};a.dim=i.getRotatedCanvasDim(a.width,a.height,a.angle);var n=t%90===0&&t%180!==0?a.dim.width:i.baseImgCanvas.width,s=t%90===0&&t%180!==0?a.dim.height:i.baseImgCanvas.height,l=t%90===0&&t%180!==0?o:r,p=t%90===0&&t%180!==0?r:o,h=n/2,u=s/2,c=h-l/2,g=u-p/2,v=h+l/2,b=u+p/2,m={x:h,y:u},y=i.transform.straighten*(Math.PI/180),P={x:Math.cos(y)*(c-m.x)-Math.sin(y)*(g-m.y)+m.x,y:Math.sin(y)*(c-m.x)+Math.cos(y)*(g-m.y)+m.y},S={x:Math.cos(y)*(v-m.x)-Math.sin(y)*(g-m.y)+m.x,y:Math.sin(y)*(v-m.x)+Math.cos(y)*(g-m.y)+m.y},O={x:Math.cos(y)*(v-m.x)-Math.sin(y)*(b-m.y)+m.x,y:Math.sin(y)*(v-m.x)+Math.cos(y)*(b-m.y)+m.y},j={x:Math.cos(y)*(c-m.x)-Math.sin(y)*(b-m.y)+m.x,y:Math.sin(y)*(c-m.x)+Math.cos(y)*(b-m.y)+m.y};return e.push(P),e.push(S),e.push(O),e.push(j),e},d.prototype.doIntersect=function(e,i,t,r){var o=this.initiation(e,i,t),a=this.initiation(e,i,r),n=this.initiation(t,r,e),s=this.initiation(t,r,i);return!!(o!==a&&n!==s||o===0&&this.onSegment(e,t,i)||a===0&&this.onSegment(e,r,i)||n===0&&this.onSegment(t,e,r)||s===0&&this.onSegment(t,i,r))},d.prototype.initiation=function(e,i,t){var r=(i.y-e.y)*(t.x-i.x)-(i.x-e.x)*(t.y-i.y);return r===0?0:r>0?1:2},d.prototype.onSegment=function(e,i,t){return i.x<=Math.max(e.x,t.x)&&i.x>=Math.min(e.x,t.x)&&i.y<=Math.max(e.y,t.y)&&i.y>=Math.min(e.y,t.y)},d.prototype.isInsideRect=function(e){var i=this.parent,t=i.activeObj.activePoint,r=!1;return e.x>=t.startX&&e.x<=t.endX&&e.y>=t.startY&&e.y<=t.endY&&(r=!0),r},d.prototype.setDestForStraighten=function(){var e=this.parent;if(C(this.straightenDestPoints)){var i=e.img,t=i.destLeft,r=i.destTop,o=i.destWidth,a=i.destHeight;e.notify("shape",{prop:"straightenShapes",onPropertyChange:!1}),this.straightenDestPoints=f({},e.img,{},!0),e.img.destLeft=t,e.img.destTop=r,e.img.destWidth=o,e.img.destHeight=a}},d.prototype.drawRedact=function(e,i){var t=i.activePoint,r=t.startX,o=t.startY,a=t.endX,n=t.endY,s=i.activePoint,l=s.width,p=s.height,h=!1,u=e.canvas;u.id.indexOf("_tempCanvas")!==-1&&(h=!0);var c=this.parent.img;if(!(l<=0||p<=0))if(this.parent.isCropTab)e.drawImage(i.redactImage,0,0,i.redactImage.width,i.redactImage.height,r,o,l,p);else{var g=document.createElement("canvas"),v=g.getContext("2d"),b=u.width,m=u.height,y=Math.min(b,m)/1e3,P=Math.round(this.parent.activeObj.rotatedAngle*(180/Math.PI));if(this.allowRedactStraighten&&P!==0){var S=document.createElement("canvas"),O=S.getContext("2d");h?(S.width=u.width,S.height=u.height,O.drawImage(u,0,0)):(S.width=c.destWidth>u.width?u.width:c.destWidth,S.height=c.destHeight>u.height?u.height:c.destHeight,O.drawImage(this.lowerContext.canvas,c.destLeft>0?c.destLeft:0,c.destTop>0?c.destTop:0,S.width,S.height,0,0,S.width,S.height));var j=-P*Math.PI/180,x=document.createElement("canvas"),k=x.getContext("2d");x.width=S.width,x.height=S.height,c.destWidth>u.width&&!h&&(x.width=u.width),c.destHeight>u.height&&!h&&(x.height=u.height),k.save(),k.translate(S.width/2,S.height/2),k.rotate(j),k.drawImage(S,-S.width/2,-S.height/2),k.restore(),c.destLeft>0&&!h&&(r-=c.destLeft,a-=c.destLeft),c.destTop>0&&!h&&(o-=c.destTop,n-=c.destTop);var T={x:r+l/2,y:o+p/2},A=Math.cos(P*Math.PI/180),L=Math.sin(P*Math.PI/180),H={x:A*(r-T.x)-L*(o-T.y)+T.x,y:L*(r-T.x)+A*(o-T.y)+T.y},B={x:A*(a-T.x)-L*(o-T.y)+T.x,y:L*(a-T.x)+A*(o-T.y)+T.y},D={x:A*(r-T.x)-L*(n-T.y)+T.x,y:L*(r-T.x)+A*(n-T.y)+T.y};h?T={x:u.width/2,y:u.height/2}:(T={x:c.destWidth/2,y:c.destHeight/2},c.destWidth>u.width&&(T.x=u.width/2),c.destHeight>u.height&&(T.y=u.height/2)),A=Math.cos(j),L=Math.sin(j);var E={x:A*(H.x-T.x)-L*(H.y-T.y)+T.x,y:L*(H.x-T.x)+A*(H.y-T.y)+T.y},R={x:A*(B.x-T.x)-L*(B.y-T.y)+T.x,y:L*(B.x-T.x)+A*(B.y-T.y)+T.y},Q={x:A*(D.x-T.x)-L*(D.y-T.y)+T.x,y:L*(D.x-T.x)+A*(D.y-T.y)+T.y},V=h?e.canvas.width:c.destWidth>u.width?u.width:c.destWidth,G=h?e.canvas.height:c.destHeight>u.height?u.height:c.destHeight,W=Math.abs(V*Math.cos(j))+Math.abs(G*Math.sin(j)),K=Math.abs(V*Math.sin(j))+Math.abs(G*Math.cos(j)),$=x.width,Z=x.height;if(x.width=W,x.height=K,k.save(),k.translate(W/2,K/2),k.rotate(j),k.drawImage(S,-S.width/2,-S.height/2),k.restore(),this.parent.activeObj.redactType==="blur"){g.width=l,g.height=p;var pe=E.x+(W-$)/2,he=E.y+(K-Z)/2;this.isRedactStraighten&&(pe=r+(W-$)/2,he=o+(K-Z)/2),v.drawImage(x,pe,he,R.x-E.x,Q.y-R.y,0,0,l,p)}else{var ce=i.redactPixelate/100*20;h&&(ce=y*(i.redactPixelate/100)*35),g.width=Math.ceil(l/ce),g.height=Math.ceil(p/ce);var pe=E.x+(W-$)/2,he=E.y+(K-Z)/2;this.isRedactStraighten&&(pe=r+(W-$)/2,he=o+(K-Z)/2),v.drawImage(x,pe,he,R.x-E.x,Q.y-R.y,0,0,g.width,g.height)}}if(this.parent.activeObj.redactType==="blur"){if(P===0&&(g.width=l,g.height=p,v.drawImage(h?u:this.lowerContext.canvas,r,o,l,p,0,0,l,p)),h){var Te=y*(i.redactBlur/100*34);v.filter="blur("+Te+"px)"}else v.filter="blur("+i.redactBlur/100*17+"px)";v.drawImage(g,0,0),P===0?v.drawImage(h?u:this.lowerContext.canvas,r,o,l,p,0,0,l,p):(c.destLeft>0&&!h&&(r+=c.destLeft,a+=c.destLeft),c.destTop>0&&!h&&(o+=c.destTop,n+=c.destTop)),this.parent.isSafari&&this.parent.notify("filter",{prop:"apply-filter",onPropertyChange:!1,value:{context:v}}),e.drawImage(g,0,0,l,p,r,o,l,p)}else{var ce=i.redactPixelate/100*20;h&&(ce=y*(i.redactPixelate/100)*35),P===0?(g.width=Math.ceil(l/ce),g.height=Math.ceil(p/ce),v.drawImage(h?u:this.lowerContext.canvas,r,o,l,p,0,0,g.width,g.height)):(c.destLeft>0&&!h&&(r+=c.destLeft,a+=c.destLeft),c.destTop>0&&!h&&(o+=c.destTop,n+=c.destTop)),e.imageSmoothingEnabled=!1,e.drawImage(g,0,0,g.width,g.height,r,o,l,p)}i.redactImage=this.parent.createElement("canvas"),i.redactImage.width=g.width,i.redactImage.height=g.height,i.redactImage.getContext("2d").drawImage(g,0,0),e.beginPath(),e.rect(r,o,l,p),e.rect(r,o,l,p),e.fill("evenodd"),e.closePath()}},d}(),li=function(){function d(e){this.parent=e,this.addEventListener()}return d.prototype.destroy=function(){this.parent.isDestroyed||this.removeEventListener()},d.prototype.addEventListener=function(){this.parent.on("export",this.export,this),this.parent.on("destroyed",this.destroy,this)},d.prototype.removeEventListener=function(){this.parent.off("export",this.export),this.parent.off("destroyed",this.destroy)},d.prototype.export=function(e){switch(this.parent.notify("toolbar",{prop:"refreshShapeDrawing",onPropertyChange:!1}),this.updatePvtVar(),e.prop){case"export":this.exportImg(e.value.type,e.value.fileName,e.value.imgQuality);break;case"exportToCanvas":this.exportToCanvas(e.value.object);break;case"updateSaveContext":this.updateSaveContext(e.value.context);break;case"setImageQuality":this.imageQuality=e.value.value;break;case"drawAnnotation":this.drawAnnotation(e.value.context,e.value.ratio);break}},d.prototype.getModuleName=function(){return"export"},d.prototype.updatePvtVar=function(){var e=this.parent;e.lowerCanvas&&(this.lowerContext=e.lowerCanvas.getContext("2d"))},d.prototype.exportImg=function(e,i,t){var r=this.parent,o={fileName:""};r.notify("draw",{prop:"getFileName",onPropertyChange:!1,value:{obj:o}});var a=o.fileName;if(!r.disabled&&r.isImageLoaded){r.notify("shape",{prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:null}});var n={canvasFilter:this.parent.canvasFilter};this.lowerContext.filter=n.canvasFilter,e=e||"Png",r.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:null}});var s={cancel:!1,fileName:i||a,fileType:e,imageQuality:t};r.trigger("beforeSave",s),this.beforeSaveEvent(s,e,i,a,t)}},d.prototype.beforeSaveEvent=function(e,i,t,r,o){var a=this.parent;if(!e.cancel){a.currObjType.isSave=!0,t=e.fileName?e.fileName:t;var n=i.toLowerCase();t=t||r,n==="svg"?this.toSVGImg(t):this.toBlobFn(t,n,o);var s={fileName:t||r,fileType:i};a.trigger("saved",s);var l={action:"save",actionEventArgs:s};a.triggerEditCompleteEvent(l),a.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1}),a.lowerCanvas.style.left=a.upperCanvas.style.left="",a.lowerCanvas.style.top=a.upperCanvas.style.top="",a.lowerCanvas.style.maxWidth=a.upperCanvas.style.maxWidth="",a.lowerCanvas.style.maxHeight=a.upperCanvas.style.maxHeight=""}},d.prototype.toSVGImg=function(e){var i=this.parent;ue(i.element),i.element.style.opacity="0.5";var t=this.exportToCanvas(),r=t.toDataURL();re(i.element),i.element.style.opacity="1";var o=document.createElementNS("http://www.w3.org/2000/svg","svg");o.setAttribute("width",t.style.maxWidth),o.setAttribute("height",t.style.maxHeight);var a="http://www.w3.org/1999/xlink",n=document.createElementNS("http://www.w3.org/2000/svg","image");n.setAttributeNS(null,"height",t.height.toString()),n.setAttributeNS(null,"width",t.width.toString()),n.setAttributeNS(a,"xlink:href",r),o.appendChild(n);var s="data:image/svg+xml;base64,",l='<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"'+(' width="'+t.width+'"')+(' height="'+t.height+'"')+">",p="</svg>",h=o.innerHTML,u=l+h+p,c=s+btoa(u);return e===null?c:(this.downloadImg(c,e+".svg"),null)},d.prototype.toBlobFn=function(e,i,t){var r=this,o=this.parent;ue(o.element),o.element.style.opacity="0.5",C(t)||(t=t>1?1:t<=0?.01:t,this.imageQuality=t||null);var a=this.exportToCanvas(),n=i==="jpeg"?"image/jpeg":i==="webp"?"image/webp":"image/png";a.toBlob(function(s){var l=URL.createObjectURL(s);r.downloadImg(l,e+"."+i),re(o.element),o.element.style.opacity="1"},n,this.imageQuality?this.imageQuality:null)},d.prototype.exportToCanvas=function(e){var i=this.parent,t,r,o=f({},i.cropObj,{},!0),a={currObj:{}};i.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:a}});var n=a.currObj;n.objColl=f([],i.objColl,[],!0),n.pointColl=f([],i.pointColl,[],!0),n.afterCropActions=f([],i.afterCropActions,[],!0);var s={selPointColl:null};i.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:s}}),this.parent.aspectWidth?(i.notify("undo-redo",{prop:"setPreventUR",value:{bool:!0}}),i.notify("toolbar",{prop:"resizeClick",value:{bool:!1}}),i.okBtn(),i.transform.degree%90===0&&i.transform.degree%180!==0?(t=this.parent.aspectHeight,r=this.parent.aspectWidth):(t=this.parent.aspectWidth,r=this.parent.aspectHeight),i.notify("undo-redo",{prop:"setPreventUR",value:{bool:!1}})):i.currSelectionPoint?(t=i.img.srcWidth,r=i.img.srcHeight):(t=i.baseImgCanvas.width,r=i.baseImgCanvas.height);var l={width:0,height:0};i.notify("crop",{prop:"calcRatio",onPropertyChange:!1,value:{obj:l,dimension:{width:t,height:r}}});var p=l,h=this.lowerContext.filter;if(this.lowerContext.filter!=="none"){var u=this.lowerContext.filter.split(" "),c=parseFloat(u[5].split("(")[1]);c*=(p.width+p.height)/2,u[5]="blur("+c+"px)",this.lowerContext.filter=u.join(" ")}var g=i.createElement("canvas",{id:i.element.id+"_tempCanvas",attrs:{name:"canvasImage"}}),v=g.getContext("2d");g.width=t,g.height=r;var b={width:0,height:0};i.notify("transform",{prop:"calcMaxDimension",onPropertyChange:!1,value:{width:t,height:r,obj:b}});var m=b;g.style.maxWidth=m.width+"px",g.style.maxHeight=m.height+"px";var y=this.lowerContext.filter;return v.filter=this.lowerContext.filter,this.downScaleImgCanvas(v,t,r),this.lowerContext.filter=y,(i.transform.degree!==0||i.transform.currFlipState!==""||i.transform.straighten!==0)&&(this.updateSaveContext(v),this.exportTransformedImage(v)),i.isSafari&&i.notify("filter",{prop:"apply-filter",onPropertyChange:!1,value:{context:v}}),this.drawAnnotation(v,p),i.isCircleCrop&&i.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:v,isSave:!0,isFlip:null}}),this.updateFrame(v,!0),this.lowerContext.filter=h,i.canvasFilter=h,e&&(e.canvas=g),i.aspectWidth&&(i.objColl=[],i.pointColl=[],i.freehandCounter=0,i.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:[]}}}),i.notify("draw",{prop:"setCurrentObj",onPropertyChange:!1,value:{obj:n}}),n.selPointColl=f([],s.selPointColl,[],!0),i.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:n.selPointColl}}}),i.cropObj=o,i.objColl=f([],n.objColl,[],!0),i.pointColl=f([],n.pointColl,[],!0),i.freehandCounter=i.pointColl.length,i.transform.straighten=0,this.lowerContext.filter="none",i.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),this.lowerContext.filter=n.filter,i.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),(i.isCircleCrop||i.currSelectionPoint&&i.currSelectionPoint.shape==="crop-circle")&&i.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}})),g},d.prototype.drawAnnotation=function(e,i){var t=this.parent,r=f([],t.objColl,[],!0),o=f([],t.pointColl,[],!0),a=t.shapeColl.filter(function(l){return l.shape!=="redact"}),n=t.shapeColl.filter(function(l){return l.shape==="redact"});t.shapeColl=n.concat(a);for(var s=0;s<t.shapeColl.length;s++)t.shapeColl[s].order&&(t.shapeColl[s].currIndex&&t.shapeColl[s].currIndex.indexOf("shape")>-1?(t.objColl=[],t.objColl.push(f({},t.shapeColl[s],{},!0)),this.drawShape(e,i)):t.shapeColl[s].id&&t.shapeColl[s].id.indexOf("pen")>-1&&(t.pointColl=[],t.freehandCounter=0,t.pointColl.push(f({},t.shapeColl[s],{},!0)),t.freehandCounter=t.pointColl.length,this.drawPen(e,i)));t.objColl=r,t.pointColl=o,t.freehandCounter=t.pointColl.length},d.prototype.drawShape=function(e,i){var t=this.parent;if(t.objColl.length>0){var r=e.filter;e.filter="none";var o={index:null};t.notify("shape",{prop:"getSmallestIndex",onPropertyChange:!1,value:{obj:o}});for(var a=o.index,n=f([],t.objColl,[],!0),s=f([],t.objColl,[],!0);n.length>0;){for(var l=!1,p=0;p<n.length;p++){var h=n[p];if(C(h.order)){n.splice(p,1),p--;continue}if(h.order===a){var u=e.filter;e.filter="none";var c=n[p],g=c.activePoint;if(g.startX-=t.img.destLeft,g.startY-=t.img.destTop,g.endX-=t.img.destLeft,g.endY-=t.img.destTop,g.width=g.endX-g.startX,g.height=g.endY-g.startY,g.startX*=i.width,g.startY*=i.height,g.endX*=i.width,g.endY*=i.height,g.width=g.endX-g.startX,g.height=g.endY-g.startY,c.strokeSettings.strokeWidth*=(i.width+i.height)/2,c.shape==="text")c.textSettings.fontSize*=(i.width+i.height)/2;else if(c.shape==="path")for(var v=0;v<c.pointColl.length;v++)c.pointColl[v].x=(c.pointColl[v].x-t.img.destLeft)*i.width,c.pointColl[v].y=(c.pointColl[v].y-t.img.destTop)*i.height;else c.shape==="image"&&(t.activeObj=f({},n[p],{},!0),t.notify("selection",{prop:"upgradeImageQuality",onPropertyChange:!1}),n[p]=f({},t.activeObj,{},!0));t.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"saveContext",obj:n[p],isCropRatio:null,points:null,isPreventDrag:!0,saveContext:e,isPreventSelection:null}}),e.filter=u,t.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),a++;var b={bool:!1};t.notify("shape",{prop:"isIndexInObjColl",onPropertyChange:!1,value:{obj:b,index:a}}),b.bool||a++,n.splice(p,1),l=!0;break}}if(!l)break}e.filter=r,t.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),t.objColl=s}},d.prototype.drawPen=function(e,i){var t=this.parent;if(t.freehandCounter>0){var r={penStrokeWidth:null};t.notify("freehand-draw",{prop:"getPenStrokeWidth",onPropertyChange:!1,value:{obj:r}});for(var o=f({},t.pointColl,{},!0),a=0;a<t.freehandCounter;a++){t.points=f([],t.pointColl[a].points,[]),t.notify("freehand-draw",{prop:"setPointCounter",onPropertyChange:!1,value:{value:0}});var n=t.points.length;t.pointColl[a].strokeWidth*=(i.width+i.height)/2;for(var s=0;s<n;s++)t.points[s].x=(t.points[s].x-t.img.destLeft)*i.width,t.points[s].y=(t.points[s].y-t.img.destTop)*i.height}t.notify("freehand-draw",{prop:"freehandRedraw",onPropertyChange:!1,value:{context:e,points:null}}),t.pointColl=o,t.notify("freehand-draw",{prop:"setPenStrokeWidth",onPropertyChange:!1,value:{value:r.penStrokeWidth}})}},d.prototype.downScaleImgCanvas=function(e,i,t){var r=this.parent,o=r.baseImgCanvas,a=r.baseImg,n={width:0,height:0};r.notify("transform",{prop:"calcMaxDimension",onPropertyChange:!1,value:{width:a.width,height:a.height,obj:n,isImgShape:null}});var s={color:null};if(r.notify("draw",{prop:"getImageBackgroundColor",value:{obj:s}}),s.color!==""&&(e.fillStyle=s.color,e.fillRect(0,0,e.canvas.width,e.canvas.height)),n.width>i&&n.height>t){var l=r.createElement("canvas",{id:r.element.id+"_downScaleCanvas",attrs:{name:"canvasImage"}});l.width=this.parent.img.srcWidth,l.height=this.parent.img.srcHeight,l.getContext("2d").drawImage(o,r.img.srcLeft,r.img.srcTop,r.img.srcWidth,r.img.srcHeight,0,0,l.width,l.height),r.notify("draw",{prop:"downScale",value:{canvas:l,width:i,height:t}}),e.drawImage(l,0,0)}else e.drawImage(r.baseImgCanvas,r.img.srcLeft,r.img.srcTop,r.img.srcWidth,r.img.srcHeight,0,0,i,t)},d.prototype.updateFrame=function(e,i){if(this.parent.frameObj.type!=="none"){var t=e.filter;e.filter="none",this.parent.notify("draw",{prop:"applyFrame",value:{ctx:e,frame:this.parent.frameObj.type,preventImg:i}}),e.filter=t}},d.prototype.downloadImg=function(e,i){var t=document.createElement("a");t.href=e,t.target="_parent",t.download=i,(document.body||document.documentElement).appendChild(t),t.click(),t.parentNode.removeChild(t)},d.prototype.exportTransformedImage=function(e){var i=this.parent,t=i.transform.degree;if(i.rotateFlipColl.length>0)for(var r=0,o=i.rotateFlipColl.length;r<o;r++){var a=i.rotateFlipColl[r];typeof a=="number"?this.exportRotate(e,a):a==="horizontal"?this.exportFlip(e,!0,!1):a==="vertical"&&this.exportFlip(e,!1,!0)}i.transform.degree=t},d.prototype.exportRotate=function(e,i){var t=this.parent;e.clearRect(0,0,e.canvas.width,e.canvas.height),this.setMaxDim(t.transform.degree,e.canvas),e.translate(e.canvas.width/2,e.canvas.height/2),e.rotate(Math.PI/180*i),e.drawImage(t.inMemoryCanvas,-e.canvas.height/2,-e.canvas.width/2,e.canvas.height,e.canvas.width),this.updateSaveContext(e)},d.prototype.exportFlip=function(e,i,t){e.clearRect(0,0,e.canvas.width,e.canvas.height),i&&(e.translate(e.canvas.width,0),e.scale(-1,1)),t&&(e.translate(0,e.canvas.height),e.scale(1,-1)),e.drawImage(this.parent.inMemoryCanvas,0,0),this.updateSaveContext(e)},d.prototype.updateSaveContext=function(e){var i=this.parent.inMemoryCanvas.getContext("2d");e.setTransform(1,0,0,1,0,0);var t=e.getImageData(0,0,e.canvas.width,e.canvas.height);this.parent.inMemoryCanvas.width=t.width,this.parent.inMemoryCanvas.height=t.height,i.putImageData(t,0,0)},d.prototype.setMaxDim=function(e,i){var t,r;e%90===0&&e%180!==0?C(this.parent.currSelectionPoint)?(t=this.parent.baseImgCanvas.height,r=this.parent.baseImgCanvas.width):(t=this.parent.img.srcHeight,r=this.parent.img.srcWidth):(e%180===0||e===0)&&(C(this.parent.currSelectionPoint)?(t=this.parent.baseImgCanvas.width,r=this.parent.baseImgCanvas.height):(t=this.parent.img.srcWidth,r=this.parent.img.srcHeight)),C(this.parent.aspectWidth)||(t=this.parent.aspectWidth,r=this.parent.aspectHeight),i.width=t,i.height=r;var o={width:0,height:0};this.parent.notify("transform",{prop:"calcMaxDimension",onPropertyChange:!1,value:{width:t,height:r,obj:o,isImgShape:null}});var a=o;i.style.maxWidth=a.width+"px",i.style.maxHeight=a.height+"px"},d}(),pi=function(){function d(e){this.adjustmentLevel={brightness:0,contrast:0,hue:0,opacity:100,saturation:0,blur:0,exposure:0,transparency:100,sharpen:!1,bw:!1},this.tempAdjustmentLevel={brightness:0,contrast:0,hue:0,opacity:100,saturation:0,blur:0,exposure:0,transparency:100,sharpen:!1,bw:!1},this.adjustmentValue="",this.isBrightnessAdjusted=!1,this.bevelFilter="none",this.tempAdjVal={brightness:0,contrast:0,hue:0,opacity:100,saturation:0,blur:0,exposure:0,transparency:100,sharpen:!1,bw:!1},this.tempFilVal="",this.parent=e,this.addEventListener()}return d.prototype.destroy=function(){this.parent.isDestroyed||this.removeEventListener()},d.prototype.addEventListener=function(){this.parent.on("filter",this.filter,this),this.parent.on("destroyed",this.destroy,this)},d.prototype.removeEventListener=function(){this.parent.off("filter",this.filter),this.parent.off("destroyed",this.destroy)},d.prototype.filter=function(e){switch(this.updatePrivateVariables(),e.prop){case"finetuneImage":this.finetuneImage(e.value.option,e.value.value);break;case"applyImageFilter":this.setFilter(e.value.option);break;case"update-finetunes":this.updateFinetunes();break;case"set-adjustment":this.setAdjustment(e.value.operation);break;case"initFilter":this.initFilter();break;case"setCurrAdjValue":this.setCurrAdjValue(e.value.type,e.value.value);break;case"updateAdj":this.updateAdj(e.value.type,e.value.value,e.value.isPreview,e.value.ctx);break;case"getCurrentObj":this.getCurrentObj(e.value.object);break;case"getAdjustmentLevel":C(this.parent.activeObj.opacity)?this.adjustmentLevel.transparency=100:this.adjustmentLevel.transparency=this.parent.activeObj.opacity*100,e.value.obj.adjustmentLevel=this.adjustmentLevel;break;case"setAdjustmentLevel":this.adjustmentLevel=e.value.adjustmentLevel;break;case"getTempAdjustmentLevel":e.value.obj.tempAdjustmentLevel=this.tempAdjustmentLevel;break;case"setTempAdjustmentLevel":this.tempAdjustmentLevel=e.value.tempAdjustmentLevel;break;case"setAdjustmentValue":this.adjustmentValue=e.value.adjustmentValue;break;case"setBrightnessAdjusted":this.isBrightnessAdjusted=e.value.isBrightnessAdjusted,this.parent.currentFilter.split("_")&&this.parent.currentFilter.split("_")[1]==="cold"&&(this.isBrightnessAdjusted=!1);break;case"getBevelFilter":e.value.obj.bevelFilter=this.bevelFilter;break;case"setBevelFilter":this.bevelFilter=e.value.bevelFilter;break;case"setTempAdjVal":this.tempAdjVal=f({},this.adjustmentLevel,{},!0);break;case"setTempFilVal":this.tempFilVal=this.parent.currentFilter;break;case"reset":this.reset();break;case"apply-filter":this.applyFilter(e.value.context);break}},d.prototype.updatePrivateVariables=function(){var e=this.parent;e.lowerCanvas&&(this.lowerContext=e.lowerCanvas.getContext("2d"))},d.prototype.getModuleName=function(){return"filter"},d.prototype.reset=function(){this.adjustmentLevel={brightness:0,contrast:0,hue:0,opacity:100,saturation:0,blur:0,exposure:0,transparency:100,sharpen:!1,bw:!1},this.tempAdjustmentLevel={brightness:0,contrast:0,hue:0,opacity:100,saturation:0,blur:0,exposure:0,transparency:100,sharpen:!1,bw:!1},this.adjustmentValue=this.parent.getDefaultFilter(),this.isBrightnessAdjusted=!1,this.bevelFilter="none",this.tempFilVal="",this.tempAdjVal={brightness:0,contrast:0,hue:0,opacity:100,saturation:0,blur:0,exposure:0,transparency:100,sharpen:!1,bw:!1}},d.prototype.updateFinetunes=function(){var e=this,i=this.parent,t=i.finetuneSettings;if(t){var r=["brightness","contrast","hue","saturation","exposure","opacity","blur"];r.forEach(function(o){t[o]&&(e.adjustmentLevel[o]=t[o].defaultValue,e.tempAdjustmentLevel[o]=t[o].defaultValue)}),i.notify("draw",{prop:"isInitialLoading",onPropertyChange:!1,value:{isInitialLoading:!0}})}},d.prototype.initFilter=function(){this.setFilterAdj("brightness",this.adjustmentLevel.brightness),this.setFilterAdj("contrast",this.adjustmentLevel.contrast),this.setFilterAdj("hue",this.adjustmentLevel.hue),this.setFilterAdj("saturation",this.adjustmentLevel.saturation),this.setFilterAdj("exposure",this.adjustmentLevel.exposure),this.setFilterAdj("opacity",this.adjustmentLevel.opacity),this.setFilterAdj("blur",this.adjustmentLevel.blur)},d.prototype.updateAdj=function(e,i,t,r){var o=this.parent;this.lowerContext.clearRect(0,0,o.lowerCanvas.width,o.lowerCanvas.height);var a=this.lowerContext.filter.split(" "),n=[],s=this.getFilterValue(this.adjustmentLevel.brightness),l,p,h,u,c;switch(e){case"brightness":i=this.getFilterValue(this.adjustmentLevel.exposure)+i*.005,a[0]="brightness("+i+")",this.adjustmentLevel.brightness!==0?(i=this.adjustmentLevel.opacity/100-this.adjustmentLevel.opacity*.3/100,a[4]="opacity("+i+")"):(i=this.adjustmentLevel.opacity/100,a[4]="opacity("+i+")"),this.adjustmentValue=a.join(" ");break;case"contrast":a[1]="contrast("+i+"%)",this.adjustmentValue=a.join(" ");break;case"hue":a[2]="hue-rotate("+i+"deg)",this.adjustmentValue=a.join(" ");break;case"saturation":a[3]="saturate("+i+"%)",this.adjustmentValue=a.join(" ");break;case"opacity":parseFloat(a[0].split("(")[1])!==1&&(i-=.2),i<0&&(i=0),a[4]="opacity("+i+")",this.adjustmentValue=a.join(" ");break;case"blur":a[5]="blur("+i+"px)",this.adjustmentValue=a.join(" ");break;case"exposure":i>1?(i-=1,i+=s):i<1&&(i=1-i,i=s-i),a[0]="brightness("+i+")",this.adjustmentValue=a.join(" ");break;case"chrome":l=this.getSaturationFilterValue(this.adjustmentLevel.saturation),l*=100,i=l+l*.4,a[3]="saturate("+i+"%)",n=this.adjustmentValue.split(" "),a[0]=n[0],a[1]=n[1],a[2]=n[2],a[4]=n[4],a[5]=n[5],a[6]="sepia(0%)",a[7]="grayscale(0%)",a[8]="invert(0%)";break;case"cold":p=this.getFilterValue(this.adjustmentLevel.brightness),p*=100,i=p*.9,i*=.01,a[0]="brightness("+i+")",u=this.getFilterValue(this.adjustmentLevel.contrast),u*=100,i=u+u*.5,a[1]="contrast("+i+"%)",c=this.getSaturationFilterValue(this.adjustmentLevel.saturation),c*=100,i=c,a[3]="saturate("+i+"%)",n=this.adjustmentValue.split(" "),a[2]=n[2],a[4]=n[4],a[5]=n[5],a[6]="sepia(0%)",a[7]="grayscale(0%)",a[8]="invert(0%)";break;case"warm":h=this.getSaturationFilterValue(this.adjustmentLevel.saturation),h*=100,i=h+h*.4,a[3]="saturate("+i+"%)",a[6]="sepia(25%)",n=this.adjustmentValue.split(" "),a[0]=n[0],a[1]=n[1],a[2]=n[2],a[4]=n[4],a[5]=n[5],a[7]="grayscale(0%)",a[8]="invert(0%)";break;case"grayscale":a[7]="grayscale(100%)",n=this.adjustmentValue.split(" "),a[0]=n[0],a[1]=n[1],a[2]=n[2],a[3]=n[3],a[4]=n[4],a[5]=n[5],a[6]="sepia(0%)",a[8]="invert(0%)";break;case"sepia":a[6]="sepia(100%)",n=this.adjustmentValue.split(" "),a[0]=n[0],a[1]=n[1],a[2]=n[2],a[3]=n[3],a[4]=n[4],a[5]=n[5],a[7]="grayscale(0%)",a[8]="invert(0%)";break;case"invert":a[8]="invert(100%)",n=this.adjustmentValue.split(" "),a[0]=n[0],a[1]=n[1],a[2]=n[2],a[3]=n[3],a[4]=n[4],a[5]=n[5],a[6]="sepia(0%)",a[7]="grayscale(0%)";break}if(e!=="sharpen"&&e!=="blackandwhite"){C(t)&&(e==="default"&&(a=this.getDefaultCurrentFilter(a)),this.lowerContext.filter=a.join(" ")),a=this.setTempFilterValue(s,t,a,e),o.notify("draw",{prop:"setRotateZoom",onPropertyChange:!1,value:{isRotateZoom:!0}}),o.notify("draw",{prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"initial",isPreventDestination:null,isRotatePan:null}});var g=void 0;o.frameObj.type==="bevel"&&(g=this.lowerContext.filter,this.bevelFilter=g),o.transform.degree===0&&o.rotateFlipColl.length>0&&(o.img.destLeft+=o.panPoint.totalPannedPoint.x,o.img.destTop+=o.panPoint.totalPannedPoint.y),o.img.destLeft+=o.panPoint.totalPannedInternalPoint.x,o.img.destTop+=o.panPoint.totalPannedInternalPoint.y,o.transform.degree===0&&o.notify("transform",{prop:"setDestPointsForFlipState",onPropertyChange:!1}),o.notify("draw",{prop:"drawImage",onPropertyChange:!1}),o.notify("draw",{prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"reverse",isPreventDestination:null,isRotatePan:null}}),o.notify("draw",{prop:"setRotateZoom",onPropertyChange:!1,value:{isRotateZoom:!1}}),o.transform.degree===0&&o.rotateFlipColl.length>0&&(o.img.destLeft+=o.panPoint.totalPannedPoint.x,o.img.destTop+=o.panPoint.totalPannedPoint.y),a=this.setTempFilterValue(s,t,a,e),C(t)&&(this.lowerContext.filter=a.join(" ")),o.initialAdjustmentValue=a.join(" "),g=this.lowerContext.filter,this.lowerContext.filter="brightness(1) contrast(100%) hue-rotate(0deg) saturate(100%) opacity(1) blur(0px) sepia(0%) grayscale(0%) invert(0%)",this.bevelFilter=g,o.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"iterate",pen:"iterate",isPreventApply:null}}),this.lowerContext.filter=g,o.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),(o.currSelectionPoint&&o.currSelectionPoint.shape==="crop-circle"||o.isCircleCrop)&&o.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),this.isBrightnessAdjusted=s!==1}var v=a.join(" ");r&&(r.filter=v)},d.prototype.setTempFilterValue=function(e,i,t,r){if(i){if(r==="default")t=this.getDefaultCurrentFilter(t);else if(e!==1){var o=this.lowerContext.filter.split(" ");o[4]=t[4],this.lowerContext.filter=o.join(" ")}}return t},d.prototype.getDefaultCurrentFilter=function(e){var i=this.adjustmentValue.split(" ");return e=[i[0],i[1],i[2],i[3],i[4],i[5],"sepia(0%)","grayscale(0%)","invert(0%)"],e},d.prototype.getFilterValue=function(e){return e===0?1:1+e*.5/100},d.prototype.getSaturationFilterValue=function(e){return e===0?1:1+e/100},d.prototype.setFilterAdj=function(e,i){var t=this.parent;switch(t.notify("freehand-draw",{prop:"apply-pen-draw",onPropertyChange:!1}),this.adjustmentLevel[""+e]=i,e){case"contrast":case"exposure":i=this.getFilterValue(i),e==="contrast"&&(i*=100);break;case"hue":i*=3;break;case"saturation":i=this.getSaturationFilterValue(i)*100;break;case"opacity":i<10&&(i+=1),i/=100;break;case"blur":i!==0&&(i/=20,i+=.5);break}var r=f({},t.cropObj,{},!0),o=this.getCurrentObj();o.objColl=f([],t.objColl,[],!0),o.pointColl=f([],t.pointColl,[],!0),o.afterCropActions=f([],t.afterCropActions,[],!0);var a={selPointColl:null};t.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:a}}),o.selPointColl=f([],a.selPointColl,[],!0),this.updateAdj(e,i),t.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:e,previousObj:o,previousObjColl:o.objColl,previousPointColl:o.pointColl,previousSelPointColl:o.selPointColl,previousCropObj:r,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}})},d.prototype.setFilter=function(e){var i=this.parent;e=e.toLowerCase(),i.notify("freehand-draw",{prop:"apply-pen-draw",onPropertyChange:!1});var t={currentFilter:this.parent.currentFilter},r=t.currentFilter,o=f({},i.cropObj,{},!0),a=this.getCurrentObj();a.objColl=f([],i.objColl,[],!0),a.pointColl=f([],i.pointColl,[],!0),a.afterCropActions=f([],i.afterCropActions,[],!0);var n={selPointColl:null};i.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:n}}),a.selPointColl=f([],n.selPointColl,[],!0),this.updateAdj(e,null),i.notify("draw",{prop:"setImageEdited",onPropertyChange:!1}),i.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:e,previousObj:a,previousObjColl:a.objColl,previousPointColl:a.pointColl,previousSelPointColl:a.selPointColl,previousCropObj:o,previousText:null,currentText:null,previousFilter:r,isCircleCrop:null}})},d.prototype.setAdjustment=function(e){var i=this.lowerContext.filter.split(" "),t,r;switch(e){case"brightness":r=i[0].split("("),t=parseFloat(r[1].split(")")[0]),this.adjustmentLevel.brightness=this.setFilterValue(t);break;case"contrast":r=i[1].split("("),t=parseFloat(r[1].split(")")[0]),t/=100,this.adjustmentLevel.contrast=this.setFilterValue(t);break;case"hue":r=i[2].split("("),t=parseFloat(r[1].split(")")[0]),t/=3,this.adjustmentLevel.hue=t;break;case"saturation":r=i[3].split("("),t=parseFloat(r[1].split(")")[0]),t/=100,this.adjustmentLevel.saturation=this.setSaturationFilterValue(t);break;case"opacity":r=i[4].split("("),t=parseFloat(r[1].split(")")[0]),t===.45?t=40:t===.4?t=30:t===.35?t=20:t===.3?t=10:t===.25?t=0:t*=100,this.adjustmentLevel.opacity=t;break;case"blur":r=i[5].split("("),t=parseFloat(r[1].split(")")[0]),t*=20,this.adjustmentLevel.blur=t;break;case"exposure":r=i[0].split("("),t=parseFloat(r[1].split(")")[0]),this.adjustmentLevel.exposure=this.setFilterValue(t);break}},d.prototype.setFilterValue=function(e){return Math.round(e===1?0:(e-1)*100/.5)},d.prototype.setSaturationFilterValue=function(e){return Math.round(e===1?0:(e-1)*100)},d.prototype.finetuneImage=function(e,i){var t=this.parent;if(!t.disabled&&t.isImageLoaded){switch(e.toLowerCase()){case"brightness":this.setFilterAdj("brightness",i);break;case"contrast":this.setFilterAdj("contrast",i);break;case"hue":this.setFilterAdj("hue",i);break;case"saturation":this.setFilterAdj("saturation",i);break;case"opacity":this.setFilterAdj("opacity",i);break;case"blur":this.setFilterAdj("blur",i);break;case"exposure":this.setFilterAdj("exposure",i);break}this.parent.canvasFilter=this.lowerContext.filter,t.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}})}},d.prototype.setCurrAdjValue=function(e,i){var t=this.parent;switch(this.parent.notify("draw",{prop:"setImageEdited",onPropertyChange:!1}),e){case"brightness":this.setFilterAdj("brightness",i);break;case"contrast":this.setFilterAdj("contrast",i);break;case"hue":this.setFilterAdj("hue",i);break;case"saturation":this.setFilterAdj("saturation",i);break;case"opacity":this.setFilterAdj("opacity",i);break;case"blur":this.setFilterAdj("blur",i);break;case"exposure":this.setFilterAdj("exposure",i);break}t.isFinetuneBtnClick=!0,t.curFinetuneObjEvent={finetune:t.toPascalCase(e),value:i}},d.prototype.getCurrentObj=function(e){var i=this.parent,t={point:null};i.notify("crop",{prop:"getTempFlipPanPoint",value:{obj:t}});var r={previousZoomValue:null};i.notify("transform",{prop:"getPreviousZoomValue",value:{obj:r}});var o={zoomFactor:null};i.notify("draw",{prop:"getStraightenInitZoom",value:{obj:o}});var a={color:null};i.notify("draw",{prop:"getImageBackgroundColor",value:{obj:a}});var n={cropZoom:0,defaultZoom:0,totalPannedPoint:{x:0,y:0},totalPannedClientPoint:{x:0,y:0},totalPannedInternalPoint:{x:0,y:0},tempFlipPanPoint:{x:0,y:0},activeObj:{},rotateFlipColl:[],degree:0,currFlipState:"",zoomFactor:0,previousZoomValue:0,straighten:0,destPoints:{startX:0,startY:0,width:0,height:0},frame:"none",srcPoints:{startX:0,startY:0,width:0,height:0},filter:"",isBrightAdjust:this.isBrightnessAdjusted,aspectWidth:null,aspectHeight:null,straightenZoom:0,adjustmentLevel:f({},this.tempAdjVal,{},!0),currentFilter:this.tempFilVal,imageSource:"",bgColor:""};return n.cropZoom=i.transform.cropZoomFactor,n.defaultZoom=i.transform.defaultZoomFactor,n.zoomFactor=i.zoomSettings.zoomFactor,n.previousZoomValue=r.previousZoomValue,n.straightenZoom=o.zoomFactor,n.totalPannedPoint=f({},i.panPoint.totalPannedPoint,{},!0),n.totalPannedClientPoint=f({},i.panPoint.totalPannedClientPoint,{},!0),n.totalPannedInternalPoint=f({},i.panPoint.totalPannedInternalPoint,{},!0),n.tempFlipPanPoint=f({},t.point,{},!0),n.activeObj=f({},i.activeObj,{},!0),n.rotateFlipColl=f([],i.rotateFlipColl,[],!0),n.degree=i.transform.degree,n.straighten=i.cropObj.straighten,n.currFlipState=i.transform.currFlipState,n.destPoints={startX:i.img.destLeft,startY:i.img.destTop,endX:0,endY:0,width:i.img.destWidth,height:i.img.destHeight},n.srcPoints={startX:i.img.srcLeft,startY:i.img.srcTop,endX:0,endY:0,width:i.img.srcWidth,height:i.img.srcHeight},n.filter=this.lowerContext.filter,n.aspectWidth=i.aspectWidth,n.aspectHeight=i.aspectHeight,n.frame=i.frameObj.type,n.frameObj=f({},i.frameObj),n.imageSource=i.baseImg.src,n.bgColor=a.color,e&&(e.currObj=n),n},d.prototype.getValFromPercentage=function(e){var i=parseFloat(e);return/%\s*?$/i.test(e)&&(i/=100),i},d.prototype.getValFromLength=function(e){return parseFloat(e)},d.prototype.parseFilterString=function(e){var i=[];return e&&e!=="none"&&(i=e.split(" ").map(function(t){var r=t.match(/([a-z-]+)\(([^)]+)\)/).slice(1,3),o=r[0],a=r[1];return{filter:o,value:a}})),i},d.prototype.applyFilter=function(e){for(var i=e.canvas,t=i.height,r=i.width,o=e.getImageData(0,0,r,t),a=this.parseFilterString(e.filter),n=0,s=a.length;n<s;n++)switch(a[n].filter){case"blur":o=this.blur(e,o,a[n].value);break;case"brightness":o=this.brightness(o,a[n].value);break;case"contrast":o=this.contrast(o,a[n].value);break;case"grayscale":o=this.grayscale(o,a[n].value);break;case"hue-rotate":o=this.hueRotate(o,a[n].value);break;case"invert":o=this.invert(o,a[n].value);break;case"opacity":o=this.opacity(o,a[n].value);break;case"saturate":o=this.saturate(e,o,a[n].value);break;case"sepia":o=this.sepia(o,a[n].value);break}e.putImageData(o,0,0)},d.prototype.blur=function(e,i,t){t===void 0&&(t="0");var r=this.getValFromLength(t);if(r=Math.floor(r),r<=0)return i;for(var o=e.canvas,a=o.height,n=o.width,s=i.data,l=new Uint8ClampedArray(s.length),p=0;p<a;p++)for(var h=0;h<n;h++){for(var u=0,c=0,g=0,v=0,b=0,m=-r;m<=r;m++)for(var y=-r;y<=r;y++){var P=h+y,S=p+m;if(P>=0&&P<n&&S>=0&&S<a){var O=(S*n+P)*4;u+=s[O],c+=s[O+1],g+=s[O+2],v+=s[O+3],b++}}var j=(p*n+h)*4;l[j]=u/b,l[j+1]=c/b,l[j+2]=g/b,l[j+3]=v/b}for(var j=0;j<s.length;j++)s[j]=l[j];return i},d.prototype.brightness=function(e,i){i===void 0&&(i="1");var t=this.getValFromPercentage(i);if(t!==1)for(var r=e.data,o=r.length,a=0;a<o;a+=4)r[a+0]*=t,r[a+1]*=t,r[a+2]*=t;return e},d.prototype.contrast=function(e,i){i===void 0&&(i="1");var t=this.getValFromPercentage(i);if(t!==1)for(var r=e.data,o=r.length,a=0;a<o;a+=4)r[a+0]=((r[a+0]/255-.5)*t+.5)*255,r[a+1]=((r[a+1]/255-.5)*t+.5)*255,r[a+2]=((r[a+2]/255-.5)*t+.5)*255;return e},d.prototype.grayscale=function(e,i){i===void 0&&(i="0");var t=this.getValFromPercentage(i);if(t>0)for(var r=e.data,o=r.length,a=0;a<o;a+=4){var n=r[a],s=r[a+1],l=r[a+2],p=.299*n+.587*s+.114*l;r[a]=n*(1-t)+p*t,r[a+1]=s*(1-t)+p*t,r[a+2]=l*(1-t)+p*t}return e},d.prototype.hueRotate=function(e,i){i===void 0&&(i="0deg");var t=e.data,r=parseFloat(i)*(Math.PI/180);if(r>0)for(var o=Math.cos(r),a=Math.sin(r),n=[.213+o*.787-a*.213,.715-o*.715-a*.715,.072-o*.072+a*.928,.213-o*.213+a*.143,.715+o*.285+a*.14,.072-o*.072-a*.283,.213-o*.213-a*.787,.715-o*.715+a*.715,.072+o*.928+a*.072],s=0;s<t.length;s+=4){var l=t[s],p=t[s+1],h=t[s+2];t[s]=n[0]*l+n[1]*p+n[2]*h,t[s+1]=n[3]*l+n[4]*p+n[5]*h,t[s+2]=n[6]*l+n[7]*p+n[8]*h}return e},d.prototype.invert=function(e,i){i===void 0&&(i="0");var t=this.getValFromPercentage(i);if(t>0)for(var r=e.data,o=r.length,a=0;a<o;a+=4)r[a+0]=Math.abs(r[a+0]-255*t),r[a+1]=Math.abs(r[a+1]-255*t),r[a+2]=Math.abs(r[a+2]-255*t);return e},d.prototype.opacity=function(e,i){i===void 0&&(i="0");var t=this.getValFromPercentage(i);if(t>=0)for(var r=e.data,o=r.length,a=3;a<o;a+=4)r[a]*=t;return e},d.prototype.saturate=function(e,i,t){t===void 0&&(t="0");var r=this.getValFromPercentage(t);if(r!==1)for(var o=e.canvas,a=o.width,n=o.height,s=i.data,l=(1-r)*.3086,p=(1-r)*.6094,h=(1-r)*.082,u=a<<2,c=0;c<n;c++)for(var g=c*u,v=0;v<a;v++){var b=g+(v<<2),m=s[b+0],y=s[b+1],P=s[b+2];s[b+0]=(l+r)*m+p*y+h*P,s[b+1]=l*m+(p+r)*y+h*P,s[b+2]=l*m+p*y+(h+r)*P}return i},d.prototype.sepia=function(e,i){i===void 0&&(i="0");var t=this.getValFromPercentage(i);if(t>1&&(t=1),t>0)for(var r=e.data,o=r.length,a=0;a<o;a+=4){var n=r[a+0],s=r[a+1],l=r[a+2];r[a+0]=(.393*n+.769*s+.189*l)*t+n*(1-t),r[a+1]=(.349*n+.686*s+.168*l)*t+s*(1-t),r[a+2]=(.272*n+.534*s+.131*l)*t+l*(1-t)}return e},d}(),hi=function(){function d(e){this.fhdObj={lastWidth:0,lastVelocity:0,time:0,pointX:0,pointY:0},this.isFreehandDrawing=!1,this.freehandDownPoint={x:0,y:0},this.isFreehandPointMoved=!1,this.pointCounter=0,this.selPointColl={},this.currFHDIdx=0,this.selPoints=[],this.dummyPoints=[],this.tempFHDStyles={strokeColor:null,fillColor:null,strokeWidth:null},this.straightenPoint={x:null,y:null,ratioX:null,ratioY:null},this.straightenPointAngle=0,this.isMasking=!1,this.parent=e,this.addEventListener()}return d.prototype.destroy=function(){this.parent.isDestroyed||this.removeEventListener()},d.prototype.addEventListener=function(){this.parent.on("freehand-draw",this.draw,this),this.parent.on("destroyed",this.destroy,this)},d.prototype.removeEventListener=function(){this.parent.off("freehand-draw",this.draw),this.parent.off("destroyed",this.destroy)},d.prototype.draw=function(e){switch(this.updateFhdPvtVar(),e.prop){case"hoverFhd":{this.hoverFhd(e.value.strokeColor,e.value.strokeWidth);break}case"freehandDownHandler":this.freehandDownHandler(e.value.e,e.value.canvas);break;case"freehandUpHandler":this.freehandUpHandler(e.value.e,e.value.canvas,e.value.context);break;case"handle-freehand-draw":{var i=parseInt(e.value.id.split("_")[1],10)-1;this.isFHDIdx(i)&&this.deleteFhd(i,!0);break}case"freehandRedraw":this.freehandRedraw(e.value.context,e.value.points);break;case"deleteFhd":{var i=parseInt(e.value.id.split("_")[1],10)-1;this.deleteFhd(i,!0);break}case"selectFhd":{var i=null;e.value.id&&(i=parseInt(e.value.id.split("_")[1],10)-1),this.selectFhd(i);break}case"applyFhd":this.applyFhd();break;case"cancelFhd":this.cancelFhd();break;case"updateFHDCurPts":this.updateFHDCurPts();break;case"rotateFhdColl":this.rotateFhdColl();break;case"flipFHDColl":this.flipFHDColl(e.value.value);break;case"panFHDColl":this.panFHDColl(e.value.xDiff,e.value.yDiff,e.value.panRegion);break;case"updateFHDColl":e.value&&e.value.isPreventApply?this.updateFHDColl(e.value.isPreventApply):this.updateFHDColl();break;case"zoomFHDColl":this.zoomFHDColl(e.value.isPreventApply);break;case"apply-pen-draw":this.applyPenDraw();break;case"freeHandDraw":this.freeHandDraw(e.value.value);break;case"isFHDIdx":this.isFHDIdx(e.value.index,e.value.obj);break;case"getSqPtFD":this.getSqPtFD(e.value.idx,e.value.obj);break;case"getSelPointColl":e.value.obj.selPointColl=f([],this.selPointColl);break;case"setSelPointColl":this.selPointColl=f([],e.value.obj.selPointColl);break;case"pushSelPointColl":this.selPointColl.push(f([],e.value.obj.selPointColl));break;case"setFreehandDrawHoveredIndex":this.fhdHovIdx=e.value.index;break;case"getFreehandDrawHoveredIndex":e.value.obj.index=this.fhdHovIdx;break;case"setPointCounter":this.pointCounter=e.value.value;break;case"getPenStrokeWidth":e.value.obj.penStrokeWidth=this.penStrokeWidth;break;case"setPenStrokeWidth":this.penStrokeWidth=e.value.value;break;case"getCurrentFreehandDrawIndex":e.value.obj.currentFreehandDrawIndex=this.currFHDIdx;break;case"setCurrentFreehandDrawIndex":this.currFHDIdx=e.value.value;break;case"updateCropPtsForSel":this.updateCropPtsForSel();break;case"getFreehandDrawSelectedId":e.value.obj.freehandDrawSelectedId=this.fhdSelID;break;case"resetFreehandDrawSelectedId":this.fhdSelID=null;break;case"getTempFreeHandDrawEditingStyles":e.value.obj.tempFreeHandDrawEditingStyles=this.tempFHDStyles;break;case"setFreehandSelectedIndex":this.fhdSelIdx=e.value.index;break;case"getFreehandSelectedIndex":e.value.obj.freehandSelectedIndex=this.fhdSelIdx;break;case"setCenterSelPoints":this.setCenterSelPoints();break;case"getStraightenPoint":e.value.obj.straightenPoint=f({},this.straightenPoint,{},!0);break;case"setStraightenPoint":this.straightenPoint.x=e.value.x,this.straightenPoint.y=e.value.y,e.value.ratioX&&e.value.ratioY&&(this.straightenPoint.ratioX=e.value.ratioX,this.straightenPoint.ratioY=e.value.ratioY);break;case"resetStraightenPoint":this.straightenPoint={x:null,y:null,ratioX:null,ratioY:null},this.prevStraightenObj=null,this.straightenPointAngle=0;break;case"getStraightenPointAngle":e.value.obj.angle=this.straightenPointAngle;break;case"reset":this.reset();break;case"triggerShapeChanging":this.triggerShapeChanging(e.value.shapeChangingArgs);break;case"setMasking":this.isMasking=e.value.value;break;case"resetSelPoints":this.selPoints=[];break}},d.prototype.updateFhdPvtVar=function(){var e=this.parent;e.lowerCanvas&&(this.lowerContext=e.lowerCanvas.getContext("2d")),e.upperCanvas&&(this.upperContext=e.upperCanvas.getContext("2d"))},d.prototype.reset=function(){this.fhdObj={lastWidth:0,lastVelocity:0,time:0,pointX:0,pointY:0},this.isFreehandDrawing=this.isFreehandPointMoved=!1,this.selPoints=[],this.dummyPoints=[],this.freehandDownPoint={x:0,y:0},this.selPointColl={},this.straightenPointAngle=0,this.fhdHovIdx=null,this.pointCounter=0,this.fhdSelID=null,this.isMasking=!1,this.penStrokeWidth=void 0,this.currFHDIdx=0,this.fhdSelIdx=null,this.tempFHDStyles={strokeColor:null,fillColor:null,strokeWidth:null},this.straightenPoint={x:null,y:null,ratioX:null,ratioY:null},this.prevStraightenObj=null},d.prototype.getModuleName=function(){return"freehand-draw"},d.prototype.hoverFhd=function(e,i){var t=this.parent,r=this.upperContext,o=-1;this.fhdHovIdx>-1?o=this.fhdHovIdx:o=this.fhdSelIdx,t.points=f([],t.pointColl[o].points),this.pointCounter=0;var a=t.points.length,n,s,l,p,h=0,u=0;r.fillStyle=e||t.pointColl[o].strokeColor,r.strokeStyle=r.fillStyle,h=u=this.penStrokeWidth=i||t.pointColl[o].strokeWidth,a===1&&(n=s=l=p=t.points[0],this.startDraw(r,n,s,l,p,h,u));for(var c=0;c<a-3;c++)t.points[c+1]&&t.points[c+2]&&t.points[c+2]&&(n=this.calcCurveCP(t.points[c+0],t.points[c+1],t.points[c+2]).controlPoint2,s=this.calcCurveCP(t.points[c+1],t.points[c+2],t.points[c+3]).controlPoint1,c===0?l=t.points[c]:l=t.points[c+1],p=t.points[c+2],this.startDraw(r,n,s,l,p,h,u));r.closePath();var g=this.getSqPtFD(o),v=r.lineWidth;r.lineWidth=2,r.strokeStyle=t.themeColl[t.theme].primaryColor,r.beginPath(),r.rect(g.startX,g.startY,g.width,g.height),r.stroke(),r.closePath(),r.lineWidth=v},d.prototype.freehandDownHandler=function(e,i){var t=this.parent;t.lowerCanvas=document.querySelector("#"+t.element.id+"_lowerCanvas"),this.lowerContext=t.lowerCanvas.getContext("2d"),t.upperCanvas=document.querySelector("#"+t.element.id+"_upperCanvas"),this.upperContext=t.upperCanvas.getContext("2d"),this.fhdObj.time=new Date().getTime(),this.isFreehandDrawing=!0,e.type==="mousedown"?this.freehandDownPoint={x:e.clientX,y:e.clientY}:this.freehandDownPoint={x:e.touches[0].clientX,y:e.touches[0].clientY},this.isFreehandPointMoved=!1,I.add(i,"mousemove touchmove",this.freehandMoveHandler,this);var r={id:"pen_"+(this.currFHDIdx+1),type:se.FreehandDraw,startX:this.freehandDownPoint.x,startY:this.freehandDownPoint.y,strokeColor:t.activeObj.strokeSettings.strokeColor,strokeWidth:this.penStrokeWidth,points:null,index:t.objColl.length+t.freehandCounter+1},o={cancel:!1,action:"draw-start",previousShapeSettings:r,currentShapeSettings:r};this.triggerShapeChanging(o)},d.prototype.freehandUpHandler=function(e,i,t){var r=i.getBoundingClientRect(),o=this.parent;I.remove(i,"mousemove touchmove",this.freehandMoveHandler),o.points.length===0&&(e.type==="mouseup"?this.processPoint(e.clientX-r.left,e.clientY-r.top,!0,t):e.type==="touchend"&&e.changedTouches?this.processPoint(e.changedTouches[0].clientX-r.left,e.changedTouches[0].clientY-r.top,!0,t):this.isFreehandPointMoved||this.processPoint(this.freehandDownPoint.x-r.left,this.freehandDownPoint.y-r.top,!0,t)),t.closePath();var a=f({},o.cropObj,{},!0),n={currObj:{}};o.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:n}});var s=n.currObj;s.objColl=f([],o.objColl,[],!0),s.pointColl=f([],o.pointColl,[],!0),s.afterCropActions=f([],o.afterCropActions,[],!0);var l={selPointColl:null};o.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:l}}),s.selPointColl=f([],l.selPointColl,[],!0);var p=o.freehandCounter,h=o.objColl.length+o.freehandCounter+1;o.pointColl[p]={points:f([],o.points),strokeColor:o.activeObj.strokeSettings.strokeColor,strokeWidth:this.penStrokeWidth,flipState:o.transform.currFlipState,id:"pen_"+(this.currFHDIdx+1),order:h},o.points=[],this.dummyPoints=[],this.selPointColl[p]={points:f([],this.selPoints)},this.selPoints=[],this.pointCounter=0,o.freehandCounter++,this.isFreehandDrawing=!1,o.isMaskImage||o.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"freehand-draw",previousObj:s,previousObjColl:s.objColl,previousPointColl:s.pointColl,previousSelPointColl:s.selPointColl,previousCropObj:a,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}});var u={id:"pen_"+(this.currFHDIdx+1),type:se.FreehandDraw,startX:this.freehandDownPoint.x,startY:this.freehandDownPoint.y,strokeColor:o.activeObj.strokeSettings.strokeColor,strokeWidth:this.penStrokeWidth,points:o.pointColl[this.currFHDIdx].points,index:h},c={cancel:!1,action:"draw-end",previousShapeSettings:u,currentShapeSettings:u};this.triggerShapeChanging(c),this.currFHDIdx++},d.prototype.freehandMoveHandler=function(e){this.isFreehandPointMoved=!0;var i=this.parent.upperCanvas.getBoundingClientRect(),t,r;e.type==="mousemove"?(t=e.clientX-i.left,r=e.clientY-i.top):(t=e.touches[0].clientX-i.left,r=e.touches[0].clientY-i.top),this.isFreehandDrawing&&(this.upperContext.fillStyle=this.parent.activeObj.strokeSettings.strokeColor,this.parent.isMaskImage&&(this.upperContext.globalCompositeOperation="xor"),this.processPoint(t,r,!1,this.upperContext))},d.prototype.processPoint=function(e,i,t,r){var o=this.parent,a=this.point(e,i,new Date().getTime());a=o.points.length>0&&o.points[o.points.length-1];var n=a?this.distanceTo(a)<=5:!1,s,l,p,h;if(this.selPoints.push({x:e,y:i,ratioX:(e-o.img.destLeft)/o.img.destWidth,ratioY:(i-o.img.destTop)/o.img.destHeight,time:this.fhdObj.time}),!a||!(a&&n)||t){if(this.fhdObj.time=new Date().getTime(),o.points.push({x:e,y:i,ratioX:(e-o.img.destLeft)/o.img.destWidth,ratioY:(i-o.img.destTop)/o.img.destHeight,time:this.fhdObj.time}),this.dummyPoints.push({x:e,y:i,ratioX:(e-o.img.destLeft)/o.img.destWidth,ratioY:(i-o.img.destTop)/o.img.destHeight,time:this.fhdObj.time}),this.dummyPoints.length>2){this.dummyPoints.length===3&&this.dummyPoints.unshift(this.dummyPoints[0]);var u=this.dummyPoints[0],c=this.dummyPoints[1],g=this.dummyPoints[2],v=this.dummyPoints[3];s=this.calcCurveCP(u,c,g).controlPoint2,l=this.calcCurveCP(c,g,v).controlPoint1,p=this.dummyPoints[1],h=this.dummyPoints[2];var b=.5,m=5;C(this.penStrokeWidth)||(b=m=this.penStrokeWidth),this.startDraw(r,s,l,p,h,b,m),this.pointCounter++,this.dummyPoints.shift()}if(t){s=l=p=h={x:e,y:i,time:new Date().getTime()};var b=.5,m=5;C(this.penStrokeWidth)||(b=m=this.penStrokeWidth),this.startDraw(r,s,l,p,h,b,m)}}},d.prototype.calcCurveCP=function(e,i,t){i||(i=e),t||(t=i);var r=e.x-i.x,o=e.y-i.y,a=i.x-t.x,n=i.y-t.y,s={x:(e.x+i.x)/2,y:(e.y+i.y)/2},l={x:(i.x+t.x)/2,y:(i.y+t.y)/2},p=Math.sqrt(r*r+o*o),h=Math.sqrt(a*a+n*n),u=s.x-l.x,c=s.y-l.y,g=h/(p+h),v={x:l.x+u*g,y:l.y+c*g},b=i.x-v.x,m=i.y-v.y;return{controlPoint1:this.point(s.x+b,s.y+m,0),controlPoint2:this.point(l.x+b,l.y+m,0)}},d.prototype.point=function(e,i,t){return this.fhdObj.pointX=e,this.fhdObj.pointY=i,{x:this.fhdObj.pointX,y:this.fhdObj.pointY,time:t}},d.prototype.startDraw=function(e,i,t,r,o,a,n){var s;s=this.pointVelocity(r),s=.7*s+(1-.7)*this.fhdObj.lastVelocity;var l=Math.max(n/(.7+1),a);this.drawCurve(this.fhdObj.time,l,e,i,t,r,o,n),this.fhdObj.lastVelocity=s,this.fhdObj.time=l},d.prototype.pointVelocity=function(e){return this.fhdObj.time!==e.time?this.distanceTo(e)/(this.fhdObj.time-e.time):0},d.prototype.distanceTo=function(e){return Math.sqrt(Math.pow(this.fhdObj.pointX-e.x,2)+Math.pow(this.fhdObj.pointY-e.y,2))},d.prototype.drawCurve=function(e,i,t,r,o,a,n,s){var l,p,h,u,c,g,v,b,m,y,P=i-e,S=this.bezierLength(r,o,a,n),O=Math.ceil(S)*2;for(t.beginPath(),p=0;p<O;p++)h=p/O,u=h*h,c=u*h,g=1-h,v=g*g,b=v*g,m=b*a.x,m+=3*v*h*r.x,m+=3*g*u*o.x,m+=c*n.x,y=b*a.y,y+=3*v*h*r.y,y+=3*g*u*o.y,y+=c*n.y,l=Math.min(e+c*P,s),this.drawArc(m,y,l,t);t.closePath(),t.fill()},d.prototype.bezierLength=function(e,i,t,r){var o=10,a=0,n,s,l,p,h,u,c,g;for(n=0;n<=o;n++)s=n/o,l=this.bezierPoint(s,t.x,e.x,i.x,r.x),p=this.bezierPoint(s,t.y,e.y,i.y,r.y),n>0&&(c=l-h,g=p-u,a+=Math.sqrt(c*c+g*g)),h=l,u=p;return a},d.prototype.bezierPoint=function(e,i,t,r,o){return i*(1-e)*(1-e)*(1-e)+3*t*(1-e)*(1-e)*e+3*r*(1-e)*e*e+o*e*e*e},d.prototype.drawArc=function(e,i,t,r){var o=this.parent.img;(e>o.destLeft&&i>o.destTop&&e<o.destLeft+o.destWidth&&i<o.destTop+o.destHeight||r!==this.lowerContext&&r!==this.upperContext)&&(r.moveTo(e,i),r.arc(e,i,t,0,2*Math.PI,!1))},d.prototype.freehandRedraw=function(e,i){var t=this.parent,r=e.filter;if(e.filter="none",i&&(t.pointColl[t.freehandCounter]={points:i,strokeColor:t.activeObj.strokeSettings.strokeColor,strokeWidth:this.penStrokeWidth,flipState:t.transform.currFlipState,id:"pen_"+(t.freehandCounter+1),order:t.objColl.length+t.freehandCounter+1},this.selPointColl[t.freehandCounter]=f({},t.pointColl[t.freehandCounter],{},!0),t.freehandCounter++),t.freehandCounter>0){for(var o=0;o<t.freehandCounter;o++){t.points=f([],t.pointColl[o].points),this.pointCounter=0;var a=t.points.length,n=void 0,s=void 0,l=void 0,p=void 0,h=void 0,u=void 0;a>0&&(e.fillStyle=t.pointColl[o].strokeColor,h=u=this.penStrokeWidth=t.pointColl[o].strokeWidth),a===1&&(n=s=l=p=t.points[0],this.startDraw(e,n,s,l,p,h,u));for(var c=0;c<a-3;c++)t.points[c+1]&&t.points[c+2]&&t.points[c+2]&&(n=this.calcCurveCP(t.points[c+0],t.points[c+1],t.points[c+2]).controlPoint2,s=this.calcCurveCP(t.points[c+1],t.points[c+2],t.points[c+3]).controlPoint1,c===0?l=t.points[c]:l=t.points[c+1],p=t.points[c+2],this.startDraw(e,n,s,l,p,h,u));e.closePath()}e===this.lowerContext&&(t.notify("draw",{prop:"applyFrame",value:{ctx:this.lowerContext,frame:t.frameObj.type,preventImg:!0}}),this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height))}e.filter=r},d.prototype.getSqPtFD=function(e,i){var t={startX:0,startY:0,endX:0,endY:0,width:0,height:0},r=f([],this.selPointColl[e].points,[]);this.parent.points=f([],this.parent.pointColl[e].points),this.pointCounter=0;for(var o=r.length,a=0;a<o;a++)t.startX===0&&t.startY===0&&t.endX===0&&t.endY===0?(t.startX=r[a].x,t.startY=r[a].y,t.endX=r[a].x,t.endY=r[a].y):(t.startX=Math.min(t.startX,r[a].x),t.startY=Math.min(t.startY,r[a].y),t.endX=Math.max(t.endX,r[a].x),t.endY=Math.max(t.endY,r[a].y));return t.startX-=this.penStrokeWidth,t.startY-=this.penStrokeWidth,t.endX+=this.penStrokeWidth,t.endY+=this.penStrokeWidth,t.width=t.endX-t.startX,t.height=t.endY-t.startY,i&&(i.activePoint=t),t},d.prototype.applyPenDraw=function(){var e=this.parent;e.currObjType.shape==="freehanddraw"&&(e.notify("shape",{prop:"apply",onPropertyChange:!1,value:{shape:null,obj:null,canvas:null}}),e.upperCanvas.style.cursor=e.cursor="default",e.currObjType.shape=""),e.notify("shape",{prop:"clearActObj"})},d.prototype.applyFhd=function(){var e=this.parent,i=e.pointColl[this.fhdSelIdx];i.strokeColor==="#42a5f5"&&(i.strokeColor=this.tempFHDStyles.strokeColor),e.notify("toolbar",{prop:"setSelectedFreehandColor",value:{color:"#42a5f5"}}),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),this.lowerContext.clearRect(0,0,e.lowerCanvas.width,e.lowerCanvas.height),e.notify("draw",{prop:"render-image",value:{isMouseWheel:null}}),e.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1}),i&&(i.isSelected=!1),e.notify("selection",{prop:"resetFreehandDrawVariables"}),this.fhdHovIdx=this.fhdSelIdx=null},d.prototype.cancelFhd=function(){var e=this.parent,i=e.pointColl[this.fhdSelIdx];e.notify("toolbar",{prop:"setSelectedFreehandColor",value:{color:"#42a5f5"}}),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),this.lowerContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),this.pointCounter=0,i&&(i.strokeColor=this.tempFHDStyles.strokeColor,i.strokeWidth=this.tempFHDStyles.strokeWidth,i.isSelected=!1),this.fhdHovIdx=this.fhdSelIdx=this.fhdSelID=null,e.notify("selection",{prop:"resetFreehandDrawVariables"}),e.activeObj.strokeSettings.strokeColor=this.tempFHDStyles.strokeColor,e.activeObj.strokeSettings.strokeWidth=this.penStrokeWidth=this.tempFHDStyles.strokeWidth,this.tempFHDStyles={strokeColor:null,strokeWidth:null,fillColor:null},e.notify("draw",{prop:"render-image",value:{isMouseWheel:null}}),e.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1})},d.prototype.selectFhd=function(e){var i=this.parent,t=f({},this.tempFHDStyles,{},!0);if(i.notify("selection",{prop:"setFreehandDrawEditing",onPropertyChange:!1,value:{bool:!0}}),e||e===0)if(this.isFHDIdx(e))this.fhdSelIdx=this.fhdHovIdx=e,this.hoverFhd(),i.upperCanvas.style.cursor=i.cursor="pointer";else return;this.fhdSelIdx=this.fhdHovIdx;var r=i.pointColl[this.fhdSelIdx];r.isSelected=!0,this.fhdSelID=r.id,r.strokeColor!=="#42a5f5"&&(i.activeObj.strokeSettings.strokeColor=this.tempFHDStyles.strokeColor=r.strokeColor),i.activeObj.strokeSettings.strokeWidth=this.tempFHDStyles.strokeWidth=i.pointColl[this.fhdHovIdx].strokeWidth;var o={bool:!1};if(i.notify("selection",{prop:"getFreehandDrawEditing",onPropertyChange:!1,value:{obj:o}}),o.bool){var a={id:"pen_"+(this.fhdSelIdx+1),type:se.FreehandDraw,startX:r.points[0].x,startY:r.points[0].y,strokeColor:r.strokeColor,strokeWidth:r.strokeWidth,points:r.points,opacity:r.opacity,index:r.order},n={cancel:!1,action:"select",previousShapeSettings:a,currentShapeSettings:a};this.triggerShapeChanging(n)}else i.okBtn(null,!0);i.isUndoRedoStack&&(this.tempFHDStyles=t)},d.prototype.deleteFhd=function(e,i){var t=this.parent;if(this.isFHDIdx(e)){this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height);var r=f({},t.pointColl,{},!0),o=f({},this.selPointColl,{},!0);t.pointColl={},this.selPointColl={};for(var a=0,n=0;n<t.freehandCounter;n++)parseInt(r[n].id.split("_")[1],10)-1!==e&&(t.pointColl[a]=r[n],this.selPointColl[a]=o[n],a++);t.freehandCounter-=1,this.fhdHovIdx=this.fhdSelIdx=null,t.notify("selection",{prop:"resetFreehandDrawVariables"}),t.notify("draw",{prop:"render-image",value:{isMouseWheel:null}}),t.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1})}},d.prototype.zoomX=function(e){return e*this.parent.img.destWidth+this.parent.img.destLeft},d.prototype.zoomY=function(e){return e*this.parent.img.destHeight+this.parent.img.destTop},d.prototype.zoomFHDColl=function(e){var i=this.parent,t={startX:i.img.destLeft,startY:i.img.destTop,width:i.img.destWidth,height:i.img.destHeight};i.notify("shape",{prop:"straightenShapes",onPropertyChange:!1});for(var r=0;r<i.freehandCounter;r++){i.points=f([],i.pointColl[r].points,[]),this.pointCounter=0;for(var o=i.points.length,a=0;a<o;a++){var n=i.points[a];n.x=this.zoomX(n.ratioX),n.y=this.zoomY(n.ratioY)}}this.updateFHDCurPts(),this.straightenPoint.x&&this.straightenPoint.y&&(this.straightenPoint.x=this.zoomX(this.straightenPoint.ratioX),this.straightenPoint.y=this.zoomY(this.straightenPoint.ratioY)),i.transform.straighten!==0&&i.notify("shape",{prop:"straightenFHD",onPropertyChange:!1}),i.img.destLeft=t.startX,i.img.destTop=t.startY,i.img.destWidth=t.width,i.img.destHeight=t.height,C(e)&&this.freehandRedraw(this.lowerContext,null)},d.prototype.updateFHDCurPts=function(){for(var e=this.parent,i=0;i<e.freehandCounter;i++)if(this.selPointColl[i]){this.selPoints=f([],this.selPointColl[i].points,[]),this.pointCounter=0;for(var t=this.selPoints.length,r=0;r<t;r++){var o=this.selPoints[r];o.x=this.zoomX(o.ratioX),o.y=this.zoomY(o.ratioY)}}},d.prototype.rotateFhdColl=function(){for(var e=this.parent,i=e.img,t=i.destLeft,r=i.destTop,o=i.destWidth,a=i.destHeight,n=0;n<e.freehandCounter;n++){e.points=f([],e.pointColl[n].points,[]),this.pointCounter=0;for(var s=e.points.length,l=0;l<s;l++){var p=e.points[l];p.y=r+a*p.ratioX,p.x=t+o-o*p.ratioY,p.ratioX=(p.x-t)/o,p.ratioY=(p.y-r)/a}}for(var n=0;n<e.freehandCounter;n++)if(this.selPointColl[n]){this.selPoints=f([],this.selPointColl[n].points,[]),this.pointCounter=0;for(var s=this.selPoints.length,l=0;l<s;l++){var p=this.selPoints[l];p.y=r+a*p.ratioX,p.x=t+o-o*p.ratioY,p.ratioX=(p.x-t)/o,p.ratioY=(p.y-r)/a}}this.updateFHDCurPts()},d.prototype.flipFHDColl=function(e){var i=e.toLowerCase();if(i==="horizontal")this.pointsHorizontalFlip();else if(i==="vertical")this.pointsVerticalFlip();else{this.pointsHorizontalFlip();for(var t=0;t<this.parent.freehandCounter;t++)this.parent.pointColl[t].shapeFlip="";this.pointsVerticalFlip()}},d.prototype.pointsHorizontalFlip=function(){for(var e=this.parent,i=e.img,t=i.destLeft,r=i.destTop,o=i.destWidth,a=i.destHeight,n=0;n<e.freehandCounter;n++)if(e.pointColl[n].shapeFlip!==e.transform.currFlipState){e.points=f([],e.pointColl[n].points,[]),this.pointCounter=0;for(var s=e.points.length,l=0;l<s;l++){var p=e.points[l];p.x<=t+o/2?p.x=t+o-(p.x-t):p.x>=t+o/2&&(p.x=t+(t+o-p.x)),p.ratioX=(p.x-t)/o,p.ratioY=(p.y-r)/a}e.pointColl[n].shapeFlip=e.transform.currFlipState}for(var n=0;n<e.freehandCounter;n++)if(this.selPointColl[n]&&this.selPointColl[n].shapeFlip!==e.transform.currFlipState){this.selPoints=f([],this.selPointColl[n].points,[]),this.pointCounter=0;for(var s=this.selPoints.length,l=0;l<s;l++){var p=this.selPoints[l];p.x<=t+o/2?p.x=t+o-(p.x-t):p.x>=t+o/2&&(p.x=t+(t+o-p.x)),p.ratioX=(p.x-t)/o,p.ratioY=(p.y-r)/a}}this.updateFHDCurPts()},d.prototype.pointsVerticalFlip=function(){for(var e=this.parent,i=e.img,t=i.destLeft,r=i.destTop,o=i.destWidth,a=i.destHeight,n=0;n<e.freehandCounter;n++)if(e.pointColl[n].shapeFlip!==e.transform.currFlipState){e.points=f([],e.pointColl[n].points,[]),this.pointCounter=0;for(var s=e.points.length,l=0;l<s;l++){var p=e.points[l];p.y<=r+a/2?p.y=r+a-(p.y-r):p.y>=r+a/2&&(p.y=r+(r+a-p.y)),p.ratioX=(p.x-t)/o,p.ratioY=(p.y-r)/a}e.pointColl[n].shapeFlip=e.transform.currFlipState}for(var n=0;n<e.freehandCounter;n++)if(this.selPointColl[n]&&this.selPointColl[n].shapeFlip!==e.transform.currFlipState){this.selPoints=f([],this.selPointColl[n].points,[]),this.pointCounter=0;for(var s=this.selPoints.length,l=0;l<s;l++){var p=this.selPoints[l];p.y<=r+a/2?p.y=r+a-(p.y-r):p.y>=r+a/2&&(p.y=r+(r+a-p.y)),p.ratioX=(p.x-t)/o,p.ratioY=(p.y-r)/a}}this.updateFHDCurPts()},d.prototype.updateFHDColl=function(e){var i=this.parent,t={startX:i.img.destLeft,startY:i.img.destTop,width:i.img.destWidth,height:i.img.destHeight};i.notify("shape",{prop:"straightenShapes",onPropertyChange:!1});for(var r=i.img,o=r.destLeft,a=r.destTop,n=r.destWidth,s=r.destHeight,l=0,p=i.objColl.length;l<p;l++){var h=i.objColl[l];if(h.shape==="line"||h.shape==="arrow")i.notify("shape",{prop:"straightenShapePoints",value:{obj:h,isReverse:!0}});else if(h.shape==="path"){var u=i.transform.straighten;i.transform.straighten=-i.transform.straighten,i.notify("shape",{prop:"straightenPath",onPropertyChange:!1,value:{obj:h}}),i.transform.straighten=u}if(h.imageRatio={startX:(h.activePoint.startX-o)/n,startY:(h.activePoint.startY-a)/s,endX:(h.activePoint.endX-o)/n,endY:(h.activePoint.endY-a)/s,width:n/h.activePoint.width,height:s/h.activePoint.height},h.shape==="path")for(var c=0,g=h.pointColl.length;c<g;c++)h.pointColl[c].ratioX=(h.pointColl[c].x-o)/n,h.pointColl[c].ratioY=(h.pointColl[c].y-a)/s;i.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1})}if(i.freehandCounter>0&&i.transform.straighten!==0){var u=i.transform.straighten;i.transform.straighten=-i.transform.straighten,i.notify("shape",{prop:"straightenFHD",onPropertyChange:!1}),i.transform.straighten=u}for(var v=0;v<i.freehandCounter;v++){i.points=f([],i.pointColl[v].points,[]),this.pointCounter=0;for(var b=i.points.length,m=0;m<b;m++){var y=i.points[m];y.ratioX=(y.x-o)/n,y.ratioY=(y.y-a)/s}}for(var v=0;v<i.freehandCounter;v++)if(this.selPointColl[v]){this.selPoints=f([],this.selPointColl[v].points,[]),this.pointCounter=0;for(var b=this.selPoints.length,m=0;m<b;m++){var y=this.selPoints[m];y.ratioX=(y.x-o)/n,y.ratioY=(y.y-a)/s}}this.straightenPoint.x&&this.straightenPoint.y&&(this.straightenPoint.ratioX=(this.straightenPoint.x-o)/n,this.straightenPoint.ratioY=(this.straightenPoint.y-a)/s),i.img.destLeft=t.startX,i.img.destTop=t.startY,i.img.destWidth=t.width,i.img.destHeight=t.height,i.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:e}})},d.prototype.panFHDColl=function(e,i,t){for(var r=this.parent,o=0;o<r.freehandCounter;o++){r.points=f([],r.pointColl[o].points,[]),this.pointCounter=0;for(var a=r.points.length,n=0;n<a;n++){var s=r.points[n];t===""||t==="vertical"?s.x+=e:s.x-=e,t===""||t==="horizontal"?s.y+=i:s.y-=i}}for(var o=0;o<r.freehandCounter;o++)if(this.selPointColl[o]){this.selPoints=f([],this.selPointColl[o].points,[]),this.pointCounter=0;for(var a=this.selPoints.length,n=0;n<a;n++){var s=this.selPoints[n];t===""||t==="vertical"?s.x+=e:s.x-=e,t===""||t==="horizontal"?s.y+=i:s.y-=i}}this.straightenPoint.x&&this.straightenPoint.y&&(t===""||t==="vertical"?this.straightenPoint.x+=e:this.straightenPoint.x-=e,t===""||t==="horizontal"?this.straightenPoint.y+=i:this.straightenPoint.y-=i),this.freehandRedraw(this.lowerContext,null)},d.prototype.freeHandDraw=function(e){var i=this.parent;if(e){if(i.points=[],this.dummyPoints=[],i.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),i.togglePen=!0,i.upperCanvas.style.cursor=i.cursor="crosshair",i.upperCanvas.style.display="block",C(i.activeObj.strokeSettings)){var t={strokeSettings:{}};i.notify("shape",{prop:"getStrokeSettings",onPropertyChange:!1,value:{obj:t}}),i.activeObj.strokeSettings=t.strokeSettings}C(i.activeObj.strokeSettings.strokeWidth)&&(i.activeObj.strokeSettings.strokeWidth=2),i.isMaskImage?i.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1}):i.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"pen",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}})}else{i.upperCanvas.style.cursor=i.cursor="default";var r=this.penStrokeWidth;i.notify("shape",{prop:"apply",onPropertyChange:!1,value:{shape:null,obj:null,canvas:null}}),i.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1}),i.notify("toolbar",{prop:"setCurrentToolbar",value:{type:"main"}}),i.notify("selection",{prop:"setFreehandDrawCustomized",value:{isFreehandDrawCustomized:!1}}),this.penStrokeWidth=r}},d.prototype.isFHDIdx=function(e,i){for(var t=!1,r=0;r<this.parent.freehandCounter;r++)if(this.parent.pointColl[r].id&&parseInt(this.parent.pointColl[r].id.split("_")[1],10)-1===e){t=!0;break}return i&&(i.isIndex=t),t},d.prototype.updateCropPtsForSel=function(){for(var e=this.parent,i=e.activeObj.activePoint,t=0;t<e.freehandCounter;t++){var r={selPointColl:f([],this.selPointColl)};if(r.selPointColl[t]){this.selPoints=f([],r.selPointColl[t].points,[]),this.pointCounter=0;for(var o=this.selPoints.length,a=0;a<o;a++){var n=this.selPoints[a];n.ratioX=(n.x-i.startX)/i.width,n.ratioY=(n.y-i.startY)/i.height}}}},d.prototype.triggerShapeChanging=function(e){var i=this.parent,t=i.pointColl[this.fhdSelIdx];if(i.trigger("shapeChanging",e),i.element.getAttribute("data-value")==="mask-drawing"&&!this.isMasking){this.isMasking=!0,i.upperCanvas.style.cursor="crosshair",i.notify("draw",{prop:"updateTempObjColl"}),i.notify("draw",{prop:"updateTempPointColl"}),i.discard(),i.selectMaskImage();return}if(i.editCompleteArgs=e,e.currentShapeSettings.id.indexOf("pen_")===-1&&(e.action==="draw-end"||e.action==="select")){var r="pen_"+e.currentShapeSettings.id;this.fhdSelIdx?i.pointColl[this.fhdSelIdx].id=r:i.pointColl[i.freehandCounter-1].id=r}this.penStrokeWidth=e.currentShapeSettings.strokeWidth,i.activeObj.strokeSettings.strokeColor!==e.currentShapeSettings.strokeColor&&(i.activeObj.strokeSettings.strokeColor=e.currentShapeSettings.strokeColor,i.notify("toolbar",{prop:"update-toolbar-items",onPropertyChange:!1})),this.fhdSelID&&t&&e.currentShapeSettings&&(t.strokeColor=e.currentShapeSettings.strokeColor,t.strokeWidth=e.currentShapeSettings.strokeWidth,t.points=e.currentShapeSettings.points,t.opacity=e.currentShapeSettings.opacity),e.action==="select"&&(this.freehandRedraw(this.upperContext),i.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"pen",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}))},d.prototype.setCenterSelPoints=function(){var e=this.parent,i={startX:e.img.destLeft,startY:e.img.destTop,width:e.img.destWidth,height:e.img.destHeight};e.notify("shape",{prop:"straightenShapes",onPropertyChange:!1});var t=e.img,r=t.destLeft,o=t.destTop,a=t.destWidth,n=t.destHeight,s=e.activeObj.activePoint;(C(this.prevStraightenObj)||JSON.stringify(this.prevStraightenObj.activePoint)!==JSON.stringify(s))&&(this.straightenPoint={x:s.startX+s.width/2,y:s.startY+s.height/2,ratioX:(s.startX+s.width/2-r)/a,ratioY:(s.startY+s.height/2-o)/n},this.prevStraightenObj=f({},e.activeObj,{},!0),this.straightenPointAngle=e.transform.straighten),e.img.destLeft=i.startX,e.img.destTop=i.startY,e.img.destWidth=i.width,e.img.destHeight=i.height},d}(),di=function(){function d(e){this.diffPoint={x:0,y:0},this.oldPoint={},this.isTouch=!1,this.isObjSelected=!1,this.isFhdPoint=!1,this.dragPoint={startX:0,startY:0,endX:0,endY:0},this.isShapeInserted=!1,this.tempActiveObj={activePoint:{startX:0,startY:0,endX:0,endY:0,width:0,height:0},flipObjColl:[],triangle:[],triangleRatio:[],order:null},this.isFirstMove=!1,this.startTouches=[],this.tempTouches=[],this.currMousePoint={x:0,y:0},this.cursorTargetId="",this.isPreventDragging=!1,this.dragElement="",this.textRow=1,this.mouseDownPoint={x:0,y:0},this.previousPoint={x:0,y:0},this.zoomType="Toolbar",this.isInitialTextEdited=!1,this.dragCanvas=!1,this.isFhdCustomized=!1,this.touchEndPoint={},this.isFhdEditing=!1,this.currentDrawingShape="",this.initialPrevObj={},this.touchTime=0,this.resizedElement="",this.isImageClarity=!0,this.isPinching=!1,this.isSliding=!1,this.mouseDown="",this.isSliderActive=!1,this.arrowShape=[Se.None,Se.SolidArrow],this.isTouchDblClick=!1,this.isMouseDown=!1,this.isMouseUp=!1,this.mouseWheel=0,this.isTransformedShape=!1,this.parent=e,this.addEventListener()}return d.prototype.destroy=function(){this.parent.isDestroyed||this.removeEventListener()},d.prototype.addEventListener=function(){this.parent.on("selection",this.selection,this),this.parent.on("destroyed",this.destroy,this)},d.prototype.removeEventListener=function(){this.parent.off("selection",this.selection),this.parent.off("destroyed",this.destroy)},d.prototype.selection=function(e){var i=this.parent;switch(this.updatePrivateVariables(),e.prop){case"setCursor":this.setCursor(e.value.x,e.value.y);break;case"updateActivePoint":this.updateActivePoint(e.value.x,e.value.y,e.value.isCropSelection);break;case"updateCursorStyles":this.updateCursorStyles(e.value.x,e.value.y,e.value.type);break;case"setTextSelection":this.setTextSelection(e.value.width,e.value.height);break;case"setActivePoint":this.setActivePoint(e.value.startX,e.value.startY);break;case"clearSelection":this.clearSelection(e.value.resetCrop);break;case"calcShapeRatio":this.calcShapeRatio(e.value.x,e.value.y,e.value.imgWidth,e.value.imgHeight);break;case"tab":this.performTabAction();break;case"setDragDirection":this.setDragDirection(e.value.width,e.value.height);break;case"clearUpperCanvas":this.isTouch&&setTimeout(function(){i.upperCanvas.getContext("2d").clearRect(0,0,i.upperCanvas.width,i.upperCanvas.height)},550);break;case"resetFreehandDrawVariables":this.isFhdEditing=this.isFhdPoint=!1;break;case"isShapeInserted":this.isShapeInserted=e.value.bool;break;case"redrawShape":this.redrawShape(e.value.obj);break;case"setTextBoxStylesToActObj":this.setTextBoxStylesToActObj();break;case"mouseDownEventHandler":this.mouseDownEventHandler(e.value.e);break;case"mouseMoveEventHandler":this.mouseMoveEventHandler(e.value.e);break;case"mouseUpEventHandler":this.mouseUpEventHandler(e.value.e);break;case"canvasMouseDownHandler":this.canvasMouseDownHandler(e.value.e);break;case"canvasMouseMoveHandler":this.canvasMouseMoveHandler(e.value.e);break;case"canvasMouseUpHandler":this.canvasMouseUpHandler(e.value.e);break;case"touchStartHandler":this.touchStartHandler(e.value.e);break;case"keyDownEventHandler":this.keyDownEventHandler(e.value.e);break;case"handleScroll":this.handleScroll(e.value.e);break;case"textKeyDown":setTimeout(this.textKeyDown.bind(this),1,e.value.e);break;case"deleteItem":this.deleteItem();break;case"updatePrevShapeSettings":this.updatePrevShapeSettings(e.value.obj);break;case"getZoomType":e.value.obj.zoomType=this.zoomType;break;case"setZoomType":this.zoomType=e.value.zoomType;break;case"setInitialTextEdit":this.isInitialTextEdited=e.value.bool;break;case"setDragCanvas":this.dragCanvas=e.value.bool;break;case"setFreehandDrawCustomized":this.isFhdCustomized=e.value.isFreehandDrawCustomized;break;case"setTouchEndPoint":this.touchEndPoint.x=e.value.x,this.touchEndPoint.y=e.value.y;break;case"getPanDown":e.value.obj.panDown=this.panDown;break;case"setPanDown":this.panDown=e.value.panDown;break;case"getFreehandDrawEditing":e.value.obj.bool=this.isFhdEditing;break;case"setFreehandDrawEditing":this.isFhdEditing=e.value.bool;break;case"getTempActObj":e.value.obj.tempObj=this.tempActiveObj;break;case"setTempActObj":this.tempActiveObj=e.value.obj;break;case"isInside":this.isInside(e.value.x,e.value.y,e.value.z1,e.value.z2,e.value.z3,e.value.z4);break;case"setDragElement":this.dragElement=e.value.value;break;case"setObjSelected":this.isObjSelected=e.value.bool;break;case"adjustActObjForLineArrow":this.adjustActObjForLineArrow(e.value.obj);break;case"findTarget":this.findTarget(e.value.x,e.value.y,e.value.type);break;case"getCurrentFlipState":this.getCurrentFlipState();break;case"setDragWidth":this.setDragWidth(e.value.width);break;case"setDragHeight":this.setDragHeight(e.value.setDragHeight);break;case"annotate":this.currentDrawingShape=e.value.shape,e.value.shape==="text"?(i.activeObj.textSettings.fontSize=11,i.activeObj.keyHistory="Enter Text",i.notify("shape",{prop:"initializeTextShape",onPropertyChange:!1,value:{text:null,fontFamily:null,fontSize:null,bold:null,italic:null,strokeColor:null}})):e.value.shape==="path"&&(i.activeObj.pointColl=[]);break;case"getCurrentDrawingShape":e.value.obj.shape=this.currentDrawingShape;break;case"setCurrentDrawingShape":this.currentDrawingShape=e.value.value;break;case"getTransRotationPoint":this.getTransRotationPoint(e.value.obj,e.value.object);break;case"adjustNEPoints":this.adjustNEPoints(e.value.rectangle,e.value.x,e.value.y,e.value.angle);break;case"adjustRotationPoints":this.adjustRotationPoints(e.value.rectangle,e.value.x,e.value.y,e.value.angle,e.value.type,e.value.elem);break;case"getResizeDirection":this.getResizeDirection(e.value.rectangle,e.value.x,e.value.y,e.value.angle);break;case"setResizedElement":this.resizedElement=e.value.value;break;case"reset":this.reset();break;case"unWireEvent":this.unwireEvent();break;case"updPtCollForShpRot":this.updPtCollForShpRot(e.value.obj);break;case"findImageRatio":this.findImageRatio(e.value.width,e.value.height,e.value.obj);break;case"getNumTextValue":this.getNumTextValue(e.value.obj);break;case"setImageClarity":this.isImageClarity=e.value.bool;break;case"upgradeImageQuality":this.upgradeImageQuality();break;case"triggerShapeChange":this.triggerShapeChange(e.value.shapeResizingArgs,e.value.shapeMovingArgs,e.value.type);break;case"applyTransformToImg":this.applyTransformToImg(e.value.ctx);break;case"findTargetObj":e.value.obj.bool=this.findTargetObj(e.value.x,e.value.y,e.value.isCrop);break;case"setSliding":this.isSliding=e.value.bool;break;case"setSliderActive":this.isSliderActive=e.value.bool;break;case"getArrowType":e.value.obj.type=this.getArrowType(e.value.type);break;case"setArrowShape":e.value.type==="initial"?this.arrowShape[0]=e.value.shape:this.arrowShape[1]=e.value.shape;break;case"updateNWPoints":this.updateNWPoints(e.value.x,e.value.y);break;case"updateNPoints":this.updateNPoints(e.value.x,e.value.y);break;case"updateNEPoints":this.updateNEPoints(e.value.x,e.value.y);break;case"updateWPoints":this.updateWPoints(e.value.x,e.value.y);break;case"updateEPoints":this.updateEPoints(e.value.x,e.value.y);break;case"updateSWPoints":this.updateSWPoints(e.value.x,e.value.y);break;case"updateSPoints":this.updateSPoints(e.value.x,e.value.y);break;case"updateSEPoints":this.updateSEPoints(e.value.x,e.value.y);break;case"drawMaskCircle":this.drawMaskCircle(e.value.x,e.value.y);break;case"isValueUpdated":this.isValueUpdated();break;case"getDistance":this.getDistance(e.value.x,e.value.y);break;case"redact":this.currentDrawingShape=e.value.shape;break;case"updateTransColl":e.value.obj.coll=this.updateTransColl(e.value.object);break;case"getTransformedShape":e.value.obj.bool=this.isTransformedShape;break;case"setTransformedShape":this.isTransformedShape=e.value.bool;break;case"rgbToHex":this.rgbToHex(e.value.r,e.value.g,e.value.b,e.value.a);break;case"padLeft":this.padLeft(e.value.value,e.value.length,e.value.padChar);break;case"setTimer":this.setTimer(e.value.e);break;case"targetTouches":e.value.output=this.targetTouches(e.value.touches);break;case"calculateScale":e.value.output=this.calculateScale(e.value.startTouches,e.value.endTouches);break;case"beforeSaveEvent":this.beforeSaveEvent(e.value.args,e.value.e);break;case"isKeyBoardCrop":e.value.output=this.isKeyBoardCrop(e.value.e);break;case"focusRatioBtn":this.focusRatioBtn();break;case"performEnterAction":this.performEnterAction(e.value.e);break;case"getImagePoints":e.value.output=this.getImagePoints(e.value.x,e.value.y);break;case"revertPoints":this.revertPoints(e.value.actPoint,e.value.tempActiveObj);break;case"performNWResize":this.performNWResize(e.value.x,e.value.y,e.value.tempActiveObj,e.value.actPoint);break;case"performSEResize":this.performSEResize(e.value.x,e.value.y,e.value.tempActiveObj,e.value.actPoint);break;case"isMouseOutsideImg":e.value.output=this.isMouseOutsideImg(e.value.x,e.value.y);break}},d.prototype.getModuleName=function(){return"selection"},d.prototype.updatePrivateVariables=function(){var e=this.parent;e.lowerCanvas&&(this.lowerContext=e.lowerCanvas.getContext("2d")),e.upperCanvas&&(this.upperContext=e.upperCanvas.getContext("2d"))},d.prototype.reset=function(){this.diffPoint={x:0,y:0},this.oldPoint={},this.isTouch=this.isObjSelected=this.isFhdPoint=this.isShapeInserted=!1,this.dragPoint={startX:0,startY:0,endX:0,endY:0},this.tempActiveObj={activePoint:{startX:0,startY:0,endX:0,endY:0,width:0,height:0},flipObjColl:[],triangle:[],triangleRatio:[],order:null},this.isFirstMove=!1,this.cursorTargetId=this.dragElement="",this.isTouchDblClick=!1,this.startTouches=[],this.tempTouches=[],this.currMousePoint={x:0,y:0},this.isPreventDragging=!1,this.timer=void 0,this.tempObjColl=void 0,this.mouseWheel=0,this.textRow=1,this.mouseDownPoint={x:0,y:0},this.previousPoint={x:0,y:0},this.zoomType="Toolbar",this.isInitialTextEdited=!1,this.dragCanvas=this.isPinching=!1,this.isFhdCustomized=!1,this.touchEndPoint={},this.panDown=null,this.isSliding=!1,this.isFhdEditing=!1,this.pathAdjustedIndex=null,this.touchTime=0,this.isImageClarity=!0,this.currentDrawingShape="",this.initialPrevObj={},this.resizedElement="",this.mouseDown="",this.isSliderActive=!1,this.arrowShape=[Se.None,Se.SolidArrow],this.isMouseDown=this.isMouseUp=this.isTransformedShape=!1},d.prototype.performTabAction=function(){var e=this.parent;if(e.textArea.style.display==="block"||e.textArea.style.display==="inline-block"){var i=this.applyCurrShape(!1);e.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:null}}),i&&e.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}})}e.isKBDNavigation=!0},d.prototype.selMouseUpEvent=function(){this.oldPoint.x=void 0,this.oldPoint.y=void 0},d.prototype.getMouseCursor=function(e,i,t,r,o){var a=this.getTransRotationPoint(e),n=e.bottomCenterCircle.radius,s="default",l=o?0:e.topLeftCircle.radius*2;return i>=e.topLeftCircle.startX-l&&i<=e.topLeftCircle.startX+l&&t>=e.topLeftCircle.startY-l&&t<=e.topLeftCircle.startY+l?s="nw-resize":i>=e.topLeftCircle.startX-l&&i<=e.topRightCircle.startX-l&&t>=e.topCenterCircle.startY-l&&t<=e.topCenterCircle.startY+l?s="n-resize":i>=e.topRightCircle.startX-l&&i<=e.topRightCircle.startX+l&&t>=e.topRightCircle.startY-l&&t<=e.topRightCircle.startY+l?s="ne-resize":i>=e.centerLeftCircle.startX-l&&i<=e.centerLeftCircle.startX+l&&t>=e.topLeftCircle.startY-l&&t<=e.bottomLeftCircle.startY-l?s="w-resize":i>=e.centerRightCircle.startX-l&&i<=e.centerRightCircle.startX+l&&t>=e.topRightCircle.startY-l&&t<=e.bottomRightCircle.startY-l?s="e-resize":i>=e.bottomLeftCircle.startX-l&&i<=e.bottomLeftCircle.startX+l&&t>=e.bottomLeftCircle.startY-l&&t<=e.bottomLeftCircle.startY+l?s="sw-resize":i>=e.bottomLeftCircle.startX-l&&i<=e.bottomRightCircle.startX-l&&t>=e.bottomCenterCircle.startY-l&&t<=e.bottomCenterCircle.startY+l?s="s-resize":i>=e.bottomRightCircle.startX-l&&i<=e.bottomRightCircle.startX+l&&t>=e.bottomRightCircle.startY-l&&t<=e.bottomRightCircle.startY+l?s="se-resize":i>=e.activePoint.startX&&i<=e.activePoint.endX&&t>=e.activePoint.startY&&t<=e.activePoint.endY?r?s="grab":s="move":a&&!o&&i>=a.x-(n+2)&&i<=a.x+(n+2)&&t>=a.y-(n+2)&&t<=a.y+(n+2)?s="grabbing":s="default",s},d.prototype.setCursor=function(e,i){var t=this.parent;t.upperCanvas.style.cursor=t.cursor="default";var r={bool:null};if(t.notify("toolbar",{prop:"getFrameToolbar",onPropertyChange:!1,value:{obj:r}}),t.isResize||this.isSliding||r.bool){t.upperCanvas.style.cursor="default";return}var o=!1,a;if(t.activeObj.shape&&(a=t.activeObj.shape.split("-")),(!a&&t.currObjType.isCustomCrop||a&&a[0]==="crop")&&(o=!0),t.currObjType.isDragging){this.dragElement===""?t.upperCanvas.style.cursor=t.cursor="move":t.upperCanvas.style.cursor=t.cursor=this.dragElement;return}if(t.togglePen){t.upperCanvas.style.cursor=t.cursor="crosshair",t.isMaskImage&&(this.drawMaskCircle(e,i),t.upperCanvas.style.cursor="none");return}if(t.activeObj.shape&&this.setCursorForActObj(a,o,e,i),t.cursor==="default"||t.cursor==="grab"){for(var n=this.getHighestOrder(),s=f([],t.shapeColl,[],!0),l=f([],t.objColl,[],!0),p=!1;n>0;){p=!1;for(var h=s.length-1;h>=0;h--)if(s[h].order===n)if(p=!0,s[h].id&&s[h].id.indexOf("pen")>-1){if(t.pointColl[0]&&(t.cursor!=="grab"||!o)&&!t.currObjType.isDragging&&!t.currObjType.isResize){var u=f([],t.points,[],!0);o||this.setCursorForFreehandDrawing(e,i,t.upperCanvas,s[h].id),t.points=u}}else{t.objColl=[],t.objColl.push(f({},s[h],null,!0));var c=t.upperCanvas.style.cursor;t.objColl.length>0&&(t.cursor!=="grab"||!o)&&this.setCursorFromObj(e,i,t.objColl,t.upperCanvas,o),c==="grab"&&t.cursor==="default"&&(t.upperCanvas.style.cursor=t.cursor="grab")}else C(s[h].order)&&(p=!0);if(t.cursor!=="default"&&t.cursor!=="grab")break;if(p)for(var g=!1;!g&&n>0;){for(var v=0;v<s.length;v++)if(s[v].order===n-1){g=!0;break}n--,g||n--}}t.objColl=l,(t.cursor==="default"||t.cursor==="grab")&&t.togglePan&&(t.lowerCanvas.style.cursor=t.upperCanvas.style.cursor=t.cursor="grab")}this.currentDrawingShape!==""&&(t.cursor==="default"||t.cursor==="grab")&&(t.upperCanvas.style.cursor=t.cursor="crosshair")},d.prototype.getHighestOrder=function(){for(var e=0,i=0;i<this.parent.shapeColl.length;i++)this.parent.shapeColl[i].order>e&&(e=this.parent.shapeColl[i].order);return e},d.prototype.drawMaskCircle=function(e,i){var t=this.parent;if(t.isMaskImage){var r=t.activeObj.strokeSettings.strokeWidth*2,o=t.maskCanvas.getContext("2d");o.clearRect(0,0,t.maskCanvas.width,t.maskCanvas.height),o.fillStyle=t.activeObj.strokeSettings.strokeColor,o.strokeStyle="#fff",o.beginPath(),o.ellipse(e,i,r/2,r/2,0,0,2*Math.PI,!1),o.fill(),o.stroke(),o.closePath(),t.maskCanvas.style.cursor="none"}},d.prototype.setCursorForActObj=function(e,i,t,r){var o=this.parent;if(o.activeObj.horTopLine!==void 0){o.activeObj.shape!==void 0&&(e=o.activeObj.shape.split("-")),(e===void 0&&o.currObjType.isCustomCrop||e!==void 0&&e[0]==="crop")&&(i=!0),!i&&o.togglePan&&(o.lowerCanvas.style.cursor=o.upperCanvas.style.cursor=o.cursor="grab");var a=o.upperCanvas.style.cursor,n=f({},o.activeObj,{},!0);if(this.cursorTargetId=n.currIndex,n.shapeDegree===0?o.transform.degree:o.transform.degree-n.shapeDegree,n.shape==="line"||n.shape==="arrow")this.setCursorForLineArrow(n,t,r,o.upperCanvas);else if(n.shape==="path")this.setCursorForPath(n,t,r,o.upperCanvas);else if(!C(n.rotatedAngle)&&n.rotatedAngle!==0)this.setCursorForRotatedObject(n,t,r,o.upperCanvas);else{o.upperCanvas.style.cursor=o.cursor=this.getMouseCursor(n,t,r,i,!1);var s=["n-resize","s-resize","e-resize","w-resize"];n.shape==="text"&&s.indexOf(o.cursor)>-1&&(o.upperCanvas.style.cursor=o.cursor="move")}a==="default"&&o.cursor==="default"&&i&&(o.upperCanvas.style.cursor=o.cursor="grab"),a==="grab"&&o.cursor==="default"&&(o.upperCanvas.style.cursor=o.cursor="grab")}else o.togglePan&&!o.togglePen?o.lowerCanvas.style.cursor=o.upperCanvas.style.cursor=o.cursor="grab":o.currObjType.isCustomCrop||o.togglePen?o.upperCanvas.style.cursor=o.cursor="crosshair":o.upperCanvas.style.cursor=o.cursor="default"},d.prototype.setCursorForPath=function(e,i,t,r){this.setCursorForLineArrow(e,i,t,r);var o=this.parent;if(o.cursor==="default")for(var a=f({},e,null,!0),n=!1,s=1,l=e.pointColl.length;s<l&&!n;s++){a.activePoint.startX=e.pointColl[s-1].x,a.activePoint.startY=e.pointColl[s-1].y,a.activePoint.endX=e.pointColl[s].x,a.activePoint.endY=e.pointColl[s].y,o.notify("shape",{prop:"setPointCollForLineArrow",onPropertyChange:!1,value:{obj:a}});for(var p=e.topLeftCircle.radius,h=0,u=a.pointColl.length;h<u;h++){var c=a.pointColl[h];if(!C(c.x-p*2)&&!C(c.x+p*2)&&!C(c.y-p*2)&&!C(c.y+p*2)&&i>=c.x-p*2&&i<=c.x+p*2&&t>=c.y-p*2&&t<=c.y+p*2){r.style.cursor=o.cursor="move",n=!0;break}else r.style.cursor=o.cursor="default"}}return o.cursor},d.prototype.setCursorForLineArrow=function(e,i,t,r){var o,a=e.topLeftCircle.radius;if(C(e.pointColl))return o;for(var n=0,s=e.pointColl.length;n<s;n++){var l=e.pointColl[n];if(i>=l.x-a*2&&i<=l.x+a*2&&t>=l.y-a*2&&t<=l.y+a*2){r.style.cursor=this.parent.cursor="move",o=n;break}else r.style.cursor=this.parent.cursor="default"}return o},d.prototype.setCursorForRotatedObject=function(e,i,t,r){this.resizedElement="";var o=this.parent,a=e.bottomCenterCircle.radius,n=e.horTopLinePointColl[Math.round(e.horTopLinePointColl.length/2)],s=e.horTopLinePointColl[Math.round(e.horTopLinePointColl.length-1)],l=e.verLeftLinePointColl[Math.round(e.verLeftLinePointColl.length/2)],p=e.verRightLinePointColl[Math.round(e.verRightLinePointColl.length/2)],h=e.horBottomLinePointColl[Math.round(e.horBottomLinePointColl.length/2)],u=e.horBottomLinePointColl[Math.round(e.horBottomLinePointColl.length-1)],c=e.rotationCirclePointColl,g=e.horTopLinePointColl[0],v=e.horBottomLinePointColl[0];if(i>=g.x-(a+2)&&i<=g.x+(a+2)&&t>=g.y-(a+2)&&t<=g.y+(a+2))r.style.cursor=o.cursor="nw-resize";else if(i>=n.x-5&&i<=n.x+5&&t>=n.y-5&&t<=n.y+5)r.style.cursor=o.cursor=this.resizedElement="n-resize";else if(i>=s.x-(a+2)&&i<=s.x+(a+2)&&t>=s.y-(a+2)&&t<=s.y+(a+2))r.style.cursor=o.cursor="ne-resize";else if(i>=l.x-5&&i<=l.x+5&&t>=l.y-5&&t<=l.y+5)r.style.cursor=o.cursor=this.resizedElement="w-resize";else if(i>=p.x-5&&i<=p.x+5&&t>=p.y-5&&t<=p.y+5)r.style.cursor=o.cursor=this.resizedElement="e-resize";else if(i>=v.x-(a+2)&&i<=v.x+(a+2)&&t>=v.y-(a+2)&&t<=v.y+(a+2))r.style.cursor=o.cursor="sw-resize";else if(i>=h.x-5&&i<=h.x+5&&t>=h.y-5&&t<=h.y+5)r.style.cursor=o.cursor=this.resizedElement="s-resize";else if(i>=u.x-(a+2)&&i<=u.x+(a+2)&&t>=u.y-(a+2)&&t<=u.y+(a+2))r.style.cursor=o.cursor="se-resize";else if(c&&i>=c.x-(a+2)&&i<=c.x+(a+2)&&t>=c.y-(a+2)&&t<=c.y+(a+2))r.style.cursor=o.cursor="grabbing";else{r.style.cursor=o.cursor="default";var b=this.getRectanglePoints(e.activePoint.startX,e.activePoint.startY,e.activePoint.width,e.activePoint.height,e.rotatedAngle*(180/Math.PI),i,t);b&&(r.style.cursor=o.cursor="move")}if(o.cursor==="default")for(var m=0,y=e.horTopLinePointColl.length;m<y;m++){var P=e.horTopLinePointColl[m];if(i>=P.x-5&&i<=P.x+5&&t>=P.y-5&&t<=P.y+5){r.style.cursor=o.cursor=this.resizedElement="n-resize";break}}if(o.cursor==="default")for(var m=0,y=e.horBottomLinePointColl.length;m<y;m++){var S=e.horBottomLinePointColl[m];if(i>=S.x-5&&i<=S.x+5&&t>=S.y-5&&t<=S.y+5){r.style.cursor=o.cursor=this.resizedElement="s-resize";break}}if(o.cursor==="default")for(var m=0,y=e.verLeftLinePointColl.length;m<y;m++){var O=e.verLeftLinePointColl[m];if(i>=O.x-5&&i<=O.x+5&&t>=O.y-5&&t<=O.y+5){r.style.cursor=o.cursor=this.resizedElement="w-resize";break}}if(o.cursor==="default")for(var m=0,y=e.verRightLinePointColl.length;m<y;m++){var j=e.verRightLinePointColl[m];if(i>=j.x-5&&i<=j.x+5&&t>=j.y-5&&t<=j.y+5){r.style.cursor=o.cursor=this.resizedElement="e-resize";break}}return this.adjustCursorStylesForRotatedState(e),o.cursor},d.prototype.adjustCursorStylesForRotatedState=function(e){var i=this.parent,t=e.rotatedAngle*(180/Math.PI);if(t=t>0?Math.floor(t):Math.ceil(t),t>=92&&t<=182||t>=-178&&t<=-88){var r={"nw-resize":"ne-resize","n-resize":"s-resize","ne-resize":"nw-resize","w-resize":"e-resize","e-resize":"w-resize","sw-resize":"se-resize","s-resize":"n-resize","se-resize":"sw-resize"};i.cursor in r&&(i.cursor=r[i.cursor])}return i.upperCanvas.style.cursor=this.getResizeElement(e.rotatedAngle*(180/Math.PI),i.cursor),i.cursor},d.prototype.getResizeElement=function(e,i){var t=[];switch(i){case"nw-resize":t=[[337.5,22.5,"nw-resize"],[22.5,67.5,"n-resize"],[67.5,112.5,"ne-resize"],[112.5,157.5,"e-resize"],[157.5,202.5,"se-resize"],[202.5,247.5,"s-resize"],[247.5,292.5,"sw-resize"],[292.5,337.5,"w-resize"]];break;case"n-resize":t=[[337.5,22.5,"n-resize"],[22.5,67.5,"ne-resize"],[67.5,112.5,"e-resize"],[112.5,157.5,"se-resize"],[157.5,202.5,"s-resize"],[202.5,247.5,"sw-resize"],[247.5,292.5,"w-resize"],[292.5,337.5,"nw-resize"]];break;case"ne-resize":t=[[337.5,22.5,"ne-resize"],[22.5,67.5,"e-resize"],[67.5,112.5,"se-resize"],[112.5,157.5,"s-resize"],[157.5,202.5,"sw-resize"],[202.5,247.5,"w-resize"],[247.5,292.5,"nw-resize"],[292.5,337.5,"n-resize"]];break;case"e-resize":t=[[337.5,22.5,"e-resize"],[22.5,67.5,"se-resize"],[67.5,112.5,"s-resize"],[112.5,157.5,"sw-resize"],[157.5,202.5,"w-resize"],[202.5,247.5,"nw-resize"],[247.5,292.5,"n-resize"],[292.5,337.5,"ne-resize"]];break;case"se-resize":t=[[337.5,22.5,"se-resize"],[22.5,67.5,"s-resize"],[67.5,112.5,"sw-resize"],[112.5,157.5,"w-resize"],[157.5,202.5,"nw-resize"],[202.5,247.5,"n-resize"],[247.5,292.5,"ne-resize"],[292.5,337.5,"e-resize"]];break;case"s-resize":t=[[337.5,22.5,"s-resize"],[22.5,67.5,"sw-resize"],[67.5,112.5,"w-resize"],[112.5,157.5,"nw-resize"],[157.5,202.5,"n-resize"],[202.5,247.5,"ne-resize"],[247.5,292.5,"e-resize"],[292.5,337.5,"se-resize"]];break;case"sw-resize":t=[[337.5,22.5,"sw-resize"],[22.5,67.5,"w-resize"],[67.5,112.5,"nw-resize"],[112.5,157.5,"n-resize"],[157.5,202.5,"ne-resize"],[202.5,247.5,"e-resize"],[247.5,292.5,"se-resize"],[292.5,337.5,"s-resize"]];break;case"w-resize":t=[[337.5,22.5,"w-resize"],[22.5,67.5,"nw-resize"],[67.5,112.5,"n-resize"],[112.5,157.5,"ne-resize"],[157.5,202.5,"e-resize"],[202.5,247.5,"se-resize"],[247.5,292.5,"s-resize"],[292.5,337.5,"sw-resize"]];break}for(var r=e<0?360-Math.abs(e):e,o=0,a=t;o<a.length;o++){var n=a[o],s=n[0],l=n[1],p=n[2];if(r>s&&r<=l||r+360>s&&r+360<=l)return p}return i},d.prototype.setCursorForFreehandDrawing=function(e,i,t,r){var o=t.getContext("2d"),a=this.parent,n=document.querySelector("#"+a.element.id+"_textArea"),s=!1;a.notify("freehand-draw",{prop:"setFreehandDrawHoveredIndex",onPropertyChange:!1,value:{index:-1}});for(var l,p=0;p<a.freehandCounter;p++)if(!(r&&r!==a.pointColl[p].id)){var h={selPointColl:{}};a.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:h}}),l=f([],h.selPointColl[p].points,[]),a.points=f([],a.pointColl[p].points,[]);var u=a.pointColl[p];a.notify("freehand-draw",{prop:"setPointCounter",onPropertyChange:!1,value:{value:0}});for(var c=l.length,g=0;g<c;g++)if(g!==0){var v=!1;if(l[g-1]&&l[g]&&(v=this.isInside(e,i,l[g-1].x,l[g-1].y,l[g].x,l[g].y)),v){this.isFhdPoint=!0,a.notify("freehand-draw",{prop:"setFreehandDrawHoveredIndex",onPropertyChange:!1,value:{index:p}}),a.notify("freehand-draw",{prop:"hoverFhd",onPropertyChange:!1,value:{strokeColor:null,strokeWidth:null}}),t.style.cursor=a.cursor="pointer",s=!0;break}else if(!this.isFhdEditing||u.isSelected){if((this.isFhdPoint||this.isFhdEditing)&&(o.clearRect(0,0,t.width,t.height),a.activeObj.shape&&n.style.display==="none"&&a.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:a.activeObj}})),this.isFhdEditing){var b={freehandSelectedIndex:-1};a.notify("freehand-draw",{prop:"getFreehandSelectedIndex",onPropertyChange:!1,value:{obj:b}});var m=a.pointColl[b.freehandSelectedIndex].strokeColor,y=a.pointColl[b.freehandSelectedIndex].strokeWidth;a.notify("freehand-draw",{prop:"hoverFhd",onPropertyChange:!1,value:{strokeColor:m,strokeWidth:y}})}else a.notify("freehand-draw",{prop:"setFreehandDrawHoveredIndex",onPropertyChange:!1,value:{index:null}});this.isFhdPoint=!1}}else{var P=a.points[g];if(e>P.x-u.strokeWidth&&e<P.x+u.strokeWidth&&i>P.y-u.strokeWidth&&i<P.y+u.strokeWidth){this.isFhdPoint=!0,a.notify("freehand-draw",{prop:"setFreehandDrawHoveredIndex",onPropertyChange:!1,value:{index:p}}),a.notify("freehand-draw",{prop:"hoverFhd",onPropertyChange:!1,value:{strokeColor:null,strokeWidth:null}}),t.style.cursor=a.cursor="pointer",s=!0;break}else if(!this.isFhdEditing||u.isSelected){if((this.isFhdPoint||this.isFhdEditing)&&(o.clearRect(0,0,t.width,t.height),a.activeObj.shape&&n.style.display==="none"&&a.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:a.activeObj}})),this.isFhdEditing){var b={freehandSelectedIndex:-1};a.notify("freehand-draw",{prop:"getFreehandSelectedIndex",onPropertyChange:!1,value:{obj:b}});var m=a.pointColl[b.freehandSelectedIndex].strokeColor,y=a.pointColl[b.freehandSelectedIndex].strokeWidth;a.notify("freehand-draw",{prop:"hoverFhd",onPropertyChange:!1,value:{strokeColor:m,strokeWidth:y}})}this.isFhdPoint=!1}}if(s)break}},d.prototype.setCursorFromObj=function(e,i,t,r,o){for(var a=this.parent,n=0,s=t.length;n<s;n++){if(a.cursor==="move")return;var l=f({},t[n],{},!0);if(l.activePoint.width===0&&l.activePoint.height===0){t.splice(n,1);return}this.cursorTargetId=l.currIndex,l.shape==="line"||l.shape==="arrow"?this.setCursorForLineArrow(l,e,i,r):l.shape==="path"?this.setCursorForPath(l,e,i,r):!C(l.rotatedAngle)&&l.rotatedAngle!==0?this.setCursorForRotatedObject(l,e,i,r):r.style.cursor=a.cursor=this.getMouseCursor(l,e,i,o,!0)}},d.prototype.isInside=function(e,i,t,r,o,a){var n=Math.min(t,o),s=Math.max(t,o),l=Math.min(r,a),p=Math.max(r,a);return n<=e&&e<=s&&l<=i&&i<=p},d.prototype.preventResizing=function(e){var i=this.parent;if(i.activeObj.preventShapeDragOut&&this.isShapeDragOut()){var t=i.activeObj.activePoint;t.startX=e.activePoint.startX,t.startY=e.activePoint.startY,t.endX=e.activePoint.endX,t.endY=e.activePoint.endY,t.width=e.activePoint.width,t.height=e.activePoint.height,i.activeObj.rotatedAngle=e.rotatedAngle,i.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:t,obj:i.activeObj,isMouseMove:null,x:null,y:null}})}},d.prototype.updateActivePoint=function(e,i,t){var r=this.parent,o={width:0,height:0},a=r.activeObj.activePoint,n=a.startX,s=a.startY,l=r.activeObj.activePoint,p=l.width,h=l.height;r.notify("transform",{prop:"calcMaxDimension",onPropertyChange:!1,value:{width:p,height:h,obj:o,isImgShape:null}});var u=this.updatePrevShapeSettings(),c={cancel:!1,action:"resize",previousShapeSettings:u,allowShapeOverflow:this.allowOutofBound()},g={cancel:!1,action:"move",previousShapeSettings:u,allowShapeOverflow:this.allowOutofBound()};if(this.shapeResizingArgs=c,this.shapeMovingArgs=g,r.activeObj.shape==="text"&&this.dragElement!==""&&r.notify("shape",{prop:"updateFontRatio",onPropertyChange:!1,value:{obj:r.activeObj,isTextArea:null}}),this.currentDrawingShape!==""&&(this.dragElement===""||this.dragElement==="move")&&r.isShapeDrawing){var v=["line","arrow","path"];v.indexOf(r.activeObj.shape)>-1?this.dragElement="e-resize":e>n&&i>s?this.dragElement="se-resize":e<n&&i>s?this.dragElement="sw-resize":e>n&&i<s?this.dragElement="ne-resize":e<n&&i<s&&(this.dragElement="nw-resize")}r.activeObj.shape==="arrow"&&(Math.atan2(e-r.lowerCanvas.width/2,i-r.lowerCanvas.height/2)>0?r.activeObj.rotatedAngle=-Math.atan2(e-r.lowerCanvas.width/2,i-r.lowerCanvas.height/2):r.activeObj.rotatedAngle=Math.abs(Math.atan2(e-r.lowerCanvas.width/2,i-r.lowerCanvas.height/2)));var b,m=!1,y=!1;if(!(t&&r.transform.straighten!==0&&this.isMouseOutsideImg(e,i))){var P=f({},r.activeObj,{},!0),S,O;switch(r.activeObj.shape!==void 0&&(S=r.activeObj.shape.split("-")),S!==void 0&&S[0]==="crop"&&(O=!0),this.dragElement.toLowerCase()){case"nw-resize":this.updateNWPoints(e,i),this.preventResizing(P),r.notify("shape",{prop:"updateArrowDirection",onPropertyChange:!1,value:{obj:r.activeObj,flip:null,rotatedDegree:null}}),this.triggerShapeChange(c,g,"resize");break;case"n-resize":this.updateNPoints(e,i),this.preventResizing(P),r.notify("shape",{prop:"updateArrowDirection",onPropertyChange:!1,value:{obj:r.activeObj,flip:null,rotatedDegree:null}}),this.triggerShapeChange(c,g,"resize");break;case"ne-resize":this.updateNEPoints(e,i),this.preventResizing(P),r.notify("shape",{prop:"updateArrowDirection",onPropertyChange:!1,value:{obj:r.activeObj,flip:null,rotatedDegree:null}}),this.triggerShapeChange(c,g,"resize");break;case"w-resize":this.updateWPoints(e,i),this.preventResizing(P),r.notify("shape",{prop:"updateArrowDirection",onPropertyChange:!1,value:{obj:r.activeObj,flip:null,rotatedDegree:null}}),this.triggerShapeChange(c,g,"resize");break;case"e-resize":this.updateEPoints(e,i),this.preventResizing(P),r.notify("shape",{prop:"updateArrowDirection",onPropertyChange:!1,value:{obj:r.activeObj,flip:null,rotatedDegree:null}}),this.triggerShapeChange(c,g,"resize");break;case"sw-resize":this.updateSWPoints(e,i),this.preventResizing(P),r.notify("shape",{prop:"updateArrowDirection",onPropertyChange:!1,value:{obj:r.activeObj,flip:null,rotatedDegree:null}}),this.triggerShapeChange(c,g,"resize");break;case"s-resize":this.updateSPoints(e,i),this.preventResizing(P),r.notify("shape",{prop:"updateArrowDirection",onPropertyChange:!1,value:{obj:r.activeObj,flip:null,rotatedDegree:null}}),this.triggerShapeChange(c,g,"resize");break;case"se-resize":this.updateSEPoints(e,i),this.preventResizing(P),r.notify("shape",{prop:"updateArrowDirection",onPropertyChange:!1,value:{obj:r.activeObj,flip:null,rotatedDegree:null}}),this.triggerShapeChange(c,g,"resize");break;case"grabbing":Math.atan2(e-(n+p/2),i-(s+h/2))>0?r.activeObj.rotatedAngle=-Math.atan2(e-(n+p/2),i-(s+h/2)):r.activeObj.rotatedAngle=Math.abs(Math.atan2(e-(n+p/2),i-(s+h/2))),r.activeObj.shapeDegree===0?b=r.transform.degree:b=r.transform.degree-r.activeObj.shapeDegree,b<0&&(b=360+b);for(var j=0,x=r.activeObj.flipObjColl.length;j<x;j++)r.activeObj.flipObjColl[j].toLowerCase()==="horizontal"?m=!0:r.activeObj.flipObjColl[j].toLowerCase()==="vertical"&&(y=!0);r.activeObj.rotatedAngle-=b*(Math.PI/180),b===0||b===360?y&&(r.activeObj.rotatedAngle-=180*(Math.PI/180)):b===90||b===-270?m&&(r.activeObj.rotatedAngle-=180*(Math.PI/180)):b===180||b===-180?y&&(r.activeObj.rotatedAngle-=180*(Math.PI/180)):(b===270||b===-90)&&m&&(r.activeObj.rotatedAngle-=180*(Math.PI/180)),this.preventResizing(P);break;case"pathdrag":C(this.pathAdjustedIndex)||(r.activeObj.pointColl[this.pathAdjustedIndex].x=e,r.activeObj.pointColl[this.pathAdjustedIndex].y=i);break;default:if(!t&&!r.currObjType.isCustomCrop){var k=r.activeObj.activePoint;if(this.dragPoint.startX){var T=this.dragPoint.endX-this.previousPoint.x,A=this.dragPoint.endY-this.previousPoint.y;if(k.startX+=T,k.endX+=T,k.startY+=A,k.endY+=A,n=k.startX,s=k.startY,r.activeObj.shape!=="line"&&r.activeObj.shape!=="arrow"&&r.activeObj.rotationCirclePointColl&&(r.activeObj.rotationCirclePointColl.x+=T,r.activeObj.rotationCirclePointColl.y+=A,r.activeObj.rotationCirclePoint.x+=T,r.activeObj.rotationCirclePoint.y+=A),r.activeObj.shape==="path")for(var j=0,x=r.activeObj.pointColl.length;j<x;j++)r.activeObj.pointColl[j].x+=T,r.activeObj.pointColl[j].y+=A;if(!this.isPreventDragging&&this.isShapeDragOut()&&(r.activeObj.preventShapeDragOut||r.activeObj.shape==="redact"||O)){if(k.startX-=T,k.endX-=T,k.startY-=A,k.endY-=A,r.activeObj.shape!=="line"&&r.activeObj.shape!=="arrow"&&r.activeObj.rotationCirclePointColl)r.activeObj.rotationCirclePointColl.x-=T,r.activeObj.rotationCirclePointColl.y-=A,r.activeObj.rotationCirclePoint.x-=T,r.activeObj.rotationCirclePoint.y-=A;else if(r.activeObj.shape==="path")for(var L=0,x=r.activeObj.pointColl.length;L<x;L++)r.activeObj.pointColl[L].x-=T,r.activeObj.pointColl[L].y-=A;if(r.activeObj.rotatedAngle===0){var H=r.activeObj.activePoint.endX,B=r.activeObj.activePoint.endY;r.activeObj.shape==="path"&&(r.activeObj.activePoint=r.getSquarePointForPath(r.activeObj)),this.setDragWidth(T),this.setDragHeight(A);var D=r.activeObj,E=D.activePoint.endX-H,R=D.activePoint.endY-B;if(D.shape==="path")for(var L=0,x=D.pointColl.length;L<x;L++)D.pointColl[L].x+=E,D.pointColl[L].y+=R}else r.notify("selection",{prop:"updPtCollForShpRot",onPropertyChange:!1,value:{obj:r.activeObj}})}}else k.startX=e<this.mouseDownPoint.x?e:this.mouseDownPoint.x,k.startY=i<this.mouseDownPoint.y?i:this.mouseDownPoint.y,e=e<this.mouseDownPoint.x?this.mouseDownPoint.x:e,i=i<this.mouseDownPoint.y?this.mouseDownPoint.y:i,k.endX=e,k.endY=i;this.triggerShapeChange(c,g,"move")}break}}},d.prototype.isShapeDragOut=function(){var e=this.parent,i=!1,t=!1,r=e.activeObj.shape;if((e.activeObj.preventShapeDragOut||e.activeObj.rotatedAngle===0&&r!=="line"&&r!=="arrow"&&r!=="path")&&(t=!0),t){var o=e.activeObj.activePoint,a=o.startX,n=o.startY,s=o.endX,l=o.endY;if(r==="path"){var p=e.getSquarePointForPath(e.activeObj);a=p.startX,n=p.startY,s=p.endX,l=p.endY}if(e.activeObj.rotatedAngle===0||r==="arrow")i=this.isObjOutsideImg(a,n,s,l,r);else{var h={isIntersect:null,arr:null};e.notify("draw",{prop:"updateImgCanvasPoints",onPropertyChange:!1}),e.notify("draw",{prop:"isLinesIntersect",onPropertyChange:!1,value:{obj:h}}),h.arr[0]||h.arr[1]||h.arr[2]||h.arr[3]?i=!0:i=this.isObjOutsideImg(a,n,s,l,r)}}return i},d.prototype.isObjOutsideImg=function(e,i,t,r,o){var a=this.parent,n=a.img,s=n.destLeft,l=n.destTop,p=n.destWidth,h=n.destHeight;return e<s||i<l||t>s+p||r>l+h||(o==="line"||o==="arrow")&&(e>s+p||i>l+h||t<s||r<l)},d.prototype.triggerShapeChange=function(e,i,t){var r=this.parent,o=r.activeObj.activePoint;o.width=o.endX-o.startX,o.height=o.endY-o.startY;var a=this.updatePrevShapeSettings();if(!C(this.shapeResizingArgs)&&!C(this.shapeMovingArgs)?(e.currentShapeSettings=this.shapeResizingArgs.currentShapeSettings=a,i.currentShapeSettings=this.shapeMovingArgs.currentShapeSettings=a):(e.currentShapeSettings=a,i.currentShapeSettings=a),t==="resize"){this.isCropSelection=!1;var n=void 0;if(r.activeObj.shape!==void 0&&(n=r.activeObj.shape.split("-")),n!==void 0&&n[0]==="crop"&&(this.isCropSelection=!0),!this.isCropSelection)this.currentDrawingShape!==""&&r.upperCanvas.style.cursor==="crosshair"&&(e.action="drawing"),(!r.currObjType.isRedact||r.activeObj.shape!=="redact")&&r.trigger("shapeChanging",e),r.editCompleteArgs=e,this.isPreventShaping=e.cancel,r.notify("shape",{prop:"updateShapeChangeEventArgs",onPropertyChange:!1,value:{shapeSettings:e.currentShapeSettings,allowShapeOverflow:e.allowShapeOverflow}});else{this.isMouseDown?e.action="resize-start":this.isMouseUp&&(e.action="resize-end");var s={action:e.action,previousSelectionSettings:{type:r.getSelectionType(r.activeObj.shape),startX:e.previousShapeSettings.startX,startY:e.previousShapeSettings.startY,width:e.previousShapeSettings.width,height:e.previousShapeSettings.height},currentSelectionSettings:{type:r.getSelectionType(r.activeObj.shape),startX:e.currentShapeSettings.startX,startY:e.currentShapeSettings.startY,width:e.currentShapeSettings.width,height:e.currentShapeSettings.height}};this.selectionResizingArgs=s,r.trigger("selectionChanging",s),r.editCompleteArgs=s,r.notify("shape",{prop:"updSelChangeEventArgs",onPropertyChange:!1,value:{selectionSettings:s.currentSelectionSettings}})}}else t==="mouse-down"||t==="mouse-up"?(r.activeObj.shape!=="redact"&&r.trigger("shapeChanging",e),r.editCompleteArgs=e,this.isPreventShaping=e.cancel,r.notify("shape",{prop:"updateShapeChangeEventArgs",onPropertyChange:!1,value:{shapeSettings:e.currentShapeSettings,allowShapeOverflow:e.allowShapeOverflow}})):(r.activeObj.shape!=="redact"&&r.trigger("shapeChanging",i),r.editCompleteArgs=i,this.isPreventShaping=i.cancel,r.notify("shape",{prop:"updateShapeChangeEventArgs",onPropertyChange:!1,value:{shapeSettings:i.currentShapeSettings,allowShapeOverflow:i.allowShapeOverflow}}));r.eventType=t},d.prototype.setDragWidth=function(e){var i=this.parent,t=i.activeObj.activePoint,r=i.img,o=r.destLeft,a=r.destWidth,n=e,s=i.activeObj.shape,l=!1;if(i.activeObj.preventShapeDragOut&&(s==="line"||s==="arrow")&&(l=!0),n>=0)for(var p=0;p<n&&(e=n-p,t.startX+=e,t.endX+=e,!(t.startX>=o&&t.endX<=o+a&&!l||t.startX>=o&&t.endX<=o+a&&t.endX>=o&&t.startX<=o+a&&l));p++)t.startX-=e,t.endX-=e;else for(var p=1;p<Math.abs(n)&&(e=n+p,t.startX+=e,t.endX+=e,!(t.startX>=o&&t.endX<=o+a&&!l||t.startX>=o&&t.endX<=o+a&&t.endX>=o&&t.startX<=o+a&&l));p++)t.startX-=e,t.endX-=e},d.prototype.setDragHeight=function(e){var i=this.parent,t=i.activeObj.activePoint,r=i.img,o=r.destTop,a=r.destHeight,n=e,s=i.activeObj.shape,l=!1;if(i.activeObj.preventShapeDragOut&&(s==="line"||s==="arrow")&&(l=!0),n>=0)for(var p=1;p<n&&(e=n-p,t.startY+=e,t.endY+=e,!(t.startY>=o&&t.endY<=o+a&&!l||t.startY>=o&&t.endY<=o+a&&t.endY>=o&&t.startY<=o+a&&l));p++)t.startY-=e,t.endY-=e;else for(var p=0;p<Math.abs(n)&&(e=n+p,t.startY+=e,t.endY+=e,!(t.startY>=o&&t.endY<=o+a&&!l||t.startY>=o&&t.endY<=o+a&&t.endY>=o&&t.startY<=o+a&&l));p++)t.startY-=e,t.endY-=e},d.prototype.limitDrag=function(e){var i=!1,t=this.parent,r=t.img,o=r.destLeft,a=r.destTop,n=r.destWidth,s=r.destHeight,l=t.activeObj.activePoint,p=e?l.startX:l.endX,h=e?l.startY:l.endY,u=e?l.endX:l.startX,c=e?l.endY:l.startY,g=t.upperCanvas.width,v=t.upperCanvas.height,b=o<0?0:o,m=a<0?0:a,y=o+n>g?g:o+n,P=a+s>v?v:a+s;if(w.isDevice?(p<b&&(p=b),h<m&&(h=m),u>y&&(u=y),c>P&&(c=P)):(p<o&&(p=o),h<a&&(h=a),u>o+n&&(u=o+n),c>a+s&&(c=a+s)),t.transform.straighten!==0){var S={isIntersect:null,arr:null};t.notify("draw",{prop:"updateImgCanvasPoints",onPropertyChange:!1}),t.notify("draw",{prop:"isLinesIntersect",onPropertyChange:!1,value:{obj:S}}),(S.arr[0]||S.arr[1]||S.arr[2]||S.arr[3])&&(i=!0)}return e?(l.startX=p,l.startY=h,l.endX=u,l.endY=c):(l.startX=u,l.startY=c,l.endX=p,l.endY=h),i},d.prototype.isMouseOutsideImg=function(e,i){var t={bool:!1};return this.parent.notify("draw",{prop:"updateImgCanvasPoints",onPropertyChange:!1}),this.parent.notify("draw",{prop:"isPointsInsideImg",value:{obj:t,x:e,y:i}}),t.bool},d.prototype.preventDraggingInvertly=function(){var e=!1,i=this.parent;if(i.activeObj.shape==="image")return e;var t,r;if(i.activeObj.shape!==void 0&&(t=i.activeObj.shape.split("-")),t!==void 0&&t[0]==="crop"&&(r=!0),!this.isPreventDragging&&i.activeObj.rotatedAngle===0&&(i.activeObj.preventShapeDragOut||i.activeObj.shape==="redact"||r)){e=this.limitDrag(!0);var o=["line","arrow","path"];o.indexOf(i.activeObj.shape)>-1&&(e=this.limitDrag(!1))}return e},d.prototype.preventTextDraggingInvertly=function(){var e=this.parent,i=!1,t=e.activeObj.activePoint,r=e.img,o=r.destLeft,a=r.destTop,n=r.destWidth,s=r.destHeight;return this.isPreventDragging||(t.startX<o||t.startY<a||t.endX>o+n||t.endY>a+s)&&(i=!0),i},d.prototype.preventInverseResize=function(e){var i=this.parent,t=i.activeObj.activePoint;t.width<0&&(t.width=0,t.startX=e.activePoint.startX,t.endX=e.activePoint.endX),t.height<0&&(t.height=0,t.startY=e.activePoint.startY,t.endY=e.activePoint.endY)},d.prototype.getScaleRatio=function(e){var i=this.parent,t={x:e,y:e};if(i.activeObj.shape&&i.activeObj.shape!=="crop-custom"&&i.activeObj.shape!=="crop-circle"&&i.activeObj.shape!=="crop-square"){var r=i.activeObj.shape==="image"||i.activeObj.shape==="text"?this.findImageRatio(i.activeObj.activePoint.width,i.activeObj.activePoint.height).split("-"):i.activeObj.shape.split("-");if(r.length>1||i.activeObj.shape==="image"||i.activeObj.shape==="text"){r=i.activeObj.shape==="image"||i.activeObj.shape==="text"?r[0].split(":"):r[1].split(":");var o=e/parseInt(r[1],10);t.x=o*parseInt(r[0],10),t.y=o*parseInt(r[1],10)}}return t},d.prototype.findImageRatio=function(e,i,t){var r=function(n,s){return s===0?n:r(s,n%s)},o=r(e,i),a=e/o+":"+i/o;return t&&(t.ratio=a),a},d.prototype.revertResizing=function(e){var i=this.parent,t=i.activeObj.activePoint;this.preventDraggingInvertly()&&(t.startX=e.activePoint.startX,t.startY=e.activePoint.startY,t.endX=e.activePoint.endX,t.endY=e.activePoint.endY)},d.prototype.performSEResize=function(e,i,t,r){var o=this.parent;if(this.resizeImg(e,i,"se-resize",t),r.endX<r.startX){var a=r.endX;r.endX=r.startX,r.startX=a,this.dragElement=o.upperCanvas.style.cursor=o.cursor="sw-resize"}if(r.endY<r.startY){var a=r.endY;r.endY=r.startY,r.startY=a,this.dragElement=o.upperCanvas.style.cursor=o.cursor="ne-resize"}this.revertCustomSelection(r,t,"se-resize"),this.revertResizing(t)},d.prototype.performNWResize=function(e,i,t,r){var o=this.parent;if(this.resizeImg(e,i,"nw-resize",t),r.startX>r.endX){var a=r.startX;r.startX=r.endX,r.endX=a,this.dragElement=o.upperCanvas.style.cursor=o.cursor="ne-resize"}if(r.startY>r.endY){var a=r.startY;r.startY=r.endY,r.endY=a,this.dragElement=o.upperCanvas.style.cursor=o.cursor="sw-resize"}this.revertCustomSelection(r,t,"nw-resize"),this.revertResizing(t)},d.prototype.isCustomSelection=function(){if(this.parent.activeObj.shape){var e=["custom","circle","square","2:3","3:2","3:4","4:3","4:5","5:4","5:7","7:5","9:16","16:9"];return this.parent.activeObj.shape.indexOf("crop-")>-1&&e.indexOf(this.parent.activeObj.shape.split("-")[1])===-1}return!1},d.prototype.revertCustomSelection=function(e,i,t){var r=this.parent;if(this.isCustomSelection()){var o=r.img,a=o.destLeft,n=o.destTop,s=o.destWidth,l=o.destHeight,p=a+s<r.lowerCanvas.width?a+s:r.lowerCanvas.width,h=n+l<r.lowerCanvas.height?n+l:r.lowerCanvas.height,u=a>0?a:0,c=n>0?n:0,g=n>0?n:0,v=a>0?a:0;(t==="se-resize"&&(e.endX>p||e.endY>h)||t==="nw-resize"&&(e.startX<u||e.startY<c)||t==="ne-resize"&&(e.endX>p||e.startY<g)||t==="sw-resize"&&(e.startX<v||e.endY>h))&&this.revertPoints(e,i)}},d.prototype.revertPoints=function(e,i){e.startX=i.activePoint.startX,e.startY=i.activePoint.startY,e.endX=i.activePoint.endX,e.endY=i.activePoint.endY,e.width=i.activePoint.width,e.height=i.activePoint.height},d.prototype.updateNWPoints=function(e,i){var t=this.parent,r=t.activeObj.activePoint,o,a,n,s=f({},t.activeObj,null,!0);if(t.activeObj.shape==="text")this.resizeImg(e,i,"nw-resize",s),t.notify("shape",{prop:"updateFontSize",onPropertyChange:!1,value:{obj:t.activeObj}});else{var l=void 0;if(t.activeObj.shape!==void 0&&(l=t.activeObj.shape.split("-")),t.activeObj.shape==="crop-custom"||t.activeObj.shape!==void 0&&l[0]!=="crop"||this.isCustomSelection()){if(t.activeObj.shape==="image"||this.isCustomSelection()?this.resizeImg(e,i,"nw-resize",s):this.adjustNWPoints(r,e,i,t.activeObj.rotatedAngle),r.startX>r.endX){var p=r.startX;r.startX=r.endX,r.endX=p,this.dragElement=t.upperCanvas.style.cursor=t.cursor="ne-resize"}if(r.startY>r.endY){var p=r.startY;r.startY=r.endY,r.endY=p,this.dragElement=t.upperCanvas.style.cursor=t.cursor="sw-resize"}this.revertCustomSelection(r,s,"nw-resize"),this.revertResizing(s)}else{var h=t.img,u=h.destLeft,c=h.destTop;if(r.startX<e&&r.startY<i){o=e-r.startX,a=i-r.startY,n=Math.min(o,a);var g=this.getScaleRatio(n);r.startX+=g.x,r.startY+=g.y;var v=u>0?u:0,b=c>0?c:0;(r.startX<v||r.startY<b)&&(r.startX-=g.x,r.startY-=g.y)}else{o=r.startX-e,a=i-r.endY,n=Math.max(o,a);var g=this.getScaleRatio(n);r.startX-=g.x,r.startY-=g.y;var v=u>0?u:0,m=c>0?c:0;(r.startX<v||r.startY<m)&&(r.startX+=g.x,r.startY+=g.y)}r.width=r.endX-r.startX,r.height=r.endY-r.startY,this.revertResizing(s)}r.width=r.endX-r.startX,r.height=r.endY-r.startY,this.preventInverseResize(s)}},d.prototype.updateNPoints=function(e,i){var t=this.parent,r=t.activeObj.activePoint,o,a,n,s=f({},t.activeObj,null,!0);if(t.activeObj.shape!=="text"){var l=void 0;if(t.activeObj.shape&&(l=t.activeObj.shape.split("-")),t.activeObj.shape==="crop-custom"||t.activeObj.shape&&l[0]!=="crop"){if(t.activeObj.shape!=="line"&&t.activeObj.shape!=="arrow"&&t.activeObj.shape!=="path"&&t.activeObj.rotatedAngle!==0&&this.dragPoint.startX?(this.dragPoint.startX&&this.dragPoint.startY&&(this.previousPoint.x=this.dragPoint.endX,this.previousPoint.y=this.dragPoint.endY,this.dragPoint.endX=e,this.dragPoint.endY=i),o=this.dragPoint.endX-this.previousPoint.x,a=this.dragPoint.endY-this.previousPoint.y,this.adjustRotationPoints(r,o,a,t.activeObj.rotatedAngle)):(r.startY=i,r.height=r.endY-r.startY),r.startY>r.endY){var p=r.startY;r.startY=r.endY,r.endY=p,this.dragElement=this.resizedElement="s-resize"}this.revertResizing(s)}else{var h=t.img,u=h.destLeft,c=h.destTop,g=h.destWidth;if(this.isCustomSelection())this.performNWResize(e,i,s,r);else if(r.endX>e&&r.startY<i){o=r.endX-e,a=i-r.startY,n=Math.min(o,a);var v=this.getScaleRatio(n);r.endX-=v.x,r.startY+=v.y,(r.endX>u+g||r.startY<c)&&(r.endX+=v.x,r.startY-=v.y)}else{o=e-r.endX,a=r.startY-i,n=Math.max(o,a);var v=this.getScaleRatio(n);r.endX+=v.x,r.startY-=v.y,(r.endX>u+g||r.startY<c)&&(r.endX-=v.x,r.startY+=v.y)}r.width=r.endX-r.startX,r.height=r.endY-r.startY,this.revertResizing(s)}}},d.prototype.updateNEPoints=function(e,i){var t=this.parent,r=t.activeObj.activePoint,o,a,n,s=f({},t.activeObj,null,!0);if(t.activeObj.shape==="text")this.resizeImg(e,i,"ne-resize",s),t.notify("shape",{prop:"updateFontSize",onPropertyChange:!1,value:{obj:t.activeObj}});else{var l=void 0;if(t.activeObj.shape&&(l=t.activeObj.shape.split("-")),t.activeObj.shape==="crop-custom"||t.activeObj.shape!==void 0&&l[0]!=="crop"||this.isCustomSelection()){if(t.activeObj.shape==="image"||this.isCustomSelection()?this.resizeImg(e,i,"ne-resize",s):this.adjustNEPoints(r,e,i,t.activeObj.rotatedAngle),r.endX<r.startX){var p=r.endX;r.endX=r.startX,r.startX=p,this.dragElement=t.upperCanvas.style.cursor=t.cursor="nw-resize"}if(r.startY>r.endY){var p=r.startY;r.startY=r.endY,r.endY=p,this.dragElement=t.upperCanvas.style.cursor=t.cursor="se-resize"}this.revertCustomSelection(r,s,"ne-resize"),this.revertResizing(s)}else{var h=t.img,u=h.destLeft,c=h.destTop,g=h.destWidth;if(r.endX>e&&r.startY<i){o=r.endX-e,a=i-r.startY,n=Math.min(o,a);var v=this.getScaleRatio(n);r.endX-=v.x,r.startY+=v.y;var b=u+g<t.lowerCanvas.width?u+g:t.lowerCanvas.width,m=c>0?c:0;(r.endX>b||r.startY<m)&&(r.endX+=v.x,r.startY-=v.y)}else{o=e-r.endX,a=r.startY-i,n=Math.max(o,a);var v=this.getScaleRatio(n);r.endX+=v.x,r.startY-=v.y;var b=u+g<t.lowerCanvas.width?u+g:t.lowerCanvas.width,m=c>0?c:0;(r.endX>b||r.startY<m)&&(r.endX-=v.x,r.startY+=v.y)}r.width=r.endX-r.startX,r.height=r.endY-r.startY,this.revertResizing(s)}r.width=r.endX-r.startX,r.height=r.endY-r.startY,this.preventInverseResize(s)}},d.prototype.updateWPoints=function(e,i){var t=this.parent,r=t.activeObj.activePoint,o,a,n,s=f({},t.activeObj,null,!0);if(t.activeObj.shape!=="text"){var l=void 0;if(t.activeObj.shape&&(l=t.activeObj.shape.split("-")),t.activeObj.shape==="crop-custom"||t.activeObj.shape&&l[0]!=="crop"){if(t.activeObj.shape!=="line"&&t.activeObj.shape!=="arrow"&&t.activeObj.shape!=="path"&&t.activeObj.rotatedAngle!==0&&this.dragPoint.startX?(this.dragPoint.startX&&this.dragPoint.startY&&(this.previousPoint.x=this.dragPoint.endX,this.previousPoint.y=this.dragPoint.endY,this.dragPoint.endX=e,this.dragPoint.endY=i),o=this.dragPoint.endX-this.previousPoint.x,a=this.dragPoint.endY-this.previousPoint.y,this.adjustRotationPoints(r,o,a,t.activeObj.rotatedAngle)):(r.startX=e,r.width=r.endX-r.startX),t.activeObj.shape==="line"||t.activeObj.shape==="arrow"||t.activeObj.shape==="path")r.startY=i,r.height=r.endY-r.startY,this.adjustActObjForLineArrow()&&(this.dragElement="e-resize",t.activeObj.triangleDirection==="right"?t.activeObj.triangleDirection="left":t.activeObj.triangleDirection==="left"&&(t.activeObj.triangleDirection="right"));else if(r.startX>r.endX){var p=r.startX;r.startX=r.endX,r.endX=p,this.dragElement=this.resizedElement="e-resize"}this.revertResizing(s)}else{var h=t.img,u=h.destLeft,c=h.destTop,g=h.destHeight;if(this.isCustomSelection())this.performNWResize(e,i,s,r);else if(r.startX<e&&r.endY>i){o=e-r.startX,a=r.endY-i,n=Math.min(o,a);var v=this.getScaleRatio(n);r.startX+=v.x,r.endY-=v.y,(r.startX<u||r.endY>c+g)&&(r.startX-=v.x,r.endY+=v.y)}else{o=r.startX-e,a=i-r.endY,n=Math.max(o,a);var v=this.getScaleRatio(n);r.startX-=v.x,r.endY+=v.y,(r.startX<u||r.endY>c+g)&&(r.startX+=v.x,r.endY-=v.y)}r.width=r.endX-r.startX,r.height=r.endY-r.startY,this.revertResizing(s)}}},d.prototype.updateEPoints=function(e,i){var t=this.parent,r=t.activeObj.activePoint,o,a,n,s=f({},t.activeObj,null,!0);if(t.activeObj.shape!=="text"){var l=void 0;if(t.activeObj.shape&&(l=t.activeObj.shape.split("-")),t.activeObj.shape==="crop-custom"||t.activeObj.shape&&l[0]!=="crop"){if(t.activeObj.shape!=="line"&&t.activeObj.shape!=="arrow"&&t.activeObj.shape!=="path"&&t.activeObj.rotatedAngle!==0&&this.dragPoint.startX?(this.dragPoint.startX&&this.dragPoint.startY&&(this.previousPoint.x=this.dragPoint.endX,this.previousPoint.y=this.dragPoint.endY,this.dragPoint.endX=e,this.dragPoint.endY=i),o=this.dragPoint.endX-this.previousPoint.x,a=this.dragPoint.endY-this.previousPoint.y,this.adjustRotationPoints(r,o,a,t.activeObj.rotatedAngle)):(r.endX=e,r.width=r.endX-r.startX),t.activeObj.shape==="line"||t.activeObj.shape==="arrow"||t.activeObj.shape==="path")r.endY=i,r.height=r.endY-r.startY,this.adjustActObjForLineArrow()&&(this.dragElement="w-resize",t.activeObj.triangleDirection==="right"?t.activeObj.triangleDirection="left":t.activeObj.triangleDirection==="left"&&(t.activeObj.triangleDirection="right"));else if(r.endX<r.startX){var p=r.endX;r.endX=r.startX,r.startX=p,this.dragElement=this.resizedElement="w-resize"}this.revertResizing(s)}else{var h=t.img,u=h.destLeft,c=h.destTop,g=h.destWidth,v=h.destHeight;if(this.isCustomSelection())this.performSEResize(e,i,s,r);else if(r.endX>e&&r.endY>i){o=r.endX-e,a=r.endY-i,n=Math.min(o,a);var b=this.getScaleRatio(n);r.endX-=b.x,r.endY-=b.y,(r.endX>u+g||r.endY>c+v)&&(r.endX+=b.x,r.endY+=b.y)}else{o=e-r.endX,a=i-r.endY,n=Math.max(o,a);var b=this.getScaleRatio(n);r.endX+=b.x,r.endY+=b.y,(r.endX>u+g||r.endY>c+v)&&(r.endX-=b.x,r.endY-=b.y)}r.width=r.endX-r.startX,r.height=r.endY-r.startY,this.revertResizing(s)}}},d.prototype.updateSWPoints=function(e,i){var t=this.parent,r=t.activeObj.activePoint,o,a,n,s=f({},t.activeObj,null,!0);if(t.activeObj.shape==="text")this.resizeImg(e,i,"sw-resize",s),t.notify("shape",{prop:"updateFontSize",onPropertyChange:!1,value:{obj:t.activeObj}});else{var l=void 0;if(t.activeObj.shape!==void 0&&(l=t.activeObj.shape.split("-")),t.activeObj.shape==="crop-custom"||t.activeObj.shape!==void 0&&l[0]!=="crop"||this.isCustomSelection()){if(t.activeObj.shape==="image"||this.isCustomSelection()?this.resizeImg(e,i,"sw-resize",s):this.adjustSWPoints(r,e,i,t.activeObj.rotatedAngle),r.startX>r.endX){var p=r.startX;r.startX=r.endX,r.endX=p,this.dragElement=t.upperCanvas.style.cursor=t.cursor="se-resize"}if(r.endY<r.startY){var p=r.endY;r.endY=r.startY,r.startY=p,this.dragElement=t.upperCanvas.style.cursor=t.cursor="nw-resize"}this.revertCustomSelection(r,s,"sw-resize"),this.revertResizing(s)}else{var h=t.img,u=h.destLeft,c=h.destTop,g=h.destHeight;if(r.startX<e&&r.endY>i){o=e-r.startX,a=r.endY-i,n=Math.min(o,a);var v=this.getScaleRatio(n);r.startX+=v.x,r.endY-=v.y;var b=u>0?u:0,m=c+g<t.lowerCanvas.height?c+g:t.lowerCanvas.height;(r.startX<b||r.endY>m)&&(r.startX-=v.x,r.endY+=v.y)}else{o=r.startX-e,a=i-r.endY,n=Math.max(o,a);var v=this.getScaleRatio(n);r.startX-=v.x,r.endY+=v.y;var b=u>0?u:0,m=c+g<t.lowerCanvas.height?c+g:t.lowerCanvas.height;(r.startX<b||r.endY>m)&&(r.startX+=v.x,r.endY-=v.y)}r.width=r.endX-r.startX,r.height=r.endY-r.startY,this.revertResizing(s)}r.width=r.endX-r.startX,r.height=r.endY-r.startY,this.preventInverseResize(s)}},d.prototype.updateSPoints=function(e,i){var t=this.parent,r=t.activeObj.activePoint,o,a,n,s=f({},t.activeObj,null,!0);if(t.activeObj.shape!=="text"){var l=void 0;if(t.activeObj.shape&&(l=t.activeObj.shape.split("-")),t.activeObj.shape==="crop-custom"||t.activeObj.shape&&l[0]!=="crop"){if(t.activeObj.shape!=="line"&&t.activeObj.shape!=="arrow"&&t.activeObj.shape!=="path"&&t.activeObj.rotatedAngle!==0&&this.dragPoint.startX?(this.dragPoint.startX&&this.dragPoint.startY&&(this.previousPoint.x=this.dragPoint.endX,this.previousPoint.y=this.dragPoint.endY,this.dragPoint.endX=e,this.dragPoint.endY=i),o=this.dragPoint.endX-this.previousPoint.x,a=this.dragPoint.endY-this.previousPoint.y,this.adjustRotationPoints(r,o,a,t.activeObj.rotatedAngle)):(r.endY=i,r.height=r.endY-r.startY),r.endY<r.startY){var p=r.endY;r.endY=r.startY,r.startY=p,this.dragElement=this.resizedElement="n-resize"}this.revertResizing(s)}else{var h=t.img,u=h.destLeft,c=h.destTop,g=h.destWidth,v=h.destHeight;if(this.isCustomSelection())this.performSEResize(e,i,s,r);else if(r.endX>e&&r.endY>i){o=r.endX-e,a=r.endY-i,n=Math.min(o,a);var b=this.getScaleRatio(n);r.endX-=b.x,r.endY-=b.y,(r.endX>u+g||r.endY>c+v)&&(r.endX+=b.x,r.endY+=b.y)}else{o=e-r.endX,a=i-r.endY,n=Math.max(o,a);var b=this.getScaleRatio(n);r.endX+=b.x,r.endY+=b.x,(r.endX>u+g||r.endY>c+v)&&(r.endX-=b.x,r.endY-=b.y)}r.width=r.endX-r.startX,r.height=r.endY-r.startY,this.revertResizing(s)}}},d.prototype.updateSEPoints=function(e,i){var t=this.parent,r=t.activeObj.activePoint,o,a,n,s=f({},t.activeObj,null,!0);if(t.activeObj.shape==="text")this.resizeImg(e,i,"se-resize",s),t.notify("shape",{prop:"updateFontSize",onPropertyChange:!1,value:{obj:t.activeObj}});else{var l=void 0,p=void 0;if(t.activeObj.shape!==void 0&&(l=t.activeObj.shape.split("-")),t.activeObj.shape==="crop-custom"||t.activeObj.shape!==void 0&&l[0]!=="crop"||this.isCustomSelection()){if(t.activeObj.shape==="image"||this.isCustomSelection()?this.resizeImg(e,i,"se-resize",s):this.adjustSEPoints(r,e,i,t.activeObj.rotatedAngle),r.endX<r.startX){var h=r.endX;r.endX=r.startX,r.startX=h,this.dragElement=t.upperCanvas.style.cursor=t.cursor="sw-resize"}if(r.endY<r.startY){var h=r.endY;r.endY=r.startY,r.startY=h,this.dragElement=t.upperCanvas.style.cursor=t.cursor="ne-resize"}this.revertCustomSelection(r,s,"se-resize"),this.revertResizing(s)}else{var u=t.img,c=u.destLeft,g=u.destTop,v=u.destWidth,b=u.destHeight;if(r.endX>e&&r.endY>i){o=r.endX-e,a=r.endY-i,n=Math.min(o,a),p=this.getScaleRatio(n),r.endX-=p.x,r.endY-=p.y;var m=c+v<t.lowerCanvas.width?c+v:t.lowerCanvas.width,y=g+b<t.lowerCanvas.height?g+b:t.lowerCanvas.height;(r.endX>m||r.endY>y)&&(r.endX+=p.x,r.endY+=p.y)}else{o=e-r.endX,a=i-r.endY,n=Math.max(o,a),p=this.getScaleRatio(n),r.endX+=p.x,r.endY+=p.y;var m=c+v<t.lowerCanvas.width?c+v:t.lowerCanvas.width,y=g+b<t.lowerCanvas.height?g+b:t.lowerCanvas.height;(r.endX>m||r.endY>y)&&(r.endX-=p.x,r.endY-=p.y)}r.width=r.endX-r.startX,r.height=r.endY-r.startY,this.revertResizing(s)}this.preventInverseResize(s)}},d.prototype.resizeImg=function(e,i,t,r){var o=this.parent,a=o.activeObj.activePoint,n,s,l,p;if(this.previousPoint.x!==0&&this.previousPoint.y!==0){if(this.currentDrawingShape==="text"&&(this.setCursor(e,i),o.activeObj.textSettings.fontSize===0)){o.activeObj.textSettings.fontSize=11,o.notify("shape",{prop:"updateFontRatio",onPropertyChange:!1,value:{obj:o.activeObj,isTextArea:null}}),o.activeObj.textSettings.text=o.activeObj.keyHistory="Enter Text",o.notify("shape",{prop:"updateFontStyles",onPropertyChange:!1,value:{isTextBox:null}});var h=this.upperContext.measureText(o.activeObj.textSettings.text).width+o.activeObj.textSettings.fontSize*.5;a.endX=a.startX+h,a.endY=a.startY+o.activeObj.textSettings.fontSize,a.width=a.endX-a.startX,a.height=a.endY-a.startY,r=f({},o.activeObj,null,!0),o.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:o.activeObj.activePoint,obj:o.activeObj,isMouseMove:null,x:null,y:null}})}switch(o.upperCanvas.style.cursor){case"se-resize":case"s-resize":this.previousPoint.x>e||this.previousPoint.y>i?(n=this.previousPoint.x-e,s=this.previousPoint.y-i,l=(n+s)/2,p=this.getScaleRatio(l),this.adjustRotationPoints(a,-Math.abs(p.x),-Math.abs(p.y),o.activeObj.rotatedAngle,"img-resize",t)):this.previousPoint.x!==0&&this.previousPoint.y!==0&&(n=e-this.previousPoint.x,s=i-this.previousPoint.y,l=(n+s)/2,p=this.getScaleRatio(l),this.adjustRotationPoints(a,Math.abs(p.x),Math.abs(p.y),o.activeObj.rotatedAngle,"img-resize",t));break;case"sw-resize":this.previousPoint.x<e||this.previousPoint.y>i?(n=e-this.previousPoint.x,s=this.previousPoint.y-i,l=(n+s)/2,p=this.getScaleRatio(l),this.adjustRotationPoints(a,-Math.abs(p.x),-Math.abs(p.y),o.activeObj.rotatedAngle,"img-resize",t)):this.previousPoint.x!==0&&this.previousPoint.y!==0&&(n=this.previousPoint.x-e,s=i-this.previousPoint.y,l=(n+s)/2,p=this.getScaleRatio(l),this.adjustRotationPoints(a,Math.abs(p.x),Math.abs(p.y),o.activeObj.rotatedAngle,"img-resize",t));break;case"w-resize":case"nw-resize":this.previousPoint.x<e||this.previousPoint.y<i?(n=e-this.previousPoint.x,s=i-this.previousPoint.y,l=(n+s)/2,p=this.getScaleRatio(l),this.adjustRotationPoints(a,-Math.abs(p.x),-Math.abs(p.y),o.activeObj.rotatedAngle,"img-resize",t)):this.previousPoint.x!==0&&this.previousPoint.y!==0&&(n=this.previousPoint.x-e,s=this.previousPoint.y-i,l=(n+s)/2,p=this.getScaleRatio(l),this.adjustRotationPoints(a,Math.abs(p.x),Math.abs(p.y),o.activeObj.rotatedAngle,"img-resize",t));break;case"n-resize":case"ne-resize":this.previousPoint.x>e||this.previousPoint.y<i?(n=this.previousPoint.x-e,s=i-this.previousPoint.y,l=(n+s)/2,p=this.getScaleRatio(l),this.adjustRotationPoints(a,-Math.abs(p.x),-Math.abs(p.y),o.activeObj.rotatedAngle,"img-resize",t)):this.previousPoint.x!==0&&this.previousPoint.y!==0&&(n=e-this.previousPoint.x,s=this.previousPoint.y-i,l=(n+s)/2,p=this.getScaleRatio(l),this.adjustRotationPoints(a,Math.abs(p.x),Math.abs(p.y),o.activeObj.rotatedAngle,"img-resize",t));break;case"e-resize":this.previousPoint.x>e||this.previousPoint.y>i?(n=this.previousPoint.x-e,s=this.previousPoint.y-i,l=(n+s)/2,p=this.getScaleRatio(l),this.adjustRotationPoints(a,-Math.abs(p.x),-Math.abs(p.y),o.activeObj.rotatedAngle,"img-resize",t)):this.previousPoint.x!==0&&this.previousPoint.y!==0&&(n=e-this.previousPoint.x,s=i-this.previousPoint.y,l=(n+s)/2,p=this.getScaleRatio(l),this.adjustRotationPoints(a,Math.abs(p.x),Math.abs(p.y),o.activeObj.rotatedAngle,"img-resize",t));break}a.width=a.endX-a.startX,a.height=a.endY-a.startY,(a.width<10||a.height<10||o.activeObj.shape==="text"&&o.activeObj.rotatedAngle===0&&this.preventTextDraggingInvertly())&&(o.activeObj=f({},r,null,!0))}this.previousPoint={x:e,y:i}},d.prototype.adjustNWPoints=function(e,i,t,r){var o=e.startX+e.width/2,a=e.startY+e.height/2,n=this.rotatePoints(e.endX,e.endY,o,a,r),s=[(n[0]+i)/2,(n[1]+t)/2],l=this.rotatePoints(n[0],n[1],s[0],s[1],-r),p=this.rotatePoints(i,t,s[0],s[1],-r);return e.endX=l[0],e.endY=l[1],e.startY=p[1],e.startX=p[0],e.width=e.endX-e.startX,e.height=e.endY-e.startY,e},d.prototype.adjustNEPoints=function(e,i,t,r){var o=e.startX+e.width/2,a=e.startY+e.height/2,n=this.rotatePoints(e.startX,e.endY,o,a,r),s=[(n[0]+i)/2,(n[1]+t)/2],l=this.rotatePoints(n[0],n[1],s[0],s[1],-r),p=this.rotatePoints(i,t,s[0],s[1],-r);return e.startX=l[0],e.endY=l[1],e.width=p[0]-l[0],e.height=l[1]-p[1],e.endX=e.startX+e.width,e.startY=e.endY-e.height,e},d.prototype.adjustSWPoints=function(e,i,t,r){var o=e.startX+e.width/2,a=e.startY+e.height/2,n=this.rotatePoints(e.endX,e.startY,o,a,r),s=[(n[0]+i)/2,(n[1]+t)/2],l=this.rotatePoints(n[0],n[1],s[0],s[1],-r),p=this.rotatePoints(i,t,s[0],s[1],-r);return e.endX=l[0],e.startY=l[1],e.startX=p[0],e.endY=p[1],e.width=e.endX-e.startX,e.height=e.endY-e.startY,e},d.prototype.adjustSEPoints=function(e,i,t,r){var o=e.startX+e.width/2,a=e.startY+e.height/2,n=this.rotatePoints(e.startX,e.startY,o,a,r),s=[(n[0]+i)/2,(n[1]+t)/2],l=this.rotatePoints(n[0],n[1],s[0],s[1],-r),p=this.rotatePoints(i,t,s[0],s[1],-r);return e.startX=l[0],e.startY=l[1],e.width=p[0]-l[0],e.height=p[1]-l[1],e.endX=e.startX+e.width,e.endY=e.startY+e.height,e},d.prototype.adjustRotationPoints=function(e,i,t,r,o,a){var n=e.startX+e.width/2,s=e.startY+e.height/2;this.getResizeDirection(e,i,t,r,o,a);var l=this.rotatePoints(e.startX,e.startY,n,s,r),p=this.rotatePoints(e.endX,e.startY,n,s,r),h=this.rotatePoints(e.endX,e.endY,n,s,r),u=this.rotatePoints(e.startX,e.endY,n,s,r),c=[(l[0]+h[0])/2,(l[1]+h[1])/2],g=this.rotatePoints(l[0],l[1],c[0],c[1],-r),v=this.rotatePoints(u[0],u[1],c[0],c[1],-r),b=this.rotatePoints(p[0],p[1],c[0],c[1],-r);return e.startX=g[0],e.startY=g[1],e.endX=b[0],e.endY=v[1],e.width=e.endX-e.startX,e.height=e.endY-e.startY,e},d.prototype.rotatePoints=function(e,i,t,r,o){return[(e-t)*Math.cos(o)-(i-r)*Math.sin(o)+t,(e-t)*Math.sin(o)+(i-r)*Math.cos(o)+r]},d.prototype.setResizedValue=function(e,i,t,r){switch(e){case"x":i+=t;break;case"y":i+=r;break;case"abs-x":i+=t>0?-t:Math.abs(t);break;case"abs-y":i+=r>0?-r:Math.abs(r);break;case"y-abs-x":i+=r+(t>0?-t:Math.abs(t))/2;break;case"abs-x-abs-y":i+=(t>0?-t:Math.abs(t))+(r>0?-r:Math.abs(r))/2;break;case"abs-y-x":i+=(r>0?-r:Math.abs(r))+t/2;break;case"x-y":i+=t+r/2;break;case"y-x":i+=r+t/2;break;case"img-resize-x":i+=t;break;case"img-resize-y":i+=r;break}return i},d.prototype.getResizeDirection=function(e,i,t,r,o,a){var n=r*(180/Math.PI),s=this.getResizedElement(n,this.resizedElement);this.resizedElement==="e-resize"?(e.width=this.setResizedValue(s,e.width,i,t),e.endX=e.width+e.startX):this.resizedElement==="n-resize"?(e.startY=this.setResizedValue(s,e.startY,i,t),e.height=e.endY-e.startY):this.resizedElement==="w-resize"?(e.startX=this.setResizedValue(s,e.startX,i,t),e.width=e.startX+e.endX):this.resizedElement==="s-resize"?(e.height=this.setResizedValue(s,e.height,i,t),e.endY=e.height+e.startY):o&&o==="img-resize"?(e.width=this.setResizedValue("img-resize-x",e.width,i,t),e.height=this.setResizedValue("img-resize-y",e.height,i,t),a==="se-resize"?(e.endX=e.width+e.startX,e.endY=e.height+e.startY):a==="sw-resize"?(e.startX=e.endX-e.width,e.endY=e.height+e.startY):a==="ne-resize"?(e.endX=e.width+e.startX,e.startY=e.endY-e.height):a==="nw-resize"&&(e.startX=e.endX-e.width,e.startY=e.endY-e.height)):o&&o==="text"&&(a==="widthHeight"?(e.width=this.setResizedValue("x-y",e.width,i,t),e.endX=e.width+e.startX,e.height=this.setResizedValue("y-x",e.height,i,t),e.endY=e.height+e.startY):a==="width"?(e.width=this.setResizedValue("x-y",e.width,i,t),e.endX=e.width+e.startX):a==="height"&&(e.height=this.setResizedValue("y-abs-x",e.height,i,t),e.endY=e.height+e.startY))},d.prototype.getResizedElement=function(e,i){var t=[];i==="n-resize"?t=[[337.5,360,"y"],[0,22.5,"y"],[22.5,67.5,"y-abs-x"],[67.5,112.5,"abs-x"],[112.5,157.5,"abs-x-abs-y"],[157.5,202.5,"abs-y"],[202.5,247.5,"abs-y-x"],[247.5,292.5,"x"],[292.5,337.5,"x-y"]]:i==="e-resize"?t=[[337.5,360,"x"],[0,22.5,"x"],[22.5,67.5,"x-y"],[67.5,112.5,"y"],[112.5,157.5,"y-abs-x"],[157.5,202.5,"abs-x"],[202.5,247.5,"abs-x-abs-y"],[247.5,292.5,"abs-y"],[292.5,337.5,"abs-y-x"]]:i==="s-resize"?t=[[337.5,360,"y"],[0,22.5,"y"],[22.5,67.5,"y-abs-x"],[67.5,112.5,"abs-x"],[112.5,157.5,"abs-x-abs-y"],[157.5,202.5,"abs-y"],[202.5,247.5,"abs-y-x"],[247.5,292.5,"x"],[292.5,337.5,"x-y"]]:i==="w-resize"&&(t=[[337.5,360,"x"],[0,22.5,"x"],[22.5,67.5,"x-y"],[67.5,112.5,"y"],[112.5,157.5,"y-abs-x"],[157.5,202.5,"abs-x"],[202.5,247.5,"abs-x-abs-y"],[247.5,292.5,"abs-y"],[292.5,337.5,"abs-y-x"]]);for(var r=e<0?360-Math.abs(e):e,o=0,a=t;o<a.length;o++){var n=a[o],s=n[0],l=n[1],p=n[2];if(r>s&&r<=l||r+360>s&&r+360<=l)return p}return i},d.prototype.updateCursorStyles=function(e,i,t){var r=this.parent,o=!1;r.activeObj.keyHistory!==""&&r.activeObj.shape===void 0&&!r.currObjType.isCustomCrop&&!r.currObjType.isLine&&r.currObjType.isText&&(r.activeObj.shape="text");var a=f({},r.activeObj,{},!0);if(!C(a.topLeftCircle)){if(a.shapeDegree===0?r.transform.degree:r.transform.degree-a.shapeDegree,this.isObjSelected)if(a.shape==="line"||a.shape==="arrow")o=this.updateCursorStylesForLineArrow(e,i,a);else if(a.shape==="path")o=this.updateCursorStylesForPath(e,i,a);else if(a.rotatedAngle)this.setCursorForRotatedObject(a,e,i,r.upperCanvas),r.cursor==="grabbing"?(r.upperCanvas.style.cursor=r.cursor="grabbing",this.dragElement=r.cursor):r.cursor==="move"?(this.dragPoint.startX=this.previousPoint.x=this.dragPoint.endX=e,this.dragPoint.startY=this.previousPoint.y=this.dragPoint.endY=i):r.cursor!=="default"&&(o=!0,this.dragElement=r.cursor,r.currObjType.isResize=!0);else{var n=this.getTransRotationPoint(a),s=a.topLeftCircle.radius;n&&e>=n.x-s*2&&e<=n.x+s*2&&i>=n.y-s*2&&i<=n.y+s*2&&this.dragElement!=="grabbing"?(r.upperCanvas.style.cursor=r.cursor="grabbing",this.dragElement=r.upperCanvas.style.cursor):e>=a.topLeftCircle.startX-s*2&&e<=a.topLeftCircle.startX+s*2&&i>=a.topLeftCircle.startY-s*2&&i<=a.topLeftCircle.startY+s*2&&this.dragElement!=="nw-resize"?(a.topLeftCircle.startX=a.topLeftCircle.startY=0,r.upperCanvas.style.cursor=r.cursor="nw-resize",o=!0,this.dragElement=r.upperCanvas.style.cursor):e>=a.topLeftCircle.startX-s*2&&e<=a.topRightCircle.startX-s*2&&i>=a.topCenterCircle.startY-s*2&&i<=a.topCenterCircle.startY+s*2&&this.dragElement!=="n-resize"?(a.topCenterCircle.startX=a.topCenterCircle.startY=0,r.upperCanvas.style.cursor=r.cursor="n-resize",o=!0,this.dragElement=r.upperCanvas.style.cursor):e>=a.topRightCircle.startX-s*2&&e<=a.topRightCircle.startX+s*2&&i>=a.topRightCircle.startY-s*2&&i<=a.topRightCircle.startY+s*2&&this.dragElement!=="ne-resize"?(a.topRightCircle.startX=a.topRightCircle.startY=0,r.upperCanvas.style.cursor=r.cursor="ne-resize",o=!0,this.dragElement=r.upperCanvas.style.cursor):e>=a.centerLeftCircle.startX-s*2&&e<=a.centerLeftCircle.startX+s*2&&i>=a.topLeftCircle.startY-s*2&&i<=a.bottomLeftCircle.startY-s*2&&this.dragElement!=="w-resize"?(a.centerLeftCircle.startX=a.centerLeftCircle.startY=0,r.upperCanvas.style.cursor=r.cursor="w-resize",o=!0,this.dragElement=r.upperCanvas.style.cursor):e>=a.centerRightCircle.startX-s*2&&e<=a.centerRightCircle.startX+s*2&&i>=a.topRightCircle.startY-s*2&&i<=a.bottomRightCircle.startY-s*2&&this.dragElement!=="e-resize"?(a.centerRightCircle.startX=a.centerRightCircle.startY=0,r.upperCanvas.style.cursor=r.cursor="e-resize",o=!0,this.dragElement=r.upperCanvas.style.cursor):e>=a.bottomLeftCircle.startX-s*2&&e<=a.bottomLeftCircle.startX+s*2&&i>=a.bottomLeftCircle.startY-s*2&&i<=a.bottomLeftCircle.startY+s*2&&this.dragElement!=="sw-resize"?(a.bottomLeftCircle.startX=a.bottomLeftCircle.startY=0,r.upperCanvas.style.cursor=r.cursor="sw-resize",o=!0,this.dragElement=r.upperCanvas.style.cursor):e>=a.bottomLeftCircle.startX-s*2&&e<=a.bottomRightCircle.startX-s*2&&i>=a.bottomCenterCircle.startY-s*2&&i<=a.bottomCenterCircle.startY+s*2&&this.dragElement!=="s-resize"?(a.bottomCenterCircle.startX=a.bottomCenterCircle.startY=0,r.upperCanvas.style.cursor=r.cursor="s-resize",o=!0,this.dragElement=r.upperCanvas.style.cursor):e>=a.bottomRightCircle.startX-s*2&&e<=a.bottomRightCircle.startX+s*2&&i>=a.bottomRightCircle.startY-s*2&&i<=a.bottomRightCircle.startY+s*2&&this.dragElement!=="se-resize"?(a.bottomRightCircle.startX=a.bottomRightCircle.startY=0,r.upperCanvas.style.cursor=r.cursor="se-resize",o=!0,this.dragElement=r.upperCanvas.style.cursor):(this.dragPoint.startX=this.previousPoint.x=this.dragPoint.endX=e,this.dragPoint.startY=this.previousPoint.y=this.dragPoint.endY=i),a.shape==="text"&&(r.cursor==="n-resize"||r.cursor==="s-resize"||r.cursor==="e-resize"||r.cursor==="w-resize")&&(r.upperCanvas.style.cursor=r.cursor="move",this.dragElement="",this.dragPoint.startX=this.previousPoint.x=this.dragPoint.endX=e,this.dragPoint.startY=this.previousPoint.y=this.dragPoint.endY=i)}else this.dragPoint.startX=this.previousPoint.x=this.dragPoint.endX=e,this.dragPoint.startY=this.previousPoint.y=this.dragPoint.endY=i;this.previousPoint.x=this.previousPoint.y=this.diffPoint.x=this.diffPoint.y=0,t==="touchstart"?o||e>=a.activePoint.startX&&e<=a.activePoint.endX&&i>=a.activePoint.startY&&i<=a.activePoint.endY||this.dragElement==="grabbing"?r.currObjType.isDragging=!0:a.shape==="line"||a.shape==="arrow"?(this.setCursorForLineArrow(a,e,i,r.upperCanvas),r.cursor==="move"&&(r.currObjType.isDragging=!0)):a.shape==="path"&&(this.setCursorForPath(a,e,i,r.upperCanvas),r.cursor==="move"&&(r.currObjType.isDragging=!0)):r.currObjType.isDragging=!0,a.rotatedAngle!==0&&(this.dragElement==="e-resize"||this.dragElement==="w-resize"||this.dragElement==="n-resize"||this.dragElement==="s-resize")&&(this.dragPoint.startX=this.previousPoint.x=this.dragPoint.endX=e,this.dragPoint.startY=this.previousPoint.y=this.dragPoint.endY=i)}},d.prototype.updateCursorStylesForLineArrow=function(e,i,t){for(var r=!1,o=this.parent,a,n=t.topLeftCircle.radius,s=0;s<5;s++)if(a=t.pointColl[s],e>=a.x-n*2&&e<=a.x+n*2&&i>=a.y-n*2&&i<=a.y+n*2){t.centerLeftCircle.startX=t.centerLeftCircle.startY=0,this.dragElement="w-resize",r=!0;break}if(!r){for(var s=1;s<6;s++)if(a=t.pointColl[t.pointColl.length-s],e>=a.x-n*2&&e<=a.x+n*2&&i>=a.y-n*2&&i<=a.y+n*2){t.centerRightCircle.startX=t.centerRightCircle.startY=0,this.dragElement="e-resize",r=!0;break}}if(!r)for(var s=0;s<t.pointColl.length;s++)if(a=t.pointColl[s],e>=a.x-n*2&&e<=a.x+n*2&&i>=a.y-n*2&&i<=a.y+n*2){o.upperCanvas.style.cursor=o.cursor="move",this.dragPoint.startX=this.previousPoint.x=this.dragPoint.endX=e,this.dragPoint.startY=this.previousPoint.y=this.dragPoint.endY=i;break}else o.upperCanvas.style.cursor=o.cursor="default";return r},d.prototype.updateCursorStylesForPath=function(e,i,t){var r=!1,o=this.parent;return this.pathAdjustedIndex=this.setCursorForLineArrow(t,e,i,o.upperCanvas),o.cursor==="move"&&(r=!0,this.dragElement="pathDrag"),r||(o.upperCanvas.style.cursor=o.cursor="move",this.dragPoint.startX=this.previousPoint.x=this.dragPoint.endX=e,this.dragPoint.startY=this.previousPoint.y=this.dragPoint.endY=i),r},d.prototype.setTextSelection=function(e,i){var t=this.parent,r=t.activeObj.activePoint,o=t.transform.degree;t.activeObj.shapeDegree===0?o=t.transform.degree:o=t.transform.degree-t.activeObj.shapeDegree;var a=t.activeObj.rotateFlipColl;if(this.isTransformedShape&&a){o=0;for(var n=0;n<a.length;n++)typeof a[n]=="number"&&(o+=a[n])}o<0&&(o=360+o);for(var n=0,s=t.activeObj.flipObjColl.length;n<s;n++){var l=t.activeObj.flipObjColl[n].toLowerCase();switch(o){case 0:switch(l){case"horizontal":r={startX:r.endX-e,startY:r.startY,endX:r.endX,endY:r.startY+(i||0)};break;case"vertical":r.startY=r.endY-i,r={startX:r.startX,startY:r.startY,endX:r.startX+(e||0),endY:r.endY};break;default:r={startX:r.startX,startY:r.startY,endX:r.startX+(e||0),endY:r.startY+(i||0)};break}break;case 90:switch(l){case"horizontal":r.endX=r.startX+i,r={startX:r.startX,startY:r.startY,endX:r.endX,endY:r.startY+(e||0)};break;case"vertical":r.startX=r.endX-i,r={startX:r.startX,startY:r.endY-e,endX:r.endX,endY:r.endY};break;default:r.startX=r.endX-i,r={startX:r.startX,startY:r.startY,endX:r.endX,endY:r.startY+(e||0)};break}break;case 180:switch(l){case"horizontal":r.startY=r.endY-i,r={startX:r.startX,startY:r.startY,endX:r.startX+e,endY:r.endY};break;case"vertical":r.endY=r.startY+i,r={endX:r.endX,endY:r.endY,startX:r.endX-(e||0),startY:r.startY};break;default:r={endX:r.endX,endY:r.endY,startX:r.endX-(e||0),startY:r.endY-(i||0)};break}break;case 270:switch(l){case"horizontal":r.startX=r.endX-i,r={startX:r.startX,startY:r.endY-(e||0),endX:r.endX,endY:r.endY};break;case"vertical":r={startX:r.startX,startY:r.startY,endX:r.startX+i,endY:r.startY+(e||0)};break;default:r.endX=r.startX+i,r={startX:r.startX,startY:r.endY-(e||0),endX:r.endX,endY:r.endY};break}break}}if(t.activeObj.flipObjColl.length===0)switch(o){case 0:r={startX:r.startX,startY:r.startY,endX:r.startX+(e||0),endY:r.startY+(i||0)};break;case 90:r.startX=r.endX-i,r={startX:r.startX,startY:r.startY,endX:r.endX,endY:r.startY+(e||0)};break;case 180:r={endX:r.endX,endY:r.endY,startX:r.endX-(e||0),startY:r.endY-(i||0)};break;case 270:r.endX=r.startX+i,r={startX:r.startX,startY:r.endY-(e||0),endX:r.endX,endY:r.endY};break}r.width=r.endX-r.startX,r.height=r.endY-r.startY,t.activeObj.activePoint=r,(t.transform.degree===360||t.transform.degree===-360)&&(t.transform.degree=0)},d.prototype.setActivePoint=function(e,i){var t=this.parent,r=t.activeObj.activePoint;if(!C(r))if(t.currObjType.isText){var o=e||0,a=i||t.activeObj.textSettings.fontSize;t.activeObj.textSettings.fontSize===void 0&&(t.activeObj.textSettings.fontSize=Math.abs(t.baseImgCanvas.width-t.baseImgCanvas.height)*.1),this.setTextSelection(o,a),this.mouseDownPoint.x=r.endX,this.mouseDownPoint.y=r.endY,t.activeObj.horTopLine!==void 0&&(t.activeObj.activePoint=f({},r,{},!0)),t.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}})}else if(e&&i)r.startX=this.mouseDownPoint.x=e,r.startY=this.mouseDownPoint.y=i,t.currObjType.isDragging=!0;else{var n=t.activeObj;r={startX:n.horTopLine.startX,startY:n.horTopLine.startY,endX:n.horTopLine.endX,endY:n.horTopLine.endY},r.width=r.endX-r.startX,r.height=r.endY-r.startY}},d.prototype.mouseDownEventHandler=function(e){var i=this.parent;if(i.isKBDNavigation=!1,this.mouseDown=e.currentTarget===i.lowerCanvas||e.currentTarget===i.upperCanvas?"canvas":"",e.type==="touchstart"?this.isTouch=!0:this.isTouch=!1,!(e.type==="touchstart"&&e.currentTarget===i.lowerCanvas&&!i.isImageLoaded)){this.isCropSelection=!1,this.isPan=!0;var t;if(i.activeObj.shape!==void 0&&(t=i.activeObj.shape.split("-")),t!==void 0&&t[0]==="crop"&&(this.isCropSelection=!0),this.isCropSelection&&(this.dragCanvas=i.togglePan=!0),i.cursor==="grabbing"){var r={shapeSettingsObj:{}};this.isGrabbing=!0,i.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:r}});var o=r.shapeSettingsObj,a={cancel:!1,action:"rotate-start",previousShapeSettings:o,allowShapeOverflow:this.allowOutofBound()},n={cancel:!1,action:"rotate-start",previousShapeSettings:o,allowShapeOverflow:this.allowOutofBound()};this.triggerShapeChange(a,n,"mouse-down")}var s={point:this.setXYPoints(e)};i.trigger("click",s),this.isMouseDown=!0,this.isMouseUp=!1,this.clickEvent(s,e)}},d.prototype.getImagePoints=function(e,i){var t=this.parent,r=t.img,o=r.destLeft,a=r.destTop,n=r.destWidth,s=r.destHeight;return e<o?e=o:e>o+n&&(e=o+n),i<a?i=a:i>a+s&&(i=a+s),{x:e,y:i}},d.prototype.clickEvent=function(e,i){var t=this.parent,r=t.activeObj.activePoint,o=e.point.x,a=e.point.y,n=t.activeObj.shape&&t.activeObj.shape==="text"?t.cursor:"default",s=t.upperCanvas.style.cursor;if(t.isResize){this.performEnterAction(i),t.upperCanvas.style.cursor="default";return}else if(JSON.stringify(t.frameObj)!==JSON.stringify(t.tempFrameObj))t.okBtn();else if(this.currentDrawingShape!==""&&!this.isShapeTouch(i,this.isCropSelection)&&(this.isTouch||s==="crosshair"||t.isShapeDrawing)){t.drawingShape&&!t.isShapeDrawing&&(t.okBtn(),t.enableShapeDrawing(t.toPascalCase(t.drawingShape),!0)),r=t.activeObj.activePoint;var l={currObj:{}};t.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:l}}),this.initialPrevObj=l.currObj,this.initialPrevObj.objColl=f([],t.objColl,[],!0),this.initialPrevObj.pointColl=f([],t.pointColl,[],!0),this.initialPrevObj.afterCropActions=f([],t.afterCropActions,[],!0);var p={selPointColl:null};if(t.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:p}}),this.initialPrevObj.selPointColl=f([],p.selPointColl,[],!0),this.setActivePoint(o,a),r=t.activeObj.activePoint,this.currentDrawingShape==="path"){var h=this.getImagePoints(o,a);t.activeObj.pointColl.push({x:h.x,y:h.y}),r.width!==0&&r.height!==0&&(r.width=0,r.height=0,r.startX=t.activeObj.pointColl[t.activeObj.pointColl.length-1].x,r.startY=t.activeObj.pointColl[t.activeObj.pointColl.length-1].y)}if(r.endX=r.startX,r.endY=r.startY,this.currentDrawingShape==="text"){t.activeObj.textSettings.fontSize=11,this.previousPoint.x=r.startX,this.previousPoint.y=r.startY,t.notify("shape",{prop:"updateFontStyles",onPropertyChange:!1,value:{isTextBox:null}});var u=this.upperContext.measureText(t.activeObj.textSettings.text).width+t.activeObj.textSettings.fontSize*.5;r.endX=r.startX+u,r.endY=r.startY+t.activeObj.textSettings.fontSize,r.width=r.endX-r.startX,r.height=r.endY-r.startY}else this.currentDrawingShape==="arrow"&&(t.activeObj.start=this.arrowShape[0],t.activeObj.end=this.arrowShape[1]);t.currObjType.isDragging=!0;var c=this.updatePrevShapeSettings(),g={cancel:!1,action:"draw-start",previousShapeSettings:c,allowShapeOverflow:this.allowOutofBound()},v={cancel:!1,action:"move",previousShapeSettings:c,allowShapeOverflow:this.allowOutofBound()};this.shapeResizingArgs=g,this.shapeMovingArgs=v,this.triggerShapeChange(g,v,"mouse-down"),t.activeObj.activePoint=r,t.isShapeDrawing=!0,this.tempActiveObj=f({},t.activeObj,{},!0);return}t.notify("draw",{prop:"resetFrameZoom",onPropertyChange:!1,value:{isOk:!0}}),this.isCropSelection&&this.dragCanvas&&(this.setCursor(o,a),t.cursor!=="move"&&t.cursor!=="crosshair"&&t.cursor!=="default"&&t.cursor!=="grab"&&(this.isPan=!1)),t.activeObj.shape?this.isObjSelected=!0:this.isObjSelected=!1;var b={currObj:{}};t.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:b}});var m=b.currObj,y=f({},t.activeObj,null,!0),P=this.isShapeTouch(i,this.isCropSelection),S=this.isFreehandDrawTouch(i,this.isCropSelection),O=P||this.isShapeClick(i,this.isCropSelection),j=this.applyCurrShape(O),x=t.textArea.style.display!=="none";if(this.isTouch&&!P&&y.shape&&!this.isCropSelection){this.applyObj(o,a)&&(t.okBtn(!0),t.notify("draw",{prop:"setPrevActObj",onPropertyChange:!1,value:{prevActObj:null}}));var k=f({},t.cropObj,{},!0);t.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:m,previousObjColl:m.objColl,previousPointColl:m.pointColl,previousSelPointColl:m.selPointColl,previousCropObj:k,previousText:null,currentText:null,previousFilter:null,isCircleCrop:t.isCircleCrop}}),j&&t.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}})}if(!P&&!t.togglePen&&!this.isCropSelection&&t.activeObj.redactType!=="blur"&&t.activeObj.redactType!=="pixelate"&&(t.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1}),t.notify("toolbar",{prop:"close-contextual-toolbar",onPropertyChange:!1})),this.dragCanvas&&this.isPan&&(t.cursor==="grab"||this.isTouch)&&!P&&!S&&!t.togglePen){if(this.applyObj(o,a)){if(t.okBtn(!0),j){var T=t.cursor;t.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}}),t.cursor=T}t.notify("draw",{prop:"setPrevActObj",onPropertyChange:!1,value:{prevActObj:null}})}this.isFhdEditing&&(t.notify("freehand-draw",{prop:"applyFhd",onPropertyChange:!1}),this.isFhdCustomized=!1,t.notify("toolbar",{prop:"destroy-qa-toolbar",onPropertyChange:!1}));var A=t.activeObj.shape,L=["rectangle","ellipse","line","arrow","path","text","image","redact"];A&&L.indexOf(A)>-1&&(t.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:null}}),t.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),t.notify("toolbar",{prop:"setCurrentToolbar",value:{type:"main"}}),t.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1}));var H=!1;t.activeObj.shape&&t.activeObj.shape.indexOf("crop-")>-1&&(H=!0),t.element.querySelector(".e-contextual-toolbar-wrapper")&&!H&&(t.element.querySelector(".e-contextual-toolbar-wrapper").classList.contains("e-hide")||(t.okBtn(),t.element.querySelector(".e-contextual-toolbar-wrapper").classList.add("e-hide"))),this.canvasMouseDownHandler(i)}else{var B=!1;t.activeObj.shape&&(t.activeObj.shape==="line"||t.activeObj.shape==="arrow")&&(B=!0);var D=this.setXYPoints(i),E=D.x,R=D.y;if(this.applyObj(E,R)){if(t.okBtn(!0),j){var Q=t.cursor;t.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}}),t.cursor=Q}t.notify("draw",{prop:"setPrevActObj",onPropertyChange:!1,value:{prevActObj:null}})}t.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:E,y:R,isMouseDown:!0}});var V={index:null};t.notify("freehand-draw",{prop:"getFreehandDrawHoveredIndex",onPropertyChange:!1,value:{obj:V}});var G={freehandSelectedIndex:null};if(t.notify("freehand-draw",{prop:"getFreehandSelectedIndex",onPropertyChange:!1,value:{obj:G}}),this.isFhdPoint||this.isFhdCustomized&&!t.togglePen){if(!C(G.freehandSelectedIndex)&&G.freehandSelectedIndex!==V.index){var W=V.index;if(t.okBtn(),this.isFhdCustomized=!1,t.notify("freehand-draw",{prop:"setFreehandDrawHoveredIndex",onPropertyChange:!1,value:{index:W}}),V.index>-1){var K=t.pointColl[V.index].strokeColor;t.notify("freehand-draw",{prop:"hoverFhd",onPropertyChange:!1,value:{strokeColor:K,strokeWidth:t.pointColl[V.index].strokeWidth}})}}G.freehandSelectedIndex=null,t.notify("freehand-draw",{prop:"getFreehandSelectedIndex",onPropertyChange:!1,value:{obj:G}});var $=f([],t.objColl,[],!0);if(!C(V.index)&&V.index>-1)t.notify("freehand-draw",{prop:"selectFhd",value:{type:"ok"}}),t.notify("freehand-draw",{prop:"hoverFhd",onPropertyChange:!1,value:{strokeColor:null,strokeWidth:null}}),t.notify("toolbar",{prop:"renderQAT",onPropertyChange:!1,value:{isPenEdit:!0}});else if(G.freehandSelectedIndex){t.okBtn();var K=t.pointColl[G.freehandSelectedIndex].strokeColor;t.notify("freehand-draw",{prop:"hoverFhd",onPropertyChange:!1,value:{strokeColor:K,strokeWidth:t.pointColl[G.freehandSelectedIndex].strokeWidth}})}else this.findTargetObj(E,R,!1)&&(t.objColl=$,this.findTarget(E,R,i.type),t.notify("draw",{prop:"redrawDownScale"}))}else{if(this.isFhdEditing){t.apply();var Z=document.getElementById(t.element.id+"_quickAccessToolbarArea");Z&&(Z.style.display="none");var h=t.pointColl[G.freehandSelectedIndex],pe={id:"pen_"+(G.freehandSelectedIndex+1),type:se.FreehandDraw,startX:h.points[0].x,startY:h.points[0].y,strokeColor:h.strokeColor,strokeWidth:h.strokeWidth,points:h.points,opacity:h.opacity,index:h.order},he={action:"apply",currentShapeSettings:f({},pe,{},!0)};t.trigger("shapeChange",he),t.editCompleteArgs=he}var ce=t.togglePen,Te=t.cursor;if(t.notify("toolbar",{prop:"close-contextual-toolbar",onPropertyChange:!1}),y.shape==="redact"&&Te!=="default"&&(t.cursor=Te),ce&&t.freeHandDraw(!0),this.isFhdEditing=!1,B?this.setCursor(E,R):n!=="default"&&(t.upperCanvas.style.cursor=t.cursor=n),t.cursor==="crosshair"||w.isDevice&&t.togglePen){if(t.togglePen){if(C(t.activeObj.strokeSettings)){var Ge={strokeSettings:{}};t.notify("shape",{prop:"getStrokeSettings",onPropertyChange:!1,value:{obj:Ge}}),t.activeObj.strokeSettings=Ge.strokeSettings}var Ke={penStrokeWidth:null};t.notify("freehand-draw",{prop:"getPenStrokeWidth",onPropertyChange:!1,value:{obj:Ke}}),C(Ke.penStrokeWidth)&&t.notify("freehand-draw",{prop:"setPenStrokeWidth",onPropertyChange:!1,value:{value:2}}),this.upperContext.strokeStyle=t.activeObj.strokeSettings.strokeColor,this.upperContext.fillStyle=t.activeObj.strokeSettings.strokeColor,t.notify("freehand-draw",{prop:"resetSelPoints",onPropertyChange:!1}),t.notify("freehand-draw",{prop:"freehandDownHandler",onPropertyChange:!1,value:{e:i,canvas:t.upperCanvas}})}else t.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height);t.currObjType.isActiveObj=!1,this.dragElement="",this.dragPoint.startX=this.dragPoint.startY=this.dragPoint.endX=this.dragPoint.endY=0}(this.isTouch&&Te!=="crosshair"||t.cursor!=="crosshair")&&i.type.toLowerCase()==="touchstart"||t.currObjType.isActiveObj&&t.cursor!=="default"&&!t.togglePen?(t.notify("draw",{prop:"updateTempObjColl"}),t.notify("draw",{prop:"updateTempPointColl"}),this.findTarget(E,R,i.type),t.notify("draw",{prop:"redrawDownScale"})):(t.currObjType.shape===""||t.currObjType.isCustomCrop)&&!t.togglePen&&t.cursor!=="default"&&this.setActivePoint(E,R),x&&t.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}})}}this.isShapeInserted=!1,this.tempActiveObj=f({},t.activeObj,{},!0)},d.prototype.mouseMoveEventHandler=function(e){var i=this.parent,t=i.cursor,r=i.upperCanvas.style.cursor;if(e.preventDefault(),!(this.isPreventShaping||i.isShapeDrawing&&i.currObjType.isDragging&&this.isTouch&&i.activeObj.shape&&i.activeObj.shape==="path")){if(i.cursor==="grabbing"&&this.isGrabbing){var o={shapeSettingsObj:{}};i.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:o}});var a=o.shapeSettingsObj,n={cancel:!1,action:"rotating",previousShapeSettings:a,allowShapeOverflow:this.allowOutofBound()},s={cancel:!1,action:"rotating",previousShapeSettings:a,allowShapeOverflow:this.allowOutofBound()};this.triggerShapeChange(n,s,"mouse-down")}if(this.timer&&this.timer>0&&this.dragPoint.startX&&this.dragPoint.startY){var l=Math.abs(this.dragPoint.startX-e.touches[0].clientX),p=Math.abs(this.dragPoint.startY-e.touches[0].clientY);(l>10||p>10)&&(this.timer=0)}var h=i.lowerCanvas.getBoundingClientRect();if(e.type==="touchmove"&&e.touches.length===2){if(this.isFirstMove)this.startTouches=this.targetTouches(e.touches),this.tempTouches=[],this.tempTouches.push({x:e.touches[0].clientX||e.touches[0].pageX-i.lowerCanvas.offsetLeft-h.left,y:(e.touches[0].clientY||e.touches[0].pageY-i.lowerCanvas.offsetTop)-h.top}),this.tempTouches.push({x:(e.touches[1].clientX||e.touches[1].pageX-i.lowerCanvas.offsetLeft)-h.left,y:(e.touches[1].clientY||e.touches[1].pageY-i.lowerCanvas.offsetTop)-h.top});else{var u=(e.touches[0].clientX||e.touches[0].pageX-i.lowerCanvas.offsetLeft)-h.left,c=(e.touches[0].clientY||e.touches[0].pageY-i.lowerCanvas.offsetTop)-h.top,g=(e.touches[1].clientX||e.touches[1].pageX-i.lowerCanvas.offsetLeft)-h.left,v=(e.touches[1].clientY||e.touches[1].pageY-i.lowerCanvas.offsetTop)-h.top,b={x:u<g?g-(g-u)/2:u-(u-g)/2,y:c<v?v-(v-c)/2:c-(c-v)/2};if(this.currMousePoint.x!==b.x&&this.currMousePoint.y!==b.y){var m="";if(e.type==="touchmove"&&(i.zoomSettings.zoomTrigger&U.Pinch)===U.Pinch){this.zoomType="Pinch";var y=this.calculateScale(this.startTouches,this.targetTouches(e.touches));this.startTouches=this.targetTouches(e.touches),y>1?m="zoomIn":y<1&&(m="zoomOut")}m!==""&&(i.isZoomBtnClick=!0,i.notify("draw",{prop:"performPointZoom",onPropertyChange:!1,value:{x:b.x,y:b.y,type:m,isResize:null}})),this.tempTouches=[],this.tempTouches.push({x:e.touches[0].clientX||e.touches[0].pageX-i.lowerCanvas.offsetLeft,y:e.touches[0].clientY||e.touches[0].pageY-i.lowerCanvas.offsetTop}),this.tempTouches.push({x:e.touches[1].clientX||e.touches[1].pageX-i.lowerCanvas.offsetLeft,y:e.touches[1].clientY||e.touches[1].pageY-i.lowerCanvas.offsetTop}),this.currMousePoint.x=b.x,this.currMousePoint.y=b.y,this.isPinching=!0}}this.isFirstMove=!1;return}var P,S;e.type==="mousemove"?(P=e.clientX,S=e.clientY):(this.touchEndPoint.x=P=e.touches[0].clientX,this.touchEndPoint.y=S=e.touches[0].clientY),P-=h.left,S-=h.top,this.canvasMouseMoveHandler(e);var O=!1,j;i.activeObj.shape!==void 0&&(j=i.activeObj.shape.split("-")),j!==void 0&&j[0]==="crop"&&(O=!0),O&&i.notify("transform",{prop:"disableZoomOutBtn",value:{isZoomOut:!0}}),i.upperCanvas.style.cursor=r,i.cursor=t,(i.currObjType.isActiveObj&&(i.activeObj.activePoint!==void 0||i.objColl.length>0)&&!this.dragCanvas||i.activeObj.activePoint!==void 0)&&this.dragElement===""&&(this.setCursor(P,S),i.activeObj.activePoint&&(i.activeObj.activePoint.width===0||!C(i.activeObj.currIndex)&&this.cursorTargetId!==i.activeObj.currIndex)&&i.cursor!=="default"&&i.cursor!=="move"&&i.cursor!=="crosshair"&&i.cursor!=="grab"&&i.cursor!=="pointer"&&(i.upperCanvas.style.cursor=i.cursor="move"),this.findTarget(P,S,e.type));var x=i.img,k=x.destLeft,T=x.destTop,A=x.destWidth,L=x.destHeight;if(i.currObjType.isDragging){if(i.activeObj.shape&&i.activeObj.preventShapeDragOut&&(P<k||P>k+A||S<T||S>T+L))return;this.upperContext.clearRect(0,0,i.lowerCanvas.width,i.lowerCanvas.height),this.updateActivePoint(P,S,O),i.notify("shape",{prop:"updateTrianglePoints",onPropertyChange:!1,value:{obj:i.activeObj}}),this.isPreventDragging?(this.isShapeDragOut()||(this.isPreventDragging=!1),i.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:null,isCropRatio:null,points:null,isPreventDrag:!0,saveContext:null,isPreventSelection:null}})):i.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:null,isCropRatio:null,points:null,isPreventDrag:null,saveContext:null,isPreventSelection:null}}),O&&(this.dragCanvas=i.togglePan=!0)}this.isMouseDown=!1,this.isMouseUp=!1}},d.prototype.mouseUpEventHandler=function(e){var i=this.parent,t=i.element.id;if(i.isKBDNavigation=this.isMouseDown=!1,this.isMouseUp=!0,!(!w.isDevice&&(i.element.querySelector("#"+t+"_contextualToolbar")&&!i.element.querySelector("#"+t+"_contextualToolbar").parentElement.classList.contains("e-hide")||i.element.querySelector("#"+t+"_headWrapper")&&!i.element.querySelector("#"+t+"_headWrapper").parentElement.classList.contains("e-hide"))&&!(i.activeObj.shape&&i.activeObj.shape==="redact"&&i.isShapeDrawing))){if(i.cursor==="grabbing"&&this.isGrabbing){var r={shapeSettingsObj:{}};i.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:r}});var o=r.shapeSettingsObj,a={cancel:!1,action:"rotate-end",previousShapeSettings:o,allowShapeOverflow:this.allowOutofBound()},n={cancel:!1,action:"rotate-end",previousShapeSettings:o,allowShapeOverflow:this.allowOutofBound()};this.triggerShapeChange(a,n,"mouse-up")}if(this.isGrabbing=!1,this.isPreventShaping&&(this.isPreventShaping=!1),this.mouseDown==="canvas"||this.isSliderActive||e.target.closest(".e-image-editor")||e.target.closest(".e-ie-ddb-popup")){e.type==="touchstart"?this.isTouch=!1:e.type==="touchend"&&e.stopImmediatePropagation(),e.preventDefault(),i.togglePan&&this.canvasMouseUpHandler(e);var s=void 0,l=void 0;e.type==="mouseup"?(s=e.clientX,l=e.clientY):this.isTouchDblClick||(s=this.touchEndPoint.x,l=this.touchEndPoint.y);var p=i.lowerCanvas.getBoundingClientRect();s-=p.left,l-=p.top;var h=void 0,u=this.currentDrawingShape,c=!1;if(e.type==="touchend"&&(this.startTouches=this.tempTouches=[],this.isFirstMove=!1,i.textArea.style.display==="none"&&(this.timer=0),this.isPinching)){this.isPinching=!1,i.notify("draw",{prop:"redrawDownScale"}),(i.isCropTab||i.activeObj.shape)&&(i.notify("draw",{prop:"setStraightenActObj",value:{activeObj:null}}),i.notify("freehand-draw",{prop:"resetStraightenPoint"})),i.isStraightening&&(i.notify("draw",{prop:"resetStraightenDestPoints"}),i.notify("draw",{prop:"setDestForStraighten"}));return}var g=!1,v=void 0;if(i.activeObj.shape!==void 0&&(v=i.activeObj.shape.split("-")),v!==void 0&&v[0]==="crop"&&(g=!0),this.currentDrawingShape==="path"&&i.isShapeDrawing){var b=e.srcElement,m=b.parentElement.id,y=i.element.id;e.currentTarget!==i.upperCanvas&&e.currentTarget!==i.lowerCanvas&&i.activeObj.pointColl.length>0&&(b.classList.contains("e-upload-icon")||m===y+"_zoomIn"||m===y+"_zoomOut"||m===y+"_annotationBtn"||m===y+"_borderColorBtn"||m===y+"_borderWidthBtn")&&(i.notify("shape",{prop:"stopPathDrawing",onPropertyChange:!1,value:{e,isApply:!0}}),this.upperContext.clearRect(0,0,i.upperCanvas.width,i.upperCanvas.height),i.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:i.activeObj,isCropRatio:null,points:null,isPreventDrag:!0,saveContext:null,isPreventSelection:!0}})),i.currObjType.isDragging&&this.isTouch&&i.activeObj.shape&&i.activeObj.shape==="path"&&(this.upperContext.clearRect(0,0,i.upperCanvas.width,i.upperCanvas.height),i.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:i.activeObj,isCropRatio:null,points:null,isPreventDrag:!0,saveContext:null,isPreventSelection:!0}}));return}if(e.currentTarget===i.upperCanvas&&!i.isResize){if(this.pathAdjustedIndex=null,this.currentDrawingShape!==""){if(this.currentDrawingShape==="text"){var P=f({},i.cropObj,{},!0);i.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeInsert",previousObj:this.initialPrevObj,previousObjColl:this.initialPrevObj.objColl,previousPointColl:this.initialPrevObj.pointColl,previousSelPointColl:this.initialPrevObj.selPointColl,previousCropObj:P,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}})}else i.notify("undo-redo",{prop:"updateUrObj",onPropertyChange:!1,value:{objColl:this.initialPrevObj.objColl,operation:"shapeInsert"}});this.isShapeInserted=!0,this.currentDrawingShape="",(i.activeObj.shape&&i.activeObj.shape==="path"&&i.activeObj.pointColl.length===0||(!i.activeObj.shape||i.activeObj.shape!=="path")&&i.activeObj.activePoint.width===0&&i.activeObj.activePoint.height===0)&&(c=!0,i.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,i.upperCanvas.width,i.upperCanvas.height));var S=this.updatePrevShapeSettings(),a={cancel:!1,action:"draw-end",previousShapeSettings:S},n={cancel:!1,action:"move",previousShapeSettings:S};this.shapeResizingArgs=a,this.shapeMovingArgs=n,this.triggerShapeChange(a,n,"mouse-up")}i.activeObj.shape&&i.activeObj.shape==="path"&&i.activeObj.pointColl.length>0&&(i.activeObj.activePoint=i.getSquarePointForPath(i.activeObj)),this.adjustActObjForLineArrow(),this.updPtCollForShpRot(),i.currObjType.shape=i.currObjType.shape.toLowerCase();var O=f({},i.cropObj,{},!0),j={currObj:{}};i.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:j}});var x=j.currObj;x.objColl=f([],i.objColl,[],!0),x.pointColl=f([],i.pointColl,[],!0),x.afterCropActions=f([],i.afterCropActions,[],!0);var k={selPointColl:null};if(i.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:k}}),x.selPointColl=f([],k.selPointColl,[],!0),!i.togglePen&&!g){if(this.tempObjColl&&i.activeObj.activePoint.width!==0){i.notify("shape",{prop:"updImgRatioForActObj",onPropertyChange:!1}),i.objColl.push(i.activeObj),JSON.stringify(i.activeObj.activePoint)!==JSON.stringify(this.tempActiveObj.activePoint)&&i.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:x,previousObjColl:this.tempObjColl,previousPointColl:x.pointColl,previousSelPointColl:x.selPointColl,previousCropObj:O,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}});var T=f({},i.objColl[i.objColl.length-1],{},!0);i.objColl.pop(),this.redrawShape(T),this.tempObjColl=void 0}this.isFhdEditing||(this.applyCurrActObj(s,l),i.currObjType.isResize=!1,i.notify("toolbar",{prop:"destroy-qa-toolbar",onPropertyChange:!1}))}else if(g&&this.isMouseUp&&i.cursor.indexOf("resize")>-1){var S=this.updatePrevShapeSettings(),a={cancel:!1,action:"resize-end",previousShapeSettings:S};this.triggerShapeChange(a,a,"resize")}if(i.activeObj){var A=!1,L;i.activeObj.shape!==void 0&&(L=i.activeObj.shape.split("-")),(L===void 0&&(i.currObjType.isCustomCrop||i.togglePen)||L!==void 0&&L[0]==="crop")&&(A=!0);var H=i.activeObj.shape;h=H;var B=["rectangle","ellipse","line","arrow","path"];if(B.indexOf(H)>-1)i.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"shapes",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}});else if(H==="text")i.textArea.style.display==="none"&&i.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"text",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}});else if(H==="redact")i.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"redact",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}});else if(this.isFhdEditing)i.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"pen",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}});else if(!A){var D={type:"main",isApplyBtn:null,isCropping:!1,isZooming:null};i.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:D})}if(i.notify("toolbar",{prop:"update-toolbar-items",onPropertyChange:!1}),!this.isFhdEditing){var E=Math.floor(i.activeObj.activePoint.width);if(i.activeObj.shape&&i.activeObj.shape==="text"&&i.activeObj.textSettings.fontSize===11&&Math.floor(i.activeObj.activePoint.height)===11&&(E===55||i.activeObj.textSettings.bold&&E===58)&&(i.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),i.drawingShape==="text"&&!i.activeObj.keyHistory&&(i.activeObj.keyHistory="Enter Text")),!A)if(this.adjustActObjForLineArrow(),i.isShapeDrawing){var R=this.currentDrawingShape;i.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1}),this.currentDrawingShape=R}else i.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1})}}}if(i.activeObj.shape!==void 0&&(v=i.activeObj.shape.split("-")),v!==void 0&&v[0]==="crop"&&(g=!0),i.activeObj.shape&&!g&&e.currentTarget===i.upperCanvas&&i.textArea.style.display==="none"){if(i.activeObj.shape==="text")i.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"text",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}});else if(i.activeObj.shape==="redact")i.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"redact",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}});else{var R=this.currentDrawingShape;this.currentDrawingShape="",i.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"shapes",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}),this.currentDrawingShape=R}i.notify("toolbar",{prop:"update-toolbar-items",onPropertyChange:!1}),i.notify("toolbar",{prop:"renderQAT",onPropertyChange:!1,value:{isPenEdit:null}})}var r={freehandDrawSelectedId:null};i.notify("freehand-draw",{prop:"getFreehandDrawSelectedId",onPropertyChange:!1,value:{obj:r}}),i.togglePen&&e.currentTarget===i.upperCanvas&&!r.freehandDrawSelectedId?(i.notify("freehand-draw",{prop:"freehandUpHandler",onPropertyChange:!1,value:{e,canvas:i.upperCanvas,context:this.upperContext}}),i.togglePen&&!i.isMaskImage&&(C(i.toolbar)||i.toolbar&&i.toolbar.length>0||!C(i.toolbarTemplate))&&(i.okBtn(),i.freeHandDraw(!0))):i.currObjType.shape="",this.dragElement="",this.mouseDown="",this.isSliderActive=!1,i.currObjType.isInitialLine=i.currObjType.isDragging=!1,this.selMouseUpEvent(),C(i.drawingShape)&&h&&u!==""&&(i.drawingShape=h),i.drawingShape&&(this.currentDrawingShape=i.drawingShape.toLowerCase(),c&&(i.enableShapeDrawing(i.toPascalCase(i.drawingShape),!0),i.upperCanvas.style.cursor="crosshair")),i.isShapeDrawing=!1,i.notify("freehand-draw",{prop:"resetSelPoints",onPropertyChange:!1})}this.isMouseUp=!1}},d.prototype.adjustActObjForLineArrow=function(e){var i=!1,t=this.parent;if(e=e||t.activeObj,e.shape&&(e.shape==="line"||t.activeObj.shape==="arrow")){var r=void 0;if((this.dragElement==="e-resize"&&e.activePoint.endX<e.activePoint.startX||this.dragElement==="w-resize"&&e.activePoint.startX>e.activePoint.endX)&&(i=!0,r=e.activePoint.startX,e.activePoint.startX=e.activePoint.endX,e.activePoint.endX=r,r=e.activePoint.startY,e.activePoint.startY=e.activePoint.endY,e.activePoint.endY=r),e.activePoint.width=Math.abs(e.activePoint.endX-e.activePoint.startX),e.activePoint.height=Math.abs(e.activePoint.endY-e.activePoint.startY),t.activeObj.shape!=="path"){t.notify("shape",{prop:"setPointCollForLineArrow",onPropertyChange:!1,value:{obj:e}});for(var o=0;o<e.pointColl.length;o++)e.pointColl[o].ratioX=(e.pointColl[o].x-t.img.destLeft)/t.img.destWidth,e.pointColl[o].ratioY=(e.pointColl[o].y-t.img.destTop)/t.img.destHeight}}return i},d.prototype.updPtCollForShpRot=function(e){var i=this.parent;if(e=e||i.activeObj,e.shape&&e.rotatedAngle!==0){i.notify("shape",{prop:"setPointCollForShapeRotation",onPropertyChange:!1,value:{obj:e}});var t=i.img,r=t.destLeft,o=t.destTop,a=t.destWidth,n=t.destHeight,s=e.horTopLinePointColl,l=e.horBottomLinePointColl,p=e.verLeftLinePointColl,h=e.verRightLinePointColl,u=function(c){c.ratioX=(c.x-r)/a,c.ratioY=(c.y-o)/n};s.forEach(u),l.forEach(u),p.forEach(u),h.forEach(u)}},d.prototype.setXYPoints=function(e){e.preventDefault();var i,t;e.type==="mousedown"?(i=e.clientX,t=e.clientY):(this.touchEndPoint.x=i=e.touches[0].clientX,this.touchEndPoint.y=t=e.touches[0].clientY);var r=this.parent.lowerCanvas.getBoundingClientRect();return i-=r.left,t-=r.top,{x:i,y:t}},d.prototype.getCurrentIndex=function(){for(var e,i=this.parent,t=0,r=i.objColl.length;t<r;t++)if(i.activeObj.currIndex===i.objColl[t].currIndex){e=t;break}return e},d.prototype.isShapeClick=function(e,i){var t=this.parent,r=!1;if(t.togglePen)return r;if(t.activeObj.shape&&t.activeObj.shape==="text"&&this.isShapeInserted){var o=t.textArea.style.display==="block"||t.textArea.style.display==="inline-block",a=f({},t.activeObj,null,!0);t.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:!0}});var n=this.setXYPoints(e),s=n.x,l=n.y;if(r=this.findTargetObj(s,l,i),i||(this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),r&&t.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:!0}})),o){t.textArea.value=t.objColl[t.objColl.length-1].keyHistory,t.textArea.style.display="block",t.activeObj=a;var p=this.getCurrentIndex();C(p)?t.objColl.pop():t.objColl.splice(p,1)}else if(!r&&a.shape){t.activeObj=a;var p=this.getCurrentIndex();!C(p)&&JSON.stringify(t.activeObj.activePoint)===JSON.stringify(t.objColl[p].activePoint)?t.objColl.splice(p,1):C(t.activeObj.currIndex)&&t.objColl.pop()}}return r},d.prototype.isShapeTouch=function(e,i){var t=this.parent,r=!1;if(e.type==="touchstart"&&!t.togglePen){t.activeObj&&t.activeObj.shape==="text"&&(this.timer=setTimeout(this.setTimer.bind(this),1e3,e));var o=t.textArea.style.display==="block"||t.textArea.style.display==="inline-block",a=f({},t.activeObj,null,!0);t.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:!0}});var n=this.setXYPoints(e),s=n.x,l=n.y;if(r=this.findTargetObj(s,l,i),i||this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),o){t.textArea.value=t.objColl[t.objColl.length-1].keyHistory,t.textArea.style.display="block",t.activeObj=a;var p=this.getCurrentIndex();C(p)?t.objColl.pop():t.objColl.splice(p,1)}else if(!r&&a.shape&&(a.activePoint.width!==0||a.activePoint.height!==0||a.shape==="path"&&a.pointColl.length>0)){t.activeObj=a;var p=this.getCurrentIndex();i||(!C(p)&&JSON.stringify(t.activeObj.activePoint)===JSON.stringify(t.objColl[p].activePoint)?t.objColl.splice(p,1):C(t.activeObj.currIndex)&&t.objColl.pop())}}return r},d.prototype.isFreehandDrawTouch=function(e,i){var t=this.parent,r=!1;if(e.type==="touchstart"&&!i&&!t.togglePen){var o=t.textArea.style.display==="block"||t.textArea.style.display==="inline-block",a=f({},t.activeObj,null,!0);t.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:!0}});var n=this.setXYPoints(e),s=n.x,l=n.y;if(this.setCursor(s,l),this.isFhdPoint&&(r=!0),o){t.textArea.value=t.objColl[t.objColl.length-1].keyHistory,t.textArea.style.display="block",t.activeObj=a;var p=this.getCurrentIndex();C(p)?t.objColl.pop():t.objColl.splice(p,1)}else if(a.shape){t.activeObj=a;var p=this.getCurrentIndex();i||(!C(p)&&JSON.stringify(t.activeObj.activePoint)===JSON.stringify(t.objColl[p].activePoint)?t.objColl.splice(p,1):C(t.activeObj.currIndex)&&t.objColl.pop())}}return r},d.prototype.applyObj=function(e,i){var t=this.parent,r=!1;if(t.activeObj.activePoint.width===0&&t.activeObj.activePoint.height===0)return!1;var o=["rectangle","ellipse","line","arrow","path","image","text"],a=t.activeObj.activePoint,n=a.startX,s=a.startY,l=a.endX,p=a.endY;if(t.activeObj.shape&&o.indexOf(t.activeObj.shape)>-1){var h=t.activeObj.topLeftCircle.radius;e>=n-h*2&&e<=l+h*2&&i>=s-h*2&&i<=p+h*2||t.upperCanvas.style.cursor!=="default"&&t.upperCanvas.style.cursor!=="grab"&&t.upperCanvas.style.cursor!=="crosshair"&&t.upperCanvas.style.cursor!=="pointer"&&t.upperCanvas.style.cursor!=="move"?r=!1:r=!0}return r},d.prototype.applyCurrShape=function(e){var i=this.parent,t=!1;if(i.togglePen)return t;var r=f({},i.activeObj,null,!0);if(this.isShapeInserted&&i.activeObj.shape==="text"&&e&&(this.isInitialTextEdited=!0,i.notify("draw",{prop:"setShapeTextInsert",onPropertyChange:!1,value:{bool:!0}})),i.textArea.style.display==="block"||i.textArea.style.display==="inline-block"){var o=f({},i.activeObj,null,!0);i.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:null}}),r=f({},i.objColl[i.objColl.length-1],null,!0),i.objColl.pop(),i.activeObj=f({},o,null,!0),i.textArea.value=r.keyHistory,i.textArea.style.display="block";var a=r.strokeSettings&&r.strokeSettings.strokeColor?r.strokeSettings.strokeColor.split("(")[0]==="rgb"?this.rgbToHex(parseFloat(r.strokeSettings.strokeColor.split("(")[1].split(",")[0]),parseFloat(r.strokeSettings.strokeColor.split("(")[1].split(",")[1]),parseFloat(r.strokeSettings.strokeColor.split("(")[1].split(",")[2]),parseFloat(r.strokeSettings.strokeColor.split("(")[1].split(",")[3])):r.strokeSettings.strokeColor:null;a&&a==="#ffffff"&&(a="#fff"),this.tempActiveObj.strokeSettings&&this.tempActiveObj.strokeSettings.strokeColor&&this.tempActiveObj.strokeSettings.strokeColor==="#ffffff"&&(this.tempActiveObj.strokeSettings.strokeColor="#fff"),(r.keyHistory!==this.tempActiveObj.keyHistory||a&&a!==this.tempActiveObj.strokeSettings.strokeColor||r.textSettings&&r.textSettings.fontFamily!==this.tempActiveObj.textSettings.fontFamily||r.textSettings&&Math.round(r.textSettings.fontSize)!==Math.round(this.tempActiveObj.textSettings.fontSize)||r.textSettings&&Math.round(r.textSettings.fontRatio)!==Math.round(this.tempActiveObj.textSettings.fontRatio)||r.textSettings&&r.textSettings.bold!==this.tempActiveObj.textSettings.bold||r.textSettings&&r.textSettings.italic!==this.tempActiveObj.textSettings.italic||r.textSettings&&r.textSettings.underline!==this.tempActiveObj.textSettings.underline)&&(t=!0),this.isInitialTextEdited&&!t&&(t=!0,this.isInitialTextEdited=!1)}else this.tempActiveObj.activePoint.height=Math.abs(this.tempActiveObj.activePoint.height),t=JSON.stringify(r)!==JSON.stringify(this.tempActiveObj);return t},d.prototype.canvasMouseDownHandler=function(e){var i=this.parent;e.preventDefault();var t,r;e.type==="mousedown"?(t=e.offsetX||e.pageX-i.lowerCanvas.offsetLeft,r=e.offsetY||e.pageY-i.lowerCanvas.offsetTop):(t=e.touches[0].clientX||e.touches[0].pageX-i.lowerCanvas.offsetLeft,r=e.touches[0].clientY||e.touches[0].pageY-i.lowerCanvas.offsetTop);var o=i.lowerCanvas.getBoundingClientRect();t-=o.left,r-=o.top,this.panDown={x:t,y:r};var a={tempPanMove:null};i.notify("transform",{prop:"getTempPanMove",onPropertyChange:!1,value:{obj:a}}),C(a.tempPanMove)&&i.notify("transform",{prop:"setTempPanMove",onPropertyChange:!1,value:{point:{x:t,y:r}}})},d.prototype.canvasMouseMoveHandler=function(e){var i=this.parent,t={bool:null};if(i.notify("toolbar",{prop:"getFrameToolbar",onPropertyChange:!1,value:{obj:t}}),i.isResize||t.bool){i.upperCanvas.style.cursor="default";return}this.dragCanvas?i.lowerCanvas.style.cursor="grab":(this.dragCanvas=i.togglePan=!1,i.lowerCanvas.style.cursor=i.upperCanvas.style.cursor=i.cursor="default");var r,o;e.type==="mousemove"?(r=e.offsetX,o=e.offsetY):(r=e.touches[0].clientX||e.touches[0].pageX-i.lowerCanvas.offsetLeft,o=e.touches[0].clientY||e.touches[0].pageY-i.lowerCanvas.offsetTop);var a=i.lowerCanvas.getBoundingClientRect();r-=a.left,o-=a.top;var n={x:r,y:o};i.notify("transform",{prop:"setPanMove",onPropertyChange:!1,value:{point:{x:r,y:o}}}),this.panDown&&n&&i.togglePan&&this.dragCanvas&&((i.isCropTab||i.activeObj.shape)&&(i.notify("draw",{prop:"setStraightenActObj",value:{activeObj:null}}),i.notify("freehand-draw",{prop:"resetStraightenPoint"})),i.notify("transform",{prop:"drawPannedImage",onPropertyChange:!1,value:{xDiff:null,yDiff:null}}))},d.prototype.canvasMouseUpHandler=function(e){var i=this.parent;e.preventDefault();var t={panMove:null};i.notify("transform",{prop:"getPanMove",onPropertyChange:!1,value:{obj:t}}),i.togglePan&&this.panDown&&t.panMove&&i.togglePan&&this.dragCanvas&&(this.panDown=null,i.notify("transform",{prop:"setPanMove",onPropertyChange:!1,value:{point:null}})),i.notify("transform",{prop:"setTempPanMove",onPropertyChange:!1,value:{point:null}}),this.currentDrawingShape!=="path"&&(i.currObjType.isDragging=!1)},d.prototype.touchStartHandler=function(e){e.preventDefault();var i=this.parent;if(this.touchTime===0)this.touchTime=new Date().getTime();else if(new Date().getTime()-this.touchTime<400){this.isTouchDblClick=!0;var t=i.isShapeDrawing;if(i.notify("shape",{prop:"stopPathDrawing",onPropertyChange:!1,value:{e,isApply:null}}),this.isTouchDblClick=!1,this.touchTime=0,t!==i.isShapeDrawing&&i.activeObj.shape&&i.activeObj.shape==="path")return}else this.touchTime=new Date().getTime();e.touches.length===2?this.isFirstMove=!0:this.mouseDownEventHandler(e),I.add(i.lowerCanvas,"touchend",this.mouseUpEventHandler,this),I.add(i.lowerCanvas,"touchmove",this.mouseMoveEventHandler,this),I.add(i.upperCanvas,"touchend",this.mouseUpEventHandler,this),I.add(i.upperCanvas,"touchmove",this.mouseMoveEventHandler,this)},d.prototype.unwireEvent=function(){var e=this.parent;I.remove(e.lowerCanvas,"touchend",this.mouseUpEventHandler),I.remove(e.lowerCanvas,"touchmove",this.mouseMoveEventHandler),I.remove(e.upperCanvas,"touchend",this.mouseUpEventHandler),I.remove(e.upperCanvas,"touchmove",this.mouseMoveEventHandler)},d.prototype.keyDownEventHandler=function(e){var i=this.parent;e.ctrlKey&&(e.key==="+"||e.key==="-")&&e.preventDefault();var t={fileName:"",fileType:null};i.notify("draw",{prop:"getFileName",onPropertyChange:!1,value:{obj:t}});var r={fileName:t.fileName,fileType:t.fileType,cancel:!1};switch(e.key){case(e.ctrlKey&&"s"):i.trigger("beforeSave",r),this.beforeSaveEvent(r,e);break;case(e.ctrlKey&&"z"):i.allowUndoRedo&&(i.noPushUndo=!1,(i.togglePen||i.drawingShape)&&(i.okBtn(),i.drawingShape=null),i.notify("undo-redo",{prop:"call-undo"}));break;case(e.ctrlKey&&"y"):i.allowUndoRedo&&(i.noPushUndo=!1,(i.togglePen||i.drawingShape)&&(i.okBtn(),i.drawingShape=null),i.notify("undo-redo",{prop:"call-redo"}));break;case(e.ctrlKey&&"+"):(i.zoomSettings.zoomTrigger&U.Commands)===U.Commands&&(this.zoomType="Commands",i.isZoomBtnClick=!0,i.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:.1,zoomPoint:null},isResize:null}),i.notify("draw",{prop:"redrawDownScale"}),(i.isCropTab||i.activeObj.shape)&&(i.notify("draw",{prop:"setStraightenActObj",value:{activeObj:null}}),i.notify("freehand-draw",{prop:"resetStraightenPoint"})),i.isStraightening&&(i.notify("draw",{prop:"resetStraightenDestPoints"}),i.notify("draw",{prop:"setDestForStraighten"})));break;case(e.ctrlKey&&"-"):(i.zoomSettings.zoomTrigger&U.Commands)===U.Commands&&(this.zoomType="Commands",i.isZoomBtnClick=!0,i.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-.1,zoomPoint:null},isResize:null}),i.notify("draw",{prop:"redrawDownScale"}),(i.isCropTab||i.activeObj.shape)&&(i.notify("draw",{prop:"setStraightenActObj",value:{activeObj:null}}),i.notify("freehand-draw",{prop:"resetStraightenPoint"})),i.isStraightening&&(i.notify("draw",{prop:"resetStraightenDestPoints"}),i.notify("draw",{prop:"setDestForStraighten"})));break;case"Delete":this.deleteItem();break;case"Escape":i.notify("draw",{prop:"performCancel",value:{isContextualToolbar:null,isFinalCancel:!0}});break;case"Enter":this.performEnterAction(e);break;case"Tab":this.performTabAction();break;default:w.isDevice&&(i.textArea.style.display==="block"||i.textArea.style.display==="inline-block")&&setTimeout(this.textKeyDown.bind(this),1,e);break}},d.prototype.performEnterAction=function(e){var i=this.parent;if(i.isResize){var t=e.target,r=!!(t.id.indexOf("aspectratio")||t.id.indexOf("non-aspectratio")>-1),o=this.isValueUpdated();if(!o){r&&this.focusRatioBtn();return}var a=this.getNumTextValue(),n=i.element.querySelector("#"+i.element.id+"_aspectratio"),s=i.element.querySelector(".e-ie-toolbar-aspect-ratio-btn");a&&a.x&&a.y&&(n||s&&!s.classList.contains("e-hidden")?i.notify("transform",{prop:"resize",value:{width:a.x,height:null,isAspectRatio:!0}}):i.notify("transform",{prop:"resize",value:{width:a.x,height:a.y,isAspectRatio:!1}}));var l=i.element.querySelector("#"+i.element.id+"_resizeHeight"),p=i.element.querySelector("#"+i.element.id+"_resizeWidth");if(C(n)){if(l){var h=F(l,"numerictextbox");l&&l.value===""&&(h.value=parseFloat(h.placeholder),l.value=h.placeholder+"px")}if(p){var h=F(p,"numerictextbox");p&&p.value===""&&(h.value=parseFloat(h.placeholder),p.value=h.placeholder+"px")}}i.notify("draw",{prop:"redrawDownScale"}),r&&this.focusRatioBtn()}else if(e.target.classList.contains("e-upload")){var u=i.element.querySelector(".e-image-upload");u&&u.querySelector(".e-tbar-btn")&&u.querySelector(".e-tbar-btn").click()}else if(e.target.classList.contains("filter-wrapper"))e.target.parentElement.click();else{var c=void 0;i.activeObj.shape&&(c=i.activeObj.shape.split("-")),e&&this.isKeyBoardCrop(e)&&i.activeObj.horTopLine&&i.activeObj.shape&&c[0]==="crop"&&i.crop()}},d.prototype.focusRatioBtn=function(){var e=this.parent.element.id;this.parent.isKBDNavigation&&setTimeout(function(){document.getElementById(e+"_aspectratio")?document.getElementById(e+"_aspectratio").focus():document.getElementById(e+"_nonaspectratio")&&document.getElementById(e+"_nonaspectratio").focus()},50)},d.prototype.isKeyBoardCrop=function(e){var i=!1,t=e.target;return(t.id===this.parent.element.id+"_ok"||t.id==="")&&(i=!0),i},d.prototype.beforeSaveEvent=function(e,i){var t=this.parent;e.cancel||t.notify("export",{prop:"export",onPropertyChange:!1,value:{type:e.fileType,fileName:e.fileName}}),i.preventDefault(),i.stopImmediatePropagation()},d.prototype.handleScroll=function(e){this.mouseWheel++;var i=this.parent,t,r,o=!1;e.type==="mousewheel"&&(t=e.clientX,r=e.clientY);var a=i.lowerCanvas.getBoundingClientRect();if(t-=a.left,r-=a.top,t>i.img.destLeft&&t<i.img.destLeft+i.img.destWidth&&r>i.img.destTop&&r<i.img.destTop+i.img.destHeight&&(o=!0),this.mouseWheel===2){this.mouseWheel=0,e.ctrlKey===!0&&o&&e.preventDefault();return}if(e.stopPropagation(),e.ctrlKey===!0&&o){e.preventDefault(),!i.isCropTab&&i.activeObj.shape&&i.activeObj.shape.split("-")[0]!=="crop"&&(i.okBtn(null,!0),i.notify("toolbar",{prop:"close-contextual-toolbar",onPropertyChange:!1}));var n="";e.type==="mousewheel"&&(i.zoomSettings.zoomTrigger&U.MouseWheel)===U.MouseWheel&&(this.zoomType="MouseWheel",e.wheelDelta>0?n="zoomIn":n="zoomOut"),n!==""&&(i.isZoomBtnClick=!0,i.notify("draw",{prop:"performPointZoom",onPropertyChange:!1,value:{x:t,y:r,type:n,isResize:null}}),i.notify("draw",{prop:"redrawDownScale"}),(i.isCropTab||i.activeObj.shape)&&(i.notify("draw",{prop:"setStraightenActObj",value:{activeObj:null}}),i.notify("freehand-draw",{prop:"resetStraightenPoint"})),i.isStraightening&&(i.notify("draw",{prop:"resetStraightenDestPoints"}),i.notify("draw",{prop:"setDestForStraighten"})))}},d.prototype.textKeyDown=function(e){var i=this.parent;if(i.activeObj.rotatedAngle===0){String.fromCharCode(e.which)==="\r"&&(this.textRow+=1),i.textArea.setAttribute("rows",this.textRow.toString()),i.textArea.style.height="auto",i.textArea.style.height=i.textArea.scrollHeight+"px",i.notify("shape",{prop:"setTextBoxWidth",onPropertyChange:!1,value:{e}}),w.isDevice&&(i.textArea.style.width=parseFloat(i.textArea.style.width)+i.textArea.style.fontSize+"px");var t=i.textArea.value.split(`
`);this.textRow=t.length,i.textArea.setAttribute("rows",this.textRow.toString()),this.isInitialTextEdited=!1}},d.prototype.clearSelection=function(e){var i=this.parent;!i.disabled&&i.isImageLoaded&&(e?i.notify("draw",{prop:"performCancel",value:{isContextualToolbar:null}}):(i.togglePen=!1,i.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.dragElement="",this.dragPoint.startX=this.dragPoint.startY=this.dragPoint.endX=this.dragPoint.endY=0,i.currObjType.shape="",this.upperContext.clearRect(0,0,i.upperCanvas.width,i.upperCanvas.height),i.currObjType.isActiveObj=!0,i.currObjType.isCustomCrop=!1,i.upperCanvas.style.cursor=i.cursor="default"))},d.prototype.setDragDirection=function(e,i){var t=7.5,r=this.parent,o=r.activeObj.activePoint;r.img.destWidth>r.img.destHeight?(o.startX=this.dragPoint.startX=e/2-i/2+t,o.startY=this.dragPoint.startY=i/2-i/2+t,o.endX=e/2+i/2-t,o.endY=i/2+i/2-t):(o.startY=this.dragPoint.startX=i/2-e/2+t,o.endY=i/2+e/2-t,o.startX=this.dragPoint.startX=t,o.endX=e-t)},d.prototype.calcShapeRatio=function(e,i,t,r){for(var o=this.parent,a=o.activeObj.activePoint,n=7.5,s=e/i,l=t,p=r,h=l>=p?l:p,u=h*s,c=h,g=this.getScale(u,l),v=[],b=o.img,m=b.destLeft,y=b.destTop,P=b.destWidth,S=b.destHeight,O=0;O<2;O++)O===0?v.push(u*g):v.push(c*g);u=v[0],c=v[1];for(var j=this.getScale(c,p),x=[],O=0;O<2;O++)O===0?x.push(u*j):x.push(c*j);u=x[0],c=x[1],a.width=u,a.height=c,a.startX=(this.dragPoint.startX=(l-u)/2)+n,a.startY=(this.dragPoint.startY=(p-c)/2)+n,a.endX=a.startX+a.width,a.endY=a.startY+a.height,a.startX<m&&m+P>o.lowerCanvas.clientWidth&&(a.startX=m,a.endX=a.startX+u-n),a.startY<y&&y+S>o.lowerCanvas.clientHeight&&(a.startY=y,a.endY=a.startY+c-n),a.width=a.endX-a.startX,a.height=a.endY-a.startY},d.prototype.getScale=function(e,i){return e>i?i/e:1},d.prototype.findTarget=function(e,i,t){var r=this.parent;if(t.toLowerCase()==="mousedown"||t.toLowerCase()==="touchstart"){var o=void 0,a=!1;r.activeObj.shape&&(o=r.activeObj.shape.split("-"),o[0]==="crop"&&(a=!0)),this.findTargetObj(e,i,a),this.updateCursorStyles(e,i,t)}else{var n=r.activeObj,s=n.topLeftCircle,l=n.topCenterCircle,p=n.topRightCircle,h=n.centerLeftCircle,u=n.centerRightCircle,c=n.bottomLeftCircle,g=n.bottomCenterCircle,v=n.bottomRightCircle;switch(this.dragElement.toLowerCase()){case"nw-resize":s.startX=e,s.startY=i;break;case"n-resize":l.startX=e,l.startY=i;break;case"ne-resize":p.startX=e,p.startY=i;break;case"w-resize":h.startX=e,h.startY=i;break;case"e-resize":u.startX=e,u.startY=i;break;case"sw-resize":c.startX=e,c.startY=i;break;case"s-resize":g.startX=e,g.startY=i;break;case"se-resize":v.startX=e,v.startY=i;break;default:this.dragPoint.startX&&this.dragPoint.startY&&(this.previousPoint.x=this.dragPoint.endX,this.previousPoint.y=this.dragPoint.endY,this.dragPoint.endX=e,this.dragPoint.endY=i);break}}},d.prototype.findTargetObj=function(e,i,t){var r=this.parent,o=!1;if(r.objColl.length!==0&&!r.currObjType.isCustomCrop&&!t){for(var a=0,n=void 0,s=0;s<r.objColl.length;s++){var l=r.upperCanvas.style.cursor;this.setCursor(e,i);var p=f({},r.objColl[s],{},!0),h=p.topLeftCircle.radius;if(p.shape==="line"||p.shape==="arrow"){for(var u=0;u<p.pointColl.length;u++)if(e>=p.pointColl[u].x-h*2&&e<=p.pointColl[u].x+h*2&&i>=p.pointColl[u].y-h*2&&i<=p.pointColl[u].y+h*2){if(this.tempActiveObj&&this.tempActiveObj.activePoint&&JSON.stringify(this.tempActiveObj.activePoint)===JSON.stringify(p.activePoint)){n=s;break}else this.isTouch||r.cursor==="move"||r.cursor==="grab"||this.isShapeInserted?(a===0||a<p.order)&&(a=p.order,n=s):r.objColl[s].currIndex===this.tempActiveObj.currIndex&&(n=s);break}}else if(p.shape==="path"){var c=this.setCursorForPath(p,e,i,r.upperCanvas);if(c!=="default"&&c!=="grab")if(this.tempActiveObj&&this.tempActiveObj.activePoint&&JSON.stringify(this.tempActiveObj.activePoint)===JSON.stringify(p.activePoint)){n=s;break}else this.isTouch||r.cursor==="move"||r.cursor==="grab"||this.isShapeInserted?(a===0||a<p.order)&&(a=p.order,n=s):r.objColl[s].currIndex===this.tempActiveObj.currIndex&&(n=s)}else if(p.rotatedAngle!==0){var g=this.setCursorForRotatedObject(p,e,i,r.upperCanvas);if(g!=="default"&&g!=="grab")if(this.tempActiveObj&&this.tempActiveObj.activePoint&&JSON.stringify(this.tempActiveObj.activePoint)===JSON.stringify(p.activePoint)){n=s;break}else this.isTouch||r.cursor==="move"||r.cursor==="grab"||this.isShapeInserted?(a===0||a<p.order&&(p.shape!=="redact"||r.drawingShape==="redact"))&&(a=p.order,n=s):r.objColl[s].currIndex===this.tempActiveObj.currIndex&&(n=s)}else{var v=this.getTransRotationPoint(p);if(e>=p.activePoint.startX-h*2&&e<=p.activePoint.endX+h*2&&i>=p.activePoint.startY-h*2&&i<=p.activePoint.endY+h*2||v&&e>=v.x-h*2&&e<=v.x+h*2&&i>=v.y-h*2&&i<=v.y+h*2)if(this.tempActiveObj&&this.tempActiveObj.activePoint&&JSON.stringify(this.tempActiveObj.activePoint)===JSON.stringify(p.activePoint)){n=s;break}else this.isTouch||l==="move"||l==="grabbing"||this.isShapeInserted||r.cursor==="move"||r.cursor==="grabbing"?(a===0||a<p.order&&(p.shape!=="redact"||r.drawingShape==="redact"))&&(a=p.order,n=s):r.objColl[s].currIndex===this.tempActiveObj.currIndex&&(n=s)}}if(C(n))r.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),o=!1;else{this.tempObjColl=f([],r.objColl,[],!0),r.currObjType.isCustomCrop=!1,r.activeObj=f({},r.objColl[n],{},!0);var b=f({},r.objColl[n],{},!0);if(r.objColl.splice(n,1),r.transform.degree===0){var m=this.lowerContext.filter;this.lowerContext.clearRect(0,0,r.lowerCanvas.width,r.lowerCanvas.height),r.notify("draw",{prop:"drawImage",onPropertyChange:!1}),this.lowerContext.filter="none",r.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"iterate",pen:"iterate",isPreventApply:null}}),r.activeObj=f({},m,{},!0),this.lowerContext.filter=m,this.getCurrentFlipState()}else{var y=f({},r.panPoint.totalPannedInternalPoint,{},!0),P={startX:r.img.destLeft,startY:r.img.destTop,width:r.img.destWidth,height:r.img.destHeight};r.notify("draw",{prop:"callUpdateCurrTransState",onPropertyChange:!1}),r.panPoint.totalPannedInternalPoint=y,r.img.destLeft=P.startX,r.img.destTop=P.startY,r.img.destWidth=P.width,r.img.destHeight=P.height,r.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"iterate",pen:"iterate",isPreventApply:null}})}r.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),(r.currSelectionPoint&&r.currSelectionPoint.shape==="crop-circle"||r.isCircleCrop)&&r.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),r.activeObj=f({},b,{},!0),this.setActivePoint(),r.activeObj=f({},b,{},!0);var S=f({},r.activeObj.strokeSettings,{},!0);r.notify("draw",{prop:"setTempStrokeSettings",onPropertyChange:!1,value:{tempStrokeSettings:S}});var O=f({},r.activeObj.textSettings,{},!0);r.notify("draw",{prop:"setTempTextSettings",onPropertyChange:!1,value:{tempTextSettings:O}});var j=this.updatePrevShapeSettings(),x={cancel:!1,action:"select",previousShapeSettings:j,currentShapeSettings:j,allowShapeOverflow:this.allowOutofBound()};(r.activeObj.shape==="line"||r.activeObj.shape==="arrow")&&(x.currentShapeSettings.width=r.activeObj.activePoint.endX-r.activeObj.activePoint.startX,x.currentShapeSettings.height=r.activeObj.activePoint.endY-r.activeObj.activePoint.startY),this.isCropSelection=!1;var k=void 0;if(r.activeObj.shape!==void 0&&(k=r.activeObj.shape.split("-")),k!==void 0&&k[0]==="crop"&&(this.isCropSelection=!0),!this.isCropSelection&&r.activeObj.shape!=="redact")r.trigger("shapeChanging",x),this.shapeEvent(x),r.editCompleteArgs=x;else{this.isMouseDown?x.action="resize-start":this.isMouseUp&&(x.action="resize-end");var T={action:x.action,previousSelectionSettings:{type:r.getSelectionType(r.activeObj.shape),startX:x.previousShapeSettings.startX,startY:x.previousShapeSettings.startY,width:x.previousShapeSettings.width,height:x.previousShapeSettings.height},currentSelectionSettings:{type:r.getSelectionType(r.activeObj.shape),startX:x.currentShapeSettings.startX,startY:x.currentShapeSettings.startY,width:x.currentShapeSettings.width,height:x.currentShapeSettings.height}};r.trigger("selectionChanging",T),r.editCompleteArgs=T,x.currentShapeSettings.startX=T.currentSelectionSettings.startX,x.currentShapeSettings.startY=T.currentSelectionSettings.startY,x.currentShapeSettings.width=T.currentSelectionSettings.width,x.currentShapeSettings.height=T.currentSelectionSettings.height,this.shapeEvent(x)}o=!0}}return o},d.prototype.shapeEvent=function(e){var i=this.parent;if(i.notify("shape",{prop:"updateShapeChangeEventArgs",onPropertyChange:!1,value:{shapeSettings:e.currentShapeSettings,allowShapeOverflow:e.allowShapeOverflow}}),i.activeObj.activePoint){var t={prevActObj:null};i.notify("draw",{prop:"getPrevActObj",onPropertyChange:!1,value:{obj:t}}),C(t.prevActObj)&&i.notify("draw",{prop:"setPrevActObj",onPropertyChange:!1,value:{prevActObj:f({},i.activeObj,{},!0)}}),i.activeObj.shape==="image"&&!this.isImageClarity&&(this.upgradeImageQuality(),this.isImageClarity=!0),i.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:i.activeObj,isCropRatio:null,points:null,isPreventDrag:!0,saveContext:null,isPreventSelection:!0}}),this.isShapeInserted||(this.isPreventDragging=this.isShapeDragOut())}},d.prototype.upgradeImageQuality=function(){var e=this.parent;if(e.activeObj.imageCanvas){var i=f({},e.activeObj,null,!0),t=e.activeObj.imageCanvas.getContext("2d"),r={width:0,height:0};e.notify("transform",{prop:"calcMaxDimension",onPropertyChange:!1,value:{width:e.activeObj.imageElement.width,height:e.activeObj.imageElement.height,obj:r,isImgShape:null}}),e.notify("shape",{prop:"updateObj",onPropertyChange:!1,value:{dimObj:r,x:null,y:null}}),t.clearRect(0,0,e.activeObj.imageCanvas.width,e.activeObj.imageCanvas.height),this.applyTransformToImg(t),e.activeObj=i}},d.prototype.applyTransformToImg=function(e){var i=this.parent;i.activeObj.isHorImageFlip&&i.activeObj.isVerImageFlip?(i.activeObj.isHorImageFlip=i.activeObj.isVerImageFlip=!1,i.notify("draw",{prop:"downScaleImgCanvas",onPropertyChange:!1,value:{ctx:e,isImgAnnotation:!0,isHFlip:!0,isVFlip:!0}})):i.activeObj.isHorImageFlip?(i.activeObj.isHorImageFlip=!1,i.notify("draw",{prop:"downScaleImgCanvas",onPropertyChange:!1,value:{ctx:e,isImgAnnotation:!0,isHFlip:!0,isVFlip:!1}})):i.activeObj.isVerImageFlip?(i.activeObj.isVerImageFlip=!1,i.notify("draw",{prop:"downScaleImgCanvas",onPropertyChange:!1,value:{ctx:e,isImgAnnotation:!0,isHFlip:!1,isVFlip:!0}})):i.notify("draw",{prop:"downScaleImgCanvas",onPropertyChange:!1,value:{ctx:e,isImgAnnotation:!0,isHFlip:!1,isVFlip:!1}})},d.prototype.targetTouches=function(e){var i=this.parent.lowerCanvas.getBoundingClientRect(),t={x:e[0].pageX-i.left,y:e[0].pageY-i.top},r={x:e[1].pageX-i.left,y:e[1].pageY-i.top},o=[t,r];return o},d.prototype.calculateScale=function(e,i){var t=this.getDistance(e[0],e[1]),r=this.getDistance(i[0],i[1]);return r/t},d.prototype.getDistance=function(e,i){var t=0,r=0;return e&&i&&(t=e.x-i.x,r=e.y-i.y),Math.sqrt(t*t+r*r)},d.prototype.redrawShape=function(e,i){for(var t=this.parent,r=0,o=t.objColl.length;r<o;r++)if(JSON.stringify(e)===JSON.stringify(t.objColl[r])){if(t.objColl.splice(r,1),e.shape&&t.textArea.style.display==="none"){var a=f({},e,{},!0);t.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.lowerContext.clearRect(0,0,t.lowerCanvas.width,t.lowerCanvas.height),t.notify("draw",{prop:"render-image",value:{isMouseWheel:null}}),t.rotateFlipColl.length>0&&(t.panPoint.totalPannedClientPoint.x!==0||t.panPoint.totalPannedClientPoint.y!==0)&&t.notify("draw",{prop:"redrawImgWithObj",onPropertyChange:!1}),e=t.activeObj=a}break}e.shape==="path"&&e.pointColl.length===0||e.shape!=="path"&&e.activePoint.width===0&&e.activePoint.height===0||(this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),this.isPreventDragging?(t.activeObj.activePoint.startX>t.img.destLeft&&(this.isPreventDragging=!1),i&&t.activeObj.rotatedAngle!==0?t.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:null,isCropRatio:null,points:null,isPreventDrag:!0,saveContext:null,isPreventSelection:null}}):t.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:null,isCropRatio:null,points:null,isPreventDrag:!0,saveContext:null,isPreventSelection:null}})):i&&t.activeObj.rotatedAngle!==0?t.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:null,isCropRatio:null,points:null,isPreventDrag:!0,saveContext:null,isPreventSelection:null}}):(t.activeObj.shape==="redact"&&(this.lowerContext.clearRect(0,0,t.lowerCanvas.width,t.lowerCanvas.height),t.notify("draw",{prop:"redrawImgWithObj",onPropertyChange:!1}),t.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}})),t.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:null,isCropRatio:null,points:null,isPreventDrag:!0,saveContext:null,isPreventSelection:null}})))},d.prototype.setTimer=function(e){var i=this.parent;this.timer>10&&(clearTimeout(this.timer),this.timer=0,i.notify("shape",{prop:"findTextTarget",onPropertyChange:!1,value:{e}}),w.isDevice&&this.upperContext.clearRect(0,0,i.upperCanvas.width,i.upperCanvas.height))},d.prototype.applyCurrActObj=function(e,i){var t=this.parent,r=!1,o=f({},t.activeObj,{},!0);if(!C(o.activePoint)){var a=o.activePoint,n=a.startX,s=a.startY,l=a.endX,p=a.endY,h=o.topLeftCircle?o.topLeftCircle.radius:0;if(e>=Math.floor(n)&&e<=Math.ceil(l)&&i>=Math.floor(s)&&i<=Math.ceil(p))r=!0;else if(h!==0&&e>=Math.floor(n)-h&&e<=Math.ceil(l)+h&&i>=Math.floor(s)-h&&i<=Math.ceil(p)+h)r=!0,this.tempActiveObj={activePoint:{startX:0,startY:0,endX:0,endY:0,width:0,height:0},flipObjColl:[],triangle:[],triangleRatio:[]};else if((o.shape==="text"||o.shape==="image")&&this.dragElement!=="")r=!0;else if(o.shape==="line"||o.shape==="arrow"){var u={x:n<l?n:l,y:s<p?s:p},c={x:n>l?n:l,y:s>p?s:p};(e>=Math.floor(u.x)-5&&e<=Math.ceil(c.x)+5&&i>=Math.floor(u.y)-5&&i<=Math.ceil(c.y)+5||t.activeObj.preventShapeDragOut)&&(r=!0)}else if(o.shape==="path"){var g=this.setCursorForPath(o,e,i,t.upperCanvas);g==="move"&&(r=!0)}else if(this.dragElement==="grabbing")r=!0;else if(o.rotatedAngle!==0){var g=this.setCursorForRotatedObject(o,e,i,t.upperCanvas);(g!=="default"&&g!=="grab"||this.dragElement==="n-resize"||this.dragElement==="e-resize"||this.dragElement==="s-resize"||this.dragElement==="w-resize")&&(r=!0)}else(t.textArea.style.display==="block"||t.textArea.style.display==="inline-block")&&(r=!0);if(!r){if(C(t.activeObj.currIndex)){var v={id:"shape_"+(t.objColl.length+1)};t.notify("shape",{prop:"getNewShapeId",onPropertyChange:!1,value:{obj:v}}),t.activeObj.currIndex=v.id}t.notify("shape",{prop:"updImgRatioForActObj",onPropertyChange:!1}),t.activeObj.horTopLine!==void 0&&t.activeObj.horTopLine.startX!==0&&t.activeObj.horTopLine.endX!==0&&!t.currObjType.isCustomCrop&&t.currObjType.shape!==""&&t.objColl.length>0&&JSON.stringify(t.objColl[t.objColl.length-1].activePoint)!==JSON.stringify(t.activeObj.activePoint)&&t.objColl.push(f({},t.activeObj,{},!0));var b=["rectangle","ellipse","line","arrow","path","text","image"];if(b.indexOf(t.activeObj.shape)>-1){var m=this.lowerContext.filter;this.lowerContext.filter="brightness(1) contrast(100%) hue-rotate(0deg) saturate(100%) opacity(1) blur(0px) sepia(0%) grayscale(0%) invert(0%)",t.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),this.lowerContext.filter=m,t.activeObj.shape&&t.notify("shape",{prop:"apply",onPropertyChange:!1,value:{shape:null,obj:null,canvas:null}}),t.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),t.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.upperContext}}),t.isCircleCrop&&t.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}})}t.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1})}}},d.prototype.getCurrentFlipState=function(){var e=this.parent;if(e.rotateFlipColl.length!==0){var i=f({},e.panPoint.totalPannedInternalPoint,{},!0);e.notify("draw",{prop:"callUpdateCurrTransState",onPropertyChange:!1}),e.panPoint.totalPannedInternalPoint=i}else e.notify("draw",{prop:"callUpdateCurrTransState",onPropertyChange:!1})},d.prototype.setTextBoxStylesToActObj=function(){var e=this.parent;e.activeObj.textSettings.fontFamily=e.textArea.style.fontFamily,e.activeObj.strokeSettings.strokeColor=e.textArea.style.color!==""&&e.textArea.style.color.split("(")[1]&&e.textArea.style.color.split("(")[1].split(",")[0]&&e.textArea.style.color.split("(")[1].split(",")[1]&&e.textArea.style.color.split("(")[1].split(",")[2]&&e.textArea.style.color.split("(")[1].split(",")[3]?this.rgbToHex(parseFloat(e.textArea.style.color.split("(")[1].split(",")[0]),parseFloat(e.textArea.style.color.split("(")[1].split(",")[1]),parseFloat(e.textArea.style.color.split("(")[1].split(",")[2]),parseFloat(e.textArea.style.color.split("(")[1].split(",")[3])):e.textArea.style.color,e.activeObj.strokeSettings.fillColor=e.textArea.style.backgroundColor!==""&&e.textArea.style.backgroundColor.split("(")[1]&&e.textArea.style.backgroundColor.split("(")[1].split(",")[0]&&e.textArea.style.backgroundColor.split("(")[1].split(",")[1]&&e.textArea.style.backgroundColor.split("(")[1].split(",")[2]&&e.textArea.style.backgroundColor.split("(")[1].split(",")[3]?this.rgbToHex(parseFloat(e.textArea.style.backgroundColor.split("(")[1].split(",")[0]),parseFloat(e.textArea.style.backgroundColor.split("(")[1].split(",")[1]),parseFloat(e.textArea.style.backgroundColor.split("(")[1].split(",")[2]),parseFloat(e.textArea.style.backgroundColor.split("(")[1].split(",")[3])):e.textArea.style.backgroundColor,e.activeObj.strokeSettings.outlineColor=e.textArea.style.textShadow!==""&&e.textArea.style.textShadow.split("(")[1]&&e.textArea.style.textShadow.split("(")[1].split(",")[0]&&e.textArea.style.textShadow.split("(")[1].split(",")[1]&&e.textArea.style.textShadow.split("(")[1].split(",")[2]&&e.textArea.style.textShadow.split("(")[1].split(",")[3]?this.rgbToHex(parseFloat(e.textArea.style.textShadow.split("(")[1].split(",")[0]),parseFloat(e.textArea.style.textShadow.split("(")[1].split(",")[1]),parseFloat(e.textArea.style.textShadow.split("(")[1].split(",")[2]),parseFloat(e.textArea.style.textShadow.split("(")[1].split(",")[3])):e.textArea.style.textShadow.match(/^(\s*[\w#]+)\s/)?e.textArea.style.textShadow.match(/^(\s*[\w#]+)\s/)[1].trim():e.textArea.style.textShadow,e.textArea.style.fontWeight==="bold"?e.activeObj.textSettings.bold=!0:e.activeObj.textSettings.bold=!1,e.textArea.style.fontStyle==="italic"?e.activeObj.textSettings.italic=!0:e.activeObj.textSettings.italic=!1,e.activeObj.textSettings.fontSize=parseFloat(e.textArea.style.fontSize)},d.prototype.rgbToHex=function(e,i,t,r){e=Math.max(0,Math.min(255,Math.round(e))),i=Math.max(0,Math.min(255,Math.round(i))),t=Math.max(0,Math.min(255,Math.round(t))),r=Math.max(0,Math.min(1,r));var o=this.padLeft(e.toString(16),2,"0"),a=this.padLeft(i.toString(16),2,"0"),n=this.padLeft(t.toString(16),2,"0"),s=this.padLeft(Math.round(r*255).toString(16),2,"0"),l;return isNaN(Number(s))?l="#"+o+a+n:l="#"+o+a+n+s,l},d.prototype.padLeft=function(e,i,t){for(;e.length<i;)e=t+e;return e},d.prototype.deleteItem=function(){var e=this.parent,i={cancel:!1},t={};if(this.isFhdEditing){this.updateFreehandDrawColorChange();var r=f({},e.cropObj,{},!0),o={currObj:{}};e.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:o}});var a=o.currObj;a.objColl=f([],e.objColl,[],!0),a.pointColl=f([],e.pointColl,[],!0),a.afterCropActions=f([],e.afterCropActions,[],!0);var n={selPointColl:null};e.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:n}}),a.selPointColl=f([],n.selPointColl,[],!0);var s={freehandDrawSelectedId:null};e.notify("freehand-draw",{prop:"getFreehandDrawSelectedId",onPropertyChange:!1,value:{obj:s}}),e.notify("freehand-draw",{prop:"deleteFhd",value:{id:s.freehandDrawSelectedId}}),e.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"deleteFreehandDrawing",previousObj:a,previousObjColl:this.tempObjColl,previousPointColl:a.pointColl,previousSelPointColl:a.selPointColl,previousCropObj:r,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),e.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}}),e.notify("freehand-draw",{prop:"resetFreehandDrawSelectedId"})}else if(e.textArea.style.display==="none"){var s={prevActObj:null};if(e.notify("draw",{prop:"getPrevActObj",onPropertyChange:!1,value:{obj:s}}),s.prevActObj&&(s.prevActObj.activePoint.width=Math.abs(s.prevActObj.activePoint.width),s.prevActObj.activePoint.height=Math.abs(s.prevActObj.activePoint.height)),s.prevActObj&&JSON.stringify(s.prevActObj)!==JSON.stringify(e.activeObj)){var l=e.activeObj.currIndex;e.notify("draw",{prop:"performCancel",value:{isContextualToolbar:null,isFinalCancel:!0}});for(var p=0,h=e.objColl.length;p<h;p++)if(e.objColl[p].currIndex===l){e.objColl.splice(p,1),e.notify("draw",{prop:"render-image",value:{isMouseWheel:null}});break}}var o={isNewPath:null};if(e.notify("draw",{prop:"getNewPath",value:{obj:o}}),o.isNewPath)e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),e.notify("draw",{prop:"render-image",value:{isMouseWheel:null}}),e.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1});else if(e.activeObj.shape){e.objColl.push(e.activeObj);var r=f({},e.cropObj,{},!0),u={currObj:{}};e.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:u}});var a=u.currObj;a.objColl=f([],e.objColl,[],!0),a.pointColl=f([],e.pointColl,[],!0),a.afterCropActions=f([],e.afterCropActions,[],!0);var n={selPointColl:null};e.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:n}}),a.selPointColl=f([],n.selPointColl,[],!0),e.objColl.pop(),t=this.updatePrevShapeSettings(),i={cancel:!1,action:"delete",previousShapeSettings:t,currentShapeSettings:null},e.notify("shape",{prop:"setKeyHistory",onPropertyChange:!1,value:{keyHistory:""}}),e.clearSelection(),e.trigger("shapeChanging",i),e.editCompleteArgs=i,e.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1}),e.notify("draw",{prop:"render-image",value:{isMouseWheel:null}}),C(a.objColl[a.objColl.length-1].currIndex)||(e.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"deleteObj",previousObj:a,previousObjColl:this.tempObjColl,previousPointColl:a.pointColl,previousSelPointColl:a.selPointColl,previousCropObj:r,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),e.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}}))}e.notify("draw",{prop:"setPrevActObj",onPropertyChange:!1,value:{prevActObj:null}}),e.drawingShape&&(this.currentDrawingShape=e.drawingShape.toLowerCase(),e.enableShapeDrawing(e.toPascalCase(e.drawingShape),!0),e.upperCanvas.style.cursor="crosshair")}document.getElementById(e.element.id+"_quickAccessToolbarArea")&&(document.getElementById(e.element.id+"_quickAccessToolbarArea").style.display="none")},d.prototype.updateFreehandDrawColorChange=function(){var e=this.parent,i={freehandSelectedIndex:null};if(e.notify("freehand-draw",{prop:"getFreehandSelectedIndex",onPropertyChange:!1,value:{obj:i}}),!C(i.freehandSelectedIndex)&&!C(e.pointColl[i.freehandSelectedIndex])&&e.pointColl[i.freehandSelectedIndex].strokeColor==="#42a5f5"){var t={tempFreeHandDrawEditingStyles:null};e.notify("freehand-draw",{prop:"getTempFreeHandDrawEditingStyles",value:{obj:t}}),e.pointColl[i.freehandSelectedIndex].strokeColor=t.tempFreeHandDrawEditingStyles.strokeColor}},d.prototype.updatePrevShapeSettings=function(e){var i=this.parent,t=[];if(C(i.activeObj.currIndex)){var r={id:"shape_"+(i.objColl.length+1)};i.notify("shape",{prop:"getNewShapeId",onPropertyChange:!1,value:{obj:r}}),i.activeObj.currIndex=r.id}i.activeObj.shape==="text"&&i.activeObj.textSettings&&(i.activeObj.textSettings.bold&&t.push("bold"),i.activeObj.textSettings.italic&&t.push("italic"),i.activeObj.textSettings.underline&&t.push("underline"));var o=i.activeObj.activePoint,a=o.startX,n=o.startY,s=o.endX,l=o.endY,p=o.width,h=o.height,u=i.activeObj,c=u.keyHistory,g=u.currIndex,v=u.shape,b=u.textSettings,m=u.strokeSettings,y=u.rotatedAngle,P=u.imageElement,S=u.opacity,O={id:C(g)?null:g,type:i.toPascalCase(v),startX:a,startY:n,width:p,height:h,strokeColor:m?v==="text"?m.outlineColor:m.strokeColor:null,strokeWidth:m?v==="text"?m.outlineWidth:m.strokeWidth:null,fillColor:m?m.fillColor:null,radius:v==="ellipse"?p/2:null,length:v==="line"||v==="arrow"?p:null,text:v==="text"?c||(b.text?b.text:null):null,fontSize:v==="text"&&b?b.fontSize:null,fontFamily:v==="text"&&b?b.fontFamily:null,fontStyle:v==="text"?t:null,color:v==="text"&&m?m.strokeColor:null,degree:v==="ellipse"||v==="rectangle"||v==="image"||v==="text"?y*(180/Math.PI):null,imageData:v==="image"?P.src:null,opacity:v==="image"?S:null,radiusX:v==="ellipse"?p/2:null,radiusY:v==="ellipse"?h/2:null,endX:v==="line"||v==="arrow"?s:null,endY:v==="line"||v==="arrow"?l:null,arrowHead:v==="arrow"?this.getArrowType(i.activeObj.start):null,arrowTail:v==="arrow"?this.getArrowType(i.activeObj.end):null,points:v==="path"?i.activeObj.pointColl:null,index:i.activeObj.order,transformCollection:v==="text"?this.updateTransColl(i.activeObj):null};return e&&(e.shapeSettingsObj=O),O},d.prototype.updateTransColl=function(e){var i=this.parent,t,r=e.rotateFlipColl;if(r&&r.length>0){var o=void 0;t=[];for(var a=0;a<r.length;a++)o=r[a],typeof o=="number"?t.push({degree:o}):t.push({flip:i.toPascalCase(o)})}return t},d.prototype.getArrowType=function(e){var i={none:"None",arrow:"Arrow",arrowSolid:"SolidArrow",circle:"Circle",circleSolid:"SolidCircle",square:"Square",squareSolid:"SolidSquare",bar:"Bar"};return i[""+e]},d.prototype.getRectanglePoints=function(e,i,t,r,o,a,n){var s=e+t/2,l=i+r/2,p=o*(Math.PI/180),h=Math.cos(p),u=Math.sin(p),c=a-s,g=n-l,v=c*h+g*u,b=-c*u+g*h,m=t/2,y=r/2;return v>=-m&&v<=m&&b>=-y&&b<=y},d.prototype.getTransRotationPoint=function(e,i){var t,r,o=!1,a=!1;if(r=e.shapeDegree===0?this.parent.transform.degree:this.parent.transform.degree-e.shapeDegree,r<0&&(r=360+r),e.flipObjColl)for(var n=0,s=e.flipObjColl.length;n<s;n++)e.flipObjColl[n].toLowerCase()==="horizontal"?o=!0:e.flipObjColl[n].toLowerCase()==="vertical"&&(a=!0);return r===0||r===360?a?t={x:e.topCenterCircle.startX,y:e.topCenterCircle.startY-e.rotationCircleLine}:t={x:e.bottomCenterCircle.startX,y:e.bottomCenterCircle.startY+e.rotationCircleLine}:r===90||r===-270?o?t={x:e.centerRightCircle.startX+e.rotationCircleLine,y:e.centerLeftCircle.startY}:t={x:e.centerLeftCircle.startX-e.rotationCircleLine,y:e.centerLeftCircle.startY}:r===180||r===-180?a?t={x:e.bottomCenterCircle.startX,y:e.bottomCenterCircle.startY+e.rotationCircleLine}:t={x:e.topCenterCircle.startX,y:e.topCenterCircle.startY-e.rotationCircleLine}:(r===270||r===-90)&&(o?t={x:e.centerLeftCircle.startX-e.rotationCircleLine,y:e.centerLeftCircle.startY}:t={x:e.centerRightCircle.startX+e.rotationCircleLine,y:e.centerLeftCircle.startY}),i&&(i.rotationCirclePoint=t),t},d.prototype.getNumTextValue=function(e){var i=this.parent,t=i.element,r,o,a,n;if(a=t.querySelector("#"+t.id+"_resizeWidth"),n=t.querySelector("#"+t.id+"_resizeHeight"),a&&n){var s=n.value.replace(/,/g,""),l=a.value.replace(/,/g,"");s===""&&(s=n.placeholder.replace(/,/g,"")),l===""&&(l=a.placeholder.replace(/,/g,"")),r=parseFloat(s),o=parseFloat(l)}return e&&(e.width=o,e.height=r),{x:o,y:r}},d.prototype.isValueUpdated=function(){var e=!0,i,t;return i=this.parent.element.querySelector("#"+this.parent.element.id+"_resizeWidth"),t=this.parent.element.querySelector("#"+this.parent.element.id+"_resizeHeight"),i&&t&&t.value.replace(/,/g,"")===""&&i.value.replace(/,/g,"")===""&&(e=!1),e},d.prototype.allowOutofBound=function(){var e=["ellipse","rectangle","text","image","redact"],i=!(e.indexOf(this.parent.activeObj.shape)!==-1&&this.parent.activeObj.rotatedAngle===0);return i},d}(),ui=function(){function d(e){this.textSettings={text:"Enter Text",fontFamily:"",fontSize:null,fontRatio:null,bold:!1,italic:!1,underline:!1},this.strokeSettings={strokeColor:"#fff",fillColor:"",strokeWidth:null,radius:null,outlineColor:"",outlineWidth:null},this.keyHistory="",this.preventFrameAnnotation=!1,this.redactType="blur",this.parent=e,this.addEventListener()}return d.prototype.destroy=function(){this.parent.isDestroyed||this.removeEventListener()},d.prototype.addEventListener=function(){this.parent.on("shape",this.shape,this),this.parent.on("destroyed",this.destroy,this)},d.prototype.removeEventListener=function(){this.parent.off("shape",this.shape),this.parent.off("destroyed",this.destroy)},d.prototype.shape=function(e){var i=this.parent;this.initShapePvtProps();var t;switch(e.prop){case"drawEllipse":this.drawEllipse(e.value.x,e.value.y,e.value.radiusX,e.value.radiusY,e.value.strokeWidth,e.value.strokeColor,e.value.fillColor,e.value.degree,e.value.isSelected);break;case"drawLine":this.drawLine(e.value.startX,e.value.startY,e.value.endX,e.value.endY,e.value.strokeWidth,e.value.strokeColor,e.value.isSelected);break;case"drawArrow":this.drawArrow(e.value.startX,e.value.startY,e.value.endX,e.value.endY,e.value.strokeWidth,e.value.strokeColor,e.value.arrowStart,e.value.arrowEnd,e.value.isSelected);break;case"drawPath":this.drawPath(e.value.pointColl,e.value.strokeWidth,e.value.strokeColor,e.value.isSelected);break;case"drawRectangle":this.drawRectangle(e.value.x,e.value.y,e.value.width,e.value.height,e.value.strokeWidth,e.value.strokeColor,e.value.fillColor,e.value.degree,e.value.isSelected,e.value.radius);break;case"drawText":this.drawText(e.value.x,e.value.y,e.value.text,e.value.fontFamily,e.value.fontSize,e.value.bold,e.value.italic,e.value.color,e.value.isSelected,e.value.degree,e.value.fillColor,e.value.outlineColor,e.value.outlineWidth,e.value.transformCollection);break;case"redrawActObj":this.redrawActObj(e.value.x,e.value.y,e.value.isMouseDown);break;case"apply":this.apply(e.value.shape,e.value.obj,e.value.canvas);break;case"updateShapeChangeEventArgs":this.updateShapeChangeEventArgs(e.value.shapeSettings,e.value.allowShapeOverflow);break;case"updSelChangeEventArgs":this.updSelChangeEventArgs(e.value.selectionSettings);break;case"iterateObjColl":this.iterateObjColl();break;case"updImgRatioForActObj":this.updImgRatioForActObj();break;case"redrawObj":this.redrawObj(e.value.degree);break;case"redraw-text":this.redrawText();break;case"draw-shape":this.drawShape(e.value.obj,e.value.strokeWidth,e.value.strokeColor,e.value.fillColor,e.value.start,e.value.width,e.value.height);break;case"renderTextArea":this.renderTextArea(e.value.x,e.value.y,e.value.actObj);break;case"setTextBoxWidth":this.setTextBoxWidth(e.value.e);break;case"findTextTarget":this.findTextTarget(e.value.e);break;case"updateFontStyles":this.updateFontStyles(e.value.isTextBox);break;case"applyFontStyle":this.applyFontStyle(e.value.item);break;case"updateFontRatio":this.updateFontRatio(e.value.obj,e.value.isTextArea);break;case"updateFontSize":this.updateFontSize(e.value.obj);break;case"pushActItemIntoObj":this.pushActItemIntoObj();break;case"clearActObj":this.clearActObj();break;case"refreshActiveObj":this.refreshActiveObj();break;case"applyActObj":this.applyActObj(e.value.isMouseDown);break;case"wireEvent":I.add(i.upperCanvas,"dblclick",this.findTextTarget,this),I.add(i.textArea,"mousedown",this.findTextTarget,this),t=document.getElementById(i.element.id+"_fileUpload"),t&&I.add(t,"change",this.fileChanged,this);break;case"unWireEvent":I.remove(i.upperCanvas,"dblclick",this.findTextTarget),I.remove(i.textArea,"mousedown",this.findTextTarget),t=document.getElementById(i.element.id+"_fileUpload"),t&&I.remove(t,"change",this.fileChanged);break;case"getShapeSetting":this.getShapeSetting(e.value.id,e.value.obj);break;case"getShapeSettings":this.getShapeSettings(e.value.obj);break;case"getRedactSettings":this.getRedactSettings(e.value.obj);break;case"isPointsInRange":this.isPointsInRange(e.value.x,e.value.y,e.value.obj);break;case"alignRotateFlipColl":this.alignRotateFlipColl(e.value.collection,e.value.isRotateFlipCollection,e.value.obj);break;case"selectShape":this.selectShape(e.value.id,e.value.obj);break;case"deleteShape":this.deleteShape(e.value.id);break;case"getMaxText":this.getMaxText(e.value.isTextBox,e.value.text,e.value.obj);break;case"setPointCollForLineArrow":e.value.obj.pointColl=this.getLinePoints(e.value.obj.activePoint.startX,e.value.obj.activePoint.startY,e.value.obj.activePoint.endX,e.value.obj.activePoint.endY);break;case"setPointCollForShapeRotation":this.setPointCollForShapeRotation(e.value.obj);break;case"setTextSettings":e.value.textSettings?this.textSettings=e.value.textSettings:e.value.fontFamily?this.textSettings.fontFamily=e.value.fontFamily:e.value.fontSize?this.textSettings.fontSize=e.value.fontSize:e.value.radius&&(this.strokeSettings.radius=e.value.radius);break;case"setStrokeSettings":e.value.strokeSettings?this.strokeSettings=e.value.strokeSettings:e.value.strokeColor?this.strokeSettings.strokeColor=e.value.strokeColor:e.value.fillColor?this.strokeSettings.fillColor=e.value.fillColor:e.value.strokeWidth?this.strokeSettings.strokeWidth=e.value.strokeWidth:e.value.outlineColor?this.strokeSettings.outlineColor=e.value.outlineColor:e.value.radius?this.strokeSettings.radius=e.value.radius:e.value.outlineWidth&&(this.strokeSettings.outlineWidth=e.value.outlineWidth);break;case"getStrokeSettings":e.value.obj.strokeSettings=this.strokeSettings;break;case"setKeyHistory":this.keyHistory=e.value.keyHistory;break;case"getKeyHistory":e.value.obj.keyHistory=this.keyHistory;break;case"setTextBoxPos":this.setTextBoxPos(e.value.actObj,e.value.degree,e.value.flip,e.value.x,e.value.y);break;case"setTextBoxPoints":this.setTextBoxPoints(e.value.actObj,e.value.degree,e.value.flip,e.value.x,e.value.y);break;case"alignTextAreaIntoCanvas":this.alignTextAreaIntoCanvas();break;case"initializeTextShape":this.initializeTextShape(e.value.text,e.value.fontFamily,e.value.fontSize,e.value.bold,e.value.italic,e.value.strokeColor,e.value.fillColor,e.value.outlineColor,e.value.outlineWidth);break;case"stopPathDrawing":this.stopPathDrawing(e.value.e,e.value.isApply);break;case"updateArrowRatio":this.updateArrowRatio(e.value.obj);break;case"getSquarePointForRotatedShape":this.getSquarePointForRotatedShape(e.value.obj,e.value.object);break;case"drawImage":this.drawImage(e.value.x,e.value.y,e.value.width,e.value.height,e.value.src,e.value.degree,e.value.isAspectRatio,e.value.opacity,e.value.isSelected);break;case"reset":this.reset();break;case"updateObj":this.updateObj(e.value.dimObj,e.value.x,e.value.y);break;case"straightenShapes":this.straightenShapes();break;case"straightenShapePoints":this.straightenShapePoints(e.value.obj,e.value.isReverse);break;case"straightenPath":this.straightenPath(e.value.obj);break;case"straightenFHD":this.straightenFHD();break;case"getTextBoxPosition":this.getTextBoxPosition(e.value.obj,e.value.object);break;case"setFlipState":this.setFlipState(e.value.x,e.value.y,e.value.obj,e.value.object);break;case"getNewShapeId":e.value.obj.id=this.getNewShapeId();break;case"z-order":this.updateZOrder(e.value.obj,e.value.value);break;case"getSmallestIndex":e.value.obj.index=this.getSmallestIndex();break;case"isIndexInObjColl":e.value.obj.bool=this.isIndexInObjColl(e.value.index);break;case"drawAnnotations":this.drawAnnotations(e.value.ctx,e.value.shape,e.value.pen,e.value.isPreventApply,e.value.x,e.value.y,e.value.panRegion);break;case"updateShapeColl":this.updateShapeColl();break;case"getNewOrder":e.value.obj.order=this.getNewOrder();break;case"getHighestOrder":e.value.obj.order=this.getHighestOrder();break;case"getLowestOrder":e.value.obj.order=this.getLowestOrder();break;case"drawRedact":this.drawRedact(e.value.x,e.value.y,e.value.width,e.value.height,e.value.type,e.value.value);break;case"setRedactType":this.redactType=e.value.redactType;break}},d.prototype.getModuleName=function(){return"shape"},d.prototype.initShapePvtProps=function(){var e=this.parent;e.lowerCanvas&&(this.lowerContext=e.lowerCanvas.getContext("2d")),e.upperCanvas&&(this.upperContext=e.upperCanvas.getContext("2d")),C(this.shapeImg)&&(this.shapeImg=e.createElement("img",{id:e.element.id+"_shapeImg",attrs:{name:"Image",crossorigin:"anonymous"}})),this.textSettings.fontFamily===""&&(this.textSettings.fontFamily=e.fontFamily.default)},d.prototype.reset=function(){this.textSettings={text:"Enter Text",fontFamily:this.parent.fontFamily.default,fontSize:null,fontRatio:null,bold:!1,italic:!1,underline:!1},this.strokeSettings={strokeColor:"#fff",fillColor:"",strokeWidth:null,radius:null,outlineColor:"",outlineWidth:null},this.preventFrameAnnotation=!1},d.prototype.drawEllipse=function(e,i,t,r,o,a,n,s,l){this.initializeShape("ellipse");var p=e&&i?{x:e,y:i}:null;this.drawShape("ellipse",o,a,n,p,t,r,null,null,null,s,null,l)},d.prototype.drawLine=function(e,i,t,r,o,a,n){this.initializeShape("line");var s=e&&i?{x:e,y:i}:null,l=t-e,p=r-i;this.drawShape("line",o,a,null,s,l,p,null,null,null,null,null,n)},d.prototype.drawPath=function(e,i,t,r){this.initializeShape("path"),e&&this.drawShape("path",i,t,null,null,null,null,e,null,null,null,null,r)},d.prototype.drawArrow=function(e,i,t,r,o,a,n,s,l){this.initializeShape("arrow");var p=e&&i?{x:e,y:i}:null,h=t-e,u=r-i;this.drawShape("arrow",o,a,null,p,h,u,null,n,s,null,null,l)},d.prototype.drawRectangle=function(e,i,t,r,o,a,n,s,l,p){this.initializeShape("rectangle");var h=e&&i?{x:e,y:i}:null;this.drawShape("rectangle",o,a,n,h,t,r,null,null,null,s,null,l,p)},d.prototype.drawRedact=function(e,i,t,r,o,a){this.initializeShape("redact");var n=e&&i?{x:e,y:i}:null;this.drawShape("redact",null,null,null,n,t,r,null,null,null,null,null,null,null,o,a)},d.prototype.drawText=function(e,i,t,r,o,a,n,s,l,p,h,u,c,g){this.drawShapeText(t,r,o,a,n,s,e,i,l,p,h,u,c,g)},d.prototype.initializeShape=function(e){var i=this.parent;this.redrawActObj(),i.activeObj.shape=e,i.currObjType.isCustomCrop=!1},d.prototype.updateWidthHeight=function(e){return e.activePoint.width=e.activePoint.endX-e.activePoint.startX,e.activePoint.height=e.activePoint.endY-e.activePoint.startY,e},d.prototype.setDimension=function(e,i){var t=this.parent,r=t.activeObj.shape;(e&&i||(r==="line"||r==="arrow")&&(e||i))&&(t.activeObj.activePoint.width=e,t.activeObj.activePoint.height=i,t.currObjType.shape.toLowerCase()==="ellipse"&&(t.activeObj.activePoint.width=2*e,t.activeObj.activePoint.height=2*i))},d.prototype.getArrowType=function(e){var i=e;if(e){var t={None:"none",Arrow:"arrow",SolidArrow:"arrowSolid",Circle:"circle",SolidCircle:"circleSolid",Square:"square",SolidSquare:"squareSolid",Bar:"bar"};i=t[""+e]}return i},d.prototype.drawShape=function(e,i,t,r,o,a,n,s,l,p,h,u,c,g,v,b){var m=this.parent;if(!m.disabled&&m.isImageLoaded){m.notify("draw",{prop:"setImageEdited",onPropertyChange:!1}),this.redrawActObj();var y=f([],m.objColl,[],!0);if(m.togglePen=!1,this.keyHistory="",m.upperCanvas.style.display="block",this.refreshActiveObj(),m.currObjType.shape=e=e.toLowerCase(),e!=="freehanddraw"&&e!==""){m.activeObj.shape=e;var P=m.activeObj.strokeSettings;this.upperContext.clearRect(0,0,m.upperCanvas.width,m.upperCanvas.height),C(P)&&(P=this.strokeSettings),e==="path"&&s&&(m.activeObj.pointColl=s),u!=null&&(m.activeObj.opacity=u),P.strokeWidth=i||P.strokeWidth;var S=m.activeObj.shape;(S==="rectangle"||S==="ellipse")&&i===0&&(P.strokeWidth=0),P.strokeColor=t||P.strokeColor,P.fillColor=r||r===""?r:P.fillColor,P.radius=g||P.radius;var O=m.img.destWidth>100?100:m.img.destWidth/2,j=m.img.destHeight>100?100:m.img.destHeight/2;m.activeObj.activePoint.width=O,m.activeObj.activePoint.height=j,e==="line"||e==="arrow"?(m.activeObj.lineDraw="horizontal",m.activeObj.activePoint.height=0,e==="arrow"&&(m.activeObj.activePoint.width+=50,m.activeObj.start=this.getArrowType(l),m.activeObj.end=this.getArrowType(p))):e==="rectangle"?m.activeObj.activePoint.width+=m.activeObj.activePoint.width/2:e==="redact"&&v&&(m.activeObj.redactType=v.toLowerCase(),v===Ve.Blur?b&&(m.activeObj.redactBlur=b):b&&(m.activeObj.redactPixelate=b),m.activeObj.redactImage=m.createElement("canvas")),this.setDimension(a,n),o?(m.activeObj.activePoint.startX=o.x,m.activeObj.activePoint.startY=o.y,m.activeObj.activePoint.endX=m.activeObj.activePoint.startX+m.activeObj.activePoint.width,m.activeObj.activePoint.endY=m.activeObj.activePoint.startY+m.activeObj.activePoint.height):this.setCenterPoints(),this.setPointCollForLineAndArrow(),e==="arrow"&&(m.activeObj.triangleDirection="right"),m.currObjType.isDragging=m.currObjType.isCustomCrop=!1,this.initShapeProps();var x={shapeSettingsObj:{}};m.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:x}});var k=x.shapeSettingsObj,T={cancel:!1,action:"insert",previousShapeSettings:k,currentShapeSettings:k};m.trigger("shapeChanging",T),m.editCompleteArgs=T,this.updateShapeChangeEventArgs(T.currentShapeSettings,T.allowShapeOverflow),this.setDimension(a,n),m.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}}),h&&(m.activeObj.rotatedAngle=h*(Math.PI/180),m.notify("selection",{prop:"updPtCollForShpRot",onPropertyChange:!1,value:{obj:m.activeObj}})),m.notify("toolbar",{prop:"renderQAT",onPropertyChange:!1,value:{isPenEdit:null}}),m.notify("selection",{prop:"isShapeInserted",onPropertyChange:!1,value:{bool:!0}}),m.notify("undo-redo",{prop:"updateUrObj",onPropertyChange:!1,value:{objColl:y}}),e==="redact"?m.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"redact",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}):m.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"shapes",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}),m.notify("toolbar",{prop:"update-toolbar-items",onPropertyChange:!1}),m.isPublicMethod&&!c&&m.notify("undo-redo",{prop:"updateUndoRedo",value:{operation:"shapeInsert"},onPropertyChange:!1}),m.isPublicMethod=!1}}},d.prototype.initShapeProps=function(){var e=this.parent;e.activeObj.shapeDegree=e.transform.degree,e.activeObj.shapeFlip=e.transform.currFlipState,e.activeObj.textFlip=e.transform.currFlipState,e.activeObj.flipObjColl=[],e.activeObj.order=this.getNewOrder()},d.prototype.setPointCollForLineAndArrow=function(){var e=this.parent,i=e.activeObj.shape,t=e.activeObj.activePoint,r=t.startX,o=t.startY,a=t.endX,n=t.endY;if((i==="line"||i==="arrow")&&(e.activeObj.pointColl=this.getLinePoints(r,o,a,n),e.activeObj.pointColl))for(var s=0,l=e.activeObj.pointColl.length;s<l;s++)e.activeObj.pointColl[s].ratioX=(e.activeObj.pointColl[s].x-e.img.destLeft)/e.img.destWidth,e.activeObj.pointColl[s].ratioY=(e.activeObj.pointColl[s].y-e.img.destTop)/e.img.destHeight},d.prototype.prevObjColl=function(){var e=this.parent,i={currObj:{}};e.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:i}}),this.prevObj=i.currObj,this.prevObj.objColl=f([],e.objColl,[],!0),this.prevObj.pointColl=f([],e.pointColl,[],!0),this.prevObj.afterCropActions=f([],e.afterCropActions,[],!0);var t={selPointColl:null};e.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:t}}),this.prevObj.selPointColl=f([],t.selPointColl,[],!0)},d.prototype.drawShapeText=function(e,i,t,r,o,a,n,s,l,p,h,u,c,g){var v=this.parent;if(!v.disabled&&v.isImageLoaded){v.currObjType.shape==="freehanddraw"&&(this.apply(),v.upperCanvas.style.cursor=v.cursor="default",v.currObjType.shape=""),v.notify("draw",{prop:"setImageEdited",onPropertyChange:!1}),v.togglePen=!1,this.redrawActObj(),this.prevObjColl(),this.refreshActiveObj(),v.activeObj.shape=v.currObjType.shape="text",v.currObjType.isCustomCrop=!1,this.initializeTextShape(e,i,t,r,o,a,h,u,c),v.currObjType.isText=v.currObjType.isInitialText=!0,C(v.activeObj.textSettings.fontSize)&&(v.getFontSizes(),v.activeObj.textSettings.fontSize=parseInt(v.fontSizeColl[parseInt("3",10)-1].text,10)),v.img.destWidth<100?v.activeObj.textSettings.fontSize=Math.floor(v.img.destWidth/20):v.img.destHeight<100&&(v.activeObj.textSettings.fontSize=Math.floor(v.img.destHeight/20)),v.activeObj.shapeDegree=v.transform.degree,v.activeObj.shapeFlip=v.transform.currFlipState,v.activeObj.flipObjColl=[],this.updateFontStyles(),v.activeObj.order=this.getNewOrder();var b=this.upperContext.measureText(v.activeObj.textSettings.text).width+v.activeObj.textSettings.fontSize*.5,m=v.activeObj.textSettings.fontSize;if(e){v.activeObj.keyHistory=e;var y=this.getMaxText();y=y||v.activeObj.textSettings.text,b=this.upperContext.measureText(y).width+v.activeObj.textSettings.fontSize*.5;var P=e.split(`
`);P.length>1&&(m=P.length*v.activeObj.textSettings.fontSize,m+=t*.25)}if(!C(n)&&!C(s)?(v.activeObj.activePoint.startX=n,v.activeObj.activePoint.startY=s,v.activeObj.activePoint.endX=v.activeObj.activePoint.startX+b,v.activeObj.activePoint.endY=v.activeObj.activePoint.startY+m):this.setCenterPoints(!0,b,m),g){v.notify("selection",{prop:"setTransformedShape",onPropertyChange:!1,value:{bool:!0}}),this.setTransformColl(g);var S=v.activeObj;S.shapeDegree=0,S.shapeFlip="";for(var O=0,j=S.rotateFlipColl,x=0;x<j.length;x++)typeof j[x]=="number"&&(O+=j[x]);O%90===0&&Math.abs(O)%180===90&&(S.activePoint.endX=S.activePoint.startX+m,S.activePoint.endY=S.activePoint.startY+b,S.activePoint.width=S.activePoint.endX-S.activePoint.startX,S.activePoint.height=S.activePoint.endY-S.activePoint.startY)}var k={shapeSettingsObj:{}};v.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:k}});var T=k.shapeSettingsObj,A={cancel:!1,action:"insert",previousShapeSettings:T,currentShapeSettings:T};if(v.trigger("shapeChanging",A),v.editCompleteArgs=A,this.drawShapeTextEvent(A),p&&(v.activeObj.rotatedAngle=p*(Math.PI/180),v.notify("selection",{prop:"updPtCollForShpRot",onPropertyChange:!1,value:{obj:v.activeObj}}),this.upperContext.clearRect(0,0,v.upperCanvas.width,v.upperCanvas.height),v.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:v.activeObj,isCropRatio:null,points:null,isPreventDrag:!0,saveContext:null,isPreventSelection:null}}),v.notify("toolbar",{prop:"destroy-qa-toolbar",onPropertyChange:!1}),v.notify("toolbar",{prop:"renderQAT",onPropertyChange:!1,value:{isPenEdit:null}})),e&&e.indexOf(`
`)>-1&&v.isPublicMethod){var L=String(v.fontSizeColl.findIndex(function(H){return H.text===String(v.activeObj.textSettings.fontSize)})+1);v.noPushUndo=!0,v.updateFontSize("5"),parseInt(L,10)>0&&v.updateFontSize(L),v.noPushUndo=!1}v.isPublicMethod&&!l&&v.notify("undo-redo",{prop:"updateUndoRedo",value:{operation:"shapeInsert"},onPropertyChange:!1}),v.isPublicMethod=!1}},d.prototype.drawShapeImageEvent=function(e,i){var t=this.parent;this.updateShapeChangeEventArgs(e.currentShapeSettings,e.allowShapeOverflow),t.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}}),t.objColl.push(t.activeObj);var r=f({},t.cropObj,{},!0);t.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeInsert",previousObj:this.prevObj,previousObjColl:this.prevObj.objColl,previousPointColl:this.prevObj.pointColl,previousSelPointColl:this.prevObj.selPointColl,previousCropObj:r,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),t.notify("selection",{prop:"redrawShape",onPropertyChange:!1,value:{obj:t.objColl[t.objColl.length-1]}}),i?(t.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"shapes",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}),t.notify("toolbar",{prop:"update-toolbar-items",onPropertyChange:!1}),t.notify("toolbar",{prop:"renderQAT",onPropertyChange:!1,value:{isPenEdit:null}})):t.okBtn(null,!0),t.notify("selection",{prop:"isShapeInserted",onPropertyChange:!1,value:{bool:!0}})},d.prototype.setTransformColl=function(e){var i=this.parent;if(i.activeObj.rotateFlipColl=[],e)for(var t=0;t<e.length;t++)e[t].degree?i.activeObj.rotateFlipColl.push(e[t].degree):i.activeObj.rotateFlipColl.push(e[t].flip.toLowerCase())},d.prototype.drawShapeTextEvent=function(e){var i=this.parent;this.updateShapeChangeEventArgs(e.currentShapeSettings,e.allowShapeOverflow),this.addLetter(i.activeObj.textSettings.text),i.activeObj.textFlip=i.transform.currFlipState,this.updateFontRatio(i.activeObj),i.objColl.push(i.activeObj);var t=f({},i.cropObj,{},!0);i.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeInsert",previousObj:this.prevObj,previousObjColl:this.prevObj.objColl,previousPointColl:this.prevObj.pointColl,previousSelPointColl:this.prevObj.selPointColl,previousCropObj:t,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),i.notify("selection",{prop:"redrawShape",onPropertyChange:!1,value:{obj:i.objColl[i.objColl.length-1]}}),i.notify("toolbar",{prop:"renderQAT",onPropertyChange:!1,value:{isPenEdit:null}}),i.notify("selection",{prop:"isShapeInserted",onPropertyChange:!1,value:{bool:!0}}),i.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"text",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}),i.notify("toolbar",{prop:"update-toolbar-items",onPropertyChange:!1})},d.prototype.initializeTextShape=function(e,i,t,r,o,a,n,s,l){var p=this.parent;this.keyHistory="",p.upperCanvas.style.display="block",p.activeObj.strokeSettings.strokeColor=a||p.activeObj.strokeSettings.strokeColor,p.activeObj.strokeSettings.fillColor=n||p.activeObj.strokeSettings.fillColor,p.activeObj.textSettings.text=e||p.activeObj.textSettings.text,p.activeObj.textSettings.fontFamily=i||p.activeObj.textSettings.fontFamily,p.activeObj.textSettings.fontSize=t||p.activeObj.textSettings.fontSize,p.activeObj.textSettings.bold=r||p.activeObj.textSettings.bold,p.activeObj.textSettings.italic=o||p.activeObj.textSettings.italic,p.activeObj.strokeSettings.outlineColor=s||p.activeObj.strokeSettings.outlineColor,p.activeObj.strokeSettings.outlineWidth=l||p.activeObj.strokeSettings.outlineWidth},d.prototype.drawImage=function(e,i,t,r,o,a,n,s,l){this.initializeShape("image"),this.onLoadImgShape(e,i,t,r,o,null,a,n,s,l)},d.prototype.redrawActObj=function(e,i,t){var r,o=this.parent;o.activeObj.shape&&(r=o.activeObj.shape.split("-")),o.activeObj.horTopLine&&o.activeObj.shape&&r[0]!=="crop"&&(o.textArea.style.display==="block"||o.textArea.style.display==="inline-block"?(o.notify("selection",{prop:"setTextBoxStylesToActObj",onPropertyChange:!1}),this.updateFontRatio(o.activeObj,!0),e&&i?e!==o.activeObj.activePoint.startX&&i!==o.activeObj.activePoint.startY&&this.updateTextFromTextArea():(this.updateTextFromTextArea(),o.textArea.style.transform="",o.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1})),this.refreshActiveObj()):this.applyActObj(t))},d.prototype.apply=function(e,i,t){var r=this.parent;if(!r.disabled)if(r.togglePen&&!r.currObjType.isCustomCrop){var o=r.img.destLeft,a=r.img.destTop,n=r.img.destWidth,s=r.img.destHeight;r.notify("draw",{prop:"callUpdateCurrTransState",onPropertyChange:!1});var l=this.lowerContext.filter;this.lowerContext.filter="none",r.togglePen=!1,(r.isCircleCrop||r.currSelectionPoint&&r.currSelectionPoint.shape==="crop-circle")&&r.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),r.img.destLeft=o,r.img.destTop=a,r.img.destWidth=n,r.img.destHeight=s,this.lowerContext.filter=l}else t=t||"original",C(r.activeObj.shape)&&C(e)?r.currObjType.shape="":r.currObjType.shape=e||r.currObjType.shape,r.currObjType.shape!==""&&(this.upperContext.clearRect(0,0,r.upperCanvas.width,r.upperCanvas.height),r.activeObj.shape==="text"?r.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:t,obj:i,isCropRatio:null,points:null,isPreventDrag:!0,saveContext:null,isPreventSelection:null}}):r.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:t,obj:i}}),r.activeObj.shape=r.currObjType.shape.toLowerCase(),!e&&r.currObjType.shape!==""&&!r.currObjType.isCustomCrop&&r.objColl.push(f({},r.activeObj,{},!0)),this.keyHistory="")},d.prototype.setCenterPoints=function(e,i,t){var r=this.parent,o,a;e&&i&&t?(o=i,a=t):(o=r.activeObj.activePoint.width,a=r.activeObj.activePoint.height),r.activeObj.activePoint.startX=r.lowerCanvas.width/2-o/2,r.activeObj.activePoint.startY=r.lowerCanvas.height/2-a/2,r.activeObj.activePoint.endX=r.lowerCanvas.width/2+o/2,r.activeObj.activePoint.endY=r.lowerCanvas.height/2+a/2},d.prototype.updSelChangeEventArgs=function(e){var i=this.parent;i.activeObj.activePoint={startX:e.startX,startY:e.startY,endX:i.activeObj.activePoint.startX+i.activeObj.activePoint.width,endY:i.activeObj.activePoint.startY+i.activeObj.activePoint.height,width:e.width,height:e.height},i.activeObj.activePoint.endX=i.activeObj.activePoint.startX+i.activeObj.activePoint.width,i.activeObj.activePoint.endY=i.activeObj.activePoint.startY+i.activeObj.activePoint.height},d.prototype.updateShapeChangeEventArgs=function(e,i){var t=this.parent,r;if(e.id&&e.id.indexOf("shape_")===-1&&e.id.indexOf("pen_")===-1&&(t.activeObj.currIndex?t.activeObj.currIndex="shape_"+e.id:t.pointColl[r].id="pen_"+e.id),e.id&&e.id.split("_")[0]&&e.id.split("_")[0]==="pen")r=parseInt(e.id.split("_")[1],10)-1,t.pointColl[r].points=e.points,t.pointColl[r].strokeColor=e.strokeColor,t.pointColl[r].strokeWidth=e.strokeWidth,t.pointColl[r].opacity=e.opacity,e.index&&(t.pointColl[r].order=e.index);else{switch(t.activeObj.activePoint.startX=e.startX,t.activeObj.activePoint.startY=e.startY,e.width&&e.height&&(t.activeObj.activePoint.width=e.width,t.activeObj.activePoint.height=e.height,t.activeObj.activePoint.endX=t.activeObj.activePoint.startX+t.activeObj.activePoint.width,t.activeObj.activePoint.endY=t.activeObj.activePoint.startY+t.activeObj.activePoint.height),t.activeObj.shape!=="text"&&(t.activeObj.strokeSettings.strokeColor=e.strokeColor,t.activeObj.strokeSettings.strokeWidth=e.strokeWidth),t.activeObj.strokeSettings.fillColor=e.fillColor,t.activeObj.opacity=e.opacity,e.index&&(t.activeObj.order=e.index),t.activeObj.preventShapeDragOut=!i,C(e.degree)&&(e.degree=0),t.activeObj.shape){case"ellipse":t.activeObj.activePoint.width=e.radiusX*2,t.activeObj.activePoint.height=e.radiusY*2,t.activeObj.activePoint.endX=t.activeObj.activePoint.startX+t.activeObj.activePoint.width,t.activeObj.activePoint.endY=t.activeObj.activePoint.startY+t.activeObj.activePoint.height,e.degree&&(t.activeObj.rotatedAngle=e.degree*(Math.PI/180));break;case"line":case"arrow":t.activeObj.activePoint.width=e.length,t.activeObj.activePoint.endX=e.endX,t.activeObj.activePoint.endY=e.endY,t.activeObj.activePoint.width=t.activeObj.activePoint.startX+t.activeObj.activePoint.width,t.activeObj.activePoint.height=t.activeObj.activePoint.startY+t.activeObj.activePoint.height,t.activeObj.shape==="arrow"&&(t.activeObj.start=this.getArrowType(e.arrowHead),t.activeObj.end=this.getArrowType(e.arrowTail));break;case"text":t.activeObj.keyHistory=t.activeObj.textSettings.text=e.text,t.activeObj.textSettings.fontSize=e.fontSize,t.activeObj.strokeSettings.strokeColor=e.color,t.activeObj.strokeSettings.outlineColor=e.strokeColor,t.activeObj.strokeSettings.outlineWidth=e.strokeWidth,t.activeObj.strokeSettings.fillColor=e.fillColor,t.activeObj.textSettings.fontFamily=e.fontFamily,this.setTransformColl(e.transformCollection),e.degree&&(t.activeObj.rotatedAngle=e.degree*(Math.PI/180)),this.updateFontRatio(t.activeObj);break;case"rectangle":case"image":e.degree&&(t.activeObj.rotatedAngle=e.degree*(Math.PI/180));break;case"path":t.activeObj.pointColl=e.points;break}if(t.activeObj.shape==="text"&&t.activeObj.textSettings){t.activeObj.textSettings.bold=!1,t.activeObj.textSettings.italic=!1,t.activeObj.textSettings.underline=!1;for(var o=0;o<e.fontStyle.length;o++)switch(e.fontStyle[o]){case"bold":t.activeObj.textSettings.bold=!0;break;case"italic":t.activeObj.textSettings.italic=!0;break}}}},d.prototype.addLetter=function(e){var i=this.parent;if(i.textArea.style.display==="none"&&(i.currObjType.isText||i.activeObj.shape==="text")){var t=i.activeObj.textSettings.fontSize;e==="Backspace"?this.keyHistory=this.keyHistory.slice(0,-1):this.keyHistory+=e,this.upperContext.clearRect(0,0,i.upperCanvas.width,i.upperCanvas.height),this.updateFontStyles();var r=this.upperContext.measureText(this.keyHistory).width+t*.5,o=t;this.upperContext.fillText(this.keyHistory,i.activeObj.activePoint.startX,i.activeObj.activePoint.startY+t),this.upperContext.clearRect(0,0,i.upperCanvas.width,i.upperCanvas.height),i.currObjType.isText=!0,i.notify("selection",{prop:"setActivePoint",onPropertyChange:!1,value:{startX:r,startY:o}})}},d.prototype.redrawText=function(){var e=this.parent,i=e.activeObj.textSettings,t=i.fontSize,r=i.fontFamily,o=i.bold,a=i.italic,n="";o&&(n+="bold "),a&&(n+="italic "),this.upperContext.font=n+t+"px "+r;var s=e.activeObj.keyHistory.split(`
`),l=e.textArea.style.display==="block"||e.textArea.style.display==="inline-block"?this.getMaxText(!0):this.getMaxText(),p=this.upperContext.measureText(l).width+t*.5,h=s.length*t;s.length>1&&(h+=t*.5),e.notify("selection",{prop:"setTextSelection",onPropertyChange:!1,value:{width:p,height:h}}),e.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:e.activeObj.activePoint,obj:e.activeObj,isMouseMove:null,x:null,y:null}}),e.notify("selection",{prop:"redrawShape",onPropertyChange:!1,value:{obj:e.activeObj}})},d.prototype.updateTextFromTextArea=function(){var e=this.parent,i=!1,t=e.activeObj.textSettings.fontSize,r=f({},e.activeObj,{},!0),o=f({},e.cropObj,{},!0),a={currObj:{}};e.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:a}});var n=a.currObj;n.objColl=f([],e.objColl,[],!0),n.pointColl=f([],e.pointColl,[],!0),n.afterCropActions=f([],e.afterCropActions,[],!0);var s={selPointColl:null};e.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:s}}),n.selPointColl=f([],s.selPointColl,[],!0),e.activeObj.keyHistory!==e.textArea.value&&(i=!0),e.activeObj.keyHistory=e.textArea.value,e.textArea.style.display="none",e.textArea.value="",this.updateFontStyles();var l=this.upperContext.measureText(e.activeObj.keyHistory).width+t*.5,p=t,h=e.activeObj.keyHistory.split(`
`);if(h.length>1){p*=h.length,p+=t*.1*h.length;for(var u=[],c=0,g=h.length;c<g;c++)u.push(this.upperContext.measureText(h[c]).width+t*.5);l=Math.max.apply(Math,u)}if(e.notify("selection",{prop:"setTextSelection",onPropertyChange:!1,value:{width:l,height:p}}),e.activeObj.rotatedAngle!==0){var v=e.activeObj.activePoint.width-r.activePoint.width,b=e.activeObj.activePoint.height-r.activePoint.height,m="";v>0&&b>0?m="widthHeight":v!==0?m="width":b!==0&&(m="height"),e.activeObj.activePoint=f({},r.activePoint,{},!0),e.notify("selection",{prop:"adjustRotationPoints",onPropertyChange:!1,value:{rectangle:e.activeObj.activePoint,x:v,y:b,angle:e.activeObj.rotatedAngle,type:"text",elem:m}}),e.notify("shape",{prop:"updateFontSize",onPropertyChange:!1,value:{obj:e.activeObj}})}e.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:e.activeObj.activePoint,obj:e.activeObj,isMouseMove:null,x:null,y:null}}),this.updImgRatioForActObj(),e.activeObj.rotatedAngle!==0&&e.notify("selection",{prop:"updPtCollForShpRot",onPropertyChange:!1,value:{obj:e.activeObj}}),i?(this.apply(e.activeObj.shape,e.activeObj),e.objColl.push(f({},e.activeObj,{},!0)),e.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"text",previousObj:n,previousObjColl:n.objColl,previousPointColl:n.pointColl,previousSelPointColl:n.selPointColl,previousCropObj:o,previousText:e.activeObj.keyHistory,currentText:e.textArea.value,previousFilter:null,isCircleCrop:null}})):(this.apply(e.activeObj.shape,e.activeObj),e.objColl.push(f({},e.activeObj,{},!0)))},d.prototype.iterateObjColl=function(){var e=this.parent;if(e.objColl.length>0)for(var i=this.getSmallestIndex(),t=f([],e.objColl,[],!0);t.length>0;){for(var r=!1,o=0;o<t.length;o++){var a=t[o];if(C(a.order)){t.splice(o,1),o--;continue}if(a.order===i){this.apply(a.shape,a),a.shape==="redact"&&JSON.stringify(a.activePoint)===JSON.stringify(e.activeObj.activePoint)&&a.redactImage!==e.activeObj.redactImage&&(a.redactImage=e.activeObj.redactImage,e.objColl[o]&&JSON.stringify(e.objColl[o].activePoint)===JSON.stringify(a.activePoint)&&(e.objColl[o].redactImage=e.activeObj.redactImage)),this.refreshActiveObj(),i++,this.isIndexInObjColl(i)||i++,t.splice(o,1),r=!0;break}}if(!r)break}},d.prototype.getSmallestIndex=function(){for(var e=this.parent,i,t=0,r=e.objColl.length;t<r;t++){var o=e.objColl[t];C(o.order)||(C(i)||o.order<i)&&(i=o.order)}return i},d.prototype.isIndexInObjColl=function(e){for(var i=this.parent,t=0,r=i.objColl.length;t<r;t++){var o=i.objColl[t];if(!C(o.order)&&o.order===e)return!0}return!1},d.prototype.updImgRatioForActObj=function(){var e=this.parent,i={startX:e.img.destLeft,startY:e.img.destTop,width:e.img.destWidth,height:e.img.destHeight};this.straightenShapes();var t=e.img,r=t.destLeft,o=t.destTop,a=t.destWidth,n=t.destHeight,s=e.activeObj.activePoint;e.activeObj.imageRatio={startX:(s.startX-r)/a,startY:(s.startY-o)/n,endX:(s.endX-r)/a,endY:(s.endY-o)/n,width:a/s.width,height:n/s.height},e.activeObj.rotationCirclePointColl&&(e.activeObj.rotationCirclePointColl.ratioX=(e.activeObj.rotationCirclePointColl.x-r)/a,e.activeObj.rotationCirclePointColl.ratioY=(e.activeObj.rotationCirclePointColl.y-o)/n),e.activeObj.shape==="path"?this.updatePathRatio(e.activeObj):e.activeObj.shape==="arrow"&&this.updateArrowRatio(e.activeObj),e.img.destLeft=i.startX,e.img.destTop=i.startY,e.img.destWidth=i.width,e.img.destHeight=i.height},d.prototype.zoomObjColl=function(e){var i=this.parent,t={startX:i.img.destLeft,startY:i.img.destTop,width:i.img.destWidth,height:i.img.destHeight};if(this.straightenShapes(),i.objColl.length>0){for(var r=0,o=i.objColl.length;r<o;r++){var a=i.objColl[r];if(a.imageRatio&&(a.activePoint.startX=a.imageRatio.startX*i.img.destWidth+i.img.destLeft,a.activePoint.startY=a.imageRatio.startY*i.img.destHeight+i.img.destTop,a.activePoint.endX=a.imageRatio.endX*i.img.destWidth+i.img.destLeft,a.activePoint.endY=a.imageRatio.endY*i.img.destHeight+i.img.destTop),a=this.updateWidthHeight(a),a.shape==="text")this.updateFontSize(a);else if(a.shape==="line"||a.shape==="arrow"){a.pointColl=this.getLinePoints(a.activePoint.startX,a.activePoint.startY,a.activePoint.endX,a.activePoint.endY);for(var n=0,s=a.pointColl.length;n<s;n++)a.pointColl[n].ratioX=(a.pointColl[n].x-i.img.destLeft)/i.img.destWidth,a.pointColl[n].ratioY=(a.pointColl[n].y-i.img.destTop)/i.img.destHeight;a.shape==="arrow"&&this.updateArrowSize(a),i.transform.straighten!==0&&(a.shape==="line"||a.shape==="arrow")&&this.straightenShapePoints(a)}else if(a.shape==="path"){for(var l=0,p=a.pointColl.length;l<p;l++)a.pointColl[l].x=a.pointColl[l].ratioX*i.img.destWidth+i.img.destLeft,a.pointColl[l].y=a.pointColl[l].ratioY*i.img.destHeight+i.img.destTop;this.updatePathRatio(a),i.transform.straighten!==0&&this.straightenPath(a)}i.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:a.activePoint,obj:a}}),a.shape!=="line"&&a.shape!=="arrow"&&a.shape!=="path"&&a.rotatedAngle!==0&&(this.setPointCollForShapeRotation(a),a.rotationCirclePoint.x=a.rotationCirclePoint.ratioX*i.img.destWidth+i.img.destLeft,a.rotationCirclePoint.y=a.rotationCirclePoint.ratioY*i.img.destHeight+i.img.destTop,a.rotationCirclePointColl&&(a.rotationCirclePointColl.x=a.rotationCirclePointColl.ratioX*i.img.destWidth+i.img.destLeft,a.rotationCirclePointColl.y=a.rotationCirclePointColl.ratioY*i.img.destHeight+i.img.destTop))}if(C(e)){var h=this.lowerContext.filter;this.lowerContext.filter="none",this.iterateObjColl(),this.lowerContext.filter=h}}i.img.destLeft=t.startX,i.img.destTop=t.startY,i.img.destWidth=t.width,i.img.destHeight=t.height},d.prototype.straightenPath=function(e){for(var i,t=0,r=e.pointColl.length;t<r;t++)i=this.straightenPoints(e.pointColl[t].x,e.pointColl[t].y),e.pointColl[t].x=i.x,e.pointColl[t].y=i.y},d.prototype.straightenFHD=function(){for(var e=this.parent,i=0,t=e.freehandCounter;i<t;i++){e.points=f([],e.pointColl[i].points,[]);for(var r=e.points.length,o=void 0,a=0;a<r;a++)o=this.straightenPoints(e.points[a].x,e.points[a].y),e.points[a].x=o.x,e.points[a].y=o.y}var n={selPointColl:null};e.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:n}});for(var i=0,t=e.freehandCounter;i<t;i++)if(n.selPointColl[i]&&n.selPointColl[i].points)for(var r=n.selPointColl[i].points.length,o=void 0,a=0;a<r;a++)o=this.straightenPoints(n.selPointColl[i].points[a].x,n.selPointColl[i].points[a].y),n.selPointColl[i].points[a].x=o.x,n.selPointColl[i].points[a].y=o.y;var s={straightenPoint:null};if(e.notify("freehand-draw",{prop:"getStraightenPoint",onPropertyChange:!1,value:{obj:s}}),s.straightenPoint.x&&s.straightenPoint.y){var l={angle:0};e.notify("freehand-draw",{prop:"getStraightenPointAngle",onPropertyChange:!1,value:{obj:l}});var p=((e.transform.straighten===360?0:e.transform.straighten)-l.angle)*(Math.PI/180),o=this.straightenPoints(s.straightenPoint.x,s.straightenPoint.y,p);p===0&&(o.x=s.straightenPoint.x,o.y=s.straightenPoint.y),e.notify("freehand-draw",{prop:"setStraightenPoint",onPropertyChange:!1,value:{x:o.x,y:o.y}})}},d.prototype.straightenPoints=function(e,i,t){var r=this.parent,o={x:r.img.destLeft+r.img.destWidth/2,y:r.img.destTop+r.img.destHeight/2};t=t||r.transform.straighten*(Math.PI/180);var a={x:Math.cos(t)*(e-o.x)-Math.sin(t)*(i-o.y)+o.x,y:Math.sin(t)*(e-o.x)+Math.cos(t)*(i-o.y)+o.y};return a},d.prototype.straightenShapes=function(){var e=this.parent,i=e.img,t=i.destLeft,r=i.destTop,o=i.destWidth,a=i.destHeight,n={bool:e.isStraightening};if(!(!n.bool||e.transform.straighten===0)){e.notify("draw",{prop:"updateImgCanvasPoints"});var s={points:null};e.notify("draw",{prop:"getImageCanvasPoints",value:{obj:s}});var l={x:t+o/2,y:r+a/2},p=-(e.transform.straighten*(Math.PI/180)),h={x:Math.cos(p)*(s.points[0].x-l.x)-Math.sin(p)*(s.points[0].y-l.y)+l.x,y:Math.sin(p)*(s.points[0].x-l.x)+Math.cos(p)*(s.points[0].y-l.y)+l.y},u={x:Math.cos(p)*(s.points[1].x-l.x)-Math.sin(p)*(s.points[1].y-l.y)+l.x,y:Math.sin(p)*(s.points[1].x-l.x)+Math.cos(p)*(s.points[1].y-l.y)+l.y},c={x:Math.cos(p)*(s.points[2].x-l.x)-Math.sin(p)*(s.points[2].y-l.y)+l.x,y:Math.sin(p)*(s.points[2].x-l.x)+Math.cos(p)*(s.points[2].y-l.y)+l.y};e.img.destWidth=u.x-h.x,e.img.destHeight=c.y-u.y,e.img.destLeft=h.x,e.img.destTop=h.y}},d.prototype.straightenShapePoints=function(e,i){var t=this.parent,r=t.img,o=r.destLeft,a=r.destTop,n=r.destWidth,s=r.destHeight,l={bool:t.isStraightening};if(l.bool&&(e.shape==="line"||e.shape==="arrow")){e.activePoint.width=e.activePoint.endX>e.activePoint.startX?e.activePoint.endX-e.activePoint.startX:e.activePoint.startX-e.activePoint.endX,e.activePoint.height=e.activePoint.endY>e.activePoint.startY?e.activePoint.endY-e.activePoint.startY:e.activePoint.startY-e.activePoint.endY;var p={x:o+n/2,y:a+s/2},h=(i?-t.transform.straighten:t.transform.straighten)*(Math.PI/180),u={x:Math.cos(h)*(e.activePoint.startX-p.x)-Math.sin(h)*(e.activePoint.startY-p.y)+p.x,y:Math.sin(h)*(e.activePoint.startX-p.x)+Math.cos(h)*(e.activePoint.startY-p.y)+p.y},c={x:Math.cos(h)*(e.activePoint.endX-p.x)-Math.sin(h)*(e.activePoint.endY-p.y)+p.x,y:Math.sin(h)*(e.activePoint.endX-p.x)+Math.cos(h)*(e.activePoint.endY-p.y)+p.y};e.activePoint.startX=u.x,e.activePoint.startY=u.y,e.activePoint.endX=c.x,e.activePoint.endY=c.y,e.activePoint.width=e.activePoint.endX>e.activePoint.startX?e.activePoint.endX-e.activePoint.startX:e.activePoint.startX-e.activePoint.endX,e.activePoint.height=e.activePoint.endY>e.activePoint.startY?e.activePoint.endY-e.activePoint.startY:e.activePoint.startY-e.activePoint.endY,t.notify("selection",{prop:"adjustActObjForLineArrow",onPropertyChange:!1,value:{obj:e}})}},d.prototype.redrawObj=function(e){var i=this.parent,t=!1;if(i.objColl.length>0){if(e==="horizontal"||e==="vertical"||e==="Horizontal"||e==="Vertical"||e==="horizontalVertical"||e==="verticalHorizontal")this.updateCurrentActiveObjPoint(e.toLowerCase());else if(typeof e=="number"){this.updateCurrentActiveObjPoint(e);var r=this.lowerContext.filter;this.lowerContext.filter="brightness(1) contrast(100%) hue-rotate(0deg) saturate(100%) opacity(1) blur(0px) sepia(0%) grayscale(0%) invert(0%)";for(var o=0,a=i.objColl.length;o<a;o++){var n=i.objColl[o].shape.split("-");n[0]!=="crop"&&(this.apply(i.objColl[o].shape,i.objColl[o]),t=!0)}t&&i.notify("draw",{prop:"applyFrame",value:{ctx:this.lowerContext,frame:i.frameObj.type,preventImg:!0}}),this.lowerContext.filter=r}}},d.prototype.updateCurrentActiveObjPoint=function(e){for(var i=this.parent,t,r=i.img,o=r.destLeft,a=r.destTop,n=r.destWidth,s=r.destHeight,l=0,p=i.objColl.length;l<p;l++){var h=i.objColl[l];if(i.activeObj.shape===h.shape&&i.activeObj.activePoint.startX===h.activePoint.startX&&i.activeObj.activePoint.startY===h.activePoint.startY&&i.activeObj.activePoint.endX===h.activePoint.endX&&i.activeObj.activePoint.endY===h.activePoint.endY&&i.activeObj.currIndex===h.currIndex){t=l;break}}if(e==="horizontal"||e==="vertical"||e==="Horizontal"||e==="Vertical"||e==="horizontalvertical"||e==="verticalhorizontal"){if(e==="horizontal"||e==="Horizontal")for(var u=0,p=i.objColl.length;u<p;u++){var h=i.objColl[u];h.shapeFlip!==i.transform.currFlipState&&(h.activePoint.startX<=o+n/2?(h.activePoint.endX=o+n-(h.activePoint.startX-o),h.activePoint.startX=h.activePoint.endX-h.activePoint.width,i.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:h.activePoint,obj:h}})):h.activePoint.startX>=o+n/2&&(h.activePoint.startX=o+(o+n-h.activePoint.endX),h.activePoint.endX=h.activePoint.startX+h.activePoint.width,i.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:h.activePoint,obj:h}})),h.shape==="line"||h.shape==="arrow"||h.shape==="path"?this.flipLineArrowObj(h,"horizontal"):h.rotatedAngle!==0&&(h.rotatedAngle=h.rotatedAngle+(Math.PI-h.rotatedAngle)*2,h.rotationCirclePointColl.x<=o+n/2?h.rotationCirclePointColl.x=o+n-(h.rotationCirclePointColl.x-o):h.rotationCirclePointColl.x>=o+n/2&&(h.rotationCirclePointColl.x=o+(o+n-h.rotationCirclePointColl.x)),h.rotationCirclePointColl.ratioX=(h.rotationCirclePointColl.x-o)/n),h.shapeFlip=i.transform.currFlipState,h.imageRatio={startX:(h.activePoint.startX-o)/n,startY:(h.activePoint.startY-a)/s,endX:(h.activePoint.endX-o)/n,endY:(h.activePoint.endY-a)/s,width:n/h.activePoint.width,height:s/h.activePoint.height})}else if(e==="vertical"||e==="Vertical")for(var u=0;u<i.objColl.length;u++){var h=i.objColl[u];h.shapeFlip!==i.transform.currFlipState&&(h.activePoint.startY<=a+s/2?(h.activePoint.endY=a+s-(h.activePoint.startY-a),h.activePoint.startY=h.activePoint.endY-h.activePoint.height,i.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:h.activePoint,obj:h}})):h.activePoint.startY>=i.lowerCanvas.height/2&&(h.activePoint.startY=a+(a+s-h.activePoint.endY),h.activePoint.endY=h.activePoint.startY+h.activePoint.height,i.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:h.activePoint,obj:h}})),h.shape==="line"||h.shape==="arrow"||h.shape==="path"?this.flipLineArrowObj(h,"vertical"):h.rotatedAngle!==0&&(h.rotatedAngle=-h.rotatedAngle,h.rotationCirclePointColl.y<=a+s/2?h.rotationCirclePointColl.y=a+s-(h.rotationCirclePointColl.y-a):h.rotationCirclePointColl.y>=a+s/2&&(h.rotationCirclePointColl.y=a+(a+s-h.rotationCirclePointColl.y)),h.rotationCirclePointColl.ratioY=(h.rotationCirclePointColl.y-a)/s),h.shapeFlip=i.transform.currFlipState,h.imageRatio={startX:(h.activePoint.startX-o)/n,startY:(h.activePoint.startY-a)/s,endX:(h.activePoint.endX-o)/n,endY:(h.activePoint.endY-a)/s,width:n/h.activePoint.width,height:s/h.activePoint.height})}else if(e==="verticalhorizontal"||e==="horizontalvertical")for(var u=0,p=i.objColl.length;u<p;u++){var h=i.objColl[u];h.shapeFlip!==i.transform.currFlipState&&(h.activePoint.startX<=o+n/2?(h.activePoint.endX=o+n-(h.activePoint.startX-o),h.activePoint.startX=h.activePoint.endX-h.activePoint.width,i.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:h.activePoint,obj:h}})):h.activePoint.startX>=o+n/2&&(h.activePoint.startX=o+(o+n-h.activePoint.endX),h.activePoint.endX=h.activePoint.startX+h.activePoint.width,i.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:h.activePoint,obj:h}})),h.activePoint.startY<=a+s/2?(h.activePoint.endY=a+s-(h.activePoint.startY-a),h.activePoint.startY=h.activePoint.endY-h.activePoint.height,i.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:h.activePoint,obj:h}})):h.activePoint.startY>=i.lowerCanvas.height/2&&(h.activePoint.startY=a+(a+s-h.activePoint.endY),h.activePoint.endY=h.activePoint.startY+h.activePoint.height,i.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:h.activePoint,obj:h}})),(h.shape==="line"||h.shape==="arrow"||h.shape==="path")&&this.flipLineArrowObj(h,e),h.shapeFlip=i.transform.currFlipState,h.imageRatio={startX:(h.activePoint.startX-o)/n,startY:(h.activePoint.startY-a)/s,endX:(h.activePoint.endX-o)/n,endY:(h.activePoint.endY-a)/s,width:n/h.activePoint.width,height:s/h.activePoint.height})}t!==void 0&&(i.activeObj=f({},i.objColl[t],{},!0))}else if(e===90)this.rotateObjColl();else if(e===-90)for(var u=0;u<3;u++)this.rotateObjColl();else if(typeof e=="number")if(e>0)this.rotateObjColl();else for(var u=0;u<3;u++)this.rotateObjColl()},d.prototype.rotateObjColl=function(){for(var e=this.parent,i=e.img,t=i.destWidth,r=i.destHeight,o=i.destLeft,a=i.destTop,n=0,s=e.objColl.length;n<s;n++){var l=e.objColl[n],p=l.shape;l.activePoint.startY=a+r*l.imageRatio.startX,l.activePoint.endY=a+r*l.imageRatio.endX,l.activePoint.startX=o+t-t*l.imageRatio.endY,l.activePoint.endX=o+t-t*l.imageRatio.startY,l=this.updateWidthHeight(e.objColl[n]),this.updateFontSize(l),p==="line"||p==="arrow"||p==="path"?(this.rotateLineArrowObj(l),p==="arrow"&&this.updateArrowSize(l)):l.rotatedAngle!==0&&(l.rotationCirclePointColl.y=a+r*l.rotationCirclePointColl.ratioX,l.rotationCirclePointColl.x=o+t-t*l.rotationCirclePointColl.ratioY,l.rotationCirclePointColl.ratioX=(l.rotationCirclePointColl.x-o)/t,l.rotationCirclePointColl.ratioY=(l.rotationCirclePointColl.y-a)/r)}for(var n=0,s=e.objColl.length;n<s;n++)e.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:e.objColl[n].activePoint,obj:e.objColl[n]}});for(var n=0,s=e.objColl.length;n<s;n++){var l=e.objColl[n];l.imageRatio={startX:(l.activePoint.startX-o)/t,startY:(l.activePoint.startY-a)/r,endX:(l.activePoint.endX-o)/t,endY:(l.activePoint.endY-a)/r,width:t/l.activePoint.width,height:r/l.activePoint.height}}},d.prototype.rotateLineArrowObj=function(e){if(!C(e.pointColl)){var i=this.parent,t=i.img,r=t.destWidth,o=t.destHeight,a=t.destLeft,n=t.destTop;if(e.pointColl.length>0){for(var s=0;s<e.pointColl.length;s++)e.pointColl[s].y=n+o*e.pointColl[s].ratioX,e.pointColl[s].x=a+r-r*e.pointColl[s].ratioY;for(var s=0;s<e.pointColl.length;s++)e.pointColl[s].ratioX=(e.pointColl[s].x-a)/r,e.pointColl[s].ratioY=(e.pointColl[s].y-n)/o;var l=void 0;C(e.pointColl[e.pointColl.length-2])?l={x:0,y:0}:l={x:e.pointColl[e.pointColl.length-2].x,y:e.pointColl[e.pointColl.length-2].y};var p=e.pointColl[e.pointColl.length-1].x-l.x,h=e.pointColl[e.pointColl.length-1].y-l.y;e.activePoint.startX=e.pointColl[0].x,e.activePoint.startY=e.pointColl[0].y,e.activePoint.endX=e.pointColl[e.pointColl.length-1].x+p/2,e.activePoint.endY=e.pointColl[e.pointColl.length-1].y+h/2,e=this.updateWidthHeight(e)}}},d.prototype.flipLineArrowObj=function(e,i){if(i=i.toLowerCase(),!C(e.pointColl)&&(i==="horizontal"?this.lineArrowHorizontalFlip(e):i==="vertical"?this.lineArrowVerticalFlip(e):(this.lineArrowHorizontalFlip(e),e.shapeFlip="",this.lineArrowVerticalFlip(e)),e.activePoint.startX=e.pointColl[0].x,e.activePoint.startY=e.pointColl[0].y,e.activePoint.endX=e.pointColl[e.pointColl.length-1].x,e.activePoint.endY=e.pointColl[e.pointColl.length-1].y,e.activePoint.startX>e.activePoint.endX)){var t=e.activePoint.startX;e.activePoint.startX=e.activePoint.endX,e.activePoint.endX=t,t=e.activePoint.startY,e.activePoint.startY=e.activePoint.endY,e.activePoint.endY=t}},d.prototype.lineArrowHorizontalFlip=function(e){var i=this.parent,t=i.img,r=t.destWidth,o=t.destHeight,a=t.destLeft,n=t.destTop;if(e.shapeFlip!==i.transform.currFlipState){for(var s=0,l=e.pointColl.length;s<l;s++){var p=e.pointColl[s];p.x<=a+r/2?p.x=a+r-(p.x-a):p.x>=a+r/2&&(p.x=a+(a+r-p.x)),p.ratioX=(p.x-a)/r,p.ratioY=(p.y-n)/o}if(e.shape==="arrow"){var h=e.start;e.start=e.end,e.end=h}e.shapeFlip=i.transform.currFlipState}},d.prototype.lineArrowVerticalFlip=function(e){var i=this.parent,t=i.img,r=t.destWidth,o=t.destHeight,a=t.destLeft,n=t.destTop;if(e.shapeFlip!==i.transform.currFlipState){for(var s=0,l=e.pointColl.length;s<l;s++){var p=e.pointColl[s];p.y<=n+o/2?p.y=n+o-(p.y-n):p.y>=n+o/2&&(p.y=n+(n+o-p.y)),p.ratioX=(p.x-a)/r,p.ratioY=(p.y-n)/o}e.shapeFlip=i.transform.currFlipState}},d.prototype.getRotDegOfShape=function(e,i){var t=this.parent,r;e.shapeDegree===0?r=this.parent.transform.degree:r=this.parent.transform.degree-e.shapeDegree,r<0&&(r=360+r);var o={bool:!1};if(t.notify("selection",{prop:"getTransformedShape",onPropertyChange:!1,value:{obj:o}}),o.bool&&!i&&t.activeObj.rotateFlipColl){r=0;for(var a=0;a<t.activeObj.rotateFlipColl.length;a++)typeof t.activeObj.rotateFlipColl[a]=="number"&&(r+=t.activeObj.rotateFlipColl[a])}return r},d.prototype.renderTextArea=function(e,i,t){var r=this.parent,o={shapeSettingsObj:{}};r.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:o}});var a=o.shapeSettingsObj,n={cancel:!1,action:"text-edit",previousShapeSettings:a,currentShapeSettings:a};r.trigger("shapeChanging",n),this.updateShapeChangeEventArgs(n.currentShapeSettings,n.allowShapeOverflow);var s=this.getRotDegOfShape(r.activeObj);this.transformTextArea(),r.notify("toolbar",{prop:"destroy-qa-toolbar",onPropertyChange:!1});var l=r.element.querySelector("#"+r.element.id+"_zOrderBtn"),p=r.element.querySelector("#"+r.element.id+"_duplicate"),h=r.element.querySelector("#"+r.element.id+"_remove"),u=r.element.querySelector("#"+r.element.id+"_editText"),c=t.strokeSettings.outlineColor,g=t.strokeSettings.outlineWidth,v=[];l&&l.classList.add("e-overlay"),p&&p.classList.add("e-overlay"),h&&h.classList.add("e-overlay"),u&&u.classList.add("e-overlay"),t.strokeSettings.fillColor!==""?r.textArea.style.backgroundColor=t.strokeSettings.fillColor:r.textArea.style.backgroundColor="transparent",r.textArea.style.display="block",r.textArea.style.left=e+"px",r.textArea.style.top=i+"px",r.textArea.style.fontFamily=t.textSettings.fontFamily,r.textArea.style.fontSize=t.textSettings.fontSize+"px",r.textArea.style.color=t.strokeSettings.strokeColor;var b=t.textSettings.fontSize,m=Math.max(1,g/2),y=m*(Math.floor((b-1)/16)*.5+.5);if(/^#([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6}|[0-9A-Fa-f]{8})$|^[a-zA-Z]+$/.test(t.strokeSettings.outlineColor)){for(var P=-y;P<=y;P++)for(var S=-y;S<=y;S++)(P!==0||S!==0)&&v.push(P/2+"px "+S/2+"px 0 "+c);r.textArea.style.textShadow=v.join(", ")}else r.textArea.style.textShadow=null;r.textArea.style.fontWeight=t.textSettings.bold?"bold":"normal",r.textArea.style.fontStyle=t.textSettings.italic?"italic":"normal",r.textArea.style.border="2px solid "+r.themeColl[r.theme].primaryColor,r.textArea.value=t.keyHistory,r.textArea.style.overflow="hidden",r.textArea.style.width="auto",r.textArea.style.height="auto",r.textArea.focus();var O=t.activePoint,j=O.width,x=O.height;s%90===0&&s%180!==0&&s!==0?(r.textArea.style.width=x+x*.25+"px",r.textArea.style.height=j+j*.25+"px"):(r.textArea.style.width=j+j*.25+"px",r.textArea.style.height=x+x*.25+"px"),this.setTextBoxWidth();var k={flipColl:null};if(r.notify("transform",{prop:"getFlipColl",onPropertyChange:!1,value:{obj:k}}),k.flipColl.length<=1&&this.setTextBoxHeight(),parseFloat(r.textArea.style.maxHeight)<r.activeObj.textSettings.fontSize&&(r.textArea.style.maxHeight=r.activeObj.textSettings.fontSize+"px"),s%90===0&&s%180!==0?parseFloat(r.textArea.style.left)+parseFloat(r.textArea.style.width)>r.img.destTop+r.img.destHeight&&this.alignTextAreaIntoCanvas():parseFloat(r.textArea.style.left)+parseFloat(r.textArea.style.width)>r.img.destLeft+r.img.destWidth&&this.alignTextAreaIntoCanvas(),t.rotatedAngle!==0){var T=parseFloat(r.textArea.style.left),A=parseFloat(r.textArea.style.top);if(t.flipObjColl.length>0){var L={panRegion:""},H=r.lowerCanvas,B=H.clientWidth,D=H.clientHeight,E={x:0,y:0};r.notify("crop",{prop:"getCurrFlipState",onPropertyChange:!1,value:{panObj:L}}),L.panRegion!==""&&(L.panRegion==="horizontal"?(E.x=B-B/2,T=E.x-T+E.x):L.panRegion==="vertical"?(E.y=D-D/2,A=E.y-A+E.y):(E={x:B-B/2,y:D-D/2},T=E.x-T+E.x,A=E.y-A+E.y))}var R=T+parseFloat(r.textArea.style.width),Q=A+parseFloat(r.textArea.style.height),V=parseFloat(r.textArea.style.width),G=parseFloat(r.textArea.style.height),W={x:R-V/2,y:Q-G/2},K=Math.cos(t.rotatedAngle),$=Math.sin(t.rotatedAngle),Z={x:K*(R-W.x)-$*(Q-W.y)+W.x,y:$*(R-W.x)+K*(Q-W.y)+W.y};if(Z.x>r.img.destLeft&&Z.x<r.img.destLeft+r.img.destWidth&&Z.y>r.img.destTop&&Z.y+parseFloat(r.textArea.style.fontSize)<r.img.destTop+r.img.destHeight)r.textArea.style.width=r.textArea.style.width;else for(var pe=0,he=parseFloat(r.textArea.style.width);;)if(pe++,V-=1,R=T+V,W={x:R-V/2,y:Q-G/2},Z={x:K*(R-W.x)-$*(Q-W.y)+W.x,y:$*(R-W.x)+K*(Q-W.y)+W.y},Z.x>r.img.destLeft&&Z.x<r.img.destLeft+r.img.destWidth&&Z.y>r.img.destTop&&Z.y+parseFloat(r.textArea.style.fontSize)<r.img.destTop+r.img.destHeight||pe===he){r.textArea.style.width=V+"px";break}}r.notify("selection",{prop:"clearUpperCanvas",onPropertyChange:!1})},d.prototype.setTextBoxWidth=function(e){var i=this.parent;if(i.activeObj.rotatedAngle!==0){i.textArea.style.whiteSpace="nowrap",i.textArea.style.textOverflow="ellipsis",i.textArea.style.display="inline-block";return}else i.textArea.style.whiteSpace="",i.textArea.style.textOverflow="",i.textArea.style.display==="inline-block"&&(i.textArea.style.display="block");var t=this.getMaxText(!0);i.textArea.style.display==="block"||i.textArea.style.display==="inline-block"?this.updateFontStyles(!0):this.updateFontStyles();var r=this.upperContext.measureText(t).width+parseFloat(i.textArea.style.fontSize)/2,o=e?this.upperContext.measureText(String.fromCharCode(e.which)).width:0,a=f({},i.activeObj,{},!0),n="",s=this.getRotDegOfShape(a);if(a.shapeFlip!==i.transform.currFlipState?n="":n=i.transform.currFlipState,e&&parseFloat(i.textArea.style.width)<r+o||C(e)){if(s===0)n.toLowerCase()==="horizontal"?parseFloat(i.textArea.style.left)-i.img.destLeft-r-o>0&&(i.textArea.style.width=r+o+"px"):i.img.destWidth-(parseFloat(i.textArea.style.left)-i.img.destLeft)>r+o&&(i.textArea.style.width=r+o+"px");else if(s===90)n.toLowerCase()==="vertical"?parseFloat(i.textArea.style.top)-i.img.destTop-r-o>0&&(i.textArea.style.width=r+o+"px"):i.img.destHeight-(parseFloat(i.textArea.style.top)-i.img.destTop)>r+o&&(i.textArea.style.width=r+o+"px");else if(s===180){var l=parseFloat(i.textArea.style.left),p=i.img.destLeft;if(n.toLowerCase()==="horizontal"){var h=i.img.destWidth-(l-p);h>r+o&&(i.textArea.style.width=r+o+"px")}else{var u=l-p;u-r-o>0&&(i.textArea.style.width=r+o+"px")}}else if(s===270){var c=parseFloat(i.textArea.style.top),g=i.img.destTop;if(n.toLowerCase()==="vertical"){var v=i.img.destHeight-(c-g);v>r+o&&(i.textArea.style.width=r+o+"px")}else{var b=c-g;b-r-o>0&&(i.textArea.style.width=r+o+"px")}}}},d.prototype.setTextBoxHeight=function(){var e=this.parent,i,t=f({},e.activeObj,{},!0),r="",o=this.getRotDegOfShape(t);switch(t.textFlip===e.transform.currFlipState?r="":t.textFlip===""?r=e.transform.currFlipState:r=t.textFlip,o){case 0:r.toLowerCase()==="vertical"?e.textArea.style.maxHeight=e.img.destHeight-(e.img.destHeight-parseFloat(e.textArea.style.top))+"px":(i=parseFloat(e.textArea.style.top)-e.img.destTop,e.textArea.style.maxHeight=e.img.destHeight-i+"px");break;case 90:r.toLowerCase()==="horizontal"?e.textArea.style.maxHeight=e.img.destWidth-(parseFloat(e.textArea.style.left)-e.img.destLeft)+"px":e.textArea.style.maxHeight=parseFloat(e.textArea.style.left)-e.img.destLeft+"px";break;case 180:r.toLowerCase()==="vertical"?(i=parseFloat(e.textArea.style.top)-e.img.destTop,e.textArea.style.maxHeight=e.img.destHeight-i+"px"):e.textArea.style.maxHeight=parseFloat(e.textArea.style.top)-e.img.destTop+"px";break;case 270:r.toLowerCase()==="horizontal"?e.textArea.style.maxHeight=parseFloat(e.textArea.style.left)-e.img.destLeft+"px":e.textArea.style.maxHeight=e.img.destWidth-(parseFloat(e.textArea.style.left)-e.img.destLeft)+"px";break}},d.prototype.updatePathRatio=function(e){for(var i=this.parent,t=0,r=e.pointColl.length;t<r;t++){var o=e.pointColl[t];o.ratioX=(o.x-i.img.destLeft)/i.img.destWidth,o.ratioY=(o.y-i.img.destTop)/i.img.destHeight}},d.prototype.stopPathDrawing=function(e,i){var t=this.parent;if(t.activeObj.shape==="path"){var r={shape:null};if(t.notify("selection",{prop:"getCurrentDrawingShape",value:{obj:r}}),r.shape==="path"){var o=f({},t.cropObj,{},!0),a={currObj:{}};t.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:a}});var n=a.currObj;n.objColl=f([],t.objColl,[],!0),n.pointColl=f([],t.pointColl,[],!0),n.afterCropActions=f([],t.afterCropActions,[],!0);var s={selPointColl:null};if(t.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:s}}),n.selPointColl=f([],s.selPointColl,[],!0),t.notify("selection",{prop:"setCurrentDrawingShape",value:{value:""}}),t.currObjType.isDragging=!1,e&&e.type!=="touchstart"&&C(i)&&t.activeObj.pointColl.pop(),this.updatePathRatio(t.activeObj),C(t.activeObj.imageRatio)&&t.notify("shape",{prop:"updImgRatioForActObj",onPropertyChange:!1}),t.objColl.push(t.activeObj),t.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:n,previousObjColl:n.objColl,previousPointColl:n.pointColl,previousSelPointColl:n.selPointColl,previousCropObj:o,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),t.objColl.pop(),e&&(t.notify("selection",{prop:"mouseUpEventHandler",value:{e}}),this.lowerContext.clearRect(0,0,t.lowerCanvas.width,t.lowerCanvas.height),t.notify("draw",{prop:"redrawImgWithObj",onPropertyChange:!1}),t.objColl.length>0)){var l=t.activeObj.activePoint,p=t.objColl[t.objColl.length-1].activePoint;Math.floor(l.startX)===Math.floor(p.startX)&&Math.floor(l.startY)===Math.floor(p.startY)&&Math.floor(l.endX)===Math.floor(p.endX)&&Math.floor(l.endY)===Math.floor(p.endY)&&this.refreshActiveObj()}if(t.notify("draw",{prop:"setNewPath",value:{bool:!0}}),t.objColl[t.objColl.length-1]){var h=t.drawingShape;t.notify("selection",{prop:"setCurrentDrawingShape",value:{value:""}}),t.noRedact=!0,t.selectShape(t.objColl[t.objColl.length-1].currIndex),t.notify("selection",{prop:"setCurrentDrawingShape",value:{value:"path"}}),t.drawingShape=h}t.notify("toolbar",{prop:"renderQAT",onPropertyChange:!1,value:{isPenEdit:null}});var u={shapeSettingsObj:{}};t.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:u}});var c=u.shapeSettingsObj,g={cancel:!1,action:"draw-end",previousShapeSettings:c},v={cancel:!1,action:"move",previousShapeSettings:c};t.notify("selection",{prop:"triggerShapeChange",onPropertyChange:!1,value:{shapeResizingArgs:g,shapeMovingArgs:v,type:"mouse-up"}}),t.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1})}}},d.prototype.findTextTarget=function(e){var i=this.parent;if(e){if(i.activeObj.shape!=="text")if(i.activeObj.shape==="path"){this.stopPathDrawing(e,null);return}else if(e.type==="dblclick"){i.notify("selection",{prop:"setPanDown",onPropertyChange:!1,value:{panDown:null}});var t=f({},i.activeObj,{},!0),r=f([],i.objColl,[],!0),o={bool:null};if(i.notify("selection",{prop:"findTargetObj",onPropertyChange:!1,value:{x:e.clientX,y:e.clientY,isCrop:!1,obj:o}}),i.objColl=r,!o.bool||i.activeObj.shape!=="text"){i.activeObj=f({},t,{},!0);return}}else return;var a,n;if(e.type==="dblclick"?(a=e.clientX,n=e.clientY):e.type==="touchstart"&&(a=e.touches[0].clientX,n=e.touches[0].clientY,i.notify("selection",{prop:"setTouchEndPoint",onPropertyChange:!1,value:{x:e.touches[0].clientX,y:e.touches[0].clientY}})),i.notify("toolbar",{prop:"setPreventZoomBtn",onPropertyChange:!1,value:{isPrevent:!0}}),i.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"text",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}),i.notify("toolbar",{prop:"setPreventZoomBtn",onPropertyChange:!1,value:{isPrevent:!1}}),i.notify("toolbar",{prop:"update-toolbar-items",onPropertyChange:!1}),!C(a)&&!C(n)){var s=i.lowerCanvas.getBoundingClientRect();a-=s.left,n-=s.top;var l="",p=this.getRotDegOfShape(i.activeObj);i.activeObj.textFlip===""?i.activeObj.textFlip===i.transform.currFlipState?l="":l=i.transform.currFlipState:i.activeObj.textFlip===i.transform.currFlipState?l="":i.transform.currFlipState===""?l=i.activeObj.textFlip:l=i.transform.currFlipState;var h=void 0;if(i.textArea.style.display==="none"){h=f({},i.activeObj,{},!0);for(var u=0;u<i.objColl.length;u++)JSON.stringify(i.activeObj)===JSON.stringify(i.objColl[u])&&i.objColl.splice(u,1);this.refreshActiveObj(),this.upperContext.clearRect(0,0,i.upperCanvas.width,i.upperCanvas.height),this.lowerContext.clearRect(0,0,i.upperCanvas.width,i.upperCanvas.height),i.notify("draw",{prop:"redrawImgWithObj",onPropertyChange:!1}),i.notify("draw",{prop:"redrawDownScale"}),i.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),i.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.upperContext}}),(i.currSelectionPoint&&i.currSelectionPoint.shape==="crop-circle"||i.isCircleCrop)&&i.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),i.activeObj=h,this.updateFontStyles();var c=f({},i.activeObj,{},!0),g=c.topLeftCircle.radius,v=c.activePoint,b=v.startX,m=v.startY,y=v.endX,P=v.endY,S=v.width,O=v.height,j={x:b+S/2,y:m+O/2},x=Math.cos(c.rotatedAngle),k=Math.sin(c.rotatedAngle),T={x:x*(b-j.x)-k*(m-j.y)+j.x,y:k*(b-j.x)+x*(m-j.y)+j.y},A={x:x*(y-j.x)-k*(m-j.y)+j.x,y:k*(y-j.x)+x*(m-j.y)+j.y},L={x:x*(b-j.x)-k*(P-j.y)+j.x,y:k*(b-j.x)+x*(P-j.y)+j.y},H={x:x*(y-j.x)-k*(P-j.y)+j.x,y:k*(y-j.x)+x*(P-j.y)+j.y},o={position:null,x:a,y:n,x1:T.x,y1:T.y,x2:A.x,y2:A.y,x3:L.x,y3:L.y,x4:H.x,y4:H.y};if(i.notify("draw",{prop:"checkPointPosition",onPropertyChange:!1,value:{obj:o}}),c.rotatedAngle!==0&&(o.position==="inside"||o.position==="on")||c.rotatedAngle===0&&a>=c.activePoint.startX-g*2&&a<=c.activePoint.endX+g*2&&n>=c.activePoint.startY-g*2&&n<=c.activePoint.endY+g*2){if(this.upperContext.clearRect(0,0,i.upperCanvas.width,i.upperCanvas.height),c.flipObjColl.length===4&&(c.flipObjColl=[],l="",c.shapeFlip=""),l===""&&c.flipObjColl.length>1&&(l=c.flipObjColl[c.flipObjColl.length-1]),c.flipObjColl.length<=1){var B=this.setTextBoxPos(c,p,l,a,n);a=B.x,n=B.y}else{var B=this.setTextBoxPoints(c,p,l,a,n);a=B.x,n=B.y}if(i.activeObj.rotatedAngle!==0){var D=this.getTextBoxPosition(i.activeObj);a=D.x,n=D.y,D=this.setFlipState(a,n,i.activeObj),a=D.x,n=D.y}this.renderTextArea(a,n,c)}else this.applyActObj()}}else if((i.textArea.style.display==="block"||i.textArea.style.display==="inline-block")&&this.selectedText()!==""&&e.type==="mousedown"){var h=i.textArea.value;i.textArea.value+="a",i.textArea.value=h}else i.textArea.style.display==="none"&&(i.textArea.style.display="block")}},d.prototype.getTextBoxPosition=function(e,i){var t={x:0,y:0},r=e.activePoint,o=r.startX,a=r.startY,n=r.endX,s=r.endY,l=r.width,p=r.height,h={x:o+l/2,y:a+p/2},u=Math.cos(e.rotatedAngle),c=Math.sin(e.rotatedAngle),g={x:u*(o-h.x)-c*(a-h.y)+h.x,y:c*(o-h.x)+u*(a-h.y)+h.y},v={x:u*(n-h.x)-c*(a-h.y)+h.x,y:c*(n-h.x)+u*(a-h.y)+h.y},b={x:u*(o-h.x)-c*(s-h.y)+h.x,y:c*(o-h.x)+u*(s-h.y)+h.y},m={x:u*(n-h.x)-c*(s-h.y)+h.x,y:c*(n-h.x)+u*(s-h.y)+h.y},y=this.getRotDegOfShape(e);return y===0||y===360?t={x:g.x,y:g.y}:y===90||y===-270?t={x:v.x,y:v.y}:y===180||y===-180?t={x:m.x,y:m.y}:(y===270||y===-90)&&(t={x:b.x,y:b.y}),i&&(i.x=t.x,i.y=t.y),t},d.prototype.setFlipState=function(e,i,t,r){var o=this.parent,a={panRegion:""},n=o.lowerCanvas,s=n.clientWidth,l=n.clientHeight,p={x:0,y:0};return o.notify("crop",{prop:"getCurrFlipState",onPropertyChange:!1,value:{panObj:a}}),a.panRegion!==""&&(a.panRegion==="horizontal"?(p.x=s-s/2,e=p.x-e+p.x):a.panRegion==="vertical"?(p.y=l-l/2,i=p.y-i+p.y):(p={x:s-s/2,y:l-l/2},e=p.x-e+p.x,i=p.y-i+p.y)),r&&(r.x=e,r.y=i),{x:e,y:i}},d.prototype.fileChanged=function(e){var i=e.target.files[0],t=i,r=t.name&&t.name.split(".").pop().toLowerCase();if(r&&["jpg","jpeg","png","svg","webp"].indexOf(r)===-1){this.refreshActiveObj();return}var o=window.URL,a=o.createObjectURL(e.target.files[0]);this.onLoadImgShape(null,null,null,null,a.toString(),!0),document.getElementById(this.parent.element.id+"_fileUpload").value=""},d.prototype.onLoadImgShape=function(e,i,t,r,o,a,n,s,l,p){var h=this,u=this.parent;typeof o=="string"?this.shapeImg.src=o:(u.inMemoryCanvas.width=o.width,u.inMemoryCanvas.height=o.height,u.inMemoryCanvas.getContext("2d").putImageData(o,0,0),this.shapeImg.src=u.inMemoryCanvas.toDataURL()),this.prevObjColl(),u.activeObj.shape="image",this.initShapeProps(),this.shapeImg.onload=function(){h.upperContext.drawImage(h.shapeImg,0,0,h.shapeImg.width,h.shapeImg.height),h.updateImgCanvas(a,e,i,t,r,n,s,l,p)}},d.prototype.updateImgCanvas=function(e,i,t,r,o,a,n,s,l){var p=this.parent;p.activeObj.imageElement=this.shapeImg,p.activeObj.imageCanvas=p.createElement("canvas");var h={width:0,height:0};if(p.notify("transform",{prop:"calcMaxDimension",onPropertyChange:!1,value:{width:this.shapeImg.width,height:this.shapeImg.height,obj:h,isImgShape:null}}),r&&o)if(n){var u={ratio:null};p.notify("selection",{prop:"findImageRatio",onPropertyChange:!1,value:{width:this.shapeImg.width,height:this.shapeImg.height,obj:u}}),h=this.resizeImage(r,u.ratio)}else h={width:r,height:o};if(this.updateObj(h,i,t),p.notify("draw",{prop:"downScaleImgCanvas",onPropertyChange:!1,value:{ctx:p.activeObj.imageCanvas.getContext("2d"),isImgAnnotation:!0,isHFlip:null,isVFlip:null}}),p.notify("transform",{prop:"calcMaxDimension",onPropertyChange:!1,value:{width:this.shapeImg.width,height:this.shapeImg.height,obj:h,isImgShape:!0}}),r&&o)if(n){var c={ratio:null};p.notify("selection",{prop:"findImageRatio",onPropertyChange:!1,value:{width:this.shapeImg.width,height:this.shapeImg.height,obj:c}}),h=this.resizeImage(r,c.ratio)}else h={width:r,height:o};s!=null&&(p.activeObj.opacity=s),this.updateObj(h,i,t),p.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}}),this.shapeImg=null,a&&(p.activeObj.rotatedAngle=a*(Math.PI/180),p.notify("selection",{prop:"updPtCollForShpRot",onPropertyChange:!1,value:{obj:p.activeObj}}));var g={shapeSettingsObj:{}};p.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:g}});var v=g.shapeSettingsObj,b={cancel:!1,action:"insert",previousShapeSettings:v,currentShapeSettings:v};p.trigger("shapeChanging",b),p.editCompleteArgs=b,e=e||l,this.drawShapeImageEvent(b,e),p.isPublicMethod&&!l?p.notify("undo-redo",{prop:"updateUndoRedo",onPropertyChange:!1}):p.isPublicMethod||p.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1}),p.isPublicMethod=!1},d.prototype.updateObj=function(e,i,t){var r=this.parent;r.activeObj.activePoint.width=e.width,r.activeObj.activePoint.height=e.height,r.activeObj.activePoint.startX=i||r.lowerCanvas.width/2-e.width/2,r.activeObj.activePoint.startY=t||r.lowerCanvas.height/2-e.height/2,r.activeObj.activePoint.endX=r.activeObj.activePoint.startX+e.width,r.activeObj.activePoint.endY=r.activeObj.activePoint.startY+e.height},d.prototype.resizeImage=function(e,i){var t=i.split(":"),r=parseInt(t[0],10),o=parseInt(t[1],10),a=Math.round(e*o/r);return{width:e,height:a}},d.prototype.setTextBoxPos=function(e,i,t,r,o){var a={x:r,y:o},n=e.activePoint,s=n.startX,l=n.startY,p=n.endX,h=n.endY;switch(t=t.toLowerCase(),i){case 0:t==="horizontal"?(a.x=p,a.y=l):t==="vertical"?(a.x=s,a.y=h):(a.x=s,a.y=l);break;case 90:t==="horizontal"?(a.x=s,a.y=l):t==="vertical"?(a.x=p,a.y=h):(a.x=p,a.y=l);break;case 180:t==="horizontal"?(a.x=s,a.y=h):t==="vertical"?(a.x=p,a.y=l):(a.x=p,a.y=h);break;case 270:t==="horizontal"?(a.x=p,a.y=h):t==="vertical"?(a.x=s,a.y=l):(a.x=s,a.y=h);break}return a},d.prototype.setTextBoxPoints=function(e,i,t,r,o){var a={x:r,y:o},n=e.activePoint,s=n.startX,l=n.startY,p=n.endX,h=n.endY;switch(t=t.toLowerCase(),i){case 0:e.flipObjColl[0]&&e.flipObjColl[0].toLowerCase()==="horizontal"?t==="horizontal"?(a.x=s,a.y=l):t==="vertical"&&(a.x=p,a.y=h):t==="horizontal"?(a.x=p,a.y=h):t==="vertical"&&(a.x=p,a.y=l);break;case 90:e.flipObjColl[0]&&e.flipObjColl[0].toLowerCase()==="horizontal"?t==="horizontal"?(a.x=p,a.y=h):t==="vertical"&&(a.x=s,a.y=h):t==="horizontal"?(a.x=s,a.y=h):t==="vertical"&&(a.x=s,a.y=l);break;case 180:e.flipObjColl[0]&&e.flipObjColl[0].toLowerCase()==="horizontal"?(t==="horizontal"||t==="vertical")&&(a.x=s,a.y=l):t==="horizontal"?(a.x=s,a.y=l):t==="vertical"&&(a.x=s,a.y=h);break;case 270:e.flipObjColl[0]&&e.flipObjColl[0].toLowerCase()==="horizontal"?t==="horizontal"?(a.x=s,a.y=l):t==="vertical"&&(a.x=p,a.y=l):t==="horizontal"?(a.x=p,a.y=l):t==="vertical"&&(a.x=p,a.y=h);break}return a},d.prototype.selectedText=function(){var e=this.parent,i=e.textArea.selectionStart,t=e.textArea.selectionEnd;return e.textArea.value.substring(i,t)},d.prototype.panObjColl=function(e,i,t){var r=this.parent;if(r.objColl.length>0){for(var o=0,a=r.objColl.length;o<a;o++){var n=r.objColl[o];if(t===""){if(n.activePoint.startX+=e,n.activePoint.endX+=e,n.rotationCirclePointColl&&(n.rotationCirclePointColl.x+=e),n.shape==="path")for(var s=0,l=n.pointColl.length;s<l;s++)n.pointColl[s].x+=e;if(n.activePoint.startY+=i,n.activePoint.endY+=i,n.rotationCirclePointColl&&(n.rotationCirclePointColl.y+=i),n.shape==="path")for(var s=0;s<n.pointColl.length;s++)n.pointColl[s].y+=i}if(n=this.updateWidthHeight(n),r.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:n.activePoint,obj:n}}),n.shape==="line"||n.shape==="arrow"){n.pointColl=this.getLinePoints(n.activePoint.startX,n.activePoint.startY,n.activePoint.endX,n.activePoint.endY);for(var p=0,h=n.pointColl.length;p<h;p++)n.pointColl[p].ratioX=(n.pointColl[p].x-r.img.destLeft)/r.img.destWidth,n.pointColl[p].ratioY=(n.pointColl[p].y-r.img.destTop)/r.img.destHeight}this.refreshActiveObj()}var u=this.lowerContext.filter;this.lowerContext.filter="none",this.iterateObjColl(),this.lowerContext.filter=u,this.refreshActiveObj(),r.notify("draw",{prop:"applyFrame",value:{ctx:this.lowerContext,frame:r.frameObj.type,preventImg:!0}})}},d.prototype.updateFontStyles=function(e){var i=this.parent;this.upperContext.strokeStyle=i.activeObj.strokeSettings.strokeColor,this.upperContext.fillStyle=i.activeObj.strokeSettings.strokeColor;var t="";i.activeObj.textSettings.bold&&(t="bold "),i.activeObj.textSettings.italic&&(t="italic "),i.activeObj.textSettings.bold&&i.activeObj.textSettings.italic&&(t="italic bold ");var r=e?parseFloat(i.textArea.style.fontSize):i.activeObj.textSettings.fontSize,o=i.textArea.style.display==="block"||i.textArea.style.display==="inline-block"?i.textArea.style.fontFamily:i.activeObj.textSettings.fontFamily;this.upperContext.font=t+r+"px "+o},d.prototype.applyFontStyle=function(e){var i=this.parent,t={shapeSettingsObj:{}};i.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:t}});var r=t.shapeSettingsObj;this.pushActItemIntoObj();var o=f([],i.objColl,[],!0);switch(i.objColl.pop(),i.textArea.style.display==="none"?this.updateFontRatio(i.activeObj):this.updateFontRatio(i.activeObj,!0),e){case"default":this.updateFontStyle(e,o,"normal","normal");break;case"bold":this.updateFontStyle(e,o,"bold","normal");break;case"italic":this.updateFontStyle(e,o,"normal","italic");break;case"bolditalic":this.updateFontStyle(e,o,"bold","italic");break}var a={action:"font-style",currentShapeSettings:f({},r,{},!0)};a.currentShapeSettings.fontStyle=[e],i.trigger("shapeChange",a),i.editCompleteArgs=a},d.prototype.updateFontStyle=function(e,i,t,r){var o=this.parent,a=o.textArea.style;if(a.display==="block"||a.display==="inline-block"){t==="bold"?a.fontWeight="bold":a.fontWeight="normal",r==="italic"?a.fontStyle="italic":a.fontStyle="normal";var n=a.fontWeight==="normal"&&a.fontStyle==="normal"?"default":a.fontWeight==="bold"&&a.fontStyle==="normal"?"bold":a.fontWeight==="normal"&&a.fontStyle==="italic"?"italic":"bolditalic",s=this.getTextAreaWidth(n);a.width=s+"px",this.updateObjColl(e,i)}else this.textSettings.bold=o.activeObj.textSettings.bold=t!=="normal",this.textSettings.italic=o.activeObj.textSettings.italic=r!=="normal",(o.activeObj.activePoint.width!==0||o.activeObj.activePoint.height!==0)&&this.redrawText(),o.notify("undo-redo",{prop:"updateUrObj",onPropertyChange:!1,value:{objColl:i}})},d.prototype.updateArrowRatio=function(e){var i=this.parent,t={arrowDimension:null};i.notify("draw",{prop:"getArrowDimension",onPropertyChange:!1,value:{obj:t}});var r;Math.abs(e.activePoint.width)>Math.abs(e.activePoint.height)?r=Math.abs(e.activePoint.width):r=Math.abs(e.activePoint.height);for(var o,a=["bar","arrow","arrowSolid","circle","square"],n=0,s=a;n<s.length;n++){o=s[n];var l=r/t.arrowDimension[o].width,p=r/t.arrowDimension[o].height;t.arrowDimension[o].ratioX=l,t.arrowDimension[o].ratioY=p}},d.prototype.updateArrowSize=function(e){var i={arrowDimension:null};this.parent.notify("draw",{prop:"getArrowDimension",onPropertyChange:!1,value:{obj:i}});var t;Math.abs(e.activePoint.width)>Math.abs(e.activePoint.height)?t=Math.abs(e.activePoint.width):t=Math.abs(e.activePoint.height);for(var r,o=["bar","arrow","arrowSolid","circle","square"],a=0,n=o;a<n.length;a++){r=n[a];var s=i.arrowDimension[r].ratioX,l=i.arrowDimension[r].ratioY;i.arrowDimension[r].width=t/s,i.arrowDimension[r].height=t/l}},d.prototype.updateFontRatio=function(e,i){var t=this.parent,r=this.getMaxText(i),o=this.upperContext.measureText(r).width+t.activeObj.textSettings.fontSize*.5,a=t.activeObj.textSettings.fontSize,n=this.getRotDegOfShape(e);if(C(i))n===0||Math.abs(n)===180?e.textSettings.fontRatio=o/e.textSettings.fontSize:e.textSettings.fontRatio=a/e.textSettings.fontSize;else if(i){var s={bool:!1};t.notify("selection",{prop:"getTransformedShape",onPropertyChange:!1,value:{obj:s}}),!s.bool||n===0||Math.abs(n)===180?e.textSettings.fontRatio=o/parseFloat(t.textArea.style.fontSize):e.textSettings.fontRatio=a/parseFloat(t.textArea.style.fontSize)}},d.prototype.updateFontSize=function(e){var i=this.getRotDegOfShape(e,!0);i===0||Math.abs(i)===180?e.textSettings.fontSize=e.activePoint.width/e.textSettings.fontRatio:e.textSettings.fontSize=e.activePoint.height/e.textSettings.fontRatio},d.prototype.updateObjColl=function(e,i){var t=this.parent,r=f({},t.cropObj,{},!0),o={currObj:{}};t.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:o}});var a=o.currObj;a.objColl=i,a.pointColl=f([],t.pointColl,[],!0),a.afterCropActions=f([],t.afterCropActions,[],!0);var n={selPointColl:null};t.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:n}}),a.selPointColl=f([],n.selPointColl,[],!0);var s=t.activeObj.textSettings.bold,l=t.activeObj.textSettings.italic;switch(e){case"default":t.activeObj.textSettings.bold=!1,t.activeObj.textSettings.italic=!1;break;case"bold":t.activeObj.textSettings.bold=!0,t.activeObj.textSettings.italic=!1;break;case"italic":t.activeObj.textSettings.bold=!1,t.activeObj.textSettings.italic=!0;break;case"bolditalic":t.activeObj.textSettings.bold=!0,t.activeObj.textSettings.italic=!0;break}t.objColl.push(t.activeObj),t.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"textAreaCustomization",previousObj:a,previousObjColl:a.objColl,previousPointColl:a.pointColl,previousSelPointColl:a.selPointColl,previousCropObj:r,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),t.objColl.pop(),t.activeObj.textSettings.bold=s,t.activeObj.textSettings.italic=l},d.prototype.pushActItemIntoObj=function(){var e=this.parent;if(e.textArea.style.display==="none")(e.activeObj.activePoint.width!==0||e.activeObj.activePoint.height!==0)&&e.objColl.push(e.activeObj);else{var i=f({},e.activeObj,{},!0);e.notify("selection",{prop:"setTextBoxStylesToActObj",onPropertyChange:!1}),e.objColl.push(e.activeObj),e.activeObj=i}},d.prototype.clearActObj=function(){var e=this.parent;e.textArea.style.display==="none"&&(this.refreshActiveObj(),this.applyActObj(),this.refreshActiveObj(),e.currObjType.isCustomCrop=!1)},d.prototype.refreshActiveObj=function(){var e=this.parent;e.activeObj={},e.activeObj.activePoint={startX:0,startY:0,endX:0,endY:0,width:0,height:0},e.activeObj.triangle=[],e.activeObj.triangleRatio=[],e.activeObj.order=null,e.activeObj.flipObjColl=[],e.activeObj.strokeSettings=this.strokeSettings,e.activeObj.textSettings=this.textSettings,e.activeObj.rotatedAngle=0,e.activeObj.opacity=1,e.activeObj.redactType=this.redactType,e.activeObj.redactBlur=e.tempRedactBlur,e.activeObj.redactPixelate=e.tempRedactPixel},d.prototype.applyActObj=function(e){var i=this.parent,t=!1;if(i.activeObj.shape!==void 0&&i.activeObj.shape==="text"&&i.activeObj.keyHistory==="")this.refreshActiveObj(),this.upperContext.clearRect(0,0,i.upperCanvas.width,i.upperCanvas.height);else{var r=void 0,o=!1;if(i.activeObj.shape!==void 0&&(r=i.activeObj.shape.split("-")),(r===void 0&&i.currObjType.isCustomCrop||r!==void 0&&r[0]==="crop")&&(o=!0),i.activeObj.shape&&!o&&i.activeObj.shape!=="shape"){for(var a=0;a<i.objColl.length;a++)if(JSON.stringify(i.activeObj)===JSON.stringify(i.objColl[a])){t=!0;break}if(!t){C(i.activeObj.currIndex)&&(i.activeObj.currIndex=this.getNewShapeId()),C(i.activeObj.order)&&(i.activeObj.order=this.getNewOrder()),this.updImgRatioForActObj();var n=i.activeObj.currIndex.split("_"),s=i.objColl.splice(0,parseInt(n[1],10)-1);s.push(f({},i.activeObj,{},!0));for(var a=0;a<i.objColl.length;a++)s.push(i.objColl[a]);i.objColl=s,s=[],this.refreshActiveObj(),this.lowerContext.clearRect(0,0,i.lowerCanvas.width,i.lowerCanvas.height),i.notify("draw",{prop:"redrawImgWithObj",onPropertyChange:!1}),i.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),i.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.upperContext}}),i.currObjType.shape="",this.refreshActiveObj(),i.isCircleCrop&&i.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),i.notify("toolbar",{prop:"destroy-qa-toolbar",onPropertyChange:!1}),C(e)&&(i.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}}),i.notify("draw",{prop:"setPrevActObj",onPropertyChange:!1,value:{prevActObj:null}}))}}}},d.prototype.getNewShapeId=function(){for(var e=this.parent,i=e.objColl.length+1,t=0;t<e.objColl.length;t++)e.objColl[t].currIndex==="shape_"+i&&(i++,t=-1);return"shape_"+i},d.prototype.getNewOrder=function(){var e=this.parent;this.updateShapeColl();for(var i=e.shapeColl.length+1,t=0;t<e.shapeColl.length;t++)e.shapeColl[t].order===i&&(i++,t=-1);return i},d.prototype.getHighestOrder=function(){var e=this.parent;this.updateShapeColl();for(var i=0,t=0;t<e.shapeColl.length;t++)e.shapeColl[t].order>i&&(i=e.shapeColl[t].order);return i},d.prototype.getLowestOrder=function(){var e=this.parent;this.updateShapeColl();for(var i=1,t=0;t<e.shapeColl.length;t++)e.shapeColl[t].order<i&&(i=e.shapeColl[t].order);return i},d.prototype.alignTextAreaIntoCanvas=function(){var e=this.parent,i=e.textArea.value;e.textArea.value="";for(var t=0,r=i.length;t<r;t++)e.textArea.value+=i[t],e.textArea.style.height="auto",e.textArea.style.height=e.textArea.scrollHeight+"px",this.setTextBoxWidth()},d.prototype.transformTextArea=function(){var e=this.parent;if(e.activeObj.shape==="text"){e.textArea.style.transformOrigin="0 0";var i=e.activeObj.rotatedAngle*(180/Math.PI),t="",r=this.getRotDegOfShape(e.activeObj);if(e.activeObj.flipObjColl.length>0)for(var o=0;o<e.activeObj.flipObjColl.length;o++)r!==0&&r%90===0&&r!==180?t+=e.activeObj.flipObjColl[o].toLowerCase()==="horizontal"?"scale(1, -1)":"scale(-1, 1)":t+=e.activeObj.flipObjColl[o].toLowerCase()==="horizontal"?"scale(-1, 1)":"scale(1, -1)",r+=i,(e.activeObj.flipObjColl[o].toLowerCase()==="horizontal"||e.activeObj.flipObjColl[o].toLowerCase()==="vertical")&&(e.textArea.style.transform="rotate("+r+"deg)"+t);else r+=i,e.textArea.style.transform="rotate("+r+"deg)"}},d.prototype.getTextAreaWidth=function(e){var i=this.parent,t=i.activeObj.textSettings.bold,r=i.activeObj.textSettings.italic;switch(e){case"default":i.activeObj.textSettings.bold=!1,i.activeObj.textSettings.italic=!1;break;case"bold":i.activeObj.textSettings.bold=!0,i.activeObj.textSettings.italic=!1;break;case"italic":i.activeObj.textSettings.bold=!1,i.activeObj.textSettings.italic=!0;break;case"bolditalic":i.activeObj.textSettings.bold=!0,i.activeObj.textSettings.italic=!0;break}var o=i.textArea.style.display!=="none";this.updateFontStyles(o);var a;return o?a=this.upperContext.measureText(i.textArea.value).width+i.activeObj.textSettings.fontSize*.5:a=this.upperContext.measureText(i.activeObj.keyHistory).width+i.activeObj.textSettings.fontSize*.5,i.activeObj.textSettings.bold=t,i.activeObj.textSettings.italic=r,a},d.prototype.getRedactObjDetails=function(e){var i=this.parent,t={};switch(t.id=e.currIndex,t.type=i.toPascalCase(e.redactType),t.startX=e.activePoint.startX,t.startY=e.activePoint.startY,t.width=e.activePoint.width,t.height=e.activePoint.height,e.redactType){case"blur":t.blurIntensity=e.redactBlur;break;case"pixelate":t.pixelSize=e.redactPixelate;break}return t},d.prototype.getObjDetails=function(e){var i=this.parent,t={};t.id=e.currIndex,t.type=i.toPascalCase(e.shape),t.startX=e.activePoint.startX,t.startY=e.activePoint.startY,t.index=e.order;var r={coll:null};switch(e.shape){case"rectangle":t.width=e.activePoint.width,t.height=e.activePoint.height,t.strokeColor=e.strokeSettings.strokeColor,t.fillColor=e.strokeSettings.fillColor,t.strokeWidth=e.strokeSettings.strokeWidth,t.degree=e.rotatedAngle*(180/Math.PI);break;case"ellipse":t.radius=e.activePoint.width/2,t.strokeColor=e.strokeSettings.strokeColor,t.fillColor=e.strokeSettings.fillColor,t.strokeWidth=e.strokeSettings.strokeWidth,t.radiusX=e.activePoint.width/2,t.radiusY=e.activePoint.height/2,t.degree=e.rotatedAngle*(180/Math.PI);break;case"line":case"arrow":if(t.length=e.activePoint.width,t.strokeColor=e.strokeSettings.strokeColor,t.strokeWidth=e.strokeSettings.strokeWidth,t.endX=e.activePoint.endX,t.endY=e.activePoint.endY,e.shape==="arrow"){var o={type:null};i.notify("selection",{prop:"getArrowType",onPropertyChange:!1,value:{type:e.start,obj:o}}),t.arrowHead=o.type,i.notify("selection",{prop:"getArrowType",onPropertyChange:!1,value:{type:e.end,obj:o}}),t.arrowTail=o.type}break;case"text":t.text=e.keyHistory,t.fontSize=e.textSettings.fontSize,t.fontFamily=e.textSettings.fontFamily,t.color=e.strokeSettings.strokeColor,t.strokeColor=e.strokeSettings.outlineColor,t.fillColor=e.strokeSettings.fillColor,t.strokeWidth=e.strokeSettings.outlineWidth,t.fontStyle=[],e.textSettings.bold&&t.fontStyle.push("bold"),e.textSettings.italic&&t.fontStyle.push("italic"),t.degree=e.rotatedAngle*(180/Math.PI),i.notify("selection",{prop:"updateTransColl",onPropertyChange:!1,value:{obj:r,object:e}}),t.transformCollection=r.coll;break;case"path":t.strokeColor=e.strokeSettings.strokeColor,t.strokeWidth=e.strokeSettings.strokeWidth,t.points=e.pointColl;break;case"image":t.imageData=e.imageCanvas.toDataURL(),t.degree=e.rotatedAngle*(180/Math.PI),t.width=e.activePoint.width,t.height=e.activePoint.height,t.opacity=e.opacity;break}return t},d.prototype.getFreehandDrawDetails=function(e){var i=this.parent,t={};return t.id=i.pointColl[e].id,t.type=se.FreehandDraw,t.points=f([],i.pointColl[e].points),t.strokeColor=i.pointColl[e].strokeColor,t.strokeWidth=i.pointColl[e].strokeWidth,t.index=i.pointColl[e].order,t},d.prototype.getShapeSetting=function(e,i){var t=this.parent,r;if(!t.disabled&&t.isImageLoaded)if(t.textArea.style.display!=="none"?t.okBtn(null,!0):this.applyActObj(!0),e.split("_")[0]==="shape"){for(var o,a=0,n=t.objColl.length;a<n;a++)if(t.objColl[a].currIndex===e){o=f({},t.objColl[a],{},!0);break}r=this.getObjDetails(o)}else e.split("_")[0]==="pen"&&(r=this.getFreehandDrawDetails(parseInt(e.split("_")[1],10)-1));i.shapeDetails=r},d.prototype.getShapeSettings=function(e){var i=this.parent,t=[];if(!i.disabled&&i.isImageLoaded){i.textArea.style.display!=="none"?i.okBtn(null,!0):this.applyActObj(!0);for(var r=0,o=i.objColl.length;r<o;r++){var a=this.getObjDetails(i.objColl[r]);t.push(a)}for(var r=0;r<i.freehandCounter;r++){var a=this.getFreehandDrawDetails(r);t.push(a)}}e.shapeDetailsColl=t},d.prototype.getRedactSettings=function(e){var i=this.parent,t=[];if(!i.disabled&&i.isImageLoaded){i.textArea.style.display!=="none"?i.okBtn(null,!0):this.applyActObj(!0);for(var r=0,o=i.objColl.length;r<o;r++){var a=this.getRedactObjDetails(i.objColl[r]);t.push(a)}}e.shapeDetailsColl=t},d.prototype.isPointsInRange=function(e,i,t){var r=!1,o=this.parent;!C(e)&&!C(i)&&e>=o.img.destLeft&&i>=o.img.destTop&&e<=o.img.destLeft+o.img.destWidth&&i<=o.img.destTop+o.img.destHeight&&(r=!0),t.inRange=r},d.prototype.alignRotateFlipColl=function(e,i,t){return e=this.popForDefaultTransformedState(e),e=this.popForDefaultFlipState(e),e=this.popForDefaultRotateState(e),e.length===0&&i&&(this.parent.transform.degree=0,this.parent.transform.currFlipState=""),t.collection=e,e},d.prototype.popForDefaultTransformedState=function(e){for(var i=0,t=0,r=0,o=0,a=0;a<e.length;a++)e[a]===90||e[a]==="rotateRight"?(i++,t=0,r=0,o=0,i===4&&(e.pop(),e.pop(),e.pop(),e.pop())):e[a]===-90||e[a]==="rotateLeft"?(t++,i=0,r=0,o=0,t===4&&(e.pop(),e.pop(),e.pop(),e.pop())):e[a]==="horizontal"||e[a]==="Horizontal"||e[a]==="horizontalflip"?(r++,t=0,i=0,o=0,r===2&&(e.pop(),e.pop())):(e[a]==="vertical"||e[a]==="Vertical"||e[a]==="verticalflip")&&(o++,r=0,t=0,i=0,o===2&&(e.pop(),e.pop()));return e},d.prototype.popForDefaultFlipState=function(e){for(var i=0,t=e.length-3;i<t;i++){var r=e[i]==="horizontal"||e[i]==="Horizontal"||e[i]==="horizontalFlip",o=e[i]==="vertical"||e[i]==="Vertical"||e[i]==="verticalFlip",a=e[i+1]==="horizontal"||e[i+1]==="Horizontal"||e[i+1]==="horizontalFlip",n=e[i+1]==="vertical"||e[i+1]==="Vertical"||e[i+1]==="verticalFlip",s=e[i+2]==="horizontal"||e[i+2]==="Horizontal"||e[i+2]==="horizontalFlip",l=e[i+2]==="vertical"||e[i+2]==="Vertical"||e[i+2]==="verticalFlip",p=e[i+3]==="horizontal"||e[i+3]==="Horizontal"||e[i+3]==="horizontalFlip";(r&&n&&s&&l||o&&a&&l&&p)&&(e.splice(i,4),i-=4)}return e},d.prototype.popForDefaultRotateState=function(e){for(var i=0;i<e.length-1;i++){var t=e[i],r=e[i+1];((t===90||t==="rotateRight")&&(r===-90||r==="rotateLeft")||(t===-90||t==="rotateLeft")&&(r===90||r==="rotateRight"))&&(e.splice(i,2),i-=2)}return e},d.prototype.selectShape=function(e,i){var t=this.parent,r=!1;if(!t.disabled&&t.isImageLoaded){if(this.applyActObj(),e.split("_")[0]==="shape"){for(var o,a=0,n=t.objColl.length;a<n;a++)if(t.objColl[a].currIndex===e){o=f({},t.objColl[a],{},!0);break}if(C(o))r=!1;else{r=!0,t.activeObj=o;var s={canvasFilter:null};t.notify("toolbar",{prop:"getCanvasFilter",onPropertyChange:!1,value:{obj:s}}),this.lowerContext.filter=s.canvasFilter,t.notify("selection",{prop:"redrawShape",onPropertyChange:!1,value:{obj:t.activeObj}}),t.activeObj.shape==="text"?t.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"text",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}):t.activeObj.shape==="pen"?t.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"pen",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}):t.activeObj.shape==="redact"?t.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"redact",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}):t.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"shapes",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}),t.notify("toolbar",{prop:"update-toolbar-items",onPropertyChange:!1}),t.notify("toolbar",{prop:"renderQAT",onPropertyChange:!1,value:{isPenEdit:null}})}}else if(e.split("_")[0]==="pen"){var s={bool:!1};t.notify("selection",{prop:"getFreehandDrawEditing",onPropertyChange:!1,value:{obj:s}}),s.bool&&t.okBtn(null,!0);var l={isIndex:!1};t.notify("freehand-draw",{prop:"isFHDIdx",value:{index:parseInt(e.split("_")[1],10)-1,obj:l}}),l.isIndex?(r=!0,t.notify("freehand-draw",{prop:"selectFhd",value:{id:e}}),t.notify("toolbar",{prop:"renderQAT",onPropertyChange:!1,value:{isPenEdit:!0}}),t.notify("toolbar",{prop:"update-toolbar-items",onPropertyChange:!1})):r=!1}}i.isSelected=r},d.prototype.deleteShape=function(e){var i=this.parent;if(!i.disabled&&i.isImageLoaded){if(i.activeObj.currIndex&&i.activeObj.currIndex===e)i.notify("selection",{prop:"deleteItem",onPropertyChange:!1});else if(this.applyActObj(),e.split("_")[0]==="shape"){for(var t=0,r=i.objColl.length;t<r;t++)if(i.objColl[t].currIndex===e){i.objColl.splice(t,1);break}}else e.split("_")[0]==="pen"&&i.notify("freehand-draw",{prop:"handle-freehand-draw",value:{id:e}});var o={canvasFilter:null};i.notify("toolbar",{prop:"getCanvasFilter",onPropertyChange:!1,value:{obj:o}}),this.lowerContext.filter=o.canvasFilter,this.lowerContext.clearRect(0,0,i.lowerCanvas.width,i.lowerCanvas.height),i.notify("draw",{prop:"redrawImgWithObj",onPropertyChange:!1}),i.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1})}},d.prototype.getMaxText=function(e,i,t){if(C(i)&&(i=e?this.parent.textArea.value:this.parent.activeObj.keyHistory,!i))return i;for(var r,o=i.split(`
`),a=o[0].length,n=o[0],s=1;s<o.length;s++)r=o[s].length,r>a&&(n=o[s],a=r);return t&&(t.maxText=n),n},d.prototype.getLinePoints=function(e,i,t,r){var o=[],a,n;if(e===t){i<r?(a=[e,i],n=[t,r]):(n=[e,i],a=[t,r]);for(var s=this.getSlope(a,n,!0),l=this.getIntercept(a,s),p=a[1];p<=n[1];p++){var h=s*p+l;o.push({x:h,y:p})}}else{e<t?(a=[e,i],n=[t,r]):(n=[e,i],a=[t,r]);for(var s=this.getSlope(a,n,!1),l=this.getIntercept(a,s),h=a[0];h<=n[0];h++){var p=s*h+l;o.push({x:h,y:p})}}if(Math.floor(e)===Math.floor(t)||o.length<10&&(r-i>10||i-r>10)){o=[];for(var u=Math.min(i,r),c=0;c<Math.abs(Math.floor(r)-Math.floor(i));c++)o.push({x:e,y:u+c});if(o.length>1){var g=void 0;C(o[o.length-2])?g={x:0,y:0}:g=o[o.length-2];var v=o[o.length-1].x-g.x,b=o[o.length-1].y-g.y;o.push({x:o[o.length-1].x+v/2,y:o[o.length-1].y+b/2})}}else if(Math.floor(i)===Math.floor(r)||o.length<10&&(t-e>10||e-t>10)){o=[];for(var m=Math.min(e,t),y=0;y<Math.abs(Math.floor(t)-Math.floor(e));y++)o.push({x:m+y,y:i});if(o.length>1){var g=void 0;C(o[o.length-2])?g={x:0,y:0}:g=o[o.length-2];var v=o[o.length-1].x-g.x,b=o[o.length-1].y-g.y;o.push({x:o[o.length-1].x+v/2,y:o[o.length-1].y+b/2})}}return o},d.prototype.getSlope=function(e,i,t){var r;if(t){if(e[1]===i[1])return null;r=(i[0]-e[0])/(i[1]-e[1])}else{if(e[0]===i[0])return null;r=(i[1]-e[1])/(i[0]-e[0])}return r},d.prototype.getIntercept=function(e,i){return i===null?e[0]:e[1]-i*e[0]},d.prototype.setPointCollForShapeRotation=function(e){var i=this.parent,t=e.activePoint,r=t.startX,o=t.startY,a=t.endX,n=t.endY,s=t.width,l=t.height,p={x:r+s/2,y:o+l/2},h=Math.cos(e.rotatedAngle),u=Math.sin(e.rotatedAngle),c={x:h*(r-p.x)-u*(o-p.y)+p.x,y:u*(r-p.x)+h*(o-p.y)+p.y},g={x:h*(a-p.x)-u*(o-p.y)+p.x,y:u*(a-p.x)+h*(o-p.y)+p.y},v={x:h*(r-p.x)-u*(n-p.y)+p.x,y:u*(r-p.x)+h*(n-p.y)+p.y},b={x:h*(a-p.x)-u*(n-p.y)+p.x,y:u*(a-p.x)+h*(n-p.y)+p.y};e.horTopLinePointColl=this.getLinePoints(c.x,c.y,g.x,g.y),e.horTopLinePointColl=this.getLinePoints(c.x,c.y,g.x,g.y),e.horBottomLinePointColl=this.getLinePoints(v.x,v.y,b.x,b.y),e.verLeftLinePointColl=this.getLinePoints(c.x,c.y,v.x,v.y),e.verRightLinePointColl=this.getLinePoints(g.x,g.y,b.x,b.y),e.verLeftLinePointColl.reverse(),e.verRightLinePointColl.reverse();for(var m=0;m<e.horTopLinePointColl.length;m++)e.horTopLinePointColl[m].ratioX=(e.horTopLinePointColl[m].x-this.parent.img.destLeft)/this.parent.img.destWidth,e.horTopLinePointColl[m].ratioY=(e.horTopLinePointColl[m].y-this.parent.img.destTop)/this.parent.img.destHeight;for(var m=0;m<e.horBottomLinePointColl.length;m++)e.horBottomLinePointColl[m].ratioX=(e.horBottomLinePointColl[m].x-this.parent.img.destLeft)/this.parent.img.destWidth,e.horBottomLinePointColl[m].ratioY=(e.horBottomLinePointColl[m].y-this.parent.img.destTop)/this.parent.img.destHeight;for(var m=0;m<e.verLeftLinePointColl.length;m++)e.verLeftLinePointColl[m].ratioX=(e.verLeftLinePointColl[m].x-this.parent.img.destLeft)/this.parent.img.destWidth,e.verLeftLinePointColl[m].ratioY=(e.verLeftLinePointColl[m].y-this.parent.img.destTop)/this.parent.img.destHeight;for(var m=0;m<e.verRightLinePointColl.length;m++)e.verRightLinePointColl[m].ratioX=(e.verRightLinePointColl[m].x-this.parent.img.destLeft)/this.parent.img.destWidth,e.verRightLinePointColl[m].ratioY=(e.verRightLinePointColl[m].y-this.parent.img.destTop)/this.parent.img.destHeight;if(i.upperCanvas.style.cursor!=="move"){var y={rotationCirclePoint:null};i.notify("selection",{prop:"getTransRotationPoint",value:{obj:e,object:y}});var P=y.rotationCirclePoint;P&&(e.rotationCirclePointColl={x:h*(P.x-p.x)-u*(P.y-p.y)+p.x,y:u*(P.x-p.x)+h*(P.y-p.y)+p.y},e.rotationCirclePointColl.ratioX=(e.rotationCirclePointColl.x-i.img.destLeft)/i.img.destWidth,e.rotationCirclePointColl.ratioY=(e.rotationCirclePointColl.y-i.img.destTop)/i.img.destHeight)}},d.prototype.getSquarePointForRotatedShape=function(e,i){var t={startX:0,startY:0,endX:0,endY:0,width:0,height:0},r=e.activePoint,o=r.startX,a=r.startY,n=r.endX,s=r.endY,l=r.width,p=r.height,h={x:o+l/2,y:a+p/2},u=Math.cos(e.rotatedAngle),c=Math.sin(e.rotatedAngle),g={x:u*(o-h.x)-c*(a-h.y)+h.x,y:c*(o-h.x)+u*(a-h.y)+h.y},v={x:u*(n-h.x)-c*(a-h.y)+h.x,y:c*(n-h.x)+u*(a-h.y)+h.y},b={x:u*(o-h.x)-c*(s-h.y)+h.x,y:c*(o-h.x)+u*(s-h.y)+h.y},m={x:u*(n-h.x)-c*(s-h.y)+h.x,y:c*(n-h.x)+u*(s-h.y)+h.y};return t.startX=g.x,t.startY=g.y,t.endX=g.x,t.endY=g.y,t.startX>v.x&&(t.startX=v.x),t.startX>b.x&&(t.startX=b.x),t.startX>m.x&&(t.startX=m.x),t.startY>v.y&&(t.startY=v.y),t.startY>b.y&&(t.startY=b.y),t.startY>m.y&&(t.startY=m.y),t.endX<v.x&&(t.endX=v.x),t.endX<b.x&&(t.endX=b.x),t.endX<m.x&&(t.endX=m.x),t.endY<v.y&&(t.endY=v.y),t.endY<b.y&&(t.endY=b.y),t.endY<m.y&&(t.endY=m.y),t.width=t.endX-t.startX,t.height=t.endY-t.startY,i&&(i.activePoint=t),t},d.prototype.updateZOrder=function(e,i){var t=this.parent;i=i.toLowerCase();var r=e;if(!C(r.order)){var o,a,n=this.getHighestOrder();if(this.updateShapeColl(),t.shapeColl.length!==0){for(var s,l=0;l<t.shapeColl.length;l++)s=t.shapeColl[l],r.id&&r.id.indexOf("pen")>-1?s.id&&s.id===r.id&&t.shapeColl.splice(l,1):s.shape&&s.shape.indexOf("crop-")>-1&&t.shapeColl.splice(l,1);switch(i){case"sendtoback":a=r.order,o=r.order,r.order=1;break;case"sendbackward":r.order-=1,o=r.order;break;case"bringtofront":a=r.order,o=n,r.order=o;break;case"bringforward":r.order+=1,o=r.order;break}this.reArrangeObjColl(o,i,a),r.id&&r.id.indexOf("pen")>-1&&this.reUpdateShapeColl(r)}}},d.prototype.reArrangeObjColl=function(e,i,t){var r=this.parent,o;switch(i){case"sendtoback":for(var a=0,n=r.shapeColl.length;a<n;a++)o=r.shapeColl[a],o.order<t&&o.order<=e&&(o.order+=1,this.reUpdateShapeColl(o));break;case"sendbackward":for(var a=0,n=r.shapeColl.length;a<n;a++)if(o=r.shapeColl[a],o.order===e){o.order+=1,this.reUpdateShapeColl(o);break}break;case"bringtofront":for(var a=0,n=r.shapeColl.length;a<n;a++)o=r.shapeColl[a],o.order>t&&o.order<=e&&(o.order-=1,this.reUpdateShapeColl(o));break;case"bringforward":for(var a=0,n=r.shapeColl.length;a<n;a++)if(o=r.shapeColl[a],o.order===e){o.order-=1,this.reUpdateShapeColl(o);break}break}},d.prototype.reorderRedact=function(e){var i=e.filter(function(r){return r.shape!=="redact"}),t=e.filter(function(r){return r.shape==="redact"});return t.concat(i)},d.prototype.updateShapeColl=function(){var e=this.parent,i=!1,t=1,r=f([],e.objColl,[],!0);r=this.reorderRedact(r);var o=f([],e.pointColl,[],!0);if(e.shapeColl.length>0&&e.shapeColl.length===e.objColl.length+e.pointColl.length){for(var a=0;a<e.shapeColl.length;a++)if(e.shapeColl[a].order===t)i=!0,t++;else{i=!1;break}if(i){for(var a=0;a<e.shapeColl.length;a++)if(e.shapeColl[a].currIndex&&e.shapeColl[a].currIndex.indexOf("shape")>-1){for(var n=0;n<r.length;n++)if(e.shapeColl[a].currIndex===r[n].currIndex){e.shapeColl[a]=f({},r[n],{},!0),r.splice(n,1);break}}else if(e.shapeColl[a].id&&e.shapeColl[a].id.indexOf("pen")>-1){for(var n=0;n<o.length;n++)if(e.shapeColl[a].id===o[n].id){e.shapeColl[a]=f([],o[n],[],!0),o.splice(n,1);break}}return}}r=f([],e.objColl,[],!0),o=f([],e.pointColl,[],!0),e.shapeColl=[];for(var s=1,l,p=!1;r.length!==0||o.length!==0;){l=p=!1;for(var a=0;a<r.length;a++)if(r[a].order===s||!r[a].order&&r[a].shape&&r[a].shape.indexOf("crop-")>-1){e.shapeColl.push(f({},r[a],{},!0)),r[a].shape&&r[a].shape.indexOf("crop-")>-1&&(p=!0),r.splice(a,1),l=!0;break}if(!l){for(var a=0;a<o.length;a++)if(o[a].order===s){e.shapeColl.push(f([],o[a],[],!0)),o.splice(a,1),l=!0;break}}p||s++}},d.prototype.reUpdateShapeColl=function(e){var i=this.parent;if(e.id&&e.id.indexOf("pen")>-1){if(i.freehandCounter>0)for(var t=0;t<i.freehandCounter;t++)i.pointColl[t].id===e.id&&(i.pointColl[t].order=e.order)}else if(e.currIndex&&e.currIndex.indexOf("shape")>-1)for(var t=0;t<i.objColl.length;t++)i.objColl[t].currIndex===e.currIndex&&(i.objColl[t].order=e.order)},d.prototype.drawAnnotations=function(e,i,t,r,o,a,n){var s=this.parent,l=f({},s.activeObj,{},!0),p=f([],s.objColl,[],!0),h=f([],s.pointColl,[],!0),u={selPointColl:null};s.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:u}});var c={selPointColl:null};s.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:c}}),this.updateShapeColl();var g=f([],s.shapeColl,[],!0);g=this.reorderRedact(g);var v=!1;this.preventFrameAnnotation||(this.preventFrameAnnotation=v=!0);for(var b=0;b<g.length;b++){var m=g[b].id;if(g[b].order||!g[b].order&&g[b].shape&&g[b].shape.indexOf("crop-")>-1||!g[b].order&&g[b].shape==="path"&&s.drawingShape==="path"){if(g[b].currIndex&&g[b].currIndex.indexOf("shape")>-1){if(s.objColl=[],s.objColl.push(f({},g[b],{},!0)),i==="iterate"){var y=this.lowerContext.filter;this.lowerContext.filter="none",this.iterateObjColl(),this.lowerContext.filter=y}else if(i==="zoom"||i==="pan"){for(var P=-1,S=0;S<p.length;S++)if(JSON.stringify(p[S])===JSON.stringify(s.objColl[0])){P=S;break}i==="zoom"?this.zoomObjColl(r):this.panObjColl(o,a,n),P>-1&&(p[P]=f({},s.objColl[0],{},!0))}}else if(g[b].id&&g[b].id.indexOf("pen")>-1){if(s.pointColl=[],s.freehandCounter=0,s.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:[]}}}),s.pointColl.push(f({},g[b],{},!0)),s.notify("freehand-draw",{prop:"pushSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:c.selPointColl[b]}}}),s.freehandCounter=s.pointColl.length,t==="iterate")s.notify("freehand-draw",{prop:"freehandRedraw",onPropertyChange:!1,value:{context:e,points:null}});else if(t==="zoom"||t==="pan"){t==="zoom"?s.notify("freehand-draw",{prop:"zoomFHDColl",onPropertyChange:!1,value:{isPreventApply:r}}):s.notify("freehand-draw",{prop:"panFHDColl",onPropertyChange:!1,value:{xDiff:o,yDiff:a,panRegion:n}});for(var O=0;O<h.length;O++)if(h[O].id===s.pointColl[0].id){h[O]=f({},s.pointColl[0],{},!0);break}for(var j=0,x=u.selPointColl.length;j<x;j++)if(u.selPointColl[j].id===c.selPointColl[j].id){u.selPointColl[j]=f({},c.selPointColl[j],{},!0);break}}}}else(!g[b].shape&&!m||!g[b].currIndex&&!m)&&g.splice(b,1)}t&&t==="zoom"&&(s.pointColl=[],s.freehandCounter=0,s.notify("freehand-draw",{prop:"zoomFHDColl",onPropertyChange:!1,value:{isPreventApply:r}})),s.objColl=p,s.pointColl=h,s.freehandCounter=s.pointColl.length,s.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:u.selPointColl}}}),v&&this.preventFrameAnnotation&&(s.notify("draw",{prop:"applyFrame",value:{ctx:this.lowerContext,frame:s.frameObj.type,preventImg:!0}}),this.preventFrameAnnotation=!1),s.activeObj=l},d}(),ci=function(){function d(e){this.isReverseFlip=!1,this.disablePan=!1,this.isReverseRotate=!1,this.flipColl=[],this.prevZoomValue=1,this.cropDimension={width:0,height:0},this.isPreventSelect=!1,this.preventDownScale=!1,this.resizedImgAngle=null,this.parent=e,this.addEventListener()}return d.prototype.destroy=function(){this.parent.isDestroyed||this.removeEventListener()},d.prototype.addEventListener=function(){this.parent.on("transform",this.transform,this),this.parent.on("destroyed",this.destroy,this)},d.prototype.removeEventListener=function(){this.parent.off("transform",this.transform),this.parent.off("destroyed",this.destroy)},d.prototype.transform=function(e){switch(this.initTransformPvtVar(),e.prop){case"flipImage":this.flipImage(e.value.direction);break;case"setDestPointsForFlipState":this.setDestPointsForFlipState();break;case"zoomAction":this.zoomAction(e.value.zoomFactor,e.value.zoomPoint,e.value.isResize);break;case"disableZoomOutBtn":this.disableZoomOutBtn(e.value.isZoomOut);break;case"rotatedFlip":this.rotatedFlip();break;case"drawPannedImage":this.drawPannedImage(e.value.xDiff,e.value.yDiff);break;case"drawPannImage":this.drawPannImage(e.value.point);break;case"performTransformation":this.performTransformation(e.value.text);break;case"updateTransform":this.updateTransform(e.value.text);break;case"rotatePan":this.rotatePan(e.value.isCropSelection,e.value.isDefaultZoom);break;case"resetZoom":this.resetZoom();break;case"pan":this.pan(e.value.value,e.value.x,e.value.y);break;case"zoom":this.zoom(e.value.zoomFactor,e.value.zoomPoint);break;case"setCurrPanRegion":this.setCurrPanRegion(e.value.region,e.value.type,e.value.obj);break;case"rotate":this.rotate(e.value.degree,e.value.obj);break;case"flip":this.flip(e.value.direction);break;case"update":this.update();break;case"calcMaxDimension":this.calcMaxDimension(e.value.width,e.value.height,e.value.obj,e.value.isImgShape);break;case"getPanMove":e.value.obj.panMove=this.panMove;break;case"setPanMove":this.panMove=e.value.point;break;case"getTempPanMove":e.value.obj.tempPanMove=this.tempPanMove;break;case"setTempPanMove":this.tempPanMove=e.value.point;break;case"setReverseFlip":this.isReverseFlip=e.value.isReverseFlip;break;case"setDisablePan":this.disablePan=e.value.bool;break;case"setCurrDestinationPoint":this.currDestPoint=e.value.point,this.currDestPoint.startX-=this.parent.cropObj.totalPannedPoint.x,this.currDestPoint.startY-=this.parent.cropObj.totalPannedPoint.y;break;case"setReverseRotate":this.isReverseRotate=e.value.bool;break;case"getFlipColl":e.value.obj.flipColl=this.flipColl;break;case"setFlipColl":this.flipColl=e.value.flipColl;break;case"getPreviousZoomValue":e.value.obj.previousZoomValue=this.prevZoomValue;break;case"setPreviousZoomValue":this.prevZoomValue=e.value.previousZoomValue;break;case"getCropDimension":e.value.obj.cropDimension=this.cropDimension;break;case"setCropDimension":this.cropDimension.width=e.value.width,this.cropDimension.height=e.value.height;break;case"getPreventSelect":e.value.obj.bool=this.isPreventSelect;break;case"setPreventSelect":this.isPreventSelect=e.value.bool;break;case"resizeImage":this.resizeImage(e.value.width,e.value.height);break;case"resizeCrop":this.resizeCrop(e.value.width,e.value.height);break;case"updateResize":this.updateResize();break;case"resize":this.resize(e.value.width,e.value.height,e.value.isAspectRatio);break;case"straightenImage":this.straightenImage(e.value.degree);break;case"reset":this.reset();break;case"cropZoom":e.value.obj.maxDimension=this.cropZoom(e.value.value,e.value.selectionObj);break;case"setResizedImgAngle":this.resizedImgAngle=e.value.angle;break}},d.prototype.getModuleName=function(){return"transform"},d.prototype.initTransformPvtVar=function(){this.parent.lowerCanvas&&(this.lowerContext=this.parent.lowerCanvas.getContext("2d")),this.parent.upperCanvas&&(this.upperContext=this.parent.upperCanvas.getContext("2d"))},d.prototype.reset=function(){this.zoomBtnHold=null,this.tempPanMove=null,this.panMove=null,this.disablePan=!1,this.currDestPoint=null,this.isReverseRotate=!1,this.flipColl=[],this.resizedImgAngle=null,this.transCurrObj=null,this.prevZoomValue=1,this.isPreventSelect=this.preventDownScale=!1},d.prototype.rotateImage=function(e){var i=this.parent,t={cancel:!1,previousDegree:i.transform.degree,currentDegree:Math.abs(i.transform.degree+e)===360?0:i.transform.degree+e};this.isPreventSelect||(i.trigger("rotating",t),i.editCompleteArgs=t),this.rotateEvent(t,e)},d.prototype.rotateEvent=function(e,i){var t=this.parent;if(e.cancel)t.notify("draw",{prop:"setCurrentObj",onPropertyChange:!1,value:{obj:t.prevEventObjPoint}}),t.activeObj=t.prevEventSelectionPoint,t.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:t.activeObj}});else{var r=void 0;if(C(this.transCurrObj)){var o={currObj:{}};t.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:o}}),r=o.currObj,r.objColl=f([],t.objColl,null,!0),r.pointColl=f({},t.pointColl,null,!0),r.afterCropActions=f([],t.afterCropActions,[],!0);var a={selPointColl:null};t.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:a}}),r.selPointColl=f([],a.selPointColl,[],!0)}t.afterCropActions.push(i===90?"rotateRight":"rotateLeft");var n=[],s=void 0;t.activeObj.activePoint&&t.activeObj.shape&&(t.activeObj.shape!==void 0&&(n=t.activeObj.shape.split("-")),(t.currObjType.isCustomCrop||n[0]==="crop")&&(s=t.currObjType.isCustomCrop?"custom":n[1],t.notify("shape",{prop:"updImgRatioForActObj",onPropertyChange:!1}),t.objColl.push(t.activeObj),t.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}))),t.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:!0}}),this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),this.drawRotatedImage(i),t.notify("draw",{prop:"setImageEdited",onPropertyChange:!1}),t.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),t.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.upperContext}}),t.isCircleCrop&&t.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),s&&(this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),t.activeObj=f({},t.objColl[t.objColl.length-1],{},!0),t.objColl.pop(),t.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:t.activeObj}})),t.isUndoRedo=!1;var l={collection:t.rotateFlipColl};t.notify("shape",{prop:"alignRotateFlipColl",onPropertyChange:!1,value:{collection:t.rotateFlipColl,isRotateFlipCollection:!0,obj:l}}),t.rotateFlipColl=l.collection,t.cropObj.activeObj.shape&&!this.isPreventSelect&&(t.notify("draw",{prop:"setIsCropSelect",value:{bool:!0}}),this.isPreventSelect=!0,t.notify("draw",{prop:"select",onPropertyChange:!1,value:{type:"custom",startX:null,startY:null,width:null,height:null}}),this.isPreventSelect=!1,t.setProperties({zoomSettings:{zoomFactor:1}},!0),this.prevZoomValue=t.zoomSettings.zoomFactor)}},d.prototype.drawRotatedImage=function(e){var i=this.parent;e===0?i.transform.degree=0:i.transform.degree+=e,Math.abs(i.transform.degree)===360&&(i.transform.degree=0),i.notify("draw",{prop:"setDestPoints",onPropertyChange:!1});var t=f([],i.objColl,[],!0),r=f({},i.activeObj,{},!0);if(i.objColl=[],i.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.isReverseRotate||i.notify("draw",{prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"initial",isPreventDestination:null,isRotatePan:null}}),this.rotateDegree(e),this.isReverseRotate||(i.notify("draw",{prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"reverse",isPreventDestination:null,isRotatePan:null}}),i.rotateFlipColl.push(e)),i.objColl=f([],t,[],!0),i.activeObj=f({},r,{},!0),i.isCircleCrop&&i.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),i.notify("shape",{prop:"redrawObj",onPropertyChange:!1,value:{degree:e}}),i.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),e>0)i.notify("freehand-draw",{prop:"rotateFhdColl",onPropertyChange:!1});else for(var o=0;o<3;o++)i.notify("freehand-draw",{prop:"rotateFhdColl",onPropertyChange:!1});i.notify("freehand-draw",{prop:"freehandRedraw",onPropertyChange:!1,value:{context:this.lowerContext,points:null}}),this.updateCurrSelectionPoint(e)},d.prototype.rotateDegree=function(e){var i=this.parent;this.lowerContext.save(),this.lowerContext.clearRect(0,0,i.lowerCanvas.width,i.lowerCanvas.height),this.lowerContext.translate(i.lowerCanvas.width/2,i.lowerCanvas.height/2),this.lowerContext.rotate(Math.PI/180*e),this.lowerContext.translate(-i.lowerCanvas.width/2,-i.lowerCanvas.height/2);var t=this.lowerContext.filter;i.notify("draw",{prop:"drawImage",onPropertyChange:!1}),this.lowerContext.filter=t,this.lowerContext.translate(i.lowerCanvas.width/2,i.lowerCanvas.height/2),this.lowerContext.rotate(Math.PI/180*-e),this.lowerContext.translate(-i.lowerCanvas.width/2,-i.lowerCanvas.height/2),this.lowerContext.restore()},d.prototype.updateCurrSelectionPoint=function(e){var i=this.parent;if(i.currSelectionPoint&&this.currDestPoint){var t=f({},i.activeObj,{},!0),r=f([],i.objColl,[],!0),o={startX:i.img.srcLeft,startY:i.img.srcTop,width:i.img.srcWidth,height:i.img.srcHeight},a={startX:i.img.destLeft,startY:i.img.destTop,width:i.img.destWidth,height:i.img.destHeight};i.objColl=[],i.objColl.push(f({},i.currSelectionPoint,{},!0)),i.img={srcLeft:0,srcTop:0,srcWidth:i.baseImgCanvas.width,srcHeight:i.baseImgCanvas.height,destLeft:this.currDestPoint.startX,destTop:this.currDestPoint.startY,destWidth:this.currDestPoint.width,destHeight:this.currDestPoint.height},typeof e=="number"&&(i.notify("draw",{prop:"setDestPoints",onPropertyChange:!1}),i.notify("draw",{prop:"setClientTransDim",onPropertyChange:!1,value:{isPreventDimension:null}})),i.notify("shape",{prop:"redrawObj",onPropertyChange:!1,value:{degree:e}}),i.currSelectionPoint=f({},i.objColl[0],{},!0),this.currDestPoint={startX:i.img.destLeft,startY:i.img.destTop,width:i.img.destWidth,height:i.img.destHeight},i.objColl=r,i.activeObj=t,i.img={srcLeft:o.startX,srcTop:o.startY,srcWidth:o.width,srcHeight:o.height,destLeft:a.startX,destTop:a.startY,destWidth:a.width,destHeight:a.height}}},d.prototype.flipImage=function(e){var i=this.parent,t={direction:e,cancel:!1,previousDirection:i.toPascalCase(i.transform.currFlipState||e)};this.isPreventSelect||(i.trigger("flipping",t),i.editCompleteArgs=t),this.flipEvent(t,e)},d.prototype.flipEvent=function(e,i){var t=this.parent;if(e.cancel){t.notify("draw",{prop:"setCurrentObj",onPropertyChange:!1,value:{obj:t.prevEventObjPoint}}),t.activeObj=t.prevEventSelectionPoint,t.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:t.activeObj}});return}var r;if(C(this.transCurrObj)){var o={currObj:{}};t.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:o}}),r=o.currObj,r.objColl=f([],t.objColl,null,!0),r.pointColl=f({},t.pointColl,null,!0),r.afterCropActions=f([],t.afterCropActions,[],!0);var a={selPointColl:null};t.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:a}}),r.selPointColl=f([],a.selPointColl,[],!0)}t.afterCropActions.push(i.toLowerCase()==="horizontal"?"horizontalflip":"verticalflip");var n=[],s;t.activeObj.activePoint&&(t.activeObj.shape!==void 0&&(n=t.activeObj.shape.split("-")),(t.currObjType.isCustomCrop||n[0]==="crop")&&(s=t.currObjType.isCustomCrop?"custom":n[1],t.notify("shape",{prop:"updImgRatioForActObj",onPropertyChange:!1}),t.objColl.push(t.activeObj),t.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}))),t.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:!0}}),t.clearContext(this.lowerContext),t.clearContext(this.upperContext);var l=f([],t.objColl,[],!0),p=f({},t.activeObj,{},!0);t.objColl=[],t.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.isReverseFlip||t.notify("draw",{prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"initial",isPreventDestination:null,isRotatePan:null}});var h=i.toLowerCase();this.updateFlipState(h);var u=t.transform.currFlipState.toLowerCase();t.transform.currFlipState=h==="horizontal"&&u==="horizontal"||h==="vertical"&&u==="vertical"?"":h;var c={isSelected:null};t.notify("draw",{prop:"getRotatedFlipCropSelection",onPropertyChange:!1,value:{bool:c}}),c.isSelected&&(t.img.destLeft+=t.panPoint.totalPannedInternalPoint.x,t.img.destTop+=t.panPoint.totalPannedInternalPoint.y);var g=this.lowerContext.filter;if(t.notify("draw",{prop:"drawImage",onPropertyChange:!1}),this.lowerContext.filter=g,t.notify("draw",{prop:"setImageEdited",onPropertyChange:!1}),this.updateFlipState(i.toLowerCase()),this.isReverseFlip||(t.notify("draw",{prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"reverse",isPreventDestination:null,isRotatePan:null}}),this.updateFlipColl(i.toLocaleLowerCase()),t.rotateFlipColl.push(i.toLowerCase())),t.rotateFlipColl.length===1){var v={panRegion:""};t.notify("crop",{prop:"getCurrFlipState",onPropertyChange:!1,value:{panObj:v}}),v.panRegion===""?t.notify("draw",{prop:"setClientTransDim",onPropertyChange:!1,value:{isPreventDimension:null}}):this.setDestPointsForFlipState()}t.isCircleCrop&&t.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),t.objColl=f([],l,[],!0),t.activeObj=f({},p,{},!0);for(var b=0,m=t.objColl.length;b<m;b++){var y=t.objColl[b].flipObjColl;y.length===0?y.push(i):y[y.length-1]===i?y.pop():y.push(i)}t.notify("shape",{prop:"redrawObj",onPropertyChange:!1,value:{degree:i.toLowerCase()}});var P=this.lowerContext.filter;this.lowerContext.filter="brightness(1) contrast(100%) hue-rotate(0deg) saturate(100%) opacity(1) blur(0px) sepia(0%) grayscale(0%) invert(0%)",t.notify("shape",{prop:"iterateObjColl",onPropertyChange:!1});var S=i.toLowerCase();S==="horizontal"||S==="vertical"?(t.notify("freehand-draw",{prop:"flipFHDColl",onPropertyChange:!1,value:{value:S}}),t.notify("freehand-draw",{prop:"freehandRedraw",onPropertyChange:!1,value:{context:this.lowerContext,points:null}})):t.notify("freehand-draw",{prop:"freehandRedraw",onPropertyChange:!1,value:{context:this.lowerContext,points:null}}),this.lowerContext.filter=P,t.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.updateCurrSelectionPoint(S),t.isUndoRedo=!1,t.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),t.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.upperContext}}),t.isCircleCrop&&t.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),s&&(this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),t.activeObj=f({},t.objColl[t.objColl.length-1],{},!0),t.objColl.pop(),t.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:t.activeObj}}));var O={collection:t.rotateFlipColl};t.notify("shape",{prop:"alignRotateFlipColl",onPropertyChange:!1,value:{collection:t.rotateFlipColl,isRotateFlipCollection:!0,obj:O}}),t.rotateFlipColl=O.collection,t.cropObj.activeObj.shape&&!this.isPreventSelect&&(t.notify("draw",{prop:"setIsCropSelect",value:{bool:!0}}),this.isPreventSelect=!0,t.notify("draw",{prop:"select",onPropertyChange:!1,value:{type:"custom",startX:null,startY:null,width:null,height:null}}),this.isPreventSelect=!1,t.setProperties({zoomSettings:{zoomFactor:1}},!0),this.prevZoomValue=t.zoomSettings.zoomFactor)},d.prototype.updateFlipState=function(e){var i=this.parent.transform.degree;e==="horizontal"?i%90===0&&i%180!==0?this.verticalFlip():this.horizontalFlip():e==="vertical"&&(i%90===0&&i%180!==0?this.horizontalFlip():this.verticalFlip())},d.prototype.horizontalFlip=function(){this.lowerContext.translate(this.lowerContext.canvas.width,0),this.lowerContext.scale(-1,1),this.upperContext.translate(this.upperContext.canvas.width,0),this.upperContext.scale(-1,1)},d.prototype.verticalFlip=function(){this.lowerContext.translate(0,this.lowerContext.canvas.height),this.lowerContext.scale(1,-1),this.upperContext.translate(0,this.upperContext.canvas.height),this.upperContext.scale(1,-1)},d.prototype.updateFlipColl=function(e){if(!this.isPreventSelect&&(this.flipColl.length===0||this.flipColl[this.flipColl.length-1]!==e?this.flipColl.push(e):this.flipColl.pop(),this.flipColl.length>=4)){var i=this.flipColl.slice(-4);(i[0]==="horizontal"&&i[1]==="vertical"&&i[2]==="horizontal"&&i[3]==="vertical"||i[0]==="vertical"&&i[1]==="horizontal"&&i[2]==="vertical"&&i[3]==="horizontal")&&this.flipColl.splice(-4)}},d.prototype.setDestPointsForFlipState=function(){var e=this.parent,i={panRegion:""},t=e.img,r=t.destLeft,o=t.destTop,a=t.destWidth,n=t.destHeight,s=e.lowerCanvas,l=s.clientWidth,p=s.clientHeight;e.notify("crop",{prop:"getCurrFlipState",onPropertyChange:!1,value:{panObj:i}}),i.panRegion!==""&&(i.panRegion==="horizontal"?e.img.destLeft=l-(a+r):(i.panRegion==="vertical"||(e.img.destLeft=l-(a+r)),e.img.destTop=p-(n+o)))},d.prototype.zoomAction=function(e,i,t,r){var o=this.parent;if(!o.disabled&&o.isImageLoaded){if(C(t)&&(o.zoomSettings.zoomFactor>=o.zoomSettings.maxZoomFactor&&e>0||o.zoomSettings.zoomFactor>o.zoomSettings.minZoomFactor&&e<0&&this.disableZoomOutBtn(!0)||o.zoomSettings.zoomFactor<=o.zoomSettings.minZoomFactor&&e<0)){o.notify("toolbar",{prop:"zoom-up-handler",onPropertyChange:!1});return}o.notify("draw",{prop:"setImageEdited",onPropertyChange:!1});var a=e;e=a>0?.1:-.1;for(var n=0;n<Math.round(Math.abs(a/.1));n++)if(this.prevZoomValue===1)this.prevZoomValue+=e>0?e*10:e*10/10;else if(this.prevZoomValue>1)this.prevZoomValue+=e*10;else if(this.prevZoomValue<1){this.prevZoomValue+=e*10/10;var s=Math.pow(10,1);this.prevZoomValue=Math.round(this.prevZoomValue*s)/s}e=a,o.setProperties({zoomSettings:{zoomFactor:this.prevZoomValue}},!0);var l=void 0;this.tempActiveObj=null,this.isShape=!1,o.activeObj.shape!==void 0&&(o.activeObj.shape==="shape"?o.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}):l=o.activeObj.shape.split("-")),l!==void 0&&l[0]==="crop"?(this.tempActiveObj=f({},o.activeObj,{},!0),o.isCropTab=!0):(o.activeObj.shape&&l[0]!=="crop"&&(o.activeObj.activePoint.width!==0||o.activeObj.activePoint.height!==0)||o.activeObj.shape==="path"&&o.activeObj.pointColl.length>0)&&(this.isShape=!0);var p={zoomType:null};o.notify("selection",{prop:"getZoomType",onPropertyChange:!1,value:{obj:p}}),C(i)&&(o.isCropTab&&this.tempActiveObj?i={x:o.activeObj.activePoint.startX+o.activeObj.activePoint.width/2,y:o.activeObj.activePoint.startY+o.activeObj.activePoint.height/2}:i={x:o.lowerCanvas.clientWidth/2,y:o.lowerCanvas.clientHeight/2},(p.zoomType==="MouseWheel"||p.zoomType==="Pinch")&&(i={x:o.zoomSettings.zoomPoint.x,y:o.zoomSettings.zoomPoint.y}));var h=o.zoomSettings.zoomFactor-e*10,u={zoomPoint:i,cancel:!1,previousZoomFactor:h,currentZoomFactor:o.zoomSettings.zoomFactor,zoomTrigger:p.zoomType};!o.isCropToolbar&&o.isZoomBtnClick&&(o.trigger("zooming",u),o.editCompleteArgs=u),this.zoomEvent(u,e,r)}},d.prototype.zoomEvent=function(e,i,t){var r=this.parent,o,a=r.zoomSettings,n=a.zoomFactor,s=a.minZoomFactor;if(e.cancel){r.isZoomBtnClick=!1;return}this.parent.activeObj.redactType!=="blur"&&this.parent.activeObj.redactType!=="pixelate"&&r.notify("toolbar",{prop:"close-contextual-toolbar",onPropertyChange:!1}),!r.isCropTab&&r.activeObj.shape&&(o=r.activeObj.currIndex),r.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:!0}}),r.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,r.lowerCanvas.width,r.lowerCanvas.height);var l={canvasFilter:r.canvasFilter};this.lowerContext.filter=l.canvasFilter,r.upperCanvas.style.cursor=r.cursor="default";var p=f([],r.objColl,[],!0);if(!r.isCropTab){if(r.transform.degree!==0){r.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:null}}),r.panPoint.currentPannedPoint={x:0,y:0};var h=r.allowDownScale;r.allowDownScale=!1,this.rotatePan(!0,!0),r.allowDownScale=h}else r.transform.currFlipState!==""&&(r.panPoint.totalPannedPoint={x:0,y:0});r.transform.straighten===0&&!this.isPreventSelect&&r.notify("freehand-draw",{prop:"updateFHDColl",onPropertyChange:!1,value:{isPreventApply:t}})}if(r.transform.degree===0){this.drawZoomImgToCanvas(i,this.tempActiveObj);var u={panRegion:""};if(r.notify("crop",{prop:"getCurrFlipState",onPropertyChange:!1,value:{panObj:u}}),u.panRegion!==""){r.notify("crop",{prop:"setTempFlipPanPoint",onPropertyChange:!1,value:{point:r.panPoint.totalPannedPoint,isAdd:!0}}),p=f([],r.objColl,[],!0),r.objColl=[];var c=r.img.destLeft,g=r.img.destTop;this.setDestPointsForFlipState(),this.rotatedFlip(),r.img.destLeft=c,r.img.destTop=g,r.objColl=p,r.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:t}}),r.transform.straighten===0&&!this.isPreventSelect&&r.notify("freehand-draw",{prop:"updateFHDColl",onPropertyChange:!1,value:{isPreventApply:t}})}n<=s&&!r.isCropTab&&(r.panPoint.totalPannedPoint={x:0,y:0})}else{r.transform.straighten===0&&!this.isPreventSelect&&r.notify("freehand-draw",{prop:"updateFHDColl",onPropertyChange:!1,value:{isPreventApply:t}}),r.panPoint.totalPannedClientPoint={x:0,y:0},r.panPoint.totalPannedInternalPoint={x:0,y:0},this.rotateZoom(i);var v={panRegion:""};if(r.notify("crop",{prop:"getCurrFlipState",onPropertyChange:!1,value:{panObj:v}}),v.panRegion!==""){var h=this.lowerContext.filter;this.lowerContext.filter="none",r.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:t}}),this.lowerContext.filter=h}}var b=Math.pow(10,1);(n<=s||Math.round(r.transform.zoomFactor*b)/b===2)&&(clearInterval(this.zoomBtnHold),this.zoomBtnHold=0);var m={panRegion:""};if(r.notify("crop",{prop:"getCurrFlipState",onPropertyChange:!1,value:{panObj:m}}),m.panRegion===""){var h=this.lowerContext.filter;this.lowerContext.filter="none",r.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:t}}),this.lowerContext.filter=h}(r.currSelectionPoint&&r.currSelectionPoint.shape==="crop-circle"||r.isCircleCrop)&&r.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),r.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),r.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.tempActiveObj&&(r.activeObj=f({},this.tempActiveObj,{},!0),r.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:r.activeObj}}),n<=s&&(r.currSelectionPoint=null)),r.isUndoRedo=!1;var y;y=document.querySelector("#"+r.element.id+"_zoomOut"),y&&n<=s?(y.classList.add("e-disabled"),y.parentElement.classList.add("e-overlay")):y&&(y.classList.remove("e-disabled"),y.parentElement.classList.remove("e-overlay"));var P=r.drawingShape;if(this.autoEnablePan(),r.drawingShape=P,this.tempActiveObj&&(r.activeObj=f({},this.tempActiveObj,{},!0)),r.activeObj.shape==="crop-custom"&&(r.currObjType.isCustomCrop=!0),this.isShape){if(o){for(var S=0,O=r.objColl.length;S<O;S++)if(r.objColl[S].currIndex===o){r.activeObj=f({},r.objColl[S],{},!0),r.objColl.splice(S,1);break}}else r.activeObj=f({},r.objColl[r.objColl.length-1],{},!0),r.objColl.pop();r.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:r.activeObj,isCropRatio:null,points:null,isPreventDrag:!0,saveContext:null,isPreventSelection:null}}),r.notify("toolbar",{prop:"update-toolbar-items",onPropertyChange:!1}),r.notify("toolbar",{prop:"renderQAT",onPropertyChange:!1,value:{isPenEdit:null}})}if(r.notify("toolbar",{prop:"enable-disable-btns",onPropertyChange:!1}),r.notify("selection",{prop:"setZoomType",onPropertyChange:!1,value:{zoomType:"Toolbar"}}),e={zoomPoint:e.zoomPoint,previousZoomFactor:e.previousZoomFactor,currentZoomFactor:e.currentZoomFactor,zoomTrigger:e.zoomTrigger},!r.isCropToolbar&&r.isZoomBtnClick&&(r.isZoomBtnClick=!1),r.drawingShape){var j=f({},r.activeObj,{},!0);if(r.enableShapeDrawing(r.toPascalCase(r.drawingShape),!0),r.activeObj=j,j.activePoint.width>0||j.activePoint.height>0||j.pointColl&&j.pointColl.length>0){j.shape==="redact"&&r.notify("toolbar",{prop:"renderQAT",onPropertyChange:!1,value:{isPenEdit:null}});var x=r.element.querySelector("#"+r.element.id+"_zOrderBtn"),k=r.element.querySelector("#"+r.element.id+"_duplicate"),T=r.element.querySelector("#"+r.element.id+"_remove"),A=r.element.querySelector("#"+r.element.id+"_editText");x&&x.classList.remove("e-overlay"),k&&k.classList.remove("e-overlay"),T&&T.classList.remove("e-overlay"),A&&A.classList.remove("e-overlay")}}else r.activeObj.shape&&r.activeObj.shape==="redact"&&(r.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"redact",isApplyBtn:!1,isCropping:!1}}),r.notify("toolbar",{prop:"renderQAT",onPropertyChange:!1,value:{isPenEdit:null}}))},d.prototype.disableZoomOutBtn=function(e){var i=this.parent,t=i.zoomSettings,r=t.zoomFactor,o=t.minZoomFactor,a=!1,n;C(e)||(i.transform.zoomFactor-=.1),n=i.element.querySelector("#"+i.element.id+"_zoomOut");var s={destLeft:i.img.destLeft,destTop:i.img.destTop,destWidth:i.img.destWidth,destHeight:i.img.destHeight};if(i.activeObj.shape){var l=this.setZoomDimension(-.1,i.activeObj);if(!C(n)){var p=i.activeObj.activePoint;if(i.transform.straighten===0)i.img.destLeft>p.startX||i.img.destTop>p.startY||i.img.destLeft+i.img.destWidth<p.endX||i.img.destTop+i.img.destHeight<p.endY||r===o?(n.classList.add("e-disabled"),n.parentElement.classList.add("e-overlay"),a=!0):(n.classList.remove("e-disabled"),n.parentElement.classList.remove("e-overlay"),a=!1);else{i.img.destWidth=l.width,i.img.destHeight=l.height;var h={isIntersect:null};i.notify("draw",{prop:"updateImgCanvasPoints",onPropertyChange:!1}),i.notify("draw",{prop:"isLinesIntersect",onPropertyChange:!1,value:{obj:h}}),h.isIntersect||r===o?(n.classList.add("e-disabled"),n.parentElement.classList.add("e-overlay"),a=!0):(n.classList.remove("e-disabled"),n.parentElement.classList.remove("e-overlay"),a=!1)}}}else this.setZoomDimension(-.1,null);return C(e)||(i.transform.zoomFactor+=.1),i.img.destLeft=s.destLeft,i.img.destTop=s.destTop,i.img.destWidth=s.destWidth,i.img.destHeight=s.destHeight,a},d.prototype.drawZoomImgToCanvas=function(e,i){var t=this.parent,r=Math.pow(10,1),o=Math.round(t.transform.zoomFactor*r)/r;o===.1&&e===-.1||o===0&&e===-.025?t.transform.zoomFactor=0:t.transform.zoomFactor+=e,t.transform[t.isCropTab?"cropZoomFactor":"defaultZoomFactor"]=t.transform.zoomFactor;var a={width:0,height:0};t.isCropTab?a=this.cropZoom(e,i):(a=this.calcMaxDimension(t.img.srcWidth,t.img.srcHeight),a.width+=a.width*t.transform.zoomFactor,a.height+=a.height*t.transform.zoomFactor,t.img.destLeft=(t.lowerCanvas.clientWidth-a.width)/2,t.img.destTop=(t.lowerCanvas.clientHeight-a.height+1)/2),t.notify("draw",{prop:"draw-image-to-canvas",value:{dimension:a}}),a.width=this.cropDimension.width,a.height=this.cropDimension.height,a.width+=a.width*t.transform.zoomFactor,a.height+=a.height*t.transform.zoomFactor,t.notify("draw",{prop:"setZoomCropWidth",value:{width:a.width,height:a.height}})},d.prototype.rotatedFlip=function(){var e=this.parent;this.isReverseFlip=!0;var i=e.transform.currFlipState,t=this.flipColl,r=f([],e.objColl,[],!0),o=f({},e.activeObj,{},!0);this.flipColl=[],e.objColl=[],e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),e.notify("draw",{prop:"currTransState",onPropertyChange:!1,value:{type:"initial",isPreventDestination:null,context:null,isPreventCircleCrop:null}});var a=this.lowerContext.filter;e.notify("draw",{prop:"drawImage",onPropertyChange:!1}),this.lowerContext.filter=a,e.notify("draw",{prop:"currTransState",onPropertyChange:!1,value:{type:"reverse",isPreventDestination:!0,context:null,isPreventCircleCrop:null}}),i===""&&e.transform.currFlipState!==""&&(i=e.transform.currFlipState),e.transform.currFlipState=i,this.flipColl=t,e.objColl=f([],r,[],!0),this.lowerContext.filter="none",e.notify("shape",{prop:"iterateObjColl",onPropertyChange:!1}),this.lowerContext.filter=a,o.activePoint.width!==0&&(e.activeObj=f({},o,{},!0)),this.isReverseFlip=!1},d.prototype.rotateZoom=function(e){var i=this.parent,t=Math.pow(10,1),r=Math.round(i.transform.zoomFactor*t)/t;r===.1&&e===-.1||r===0&&e===-.025?i.transform.zoomFactor=0:i.transform.zoomFactor+=e,i.isCropTab?i.transform.cropZoomFactor=i.transform.zoomFactor:i.transform.defaultZoomFactor=i.transform.zoomFactor;var o=f([],i.objColl,[],!0),a=f({},i.activeObj,{},!0);i.objColl=[],i.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),i.notify("draw",{prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"initial",isPreventDestination:null,isRotatePan:null}}),i.notify("draw",{prop:"setRotateZoom",onPropertyChange:!1,value:{isRotateZoom:!0}}),i.notify("draw",{prop:"setDestPoints",onPropertyChange:!1});var n=this.lowerContext.filter;i.notify("draw",{prop:"drawImage",onPropertyChange:!1}),this.lowerContext.filter=n,i.notify("draw",{prop:"setRotateZoom",onPropertyChange:!1,value:{isRotateZoom:!1}}),i.notify("draw",{prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"reverse",isPreventDestination:null,isRotatePan:null}}),i.objColl=o,i.activeObj=a;var s={width:this.cropDimension.width,height:this.cropDimension.height};s.width+=s.width*i.transform.zoomFactor,s.height+=s.height*i.transform.zoomFactor,i.notify("draw",{prop:"setZoomCropWidth",value:{width:s.width,height:s.height}})},d.prototype.autoEnablePan=function(){var e=this.parent;e.transform.zoomFactor<=0?(e.togglePan=!1,e.notify("selection",{prop:"setDragCanvas",value:{bool:!1}}),e.pan(!1),this.disablePan=!1):e.pan(!this.disablePan)},d.prototype.cropZoom=function(e,i){var t=this.parent,r=t.img.destLeft,o=t.img.destTop,a={width:0,height:0};return t.transform.degree%90===0&&t.transform.degree%180!==0?a=this.calcMaxDimension(t.img.srcHeight,t.img.srcWidth):a=this.calcMaxDimension(t.img.srcWidth,t.img.srcHeight),a.width+=a.width*t.transform.zoomFactor,a.height+=a.height*t.transform.zoomFactor,t.img.destLeft=r-(a.width-t.img.destWidth)/2,t.img.destTop=o-(a.height-t.img.destHeight)/2,r=t.img.destLeft,o=t.img.destTop,i&&t.transform.straighten===0&&(t.img.destLeft>i.activePoint.startX&&(t.img.destLeft=i.activePoint.startX,t.transform.degree===0&&(t.panPoint.totalPannedPoint.x-=r-t.img.destLeft)),t.img.destTop>i.activePoint.startY&&(t.img.destTop=i.activePoint.startY,t.transform.degree===0&&(t.panPoint.totalPannedPoint.y-=o-t.img.destTop)),t.img.destLeft+a.width<i.activePoint.endX&&(t.img.destLeft=i.activePoint.endX-a.width,t.transform.degree===0&&(t.panPoint.totalPannedPoint.x-=r-t.img.destLeft)),t.img.destTop+a.height<i.activePoint.endY&&(t.img.destTop=i.activePoint.endY-a.height,t.transform.degree===0&&(t.panPoint.totalPannedPoint.y-=o-t.img.destTop))),a},d.prototype.setZoomDimension=function(e,i){var t=this.parent,r=t.transform.degree,o={width:0,height:0};if(r%90===0&&r%180!==0?o=this.calcMaxDimension(t.img.srcHeight,t.img.srcWidth):o=this.calcMaxDimension(t.img.srcWidth,t.img.srcHeight),o.width+=o.width*t.transform.zoomFactor,o.height+=o.height*t.transform.zoomFactor,t.img.destLeft+=(t.img.destWidth-o.width)/2,t.img.destTop+=(t.img.destHeight-o.height)/2,e<0&&i){var a=i.activePoint.startX,n=i.activePoint.startY,s=i.activePoint.width,l=i.activePoint.height,p=t.img.destLeft+o.width,h=t.img.destTop+o.height;t.img.destLeft>a&&(t.img.destLeft=a),t.img.destTop>n&&(t.img.destTop=n),p<a+s&&(t.img.destLeft=a+s-o.width),h<n+l&&(t.img.destTop=n+l-o.height)}else e<0&&C(i)&&(t.img.destLeft>0&&(t.img.destLeft=0),t.img.destTop>0&&(t.img.destTop=0),t.img.destLeft+o.width<t.lowerCanvas.clientWidth&&(t.img.destLeft=t.lowerCanvas.clientWidth-t.img.destWidth),t.img.destTop+o.height<t.lowerCanvas.clientHeight&&(t.img.destTop=t.lowerCanvas.clientHeight-t.img.destHeight));return o},d.prototype.drawPannedImage=function(e,i){var t=this.parent,r={panDown:null};t.notify("selection",{prop:"getPanDown",onPropertyChange:!1,value:{obj:r}});var o={startPoint:r.panDown,endPoint:this.panMove,cancel:!1};t.trigger("panning",o),!o.cancel&&this.panEvent(e,i)},d.prototype.panEvent=function(e,i,t){var r=this.parent,o=!1;if(r.activeObj.shape&&r.activeObj.shape==="shape"&&r.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),C(r.activeObj.shape)){o=!0;var a=r.activeObj.activePoint={startX:r.img.destLeft,startY:r.img.destTop,endX:r.img.destLeft+r.img.destWidth,endY:r.img.destTop+r.img.destHeight},n=a.startX,s=a.startY,l=a.endX,p=a.endY;n<0&&(a.startX=0),s<0&&(a.startY=0),l>r.lowerCanvas.width&&(a.endX=r.lowerCanvas.width),p>r.lowerCanvas.height&&(a.endY=r.lowerCanvas.height),a.width=a.endX-a.startX,a.height=a.endY-a.startY,r.activeObj.shape="crop-custom";var h={strokeSettings:{}};r.notify("shape",{prop:"getStrokeSettings",onPropertyChange:!1,value:{obj:h}}),r.activeObj.strokeSettings=h.strokeSettings,r.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:a,obj:r.activeObj,isMouseMove:null,x:null,y:null}}),r.isCropTab=!0}if(r.transform.degree===0){var u=void 0;C(e)&&C(i)||t?t?u=this.updatePanPoints(e,i):u=this.updatePanPoints():u={x:e,y:i},r.panPoint.totalPannedPoint.x+=u.x,r.panPoint.totalPannedPoint.y+=u.y;var c=f({},r.activeObj,{},!0),g=this.lowerContext.filter;this.drawPannImage(u,o),this.lowerContext.filter=g,this.tempPanMove=f({},this.panMove,{},!0),r.activeObj=f({},c,{},!0),this.upperContext.clearRect(0,0,r.upperCanvas.width,r.upperCanvas.height),r.activeObj.shape&&r.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:r.activeObj}})}else{var v=r.transform.currFlipState;r.isCropTab=!0,C(e)&&C(i)||t?t?r.panPoint.currentPannedPoint=this.updatePanPoints(e,i):r.panPoint.currentPannedPoint=this.updatePanPoints():r.panPoint.currentPannedPoint={x:e,y:i},r.transform.currFlipState=v,this.rotatePan(null,null,o),r.isCropTab=!1,this.tempPanMove=f({},this.panMove,{},!0)}o&&(r.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),r.isCropTab=!1,this.upperContext.clearRect(0,0,r.upperCanvas.width,r.upperCanvas.height))},d.prototype.drawPannImage=function(e,i){var t=this.parent,r=this.lowerContext.filter,o={startX:t.img.destLeft,startY:t.img.destTop,width:t.img.destWidth,height:t.img.destHeight};this.lowerContext.clearRect(0,0,t.lowerCanvas.width,t.lowerCanvas.height),t.notify("draw",{prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"initial",isPreventDestination:null,isRotatePan:null}}),t.img.destLeft=o.startX,t.img.destTop=o.startY,t.img.destWidth=o.width,t.img.destHeight=o.height,this.setDestPointsForFlipState(),i&&(t.isCropTab=!1),t.notify("draw",{prop:"drawImage",onPropertyChange:!1}),i&&(t.isCropTab=!0),(t.currSelectionPoint&&t.currSelectionPoint.shape==="crop-circle"||t.isCircleCrop)&&t.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:!0}}),this.lowerContext.filter=r,t.notify("draw",{prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"reverse",isPreventDestination:null,isRotatePan:null}}),t.img.destLeft=o.startX,t.img.destTop=o.startY,t.img.destWidth=o.width,t.img.destHeight=o.height;var a=this.lowerContext.filter;this.lowerContext.filter="none",i&&(t.isCropTab=!1),t.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"pan",pen:"pan",x:e.x,y:e.y,panRegion:""}}),i&&(t.isCropTab=!0),this.lowerContext.filter=a,t.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),t.isCircleCrop&&t.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:!0}})},d.prototype.resetZoom=function(){var e=this.parent;if(e.transform.defaultZoomFactor!==0){var i=e.isUndoRedo,t={currObj:{}};e.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:t}}),this.transCurrObj=t.currObj,this.transCurrObj.objColl=f([],e.objColl,null,!0),this.transCurrObj.pointColl=f({},e.pointColl,null,!0),this.transCurrObj.afterCropActions=f([],e.afterCropActions,[],!0);var r={selPointColl:null};e.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:r}}),this.transCurrObj.selPointColl=f([],r.selPointColl,[],!0),e.isUndoRedo=e.isCropToolbar=!0;var o=e.transform.defaultZoomFactor;o>0?this.zoomAction(-o):this.zoomAction(Math.abs(o)),e.isCropToolbar=!1,e.isUndoRedo=i}},d.prototype.performTransformation=function(e){var i=this.parent;this.resetZoom(),this.updateTransform(e);for(var t=0,r=i.objColl.length;t<r;t++)if(i.objColl[t].flipObjColl.length>0){var o={collection:i.objColl[t].flipObjColl};i.notify("shape",{prop:"alignRotateFlipColl",onPropertyChange:!1,value:{collection:o.collection,isRotateFlipCollection:null,obj:o}}),i.objColl[t].flipObjColl=o.collection,i.objColl[t].flipObjColl.length===0&&(i.objColl[t].shapeFlip="")}},d.prototype.updateTransform=function(e){switch(e.toLowerCase()){case"rotateleft":this.rotateImage(-90);break;case"rotateright":this.rotateImage(90);break;case"horizontalflip":this.flipImage(Xe.Horizontal);break;case"verticalflip":this.flipImage(Xe.Vertical);break}},d.prototype.rotatePan=function(e,i,t){var r=this.parent;this.isReverseRotate=!0;var o=r.transform.degree,a,n={selPointColl:null};r.activeObj.activePoint&&r.activeObj.shape&&(a=f({},r.activeObj,{},!0));var s=f([],r.objColl,[],!0),l=f([],r.pointColl,[],!0);r.objColl=[],r.pointColl=[],r.freehandCounter=0,r.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:n}});var p=n.selPointColl;r.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:[]}}}),r.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),r.notify("draw",{prop:"setRotateZoom",onPropertyChange:!1,value:{isRotateZoom:!0}}),r.notify("draw",{prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"initial",isPreventDestination:null,isRotatePan:null}});var h=r.img.destLeft,u=r.img.destTop,c=r.panPoint.totalPannedInternalPoint;r.isCropTab&&(r.img.destLeft+=c.x,r.img.destTop+=c.y),r.notify("crop",{prop:"updateRotatePan",onPropertyChange:!1}),r.isCropTab&&(r.panPoint.totalPannedInternalPoint.x=r.img.destLeft-h,r.panPoint.totalPannedInternalPoint.y=r.img.destTop-u);var g=this.lowerContext.filter;t&&(r.isCropTab=!1),r.notify("draw",{prop:"drawImage",onPropertyChange:!1}),t&&(r.isCropTab=!0),r.notify("draw",{prop:"setRotateZoom",onPropertyChange:!1,value:{isRotateZoom:!1}}),r.notify("draw",{prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"reverse",isPreventDestination:!0,isRotatePan:!0}});var v=r.img.destLeft,b=r.img.destTop;r.img.destLeft+=r.panPoint.totalPannedClientPoint.x,r.img.destTop+=r.panPoint.totalPannedClientPoint.y,r.img.destLeft+=r.panPoint.currentPannedPoint.x,r.img.destTop+=r.panPoint.currentPannedPoint.y,r.panPoint.totalPannedClientPoint.x=r.img.destLeft-v,r.panPoint.totalPannedClientPoint.y=r.img.destTop-b,r.objColl=s,r.pointColl=l,r.freehandCounter=r.pointColl.length,r.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:p}}}),r.transform.degree=o,this.lowerContext.filter="none",e&&(i?(r.panPoint.totalPannedClientPoint.x=-r.panPoint.totalPannedClientPoint.x,r.panPoint.totalPannedClientPoint.y=-r.panPoint.totalPannedClientPoint.y,r.panPoint.currentPannedPoint=f({},r.panPoint.totalPannedClientPoint,{},!0),r.panPoint.totalPannedClientPoint={x:0,y:0},r.img.destLeft+=r.panPoint.currentPannedPoint.x,r.img.destTop+=r.panPoint.currentPannedPoint.y):r.panPoint.currentPannedPoint=f({},r.panPoint.totalPannedClientPoint,{},!0)),t&&(r.isCropTab=!1),r.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"pan",pen:"pan",x:r.panPoint.currentPannedPoint.x,y:r.panPoint.currentPannedPoint.y,panRegion:""}}),t&&(r.isCropTab=!0),this.lowerContext.filter=g,r.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),this.upperContext.clearRect(0,0,r.upperCanvas.width,r.upperCanvas.height),r.activeObj=f({},a,{},!0),r.activeObj.activePoint&&r.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:r.activeObj,isCropRatio:null,points:null,isPreventDrag:!0,saveContext:null,isPreventSelection:null}}),this.isReverseRotate=!1},d.prototype.limitPan=function(){var e=this.parent,i=e.activeObj.activePoint,t=i.startX,r=i.startY,o=i.endX,a=i.endY,n=e.img;e.activeObj.activePoint&&(n.destLeft>t&&(e.img.destLeft=t),n.destTop>r&&(e.img.destTop=r),n.destLeft+n.destWidth<o&&(e.img.destLeft=o-n.destWidth),n.destTop+n.destHeight<a&&(e.img.destTop=a-n.destHeight))},d.prototype.pan=function(e,i,t){var r=this.parent;!r.disabled&&r.isImageLoaded&&(e?(r.togglePan=!0,r.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:null}}),r.notify("selection",{prop:"setDragCanvas",value:{bool:!0}}),r.lowerCanvas.style.cursor=r.upperCanvas.style.cursor=r.cursor="grab",r.notify("selection",{prop:"setPanDown",onPropertyChange:!1,value:{panDown:null}}),(i||t)&&(i=i||0,t=t||0,C(this.panMove)&&(this.panMove={x:i,y:t}),C(this.tempPanMove)&&(this.tempPanMove={x:this.panMove.x,y:this.panMove.y}),this.panEvent(i,t,!0),this.tempPanMove=null)):(r.togglePan=r.currObjType.isCustomCrop=!1,r.notify("selection",{prop:"setDragCanvas",value:{bool:!1}}),r.lowerCanvas.style.cursor=r.upperCanvas.style.cursor=r.cursor="default"))},d.prototype.zoom=function(e,i){var t=this.parent;if(!t.disabled&&t.isImageLoaded){var r=this.getCurrentZoomFactor(e);if(C(i))this.zoomAction(r,i);else for(var o=r>0?"zoomIn":"zoomOut",a=Math.abs(r)*10,n=0;n<a;n++)t.notify("draw",{prop:"performPointZoom",onPropertyChange:!1,value:{x:i.x,y:i.y,type:o,isResize:null}});var s={action:r>0?"zoom-in":"zoom-out",actionEventArgs:t.editCompleteArgs};t.triggerEditCompleteEvent(s)}},d.prototype.getCurrentZoomFactor=function(e){return e>=1?this.prevZoomValue<1?e-this.prevZoomValue:(e-this.prevZoomValue)*.1:e-this.prevZoomValue},d.prototype.setCurrPanRegion=function(e,i,t){var r=e;e===""?r=i==="horizontal"?"horizontal":i==="vertical"?"vertical":e:e==="horizontal"?r=i==="horizontal"?"horizontalVertical":i==="vertical"?"verticalHorizontal":i===90?"vertical":i===-90?"horizontal":e:e==="vertical"?r=i==="horizontal"?"horizontalVertical":i==="vertical"?"verticalHorizontal":i===90?"horizontal":i===-90?"vertical":e:r=i==="horizontal"?"vertical":i==="vertical"?"horizontal":e,t.panRegion=r},d.prototype.rotate=function(e,i){var t=this.parent,r=!1;!t.disabled&&t.isImageLoaded&&e%90===0&&this.rotateImage(e),i.isRotate=r},d.prototype.flip=function(e){var i=this.parent;!i.disabled&&i.isImageLoaded&&this.flipImage(e)},d.prototype.update=function(){var e=this.parent,i=0,t=!1,r={bool:!1},o={bool:e.isStraightening},a=0,n=e.element.querySelector("#"+e.element.id+"_contextualToolbar"),s=e.element.querySelector(".e-contextual-toolbar-wrapper"),l=e.element.querySelector("#"+e.element.id+"_headWrapper");if(e.isImageLoaded){var p=!1,h=void 0;w.isDevice&&(e.activeObj.shape&&(h=e.activeObj.shape.split("-")),(e.currObjType.isCustomCrop||h&&h[0]==="crop")&&(p=!0));var u={bool:null};e.notify("toolbar",{prop:"getFrameToolbar",onPropertyChange:!1,value:{obj:u}}),!o.bool&&(n&&!n.parentElement.classList.contains("e-hide")||l&&!l.parentElement.classList.contains("e-hide"))&&(s.classList.add("e-hide"),p||e.okBtn(null,!0),e.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1}),e.notify("toolbar",{prop:"destroy-qa-toolbar",onPropertyChange:!1})),e.notify("selection",{prop:"getFreehandDrawEditing",onPropertyChange:!1,value:{obj:r}}),r.bool&&e.notify("toolbar",{prop:"destroy-qa-toolbar",onPropertyChange:!1});var c=f({},e.activeObj.activePoint,{},!0);e.activeObj.shape&&(c.width!==0||c.height!==0)&&(t=!0,e.textArea.style.display==="block"||e.textArea.style.display==="inline-block"?(e.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:null}}),e.notify("toolbar",{prop:"destroy-qa-toolbar",onPropertyChange:!1})):(e.notify("shape",{prop:"updImgRatioForActObj",onPropertyChange:!1}),e.objColl.push(e.activeObj)),e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}))}e.updateDropInfoContent(e.element.querySelector(".e-ie-drop-info"));var g=this.lowerContext.filter,v=e.element.querySelector("#"+e.element.id+"_canvasWrapper");if(v&&(v.style.width=e.element.offsetWidth-2+"px"),e.lowerCanvas.width=e.upperCanvas.width=e.maskCanvas.width=e.element.offsetWidth-2,e.toolbarTemplate)i=e.element.querySelector("#"+e.element.id+"_toolbarArea").clientHeight;else if(e.element.querySelector("#"+e.element.id+"_toolbar")&&(i=e.element.querySelector("#"+e.element.id+"_toolbar").clientHeight,i===0&&e.toolbar&&e.toolbar.length>0&&e.toolbar.indexOf("Open")===-1)){var b={toolbarHeight:0};e.notify("toolbar",{prop:"getToolbarHeight",value:{obj:b}}),i=b.toolbarHeight}var m=e.element.querySelector("#"+e.element.id+"_contextualToolbarArea");if(w.isDevice&&o.bool&&m&&(a=m.clientHeight),e.notify("toolbar",{prop:"setToolbarHeight",value:{height:i}}),w.isDevice?v&&(v.style.height=e.element.offsetHeight-(2*i+a)-4+"px"):v&&(v.style.height=e.element.offsetHeight-i-2+"px"),e.lowerCanvas.height=e.upperCanvas.height=parseFloat(v.style.height),this.lowerContext.filter="brightness(1) contrast(100%) hue-rotate(0deg) saturate(100%) opacity(1) blur(0px) sepia(0%) grayscale(0%) invert(0%)",e.notify("filter",{prop:"setAdjustmentValue",onPropertyChange:!1,value:{adjustmentValue:this.lowerContext.filter}}),e.canvasFilter=this.lowerContext.filter,e.initialAdjustmentValue=this.lowerContext.filter,e.clearContext(this.lowerContext),e.clearContext(this.upperContext),e.isImageLoaded){if(e.notify("shape",{prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:null}}),e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.lowerContext.filter=g,e.initialAdjustmentValue=g,e.canvasFilter=this.lowerContext.filter,e.isImageLoaded&&(ue(e.element),e.element.style.opacity="0.5"),this.lowerContext.clearRect(0,0,e.lowerCanvas.width,e.lowerCanvas.height),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),v){v.style.width=e.element.offsetWidth-2+"px",v.style.height=e.element.offsetHeight+"px";var y={toolbarHeight:0};e.notify("toolbar",{prop:"getToolbarHeight",value:{obj:y}}),w.isDevice?v.style.height=parseFloat(v.style.height)-2*y.toolbarHeight-a-4+"px":v.style.height=parseFloat(v.style.height)-y.toolbarHeight-2+"px"}e.lowerCanvas.width=e.upperCanvas.width=e.maskCanvas.width=parseFloat(v.style.width),e.lowerCanvas.height=e.upperCanvas.height=e.maskCanvas.height=parseFloat(v.style.height),this.lowerContext.filter=g;var b={width:0,height:0};this.calcMaxDimension(e.img.srcWidth,e.img.srcHeight,b);var P=b;if(o.bool&&e.transform.cropZoomFactor!==0?(P.width+=P.width*e.transform.cropZoomFactor,P.height+=P.height*e.transform.cropZoomFactor):e.transform.defaultZoomFactor>0&&(P.width+=P.width*e.transform.defaultZoomFactor,P.height+=P.height*e.transform.defaultZoomFactor),e.img.destLeft=(e.lowerCanvas.clientWidth-P.width)/2,e.img.destTop=(e.lowerCanvas.clientHeight-P.height+1)/2,e.transform.degree===0&&e.transform.currFlipState==="")e.transform.defaultZoomFactor>0&&(e.img.destLeft+=e.panPoint.totalPannedPoint.x,e.img.destTop+=e.panPoint.totalPannedPoint.y),e.notify("draw",{prop:"draw-image-to-canvas",value:{dimension:P}});else{e.notify("draw",{prop:"draw-image-to-canvas",value:{dimension:P}}),e.notify("draw",{prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"initial",isPreventDestination:null,isRotatePan:null}});var S=this.lowerContext.filter;e.notify("draw",{prop:"drawImage",onPropertyChange:!1}),this.lowerContext.filter=S,e.notify("draw",{prop:"updateCurrTransState",onPropertyChange:!1,value:{type:"reverse",isPreventDestination:null,isRotatePan:null}})}e.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),e.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),e.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.upperContext}}),e.isCircleCrop&&e.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),re(e.element),e.element.style.opacity="1";var O={defToolbarItems:null};if(e.notify("toolbar",{prop:"getDefToolbarItems",value:{obj:O}}),O.defToolbarItems&&O.defToolbarItems.length>0&&document.getElementById(e.element.id+"_toolbar")){var j=F(e.element.id+"_toolbar","toolbar");j&&j.refreshOverflow(),s&&!o.bool&&s.classList.add("e-hide")}if(e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),t){var x=f({},e.objColl[e.objColl.length-1],null,!0);e.objColl.pop(),x.activePoint.width!==0&&x.activePoint.height!==0&&(this.lowerContext.clearRect(0,0,e.lowerCanvas.width,e.lowerCanvas.height),e.notify("draw",{prop:"render-image",value:{isMouseWheel:null}}),e.objColl.push(x),e.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),x=f({},e.objColl[e.objColl.length-1],null,!0),e.objColl.pop(),this.lowerContext.clearRect(0,0,e.lowerCanvas.width,e.lowerCanvas.height),e.notify("draw",{prop:"render-image",value:{isMouseWheel:null}}),e.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:x}}),o.bool&&e.notify("draw",{prop:"setStraightenActObj",value:{activeObj:x}}),(e.activeObj.shape==="rectangle"||e.activeObj.shape==="ellipse"||e.activeObj.shape==="text"||e.activeObj.shape==="line"||e.activeObj.shape==="arrow"||e.activeObj.shape==="path"||e.activeObj.shape==="image")&&e.notify("toolbar",{prop:"renderQAT",onPropertyChange:!1,value:{isPenEdit:null}}))}if(r.bool&&e.notify("toolbar",{prop:"renderQAT",onPropertyChange:!1,value:{isPenEdit:!0}}),e.isResize&&(e.aspectWidth=Math.ceil(e.img.destWidth),e.aspectHeight=Math.ceil(e.img.destHeight),e.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"resize",isApplyBtn:!1,isCropping:!1}}),e.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"resize",isApplyBtn:!1,isCropping:!1}})),(e.transform.degree!==0||e.transform.currFlipState!=="")&&e.transform.defaultZoomFactor>0){var k=f({},e.panPoint.totalPannedPoint,null,!0),T=f({},e.panPoint.totalPannedInternalPoint,null,!0),A=f({},e.panPoint.totalPannedClientPoint,null,!0);this.zoomAction(.1),this.zoomAction(-.1),e.transform.degree===0?(e.img.destLeft+=k.x,e.img.destTop+=k.y,e.panPoint.totalPannedPoint=k,e.notify("draw",{prop:"updateFlipPan",value:{tempSelectionObj:null}})):(e.panPoint.totalPannedInternalPoint=T,e.panPoint.totalPannedClientPoint=A,e.panPoint.currentPannedPoint={x:0,y:0},e.isCropTab=!0,this.rotatePan(),e.isCropTab=!1)}else e.transform.degree!==0&&e.transform.cropZoomFactor>0&&(e.transform.zoomFactor=0,e.transform.cropZoomFactor=null,e.notify("toolbar",{prop:"enable-disable-btns",onPropertyChange:!1}))}},d.prototype.calcMaxDimension=function(e,i,t,r){var o={toolbarHeight:0},a=this.parent;a.notify("toolbar",{prop:"getToolbarHeight",value:{obj:o}});var n=r?a.element.clientWidth/3:a.element.clientWidth,s=r?(a.element.clientHeight-o.toolbarHeight)/3:a.element.clientHeight-o.toolbarHeight;if(s=w.isDevice?s-o.toolbarHeight:s,w.isDevice&&a.isStraightening){var l=a.element.querySelector("#"+a.element.id+"_contextualToolbarArea");s-=l?l.clientHeight:0}!r&&a.element.clientHeight===0&&(s=0),C(r)&&(n>30&&(n-=30),s>30&&(s-=30));var p=n/e,h=s/i,u=Math.min(e,n),c=Math.min(i,s);if(p<1&&p<h?(u=e*p,c=i*p):h<1&&h<p&&(u=e*h,c=i*h),C(r)){var g={bool:null};a.notify("crop",{prop:"getPreventScaling",onPropertyChange:!1,value:{obj:g}}),g.bool&&a.cropObj.activeObj.activePoint&&a.cropObj.activeObj.activePoint.width!==0&&a.cropObj.activeObj.activePoint.height!==0&&(u=a.cropObj.activeObj.activePoint.width,c=a.cropObj.activeObj.activePoint.height)}return t&&(t.width=u,t.height=c),{width:u,height:c}},d.prototype.updatePanPoints=function(e,i){var t=this.parent,r=f({},t.activeObj,{},!0),o=t.img.destLeft,a=t.img.destTop;C(this.tempPanMove)&&(this.tempPanMove={x:this.panMove.x,y:this.panMove.y});var n=this.panMove.x-this.tempPanMove.x,s=this.panMove.y-this.tempPanMove.y;(e||i)&&(n=e,s=i),t.img.destLeft+=n,t.img.destTop+=s,this.limitPan();var l={bool:null},p={isIntersect:null};t.notify("draw",{prop:"updateImgCanvasPoints",onPropertyChange:!1}),t.notify("draw",{prop:"isLinesIntersect",onPropertyChange:!1,value:{obj:p}}),t.notify("draw",{prop:"isSelOutsideImg",onPropertyChange:!1,value:{obj:l}});for(var h=0;t.transform.straighten!==0&&(p.isIntersect||l.bool)&&(h++,t.img.destLeft=o,t.img.destTop=a,n!==0&&n>0?n-=1:n!==0&&n<0&&(n+=1),s!==0&&s>0?s-=1:s!==0&&s<0&&(s+=1),!(n===0&&s===0||h===200));)t.img.destLeft+=n,t.img.destTop+=s,this.limitPan(),t.notify("draw",{prop:"updateImgCanvasPoints",onPropertyChange:!1}),t.notify("draw",{prop:"isLinesIntersect",onPropertyChange:!1,value:{obj:p}}),t.notify("draw",{prop:"isSelOutsideImg",onPropertyChange:!1,value:{obj:l}});return t.activeObj=r,{x:t.img.destLeft-o,y:t.img.destTop-a}},d.prototype.resizeImage=function(e,i){var t=this.parent,r=!0,o=!0;t.allowDownScale=!1,t.img.srcLeft=0,t.img.srcTop=0,t.isAspectRatio=!0;var a=[];for(t.img.srcWidth=t.baseImgCanvas.width,t.img.srcHeight=t.baseImgCanvas.height,t.resizeSrc&&t.resizeSrc.width!==0&&t.resizeSrc.height!==0&&(t.img.srcLeft=t.resizeSrc.startX,t.img.srcTop=t.resizeSrc.startY,t.img.srcWidth=t.resizeSrc.width,t.img.srcHeight=t.resizeSrc.height);(e<t.img.destWidth||i<t.img.destHeight)&&o;)if(this.zoomAction(-.1,null,!0,!0),e>t.img.destWidth||i>t.img.destHeight)for(;e>t.img.destWidth||i>t.img.destHeight;)this.zoomAction(.0125,null,!0,!0),o=!1,a.push(t.img.destWidth);for(;(e>t.img.destWidth||i>t.img.destHeight)&&o&&r;)if(this.zoomAction(.1,null,!0,!0),e<t.img.destWidth||i<t.img.destHeight)for(;e<t.img.destWidth;)this.zoomAction(-.0125,null,!0,!0),r=!1,a.push(t.img.destWidth);for(var n=a[0],s=Math.abs(t.img.destWidth-n),l=0,p=a;l<p.length;l++){var h=p[l],u=Math.abs(e-h);u<s&&(n=h,s=u)}n<e&&r&&(this.zoomAction(-.0125,null,!0,!0),r=!1),n>e&&!r&&(this.zoomAction(.0125,null,!0,!0),r=!1),this.zoomAction(.0125,null,!0),t.allowDownScale=!0,this.zoomAction(-.0125,null,!0);var c=f({},t.cropObj,{},!0),g=f({},this.prevResizeCurrObj,{},!0);t.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"resize",previousObj:g,previousObjColl:g.objColl,previousPointColl:g.pointColl,previousSelPointColl:g.selPointColl,previousCropObj:c,previousText:null,currentText:null,previousFilter:null,isCircleCrop:t.isCircleCrop}}),t.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}})},d.prototype.resizeCrop=function(e,i){var t=this.parent,r=!0,o={prevObj:t.prevObj};t.cropObj=f({},t.prevCropObj,{},!0),t.allowDownScale=!1,t.notify("toolbar",{prop:"getPrevObj",onPropertyChange:!1,value:{obj:o}});var a=f({},o.prevObj.activeObj,{},!0);o.prevObj.activeObj=f({},t.activeObj,{},!0),t.notify("draw",{prop:"setCurrentObj",onPropertyChange:!1,value:{obj:o.prevObj}}),t.objColl=f([],o.prevObj.objColl,[],!0),t.pointColl=f([],o.prevObj.pointColl,[],!0),t.transform.straighten=0,t.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),t.transform.straighten===0&&!this.isPreventSelect&&t.notify("freehand-draw",{prop:"updateFHDColl",onPropertyChange:!1});var n=e,s=i,l=!1;if(i>=e&&i<=Math.ceil(t.img.destHeight)){for(;i<=Math.ceil(t.img.destHeight)&&r;)if(this.zoomAction(-.1,null,!0,!0),e>t.img.destWidth||i>t.img.destHeight)for(;e>t.img.destWidth||i>t.img.destHeight;)this.zoomAction(.0125,null,!0,!0),r=!1}else if(i<=e&&e<t.img.destWidth){for(;e<t.img.destWidth&&r;)if(this.zoomAction(-.1,null,!0,!0),e>t.img.destWidth||i>t.img.destHeight)for(;e>t.img.destWidth||i>t.img.destHeight;)this.zoomAction(.0125,null,!0,!0),r=!1}else if(i>=e&&i>=t.img.destHeight)for(;i>=t.img.destHeight&&r;)this.zoomAction(.1,null,!0,!0);else if(e>=i&&e>=t.img.destWidth){for(;e>=t.img.destWidth&&r;)this.zoomAction(.1,null,!0,!0);if(e<t.img.destWidth&&i<t.img.destHeight){for(;e<t.img.destWidth&&i<t.img.destHeight;)this.zoomAction(-.0125,null,!0,!0),r=!1;this.zoomAction(.0125,null,!0,!0)}}else if(i>t.img.destHeight&&e>t.img.destWidth){for(;i>t.img.destHeight&&e>t.img.destWidth&&r;)this.zoomAction(.1,null,!0,!0);if(e<t.img.destWidth&&i<t.img.destHeight){for(;e<t.img.destWidth&&i<t.img.destHeight;)this.zoomAction(-.0125,null,!0,!0),r=!1;this.zoomAction(.0125,null,!0,!0)}}if(this.resizeImg(a,e,i),e=n,i=s,i!==t.img.destHeight||e!==t.img.destWidth){for(;i>t.img.destHeight||e>t.img.destWidth;)this.zoomAction(.0125,null,!0,!0),l=!0;l&&(this.zoomAction(-.0125,null,!0,!0),l=!1)}if(i!==t.img.destHeight||e!==t.img.destWidth){for(;i<t.img.destHeight||e<t.img.destWidth;)this.zoomAction(-.0125,null,!0,!0),l=!0;l&&(this.zoomAction(-.0125,null,!0,!0),l=!1)}o.prevObj.activeObj=f({},a,{},!0),this.zoomAction(.0125,null,!0),t.allowDownScale=!this.preventDownScale,t.isCropTab=!1,this.zoomAction(-.0125,null,!0),t.aspectWidth=e,t.aspectHeight=i},d.prototype.resizeImg=function(e,i,t){var r=this.parent,o=i/r.img.destWidth,a=t/r.img.destHeight;e.shape?(r.currSelectionPoint=e,r.notify("crop",{prop:"setInitCrop",onPropertyChange:!1,value:{bool:!0}})):r.img.srcWidth===r.baseImgCanvas.width&&r.img.srcHeight===r.baseImgCanvas.height&&(r.currSelectionPoint=null,r.notify("draw",{prop:"select",onPropertyChange:!1,value:{type:"custom",startX:null,startY:null,width:null,height:null}})),C(r.currSelectionPoint)?r.notify("draw",{prop:"select",onPropertyChange:!1,value:{type:"custom",startX:r.img.destLeft,startY:r.img.destTop,width:r.img.destWidth,height:r.img.destHeight}}):r.notify("draw",{prop:"select",onPropertyChange:!1,value:{type:"custom",startX:null,startY:null,width:null,height:null}}),i=r.activeObj.activePoint.width*o,t=r.activeObj.activePoint.height*a;for(var n=r.activeObj.activePoint.startX+r.activeObj.activePoint.width/2-i/2,s=r.activeObj.activePoint.startY+r.activeObj.activePoint.height/2-t/2,l=0;w.isDevice&&l<500&&(n<0||s<0||n+i>r.img.destWidth||s+t>r.img.destHeight);)l++,i-=1,t-=1,n=r.activeObj.activePoint.startX+r.activeObj.activePoint.width/2-i/2,s=r.activeObj.activePoint.startY+r.activeObj.activePoint.height/2-t/2;if(r.transform.defaultZoomFactor=0,r.notify("draw",{prop:"setResizeSelect",value:{bool:!0}}),r.notify("draw",{prop:"setIsCropSelect",value:{bool:!0}}),r.notify("draw",{prop:"select",onPropertyChange:!1,value:{type:"custom",startX:n,startY:s,width:i,height:t}}),r.notify("draw",{prop:"setResizeSelect",value:{bool:!1}}),r.transform.straighten!==0){var p={isIntersect:null,arr:null};for(r.notify("draw",{prop:"updateImgCanvasPoints",onPropertyChange:!1}),r.notify("draw",{prop:"isLinesIntersect",onPropertyChange:!1,value:{obj:p}});p.arr[0]||p.arr[1]||p.arr[2]||p.arr[3];)this.zoomAction(.0125,null,!0),r.notify("draw",{prop:"updateImgCanvasPoints",onPropertyChange:!1}),r.notify("draw",{prop:"isLinesIntersect",onPropertyChange:!1,value:{obj:p}})}r.isCropToolbar=!0,r.crop(),r.isCropToolbar=!1},d.prototype.updateResize=function(){var e=this.parent;e.prevCropObj=f({},e.cropObj,{},!0);var i={currObj:{}};e.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:i}}),e.prevObj=i.currObj,e.currSelectionPoint&&e.prevCropObj.activeObj.shape&&(e.prevObj.activeObj=f({},e.prevCropObj.activeObj,{},!0)),e.prevObj.objColl=f([],e.objColl,[],!0),e.prevObj.pointColl=f([],e.pointColl,[],!0),e.prevObj.afterCropActions=f([],e.afterCropActions,[],!0);var t={selPointColl:null};e.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:t}}),e.prevObj.selPointColl=f([],t.selPointColl,[],!0),e.resizeSrc={startX:e.img.srcLeft,startY:e.img.srcTop,width:e.img.srcWidth,height:e.img.srcHeight}},d.prototype.resize=function(e,i,t){var r=this.parent,o;r.isResize=!0,C(r.prevCropObj)&&C(r.prevObj)&&r.notify("transform",{prop:"updateResize",value:{bool:!1}});var a=r.element.querySelector("#"+r.element.id+"_aspectratio"),n=r.element.querySelector("#"+r.element.id+"_nonaspectratio");a&&n&&(r.notify("toolbar",{prop:"initResizeToolbar"}),w.isDevice&&r.notify("toolbar",{prop:"init-main-toolbar",value:{isApplyBtn:!1,isDevice:!0,isOkBtn:!0,isResize:!0}}));var s=r.element.querySelector("#"+r.element.id+"_resizeHeight");s?o=s.value===""?s.placeholder:s.value:o=i+"px";var l={cancel:!1,previousWidth:Math.ceil(r.img.destWidth),previousHeight:Math.ceil(r.img.destHeight),width:Math.ceil(e),height:Math.ceil(i&&i!==0?i:t?parseFloat(o):r.img.destHeight),isAspectRatio:t||!1};r.trigger("resizing",l),r.editCompleteArgs=l,l.cancel?r.aspectHeight&&r.aspectWidth&&(r.aspectHeight=l.previousHeight,r.aspectWidth=l.previousWidth):this.resizeEventHandler(l)},d.prototype.resizeEventHandler=function(e){var i=this.parent,t,r=i.element.querySelector("#"+i.element.id+"_resizeWidth"),o=i.element.querySelector("#"+i.element.id+"_resizeHeight");if(e.isAspectRatio)if((this.resizedImgAngle==null||this.resizedImgAngle!==i.transform.degree)&&(this.resizedImgAngle=i.transform.degree,t=!0),t){i.notify("transform",{prop:"resizeImage",value:{width:e.width,height:0}});var a=i.img.destWidth,n=i.img.destHeight,s=void 0;if(o){s=parseFloat(r.value===""?r.placeholder:r.value);var l=s/(a/n),p=l%1>=.5||l%1<=-.5?Math.round(l):l<0?Math.ceil(l):Math.floor(l);if(F(o,"numerictextbox").value=p,o.value=p.toString()+" px",i.aspectHeight=p,r&&r.value===""){var h=parseFloat(o.value===""?o.placeholder:o.value);l=h/(n/a);var u=l%1>=.5||l%1<=-.5?Math.round(l):l<0?Math.ceil(l):Math.floor(l);F(r,"numerictextbox").value=u,r.value=u.toString()+" px",i.aspectWidth=u}}}else i.notify("transform",{prop:"resizeImage",value:{width:e.width,height:null}});else this.resizedImgAngle!==null&&this.resizedImgAngle!==i.transform.degree&&(this.resizedImgAngle=i.transform.degree,t=!0),t?(i.notify("transform",{prop:"setPreventDownScale",value:{bool:!0}}),i.notify("transform",{prop:"resizeCrop",value:{width:e.width,height:e.height}}),i.notify("undo-redo",{prop:"setPreventUR",value:{bool:!0}}),i.okBtn(null,!0),i.notify("undo-redo",{prop:"setPreventUR",value:{bool:!1}}),i.resizeSrc={startX:i.img.srcLeft,startY:i.img.srcTop,width:i.img.srcWidth,height:i.img.srcHeight},i.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"resize",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}),i.notify("transform",{prop:"setPreventDownScale",value:{bool:!1}}),i.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"resize",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}})):i.notify("transform",{prop:"resizeCrop",value:{width:e.width,height:e.height}});this.resizedImgAngle=i.transform.degree},d.prototype.straightenImage=function(e){var i=this.parent,t=i.activeObj.shape&&i.activeObj.shape.indexOf("crop-")>-1;i.toolbar&&i.toolbar.length===0&&i.notify("draw",{prop:"select",onPropertyChange:!1,value:{type:"custom",startX:null,startY:null,width:null,height:null}}),i.notify("toolbar",{prop:"performCropTransformClick",value:{shape:null}}),i.setStraighten(e),t||i.okBtn()},d}(),fi=function(){function d(e){this.undoRedoStep=0,this.undoRedoColl=[],this.appliedUndoRedoColl=[],this.tempUndoRedoColl=[],this.tempUndoRedoStep=0,this.isPreventing=!1,this.parent=e,this.addEventListener()}return d.prototype.destroy=function(){this.parent.isDestroyed||this.removeEventListener()},d.prototype.addEventListener=function(){this.parent.on("undo-redo",this.undoRedo,this),this.parent.on("destroyed",this.destroy,this)},d.prototype.removeEventListener=function(){this.parent.off("undo-redo",this.undoRedo),this.parent.off("destroyed",this.destroy)},d.prototype.initializeUrPvtProp=function(){this.parent.lowerCanvas&&(this.lowerContext=this.parent.lowerCanvas.getContext("2d")),this.parent.upperCanvas&&(this.upperContext=this.parent.upperCanvas.getContext("2d"))},d.prototype.undoRedo=function(e){switch(this.initializeUrPvtProp(),e.prop){case"updateUndoRedoColl":this.updateUrc(e.value.operation,e.value.previousObj,e.value.previousObjColl,e.value.previousPointColl,e.value.previousSelPointColl,e.value.previousCropObj,e.value.previousText,e.value.currentText,e.value.previousFilter,e.value.isCircleCrop);break;case"refreshUrc":this.refreshUrc(e.value.bool);break;case"updateCurrUrc":this.updateCurrUrc(e.value.type,e.value.isCancel);break;case"call-undo":this.callUndo();break;case"call-redo":this.callRedo();break;case"undo":this.undo();break;case"redo":this.redo();break;case"updateUrObj":this.updateUrObj(e.value.objColl,e.value.operation);break;case"updateUndoRedo":this.updateUndoRedo(e.value?e.value.operation:null);break;case"getAppliedUndoRedoColl":e.value.obj.appliedUndoRedoColl=this.appliedUndoRedoColl;break;case"getUndoRedoStep":e.value.obj.undoRedoStep=this.undoRedoStep;break;case"setUndoRedoStep":this.undoRedoStep=e.value.step;break;case"undoDefault":this.undoDefault(e.value.obj);break;case"setPreventUR":this.isPreventing=e.value.bool;break;case"updateUndoRedoStack":e.value&&e.value.isPenDraw?this.updateUndoRedoStack(e.value.isPenDraw):this.updateUndoRedoStack();break;case"reset":this.reset();break}},d.prototype.getModuleName=function(){return"undo-redo"},d.prototype.reset=function(){this.tempCurrSelPoint=null,this.undoRedoStep=0,this.undoRedoColl=[],this.appliedUndoRedoColl=[],this.tempActObj=null,this.tempUndoRedoColl=[],this.tempUndoRedoStep=0,this.isPreventing=!1},d.prototype.refreshUrc=function(e){var i=this.parent;i.isImageUpdated||(e=e||!1,e&&(i.notify("toolbar",{prop:"setEnableDisableUndoRedo",value:{isPrevent:!0}}),this.tempUndoRedoColl=f([],this.appliedUndoRedoColl,[],!0),this.tempUndoRedoStep=this.undoRedoStep),i.notify("toolbar",{prop:"setEnableDisableUndoRedo",value:{isPrevent:!1}}),this.undoRedoColl=this.undoRedoColl.slice(0,this.undoRedoStep),this.appliedUndoRedoColl=this.appliedUndoRedoColl.slice(0,this.undoRedoStep),i.isUndoRedo=i.currObjType.isUndoAction=!1,i.notify("toolbar",{prop:"enable-disable-btns"}))},d.prototype.updateCurrUrc=function(e,i){var t=this.parent;if(!(t.isResize||this.isPreventing||t.noPushUndo)){if(t.notify("toolbar",{prop:"setEnableDisableUndoRedo",value:{isPrevent:!1}}),e==="ok"){t.notify("draw",{prop:"setShapeTextInsert",onPropertyChange:!1,value:{bool:!1}});var r=this.tempUndoRedoColl.length>0?f([],this.tempUndoRedoColl,[],!0):f([],this.undoRedoColl,[],!0),o=this.undoRedoColl[this.undoRedoColl.length-1],a=this.appliedUndoRedoColl[this.appliedUndoRedoColl.length-1],n=o?f({},o.previousObj,{},!0):null;if(C(a)?this.undoRedoColl[0]&&(o.previousCropObj=r[0].previousCropObj,o.previousObj=r[0].previousObj,o.previousObjColl=r[0].previousObjColl,o.previousPointColl=r[0].previousPointColl,o.previousText=r[0].previousText):o.operation!=="imageHFlip"&&o.operation!=="imageVFlip"&&(o.previousCropObj=a.currentCropObj,o.previousObj=a.currentObj,o.previousObjColl=a.currentObjColl,o.previousPointColl=a.currentPointColl,o.previousText=a.currentText,o.operation==="frame"&&o.previousObj&&n&&(o.previousObj.defaultZoom=n.defaultZoom,o.previousObj.zoomFactor=n.zoomFactor,o.previousObj.cropZoom=n.cropZoom)),o){if(o.operation!=="imageHFlip"&&o.operation!=="imageVFlip"){var s=this.getZeroZoomObjPointValue(o.currentObjColl,o.currentPointColl);o.currentObjColl=s.obj,o.currentPointColl=s.point;var l={adjustmentLevel:null};t.notify("filter",{prop:"getAdjustmentLevel",onPropertyChange:!1,value:{obj:l}}),o.currentObj.adjustmentLevel=f({},l.adjustmentLevel,{},!0),t.notify("filter",{prop:"setTempAdjVal"}),o.currentObj.currentFilter=t.currentFilter}this.appliedUndoRedoColl.push(o),i||this.triggerActionCompletedEvent(o.operation)}this.tempUndoRedoColl=[],this.tempUndoRedoStep=0}else this.tempUndoRedoColl.length>0&&(this.appliedUndoRedoColl=f([],this.tempUndoRedoColl,[],!0),this.undoRedoStep=this.tempUndoRedoStep,this.tempUndoRedoColl=[],this.tempUndoRedoStep=0);var p=this.appliedUndoRedoColl[this.appliedUndoRedoColl.length-1],h=this.appliedUndoRedoColl[this.appliedUndoRedoColl.length-2];if(this.appliedUndoRedoColl.length>16)this.appliedUndoRedoColl.splice(0,1);else if(!i&&p&&h){if((p.operation==="shapeTransform"&&h.operation==="shapeTransform"||p.operation==="shapeInsert"&&h.operation==="shapeInsert")&&JSON.stringify(p.currentObjColl)===JSON.stringify(h.currentObjColl)||p.operation==="freehand-draw"&&h.operation==="freehand-draw"&&JSON.stringify(p.currentPointColl)===JSON.stringify(h.currentPointColl)||p.operation==="freehanddrawCustomized"&&h.operation==="freehanddrawCustomized"&&JSON.stringify(p.currentPointColl)===JSON.stringify(h.currentPointColl))this.appliedUndoRedoColl.splice(this.appliedUndoRedoColl.length-1,1);else if(this.undoRedoStep!==this.appliedUndoRedoColl.length-1&&(p=this.appliedUndoRedoColl[this.appliedUndoRedoColl.length-1],h=this.appliedUndoRedoColl[this.undoRedoStep],p&&h&&p.operation==="shapeTransform"&&h.operation==="shapeTransform"&&JSON.stringify(p.currentObjColl)===JSON.stringify(h.previousObjColl))){this.appliedUndoRedoColl.splice(this.appliedUndoRedoColl.length-1,1),this.undoRedoColl=[],this.undoRedoColl=f([],this.appliedUndoRedoColl,[],!0);return}}this.undoRedoColl=[],this.undoRedoColl=f([],this.appliedUndoRedoColl,[],!0),e==="ok"&&(this.undoRedoStep=this.undoRedoColl.length,t.notify("toolbar",{prop:"enable-disable-btns"})),t.transform.zoomFactor>0&&(t.togglePan=!0,t.notify("selection",{prop:"setDragCanvas",value:{bool:!0}}))}},d.prototype.triggerActionCompletedEvent=function(e){var i=this.parent,t={brightness:"fine-tune",contrast:"fine-tune",hue:"fine-tune",saturation:"fine-tune",opacity:"fine-tune",blur:"fine-tune",exposure:"fine-tune",default:"filter",chrome:"filter",cold:"filter",warm:"filter",grayscale:"filter",sepia:"filter",invert:"filter",deleteObj:"shape-delete",deleteFreehandDrawing:"freehand-draw-delete",shapeInsert:"shape-insert",shapeTransform:"shape-customize",freehanddrawCustomized:"freehand-draw-customize"},r=t[e]||e,o={action:r,actionEventArgs:i.editCompleteArgs};i.triggerEditCompleteEvent(o)},d.prototype.getUndoRedoAction=function(e){var i={brightness:"fine-tune",contrast:"fine-tune",hue:"fine-tune",saturation:"fine-tune",opacity:"fine-tune",blur:"fine-tune",exposure:"fine-tune",default:"filter",chrome:"filter",cold:"filter",warm:"filter",grayscale:"filter",sepia:"filter",invert:"filter",deleteObj:"shape-delete",deleteFreehandDrawing:"freehand-drawing-delete",shapeInsert:"shape-insert",shapeTransform:"shape-customize",imageRotate:"shape-customize",freehanddraw:"freehand-draw",freehanddrawCustomized:"freehand-draw-customize",textAreaCustomization:"text-area-customization",imageHFlip:"shape-customize",imageVFlip:"shape-customize",bgColor:"background-color",updateImage:"image-update"};return i[e]||e},d.prototype.cancelCropSelection=function(){var e=this.parent,i=!1,t;e.activeObj.shape&&(t=e.activeObj.shape.split("-")),(e.currObjType.isCustomCrop||t&&t[0]==="crop")&&(i=!0),i&&e.notify("draw",{prop:"performCancel",value:{isContextualToolbar:null}}),(this.tempUndoRedoColl.length!==0||this.tempUndoRedoStep!==0)&&(this.appliedUndoRedoColl=f([],this.tempUndoRedoColl,[],!0),this.undoRedoColl=f([],this.tempUndoRedoColl,[],!0),this.undoRedoStep=this.tempUndoRedoStep,this.tempUndoRedoColl=[],this.tempUndoRedoStep=0,e.notify("toolbar",{prop:"setEnableDisableUndoRedo",value:{isPrevent:!1}}))},d.prototype.refreshToolbarActions=function(){var e=this.parent;e.activeObj.shape?(e.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"shapes",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}),e.notify("toolbar",{prop:"update-toolbar-items",onPropertyChange:!1})):e.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1})},d.prototype.applyCurrentChanges=function(){var e=this.parent;e.currObjType.isFiltered=!1,e.transform.zoomFactor===0&&(e.togglePan=!1,e.notify("selection",{prop:"setDragCanvas",value:{bool:!1}})),e.element.querySelector(".e-contextual-toolbar-wrapper")&&e.element.querySelector(".e-contextual-toolbar-wrapper").classList.add("e-hide"),e.togglePen&&(e.togglePen=!1,e.upperCanvas.style.cursor=e.cursor="default",this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height)),this.appliedUndoRedoColl.length>0&&(this.undoRedoColl=f([],this.appliedUndoRedoColl,[],!0))},d.prototype.callUndo=function(){this.applyCurrentChanges(),this.undo()},d.prototype.callRedo=function(){this.applyCurrentChanges(),this.redo()},d.prototype.undo=function(){var e=this.parent;if(this.cancelCropSelection(),e.notify("draw",{prop:"resetFrameZoom",onPropertyChange:!1,value:{isOk:!1}}),!e.disabled&&e.isImageLoaded&&this.undoRedoStep>0){this.refreshToolbarActions(),e.activeObj.activePoint&&e.activeObj.activePoint.width!==0&&(this.tempActObj=e.activeObj),e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.undoRedoStep--,e.notify("toolbar",{prop:"enable-disable-btns"}),e.element.querySelector(".e-contextual-toolbar-wrapper")&&e.element.querySelector(".e-contextual-toolbar-wrapper").classList.add("e-hide"),e.isUndoRedo=!0;var i=this.undoRedoColl[this.undoRedoStep];this.undoRedoColl.length===this.undoRedoStep?e.currObjType.isUndoAction=!1:e.currObjType.isUndoAction=!0,i.operation!=="textAreaCustomization"&&(e.textArea.style.display==="block"||e.textArea.style.display==="inline-block")&&(e.textArea.style.display="none"),e.notify("draw",{prop:"setCancelAction",onPropertyChange:!1,value:{bool:!0}});var t=void 0;e.cropObj=f({},i.previousCropObj,{},!0),e.afterCropActions=i.previousObj.afterCropActions,this.lowerContext.filter=i.previousObj.filter,e.notify("filter",{prop:"setAdjustmentLevel",onPropertyChange:!1,value:{adjustmentLevel:i.previousObj.adjustmentLevel}}),e.notify("filter",{prop:"setTempAdjVal"}),e.currentFilter=i.previousObj.currentFilter,e.notify("filter",{prop:"setTempFilVal"}),e.canvasFilter=this.lowerContext.filter,e.initialAdjustmentValue=this.lowerContext.filter,e.notify("filter",{prop:"setBevelFilter",onPropertyChange:!1,value:{bevelFilter:this.lowerContext.filter}});var r={action:this.getUndoRedoAction(i.operation)};switch(i.operation){case"shapeTransform":case"brightness":case"contrast":case"hue":case"saturation":case"opacity":case"blur":case"exposure":case"default":case"chrome":case"cold":case"warm":case"grayscale":case"blackandwhite":case"sepia":case"invert":case"sharpen":case"imageRotate":case"shapeInsert":this.shapeTransform(i.previousObjColl,i.previousPointColl);break;case"freehanddraw":case"freehand-draw":this.updateFreehandDraw(i.previousPointColl,i.previousSelPointColl),e.notify("freehand-draw",{prop:"setCurrentFreehandDrawIndex",value:{value:e.pointColl.length}});break;case"freehanddrawCustomized":this.updateFreehandDrawCustomized(i.previousObjColl,i.previousPointColl);break;case"deleteFreehandDrawing":case"deleteObj":this.updateDelete(i.operation,i.previousObjColl,i.previousPointColl,i.previousSelPointColl);break;case"textAreaCustomization":this.shapeTransform(i.previousObjColl,i.previousPointColl),this.updateTextAreaCustomization(t,i.previousObjColl);break;case"text":this.updateText(i.previousObjColl,!0);break;case"frame":e.transform.zoomFactor=e.transform.defaultZoomFactor=i.previousObj.defaultZoom,e.setProperties({zoomSettings:{zoomFactor:i.previousObj.zoomFactor}},!0),e.notify("transform",{prop:"setPreviousZoomValue",onPropertyChange:!1,value:{previousZoomValue:e.zoomSettings.zoomFactor}}),f(e.frameObj,i.previousObj.frameObj),e.notify("draw",{prop:"render-image",value:{isMouseWheel:!0,isPreventClearRect:null,isFrame:!0}});break;case"imageHFlip":this.imageFlip("horizontal",i.previousObjColl);break;case"imageVFlip":this.imageFlip("vertical",i.previousObjColl);break;case"bgColor":e.notify("draw",{prop:"imageBackgroundColor",onPropertyChange:!1,value:{color:i.previousObj.bgColor}}),e.notify("draw",{prop:"render-image",value:{isMouseWheel:!1}});break;case"updateImage":e.isImageUpdated=!0,e.baseImg.src=i.previousObj.imageSource,setTimeout(function(){e.cropObj.straighten!==0?(e.notify("toolbar",{prop:"performCropTransformClick",value:{shape:"crop-custom"}}),e.noPushUndo=!0,e.crop(),e.noPushUndo=!1):e.notify("draw",{prop:"render-image",value:{isMouseWheel:!1}}),e.isImageUpdated=!1});break;default:this.undoDefault(i,!0),e.notify("filter",{prop:"set-adjustment",value:{operation:i.operation}}),e.notify("filter",{prop:"update-filter",value:{operation:i.operation,filter:i.filter}});break}if(i.operation==="crop"){i.previousObj.currSelectionPoint&&(e.currSelectionPoint=f({},i.previousObj.currSelectionPoint,{},!0),e.currSelectionPoint&&C(e.currSelectionPoint.shape)&&(e.currSelectionPoint=null)),e.updateCropTransformItems(),e.notify("draw",{prop:"select",onPropertyChange:!1,value:{type:"custom",startX:null,startY:null,width:null,height:null}}),e.isCircleCrop&&(e.isCircleCrop=!1,this.tempCurrSelPoint=f({},e.currSelectionPoint,{},!0),e.currSelectionPoint=null);var o=e.cancelCropSelection.isCircleCrop;e.cancelCropSelection.isCircleCrop=!1,e.notify("draw",{prop:"performCancel",value:{isContextualToolbar:null,isUndoRedo:!0}}),e.cancelCropSelection.isCircleCrop=o,e.currObjType.isActiveObj=!1,e.transform.straighten!==0&&e.notify("draw",{prop:"setStraightenActObj",value:{activeObj:null}})}else i.operation==="resize"&&e.cropObj&&e.cropObj.activeObj&&(e.currSelectionPoint=f({},e.cropObj.activeObj,{},!0));this.undoRedoColl[this.undoRedoStep-1]&&this.undoRedoColl[this.undoRedoStep-1].isCircleCrop&&(e.isCircleCrop=!0,e.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}})),this.endUndoRedo(i.operation,!0);var a={action:"undo",actionEventArgs:r};e.triggerEditCompleteEvent(a)}},d.prototype.redo=function(){var e=this.parent;if(this.cancelCropSelection(),e.notify("draw",{prop:"resetFrameZoom",onPropertyChange:!1,value:{isOk:!1}}),!e.disabled&&e.isImageLoaded&&this.undoRedoStep<this.appliedUndoRedoColl.length){this.refreshToolbarActions(),this.undoRedoStep++,e.notify("toolbar",{prop:"enable-disable-btns"}),e.isUndoRedo=!0;var i=this.undoRedoColl[this.undoRedoStep-1];this.undoRedoColl.length===this.undoRedoStep?e.currObjType.isUndoAction=!1:e.currObjType.isUndoAction=!0,i.operation!=="textAreaCustomization"&&(e.textArea.style.display==="block"||e.textArea.style.display==="inline-block")&&(e.textArea.style.display="none"),e.notify("draw",{prop:"setCancelAction",onPropertyChange:!1,value:{bool:!0}}),e.cropObj=f({},i.currentCropObj,{},!0),e.afterCropActions=i.currentObj.afterCropActions,this.lowerContext.filter=i.currentObj.filter,e.element.querySelector(".e-contextual-toolbar-wrapper")&&e.element.querySelector(".e-contextual-toolbar-wrapper").classList.add("e-hide"),e.notify("filter",{prop:"setAdjustmentLevel",onPropertyChange:!1,value:{adjustmentLevel:i.currentObj.adjustmentLevel}}),e.notify("filter",{prop:"setTempAdjVal"}),e.currentFilter=i.currentObj.currentFilter,e.notify("filter",{prop:"setTempFilVal"}),e.canvasFilter=this.lowerContext.filter,e.initialAdjustmentValue=this.lowerContext.filter,e.notify("filter",{prop:"setBevelFilter",onPropertyChange:!1,value:{bevelFilter:this.lowerContext.filter}});var t=void 0,r={action:this.getUndoRedoAction(i.operation)};switch(i.operation){case"shapeTransform":case"brightness":case"contrast":case"hue":case"saturation":case"opacity":case"blur":case"exposure":case"default":case"chrome":case"cold":case"warm":case"grayscale":case"blackandwhite":case"sepia":case"invert":case"sharpen":case"imageRotate":case"shapeInsert":this.shapeTransform(i.currentObjColl,i.currentPointColl);break;case"freehanddraw":case"freehand-draw":this.updateFreehandDraw(i.currentPointColl,i.currentSelPointColl),e.notify("freehand-draw",{prop:"setCurrentFreehandDrawIndex",value:{value:e.pointColl.length}});break;case"freehanddrawCustomized":this.updateFreehandDrawCustomized(i.currentObjColl,i.currentPointColl);break;case"deleteFreehandDrawing":case"deleteObj":this.updateDelete(i.operation,i.currentObjColl,i.currentPointColl,i.currentSelPointColl);break;case"textAreaCustomization":this.shapeTransform(i.currentObjColl,i.currentPointColl),this.updateTextAreaCustomization(t,i.currentObjColl);break;case"text":this.updateText(i.currentObjColl,!1);break;case"frame":f(e.frameObj,i.currentObj.frameObj),e.notify("draw",{prop:"render-image",value:{isMouseWheel:!0,isPreventClearRect:null,isFrame:!0}});break;case"imageHFlip":this.imageFlip("horizontal",i.currentObjColl);break;case"imageVFlip":this.imageFlip("vertical",i.currentObjColl);break;case"bgColor":e.notify("draw",{prop:"imageBackgroundColor",onPropertyChange:!1,value:{color:i.currentObj.bgColor}}),e.notify("draw",{prop:"render-image",value:{isMouseWheel:!1}});break;case"updateImage":e.isImageUpdated=!0,e.baseImg.src=i.currentObj.imageSource,setTimeout(function(){e.cropObj.straighten!==0?(e.notify("toolbar",{prop:"performCropTransformClick",value:{shape:"crop-custom"}}),e.noPushUndo=!0,e.crop(),e.noPushUndo=!1):e.notify("draw",{prop:"render-image",value:{isMouseWheel:!1}}),e.isImageUpdated=!1});break;default:e.objColl=[],e.pointColl=[],e.freehandCounter=0,e.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:[]}}}),e.notify("draw",{prop:"setCurrentObj",onPropertyChange:!1,value:{obj:i.currentObj,isUndoRedo:!0}}),e.img.destLeft=i.currentObj.destPoints.startX,e.img.destTop=i.currentObj.destPoints.startY,t=f({},e.activeObj,{},!0),e.objColl=f([],i.currentObjColl,[],!0),e.pointColl=f([],i.currentPointColl,[],!0),e.freehandCounter=e.pointColl.length,e.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:f([],i.currentSelPointColl,[],!0)}}}),e.transform.straighten=0,this.lowerContext.filter="none",e.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),this.lowerContext.filter=i.currentObj.filter,e.prevStraightenedDegree=e.transform.straighten,e.activeObj=t,this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),e.activeObj.activePoint.width!==0&&e.activeObj.activePoint.height!==0&&e.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}}),e.notify("filter",{prop:"set-adjustment",value:{operation:i.operation}}),e.notify("filter",{prop:"update-filter",value:{operation:i.operation}});break}i.operation==="crop"&&i.isCircleCrop&&(e.isCircleCrop=!0,e.currSelectionPoint=f({},this.tempCurrSelPoint,{},!0),this.tempCurrSelPoint=null),i.operation==="crop"&&!i.isCircleCrop&&(e.isCircleCrop=!1),i.operation==="crop"&&i.currentObj.currSelectionPoint&&(e.currSelectionPoint=f({},i.currentObj.currSelectionPoint,{},!0),e.notify("draw",{prop:"setStraightenActObj",value:{activeObj:e.currSelectionPoint}})),e.currSelectionPoint&&C(e.currSelectionPoint.shape)&&(e.currSelectionPoint=null),i.operation==="resize"&&e.cropObj&&e.cropObj.activeObj&&(e.currSelectionPoint=f({},e.cropObj.activeObj,{},!0)),this.endUndoRedo(i.operation,!1);var o={action:"redo",actionEventArgs:r};e.triggerEditCompleteEvent(o)}},d.prototype.imageFlip=function(e,i){var t=this.parent;this.shapeTransform(i,null),t.activeObj=f({},t.objColl[t.objColl.length-1],{},!0);var r=t.activeObj,o=r.shape,a=r.isHorImageFlip,n=r.isVerImageFlip;t.objColl.pop(),o&&o==="image"?(e==="horizontal"?C(a)&&n?(t.activeObj.isHorImageFlip=!0,t.activeObj.isVerImageFlip=null,t.horizontalFlip(this.upperContext,!0)):(C(a)||!a?t.activeObj.isHorImageFlip=!0:t.activeObj.isHorImageFlip=null,t.horizontalFlip(this.upperContext,!0)):e==="vertical"&&(C(n)&&a?(t.activeObj.isVerImageFlip=!0,t.activeObj.isHorImageFlip=null,t.verticalFlip(this.upperContext,!0)):(C(n)||!n?t.activeObj.isVerImageFlip=!0:t.activeObj.isVerImageFlip=null,t.verticalFlip(this.upperContext,!0))),t.notify("shape",{prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:!0}})):t.notify("draw",{prop:"render-image",value:{isMouseWheel:!0}})},d.prototype.shapeTransform=function(e,i){var t=this.parent;t.objColl=f([],e,[],!0),i&&(t.pointColl=f([],i,[],!0),t.freehandCounter=t.pointColl.length),t.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),this.lowerContext.clearRect(0,0,t.lowerCanvas.width,t.lowerCanvas.height),this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),t.isUndoRedo=!0,t.notify("draw",{prop:"redrawImgWithObj",onPropertyChange:!1}),t.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1})},d.prototype.updateFreehandDraw=function(e,i){var t=this.parent;t.pointColl=e,t.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:i}}}),t.freehandCounter=t.pointColl.length,t.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),this.lowerContext.clearRect(0,0,t.lowerCanvas.width,t.lowerCanvas.height),this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),t.isUndoRedo=!0,t.notify("draw",{prop:"redrawImgWithObj",onPropertyChange:!1})},d.prototype.updateFreehandDrawCustomized=function(e,i){var t=this.parent;t.objColl=f([],e,[],!0),t.pointColl=i,t.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),this.lowerContext.clearRect(0,0,t.lowerCanvas.width,t.lowerCanvas.height),this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),t.isUndoRedo=!0,t.notify("draw",{prop:"redrawImgWithObj",onPropertyChange:!1})},d.prototype.updateDelete=function(e,i,t,r){var o=this.parent;e==="deleteFreehandDrawing"?(o.pointColl=t,o.freehandCounter=o.pointColl.length,o.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:r}}}),o.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}})):e==="deleteObj"&&(o.objColl=i,o.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}})),this.lowerContext.clearRect(0,0,o.lowerCanvas.width,o.lowerCanvas.height),this.upperContext.clearRect(0,0,o.upperCanvas.width,o.upperCanvas.height),o.isUndoRedo=!0,o.notify("draw",{prop:"redrawImgWithObj",onPropertyChange:!1})},d.prototype.updateTextAreaCustomization=function(e,i){var t=this.parent;t.objColl=f([],i,[],!0),t.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),this.lowerContext.clearRect(0,0,t.lowerCanvas.width,t.lowerCanvas.height),t.isUndoRedo=!0,t.notify("draw",{prop:"redrawImgWithObj",onPropertyChange:!1});for(var r=0,o=i.length;r<o;r++)if(this.tempActObj){if(this.tempActObj.currIndex===i[r].currIndex){e=f({},i[r],{},!0),t.objColl.splice(r,1);break}}else{e=f({},i[i.length-1],{},!0),t.objColl.splice(r,1);break}e&&this.updateTextBox(e),(t.textArea.style.display==="block"||t.textArea.style.display==="inline-block")&&t.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:null}})},d.prototype.updateText=function(e,i){var t=this.parent;if(this.tempActObj&&(t.activeObj=f({},this.tempActObj,{},!0)),e.length===0&&t.objColl.length===1)this.tempActObj=f({},t.objColl[0],{},!0);else for(var r=0,o=t.objColl.length;r<o;r++){if(t.objColl[r]&&C(e[r])){this.tempActObj=f({},t.objColl[r],{},!0);break}if(e[r].currIndex!==t.objColl[r].currIndex){this.tempActObj=f({},t.objColl[r],{},!0);break}}i&&(t.activeObj=f({},this.tempActObj,{},!0)),t.objColl=f([],e,[],!0),t.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:!0}}),this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),this.lowerContext.clearRect(0,0,t.lowerCanvas.width,t.lowerCanvas.height),t.isUndoRedo=!0,t.notify("draw",{prop:"redrawImgWithObj",onPropertyChange:!1}),t.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1})},d.prototype.updateTextBox=function(e){var i=this.parent;this.upperContext.clearRect(0,0,i.lowerCanvas.width,i.lowerCanvas.height),this.lowerContext.clearRect(0,0,i.lowerCanvas.width,i.lowerCanvas.height),i.notify("draw",{prop:"redrawImgWithObj",onPropertyChange:!1}),i.notify("toolbar",{prop:"destroy-qa-toolbar",onPropertyChange:!1});var t=i.textArea;t.style.display="block",t.style.fontFamily=e.textSettings.fontFamily,t.style.fontSize=e.textSettings.fontSize+"px",t.style.color=e.strokeSettings.strokeColor,t.style.fontWeight=e.textSettings.bold?"bold":"normal",t.style.fontStyle=e.textSettings.italic?"italic":"normal",t.style.border="2px solid "+i.themeColl[i.theme].primaryColor,t.value=e.keyHistory,i.activeObj=f({},e,{},!0),i.notify("shape",{prop:"updateFontStyles",onPropertyChange:!1,value:{isTextBox:null}}),i.textArea.style.width=i.activeObj.activePoint.width+"px"},d.prototype.undoDefault=function(e,i){this.lowerContext.filter=e.previousObj.filter;var t=this.parent;t.objColl=[],t.pointColl=[],t.freehandCounter=0,t.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:[]}}});var r=i?!1:e.isCircleCrop;t.notify("draw",{prop:"setCurrentObj",onPropertyChange:!1,value:{obj:e.previousObj,isUndoRedo:i,isCircleCrop:r}}),t.prevStraightenedDegree=t.transform.straighten,this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),t.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),t.img.destLeft=e.previousObj.destPoints.startX,t.img.destTop=e.previousObj.destPoints.startY;var o=f({},t.activeObj,{},!0);t.objColl=f([],e.previousObjColl,[],!0),t.pointColl=f([],e.previousPointColl,[],!0),t.freehandCounter=t.pointColl.length,t.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:f([],e.previousSelPointColl,[],!0)}}}),t.transform.straighten=0,this.lowerContext.filter="none",t.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),this.lowerContext.filter=e.previousObj.filter,t.activeObj=o,this.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),t.activeObj.activePoint.width!==0&&t.activeObj.activePoint.height!==0&&t.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}})},d.prototype.endUndoRedo=function(e,i){var t=this.parent,r={type:"none",color:"#fff",size:20,inset:20,offset:20,radius:0,amount:1,border:"solid",gradientColor:""};(t.currSelectionPoint&&t.currSelectionPoint.shape==="crop-circle"||t.isCircleCrop)&&JSON.stringify(t.frameObj)!==JSON.stringify(r)&&t.notify("draw",{prop:"render-image",value:{isMouseWheel:!0}}),t.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),t.isCircleCrop&&(i&&e!=="crop"||!i)&&t.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}}),t.transform.zoomFactor>0&&t.notify("selection",{prop:"setDragCanvas",value:{bool:!0}}),t.notify("draw",{prop:"setCancelAction",onPropertyChange:!1,value:{bool:!1}}),t.activeObj.shape&&t.activeObj.shape.split("-")[0]==="crop"?t.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:!0,isCropping:!0,isZooming:null,cType:null}}):t.notify("toolbar",{prop:"refresh-main-toolbar",onPropertyChange:!1}),t.notify("toolbar",{prop:"enable-disable-btns"}),document.getElementById(t.element.id+"_quickAccessToolbarArea")&&(document.getElementById(t.element.id+"_quickAccessToolbarArea").style.display="none"),t.notify("toolbar",{prop:"enable-disable-btns"}),t.transform.degree!==0&&t.notify("transform",{prop:"drawPannedImage",onPropertyChange:!1,value:{xDiff:0,yDiff:0}}),t.notify("filter",{prop:"setAdjustmentValue",onPropertyChange:!1,value:{adjustmentValue:this.lowerContext.filter}}),t.currObjType.isCustomCrop=!1},d.prototype.updateUrc=function(e,i,t,r,o,a,n,s,l,p){var h=this.parent;if(!(h.isResize||this.isPreventing)){var u={isInitialLoaded:!1};if(h.currObjType.isUndoAction&&this.refreshUrc(!0),h.notify("draw",{prop:"isInitialLoaded",onPropertyChange:!1,value:{object:u}}),!u.isInitialLoaded&&h.allowUndoRedo){var c={currObj:{}};h.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:c}});var g=c.currObj;g.objColl=f([],h.objColl,[],!0),g.pointColl=f([],h.pointColl,[],!0),g.afterCropActions=f([],h.afterCropActions,[],!0);var v={selPointColl:null};if(h.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:v}}),g.selPointColl=f([],v.selPointColl,[],!0),e==="crop")g.currSelectionPoint=f({},h.currSelectionPoint,{},!0);else if(e==="frame")i.destPoints={startX:h.frameDestPoints.destLeft,startY:h.frameDestPoints.destTop,width:h.frameDestPoints.destWidth,height:h.frameDestPoints.destHeight},g.destPoints={startX:h.frameDestPoints.destLeft,startY:h.frameDestPoints.destTop,width:h.frameDestPoints.destWidth,height:h.frameDestPoints.destHeight},C(h.tempFrameZoomLevel)||(i.defaultZoom=g.defaultZoom=h.tempFrameZoomLevel);else if((e==="imageHFlip"||e==="imageVFlip")&&this.appliedUndoRedoColl.length>0){var b=t[t.length-1].currIndex;if(t=this.appliedUndoRedoColl[this.appliedUndoRedoColl.length-1].currentObjColl,b){for(var m=0,y=t.length;m<y;m++)if(t[m].currIndex===b){var P=f({},t[m],{},!0);t.splice(m,1),t.push(P);break}}}this.undoRedoColl.push({operation:e,previousObj:i,currentObj:g,previousObjColl:t,currentObjColl:g.objColl,previousPointColl:r,currentPointColl:g.pointColl,previousSelPointColl:o,currentSelPointColl:g.selPointColl,previousCropObj:a,currentCropObj:f({},h.cropObj,{},!0),previousText:n,currentText:s,filter:l,isCircleCrop:p}),h.notify("toolbar",{prop:"enable-disable-btns",onPropertyChange:!1})}}},d.prototype.updateUrObj=function(e,i){var t=this.parent;if(t.allowUndoRedo){t.currObjType.isUndoAction&&!t.isShapeDrawing&&this.refreshUrc(!0),C(t.activeObj.imageRatio)&&t.notify("shape",{prop:"updImgRatioForActObj",onPropertyChange:!1}),t.objColl.push(t.activeObj);var r=f({},t.cropObj,{},!0),o={currObj:{}};t.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:o}});var a=o.currObj;a.objColl=f([],t.objColl,[],!0),a.pointColl=f([],t.pointColl,[],!0),a.afterCropActions=f([],t.afterCropActions,[],!0);var n={selPointColl:null};t.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:n}}),a.selPointColl=f([],n.selPointColl,[],!0);var s=i||"shapeTransform";this.undoRedoColl.push({operation:s,previousObj:a,currentObj:a,previousObjColl:e,currentObjColl:a.objColl,previousPointColl:a.pointColl,currentPointColl:a.pointColl,previousSelPointColl:a.selPointColl,currentSelPointColl:a.selPointColl,previousCropObj:r,currentCropObj:r}),t.notify("selection",{prop:"redrawShape",onPropertyChange:!1,value:{obj:t.objColl[t.objColl.length-1]}})}},d.prototype.updateUndoRedo=function(e){var i=this.parent,t=f({},i.cropObj,{},!0),r={currObj:{}};i.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:r}});var o=r.currObj;o.objColl=f([],i.objColl,[],!0),o.pointColl=f([],i.pointColl,[],!0),o.afterCropActions=f([],i.afterCropActions,[],!0);var a={selPointColl:null};i.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:a}}),o.selPointColl=f([],a.selPointColl,[],!0),C(i.activeObj.imageRatio)&&i.notify("shape",{prop:"updImgRatioForActObj",onPropertyChange:!1}),i.objColl.push(i.activeObj);var n=e||"shapeTransform";this.updateUrc(n,o,o.objColl,o.pointColl,o.selPointColl,t),i.objColl.pop(),i.notify("shape",{prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:null}}),i.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),i.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"shapes",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}),i.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}})},d.prototype.getZeroZoomObjPointValue=function(e,i){var t=this.parent;this.updateObjColl();var r={currObj:{}};t.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:r}});var o=r.currObj;o.objColl=f([],t.objColl,[],!0),o.pointColl=f([],t.pointColl,[],!0),o.afterCropActions=f([],t.afterCropActions,[],!0);var a={selPointColl:null};t.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:a}}),o.selPointColl=f([],a.selPointColl,[],!0);var n={cropDimension:null};t.notify("transform",{prop:"getCropDimension",onPropertyChange:!1,value:{obj:n}});var s=f([],t.objColl,[],!0),l=f([],t.pointColl,[],!0),p={arrowDimension:null};this.parent.notify("draw",{prop:"getArrowDimension",onPropertyChange:!1,value:{obj:p}});var h=f({},p.arrowDimension,{},!0);if(t.transform.zoomFactor>0&&(e.length>0||i.length>0)){if(e.length>0)for(var u=0;u<e.length;u++)e[u].currIndex||(e[u].currIndex="shape_"+(u+1));t.objColl=e,t.pointColl=i;var c=t.isUndoRedo,g=t.isCropTab;if(t.transform.zoomFactor!==0){t.isUndoRedo=!0,t.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:!0}}),t.notify("freehand-draw",{prop:"updateFHDColl",onPropertyChange:!1}),t.isCropTab=!0;var v=f({},t.zoomSettings,null,!0);t.transform.zoomFactor>0?t.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-t.transform.zoomFactor,zoomPoint:null,isResize:null}}):t.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:Math.abs(t.transform.zoomFactor),zoomPoint:null,isResize:null}}),t.zoomSettings=v,t.isCropTab=g,t.isUndoRedo=c,s=f([],t.objColl,[],!0),l=f([],t.pointColl,[],!0),t.objColl=[],t.pointColl=[],t.freehandCounter=0,t.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:[]}}}),t.notify("transform",{prop:"setCropDimension",onPropertyChange:!1,value:{width:n.cropDimension.width,height:n.cropDimension.height}});var b={width:n.cropDimension.width,height:n.cropDimension.height};b.width+=b.width*o.defaultZoom,b.height+=b.height*o.defaultZoom,t.notify("draw",{prop:"setZoomCropWidth",value:{width:b.width,height:b.height}}),t.notify("draw",{prop:"setCurrentObj",onPropertyChange:!1,value:{obj:o}}),t.img.destLeft=o.destPoints.startX,t.img.destTop=o.destPoints.startY,t.panPoint.totalPannedPoint=o.totalPannedPoint,t.panPoint.totalPannedClientPoint=o.totalPannedClientPoint,t.panPoint.totalPannedInternalPoint=o.totalPannedInternalPoint,t.objColl=f([],o.objColl,[],!0),t.pointColl=f([],o.pointColl,[],!0),t.freehandCounter=t.pointColl.length,t.notify("draw",{prop:"setArrowDimension",onPropertyChange:!1,value:{arrowDimension:h}}),t.notify("freehand-draw",{prop:"setSelPointColl",onPropertyChange:!1,value:{obj:{selPointColl:f([],o.selPointColl,[],!0)}}}),this.lowerContext.filter="none",t.transform.straighten=0,this.applyImgTranform(),t.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"iterate",pen:"iterate",isPreventApply:null}}),t.notify("freehand-draw",{prop:"updateFHDCurPts",onPropertyChange:!1}),this.lowerContext.filter=o.filter,t.transform.degree!==0&&t.notify("transform",{prop:"drawPannedImage",onPropertyChange:!1,value:{xDiff:0,yDiff:0}}),t.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),(t.isCircleCrop||t.currSelectionPoint&&t.currSelectionPoint.shape==="crop-circle")&&t.notify("crop",{prop:"cropCircle",onPropertyChange:!1,value:{context:this.lowerContext,isSave:null,isFlip:null}})}}return{obj:s,point:l}},d.prototype.updateObjColl=function(){for(var e=this.parent,i=0;i<e.objColl.length;i++){var t=e.objColl[i],r=!1;if((t.shape==="line"||t.shape==="arrow")&&(t.activePoint.width<0&&(t.activePoint.width=Math.abs(t.activePoint.width),r=!0),t.activePoint.height<0&&(t.activePoint.height=Math.abs(t.activePoint.height),r=!0),r)){var o=f({},e.activeObj,{},!0);e.activeObj=t,e.notify("shape",{prop:"updImgRatioForActObj",onPropertyChange:!1}),t=e.activeObj,e.activeObj=o}}},d.prototype.applyImgTranform=function(){for(var e=this.parent,i=f({},e.activeObj,{},!0),t=0,r=e.objColl.length;t<r;t++)if(e.objColl[t].shape==="image"){e.activeObj=f({},e.objColl[t],{},!0);var o=e.objColl[t].imageCanvas.getContext("2d");e.notify("selection",{prop:"applyTransformToImg",onPropertyChange:!1,value:{ctx:o}}),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),e.notify("selection",{prop:"setImageClarity",onPropertyChange:!1,value:{bool:!0}})}e.activeObj=i},d.prototype.updateUndoRedoStack=function(e){var i=this.parent;if(i.activeObj.currIndex&&i.activeObj.activePoint.width!==0||i.activeObj.activePoint.height!==0||i.activeObj.pointColl&&i.activeObj.pointColl.length>0||e){var t=i.textArea.style.display!=="none",r=i.noPushUndo;if(i.noPushUndo=!1,i.isUndoRedoStack=!0,e){var o=i.togglePen,a={freehandDrawSelectedId:null};i.notify("freehand-draw",{prop:"getFreehandDrawSelectedId",onPropertyChange:!1,value:{obj:a}}),i.okBtn(),i.noPushUndo=r,a.freehandDrawSelectedId?(i.noRedact=!0,i.selectShape(a.freehandDrawSelectedId)):i.freeHandDraw(!0),i.togglePen=o}else if(i.activeObj.currIndex){var n=i.activeObj.currIndex;i.okBtn(),i.noPushUndo=r,i.noRedact=!0,i.selectShape(n),i.drawingShape&&i.notify("selection",{prop:"setCurrentDrawingShape",onPropertyChange:!1,value:{value:i.drawingShape.toLowerCase()}}),t&&i.enableTextEditing()}i.isUndoRedoStack=!1}},d}(),Oe=function(){var d=function(e,i){return d=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,r){t.__proto__=r}||function(t,r){for(var o in r)r.hasOwnProperty(o)&&(t[o]=r[o])},d(e,i)};return function(e,i){d(e,i);function t(){this.constructor=e}e.prototype=i===null?Object.create(i):(t.prototype=i.prototype,new t)}}(),z=function(d,e,i,t){var r=arguments.length,o=r<3?e:t===null?t=Object.getOwnPropertyDescriptor(e,i):t,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(d,e,i,t);else for(var n=d.length-1;n>=0;n--)(a=d[n])&&(o=(r<3?a(o):r>3?a(e,i,o):a(e,i))||o);return r>3&&o&&Object.defineProperty(e,i,o),o},vi=function(d){Oe(e,d);function e(){return d!==null&&d.apply(this,arguments)||this}return z([X(null)],e.prototype,"allowedExtensions",void 0),z([X(null)],e.prototype,"minFileSize",void 0),z([X(null)],e.prototype,"maxFileSize",void 0),e}(ge),gi=function(d){Oe(e,d);function e(){return d!==null&&d.apply(this,arguments)||this}return z([X(null)],e.prototype,"brightness",void 0),z([X(null)],e.prototype,"contrast",void 0),z([X(null)],e.prototype,"hue",void 0),z([X(null)],e.prototype,"saturation",void 0),z([X(null)],e.prototype,"exposure",void 0),z([X(null)],e.prototype,"opacity",void 0),z([X(null)],e.prototype,"blur",void 0),e}(ge),Ci=function(d){Oe(e,d);function e(){return d!==null&&d.apply(this,arguments)||this}return z([X(null)],e.prototype,"zoomTrigger",void 0),z([X(1)],e.prototype,"minZoomFactor",void 0),z([X(10)],e.prototype,"maxZoomFactor",void 0),z([X(1)],e.prototype,"zoomFactor",void 0),z([X(null)],e.prototype,"zoomPoint",void 0),e}(ge),mi=function(d){Oe(e,d);function e(){return d!==null&&d.apply(this,arguments)||this}return z([X(!0)],e.prototype,"showCircle",void 0),z([X(null)],e.prototype,"strokeColor",void 0),z([X(null)],e.prototype,"fillColor",void 0),e}(ge),bi=function(d){Oe(e,d);function e(){return d!==null&&d.apply(this,arguments)||this}return z([X("Arial")],e.prototype,"default",void 0),z([X(null)],e.prototype,"items",void 0),e}(ge),yi=function(d){Oe(e,d);function e(t,r){var o=d.call(this,t)||this;return o.isImageLoaded=!1,o.activeObj={activePoint:{startX:0,startY:0,endX:0,endY:0,width:0,height:0},flipObjColl:[],triangle:[],triangleRatio:[],rotatedAngle:0,opacity:1,order:null},o.currObjType={shape:"",isDragging:!1,isActiveObj:!1,isText:!1,isInitialText:!1,isLine:!1,isInitialLine:!1,isCustomCrop:!1,isZoomed:!1,isUndoZoom:!1,isUndoAction:!1,isFiltered:!1,isSave:!1,isResize:!1,isRedact:!1},o.objColl=[],o.pointColl={},o.freehandCounter=0,o.points=[],o.togglePen=!1,o.togglePan=!1,o.img={destLeft:0,destTop:0,destWidth:0,destHeight:0,srcLeft:0,srcTop:0,srcWidth:0,srcHeight:0},o.rotateFlipColl=[],o.cropObj={cropZoom:0,defaultZoom:0,totalPannedPoint:{x:0,y:0},totalPannedClientPoint:{x:0,y:0},totalPannedInternalPoint:{x:0,y:0},tempFlipPanPoint:{x:0,y:0},activeObj:{},rotateFlipColl:[],degree:0,currFlipState:"",straighten:0,destPoints:{startX:0,startY:0,width:0,height:0},srcPoints:{startX:0,startY:0,width:0,height:0},filter:"",isBrightAdjust:!1,zoomFactor:0,previousZoomValue:0,aspectWidth:null,aspectHeight:null,frame:"none",straightenZoom:0,adjustmentLevel:{brightness:0,contrast:0,hue:0,opacity:100,saturation:0,blur:0,exposure:0,transparency:100,sharpen:!1,bw:!1},currentFilter:""},o.afterCropActions=[],o.transform={degree:0,currFlipState:"",zoomFactor:0,cropZoomFactor:null,defaultZoomFactor:0,straighten:0},o.panPoint={currentPannedPoint:{x:0,y:0},totalPannedPoint:{x:0,y:0},totalPannedInternalPoint:{x:0,y:0},totalPannedClientPoint:{x:0,y:0}},o.isUndoRedo=!1,o.isCropTab=!1,o.isCircleCrop=!1,o.fontSizeColl=[],o.initialAdjustmentValue="",o.currentFilter="",o.canvasFilter="brightness(1) contrast(100%) hue-rotate(0deg) saturate(100%) opacity(1) blur(0px) sepia(0%) grayscale(0%) invert(0%)",o.toolbarHeight=0,o.isPublicMethod=!1,o.isCropToolbar=!1,o.cursor="default",o.resizeSrc={startX:o.img.srcLeft,startY:o.img.srcTop,width:o.img.srcWidth,height:o.img.srcHeight},o.isResize=!1,o.isAspectRatio=!1,o.frameObj={type:"none",color:"#fff",size:20,inset:20,offset:20,radius:0,amount:1,border:"solid",gradientColor:""},o.tempFrameObj={type:"none",color:"#fff",size:20,inset:20,offset:20,radius:0,amount:1,border:"solid",gradientColor:""},o.allowDownScale=!0,o.gradientColor="",o.size=20,o.inset=0,o.offset=0,o.borderRadius=0,o.lineCount=0,o.prevStraightenedDegree=0,o.tempStraighten=0,o.isStraightening=!1,o.isFinetuning=!1,o.isZoomBtnClick=!1,o.isFinetuneBtnClick=!1,o.isFilterCanvasClick=!1,o.isFrameBtnClick=!1,o.isChangesSaved=!1,o.isShapeDrawing=!1,o.noPushUndo=!1,o.isUndoRedoStack=!1,o.shapeColl=[],o.isKBDNavigation=!1,o.isMaskImage=!1,o.tempObjColl=[],o.tempPointColl=[],o.tempShapeColl=[],o.isImageUpdated=!1,o.noRedact=!1,o.tempRedactBlur=50,o.tempRedactPixel=40,o.tempToolbarHeight=0,o.tempToolbar=[],i.Inject(oi,si,di,ci,li,Pi),i.Inject(fi),i.Inject(pi),i.Inject(ui),i.Inject(hi),r&&o.appendTo(r),o}i=e,e.prototype.requiredModules=function(){var t=[];return t.push({member:"crop",args:[this]}),t.push({member:"draw",args:[this]}),t.push({member:"selection",args:[this]}),t.push({member:"transform",args:[this]}),t.push({member:"export",args:[this]}),t.push({member:"toolbar-module",args:[this]}),t.push({member:"undo-redo",args:[this]}),t.push({member:"filter",args:[this]}),t.push({member:"shape",args:[this]}),t.push({member:"freehand-draw",args:[this]}),t},e.prototype.preRender=function(){this.element.id=this.element.id||Ie("ej2-image-editor"),this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),w.isDevice&&this.element.classList.add("e-device"),this.initializeThemeColl()},e.prototype.render=function(){if(this.isAngular){var t=this.element,r=t.cloneNode(!0);t.parentNode.replaceChild(r,t),this.element=r,St("ej2_instances",[this],this.element)}this.initialize()},e.prototype.getModuleName=function(){return"image-editor"},e.prototype.getPersistData=function(){return this.addOnPersist([])},e.prototype.onPropertyChanged=function(t,r){for(var o,a=0,n=Object.keys(t);a<n.length;a++){var s=n[a];switch(s){case"cssClass":r.cssClass&&je([this.element],r.cssClass.replace(/\s+/g," ").trim().split(" ")),t.cssClass&&we([this.element],t.cssClass.replace(/\s+/g," ").trim().split(" "));break;case"disabled":t.disabled?(this.element.classList.add("e-disabled"),this.unwireEvent()):(this.element.classList.remove("e-disabled"),this.wireEvent());break;case"height":this.element.style.height=t.height,this.update();break;case"width":this.element.style.width=t.width,this.update();break;case"theme":t.theme&&(this.theme&&this.theme!==""?this.theme=this.toPascalCase(this.theme):this.theme="Bootstrap5",this.upperContext.strokeStyle=this.themeColl[this.theme].primaryColor,this.upperContext.fillStyle=this.themeColl[this.theme].secondaryColor,this.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}));break;case"finetuneSettings":t.finetuneSettings&&(this.finetuneSettings=t.finetuneSettings,this.notify("filter",{prop:"update-finetunes"}));break;case"locale":t.locale&&(this.notify("toolbar",{prop:"setLocale",onPropertyChange:!1,value:{locale:t.locale}}),this.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}));break;case"allowUndoRedo":t.allowUndoRedo?this.allowUndoRedo=!0:this.allowUndoRedo=!1,this.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}});break;case"showQuickAccessToolbar":t.showQuickAccessToolbar?(this.showQuickAccessToolbar=!0,this.notify("toolbar",{prop:"create-qa-toolbar",onPropertyChange:!1}),o={freehandSelectedIndex:null},this.notify("freehand-draw",{prop:"getFreehandSelectedIndex",onPropertyChange:!1,value:{obj:o}}),this.activeObj.shape?this.notify("toolbar",{prop:"renderQAT",onPropertyChange:!1,value:{isPenEdit:null}}):o.freehandSelectedIndex&&this.notify("toolbar",{prop:"renderQAT",onPropertyChange:!1,value:{isPenEdit:!0}})):(this.showQuickAccessToolbar=!1,this.notify("toolbar",{prop:"destroy-qa-toolbar",onPropertyChange:!1}));break;case"zoomSettings":t.zoomSettings&&(this.zoomSettings.zoomTrigger=t.zoomSettings.zoomTrigger),C(this.zoomSettings.zoomTrigger)?(this.zoomSettings.zoomTrigger=U.MouseWheel|U.Pinch|U.Toolbar|U.Commands,this.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}})):(t.zoomSettings.zoomTrigger&U.Toolbar)===U.Toolbar&&this.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}});break;case"selectionSettings":t.selectionSettings&&(this.selectionSettings=t.selectionSettings,this.activeObj.shape&&(this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:this.activeObj}})));break;case"toolbar":t.toolbar&&(this.toolbar=t.toolbar,this.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}));break;case"toolbarTemplate":t.toolbarTemplate&&(this.notify("toolbar",{prop:"destroy-bottom-toolbar",onPropertyChange:!1}),this.notify("toolbar",{prop:"destroy-top-toolbar",onPropertyChange:!1}),this.element.appendChild(this.createElement("div",{id:this.element.id+"_toolbarArea",className:"e-toolbar-area"})),this.toolbarTemplateFn());break;case"quickAccessToolbarTemplate":t.quickAccessToolbarTemplate&&(this.notify("toolbar",{prop:"destroy-qa-toolbar",onPropertyChange:!1}),this.quickAccessToolbarTemplateFn());break;case"uploadSettings":t.uploadSettings?(this.uploadSettings=t.uploadSettings,this.uploadSettings.allowedExtensions?this.notify("draw",{prop:"setNullExtension",value:{extension:!1}}):(this.uploadSettings.allowedExtensions=".jpg, .jpeg, .png, .svg, .webp",this.notify("draw",{prop:"setNullExtension",value:{extension:!0}})),this.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}})):this.notify("draw",{prop:"setNullExtension",value:{extension:!0}}),this.updateDropInfoContent(this.element.querySelector(".e-ie-drop-info"));break}}},e.prototype.destroy=function(){var t=[];this.element.removeAttribute("tabindex");var r=this.element.querySelector("#"+this.element.id+"_saveDialog");r&&r.style.display==="block"&&F(document.getElementById(this.element.id+"_saveDialog"),"dialog").destroy(),this.cssClass&&(t=t.concat(this.cssClass.replace(/\s+/g," ").trim().split(" "))),je([this.element],t),this.element.getAttribute("class")||this.element.removeAttribute("class"),this.unwireEvent(),this.notify("toolbar",{prop:"destroySubComponents",onPropertyChange:!1}),this.notify("destroyed",null),d.prototype.destroy.call(this),this.element.innerHTML=""},e.prototype.initialize=function(){if(this.toolbarTemplate?(this.element.appendChild(this.createElement("div",{id:this.element.id+"_toolbarArea",className:"e-toolbar-area"})),this.toolbarTemplateFn()):(this.notify("toolbar",{prop:"create-toolbar",onPropertyChange:!1}),this.notify("toolbar",{prop:"create-contextual-toolbar",onPropertyChange:!1})),this.uploadSettings.allowedExtensions?this.notify("draw",{prop:"setNullExtension",value:{extension:!1}}):this.setProperties({uploadSettings:{allowedExtensions:".jpg, .jpeg, .png, .svg, .webp"}},!0),this.createCanvas(),this.element.offsetWidth>359&&this.element.querySelector(".e-ie-min-drop-content")&&this.element.querySelector(".e-ie-drop-content")&&(this.element.querySelector(".e-ie-min-drop-content").style.display="none",this.element.querySelector(".e-ie-drop-content").style.display="block"),this.createDropUploader(),this.showQuickAccessToolbar){var t=document.querySelector("#"+this.element.id+"_canvasWrapper");t.appendChild(this.createElement("div",{id:this.element.id+"_quickAccessToolbarArea",className:"e-quick-access-toolbar-area"}));var r=document.getElementById(this.element.id+"_quickAccessToolbarArea");r.style.position="absolute",r.style.display="none",this.activeObj&&(r.style.left=this.activeObj.activePoint.startX+"px",r.style.top=this.activeObj.activePoint.startY+"px"),r.style.width="100%"}this.quickAccessToolbarTemplate?this.quickAccessToolbarTemplateFn():this.notify("toolbar",{prop:"create-qa-toolbar",onPropertyChange:!1}),this.wireEvent(),this.lowerContext=this.lowerCanvas.getContext("2d"),this.upperContext=this.upperCanvas.getContext("2d"),this.inMemoryContext=this.inMemoryCanvas.getContext("2d"),this.lowerContext.filter=this.getDefaultFilter(),this.notify("filter",{prop:"setAdjustmentValue",onPropertyChange:!1,value:{adjustmentValue:this.lowerContext.filter}}),this.canvasFilter=this.lowerContext.filter,this.notify("toolbar",{prop:"setInitialAdjustmentValue",onPropertyChange:!1,value:{value:this.lowerContext.filter}}),this.cssClass&&we([this.element],this.cssClass.replace(/\s+/g," ").trim().split(" ")),this.element&&Re({target:this.element}),this.initializeZoomSettings(),this.imgSrc&&this.open(this.imgSrc)},e.prototype.createDropUploader=function(){var t=this,r=this,o=new Pe({dropArea:this.element.getElementsByClassName("e-canvas-wrapper")[0],allowedExtensions:this.uploadSettings.allowedExtensions,multiple:!1,selected:function(a){if(a.event.type==="change"||a.event.type==="drop"){var n=a.filesData[0].type,s="unsupported",l=t.getExtensionArray(),p=l.indexOf(n)>-1||n==="jpeg"&&(r.uploadSettings.allowedExtensions.indexOf("jpg")>-1||r.uploadSettings.allowedExtensions.indexOf("jpeg")>-1),h=a.filesData[0].size,u=r.uploadSettings.minFileSize&&h<r.uploadSettings.minFileSize||r.uploadSettings.maxFileSize&&h>r.uploadSettings.maxFileSize;(a.event.type==="change"||a.event.type==="drop"&&a.event.dataTransfer.files.length===1)&&p&&!u?t.notify("draw",{prop:"fileSelect",value:{inputElement:t.element.querySelector("#"+t.element.id+"_dropfileUpload"),args:a}}):(a.event.type==="drop"&&a.event.dataTransfer.files.length>1&&(s="multi-select-image"),t.showDialogPopup(s,!p))}}});o.appendTo("#"+this.element.id+"_dropfileUpload")},e.prototype.dlgCloseBtnClick=function(){F(document.getElementById(this.element.id+"_dialog"),"dialog").destroy()},e.prototype.showDialogPopup=function(t,r){var o="";this.element.querySelector("#"+this.element.id+"_dialog").style.display="block";var a,n={key:"DlgOK"};if(this.notify("toolbar",{prop:"getLocaleText",onPropertyChange:!1,value:{obj:n}}),t==="multi-select-image"){a={key:"ImageErrorDialogHeader"},this.notify("toolbar",{prop:"getLocaleText",onPropertyChange:!1,value:{obj:a}});var s={key:"ImageErrorDialogContent"};this.notify("toolbar",{prop:"getLocaleText",onPropertyChange:!1,value:{obj:s}}),o="<span>"+s.value+"</span>"}else{a={key:"AlertDialogHeader"},this.notify("toolbar",{prop:"getLocaleText",onPropertyChange:!1,value:{obj:a}});var s={key:"AlertDialogContent"};this.notify("toolbar",{prop:"getLocaleText",onPropertyChange:!1,value:{obj:s}});var l={key:"SupportText"};this.notify("toolbar",{prop:"getLocaleText",onPropertyChange:!1,value:{obj:l}});var p=this.getExtensionString(),h={key:"MinMaxSizeAlert"};this.notify("toolbar",{prop:"getLocaleText",onPropertyChange:!1,value:{obj:h}});var u={key:"And"};this.notify("toolbar",{prop:"getLocaleText",onPropertyChange:!1,value:{obj:u}});var c=void 0;this.uploadSettings.minFileSize&&this.uploadSettings.maxFileSize?c=" "+h.value+" <b> "+this.formatSizeUnits(this.uploadSettings.minFileSize)+" </b> "+u.value+" <b> "+this.formatSizeUnits(this.uploadSettings.maxFileSize)+" </b> ":this.uploadSettings.minFileSize?(h.key="MinSizeAlert",this.notify("toolbar",{prop:"getLocaleText",onPropertyChange:!1,value:{obj:h}}),c=" "+h.value+" <b> "+this.formatSizeUnits(this.uploadSettings.minFileSize)+" </b> "):this.uploadSettings.maxFileSize&&(h.key="MaxSizeAlert",this.notify("toolbar",{prop:"getLocaleText",onPropertyChange:!1,value:{obj:h}}),c=" "+h.value+" <b> "+this.formatSizeUnits(this.uploadSettings.maxFileSize)+" </b> "),r?o="<span>"+s.value+" "+l.value+"<b>"+p+"</b></span>":c&&(o="<span>"+s.value+" "+l.value+c+"</span>")}var g=new Je({header:a.value,closeOnEscape:!0,content:o,target:document.getElementById("target"),width:w.isDevice?"285px":"400px",isModal:!0,animationSettings:{effect:"Zoom"},close:this.dlgCloseBtnClick.bind(this),buttons:[{click:this.dlgCloseBtnClick.bind(this),buttonModel:{content:n.value}}]});g.appendTo("#"+this.element.id+"_dialog")},e.prototype.formatSizeUnits=function(t){var r="";return t>=1073741824?r=(t/1073741824).toFixed(2)+" GB":t>=1048576?r=(t/1048576).toFixed(2)+" MB":t>=1024?r=(t/1024).toFixed(2)+" KB":t>1?r=t+" bytes":t===1?r=t+" byte":r="0 bytes",r},e.prototype.getExtensionArray=function(){for(var t=["jpeg","jpg","png","svg","webp"],r=this.uploadSettings.allowedExtensions.split(","),o=[],a=0,n=r;a<n.length;a++)for(var s=n[a],l=s.trim(),p=0,h=t;p<h.length;p++){var u=h[p];if(l.indexOf(u)!==-1){o.push(u);break}}return o},e.prototype.getExtensionString=function(){var t={key:"And"};this.notify("toolbar",{prop:"getLocaleText",onPropertyChange:!1,value:{obj:t}});for(var r=this.getExtensionArray(),o="",a=0;a<r.length;a++){switch(a===r.length-1&&r.length>1&&!((r[a]==="jpeg"||r[a]==="jpg")&&o.indexOf("JPG")>-1)&&((r.length===2||r.length===3&&r.indexOf("jpeg")!==-1&&r.indexOf("jpg")!==-1)&&(o=o.replace(/,\s*$/,"")),o+=" "+t.value),r[a]){case"jpeg":case"jpg":o.indexOf("JPG")===-1&&(o+=" JPG,");break;case"png":o+=" PNG,";break;case"svg":o+=" SVG,";break;case"webp":o+=" WebP,";break}a===r.length-1&&(o=o.slice(0,-1))}return o},e.prototype.wireEvent=function(){I.add(document,"keydown",this.keyDownEventHandler,this),I.add(document,"keypress",this.keyUpEventHandler,this),I.add(this.upperCanvas,"mousedown",this.mouseDownEventHandler,this),I.add(this.upperCanvas,"mousemove",this.mouseMoveEventHandler,this),I.add(this.upperCanvas,"mouseup",this.mouseUpEventHandler,this),I.add(document,"mouseup",this.mouseUpEventHandler,this),I.add(this.lowerCanvas,"mousedown",this.canvasMouseDownHandler,this),I.add(this.lowerCanvas,"mousemove",this.canvasMouseMoveHandler,this),I.add(this.lowerCanvas,"mouseup",this.canvasMouseUpHandler,this),I.add(this.upperCanvas,"touchstart",this.touchStartHandler,this),I.add(this.lowerCanvas,"touchstart",this.touchStartHandler,this),I.add(this.lowerCanvas,"mousewheel DOMMouseScroll",this.handleScroll,this),I.add(this.upperCanvas,"mousewheel DOMMouseScroll",this.handleScroll,this),window.addEventListener("resize",this.windowResizeHandler.bind(this)),!w.isIos&&w.info.name!=="safari"&&screen.orientation.addEventListener("change",this.screenOrientation.bind(this)),this.notify("shape",{prop:"wireEvent",onPropertyChange:!1})},e.prototype.unwireEvent=function(){I.remove(document,"keydown",this.keyDownEventHandler),I.remove(document,"keypress",this.keyUpEventHandler),I.remove(this.upperCanvas,"mousedown",this.mouseDownEventHandler),I.remove(this.upperCanvas,"mousemove",this.mouseMoveEventHandler),I.remove(this.upperCanvas,"mouseup",this.mouseUpEventHandler),I.remove(document,"mouseup",this.mouseUpEventHandler),I.remove(this.lowerCanvas,"mousedown",this.canvasMouseDownHandler),I.remove(this.lowerCanvas,"mousemove",this.canvasMouseMoveHandler),I.remove(this.lowerCanvas,"mouseup",this.canvasMouseUpHandler),I.remove(this.upperCanvas,"touchstart",this.touchStartHandler),I.remove(this.lowerCanvas,"touchstart",this.touchStartHandler),I.remove(this.lowerCanvas,"mousewheel DOMMouseScroll",this.handleScroll),I.remove(this.upperCanvas,"mousewheel DOMMouseScroll",this.handleScroll),window.removeEventListener("resize",this.windowResizeHandler.bind(this)),!w.isIos&&w.info.name!=="safari"&&screen.orientation.removeEventListener("change",this.screenOrientation.bind(this)),this.notify("shape",{prop:"unWireEvent",onPropertyChange:!1}),this.notify("selection",{prop:"unWireEvent",onPropertyChange:!1})},e.prototype.createCanvas=function(){this.element.style.boxSizing="border-box";var t={toolbarHeight:0};this.notify("toolbar",{prop:"getToolbarHeight",value:{obj:t}});var r=t.toolbarHeight;this.toolbar&&this.toolbar.length>0&&this.toolbar.indexOf("Open")===-1&&(r=0),this.element.style.width=this.width,this.element.style.height=this.height;var o=this.createElement("div",{id:this.element.id+"_canvasWrapper",className:"e-canvas-wrapper"});o.style.cssText="height: "+(this.element.offsetHeight-r-2)+"px; width: "+(this.element.offsetWidth-2)+"px; position: relative; overflow: hidden; margin: 0 auto;";var a=this.element.appendChild(o),n={key:"DragText"};this.notify("toolbar",{prop:"getLocaleText",onPropertyChange:!1,value:{obj:n}});var s={key:"DropText"};this.notify("toolbar",{prop:"getLocaleText",onPropertyChange:!1,value:{obj:s}});var l={key:"BrowseText"};this.notify("toolbar",{prop:"getLocaleText",onPropertyChange:!1,value:{obj:l}});var p=this.createElement("div",{id:this.element.id+"_dropArea",className:"e-ie-drop-area"});p.style.position="relative";var h=this.createElement("span",{className:"e-ie-drop-icon e-icons e-image"});h.style.position="absolute";var u=this.createElement("span",{className:"e-ie-drop-content"});u.style.cssText="position: absolute; display: none;",u.textContent=n.value+" ";var c=this.createElement("span",{className:"e-ie-min-drop-content"});c.style.position="absolute",c.textContent=s.value+" ";var g=this.createElement("a",{id:this.element.id+"_dropBrowse",className:"e-ie-drop-browse"});g.textContent=l.value;var v=this.createElement("a",{id:this.element.id+"_dropBrowse",className:"e-ie-drop-browse"});v.textContent=l.value,u.appendChild(g),c.appendChild(v),g.href="",v.href="";var b=this.createElement("span",{className:"e-ie-drop-info",attrs:{position:"absolute"}});this.updateDropInfoContent(b);var m=p.appendChild(this.createElement("input",{id:this.element.id+"_dropfileUpload",className:"e-fileUpload e-image-upload"}));m.setAttribute("type","file"),m.setAttribute("accept","image/*"),p.appendChild(h),p.appendChild(u),p.appendChild(c),p.appendChild(b),a.appendChild(p),this.lowerCanvas=a.appendChild(this.createElement("canvas",{id:this.element.id+"_lowerCanvas",attrs:{name:"canvasImage"}})),this.maskCanvas=a.appendChild(this.createElement("canvas",{id:this.element.id+"_maskCanvas",attrs:{name:"canvasImage"}})),this.upperCanvas=a.appendChild(this.createElement("canvas",{id:this.element.id+"_upperCanvas",attrs:{name:"canvasImage"}})),this.inMemoryCanvas=this.createElement("canvas",{id:this.element.id+"_inMemoryCanvas",attrs:{name:"canvasImage"}}),this.baseImgCanvas=this.createElement("canvas",{id:this.element.id+"_baseImgCanvas",attrs:{name:"canvasImage"}}),this.textArea=a.appendChild(this.createElement("textarea",{id:this.element.id+"_textArea",className:"e-textarea",attrs:{name:"textArea"}}));var y=this.element.appendChild(this.createElement("div",{id:this.element.id+"_dialog",className:"e-dialog"}));y.style.display="none";var P=this.element.appendChild(this.createElement("input",{id:this.element.id+"_fileUpload",className:"e-fileUpload"}));P.setAttribute("type","file"),P.setAttribute("accept","image/*"),P.style.display="none",this.textArea.setAttribute("spellcheck","false"),this.textArea.style.lineHeight="normal",this.lowerCanvas.style.width=this.upperCanvas.style.width=this.maskCanvas.style.width=this.inMemoryCanvas.style.width="100%",this.lowerCanvas.style.height=this.upperCanvas.style.height=this.maskCanvas.style.height=this.inMemoryCanvas.style.height="100%",this.upperCanvas.style.position=this.lowerCanvas.style.position=this.maskCanvas.style.position=this.textArea.style.position="absolute",this.textArea.style.backgroundColor="transparent",this.textArea.style.display="none",this.maskCanvas.style.display=this.textArea.style.resize="none",this.lowerContext=this.lowerCanvas.getContext("2d"),this.baseImg=this.createElement("img",{id:this.element.id+"_orgImg",attrs:{name:"Image",crossorigin:"anonymous"}}),this.upperCanvas.style.cursor=this.cursor="default",this.upperCanvas.style.display="block",this.upperContext=this.upperCanvas.getContext("2d"),g.addEventListener("click",function(S){return S.preventDefault(),m.click(),!1}),v.addEventListener("click",function(S){return S.preventDefault(),m.click(),!1})},e.prototype.touchStartHandler=function(t){this.notify("selection",{prop:"touchStartHandler",onPropertyChange:!1,value:{e:t}})},e.prototype.mouseDownEventHandler=function(t){t.target.className!=="e-ie-drop-browse"&&this.notify("selection",{prop:"mouseDownEventHandler",onPropertyChange:!1,value:{e:t}})},e.prototype.mouseMoveEventHandler=function(t){this.notify("selection",{prop:"mouseMoveEventHandler",onPropertyChange:!1,value:{e:t}})},e.prototype.mouseUpEventHandler=function(t){t.target.className!=="e-ie-drop-browse"&&this.notify("selection",{prop:"mouseUpEventHandler",onPropertyChange:!1,value:{e:t}})},e.prototype.keyDownEventHandler=function(t){this.notify("selection",{prop:"keyDownEventHandler",onPropertyChange:!1,value:{e:t}})},e.prototype.keyUpEventHandler=function(t){(this.textArea.style.display==="block"||this.textArea.style.display==="inline-block")&&t.target.id===this.element.id+"_textArea"&&this.notify("selection",{prop:"textKeyDown",value:{e:t}})},e.prototype.canvasMouseDownHandler=function(t){t.target.className!=="e-ie-drop-browse"&&this.notify("selection",{prop:"canvasMouseDownHandler",onPropertyChange:!1,value:{e:t}})},e.prototype.canvasMouseMoveHandler=function(t){this.notify("selection",{prop:"canvasMouseMoveHandler",onPropertyChange:!1,value:{e:t}})},e.prototype.canvasMouseUpHandler=function(t){t.target.className!=="e-ie-drop-browse"&&this.notify("selection",{prop:"canvasMouseUpHandler",onPropertyChange:!1,value:{e:t}})},e.prototype.handleScroll=function(t){this.notify("selection",{prop:"handleScroll",onPropertyChange:!1,value:{e:t}})},e.prototype.adjustToScreen=function(){this.update()},e.prototype.screenOrientation=function(){w.isDevice&&setTimeout(this.adjustToScreen.bind(this),100)},e.prototype.windowResizeHandler=function(){!w.isDevice&&this.element.classList.contains("e-image-editor")&&this.adjustToScreen()},e.prototype.notifyResetForAllModules=function(){for(var t=this.requiredModules(),r=0;r<t.length;r++){var o=t[r].member;this.notify(o==="toolbar-module"?"toolbar":o,{prop:"reset",onPropertyChange:!1})}},e.prototype.allowShape=function(t,r){this.isPublicMethod=!0,this.applyShapes();var o={inRange:!1};return this.notify("shape",{prop:"isPointsInRange",onPropertyChange:!1,value:{x:t,y:r,obj:o}}),o.inRange},e.prototype.manageActiveAction=function(){this.applyShapes(),this.activeObj.shape&&this.activeObj.shape.indexOf("crop")>-1&&this.discard()},e.prototype.clearSelection=function(t){this.notify("selection",{prop:"clearSelection",onPropertyChange:!1,value:{resetCrop:t}})},e.prototype.crop=function(){var t={isCrop:!1};return this.notify("crop",{prop:"crop",onPropertyChange:!1,value:{obj:t}}),t.isCrop},e.prototype.flip=function(t){this.applyShapes(),this.updateImageTransformColl(t.toLowerCase()+"flip"),this.notify("transform",{prop:"flip",value:{direction:t}}),this.notify("draw",{prop:"redrawDownScale"}),this.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}});var r={action:"flip",actionEventArgs:this.editCompleteArgs};this.triggerEditCompleteEvent(r)},e.prototype.getImageData=function(t){t=C(t)?!0:t;var r;if(t){var o={canvas:null};this.applyShapes(),this.notify("export",{prop:"exportToCanvas",value:{object:o}}),r=o.canvas.getContext("2d").getImageData(0,0,o.canvas.width,o.canvas.height)}else this.isMaskImage&&this.element.getAttribute("data-value")==="mask-drawing"?(r=this.getData(!0),this.updateColl("reset")):(r=this.getData(),this.notify("draw",{prop:"render-image",value:{isMouseWheel:!1}}));return r},e.prototype.open=function(t,r,o){if(r=C(r)?!0:r,r){if(C(t))return;var a=document.getElementById(this.element.id+"_dropArea");a&&(a.style.display="none"),this.notify("draw",{prop:"open",value:{data:t}})}else this.updateImage(t,o?o.backgroundColor:null)},e.prototype.reset=function(){this.updateColl("reset");var t={isErrorImage:!1};if(this.notify("draw",{prop:"getErrorImage",value:{obj:t}}),!this.disabled&&!t.isErrorImage){this.clearContext(this.inMemoryContext),this.clearContext(this.lowerContext),this.clearContext(this.upperContext),this.notify("shape",{prop:"setRedactType",onPropertyChange:!1,value:{redactType:"blur"}}),this.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:!1,isCropping:!1,isZooming:null,cType:null}}),w.isDevice&&document.getElementById(this.element.id+"_bottomToolbar")&&(F(document.getElementById(this.element.id+"_bottomToolbar"),"toolbar").destroy(),this.notify("toolbar",{prop:"create-bottom-toolbar",onPropertyChange:!1}));var r=this.isImageLoaded;this.currObjType.isUndoAction=this.isUndoRedo=this.togglePan=this.togglePen=this.isImageLoaded=this.isFinetuning=!1,this.isCircleCrop=this.isCropTab=!1,this.objColl=[],this.transform.degree=0,this.upperCanvas.style.display="block",this.transform.currFlipState="",this.allowDownScale=!0,this.upperCanvas.style.cursor=this.cursor=this.lowerCanvas.style.cursor="default",this.lowerContext.lineWidth=this.upperContext.lineWidth=void 0,this.frameDestPoints=null,this.textArea.value=this.textArea.textContent="",this.textArea.style.display="none",this.lowerContext.filter=this.canvasFilter=this.getDefaultFilter(),this.img.destLeft=this.img.destTop=this.img.srcLeft=this.img.srcTop=0,this.img.destWidth=this.img.destHeight=this.img.srcWidth=this.img.srcHeight=null,this.currSelectionPoint=null,this.panPoint.currentPannedPoint={x:0,y:0},this.rotateFlipColl=[],this.points=[],this.pointColl={},this.freehandCounter=0,this.notify("draw",{prop:"resetPanPoints"}),this.lowerCanvas.style.left=this.upperCanvas.style.left="",this.fontSizeColl=[],this.lowerCanvas.style.top=this.upperCanvas.style.top="",this.lowerCanvas.style.maxWidth=this.upperCanvas.style.maxWidth="",this.lowerCanvas.style.maxHeight=this.upperCanvas.style.maxHeight="",this.transform.defaultZoomFactor=this.transform.zoomFactor=0,this.transform.cropZoomFactor=null,this.frameObj={type:"none",color:"#fff",size:20,inset:20,offset:20,radius:0,amount:1,border:"solid",gradientColor:""},this.tempFrameObj={type:"none",color:"#fff",size:20,inset:20,offset:20,radius:0,amount:1,border:"solid",gradientColor:""},this.currObjType={shape:"",isDragging:!1,isActiveObj:!1,isText:!1,isInitialText:!1,isLine:!1,isInitialLine:!1,isCustomCrop:!1,isZoomed:!1,isUndoZoom:!1,isUndoAction:!1,isFiltered:!1,isSave:!1,isResize:!1,isRedact:!1},this.cropObj={cropZoom:0,defaultZoom:0,totalPannedPoint:{x:0,y:0},totalPannedClientPoint:{x:0,y:0},totalPannedInternalPoint:{x:0,y:0},tempFlipPanPoint:{x:0,y:0},activeObj:{},rotateFlipColl:[],degree:0,currFlipState:"",straighten:0,zoomFactor:0,previousZoomValue:0,destPoints:{startX:0,startY:0,width:0,height:0},frame:"none",srcPoints:{startX:0,startY:0,width:0,height:0},filter:"",isBrightAdjust:!1,aspectWidth:null,aspectHeight:null,straightenZoom:0,adjustmentLevel:{brightness:0,contrast:0,hue:0,opacity:100,saturation:0,blur:0,exposure:0,transparency:100,sharpen:!1,bw:!1},currentFilter:""},this.afterCropActions=[],this.currentFilter="",this.tempFrameZoomLevel=null,this.cxtTbarHeight=null,this.straightenPoint=null,this.transform.straighten=0,this.cancelCropSelection=null,this.aspectWidth=this.aspectHeight=null,this.isResize=this.isMaskImage=!1,this.drawingShape=null,this.isShapeDrawing=this.noPushUndo=this.isUndoRedoStack=this.isKBDNavigation=!1,this.shapeColl=[],this.tempObjColl=[],this.tempPointColl=[],this.tempShapeColl=[],this.isImageUpdated=!1,this.tempToolbarHeight=0,this.tempToolbar=[],this.tempRedactBlur=50,this.tempRedactPixel=40;var o={initialZoomValue:!1};this.editCompleteArgs=null,this.isFinetuneBtnClick=!1,this.notify("draw",{prop:"getInitialZoomValue",onPropertyChange:!1,value:{obj:o}}),o.initialZoomValue&&this.setProperties({zoomSettings:{zoomFactor:o.initialZoomValue}},!0);var a=document.getElementById(this.element.id+"_quickAccessToolbarArea");a&&(a.style.display="none"),this.notifyResetForAllModules(),this.notify("filter",{prop:"update-finetunes"}),this.toolbarTemplate?this.toolbarHeight=this.element.querySelector("#"+this.element.id+"_toolbarArea").clientHeight:this.element.querySelector("#"+this.element.id+"_toolbar")&&(this.toolbarHeight=this.element.querySelector("#"+this.element.id+"_toolbar").clientHeight),this.notify("toolbar",{prop:"setToolbarHeight",value:{height:this.toolbarHeight}}),this.isImageLoaded=r,this.straightenBaseImageCanvas(),this.isImageLoaded=!1,this.notify("draw",{prop:"update-canvas",onPropertyChange:!1}),this.isImageLoaded=r,this.prevStraightenedDegree=0;var n=this.element.querySelector(".e-contextual-toolbar-wrapper");n&&n.classList.add("e-hide"),this.notify("toolbar",{prop:"refresh-dropdown-btn",value:{isDisabled:!1}}),this.notify("toolbar",{prop:"enable-disable-btns"});var s={bool:this.isStraightening};w.isDevice&&s.bool&&this.notify("crop",{prop:"resizeWrapper"});var l=this.element.querySelector("#"+this.element.id+"_saveDialog");l&&F(l,"dialog").close();var p={action:"reset",actionEventArgs:null};this.triggerEditCompleteEvent(p)}},e.prototype.rotate=function(t){var r={isRotate:!1};this.applyShapes(),(t===90||t===-90)&&this.updateImageTransformColl(t===90?"rotateright":"rotateleft"),this.notify("transform",{prop:"rotate",value:{degree:t,obj:r}}),this.notify("draw",{prop:"redrawDownScale"});var o={action:"rotate",actionEventArgs:this.editCompleteArgs};return this.triggerEditCompleteEvent(o),r.isRotate},e.prototype.export=function(t,r,o){this.applyShapes(),this.notify("export",{prop:"export",onPropertyChange:!1,value:{type:t,fileName:r,imgQuality:o}})},e.prototype.select=function(t,r,o,a,n){this.applyShapes(),this.notify("toolbar",{prop:"performCropTransformClick",value:{shape:"crop-"+t}}),this.notify("draw",{prop:"select",onPropertyChange:!1,value:{type:t,startX:r,startY:o,width:a,height:n}}),r&&o||a&&n?this.notify("draw",{prop:"select",onPropertyChange:!1,value:{type:t,startX:r,startY:o,width:a,height:n}}):this.cropObj={cropZoom:0,defaultZoom:0,totalPannedPoint:{x:0,y:0},totalPannedClientPoint:{x:0,y:0},totalPannedInternalPoint:{x:0,y:0},tempFlipPanPoint:{x:0,y:0},activeObj:{},rotateFlipColl:[],degree:0,currFlipState:"",straighten:0,zoomFactor:0,previousZoomValue:0,destPoints:{startX:0,startY:0,width:0,height:0},frame:"none",srcPoints:{startX:0,startY:0,width:0,height:0},filter:"",isBrightAdjust:!1,aspectWidth:null,aspectHeight:null,straightenZoom:0,adjustmentLevel:{brightness:0,contrast:0,hue:0,opacity:100,saturation:0,blur:0,exposure:0,transparency:100,sharpen:!1,bw:!1},currentFilter:""}},e.prototype.freeHandDraw=function(t){this.notify("freehand-draw",{prop:"freeHandDraw",onPropertyChange:!1,value:{value:t}})},e.prototype.freehandDraw=function(t){if(!this.disabled&&this.isImageLoaded){if(!t&&this.isMaskImage){this.discard();return}this.manageActiveAction(),this.freeHandDraw(t);var r={shapeSettingsObj:{}};this.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:r}});var o=r.shapeSettingsObj;o.type=se.FreehandDraw;var a={cancel:!1,action:"insert",previousShapeSettings:o,currentShapeSettings:o};this.notify("freehand-draw",{prop:"triggerShapeChanging",value:{shapeChangingArgs:a}})}},e.prototype.pan=function(t,r,o){this.applyShapes(),this.notify("transform",{prop:"pan",onPropertyChange:!1,value:{value:t,x:r,y:o}})},e.prototype.zoom=function(t,r){this.isZoomBtnClick=!0,this.notify("transform",{prop:"zoom",onPropertyChange:!1,value:{zoomFactor:t,zoomPoint:r}}),this.notify("draw",{prop:"redrawDownScale"})},e.prototype.drawEllipse=function(t,r,o,a,n,s,l,p,h){var u=!1,c=this.allowShape(t,r);return!this.disabled&&this.isImageLoaded&&(c||C(t)&&C(r))&&(u=!0,this.manageActiveAction(),this.notify("shape",{prop:"drawEllipse",onPropertyChange:!1,value:{x:t,y:r,radiusX:o,radiusY:a,strokeWidth:n,strokeColor:s,fillColor:l,degree:p,isSelected:h}}),this.editCompleted()),u},e.prototype.drawLine=function(t,r,o,a,n,s,l){var p=!1,h=this.allowShape(t,r);return!this.disabled&&this.isImageLoaded&&(h||C(t)&&C(r))&&(p=!0,this.manageActiveAction(),this.notify("shape",{prop:"drawLine",onPropertyChange:!1,value:{startX:t,startY:r,endX:o,endY:a,strokeWidth:n,strokeColor:s,isSelected:l}}),this.editCompleted()),p},e.prototype.drawArrow=function(t,r,o,a,n,s,l,p,h){var u=!1,c=this.allowShape(t,r);return!this.disabled&&this.isImageLoaded&&(c||C(t)&&C(r))&&(u=!0,this.manageActiveAction(),this.notify("shape",{prop:"drawArrow",onPropertyChange:!1,value:{startX:t,startY:r,endX:o,endY:a,strokeWidth:n,strokeColor:s,arrowStart:l,arrowEnd:p,isSelected:h}}),this.editCompleted()),u},e.prototype.drawPath=function(t,r,o,a){this.isPublicMethod=!0;var n={inRange:!1},s=!1;if(t&&t.length>0)for(var l=0;l<t.length&&!n.inRange;l++)this.notify("shape",{prop:"isPointsInRange",onPropertyChange:!1,value:{x:t[l].x,y:t[l].y,obj:n}});return!this.disabled&&this.isImageLoaded&&(n.inRange||C(t))&&(s=!0,this.manageActiveAction(),this.notify("shape",{prop:"drawPath",onPropertyChange:!1,value:{pointColl:t,strokeWidth:r,strokeColor:o,isSelected:a}}),this.editCompleted()),s},e.prototype.drawRectangle=function(t,r,o,a,n,s,l,p,h,u){var c=!1,g=this.allowShape(t,r);return!this.disabled&&this.isImageLoaded&&(g||C(t)&&C(r))&&(c=!0,this.manageActiveAction(),this.notify("shape",{prop:"drawRectangle",onPropertyChange:!1,value:{x:t,y:r,width:o,height:a,strokeWidth:n,strokeColor:s,fillColor:l,degree:p,isSelected:h,radius:u}}),this.editCompleted()),c},e.prototype.drawText=function(t,r,o,a,n,s,l,p,h,u,c,g,v,b){var m=!1,y=this.allowShape(t,r);return!this.disabled&&this.isImageLoaded&&(y||C(t)&&C(r))&&(m=!0,this.manageActiveAction(),this.notify("shape",{prop:"drawText",onPropertyChange:!1,value:{x:t,y:r,text:o,fontFamily:a,fontSize:n,bold:s,italic:l,color:p,isSelected:h,degree:u,fillColor:c,outlineColor:g,outlineWidth:v,transformCollection:b}}),this.editCompleted()),m},e.prototype.drawImage=function(t,r,o,a,n,s,l,p,h){var u=!1,c=this.allowShape(r,o);if(!this.disabled&&this.isImageLoaded&&(c||C(r)&&C(o))){this.manageActiveAction();var g=this.objColl.length;this.notify("shape",{prop:"drawImage",onPropertyChange:!1,value:{x:r,y:o,width:a,height:n,src:t,degree:l,isAspectRatio:s,opacity:p,isSelected:h}}),this.editCompleted(),this.objColl.length>g&&(u=!0)}return u},e.prototype.updateShape=function(t,r){var o={isSelected:!1},a=!1,n={bool:!1};if(C(t.id))t.strokeColor&&(this.activeObj.strokeSettings.strokeColor=t.strokeColor),t.fillColor&&(this.activeObj.strokeSettings.fillColor=t.fillColor),t.strokeWidth&&(this.activeObj.strokeSettings.strokeWidth=t.strokeWidth),t.index&&(this.activeObj.order=t.index),t.type==="FreehandDraw"&&t.strokeWidth&&this.notify("freehand-draw",{prop:"setPenStrokeWidth",onPropertyChange:!1,value:{value:t.strokeWidth}});else if(t.type.toLowerCase()==="text"&&(this.textArea.style.display==="block"||this.textArea.style.display==="inline-block")&&(this.okBtn(null,!0),a=!0),this.notify("shape",{prop:"selectShape",onPropertyChange:!1,value:{id:t.id,obj:o,isShape:!0}}),this.notify("selection",{prop:"getFreehandDrawEditing",onPropertyChange:!1,value:{obj:n}}),o.isSelected){var s=this.activeObj.textSettings.fontSize;if(this.notify("shape",{prop:"updateShapeChangeEventArgs",onPropertyChange:!1,value:{shapeSettings:t}}),this.activeObj.shape==="text"&&s){var l=this.activeObj.textSettings.fontSize-s;l!==0&&(this.activeObj.activePoint.height+=l,this.activeObj.activePoint.startY-=l/2,this.activeObj.activePoint.endY+=l/2,this.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:this.activeObj.activePoint,obj:this.activeObj,isMouseMove:null,x:null,y:null}}))}var p=f({},this.activeObj,{},!0);this.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.notify("draw",{prop:"render-image",value:{isMouseWheel:null,isPreventClearRect:null,isFrame:null}}),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),p.shape&&this.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:p}}),this.activeObj.shape==="text"&&this.notify("toolbar",{prop:"editText",onPropertyChange:!1}),n.bool&&this.notify("undo-redo",{prop:"setPreventUR",value:{bool:!0}}),this.okBtn(r,!0),n.bool&&this.notify("undo-redo",{prop:"setPreventUR",value:{bool:!1}}),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.editCompleteArgs={action:"shape-update",currentShapeSettings:t},this.editCompleted("shape-customize"),a&&this.enableTextEditing(),r&&(this.noRedact=!0,this.selectShape(t.id))}return o.isSelected},e.prototype.selectShape=function(t){this.applyShapes();var r={isSelected:!1};return this.notify("shape",{prop:"selectShape",onPropertyChange:!1,value:{id:t,obj:r,isShape:!0}}),this.editCompleted("shape-select"),this.noRedact=!1,r.isSelected},e.prototype.deleteShape=function(t){var r=this.getShapeSetting(t);r.type!=="Redact"&&(this.applyShapes(),this.notify("shape",{prop:"deleteShape",onPropertyChange:!1,value:{id:t,isShape:!0}}),this.editCompleted("shape-delete"))},e.prototype.getShapeSetting=function(t){this.applyShapes();var r={shapeDetails:null};this.notify("shape",{prop:"getShapeSetting",onPropertyChange:!1,value:{id:t,obj:r}}),this.notify("draw",{prop:"redrawDownScale"});var o=r.shapeDetails?r.shapeDetails:{};return o},e.prototype.getShapeSettings=function(){this.applyShapes();var t={shapeDetailsColl:[]};return this.notify("shape",{prop:"getShapeSettings",onPropertyChange:!1,value:{obj:t}}),this.notify("draw",{prop:"redrawDownScale"}),t.shapeDetailsColl.filter(function(r){return r.type!=="redact"})},e.prototype.getRedacts=function(){this.applyShapes();var t={shapeDetailsColl:[]};return this.notify("shape",{prop:"getRedactSettings",onPropertyChange:!1,value:{obj:t}}),this.notify("draw",{prop:"redrawDownScale"}),t.shapeDetailsColl.filter(function(r){return r.type!=="redact"})},e.prototype.selectRedact=function(t){this.applyShapes();var r={isSelected:!1};return this.notify("shape",{prop:"selectShape",onPropertyChange:!1,value:{id:t,obj:r,isRedact:!0}}),this.editCompleted("redact-select"),this.noRedact=!1,r.isSelected},e.prototype.deleteRedact=function(t){this.applyShapes(),this.notify("shape",{prop:"deleteShape",onPropertyChange:!1,value:{id:t,isRedact:!0}}),this.editCompleted("redact-delete")},e.prototype.updateRedact=function(t,r){this.applyShapes();var o={isSelected:!1};if(this.notify("shape",{prop:"selectShape",onPropertyChange:!1,value:{id:t.id,obj:o,isRedact:!0}}),o.isSelected){this.notify("shape",{prop:"updateShapeChangeEventArgs",onPropertyChange:!1,value:{shapeSettings:t}}),t.blurIntensity&&(this.activeObj.redactBlur=t.blurIntensity),t.pixelSize&&(this.activeObj.redactPixelate=t.pixelSize),this.activeObj.redactType=t.type.toLowerCase()==="blur"?"blur":"pixelate";var a=f({},this.activeObj,{},!0);this.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.notify("draw",{prop:"render-image",value:{isMouseWheel:null,isPreventClearRect:null,isFrame:null}}),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),a.shape&&this.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:a}}),this.okBtn(r,!0),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.editCompleteArgs={action:"redact-update",currentShapeSettings:t},this.editCompleted("redact-customize"),r&&this.selectRedact(t.id)}return o.isSelected},e.prototype.update=function(){this.notify("transform",{prop:"update"})},e.prototype.finetuneImage=function(t,r){!this.disabled&&this.isImageLoaded&&(this.manageActiveAction(),this.notify("filter",{prop:"finetuneImage",value:{value:r,option:t}}),this.editCompleteArgs={finetune:t,value:r},this.editCompleted("fine-tune"))},e.prototype.applyImageFilter=function(t){!this.disabled&&this.isImageLoaded&&(this.manageActiveAction(),this.notify("filter",{prop:"applyImageFilter",value:{option:t.toString()}}),this.editCompleteArgs={filter:t},this.editCompleted("filter"),this.canvasFilter=this.lowerContext.filter,this.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}}))},e.prototype.undo=function(){this.manageActiveAction(),this.notify("undo-redo",{prop:"undo",onPropertyChange:!1}),this.notify("draw",{prop:"redrawDownScale"})},e.prototype.redo=function(){this.manageActiveAction(),this.notify("undo-redo",{prop:"redo",onPropertyChange:!1}),this.notify("draw",{prop:"redrawDownScale"})},e.prototype.getImageDimension=function(){return{x:this.img.destLeft,y:this.img.destTop,width:this.img.destWidth,height:this.img.destHeight}},e.prototype.resize=function(t,r,o){var a=!1;if(t.toString().length<=4&&r.toString().length<=4&&(!this.isCircleCrop||o)){this.manageActiveAction(),this.notify("toolbar",{prop:"resizeClick",value:{bool:!1}});var n={startX:this.img.destLeft,startY:this.img.destTop,width:this.img.destWidth,height:this.img.destHeight};o?(this.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"resize",isApplyBtn:!1,isCropping:!1}}),this.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"resize",isApplyBtn:!1,isCropping:!1}})):this.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"resize",isApplyBtn:!1,isCropping:!1}});var s=this.element.querySelector("#"+this.element.id+"_resizeWidth"),l=this.element.querySelector("#"+this.element.id+"_resizeHeight");s&&l&&(F(s,"numerictextbox").value=Math.floor(t),s.value=Math.floor(t).toString()+" px",F(l,"numerictextbox").value=Math.floor(r),l.value=Math.floor(r).toString()+" px"),this.notify("transform",{prop:"resize",value:{width:t,height:r,isAspectRatio:o}}),n.startX!==this.img.destLeft||n.startY!==this.img.destTop||n.width!==this.img.destWidth||n.height!==this.img.destHeight?(a=!0,this.aspectWidth=t,this.aspectHeight=r,o&&(this.aspectHeight=null),this.okBtn(!1,!1,!0)):this.notify("draw",{prop:"performCancel",value:{isContextualToolbar:null}}),this.notify("draw",{prop:"redrawDownScale"})}return a},e.prototype.drawFrame=function(t,r,o,a,n,s,l,p,h){this.manageActiveAction();var u=!1,c={frameChangeEventArgs:null};r=r||"#fff",o=o||"",a=a||20,n=n||0,s=s||0,l=l||0,p=p||Ne.Solid,h=h||0;var g={type:this.toPascalCase(this.frameObj.type),color:this.frameObj.color,gradientColor:this.frameObj.gradientColor,size:this.frameObj.size,inset:this.frameObj.inset,offset:this.frameObj.offset,borderRadius:this.frameObj.radius,frameLineStyle:this.toPascalCase(this.frameObj.border),lineCount:this.frameObj.amount};f(this.tempFrameObj,this.frameObj),this.tempFrameZoomLevel=this.transform.zoomFactor,this.frameDestPoints=f({},this.img,{},!0),this.notify("toolbar",{prop:"frameToolbarClick"}),this.frameObj.type=t.toLowerCase(),this.frameObj.color=r,this.frameObj.gradientColor=o,this.frameObj.size=a,this.frameObj.inset=n,this.frameObj.offset=s,this.frameObj.radius=l,this.frameObj.border=p.toLowerCase(),this.frameObj.amount=h,this.notify("draw",{prop:"triggerFrameChange",value:{prevFrameSettings:g,obj:c}}),c.frameChangeEventArgs&&!c.frameChangeEventArgs.cancel?(this.notify("draw",{prop:"render-image",value:{isMouseWheel:null}}),JSON.stringify(this.frameObj)!==JSON.stringify(this.tempFrameObj)?(u=!0,this.okBtn()):this.tempFrameZoomLevel=null):(this.notify("draw",{prop:"performCancel",value:{isContextualToolbar:null}}),f(this.frameObj,this.tempFrameObj),this.tempFrameZoomLevel=null),this.notify("draw",{prop:"redrawDownScale"});var v=this.element.querySelector(".e-contextual-toolbar-wrapper");return v&&v.classList.add("e-hide"),u},e.prototype.straightenImage=function(t){var r=!1;return t>=-45&&t<=45&&(this.applyShapes(),r=!0,this.notify("transform",{prop:"straightenImage",value:{degree:t}}),this.notify("draw",{prop:"redrawDownScale"})),r},e.prototype.cloneShape=function(t){var r={isSelected:!1};return t.split("_")[0]==="shape"&&(this.notify("shape",{prop:"selectShape",onPropertyChange:!1,value:{id:t,obj:r}}),r.isSelected&&(this.notify("toolbar",{prop:"duplicateShape",onPropertyChange:!1,value:{isPreventUndoRedo:!1}}),this.okBtn(null,!0),this.notify("draw",{prop:"redrawDownScale"}))),r.isSelected},e.prototype.getImageFilter=function(t){var r=this.createElement("canvas"),o=r.getContext("2d");return this.notify("filter",{prop:"updateAdj",value:{type:t.toLowerCase(),value:null,isPreview:!0,ctx:o}}),o.filter},e.prototype.enableTextEditing=function(){var t=f({},this.activeObj,{},!0);t.order||(this.noPushUndo=!0,this.okBtn(),this.noPushUndo=!1,this.noRedact=!0,this.selectShape(t.currIndex),t.order=this.activeObj.order),this.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.notify("draw",{prop:"render-image",value:{isMouseWheel:null,isPreventClearRect:null,isFrame:!1}}),this.activeObj=t,this.notify("toolbar",{prop:"editText",onPropertyChange:!1})},e.prototype.canUndo=function(){var t=!1,r=this.getUndoRedoColl(),o=r.index;return o>0&&(t=!0),t},e.prototype.canRedo=function(){var t=!1,r=this.getUndoRedoColl(),o=r.undoRedoColl,a=r.index;return o&&o.length>0&&a<o.length-1&&(t=!0),a===o.length?t=!1:(a===0&&o.length>0||a>0)&&(t=!0),t},e.prototype.apply=function(){this.isMaskImage?this.discard():(this.updateColl("reset"),this.closeOverlayTbar(),this.okBtn(null,!0))},e.prototype.discard=function(){this.updateColl("reset"),this.notify("draw",{prop:"performCancel",value:{isContextualToolbar:this.closeOverlayTbar(),isFinalCancel:!0}})},e.prototype.enableShapeDrawing=function(t,r){if(r&&(this.drawingShape=t.toLowerCase(),this.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1})),t&&r){this.currObjType.shape=t.toLowerCase(),this.activeObj.shape=this.currObjType.shape,this.currObjType.isDragging=this.currObjType.isCustomCrop=!1,this.activeObj.shapeDegree=this.transform.degree,this.activeObj.shapeFlip=this.transform.currFlipState,this.activeObj.textFlip=this.transform.currFlipState,this.activeObj.flipObjColl=[];var o={order:null};this.notify("shape",{prop:"getNewOrder",onPropertyChange:!1,value:{obj:o}}),this.activeObj.order=o.order,this.notify("selection",{prop:"annotate",value:{shape:this.currObjType.shape}}),this.currObjType.shape==="text"?this.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"text",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}):this.currObjType.shape==="redact"?this.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"redact",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}):this.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"shapes",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}),this.notify("toolbar",{prop:"update-toolbar-items",onPropertyChange:!1})}else r||this.okBtn(null,!0)},e.prototype.bringToFront=function(t){this.noRedact=!0,this.selectShape(t)&&(this.updateShapeOrder(t,"bringToFront"),this.apply())},e.prototype.bringForward=function(t){this.noRedact=!0,this.selectShape(t)&&(this.updateShapeOrder(t,"bringForward"),this.apply())},e.prototype.sendToBack=function(t){this.noRedact=!0,this.selectShape(t)&&(this.updateShapeOrder(t,"sendToBack"),this.apply())},e.prototype.sendBackward=function(t){this.noRedact=!0,this.selectShape(t)&&(this.updateShapeOrder(t,"sendBackward"),this.apply())},e.prototype.clearImage=function(){this.reset(),this.isImageLoaded=!1,this.lowerContext.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height);var t=document.getElementById(this.element.id+"_bottomToolbar");w.isDevice&&t&&(document.getElementById(this.element.id+"_bottomToolbar").style.display="none"),this.notify("toolbar",{prop:"destroy-top-toolbar",onPropertyChange:!1}),this.notify("toolbar",{prop:"create-toolbar",onPropertyChange:!1}),this.notify("toolbar",{prop:"create-contextual-toolbar",onPropertyChange:!1});var r=document.getElementById(this.element.id+"_dropArea");r&&(r.style.display="block")},e.prototype.selectMaskImage=function(t,r){t=t||10,r=r||"#512da880",this.applyShapes(),this.isMaskImage=!0,this.updateColl("empty"),this.enableDisableToolbar(!0),this.update(),this.activeObj.strokeSettings.strokeWidth=t,this.notify("freehand-draw",{prop:"setPenStrokeWidth",onPropertyChange:!1,value:{value:t}}),this.activeObj.strokeSettings.strokeColor=r,this.notify("freehand-draw",{prop:"freeHandDraw",onPropertyChange:!1,value:{value:!0}}),this.maskCanvas.style.display="block"},e.prototype.enableDisableToolbar=function(t){var r,o=document.getElementById(this.element.id+"_toolbar");o&&(r=F(o,"toolbar"),r&&r.disable(t)),o=document.getElementById(this.element.id+"_bottomToolbar"),o&&(r=F(o,"toolbar"),r&&r.disable(t))},e.prototype.updateImage=function(t,r){var o=this;if(t||r||r===""){var a=f({},this.cropObj,{},!0),n={currObj:{}};this.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:n}});var s=n.currObj;s.objColl=f([],this.objColl,[],!0),s.pointColl=f([],this.pointColl,[],!0),s.afterCropActions=f([],this.afterCropActions,[],!0);var l={selPointColl:null};if(this.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:l}}),s.selPointColl=f([],l.selPointColl,[],!0),t){if(this.isImageUpdated=!0,typeof t!="string"){var p=this.createElement("canvas");p.width=t.width,p.height=t.height,p.getContext("2d").putImageData(t,0,0),t=p.toDataURL()}this.baseImg.src=t,setTimeout(function(){o.cropObj.straighten!==0?(o.notify("toolbar",{prop:"performCropTransformClick",value:{shape:"crop-custom"}}),o.noPushUndo=!0,o.crop(),o.noPushUndo=!1):o.notify("draw",{prop:"render-image",value:{isMouseWheel:!1}}),o.isImageUpdated=!1,r||(o.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"updateImage",previousObj:s,previousObjColl:s.objColl,previousPointColl:s.pointColl,previousSelPointColl:s.selPointColl,previousCropObj:a,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),o.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}}))},100)}(r||r==="")&&(this.notify("draw",{prop:"imageBackgroundColor",onPropertyChange:!1,value:{color:r}}),this.notify("draw",{prop:"render-image",value:{isMouseWheel:!1}}),t||(this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"bgColor",previousObj:s,previousObjColl:s.objColl,previousPointColl:s.pointColl,previousSelPointColl:s.selPointColl,previousCropObj:a,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}}))),t&&r&&(this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"updateImage",previousObj:s,previousObjColl:s.objColl,previousPointColl:s.pointColl,previousSelPointColl:s.selPointColl,previousCropObj:a,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}}))}},e.prototype.editCompleted=function(t){this.notify("draw",{prop:"redrawDownScale"});var r={action:t||"shape-insert",actionEventArgs:this.editCompleteArgs};this.triggerEditCompleteEvent(r)},e.prototype.updateColl=function(t){this.isMaskImage&&(t==="empty"?(this.tempToolbarHeight=this.toolbarHeight,this.tempToolbar=this.toolbar?f([],this.toolbar,[],!0):null,this.tempObjColl=f([],this.objColl,[],!0),this.tempPointColl=f([],this.pointColl,[],!0),this.tempShapeColl=f([],this.shapeColl,[],!0),this.objColl=[],this.pointColl=[],this.shapeColl=[],this.freehandCounter=0,this.notify("freehand-draw",{prop:"setCurrentFreehandDrawIndex",value:{value:0}}),this.notify("draw",{prop:"render-image",value:{isMouseWheel:!1}})):t==="reset"&&(this.objColl=this.tempObjColl,this.pointColl=this.tempPointColl,this.shapeColl=this.tempShapeColl,this.freehandCounter=this.pointColl.length,this.notify("freehand-draw",{prop:"setCurrentFreehandDrawIndex",value:{value:this.freehandCounter}}),this.enableDisableToolbar(!1),this.cropObj.straighten!==0&&(this.notify("toolbar",{prop:"performCropTransformClick",value:{shape:"crop-custom"}}),this.noPushUndo=!0,this.crop(),this.noPushUndo=!1),this.notify("draw",{prop:"render-image",value:{isMouseWheel:!1}}),this.isMaskImage=!1,this.upperContext.globalCompositeOperation="source-over",this.maskCanvas.style.display="none",this.activeObj.strokeSettings={strokeColor:"#fff",fillColor:"",strokeWidth:null,radius:null,outlineColor:"",outlineWidth:null},this.notify("shape",{prop:"setStrokeSettings",value:{strokeSettings:this.activeObj.strokeSettings,strokeColor:"#fff",fillColor:"",strokeWidth:null,outlineWidth:null}}),this.notify("freehand-draw",{prop:"setPenStrokeWidth",onPropertyChange:!1,value:{value:2}}),this.notify("freehand-draw",{prop:"setMasking",onPropertyChange:!1,value:{value:!1}})))},e.prototype.resetToolbar=function(){this.toolbarHeight!==this.tempToolbarHeight&&!(C(this.toolbar)||this.toolbar&&this.toolbar.length>0||!C(this.toolbarTemplate))&&(this.toolbarHeight=this.tempToolbarHeight,this.notify("toolbar",{prop:"setToolbarHeight",value:{height:this.toolbarHeight}}),this.toolbar=this.tempToolbar,this.toolbarTemplate||(this.notify("toolbar",{prop:"create-toolbar",onPropertyChange:!1}),this.notify("toolbar",{prop:"create-contextual-toolbar",onPropertyChange:!1})),this.update())},e.prototype.getData=function(t){t&&this.resetToolbar();var r=f([],this.objColl,null,!0),o=f([],this.pointColl,null,!0),a=f([],this.shapeColl,null,!0);if(t){this.notify("shape",{prop:"updateShapeColl",onPropertyChange:!1});for(var n=0;n<this.freehandCounter;n++)this.pointColl[n].strokeColor="#fff"}else this.objColl=[],this.pointColl=[],this.shapeColl=[],this.freehandCounter=0;var s=this.frameObj.type;this.frameObj.type="none";var l=this.aspectWidth,p=this.aspectHeight;this.aspectWidth=this.aspectHeight=null;var h=this.cropObj.straighten;this.togglePen=!1,this.notify("toolbar",{prop:"performCropTransformClick",value:{shape:"crop-custom"}});var u=f({},this.img,{},!0),c=f({},this.cropObj,{},!0),g=f({},this.activeObj,{},!0),v=f({},this.transform,{},!0),b=f({},this.panPoint,{},!0);h!==0&&this.setStraighten(0);var m=this.activeObj.activePoint;m.startX=this.img.destLeft,m.startY=this.img.destTop,m.width=this.img.destWidth,m.height=this.img.destHeight,m.endX=m.startX+m.width,m.endY=m.startY+m.height,this.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:m,obj:this.activeObj,isMouseMove:null,x:null,y:null}}),this.noPushUndo=!0,this.crop(),this.noPushUndo=!1,this.isCropTab=!1,this.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.notify("crop",{prop:"resetZoom",onPropertyChange:!1}),this.isCropTab=!0;var y=f([],this.afterCropActions,[],!0),P=f([],this.rotateFlipColl,[],!0);this.notify("crop",{prop:"revertTransform",value:{type:"initial",coll:P}});var S=this.getImageData();if(t){var O=this.createElement("canvas"),j=O.getContext("2d");if(O.width=S.width,O.height=S.height,j.fillRect(0,0,O.width,O.height),this.pointColl.length>0){var x={width:0,height:0};this.notify("crop",{prop:"calcRatio",onPropertyChange:!1,value:{obj:x,dimension:{width:O.width,height:O.height}}});var k=x;this.notify("export",{prop:"drawAnnotation",value:{context:j,ratio:k}})}this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),S=j.getImageData(0,0,O.width,O.height)}return this.notify("crop",{prop:"revertTransform",value:{type:"reverse",coll:P}}),this.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.afterCropActions=y,t||(this.objColl=r,this.pointColl=o,this.shapeColl=a,this.freehandCounter=this.pointColl.length),this.frameObj.type=s,this.aspectWidth=l,this.aspectHeight=p,this.notify("toolbar",{prop:"performCropTransformClick",value:{shape:"crop-custom"}}),h!==0&&this.setStraighten(h),this.img=u,this.cropObj=c,this.activeObj=g,this.transform=v,this.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:.1,zoomPoint:null,isResize:null}}),this.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-.1,zoomPoint:null,isResize:null}}),this.transform.degree!==0&&(this.panPoint.currentPannedPoint={x:b.totalPannedClientPoint.x,y:b.totalPannedClientPoint.y},this.notify("transform",{prop:"drawPannedImage",value:{xDiff:b.totalPannedClientPoint.x,yDiff:b.totalPannedClientPoint.y}}),this.panPoint.currentPannedPoint={x:0,y:0},this.notify("transform",{prop:"setTempPanMove",value:{point:null}})),this.noPushUndo=!0,this.crop(),this.noPushUndo=!1,this.transform.straighten=0,this.notify("draw",{prop:"render-image",value:{isMouseWheel:!1}}),S},e.prototype.applyShapes=function(){if(!this.isUndoRedoStack){var t=["rectangle","ellipse","line","arrow","path","text","image"],r={bool:!1};this.notify("selection",{prop:"getFreehandDrawEditing",onPropertyChange:!1,value:{obj:r}}),(r.bool||this.togglePen||this.activeObj.shape&&t.indexOf(this.activeObj.shape)!==-1||this.drawingShape)&&this.okBtn(null,!0)}},e.prototype.closeOverlayTbar=function(){var t=!1,r={bool:null};if(this.notify("toolbar",{prop:"getFrameToolbar",onPropertyChange:!1,value:{obj:r}}),!r.bool&&this.element.querySelector(".e-contextual-toolbar-wrapper")){this.element.querySelector(".e-contextual-toolbar-wrapper").classList.contains("e-hide")||(t=!0);var o={bool:this.isStraightening};(!w.isDevice||w.isDevice&&!o.bool)&&this.element.querySelector(".e-contextual-toolbar-wrapper").classList.add("e-hide")}return t},e.prototype.toolbarTemplateFn=function(){var t,r=this.element.id+"_toolbar",o=this.element.querySelector("#"+this.element.id+"_toolbarArea");if(this.toolbarTemplate){if(this.toolbarFn=this.templateParser(this.toolbarTemplate),this.isReact)t=this.toolbarFn({type:"toolbar"},this,"Template",r)[0];else if(this.isAngular){var a=this.toolbarFn({type:"toolbar"},this,"Template",r);t=a[0].nodeType===3?a[1]:a[0]}else t=this.toolbarFn({type:"toolbar"},this,"Template",r)[0];o.appendChild(t),this.toolbarHeight=o.clientHeight,this.notify("toolbar",{prop:"setToolbarHeight",value:{height:this.toolbarHeight}}),this.renderReactTemplates()}},e.prototype.quickAccessToolbarTemplateFn=function(){var t,r=this.element.id+"_quickAccessToolbar",o=this.element.querySelector("#"+this.element.id+"_quickAccessToolbarArea");if(this.quickAccessToolbarTemplate){if(this.qatFn=this.templateParser(this.quickAccessToolbarTemplate),this.isReact)t=this.qatFn({type:"toolbar"},this,"Template",r)[0];else if(this.isAngular){var a=this.qatFn({type:"toolbar"},this,"Template",r);t=a[0].nodeType===3?a[1]:a[0]}else t=this.qatFn({type:"toolbar"},this,"Template",r)[0];o.appendChild(t),this.renderReactTemplates()}},e.prototype.templateParser=function(t){if(t)try{return typeof t!="function"&&document.querySelectorAll(t).length?xe(document.querySelector(t).innerHTML.trim()):xe(t)}catch{return xe(t)}},e.prototype.getTextFromId=function(t){var r={1:"none",2:"bar",3:"arrow",4:"arrowSolid",5:"circle",6:"circleSolid",7:"square",8:"squareSolid"};return r[""+t]},e.prototype.getFinetuneOption=function(t){var r={brightness:fe.Brightness,contrast:fe.Contrast,hue:fe.Hue,saturation:fe.Saturation,opacity:fe.Opacity,blur:fe.Blur,exposure:fe.Exposure};return r[""+t]},e.prototype.setPenStroke=function(t){this.notify("freehand-draw",{prop:"setPenStrokeWidth",onPropertyChange:!1,value:{value:parseInt(t,10)}})},e.prototype.updateFreehandDrawColorChange=function(){var t={tempFreeHandDrawEditingStyles:null};this.notify("freehand-draw",{prop:"getTempFreeHandDrawEditingStyles",value:{obj:t}}),this.notify("freehand-draw",{prop:"color-change",value:{color:t.tempFreeHandDrawEditingStyles.strokeColor}})},e.prototype.getUndoRedoColl=function(){var t={undoRedoColl:null,index:null},r={undoRedoStep:null},o={appliedUndoRedoColl:[]};return this.notify("undo-redo",{prop:"getAppliedUndoRedoColl",value:{obj:o}}),this.notify("undo-redo",{prop:"getUndoRedoStep",value:{obj:r}}),t.undoRedoColl=o.appliedUndoRedoColl,t.index=r.undoRedoStep,t},e.prototype.updateImageTransformColl=function(t){var r;t==="rotateleft"?r=-90:t==="rotateright"?r=90:t==="horizontalflip"?r="horizontal":t==="verticalflip"&&(r="vertical");for(var o=0;o<this.objColl.length;o++){var a=this.objColl[o].shape;if(a==="image"||a==="text"){C(this.objColl[o].rotateFlipColl)&&(this.objColl[o].rotateFlipColl=[]),this.objColl[o].rotateFlipColl.push(r);var n={collection:this.objColl[o].rotateFlipColl};this.notify("shape",{prop:"alignRotateFlipColl",onPropertyChange:!1,value:{collection:this.objColl[o].rotateFlipColl,isRotateFlipCollection:!1,obj:n}}),this.objColl[o].rotateFlipColl=n.collection}}},e.prototype.setInitialZoomState=function(){this.objColl.push(this.activeObj),this.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1});var t=this.isUndoRedo;this.isCropTab=!1,this.isUndoRedo=!0,this.transform.cropZoomFactor&&this.transform.cropZoomFactor>0?this.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-this.transform.cropZoomFactor,zoomPoint:null,isResize:!0}}):this.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:Math.abs(this.transform.cropZoomFactor),zoomPoint:null,isResize:!0}}),this.isUndoRedo=t,this.panPoint.totalPannedPoint={x:0,y:0},this.transform.cropZoomFactor=0,this.notify("freehand-draw",{prop:"updateFHDColl",onPropertyChange:!1}),this.activeObj=f({},this.objColl[this.objColl.length-1],{},!0),this.objColl.pop(),this.isCropTab=!0,this.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:this.activeObj}})},e.prototype.updateCropTransformItems=function(){this.prevCurrSelectionPoint=f({},this.currSelectionPoint,{},!0),this.notify("draw",{prop:"updateCropSelection",onPropertyChange:!1})},e.prototype.toPascalCase=function(t,r){var o=[];C(t)||(o=t.toLowerCase().split("-"));for(var a=0;a<o.length;a++)o[a]=o[a].charAt(0).toUpperCase()+o[a].slice(1);return r&&(r.maxText=o.join("")),o.join("")},e.prototype.getFontSizes=function(){var t=[];this.fontSizeColl=[];var r;this.transform.degree===0||this.transform.degree%180===0?r=this.img.destWidth/25:r=this.img.destHeight/25;for(var o=1;o<=10;o++)this.fontSizeColl.push({text:(o*Math.round(r/2)).toString()}),t.push({text:o.toString()});return t},e.prototype.updateDropInfoContent=function(t){if(t){var r={key:"SupportText"};this.notify("toolbar",{prop:"getLocaleText",onPropertyChange:!1,value:{obj:r}});var o=this.getExtensionString(),a={key:"MinMaxSize"};this.notify("toolbar",{prop:"getLocaleText",onPropertyChange:!1,value:{obj:a}});var n={key:"And"};this.notify("toolbar",{prop:"getLocaleText",onPropertyChange:!1,value:{obj:n}});var s;this.uploadSettings.minFileSize&&this.uploadSettings.maxFileSize?s=" "+a.value+" "+this.formatSizeUnits(this.uploadSettings.minFileSize)+" "+n.value+" "+this.formatSizeUnits(this.uploadSettings.maxFileSize):this.uploadSettings.minFileSize?(a.key="MinSize",this.notify("toolbar",{prop:"getLocaleText",onPropertyChange:!1,value:{obj:a}}),s=" "+a.value+" "+this.formatSizeUnits(this.uploadSettings.minFileSize)):this.uploadSettings.maxFileSize&&(a.key="MaxSize",this.notify("toolbar",{prop:"getLocaleText",onPropertyChange:!1,value:{obj:a}}),s=" "+a.value+" "+this.formatSizeUnits(this.uploadSettings.maxFileSize)),s?t.textContent=r.value+o+s:t.textContent=r.value+o}},e.prototype.okBtn=function(t,r,o){if(r){this.noPushUndo=!1;var a={activePoint:{startX:0,startY:0,endX:0,endY:0,width:0,height:0},flipObjColl:[],triangle:[],triangleRatio:[],order:null};this.notify("selection",{prop:"setTempActObj",onPropertyChange:!1,value:{obj:a}})}var n=this.element.querySelector(".e-contextual-toolbar-wrapper");n&&n.classList.remove("e-frame-wrapper");var s=!1,l;this.isResizeOkBtn=!0;var p=this.element.querySelector("#"+this.element.id+"_aspectratio"),h=this.element.querySelector("#"+this.element.id+"_nonaspectratio"),u=this.element.querySelector(".e-ie-toolbar-aspect-ratio-btn"),c=this.element.querySelector(".e-ie-toolbar-nonaspect-ratio-btn");if(this.activeObj.shape!==void 0&&(l=this.activeObj.shape.split("-")),(l===void 0&&this.currObjType.isCustomCrop||l!==void 0&&l[0]==="crop")&&(s=!0),this.allowDownScale=!0,(this.activeObj.shape&&this.activeObj.shape!=="image"||this.togglePen)&&!s){var g={shapeSettingsObj:{}};this.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:g}});var v=g.shapeSettingsObj;this.togglePen&&(v.type=se.FreehandDraw);var b={action:"apply",currentShapeSettings:f({},v,{},!0)};!this.currObjType.isRedact&&(r||this.isShapeDrawing)&&(this.isShapeDrawing&&(b.action="draw-end"),this.trigger("shapeChange",b)),this.editCompleteArgs=b,this.currObjType.isRedact&&(this.currObjType.isRedact=!1)}if(p||h){var m={width:null,height:null};this.notify("selection",{prop:"getNumTextValue",onPropertyChange:!1,value:{obj:m}});var y={x:m.width,y:m.height},P={prevCropObj:this.prevCropObj},S={prevObj:this.prevObj};if(y&&y.x&&y.y&&P.prevCropObj&&S.prevObj){h||c&&!c.classList.contains("e-hidden")?this.notify("transform",{prop:"resize",value:{width:y.x,height:y.y,isAspectRatio:!1}}):(p||u&&!u.classList.contains("e-hidden"))&&this.notify("transform",{prop:"resize",value:{width:y.x,height:null,isAspectRatio:!0}}),this.isResize=!1,this.aspectWidth=y.x,this.aspectHeight=y.y,this.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:!1,isCropping:!1,isZooming:null,cType:null}}),this.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-this.transform.zoomFactor,zoomPoint:null,isResize:!0}}),this.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:S.prevObj.defaultZoom,zoomPoint:null,isResize:!0}}),S.prevObj.zoomFactor&&this.setProperties({zoomSettings:{zoomFactor:S.prevObj.zoomFactor}},!0),this.notify("transform",{prop:"setPreviousZoomValue",onPropertyChange:!1,value:{previousZoomValue:this.zoomSettings.zoomFactor}}),this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"resize",previousObj:S.prevObj,previousObjColl:S.prevObj.objColl,previousPointColl:S.prevObj.pointColl,previousSelPointColl:S.prevObj.selPointColl,previousCropObj:P.prevCropObj,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}});var O=this.cancelCropSelection;O&&(C(h)||!h)&&(O.previousObj.aspectWidth=O.currentObj.aspectWidth=this.aspectWidth,O.previousObj.aspectHeight=O.currentObj.aspectHeight=this.aspectHeight,O.previousCropObj=f({},this.cropObj,{},!0),O.currentCropObj=f({},this.cropObj,{},!0),this.notify("draw",{prop:"updateCropSelObj"})),this.cancelCropSelection=null}else y&&(y.x===0||y.y===0)?this.notify("draw",{prop:"performCancel",value:{isContextualToolbar:null}}):this.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:!1,isCropping:!1,isZooming:null,cType:null}});this.isAspectRatio=!1}else if(o){var j=!1;this.aspectWidth&&this.aspectHeight?this.notify("transform",{prop:"resize",value:{width:this.aspectWidth,height:this.aspectHeight,isAspectRatio:!1}}):this.aspectWidth&&(this.notify("transform",{prop:"resize",value:{width:this.aspectWidth,height:null,isAspectRatio:!0}}),this.aspectHeight=this.aspectWidth/(this.img.destWidth/this.img.destHeight),j=!0),this.isResize=!1,this.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:!1,isCropping:!1,isZooming:null,cType:null}}),this.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-this.transform.zoomFactor,zoomPoint:null,isResize:!0}}),this.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:this.prevObj.defaultZoom,zoomPoint:null,isResize:!0}}),this.prevObj.zoomFactor&&this.setProperties({zoomSettings:{zoomFactor:this.prevObj.zoomFactor}},!0),this.notify("transform",{prop:"setPreviousZoomValue",onPropertyChange:!1,value:{previousZoomValue:this.zoomSettings.zoomFactor}}),this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"resize",previousObj:this.prevObj,previousObjColl:this.prevObj.objColl,previousPointColl:this.prevObj.pointColl,previousSelPointColl:this.prevObj.selPointColl,previousCropObj:this.prevCropObj,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}});var x=this.cancelCropSelection;x&&j&&(x.previousObj.aspectWidth=x.currentObj.aspectWidth=this.aspectWidth,x.previousObj.aspectHeight=x.currentObj.aspectHeight=this.aspectHeight,x.previousCropObj=f({},this.cropObj,{},!0),x.currentCropObj=f({},this.cropObj,{},!0),this.notify("draw",{prop:"updateCropSelObj"})),this.cancelCropSelection=null,this.isAspectRatio=!1}var k=this.element.querySelector(".e-contextual-toolbar-wrapper .e-toolbar-item.e-selected"),T={bool:!1};this.notify("selection",{prop:"getFreehandDrawEditing",onPropertyChange:!1,value:{obj:T}});var A={bool:null};this.notify("toolbar",{prop:"getFrameToolbar",onPropertyChange:!1,value:{obj:A}});var L=document.querySelector("#"+this.element.id+"_sliderWrapper");if(k&&(this.currentFilter=k.children[0].children[0].id.replace("Canvas","")),s){if(this.transform.straighten!==0&&(this.panPoint.totalPannedPoint.x!==0||this.panPoint.totalPannedPoint.y!==0||this.panPoint.totalPannedClientPoint.x!==0||this.panPoint.totalPannedClientPoint.y!==0)){var H=this.prevStraightenedDegree;this.prevStraightenedDegree=this.transform.straighten,this.setStraighten(this.transform.straighten-3),this.setStraighten(this.transform.straighten+3),this.prevStraightenedDegree=H}this.isCroppedEvent=this.crop()}else if(this.togglePen){if(this.freeHandDraw(!1),!this.isMaskImage){var B={penStrokeWidth:null};this.notify("freehand-draw",{prop:"getPenStrokeWidth",onPropertyChange:!1,value:{obj:B}}),this.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}}),this.notify("freehand-draw",{prop:"setPenStrokeWidth",onPropertyChange:!1,value:{value:B.penStrokeWidth}})}this.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),this.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.upperContext}})}else if(this.textArea.style.display==="block"||this.textArea.style.display==="inline-block")this.notify("shape",{prop:"redrawActObj",onPropertyChange:!1,value:{x:null,y:null,isMouseDown:null}}),this.lowerContext.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),this.notify("draw",{prop:"redrawImgWithObj",onPropertyChange:!1}),C(t)&&this.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}}),this.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),this.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.upperContext}});else if((L||this.currObjType.isFiltered)&&!this.drawingShape&&this.activeObj.shape!=="redact"){this.initialAdjustmentValue=this.canvasFilter=this.lowerContext.filter,this.currObjType.isFiltered=!1;var D={value:null};this.notify("draw",{prop:"getTempAdjustmentValue",value:{obj:D}}),(!L||L.parentElement.previousElementSibling.textContent!=="Opacity")&&this.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}}),(this.activeObj.activePoint.width!==0&&this.activeObj.activePoint.height!==0||this.activeObj.shape==="path"&&this.activeObj.pointColl.length>0)&&this.notify("shape",{prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:null}})}else if(T.bool)this.notify("freehand-draw",{prop:"applyFhd",onPropertyChange:!1}),this.notify("selection",{prop:"setFreehandDrawCustomized",value:{isFreehandDrawCustomized:!1}}),this.notify("toolbar",{prop:"destroy-qa-toolbar"}),this.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}}),this.notify("freehand-draw",{prop:"resetFreehandDrawSelectedId",onPropertyChange:!1});else if(this.activeObj.activePoint.width!==0||this.activeObj.activePoint.height!==0||this.activeObj.shape==="path"&&this.activeObj.pointColl.length>0)this.activeObj.shape==="image"&&this.notify("draw",{prop:"setImageApply",onPropertyChange:!1,value:{bool:!0}}),this.notify("shape",{prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:null}});else{if(JSON.stringify(this.frameObj)!==JSON.stringify(this.tempFrameObj)){var E={currObj:{}};this.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:E}}),this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"frame",previousObj:E.currObj,previousObjColl:E.currObj.objColl,previousPointColl:E.currObj.pointColl,previousSelPointColl:E.currObj.selPointColl,previousCropObj:f({},this.cropObj,{},!0),previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.notify("draw",{prop:"render-image",value:{isMouseWheel:null,isPreventClearRect:null,isFrame:!0}});var R={type:this.toPascalCase(this.frameObj.type),color:this.frameObj.color,gradientColor:this.frameObj.gradientColor,size:this.frameObj.size,inset:this.frameObj.inset,offset:this.frameObj.offset,borderRadius:this.frameObj.radius,frameLineStyle:this.toPascalCase(this.frameObj.border),lineCount:this.frameObj.amount},Q={type:this.toPascalCase(this.tempFrameObj.type),color:this.tempFrameObj.color,gradientColor:this.tempFrameObj.gradientColor,size:this.tempFrameObj.size,inset:this.tempFrameObj.inset,offset:this.tempFrameObj.offset,borderRadius:this.tempFrameObj.radius,frameLineStyle:this.toPascalCase(this.tempFrameObj.border),lineCount:this.tempFrameObj.amount},V={cancel:!1,previousFrameSetting:Q,currentFrameSetting:R};this.editCompleteArgs=V,this.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}}),this.tempFrameObj=f({},this.frameObj,{},!0)}this.notify("draw",{prop:"resetFrameZoom",onPropertyChange:!1,value:{isOk:!0}})}T.isCropToolbar||(this.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:!1,isCropping:null,isZooming:null,cType:null}}),this.currObjType.isRedact=!1),this.notify("draw",{prop:"setNewPath",value:{bool:!1}}),this.transform.zoomFactor=this.transform.defaultZoomFactor,this.notify("selection",{prop:"setCurrentDrawingShape",onPropertyChange:!1,value:{value:""}}),this.isResizeOkBtn=!1,this.notify("draw",{prop:"redrawDownScale"}),this.isChangesSaved=this.isFinetuneBtnClick=!1,r&&(this.drawingShape=null,this.notify("draw",{prop:"resetTempObjColl"}),this.notify("draw",{prop:"resetTempPointColl"}))},e.prototype.triggerEditCompleteEvent=function(t){t.action==="shape-insert"&&t.actionEventArgs&&t.actionEventArgs.currentShapeSettings&&t.actionEventArgs.currentShapeSettings.type.toString()==="Redact"&&(t.action="redact"),this.trigger("editComplete",t),this.editCompleteArgs=null},e.prototype.getObjFromId=function(t){var r;if(this.activeObj.currIndex&&this.activeObj.currIndex===t)r=f({},this.activeObj,{},!0);else for(var o=0;o<this.shapeColl.length;o++){var a=this.shapeColl[o].id?this.shapeColl[o].id:this.shapeColl[o].currIndex;if(a===t){r=f({},this.shapeColl[o],{},!0);break}}return r},e.prototype.setTempFilterProperties=function(){this.upperCanvas.style.display="block",this.cropSelectedState();var t={adjustmentLevel:null};this.notify("filter",{prop:"getAdjustmentLevel",onPropertyChange:!1,value:{obj:t}}),this.lowerContext.filter=this.initialAdjustmentValue,this.notify("draw",{prop:"setTempAdjustmentValue",value:{tempAdjustmentValue:this.lowerContext.filter}}),this.notify("filter",{prop:"setTempAdjustmentLevel",onPropertyChange:!1,value:{tempAdjustmentLevel:f({},t.adjustmentLevel,{},!0)}}),this.notify("draw",{prop:"setTempFilter",value:{tempFilter:this.currentFilter}});var r={undoRedoStep:null};this.notify("undo-redo",{prop:"getUndoRedoStep",value:{obj:r}}),this.notify("draw",{prop:"setTempUndoRedoStep",value:{tempUndoRedoStep:r.undoRedoStep}})},e.prototype.cropSelectedState=function(){this.activeObj.shape&&this.activeObj.shape.split("-")[0]==="crop"&&this.okBtn()},e.prototype.getCurrentCanvasData=function(){var t=f({},this.frameObj,{},!0);this.frameObj={type:"none",color:"#fff",size:20,inset:20,offset:20,radius:0,amount:1,border:"solid",gradientColor:""};var r=this.lowerContext.filter;this.lowerContext.filter=this.canvasFilter="none";var o=f([],this.objColl,null,!0),a=f([],this.pointColl,null,!0);this.objColl=[],this.pointColl=[],this.freehandCounter=0,this.notify("draw",{prop:"render-image",value:{isMouseWheel:!1}});var n=this.element.querySelector(".e-contextual-toolbar-wrapper");n&&n.classList.add("e-hide");var s=this.getImageData();return n&&n.classList.remove("e-hide"),w.isDevice||this.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"main",isApplyBtn:!0,isCropping:!1}}),this.element.querySelector("#"+this.element.id+"_contextualToolbarArea").classList.remove("e-hide"),this.objColl=o,this.pointColl=a,this.freehandCounter=a.length,this.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"iterate",pen:"iterate",isPreventApply:null}}),this.lowerContext.filter=this.canvasFilter=r,this.frameObj=t,s},e.prototype.setCurrAdjustmentValue=function(t,r){var o={finetune:this.getFinetuneOption(t),value:r,cancel:!1};this.trigger("finetuneValueChanging",o),this.editCompleteArgs=o,!o.cancel&&this.notify("filter",{prop:"setCurrAdjValue",value:{type:t.toLowerCase(),value:r}})},e.prototype.getSquarePointForPath=function(t){var r={startX:0,startY:0,endX:0,endY:0,width:0,height:0};if(t.pointColl.length>0){r={startX:t.pointColl[0].x,startY:t.pointColl[0].y,endX:t.pointColl[0].x,endY:t.pointColl[0].y};for(var o=1;o<t.pointColl.length;o++)t.pointColl[o].x<r.startX&&(r.startX=t.pointColl[o].x),t.pointColl[o].y<r.startY&&(r.startY=t.pointColl[o].y),t.pointColl[o].x>r.endX&&(r.endX=t.pointColl[o].x),t.pointColl[o].y>r.endY&&(r.endY=t.pointColl[o].y);r.width=r.endX-r.startX,r.height=r.endY-r.startY}return r},e.prototype.getSelectionType=function(t){t=t==="crop-custom"?"CropCustom":t;var r={CropCustom:"Custom",CropSquare:"Square",CropCircle:"Circle","Crop3:2":"3:2","Crop4:3":"4:3","Crop5:4":"5:4","Crop7:5":"7:5","Crop16:9":"16:9","Crop2:3":"2:3","Crop3:4":"3:4","Crop4:5":"4:5","Crop5:7":"5:7","Crop9:16":"9:16"};return r[""+t]?r[""+t]:t.split("Crop")[1]},e.prototype.clearContext=function(t){t.clearRect(0,0,t.canvas.width,t.canvas.height),t.clearRect(0,0,t.canvas.height,t.canvas.width)},e.prototype.updateArrow=function(t,r){var o=!1,a=this.objColl.length;this.notify("shape",{prop:"pushActItemIntoObj"}),a!==this.objColl.length&&(o=!0);var n=f({},this.cropObj,{},!0),s={currObj:{}},l={shapeSettingsObj:{}};this.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:l}});var p=l.shapeSettingsObj;this.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:s}});var h=s.currObj;if(h.objColl=f([],this.objColl,[],!0),h.pointColl=f([],this.pointColl,[],!0),h.afterCropActions=f([],this.afterCropActions,[],!0),o&&this.objColl.pop(),t==="startArrow"?this.activeObj.start=this.getTextFromId(r):t==="endArrow"&&(this.activeObj.end=this.getTextFromId(r)),this.notify("shape",{prop:"setStrokeSettings",value:{strokeSettings:null,strokeColor:null,fillColor:null,strokeWidth:this.activeObj.strokeSettings.strokeWidth}}),this.objColl.push(this.activeObj),(this.activeObj.activePoint.width!==0||this.activeObj.activePoint.height!==0)&&this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:h,previousObjColl:h.objColl,previousPointColl:h.pointColl,previousCropObj:n,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.notify("selection",{prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}}),w.isDevice){if(document.getElementById(this.element.id+"_bottomToolbar")){var u=F(this.element.id+"_bottomToolbar","toolbar");u.refreshOverflow()}}else if(document.getElementById(this.element.id+"_toolbar")){var c=F(this.element.id+"_toolbar","toolbar");c.refreshOverflow()}var g={action:t,currentShapeSettings:f({},p,{},!0)};this.trigger("shapeChange",g),this.editCompleteArgs=g},e.prototype.updateFontFamily=function(t){this.notify("selection",{prop:"setInitialTextEdit",value:{bool:!1}});var r=!1,o=this.objColl.length;this.notify("shape",{prop:"pushActItemIntoObj"}),o!==this.objColl.length&&(r=!0);var a=f([],this.objColl,[],!0),n=f({},this.cropObj,{},!0),s={shapeSettingsObj:{}};this.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:s}});var l=s.shapeSettingsObj,p={currObj:{}};this.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:p}});var h=p.currObj;h.objColl=f([],this.objColl,[],!0),h.pointColl=f([],this.pointColl,[],!0),h.afterCropActions=f([],this.afterCropActions,[],!0);var u={selPointColl:null};if(this.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:u}}),h.selPointColl=f([],u.selPointColl,[],!0),r&&this.objColl.pop(),this.textArea.style.display==="block"||this.textArea.style.display==="inline-block"){this.notify("shape",{prop:"updateFontRatio",onPropertyChange:!1,value:{obj:this.activeObj,isTextArea:!0}});var c=this.activeObj.textSettings.fontFamily;this.activeObj.textSettings.fontFamily=this.toPascalCase(t),(this.activeObj.activePoint.width!==0||this.activeObj.activePoint.height!==0)&&this.notify("shape",{prop:"redraw-text"}),this.objColl.push(this.activeObj),(this.activeObj.activePoint.width!==0||this.activeObj.activePoint.height!==0)&&this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"textAreaCustomization",previousObj:h,previousObjColl:h.objColl,previousPointColl:h.pointColl,previousSelPointColl:h.selPointColl,previousCropObj:n,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.objColl.pop(),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height);var g=this.activeObj.activePoint.width+this.activeObj.textSettings.fontSize*.25;this.textArea.style.width=g+"px",this.textArea.style.fontFamily=this.toPascalCase(t),this.activeObj.textSettings.fontFamily=c,this.notify("shape",{prop:"updateFontStyles",onPropertyChange:!1,value:{isTextBox:null}})}else{this.notify("shape",{prop:"updateFontRatio",onPropertyChange:!1,value:{obj:this.activeObj,isTextArea:null}});var v=this.activeObj.textSettings.fontFamily=this.toPascalCase(t);this.notify("shape",{prop:"setTextSettings",onPropertyChange:!1,value:{textSettings:null,fontFamily:v,fontSize:null}}),(this.activeObj.activePoint.width!==0||this.activeObj.activePoint.height!==0)&&this.notify("shape",{prop:"redraw-text"}),this.objColl.push(this.activeObj),(this.activeObj.activePoint.width!==0||this.activeObj.activePoint.height!==0)&&this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:h,previousObjColl:a,previousPointColl:f([],this.pointColl,[],!0),previousSelPointColl:h.selPointColl,previousCropObj:n,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.notify("selection",{prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}})}var b={action:"font-family",currentShapeSettings:f({},l,{},!0)};b.currentShapeSettings.fontFamily=this.textArea.style.fontFamily,this.trigger("shapeChange",b),this.editCompleteArgs=b},e.prototype.updateFontSize=function(t){var r=t;this.notify("selection",{prop:"setInitialTextEdit",value:{bool:!1}});var o=!1,a=this.objColl.length;this.notify("shape",{prop:"pushActItemIntoObj"}),a!==this.objColl.length&&(o=!0);var n=f({},this.cropObj,{},!0),s={shapeSettingsObj:{}};this.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:s}});var l=s.shapeSettingsObj,p={currObj:{}};this.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:p}});var h=p.currObj;h.objColl=f([],this.objColl,[],!0),h.pointColl=f([],this.pointColl,[],!0),h.afterCropActions=f([],this.afterCropActions,[],!0);var u={selPointColl:null};if(this.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:u}}),h.selPointColl=f([],u.selPointColl,[],!0),o&&this.objColl.pop(),this.textArea.style.display==="block"||this.textArea.style.display==="inline-block"){this.notify("shape",{prop:"updateFontRatio",onPropertyChange:!1,value:{obj:this.activeObj,isTextArea:!0}});var c=this.activeObj.textSettings.fontSize;this.activeObj.textSettings.fontSize=parseInt(this.fontSizeColl[parseInt(r,10)-1].text,10),this.objColl.push(this.activeObj),(this.activeObj.activePoint.width!==0||this.activeObj.activePoint.height!==0)&&this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"textAreaCustomization",previousObj:h,previousObjColl:h.objColl,previousPointColl:h.pointColl,previousSelPointColl:h.selPointColl,previousCropObj:n,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.objColl.pop();var g="";this.textArea.style.fontWeight==="bold"&&(g="bold "),this.textArea.style.fontStyle==="italic"&&(g="italic "),this.textArea.style.fontWeight==="bold"&&this.textArea.style.fontStyle==="italic"&&(g="italic bold "),this.upperContext.font=g+this.activeObj.textSettings.fontSize+"px "+this.textArea.style.fontFamily;var v=this.textArea.value.split(`
`),b={maxText:""};this.notify("shape",{prop:"getMaxText",onPropertyChange:!1,value:{isTextBox:!0,text:null,obj:b}});var m=b.maxText,y=this.upperContext.measureText(m).width+this.activeObj.textSettings.fontSize*.5;this.textArea.style.width=y+"px",this.textArea.style.height=v.length*(this.activeObj.textSettings.fontSize+this.activeObj.textSettings.fontSize*.25)+"px",this.activeObj.textSettings.fontSize=c,this.upperContext.font=this.activeObj.textSettings.fontSize+"px "+this.activeObj.textSettings.fontFamily,this.textArea.style.fontSize=parseInt(this.fontSizeColl[parseInt(r,10)-1].text,10)+"px",this.textArea.style.fontFamily==="georgia"&&(this.textArea.style.width=parseFloat(this.textArea.style.width)+parseFloat(this.textArea.style.fontSize)+"px")}else{this.notify("shape",{prop:"updateFontRatio",onPropertyChange:!1,value:{obj:this.activeObj,isTextArea:null}});var P=this.activeObj.textSettings.fontSize=parseInt(this.fontSizeColl[parseInt(r,10)-1].text,10);this.notify("shape",{prop:"setTextSettings",onPropertyChange:!1,value:{textSettings:null,fontFamily:null,fontSize:P}}),this.upperContext.font=this.activeObj.textSettings.fontSize+"px "+this.activeObj.textSettings.fontFamily;var v=this.activeObj.keyHistory.split(`
`),b={maxText:""};this.notify("shape",{prop:"getMaxText",onPropertyChange:!1,value:{isTextBox:null,text:null,obj:b}});var S=b.maxText,y=this.upperContext.measureText(S).width+this.activeObj.textSettings.fontSize*.5,O=v.length*(this.activeObj.textSettings.fontSize+this.activeObj.textSettings.fontSize*.25);(this.activeObj.activePoint.width!==0||this.activeObj.activePoint.height!==0)&&(this.notify("selection",{prop:"setTextSelection",onPropertyChange:!1,value:{width:y,height:O}}),this.notify("draw",{prop:"updateActiveObject",onPropertyChange:!1,value:{actPoint:this.activeObj.activePoint,obj:this.activeObj,isMouseMove:null,x:null,y:null}}),this.notify("shape",{prop:"redraw-text"})),this.objColl.push(this.activeObj),(this.activeObj.activePoint.width!==0||this.activeObj.activePoint.height!==0)&&this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:h,previousObjColl:h.objColl,previousPointColl:h.pointColl,previousSelPointColl:h.selPointColl,previousCropObj:n,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.notify("selection",{prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}})}var j={action:"font-size",currentShapeSettings:f({},l,{},!0)};j.currentShapeSettings.fontSize=this.activeObj.textSettings.fontSize,this.trigger("shapeChange",j),this.editCompleteArgs=j},e.prototype.updateFontColor=function(t,r){this.notify("selection",{prop:"setInitialTextEdit",value:{bool:!1}});var o=!1,a=this.objColl.length;this.notify("shape",{prop:"pushActItemIntoObj"}),a!==this.objColl.length&&(o=!0);var n=f({},this.cropObj,{},!0),s={shapeSettingsObj:{}};this.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:s}});var l=s.shapeSettingsObj,p={currObj:{}};this.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:p}});var h=p.currObj;h.objColl=f([],this.objColl,[],!0),h.pointColl=f([],this.pointColl,[],!0),h.afterCropActions=f([],this.afterCropActions,[],!0);var u={selPointColl:null};if(this.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:u}}),h.selPointColl=f([],u.selPointColl,[],!0),o&&this.objColl.pop(),this.textArea.style.display==="none")r==="Text"?(this.activeObj.strokeSettings.strokeColor=t,this.notify("shape",{prop:"setStrokeSettings",value:{strokeSettings:null,strokeColor:this.activeObj.strokeSettings.strokeColor,fillColor:null,strokeWidth:null}})):(this.activeObj.strokeSettings.fillColor=t,this.notify("shape",{prop:"setStrokeSettings",value:{strokeSettings:null,strokeColor:null,fillColor:this.activeObj.strokeSettings.fillColor,strokeWidth:null}})),this.togglePen||(this.activeObj.activePoint.width!==0||this.activeObj.activePoint.height!==0)&&(this.objColl.push(this.activeObj),this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:h,previousObjColl:h.objColl,previousPointColl:h.pointColl,previousSelPointColl:h.selPointColl,previousCropObj:n,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.notify("selection",{prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}}));else if(this.textArea.style.display==="block"||this.textArea.style.display==="inline-block"){this.textArea.style[r==="Text"?"color":"backgroundColor"]=t;var c=r==="Text"?this.activeObj.strokeSettings.strokeColor:this.activeObj.strokeSettings.fillColor;this.activeObj.strokeSettings[r==="Text"?"strokeColor":"fillColor"]=t,(this.activeObj.activePoint.width!==0||this.activeObj.activePoint.height!==0)&&(this.objColl.push(this.activeObj),this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"textAreaCustomization",previousObj:h,previousObjColl:h.objColl,previousPointColl:h.pointColl,previousSelPointColl:h.selPointColl,previousCropObj:n,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.objColl.pop()),this.activeObj.strokeSettings[r==="Text"?"strokeColor":"fillColor"]=c}else this.togglePen||(this.activeObj.activePoint.width!==0||this.activeObj.activePoint.height!==0)&&(this.objColl.push(this.activeObj),this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:h,previousObjColl:h.objColl,previousPointColl:h.pointColl,previousSelPointColl:h.selPointColl,previousCropObj:n,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.notify("selection",{prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}}));var g={action:"font-color",currentShapeSettings:f({},l,{},!0)};g.currentShapeSettings.fillColor=t,this.trigger("shapeChange",g),this.editCompleteArgs=g},e.prototype.updateStrokeTextColor=function(t){this.notify("selection",{prop:"setInitialTextEdit",value:{bool:!1}});var r=!1,o=this.objColl.length;this.notify("shape",{prop:"pushActItemIntoObj"}),o!==this.objColl.length&&(r=!0);var a=f({},this.cropObj,{},!0),n={shapeSettingsObj:{}};this.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:n}});var s=n.shapeSettingsObj,l={currObj:{}};this.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:l}});var p=l.currObj;p.objColl=f([],this.objColl,[],!0),p.pointColl=f([],this.pointColl,[],!0),p.afterCropActions=f([],this.afterCropActions,[],!0);var h={selPointColl:null};if(this.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:h}}),p.selPointColl=f([],h.selPointColl,[],!0),r&&this.objColl.pop(),this.textArea.style.display==="none")this.activeObj.strokeSettings.outlineColor=t,this.notify("shape",{prop:"setStrokeSettings",value:{strokeSettings:null,strokeColor:null,fillColor:null,strokeWidth:null,outlineColor:this.activeObj.strokeSettings.outlineColor}}),this.togglePen||(this.activeObj.activePoint.width!==0||this.activeObj.activePoint.height!==0)&&(this.objColl.push(this.activeObj),this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:p,previousObjColl:p.objColl,previousPointColl:p.pointColl,previousSelPointColl:p.selPointColl,previousCropObj:a,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.notify("selection",{prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}}));else if(this.textArea.style.display==="block"||this.textArea.style.display==="inline-block"){this.textArea.style.textShadow="-1px -1px 0 "+t+", 1px -1px 0 "+t+", -1px 1px 0 "+t+", 1px 1px 0 "+t;var u=this.activeObj.strokeSettings.outlineColor;this.activeObj.strokeSettings.outlineColor=t,(this.activeObj.activePoint.width!==0||this.activeObj.activePoint.height!==0)&&(this.objColl.push(this.activeObj),this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"textAreaCustomization",previousObj:p,previousObjColl:p.objColl,previousPointColl:p.pointColl,previousSelPointColl:p.selPointColl,previousCropObj:a,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.objColl.pop()),this.activeObj.strokeSettings.outlineColor=u}else this.togglePen||(this.activeObj.activePoint.width!==0||this.activeObj.activePoint.height!==0)&&(this.objColl.push(this.activeObj),this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:p,previousObjColl:p.objColl,previousPointColl:p.pointColl,previousSelPointColl:p.selPointColl,previousCropObj:a,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.notify("selection",{prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}}));var c={action:"font-color",currentShapeSettings:f({},s,{},!0)};c.currentShapeSettings.fillColor=t,this.trigger("shapeChange",c),this.editCompleteArgs=c},e.prototype.updatePenStrokeWidth=function(t){var r=f([],this.pointColl,[],!0);this.updateFreehandDrawColorChange();var o=f({},this.cropObj,{},!0),a={shapeSettingsObj:{}};this.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:a}});var n=a.shapeSettingsObj,s={currObj:{}};this.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:s}});var l=s.currObj;l.objColl=f([],this.objColl,[],!0),l.pointColl=f([],this.pointColl,[],!0),l.afterCropActions=f([],this.afterCropActions,[],!0);var p={selPointColl:null};this.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:p}}),l.selPointColl=f([],p.selPointColl,[],!0),this.pointColl=r,this.notify("selection",{prop:"setFreehandDrawCustomized",value:{isFreehandDrawCustomized:!0}}),this.setPenStroke(t);var h={bool:!1};if(this.notify("selection",{prop:"getFreehandDrawEditing",onPropertyChange:!1,value:{obj:h}}),h.bool){var u={penStrokeWidth:null};this.notify("freehand-draw",{prop:"getPenStrokeWidth",onPropertyChange:!1,value:{obj:u}}),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.lowerContext.clearRect(0,0,this.lowerCanvas.width,this.lowerCanvas.height),this.notify("freehand-draw",{prop:"hoverFhd",onPropertyChange:!1,value:{strokeColor:null,strokeWidth:u.penStrokeWidth}});var c={freehandSelectedIndex:null};this.notify("freehand-draw",{prop:"getFreehandSelectedIndex",onPropertyChange:!1,value:{obj:c}}),this.pointColl[c.freehandSelectedIndex].strokeWidth=u.penStrokeWidth,this.notify("draw",{prop:"render-image",value:{isMouseWheel:null}}),this.notify("draw",{prop:"redrawDownScale"}),this.notify("freehand-draw",{prop:"hoverFhd",onPropertyChange:!1,value:{strokeColor:null,strokeWidth:u.penStrokeWidth}}),this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"freehanddrawCustomized",previousObj:l,previousObjColl:l.objColl,previousPointColl:l.pointColl,previousSelPointColl:l.selPointColl,previousCropObj:o,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}})}n.type=se.FreehandDraw;var g={action:"stroke-width",currentShapeSettings:f({},n,{},!0)};g.currentShapeSettings.strokeWidth=this.activeObj.strokeSettings.strokeWidth,this.trigger("shapeChange",g),this.editCompleteArgs=g},e.prototype.updatePenStrokeColor=function(t){var r=f([],this.pointColl,[],!0);this.updateFreehandDrawColorChange();var o=f({},this.cropObj,{},!0),a={shapeSettingsObj:{}};this.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:a}});var n=a.shapeSettingsObj,s={currObj:{}};this.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:s}});var l=s.currObj;l.objColl=f([],this.objColl,[],!0),l.pointColl=f([],this.pointColl,[],!0),l.afterCropActions=f([],this.afterCropActions,[],!0);var p={selPointColl:null};this.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:p}}),l.selPointColl=f([],p.selPointColl,[],!0),this.pointColl=r,this.notify("selection",{prop:"setFreehandDrawCustomized",value:{isFreehandDrawCustomized:!0}}),this.activeObj.strokeSettings.strokeColor=t;var h={freehandSelectedIndex:null};this.notify("freehand-draw",{prop:"getFreehandSelectedIndex",onPropertyChange:!1,value:{obj:h}}),h.freehandSelectedIndex!==null&&h.freehandSelectedIndex!==void 0&&(this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.notify("draw",{prop:"render-image",value:{isMouseWheel:null}}),this.notify("draw",{prop:"redrawDownScale"}),this.notify("freehand-draw",{prop:"hoverFhd",onPropertyChange:!1,value:{strokeColor:null,strokeWidth:null}}));var u={bool:!1};if(this.notify("selection",{prop:"getFreehandDrawEditing",onPropertyChange:!1,value:{obj:u}}),u.bool){var c={freehandSelectedIndex:null};this.notify("freehand-draw",{prop:"getFreehandSelectedIndex",onPropertyChange:!1,value:{obj:c}}),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.pointColl[c.freehandSelectedIndex].strokeColor=t,this.notify("freehand-draw",{prop:"hoverFhd",onPropertyChange:!1,value:{strokeColor:t}}),this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"freehanddrawCustomized",previousObj:l,previousObjColl:l.objColl,previousPointColl:l.pointColl,previousSelPointColl:l.selPointColl,previousCropObj:o,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}})}else this.togglePen||this.notify("selection",{prop:"redrawShape",value:{obj:this.activeObj}});n.type=se.FreehandDraw;var g={action:"stroke-color",currentShapeSettings:f({},n,{},!0)};g.currentShapeSettings.strokeColor=t,this.trigger("shapeChange",g),this.editCompleteArgs=g},e.prototype.updateStrokeWidth=function(t,r,o){if(this.activeObj.shape&&(this.activeObj.shape!=="path"||this.activeObj.shape==="path"&&this.activeObj.pointColl.length>0)){var a={shapeSettingsObj:{}};this.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:a}});var n=a.shapeSettingsObj,s=!1,l=this.objColl.length;this.notify("shape",{prop:"pushActItemIntoObj"}),l!==this.objColl.length&&(s=!0);var p=f({},this.cropObj,{},!0),h={currObj:{}};this.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:h}});var u=h.currObj;u.objColl=f([],this.objColl,[],!0),u.pointColl=f([],this.pointColl,[],!0),u.afterCropActions=f([],this.afterCropActions,[],!0);var c={selPointColl:null};this.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:c}}),u.selPointColl=f([],c.selPointColl,[],!0),s&&this.objColl.pop(),this.activeObj.strokeSettings[r==="width"?o==="text"?"outlineWidth":"strokeWidth":"radius"]=parseInt(t,10),(this.activeObj.shape==="rectangle"||this.activeObj.shape==="ellipse")&&(this.activeObj.strokeSettings[r==="width"?o==="text"?"outlineWidth":"strokeWidth":"radius"]=parseInt(t,10)-1),this.activeObj.strokeSettings[r==="width"?o==="text"?"outlineWidth":"strokeWidth":"radius"]*=2,r==="width"?o==="text"?this.notify("shape",{prop:"setStrokeSettings",value:{strokeSettings:null,strokeColor:null,fillColor:null,strokeWidth:null,radius:null,outlineWidth:this.activeObj.strokeSettings.outlineWidth}}):this.notify("shape",{prop:"setStrokeSettings",value:{strokeSettings:null,strokeColor:null,fillColor:null,strokeWidth:this.activeObj.strokeSettings.strokeWidth,radius:null,outlineWidth:null}}):this.notify("shape",{prop:"setStrokeSettings",value:{strokeSettings:null,strokeColor:null,fillColor:null,strokeWidth:null,radius:this.activeObj.strokeSettings.radius}}),this.objColl.push(this.activeObj),(this.activeObj.activePoint.width!==0||this.activeObj.activePoint.height!==0)&&this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:u,previousObjColl:u.objColl,previousPointColl:u.pointColl,previousSelPointColl:u.selPointColl,previousCropObj:p,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.notify("selection",{prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}});var g={action:"stroke-width",currentShapeSettings:f({},n,{},!0)};g.currentShapeSettings[r==="width"?o==="text"?"outlineWidth":"strokeWidth":"radius"]=this.activeObj.strokeSettings[r==="width"?o==="text"?"outlineWidth":"strokeWidth":"radius"],this.trigger("shapeChange",g),this.editCompleteArgs=g}else this.activeObj.shape&&this.activeObj.shape==="path"&&this.activeObj.pointColl.length===0&&(this.activeObj.strokeSettings.strokeWidth=parseInt(t,10),this.activeObj.strokeSettings.strokeWidth*=2,r==="width"?o==="text"?this.notify("shape",{prop:"setStrokeSettings",value:{strokeSettings:null,strokeColor:null,fillColor:null,strokeWidth:null,radius:null,outlineWidth:this.activeObj.strokeSettings.outlineWidth}}):this.notify("shape",{prop:"setStrokeSettings",value:{strokeSettings:null,strokeColor:null,fillColor:null,strokeWidth:this.activeObj.strokeSettings.strokeWidth,radius:null,outlineWidth:null}}):this.notify("shape",{prop:"setStrokeSettings",value:{strokeSettings:null,strokeColor:null,fillColor:null,strokeWidth:null,radius:this.activeObj.strokeSettings.radius}}))},e.prototype.updateStrokeColor=function(t){var r={shapeSettingsObj:{}};this.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:r}});var o=r.shapeSettingsObj;if(this.activeObj.shape&&(this.activeObj.shape!=="path"||this.activeObj.shape==="path"&&this.activeObj.pointColl.length>0)){var a=!1,n=this.objColl.length;this.notify("shape",{prop:"pushActItemIntoObj"}),n!==this.objColl.length&&(a=!0);var s=f({},this.cropObj,{},!0),l={currObj:{}};this.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:l}});var p=l.currObj;p.objColl=f([],this.objColl,[],!0),p.pointColl=f([],this.pointColl,[],!0),p.afterCropActions=f([],this.afterCropActions,[],!0);var h={selPointColl:null};this.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:h}}),p.selPointColl=f([],h.selPointColl,[],!0),a&&this.objColl.pop(),this.activeObj.strokeSettings.strokeColor=t,this.notify("shape",{prop:"setStrokeSettings",value:{strokeSettings:null,strokeColor:this.activeObj.strokeSettings.strokeColor,fillColor:null,strokeWidth:null}}),this.togglePen||(this.objColl.push(this.activeObj),(this.activeObj.activePoint.width!==0||this.activeObj.activePoint.height!==0)&&this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:p,previousObjColl:p.objColl,previousPointColl:p.pointColl,previousSelPointColl:p.selPointColl,previousCropObj:s,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.notify("selection",{prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}}))}else this.activeObj.shape&&this.activeObj.shape==="path"&&this.activeObj.pointColl.length===0&&(this.activeObj.strokeSettings.strokeColor=t,this.notify("shape",{prop:"setStrokeSettings",value:{strokeSettings:null,strokeColor:this.activeObj.strokeSettings.strokeColor,fillColor:null,strokeWidth:null}}));var u={action:"stroke-color",currentShapeSettings:f({},o,{},!0)};u.currentShapeSettings.strokeColor=t,this.trigger("shapeChange",u),this.editCompleteArgs=u},e.prototype.updateFillColor=function(t){var r={shapeSettingsObj:{}};this.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:r}});var o=r.shapeSettingsObj,a=!1,n=this.objColl.length;this.notify("shape",{prop:"pushActItemIntoObj"}),n!==this.objColl.length&&(a=!0);var s=f({},this.cropObj,{},!0),l={currObj:{}};this.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:l}});var p=l.currObj;p.objColl=f([],this.objColl,[],!0),p.pointColl=f([],this.pointColl,[],!0),p.afterCropActions=f([],this.afterCropActions,[],!0);var h={selPointColl:null};this.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:h}}),p.selPointColl=f([],h.selPointColl,[],!0),a&&this.objColl.pop(),this.activeObj.strokeSettings.fillColor=t,this.notify("shape",{prop:"setStrokeSettings",value:{strokeSettings:null,strokeColor:null,fillColor:this.activeObj.strokeSettings.fillColor,strokeWidth:null}}),this.objColl.push(this.activeObj),(this.activeObj.activePoint.width!==0||this.activeObj.activePoint.height!==0)&&this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:p,previousObjColl:p.objColl,previousPointColl:p.pointColl,previousSelPointColl:p.selPointColl,previousCropObj:s,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.notify("selection",{prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}});var u={action:"fill-color",currentShapeSettings:f({},o,{},!0)};this.trigger("shapeChange",u),this.editCompleteArgs=u},e.prototype.horizontalFlip=function(t,r){var o,a;if(C(r)){C(this.activeObj.imageRatio)&&this.notify("shape",{prop:"updImgRatioForActObj",onPropertyChange:!1}),this.notify("shape",{prop:"pushActItemIntoObj"}),o=f({},this.cropObj,{},!0);var n={currObj:{}};this.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:n}}),a=n.currObj,a.objColl=f([],this.objColl,[],!0),a.pointColl=f([],this.pointColl,[],!0),a.afterCropActions=f([],this.afterCropActions,[],!0);var s={selPointColl:null};this.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:s}}),a.selPointColl=f([],s.selPointColl,[],!0),this.objColl.pop()}this.notify("toolbar",{prop:"refreshSlider"}),t.clearRect(0,0,this.activeObj.imageCanvas.width,this.activeObj.imageCanvas.height);var l=this.duplicateImage();this.notify("draw",{prop:"downScaleImgCanvas",onPropertyChange:!1,value:{ctx:this.activeObj.imageCanvas.getContext("2d"),isImgAnnotation:!0,isHFlip:!0,isVFlip:null}}),this.activeObj.activePoint=l,this.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}}),C(r)&&(this.objColl.push(this.activeObj),this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"imageHFlip",previousObj:a,previousObjColl:a.objColl,previousPointColl:a.pointColl,previousSelPointColl:a.selPointColl,previousCropObj:o,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.notify("selection",{prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}}))},e.prototype.verticalFlip=function(t,r){var o,a;if(C(r)){C(this.activeObj.imageRatio)&&this.notify("shape",{prop:"updImgRatioForActObj",onPropertyChange:!1}),this.notify("shape",{prop:"pushActItemIntoObj"}),o=f({},this.cropObj,{},!0);var n={currObj:{}};this.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:n}}),a=n.currObj,a.objColl=f([],this.objColl,[],!0),a.pointColl=f([],this.pointColl,[],!0),a.afterCropActions=f([],this.afterCropActions,[],!0);var s={selPointColl:null};this.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:s}}),a.selPointColl=f([],s.selPointColl,[],!0),this.objColl.pop()}this.notify("toolbar",{prop:"refreshSlider"}),t.clearRect(0,0,this.activeObj.imageCanvas.width,this.activeObj.imageCanvas.height);var l=this.duplicateImage();this.notify("draw",{prop:"downScaleImgCanvas",onPropertyChange:!1,value:{ctx:this.activeObj.imageCanvas.getContext("2d"),isImgAnnotation:!0,isHFlip:null,isVFlip:!0}}),this.activeObj.activePoint=l,this.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}}),C(r)&&(this.objColl.push(this.activeObj),this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"imageVFlip",previousObj:a,previousObjColl:a.objColl,previousPointColl:a.pointColl,previousSelPointColl:a.selPointColl,previousCropObj:o,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.notify("selection",{prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}}))},e.prototype.rotateImage=function(t){var r,o;C(this.activeObj.imageRatio)&&this.notify("shape",{prop:"updImgRatioForActObj",onPropertyChange:!1}),this.notify("shape",{prop:"pushActItemIntoObj"}),r=f({},this.cropObj,{},!0);var a={currObj:{}};this.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:a}}),o=a.currObj,o.objColl=f([],this.objColl,[],!0),o.pointColl=f([],this.pointColl,[],!0),o.afterCropActions=f([],this.afterCropActions,[],!0);var n={selPointColl:null};this.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:n}}),o.selPointColl=f([],n.selPointColl,[],!0),this.objColl.pop(),this.notify("toolbar",{prop:"refreshSlider"}),t==="rotleft"?this.activeObj.rotatedAngle-=90*(Math.PI/180):this.activeObj.rotatedAngle+=90*(Math.PI/180),this.notify("selection",{prop:"updPtCollForShpRot",onPropertyChange:!1,value:{obj:this.activeObj}}),this.upperContext.clearRect(0,0,this.upperCanvas.width,this.upperCanvas.height),this.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}}),this.objColl.push(this.activeObj),this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"imageRotate",previousObj:o,previousObjColl:o.objColl,previousPointColl:o.pointColl,previousSelPointColl:o.selPointColl,previousCropObj:r,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),this.notify("selection",{prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}}),this.notify("toolbar",{prop:"destroy-qa-toolbar"}),this.notify("toolbar",{prop:"renderQAT",onPropertyChange:!1,value:{isPenEdit:null}})},e.prototype.pascalToSplitWords=function(t){t=t.charAt(0).toUpperCase()+t.slice(1);var r=t.match(/[A-Z][a-z]+/g);return C(r)?t:r.map(function(o){return o.charAt(0).toUpperCase()+o.slice(1)}).join(" ")},e.prototype.getCurrAdjustmentValue=function(t){var r=100,o={freehandSelectedIndex:null};if(this.notify("freehand-draw",{prop:"getFreehandSelectedIndex",onPropertyChange:!1,value:{obj:o}}),t==="transparency"&&this.togglePen){var a={penOpacity:1};this.notify("freehand-draw",{prop:"getPenOpacity",onPropertyChange:!1,value:{obj:a}}),r=a.penOpacity*100}else if(t==="transparency"&&o.freehandSelectedIndex!==null&&o.freehandSelectedIndex!==void 0)r=this.pointColl[o.freehandSelectedIndex].opacity*100;else{var a={adjustmentLevel:null};this.notify("filter",{prop:"getAdjustmentLevel",onPropertyChange:!1,value:{obj:a}});var n={brightness:a.adjustmentLevel.brightness,contrast:a.adjustmentLevel.contrast,hue:a.adjustmentLevel.hue,saturation:a.adjustmentLevel.saturation,opacity:a.adjustmentLevel.opacity,blur:a.adjustmentLevel.blur,exposure:a.adjustmentLevel.exposure,transparency:a.adjustmentLevel.transparency,straighten:this.transform.straighten};r=n[""+t]}return r},e.prototype.transformSelect=function(t){this.transform.straighten===0&&(t==="rotateleft"||t==="rotateright")&&this.activeObj.shape&&(["crop-2:3","crop-3:2","crop-3:4","crop-4:3","crop-4:5","crop-5:4","crop-5:7","crop-7:5","crop-9:16","crop-16:9"].indexOf(this.activeObj.shape)!==-1||this.activeObj.shape.indexOf("crop-")!==-1&&this.activeObj.shape!=="crop-custom"&&this.activeObj.shape!=="crop-square"&&this.activeObj.shape!=="crop-circle")&&(this.activeObj.shape="crop-"+this.activeObj.shape.split("-")[1].split(":")[1]+":"+this.activeObj.shape.split("-")[1].split(":")[0],this.notify("toolbar",{prop:"performCropTransformClick",value:{shape:this.activeObj.shape,isTransform:!0}})),this.isCropToolbar=!0,this.allowDownScale=!1;var r=this.transform.straighten,o=f({},this.activeObj,{},!0),a=this.transform.zoomFactor;this.prevEventSelectionPoint=f({},this.activeObj,{},!0);var n={currObj:{}};this.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:n}}),this.prevEventObjPoint=n.currObj,this.prevEventObjPoint.objColl=f([],this.objColl,[],!0),this.prevEventObjPoint.pointColl=f([],this.pointColl,[],!0),this.prevEventObjPoint.afterCropActions=f([],this.afterCropActions,[],!0);var s={selPointColl:null};if(this.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:s}}),this.prevEventObjPoint.selPointColl=f([],s.selPointColl,[],!0),this.transform.straighten!==0){this.transform.straighten=0,this.straightenBaseImageCanvas();for(var l=0,p=this.objColl.length;l<p;l++){var h=this.objColl[l].shape;h!=="line"&&h!=="arrow"&&h!=="path"&&(this.objColl[l].rotatedAngle-=r*(Math.PI/180),this.notify("selection",{prop:"updPtCollForShpRot",onPropertyChange:!1,value:{obj:this.objColl[l]}}))}this.notify("draw",{prop:"render-image",value:{isMouseWheel:!1}}),this.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}})}this.setInitialZoomState();var u=f({},this.activeObj,{},!0);if(this.notify("crop",{prop:"setTransformCrop",onPropertyChange:!1,value:{bool:!0}}),this.cropSelectedState(),this.notify("crop",{prop:"setTransformCrop",onPropertyChange:!1,value:{bool:!1}}),this.notify("draw",{prop:"resetCurrentSelectionPoint"}),this.updateImageTransformColl(t),this.notify("transform",{prop:"performTransformation",value:{text:t}}),this.isCropTab=!0,this.notify("draw",{prop:"moveToSelectionRange",value:{type:t,activeObj:u}}),this.isStraightening&&(t==="horizontalflip"||t==="verticalflip")&&(this.notify("draw",{prop:"resetStraightenDestPoints"}),this.notify("draw",{prop:"setDestForStraighten"})),r!==0){this.transform.straighten=r,this.straightenBaseImageCanvas();for(var l=0,p=this.objColl.length;l<p;l++){var h=this.objColl[l].shape;h!=="line"&&h!=="arrow"&&h!=="path"&&(this.objColl[l].rotatedAngle+=r*(Math.PI/180),this.notify("selection",{prop:"updPtCollForShpRot",onPropertyChange:!1,value:{obj:this.objColl[l]}}))}this.notify("shape",{prop:"drawAnnotations",onPropertyChange:!1,value:{ctx:this.lowerContext,shape:"zoom",pen:"zoom",isPreventApply:null}}),this.notify("draw",{prop:"render-image",value:{isMouseWheel:!1}}),this.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:o}}),this.notify("draw",{prop:"setStraightenActObj",value:{activeObj:null}}),this.notify("draw",{prop:"setStraightenInitZoom",value:{zoomFactor:a}}),(this.isStraightening&&(t==="horizontalflip"||t==="verticalflip")&&C(this.transform.zoomFactor)||this.transform.zoomFactor===0)&&(this.transform.degree===0?this.transform.zoomFactor+=.025:this.transform.zoomFactor===0&&(this.transform.zoomFactor=null)),this.notify("draw",{prop:"zoomToSel",value:{activeObj:o,isToolbar:!1}})}this.isCropToolbar=!1;var c=this.element.querySelector(".e-ie-straighten-value-span");c&&(c.innerHTML=this.transform.straighten.toString()+"&#176")},e.prototype.getDefaultFilter=function(){return"brightness(1) contrast(100%) hue-rotate(0deg) saturate(100%) opacity(1) blur(0px) sepia(0%) grayscale(0%) invert(0%)"},e.prototype.setStraighten=function(t){var r={cancel:!1,previousDegree:this.transform.straighten,currentDegree:t};if(this.trigger("rotating",r),this.editCompleteArgs=r,!r.cancel){this.performStraighten(r);var o={action:"straighten",actionEventArgs:this.editCompleteArgs};this.triggerEditCompleteEvent(o)}},e.prototype.duplicateImage=function(){var t=f({},this.activeObj.activePoint,{},!0),r={width:0,height:0};return this.notify("transform",{prop:"calcMaxDimension",onPropertyChange:!1,value:{width:this.activeObj.imageElement.width,height:this.activeObj.imageElement.height,obj:r,isImgShape:null}}),this.activeObj.activePoint.width=r.width,this.activeObj.activePoint.height=r.height,t},e.prototype.performStraighten=function(t){var r=t.currentDegree,o=this.element.querySelector(".e-ie-straighten-value-span");o&&(o.innerHTML=r.toString()+"&#176");var a=f({},this.activeObj,null,!0);this.notify("freehand-draw",{prop:"setCenterSelPoints"}),this.transform.straighten=r,this.straightenPoint={x:this.activeObj.activePoint.startX+this.activeObj.activePoint.width/2,y:this.activeObj.activePoint.startY+this.activeObj.activePoint.height/2},this.straightenBaseImageCanvas();for(var n=0,s=this.objColl.length;n<s;n++){var l=this.objColl[n].shape;l!=="line"&&l!=="arrow"&&l!=="path"&&(this.objColl[n].rotatedAngle+=(this.transform.straighten-this.prevStraightenedDegree)*(Math.PI/180),this.notify("selection",{prop:"updPtCollForShpRot",onPropertyChange:!1,value:{obj:this.objColl[n]}}))}this.transform.degree%90===0&&this.transform.degree%180!==0?(this.transform.straighten===0&&(this.transform.straighten=360),this.notify("draw",{prop:"performPointZoom",onPropertyChange:!1,value:{x:this.activeObj.activePoint.startX+this.activeObj.activePoint.width/2,y:this.activeObj.activePoint.startY+this.activeObj.activePoint.height/2,type:"zoomIn",isResize:!0}}),this.notify("draw",{prop:"performPointZoom",onPropertyChange:!1,value:{x:this.activeObj.activePoint.startX+this.activeObj.activePoint.width/2,y:this.activeObj.activePoint.startY+this.activeObj.activePoint.height/2,type:"zoomOut",isResize:!0}}),this.transform.straighten===360&&(this.transform.straighten=0)):this.notify("draw",{prop:"render-image",value:{isMouseWheel:!0,isPreventClearRect:null,isFrame:null,isStraighten:!0}}),this.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:a}}),this.notify("draw",{prop:"zoomToSel",value:{activeObj:a,isToolbar:!0}}),this.notify("transform",{prop:"disableZoomOutBtn",value:{isZoomOut:!0}}),this.prevStraightenedDegree=this.transform.straighten},e.prototype.straightenBaseImageCanvas=function(){if(this.isImageLoaded){var t=this.getStraightenFlipState(),r=t==="horizontal"||t==="vertical"?-this.transform.straighten:this.transform.straighten,o=this.baseImgCanvas.getContext("2d");if(o.canvas.width!==this.lowerContext.canvas.width&&o.canvas.height!==this.lowerContext.canvas.height){var a={width:0,height:0};this.notify("crop",{prop:"calcRatio",onPropertyChange:!1,value:{obj:a,dimension:{width:o.canvas.width,height:o.canvas.height}}})}var n=void 0;n=this.getRotatedCanvasDim(this.baseImg.width,this.baseImg.height,this.transform.straighten),this.img.srcWidth=o.canvas.width=n.width,this.img.srcHeight=o.canvas.height=n.height;var s=o.canvas.width/2,l=o.canvas.height/2;o.clearRect(0,0,o.canvas.width,o.canvas.height),o.translate(s,l),o.rotate(r*Math.PI/180),o.drawImage(this.baseImg,-this.baseImg.width/2,-this.baseImg.height/2,this.baseImg.width,this.baseImg.height),o.setTransform(1,0,0,1,0,0);var p={width:0,height:0};this.notify("crop",{prop:"calcRatio",onPropertyChange:!1,value:{obj:p,dimension:{width:o.canvas.width,height:o.canvas.height}}})}},e.prototype.getRotatedCanvasDim=function(t,r,o){var a=o*Math.PI/180,n=Math.cos(a),s=Math.sin(a),l=Math.min(0,t*n,r*Math.cos(Math.PI/2-a),t*n+r*Math.cos(Math.PI/2-a)),p=Math.max(0,t*n,r*Math.cos(Math.PI/2-a),t*n+r*Math.cos(Math.PI/2-a)),h=Math.min(0,t*s,r*Math.sin(Math.PI/2-a),t*s+r*Math.sin(Math.PI/2-a)),u=Math.max(0,t*s,r*Math.sin(Math.PI/2-a),t*s+r*Math.sin(Math.PI/2-a));return{width:Math.ceil(p-l),height:Math.ceil(u-h)}},e.prototype.updateShapeOrder=function(t,r){var o=this.getObjFromId(t);if(o.shape&&(o.shape!=="path"||o.shape==="path"&&o.pointColl.length>0)||o&&o.id&&o.id.indexOf("pen")>-1){var a={shapeSettingsObj:{}};this.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:a}});var n=a.shapeSettingsObj;o.shape&&this.notify("shape",{prop:"pushActItemIntoObj"});var s=f({},this.cropObj,{},!0),l={currObj:{}};this.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:l}});var p=l.currObj;p.objColl=f([],this.objColl,[],!0),p.pointColl=f([],this.pointColl,[],!0),p.afterCropActions=f([],this.afterCropActions,[],!0);var h={selPointColl:null};this.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:h}}),p.selPointColl=f([],h.selPointColl,[],!0),o.shape&&this.objColl.pop(),this.notify("shape",{prop:"z-order",onPropertyChange:!1,value:{obj:o,value:r}}),o.shape&&(this.notify("shape",{prop:"setStrokeSettings",value:{strokeSettings:null,strokeColor:null,fillColor:null,strokeWidth:o.strokeSettings.strokeWidth}}),this.objColl.push(o)),this.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:p,previousObjColl:p.objColl,previousPointColl:p.pointColl,previousSelPointColl:p.selPointColl,previousCropObj:s,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),o.shape&&(this.notify("selection",{prop:"redrawShape",value:{obj:this.objColl[this.objColl.length-1]}}),this.activeObj.order=o.order);var u={action:"stroke-width",previousShapeSettings:f({},n,{},!0),currentShapeSettings:f({},n,{},!0)};u.currentShapeSettings.strokeWidth=this.activeObj.strokeSettings.strokeWidth}else this.activeObj.shape&&this.activeObj.shape==="path"&&this.activeObj.pointColl.length===0&&this.notify("shape",{prop:"setStrokeSettings",value:{strokeSettings:null,strokeColor:null,fillColor:null,strokeWidth:this.activeObj.strokeSettings.strokeWidth}})},e.prototype.getStraightenFlipState=function(){var t="";if(this.rotateFlipColl.length>0)for(var r=0,o=this.rotateFlipColl.length;r<o;r++){var a=this.rotateFlipColl[r];a==="horizontal"?t+="horizontal":a==="vertical"&&(t+="vertical"),(t==="horizontalvertical"||t==="verticalhorizontal")&&(t="")}return t},e.prototype.initializeZoomSettings=function(){this.theme=C(this.theme)?"Bootstrap5":this.theme,(C(this.zoomSettings.zoomTrigger)||this.zoomSettings.zoomTrigger===0)&&(this.zoomSettings.zoomTrigger=U.MouseWheel|U.Pinch|U.Toolbar|U.Commands),C(this.selectionSettings.strokeColor)&&(this.selectionSettings.strokeColor=this.themeColl[this.theme].primaryColor),C(this.selectionSettings.fillColor)&&(this.selectionSettings.fillColor=this.themeColl[this.theme].secondaryColor)},e.prototype.initializeThemeColl=function(){this.themeColl={Bootstrap5:{primaryColor:"#0d6efd",secondaryColor:"#fff"},Bootstrap5Dark:{primaryColor:"#0d6efd",secondaryColor:"#fff"},Tailwind:{primaryColor:"#4f46e5",secondaryColor:"#fff"},TailwindDark:{primaryColor:"#22d3ee",secondaryColor:"#fff"},Fluent:{primaryColor:"#0078d4",secondaryColor:"#fff"},FluentDark:{primaryColor:"#0078d4",secondaryColor:"#fff"},Bootstrap4:{primaryColor:"#007bff",secondaryColor:"#fff"},Bootstrap:{primaryColor:"#317ab9",secondaryColor:"#fff"},BootstrapDark:{primaryColor:"#317ab9",secondaryColor:"#fff"},Material:{primaryColor:"#e3165b",secondaryColor:"#fff"},MaterialDark:{primaryColor:"#00b0ff",secondaryColor:"#fff"},Fabric:{primaryColor:"#0078d6",secondaryColor:"#fff"},FabricDark:{primaryColor:"#0074cc",secondaryColor:"#fff"},Highcontrast:{primaryColor:"#000000",secondaryColor:"#fff"},Material3:{primaryColor:"#6750a4",secondaryColor:"#fff"},Material3Dark:{primaryColor:"#d0bcff",secondaryColor:"#fff"},Fluent2:{primaryColor:"#0f6cbd",secondaryColor:"#fff"},Fluent2Dark:{primaryColor:"#115ea3",secondaryColor:"#fff"},Fluent2Highcontrast:{primaryColor:"#1aebff",secondaryColor:"#fff"},"Bootstrap5.3":{primaryColor:"#0d6efd",secondaryColor:"#fff"},"Bootstrap5.3Dark":{primaryColor:"#0d6efd",secondaryColor:"#fff"},Tailwind3:{primaryColor:"#4f46e5",secondaryColor:"#ffffff"},Tailwind3Dark:{primaryColor:"#6366f1",secondaryColor:"#ffffff03"}}},e.prototype.drawRedact=function(t,r,o,a,n,s){var l=!1,p=this.allowShape(r,o);return!this.disabled&&this.isImageLoaded&&(p||C(r)&&C(o))&&(l=!0,this.manageActiveAction(),this.notify("shape",{prop:"drawRedact",onPropertyChange:!1,value:{x:r,y:o,width:a,height:n,type:t,value:s}}),this.notify("draw",{prop:"redrawDownScale"})),l};var i;return z([X("")],e.prototype,"cssClass",void 0),z([X(!1)],e.prototype,"disabled",void 0),z([X("100%")],e.prototype,"height",void 0),z([X("Bootstrap5")],e.prototype,"theme",void 0),z([X()],e.prototype,"toolbar",void 0),z([X()],e.prototype,"toolbarTemplate",void 0),z([X("100%")],e.prototype,"width",void 0),z([X(!0)],e.prototype,"allowUndoRedo",void 0),z([X(!0)],e.prototype,"showQuickAccessToolbar",void 0),z([X()],e.prototype,"quickAccessToolbarTemplate",void 0),z([X(!1)],e.prototype,"isReadOnly",void 0),z([X(!1)],e.prototype,"enableRtl",void 0),z([X(!1)],e.prototype,"enablePersistence",void 0),z([be({},gi)],e.prototype,"finetuneSettings",void 0),z([be({},Ci)],e.prototype,"zoomSettings",void 0),z([be({},mi)],e.prototype,"selectionSettings",void 0),z([be({},bi)],e.prototype,"fontFamily",void 0),z([be({},vi)],e.prototype,"uploadSettings",void 0),z([M()],e.prototype,"beforeSave",void 0),z([M()],e.prototype,"created",void 0),z([M()],e.prototype,"destroyed",void 0),z([M()],e.prototype,"zooming",void 0),z([M()],e.prototype,"panning",void 0),z([M()],e.prototype,"cropping",void 0),z([M()],e.prototype,"rotating",void 0),z([M()],e.prototype,"flipping",void 0),z([M()],e.prototype,"shapeChanging",void 0),z([M()],e.prototype,"selectionChanging",void 0),z([M()],e.prototype,"fileOpened",void 0),z([M()],e.prototype,"saved",void 0),z([M()],e.prototype,"toolbarCreated",void 0),z([M()],e.prototype,"toolbarUpdating",void 0),z([M()],e.prototype,"toolbarItemClicked",void 0),z([M()],e.prototype,"imageFiltering",void 0),z([M()],e.prototype,"finetuneValueChanging",void 0),z([M()],e.prototype,"click",void 0),z([M()],e.prototype,"shapeChange",void 0),z([M()],e.prototype,"quickAccessToolbarOpen",void 0),z([M()],e.prototype,"resizing",void 0),z([M()],e.prototype,"quickAccessToolbarItemClick",void 0),z([M()],e.prototype,"frameChange",void 0),z([M()],e.prototype,"editComplete",void 0),e=i=z([wt],e),e}(xt),vt;(function(d){d.Png="Png",d.Jpeg="Jpeg",d.Svg="Svg",d.WebP="WebP"})(vt||(vt={}));var Xe;(function(d){d.Horizontal="Horizontal",d.Vertical="Vertical"})(Xe||(Xe={}));var se;(function(d){d.Rectangle="Rectangle",d.Ellipse="Ellipse",d.Line="Line",d.Arrow="Arrow",d.Path="Path",d.Text="Text",d.FreehandDraw="FreehandDraw",d.Image="Image"})(se||(se={}));var U;(function(d){d[d.MouseWheel=1]="MouseWheel",d[d.Pinch=2]="Pinch",d[d.Commands=4]="Commands",d[d.Toolbar=8]="Toolbar"})(U||(U={}));var gt;(function(d){d.Bootstrap5="Bootstrap5",d.Bootstrap5Dark="Bootstrap5Dark",d.Tailwind="Tailwind",d.TailwindDark="TailwindDark",d.Fluent="Fluent",d.FluentDark="FluentDark",d.Bootstrap4="Bootstrap4",d.Bootstrap="Bootstrap",d.BootstrapDark="BootstrapDark",d.Material="Material",d.MaterialDark="MaterialDark",d.Fabric="Fabric",d.FabricDark="FabricDark",d.Highcontrast="Highcontrast",d.Fluent2="Fluent2",d.Fluent2Dark="Fluent2Dark",d.Tailwind3="Tailwind3",d.Tailwind3Dark="Tailwind3Dark"})(gt||(gt={}));var Ct;(function(d){d.Crop="Crop",d.Transform="Transform",d.Annotate="Annotate",d.ZoomIn="ZoomIn",d.ZoomOut="ZoomOut",d.Open="Open",d.Reset="Reset",d.Save="Save",d.Pan="Pan",d.Move="Move",d.Pen="Pen",d.Line="Line",d.Arrow="Arrow",d.Path="Path",d.Rectangle="Rectangle",d.Image="Image",d.Ellipse="Ellipse",d.Text="Text",d.CustomSelection="CustomSelection",d.CircleSelection="CircleSelection",d.SquareSelection="SquareSelection",d.RatioSelection="RatioSelection",d.RotateLeft="RotateLeft",d.RotateRight="RotateRight",d.FlipHorizontal="FlipHorizontal",d.FlipVertical="FlipVertical",d.Undo="Undo",d.Redo="Redo",d.None="None",d.Mat="Mat",d.Bevel="Bevel",d.Inset="Inset",d.Hook="Hook",d.Finetune="Finetune",d.Filter="Filter",d.Frame="Frame",d.Resize="Resize",d.HorizontalFlip="HorizontalFlip",d.VerticalFlip="VerticalFlip",d.Brightness="Brightness",d.Contrast="Contrast",d.Hue="Hue",d.Saturation="Saturation",d.Opacity="Opacity",d.Blur="Blur",d.Exposure="Exposure",d.Default="Default",d.Chrome="Chrome",d.Cold="Cold",d.Warm="Warm",d.Grayscale="Grayscale",d.Sepia="Sepia",d.Invert="Invert",d.Straightening="Straightening"})(Ct||(Ct={}));var mt;(function(d){d.Default="Default",d.Chrome="Chrome",d.Cold="Cold",d.Warm="Warm",d.Grayscale="Grayscale",d.Sepia="Sepia",d.Invert="Invert"})(mt||(mt={}));var fe;(function(d){d.Brightness="Brightness",d.Contrast="Contrast",d.Hue="Hue",d.Saturation="Saturation",d.Exposure="Exposure",d.Opacity="Opacity",d.Blur="Blur"})(fe||(fe={}));var Se;(function(d){d.None="None",d.Arrow="Arrow",d.SolidArrow="SolidArrow",d.Circle="Circle",d.SolidCircle="SolidCircle",d.Square="Square",d.SolidSquare="SolidSquare",d.Bar="Bar"})(Se||(Se={}));var bt;(function(d){d.None="None",d.Mat="Mat",d.Bevel="Bevel",d.Line="Line",d.Inset="Inset",d.Hook="Hook"})(bt||(bt={}));var Ne;(function(d){d.Solid="Solid",d.Dashed="Dashed",d.Dotted="Dotted"})(Ne||(Ne={}));var Ve;(function(d){d.Blur="Blur",d.Pixelate="Pixelate"})(Ve||(Ve={}));var Pi=function(){function d(e){this.defToolbarItems=[],this.toolbarHeight=46,this.currToolbar="",this.preventZoomBtn=!1,this.currentToolbar="main",this.selFhdColor="#42a5f5",this.preventEnableDisableUr=!1,this.isAspectRatio=!0,this.isFrameToolbar=!1,this.presetColors={custom:["#000000","#f44336","#e91e63","#9c27b0","#673ab7","#2196f3","#03a9f4","#00bcd4","#009688","#ffeb3b","#ffffff","#ffebee","#fce4ec","#f3e5f5","#ede7f6","#e3f2fd","#e1f5fe","#e0f7fa","#e0f2f1","#fffde7","#f2f2f2","#ffcdd2","#f8bbd0","#e1bee7","#d1c4e9","#bbdefb","#b3e5fc","#b2ebf2","#b2dfdb","#fff9c4","#e6e6e6","#ef9a9a","#f48fb1","#ce93d8","#b39ddb","#90caf9","#81d4fa","#80deea","#80cbc4","#fff59d","#cccccc","#e57373","#f06292","#ba68c8","#9575cd","#64b5f6","#4fc3f7","#4dd0e1","#4db6ac","#fff176","#b3b3b3","#ef5350","#ec407a","#ab47bc","#7e57c2","#42a5f5","#29b6f6","#26c6da","#26a69a","#ffee58","#999999","#e53935","#d81b60","#8e24aa","#5e35b1","#1e88e5","#039be5","#00acc1","#00897b","#fdd835","#808080","#d32f2f","#c2185b","#7b1fa2","#512da8","#1976d2","#0288d1","#0097a7","#00796b","#fbc02d","#666666","#c62828","#ad1457","#6a1b9a","#4527a0","#1565c0","#0277bd","#00838f","#00695c","#f9a825","#4d4d4d","#b71c1c","#880e4f","#4a148c","#311b92","#0d47a1","#01579b","#006064","#004d40","#f57f17"]},this.isSlider=!1,this.currentQuality=1,this.imageQuality="highest",this.parent=e,this.addEventListener(),this.initLocale()}return d.prototype.destroy=function(){this.parent.isDestroyed||this.removeEventListener()},d.prototype.addEventListener=function(){this.parent.on("toolbar",this.toolbar,this),this.parent.on("destroyed",this.destroy,this)},d.prototype.removeEventListener=function(){this.parent.off("toolbar",this.toolbar),this.parent.off("destroyed",this.destroy)},d.prototype.initLocale=function(){this.defaultLocale={Crop:"Crop",ZoomIn:"Zoom In",ZoomOut:"Zoom Out",Undo:"Undo",Redo:"Redo",Transform:"Transform",Annotation:"Annotation",Finetune:"Finetune",Brightness:"Brightness",Contrast:"Contrast",Hue:"Hue",Saturation:"Saturation",Opacity:"Opacity",Blur:"Blur",Sharpen:"Sharpen",Exposure:"Exposure",Filter:"Filter",Default:"Default",Chrome:"Chrome",Cold:"Cold",Warm:"Warm",Grayscale:"Grayscale",BlackAndWhite:"Black and White",Sepia:"Sepia",Invert:"Invert",Text:"Add Text",Pen:"Pen",Reset:"Reset",Save:"Save",Select:"Select",RotateLeft:"Rotate Left",RotateRight:"Rotate Right",HorizontalFlip:"Horizontal Flip",VerticalFlip:"Vertical Flip",OK:"Apply",Cancel:"Discard",FillColor:"Fill Color",StrokeColor:"Stroke Color",StrokeWidth:"Stroke Width",FontFamily:"Font Family",FontStyle:"Font Style",FontSize:"Font Size",FontColor:"Font Color",Pan:"Pan",Move:"Move",Load:"Load",Custom:"Custom",Square:"Square",Circle:"Circle",Ellipse:"Ellipse",Rectangle:"Rectangle",Line:"Line",Arrow:"Arrow",Path:"Path",Bold:"Bold",Italic:"Italic",BoldItalic:"Bold Italic",XSmall:"X-Small",Small:"Small",Medium:"Medium",Large:"Large",XLarge:"X-Large",ABC:"ABC",Browse:"Browse",Duplicate:"Duplicate",Remove:"Remove",EditText:"Edit Text",Start:"Start",End:"End",Bar:"Bar",ArrowSolid:"Arrow Solid",CircleSolid:"Circle Solid",SquareSolid:"Square Solid",None:"None",CropAndTransform:"Crop and Transform",CropSelection:"Crop Selection",Image:"Add Image",Transparency:"Transparency",Height:"Height",Width:"Width",AspectRatio:"Maintain aspect ratio",W:"W",H:"H",DragText:"Drag and drop your image here or",DropText:"Drop your image here or",BrowseText:"Browse here...",SupportText:"Supports:",Frame:"Frame",Mat:"Mat",Bevel:"Bevel",Inset:"Inset",Hook:"Hook",Color:"Color",Size:"Size",Offset:"Offset",Radius:"Radius",Amount:"Amount",Resize:"Resize",0:"0%",20:"20%",40:"40%",60:"60%",80:"80%",100:"100%",1:"1",2:"2",3:"3",4:"4",5:"5",Border:"Border",Solid:"Solid",Dashed:"Dashed",Dotted:"Dotted",GradientColor:"Gradient Color",ConfirmDialogHeader:"Confirm Save Changes",ConfirmDialogContent:"Do you want to save the changes you made to the image?",AlertDialogHeader:"Unsupported file",AlertDialogContent:"The selected file is unsupported.",MinMaxSize:"with file size between",MinMaxSizeAlert:"File size between",MinSize:"with minimum file size of",MinSizeAlert:"A minimum file size of",MaxSize:"with maximum file size of",MaxSizeAlert:"A maximum file size of",To:"to",Bytes:"bytes",Yes:"Yes",No:"No",ImageErrorDialogHeader:"Image Selection Error",ImageErrorDialogContent:"Please select only one image to open.",Straighten:"Straighten",NoOutline:"No outline",DlgOK:"OK",SaveAs:"Save As",ImageName:"Image name",Format:"Format",Quality:"Quality",Download:"Download",Close:"Close",ImageSize:"Image Size",QualityInfo:"The image quality option is only available for JPEG format",Good:"Good",Great:"Great",Highest:"Highest",BringForward:"Bring Forward",SendBackward:"Send Backward",SendToBack:"Send to Back",BringToFront:"Bring to Front",ZOrder:"Z-Order",Redact:"Redact",Pixelate:"Pixelate",BorderRadius:"Border Radius",TextOutlineColor:"Outline Color",TextOutlineWidth:"Outline Width",PixelSize:"Pixel Size",And:"and"},this.l10n=new Pt("image-editor",this.defaultLocale,this.parent.locale)},d.prototype.toolbar=function(e){var i=this.parent;switch(this.updatePrivateVariables(),e.prop){case"create-toolbar":this.createToolbar();break;case"create-contextual-toolbar":this.createContextualToolbar();break;case"update-toolbar-items":this.updateToolbarItems();break;case"refresh-toolbar":this.refreshToolbar(e.value.type,e.value.isApplyBtn,e.value.isCropping,e.value.isZooming,e.value.cType);break;case"renderQAT":this.renderQAT(e.value.isPenEdit);break;case"enable-disable-btns":this.enableDisableTbrBtn();break;case"init-main-toolbar":this.initMainToolbar(e.value.isApplyBtn,e.value.isDevice,e.value.isOkBtn,e.value.isResize,e.value.isFrame,e.value.isMainToolbar);break;case"create-bottom-toolbar":this.createBottomToolbar();break;case"refresh-main-toolbar":this.refreshMainToolbar();break;case"create-qa-toolbar":this.createQuickAccessToolbar();break;case"destroy-qa-toolbar":this.destroyQuickAccessToolbar();break;case"zoom-up-handler":this.zoomBtnMouseUpHandler();break;case"refresh-dropdown-btn":this.refreshDropDownBtn(e.value.isDisabled);break;case"close-contextual-toolbar":this.closeContextualToolbar();break;case"destroy-bottom-toolbar":this.destroyBottomToolbar();break;case"destroy-top-toolbar":this.destroyTopToolbar();break;case"destroySubComponents":this.destroySubComponents();break;case"setLocale":this.l10n.setLocale(e.value.locale);break;case"setPreventZoomBtn":this.preventZoomBtn=e.value.isPrevent;break;case"getToolbarHeight":e.value.obj.toolbarHeight=this.toolbarHeight;break;case"setToolbarHeight":(C(i.toolbar)||i.toolbar&&i.toolbar.length>0&&i.toolbar.indexOf("Open")>-1)&&(this.toolbarHeight=e.value.height);break;case"setCurrentToolbar":this.currentToolbar=e.value.type;break;case"setSelectedFreehandColor":this.selFhdColor=e.value.color;break;case"setInitialAdjustmentValue":i.initialAdjustmentValue=e.value.value;break;case"getCanvasFilter":e.value.obj.canvasFilter=i.canvasFilter;break;case"getDefToolbarItems":e.value.obj.defToolbarItems=this.defToolbarItems;break;case"getPenStroke":this.getPenStroke(e.value.value);break;case"performDefToolbarClickAction":this.performDefTbrClick(e.value.type,e.value.isContextualToolbar,e.value.isDisabledAdjustment,e.value.isDisabledFilter,e.value.isFilterFinetune);break;case"setTempFilterProperties":i.setTempFilterProperties();break;case"refreshSlider":this.refreshSlider();break;case"getCurrAdjustmentValue":i.getCurrAdjustmentValue(e.value.type);break;case"setCurrAdjustmentValue":i.setCurrAdjustmentValue(e.value.type,e.value.value);break;case"refreshShapeDrawing":this.refreshShapeDrawing();break;case"setEnableDisableUndoRedo":this.preventEnableDisableUr=e.value.isPrevent;break;case"reset":this.reset();break;case"getLocaleText":e.value.obj.value=this.l10n.getConstant(e.value.obj.key);break;case"initResizeToolbar":this.initResizeToolbar();break;case"getFrameToolbar":e.value.obj.bool=this.isFrameToolbar;break;case"resizeClick":this.resizeClick();break;case"frameToolbarClick":this.frameToolbarClick();break;case"performCropTransformClick":this.performCropTransformClick(e.value.shape,e.value.isTransform);break;case"duplicateShape":this.duplicateShape(e.value.isPreventUndoRedo,!0);break;case"editText":this.editText();break;case"setInitialSize":this.initialSize=Number(e.value.value);break;case"widthPress":this.widthPress(e.value.e);break;case"heightPress":this.heightPress(e.value.e);break;case"widthAspectRatio":this.widthAspectRatio(e.value.e);break;case"heightAspectRatio":this.heightAspectRatio(e.value.e);break;case"cancelPan":this.cancelPan();break;case"zoomInBtnMouseDownHandler":this.zoomInBtnMouseDownHandler(e.value.event);break;case"zoomOutBtnMouseDownHandler":this.zoomOutBtnMouseDownHandler(e.value.event);break;case"drawDashedLine":this.drawDashedLine(e.value.context);break;case"saveDialogClosed":this.saveDialogClosed(e.value.id);break;case"getIndex":this.getIndex(e.value.item);break;case"getRectRadius":this.getRectRadius(e.value.text);break;case"applyPreviewFilter":this.applyPreviewFilter();break;case"renderSlider":this.renderSlider(e.value.type,e.value.isSelect);break;case"zoomInBtnClickHandler":this.zoomInBtnClickHandler(e.value.e);break;case"zoomOutBtnClickHandler":this.zoomOutBtnClickHandler(e.value.e);break;case"getAdjustmentToolbarItem":this.getAdjustmentToolbarItem();break;case"getFilterToolbarItem":this.getFilterToolbarItem();break;case"renderCropBtn":this.renderCropBtn();break}},d.prototype.updatePrivateVariables=function(){var e=this.parent;this.inMemoryCanvas=e.inMemoryCanvas,e.lowerCanvas&&(this.lowerContext=e.lowerCanvas.getContext("2d")),e.upperCanvas&&(this.upperContext=e.upperCanvas.getContext("2d")),this.inMemoryCanvas&&(this.inMemoryContext=this.inMemoryCanvas.getContext("2d"))},d.prototype.reset=function(){var e=this.parent;this.toolbarHeight=46,e.prevCurrSelectionPoint=null,this.zoomBtnHold=null,this.currToolbar="",e.cxtTbarHeight=null,this.currentToolbar="main",this.selFhdColor="#42a5f5",e.currentFilter="",this.preventZoomBtn=e.isCropToolbar=this.preventEnableDisableUr=this.isFrameToolbar=!1,e.initialAdjustmentValue=e.canvasFilter="brightness(1) contrast(100%) hue-rotate(0deg) saturate(100%) opacity(1) blur(0px) sepia(0%) grayscale(0%) invert(0%)",e.tempStraighten=0,e.isStraightening=!1},d.prototype.destroyTopToolbar=function(){var e=this.parent,i=document.getElementById(e.element.id+"_toolbar");this.isToolbar()&&i&&i.classList.contains("e-control")&&F(i,"toolbar").destroy()},d.prototype.destroyBottomToolbar=function(){var e=this.parent,i=document.getElementById(e.element.id+"_bottomToolbar");i&&i.classList.contains("e-control")&&F(i,"toolbar").destroy()},d.prototype.isToolbar=function(){var e=this.parent;return C(e.toolbar)||e.toolbar&&e.toolbar.length>0||!C(e.toolbarTemplate)},d.prototype.createToolbar=function(){var e=this,i=this.parent,t=i.element.id;if(C(i.toolbar)||i.toolbar&&i.toolbar.length>0){i.element.appendChild(i.createElement("div",{id:t+"_toolbarArea",className:"e-toolbar-area"}));var r={cssClass:"e-image-upload",align:"Left",type:"Input",tooltipText:this.l10n.getConstant("Browse"),template:new Pe({allowedExtensions:i.uploadSettings.allowedExtensions,multiple:!1})};C(this.defToolbarItems)&&(this.defToolbarItems=[]),this.defToolbarItems.push(r);var o=document.getElementById(t+"_toolbarArea"),a=i.createElement("div",{id:t+"_toolbar"});o.appendChild(a);var n=[{cssClass:"e-image-upload",align:"Left",type:"Input",tooltipText:this.l10n.getConstant("Browse"),template:new Pe({allowedExtensions:i.uploadSettings.allowedExtensions,multiple:!1,selected:function(){var h=document.getElementById(t+"_toolbar"),u=document.getElementById(t+"_bottomToolbar");i.disabled||(w.isDevice?(e.defToolbarItems.length>0&&h&&F(h,"toolbar").destroy(),u&&F(u,"toolbar").destroy(),e.initMainToolbar(!1,w.isDevice,null),e.createBottomToolbar()):(e.defToolbarItems.length>0&&h&&F(h,"toolbar").destroy(),e.initMainToolbar(!1,!1,null)))}})}],s=new ie({items:n,width:"100%",created:function(){i.trigger("toolbarCreated",{toolbarType:"main"})},clicked:this.defToolbarClicked.bind(this)});s.appendTo("#"+t+"_toolbar"),this.createLeftToolbarControls();var l=document.getElementById(t+"_toolbar");if(a&&(this.toolbarHeight=l.clientHeight,i.toolbar&&i.toolbar.length>0&&i.toolbar.indexOf("Open")===-1)){var p=F(document.getElementById(i.element.id+"_toolbar"),"toolbar");p&&(p.destroy(),document.getElementById(i.element.id+"_toolbar").innerHTML="")}}else this.toolbarHeight=0},d.prototype.createContextualToolbar=function(){var e=this.parent,i=e.element.id;if(C(e.toolbar)||e.toolbar&&e.toolbar.length>0){var t=e.createElement("div",{id:i+"_contextualToolbarArea",className:"e-contextual-toolbar-wrapper e-hide"});t.style.position="absolute",e.element.appendChild(t);var r=document.getElementById(i+"_contextualToolbarArea"),o=e.createElement("div",{id:i+"_contextualToolbar"});r.appendChild(o)}},d.prototype.createBottomToolbar=function(){var e=this.parent,i=e.element.id;if(e.element.querySelector("#"+i+"_bottomToolbarArea")&&e.element.querySelector("#"+i+"_bottomToolbarArea").remove(),C(e.toolbar)||e.toolbar&&e.toolbar.length>0){if(e.element.appendChild(e.createElement("div",{id:i+"_bottomToolbarArea",className:"e-bottom-toolbar"})),!e.toolbarTemplate){var t=document.getElementById(i+"_bottomToolbarArea"),r=e.createElement("div",{id:i+"_bottomToolbar"});t.appendChild(r)}this.initBottomToolbar()}},d.prototype.createQuickAccessToolbar=function(){var e=this.parent,i=e.element.id;if(e.showQuickAccessToolbar){var t={cssClass:"e-image-upload",align:"Left",type:"Input",tooltipText:this.l10n.getConstant("Browse"),template:new Pe({allowedExtensions:e.uploadSettings.allowedExtensions,multiple:!1})};C(this.defToolbarItems)&&(this.defToolbarItems=[]),this.defToolbarItems.push(t);var r=document.getElementById(i+"_quickAccessToolbarArea"),o=e.createElement("div",{id:i+"_quickAccessToolbar"});r.appendChild(o);var a=new ie({clicked:this.defToolbarClicked.bind(this)});a.appendTo("#"+i+"_quickAccessToolbar")}},d.prototype.initMainToolbar=function(e,i,t,r,o,a,n){var s=this,l=this.parent,p=l.element.id;if(this.isToolbar()){var h=this.getLeftToolbarItem(t,r),u=this.getRightToolbarItem(t,a,n),c=this.getMainToolbarItem(e,o,n),g=this.getZoomToolbarItem();i?o||n?this.defToolbarItems=c:this.defToolbarItems=h.concat(u):this.defToolbarItems=h.concat(c,u,g);var v={toolbarType:"main",toolbarItems:this.defToolbarItems};if(l.trigger("toolbarUpdating",v),this.defToolbarItems=v.toolbarItems,this.defToolbarItems.length>0){var b=new ie({width:"100%",items:this.defToolbarItems,clicked:this.defToolbarClicked.bind(this),created:function(){i||s.renderAnnotationBtn(),s.wireZoomBtnEvents(),l.trigger("toolbarCreated",{toolbarType:"main"})}});if(i&&o||i&&n?b.appendTo("#"+p+"_bottomToolbar"):b.appendTo("#"+p+"_toolbar"),this.createLeftToolbarControls(),this.enableDisableTbrBtn(),this.isToolbar()&&document.getElementById(p+"_toolbar")){var m=F(p+"_toolbar","toolbar");m.refreshOverflow()}}}},d.prototype.initBottomToolbar=function(){var e=this,i=this.parent,t=i.element.id;if(C(i.toolbar)||i.toolbar&&i.toolbar.length>0){var r=this.getMainToolbarItem(),o={toolbarType:"bottom-toolbar",toolbarItems:r};i.trigger("toolbarUpdating",o),r=o.toolbarItems;var a=new ie({items:r,width:"100%",created:function(){e.renderAnnotationBtn(),e.renderCropBtn(),e.renderTransformBtn(),i.trigger("toolbarCreated",{toolbarType:"main"})},clicked:this.defToolbarClicked.bind(this)});if(a.appendTo("#"+t+"_bottomToolbar"),this.defToolbarItems.length>0&&document.getElementById(t+"_bottomToolbar")){var n=F(t+"_bottomToolbar","toolbar");n.refreshOverflow()}}},d.prototype.getLeftToolbarItem=function(e,i){var t=this.parent,r=t.element.id,o=[];(!e||i)&&(C(t.toolbar)||t.toolbar&&t.toolbar.indexOf("Open")>-1?(o.push({id:r+"_upload",cssClass:"e-image-upload",align:"Left",type:"Input",template:new Pe({allowedExtensions:t.uploadSettings.allowedExtensions,multiple:!1})}),o.push({visible:!1,cssClass:"e-image-position e-btn e-flat",tooltipText:this.l10n.getConstant("Browse"),align:"Left"})):w.isDevice&&t.toolbar&&t.toolbar.indexOf("Open")===-1&&(o.push({visible:!1,id:r+"_upload",cssClass:"e-image-upload",align:"Left",type:"Input",template:new Pe({allowedExtensions:t.uploadSettings.allowedExtensions,multiple:!1})}),o.push({visible:!1,cssClass:"e-image-position e-btn e-flat",tooltipText:this.l10n.getConstant("Browse"),align:"Left"}))),t.allowUndoRedo&&!i&&((C(t.toolbar)||t.toolbar&&t.toolbar.indexOf("Undo")>-1)&&o.push({id:r+"_undo",prefixIcon:"e-icons e-undo",cssClass:"top-icon e-undo",tooltipText:this.l10n.getConstant("Undo"),align:"Left"}),(C(t.toolbar)||t.toolbar&&t.toolbar.indexOf("Redo")>-1)&&o.push({id:r+"_redo",prefixIcon:"e-icons e-redo",cssClass:"top-icon e-redo",tooltipText:this.l10n.getConstant("Redo"),align:"Left"})),!this.preventZoomBtn&&(t.zoomSettings.zoomTrigger&U.Toolbar)===U.Toolbar&&!i&&((C(t.toolbar)||t.toolbar&&t.toolbar.indexOf("ZoomOut")>-1)&&o.push({id:r+"_zoomOut",prefixIcon:"e-icons e-zoom-out",cssClass:"top-icon e-dec-zoom",tooltipText:this.l10n.getConstant("ZoomOut"),align:"Left"}),(C(t.toolbar)||t.toolbar&&t.toolbar.indexOf("ZoomIn")>-1)&&o.push({id:r+"_zoomIn",prefixIcon:"e-icons e-zoom-in",cssClass:"top-icon e-inc-zoom",tooltipText:this.l10n.getConstant("ZoomIn"),align:"Left"}));for(var a=this.processToolbar("left"),n=0,s=a.length;n<s;n++)o.push(a[n]);return o},d.prototype.getRightToolbarItem=function(e,i,t){var r=this.parent,o=r.element.id,a=[];(e||t)&&(a.push({id:o+"_ok",prefixIcon:"e-icons e-check",cssClass:"top-icon e-tick",tooltipText:this.l10n.getConstant("OK"),align:"Right",tabIndex:0}),a.push({id:o+"_cancel",prefixIcon:"e-icons e-close",cssClass:"top-icon e-save",tooltipText:this.l10n.getConstant("Cancel"),align:"Right"})),(i||!w.isDevice)&&(C(r.toolbar)||r.toolbar&&r.toolbar.indexOf("Reset")>-1)&&a.push({id:o+"_reset",prefixIcon:"e-icons e-btn-reset",cssClass:"top-icon e-img-reset",tooltipText:this.l10n.getConstant("Reset"),align:"Right"}),e||(C(r.toolbar)||r.toolbar&&r.toolbar.indexOf("Save")>-1)&&a.push({id:o+"_save",prefixIcon:"e-icons e-btn-save",cssClass:"e-caret-hide top-icon e-save",tooltipText:this.l10n.getConstant("Save"),align:"Right"});for(var n=this.processToolbar("right"),s=0,l=n.length;s<l;s++)a.push(n[s]);return a},d.prototype.getMainToolbarItem=function(e,i,t){var r=this.parent,o=r.element.id,a=[];i?((C(r.toolbar)||!C(r.toolbar)&&r.toolbar.indexOf("None")>-1||r.toolbar.indexOf("Frame")>-1)&&a.push({id:o+"_none",prefixIcon:"e-icons e-frame-none",cssClass:"top-icon e-frame-none",tooltipText:this.l10n.getConstant("None"),align:"Center"}),(C(r.toolbar)||!C(r.toolbar)&&r.toolbar.indexOf("Mat")>-1||r.toolbar.indexOf("Frame")>-1)&&a.push({id:o+"_mat",prefixIcon:"e-icons e-frame-mat",cssClass:"top-icon e-frame-mat",tooltipText:this.l10n.getConstant("Mat"),align:"Center"}),(C(r.toolbar)||!C(r.toolbar)&&r.toolbar.indexOf("Bevel")>-1||r.toolbar.indexOf("Frame")>-1)&&a.push({id:o+"_bevel",prefixIcon:"e-icons e-frame-bevel",cssClass:"top-icon e-frame-bevel",tooltipText:this.l10n.getConstant("Bevel"),align:"Center"}),(C(r.toolbar)||!C(r.toolbar)&&r.toolbar.indexOf("Line")>-1||r.toolbar.indexOf("Frame")>-1)&&a.push({id:o+"_line",prefixIcon:"e-icons e-frame-line",cssClass:"top-icon e-frame-line",tooltipText:this.l10n.getConstant("Line"),align:"Center"}),(C(r.toolbar)||!C(r.toolbar)&&r.toolbar.indexOf("Inset")>-1||r.toolbar.indexOf("Frame")>-1)&&a.push({id:o+"_inset",prefixIcon:"e-icons e-frame-inset",cssClass:"top-icon e-frame-inset",tooltipText:this.l10n.getConstant("Inset"),align:"Center"}),(C(r.toolbar)||!C(r.toolbar)&&r.toolbar.indexOf("Hook")>-1||r.toolbar.indexOf("Frame")>-1)&&a.push({id:o+"_hook",prefixIcon:"e-icons e-frame-hook",cssClass:"top-icon e-frame-hook",tooltipText:this.l10n.getConstant("Hook"),align:"Center"})):t?(a.push({id:o+"_redactBlur",prefixIcon:"e-icons e-tint",cssClass:"top-icon e-opacity",tooltipText:this.l10n.getConstant("Blur"),align:"Center"}),a.push({id:o+"_pixelate",prefixIcon:"e-icons e-opacity",cssClass:"top-icon e-opacity",tooltipText:this.l10n.getConstant("Pixelate"),align:"Center"}),a.push({id:o+"_duplicate",prefixIcon:"e-icons e-order",cssClass:"top-icon e-order",tooltipText:this.l10n.getConstant("Duplicate"),align:"Center"}),a.push({id:o+"_remove",prefixIcon:"e-icons e-trash",cssClass:"top-icon e-trash",tooltipText:this.l10n.getConstant("Remove"),align:"Center"})):((C(r.toolbar)||r.toolbar&&r.toolbar.indexOf("Crop")>-1)&&a.push({id:o+"_cropTransform",prefixIcon:"e-icons e-crop",cssClass:"top-icon e-crop",tooltipText:this.l10n.getConstant("CropAndTransform"),align:"Center"}),(C(r.toolbar)||r.toolbar&&r.toolbar.indexOf("Annotate")>-1)&&a.push({id:o+"_annotation",tooltipText:this.l10n.getConstant("Annotation"),align:"Center",template:'<button id="'+o+'_annotationBtn"></button>'}),(C(r.toolbar)||r.toolbar&&r.toolbar.indexOf("Finetune")>-1)&&a.push({id:o+"_adjustment",prefixIcon:"e-icons e-adjustment",cssClass:"top-icon e-adjustment",tooltipText:this.l10n.getConstant("Finetune"),align:"Center"}),(C(r.toolbar)||r.toolbar&&r.toolbar.indexOf("Filter")>-1)&&a.push({id:o+"_filter",prefixIcon:"e-icons e-filters",cssClass:"top-icon e-filters",tooltipText:this.l10n.getConstant("Filter"),align:"Center"}),(C(r.toolbar)||!C(r.toolbar)&&r.toolbar.indexOf("Frame")>-1)&&a.push({id:o+"_frame",prefixIcon:"e-icons e-border-frame",cssClass:"top-icon e-border-frame",tooltipText:this.l10n.getConstant("Frame"),align:"Center"}),(C(r.toolbar)||!C(r.toolbar)&&r.toolbar.indexOf("Resize")>-1)&&a.push({id:o+"_resize",prefixIcon:"e-icons e-resize",cssClass:"top-icon e-resize",tooltipText:this.l10n.getConstant("Resize"),align:"Center"}),(C(r.toolbar)||!C(r.toolbar)&&r.toolbar.indexOf("Redact")>-1)&&a.push({id:o+"_redact",prefixIcon:"e-icons e-redact",cssClass:"top-icon e-opacity",tooltipText:this.l10n.getConstant("Redact"),align:"Center"}));for(var n=this.processToolbar("center"),s=0,l=n.length;s<l;s++)a.push(n[s]);return e&&(a.push({id:o+"_ok",prefixIcon:"e-icons e-check",cssClass:"top-icon e-tick",tooltipText:this.l10n.getConstant("OK"),align:"Right",tabIndex:0}),a.push({id:o+"_cancel",prefixIcon:"e-icons e-close",cssClass:"top-icon e-save",tooltipText:this.l10n.getConstant("Cancel"),align:"Right"})),a},d.prototype.getZoomToolbarItem=function(){var e=[];return e},d.prototype.updateContextualToolbar=function(e,i,t){var r=this.parent,o=r.element.id,a=r.element.querySelector("#"+o+"_toolbarArea"),n=r.element.querySelector("#"+o+"_contextualToolbarArea");if(n){if(n.classList.remove("e-hide"),n.style.left=a.offsetLeft+"px",e==="filter"){var s=document.getElementById(o+"_toolbar");s&&this.defToolbarItems.length>0&&F(s,"toolbar").destroy(),w.isDevice?this.initMainToolbar(!1,!0,!0):this.initMainToolbar(!0,null,null),this.refreshSlider(),this.initFilterToolbarItem()}else{var l=document.querySelector("#"+o+"_contextualToolbar");l.classList.contains("e-control")&&F(l,"toolbar").destroy(),this.refreshSlider(),e==="frame"?this.initFrameToolbarItem():this.renderSlider(i,t)}if(r.toolbarTemplate?this.toolbarHeight=r.element.querySelector("#"+o+"_toolbarArea").clientHeight:r.element.querySelector("#"+o+"_toolbar")&&(this.toolbarHeight=r.element.querySelector("#"+o+"_toolbar").clientHeight),r.toolbarHeight=this.toolbarHeight,w.isDevice){var p=n.offsetHeight+1,h=r.element.querySelector("#"+o+"_customizeWrapper");this.isFrameToolbar&&h&&(p=h.offsetHeight+2);var u=r.element.querySelector("#"+o+"_canvasWrapper").offsetHeight;if(n.style.top=this.toolbarHeight+1+u-p+"px",i==="straighten"){r.isStraightening=!0;var l=r.element.querySelector("#"+o+"_contextualToolbarArea");l.style.position==="absolute"&&(l.style.position="",r.element.insertBefore(l,r.element.querySelector("#"+o+"_bottomToolbarArea")),r.update(),t&&r.notify("draw",{prop:"select",onPropertyChange:!1,value:{type:this.getCropTextContent(document.getElementById(o+"_cropBtn")).toLowerCase(),startX:null,startY:null,width:null,height:null}}))}}else n.style.top=this.toolbarHeight+1+"px"}},d.prototype.processToolbar=function(e){var i=this.parent,t=[];if(i.toolbar)for(var r=0,o=i.toolbar.length;r<o;r++)typeof i.toolbar[r]=="object"&&(C(i.toolbar[r].align)?e==="left"&&t.push(i.toolbar[r]):i.toolbar[r].align.toLowerCase()===e&&t.push(i.toolbar[r]));return t},d.prototype.processSubToolbar=function(e){var i=[];if(e)for(var t=0,r=e.length;t<r;t++)typeof e[t]=="object"&&(e[t].align="Center",i.push(e[t]));return i},d.prototype.wireZoomBtnEvents=function(){var e=document.querySelector("#"+this.parent.element.id+"_zoomIn"),i=document.querySelector("#"+this.parent.element.id+"_zoomOut");e&&(e.addEventListener("mousedown",this.zoomInBtnMouseDownHandler.bind(this)),e.addEventListener("mouseup",this.zoomBtnMouseUpHandler.bind(this)),e.addEventListener("click",this.zoomInBtnClickHandler.bind(this))),i&&(i.addEventListener("mousedown",this.zoomOutBtnMouseDownHandler.bind(this)),i.addEventListener("mouseup",this.zoomBtnMouseUpHandler.bind(this)),i.addEventListener("click",this.zoomOutBtnClickHandler.bind(this)))},d.prototype.widthPress=function(e){if(e.keyCode===109){e.preventDefault();return}},d.prototype.heightPress=function(e){if(e.keyCode===109){e.preventDefault();return}},d.prototype.widthAspectRatio=function(e){if(!(e.keyCode===109||e.keyCode===9)){var i=this.parent,t=i.element.id,r=i.element.querySelector("#"+t+"_resizeHeight"),o=i.element.querySelector("#"+t+"_resizeWidth"),a=i.element.querySelector("#"+t+"_aspectratio"),n=i.img.destWidth,s=i.img.destHeight,l=parseFloat(r.value),p=l/(s/n),h=p%1>=.5||p%1<=-.5?Math.round(p):p<0?Math.ceil(p):Math.floor(p),u=F(o,"numerictextbox"),c=F(o,"numerictextbox");a&&(h!=null&&!isNaN(h)?C(u.value)?(u.placeholder=h+" px",o.placeholder=h.toString()+" px"):(u.value=h,o.value=h.toString()+" px"):C(u.value)?(u.placeholder="0 px",o.placeholder="0 px",C(c.value)&&!C(c.placeholder)&&(u.placeholder=""+i.img.srcWidth,o.placeholder=""+i.img.srcWidth)):(u.value=0,o.value="0 px"))}},d.prototype.heightAspectRatio=function(e){if(!(e.keyCode===109||e.keyCode===9)){var i=this.parent,t=i.element.id,r=i.element.querySelector("#"+t+"_resizeHeight"),o=i.element.querySelector("#"+t+"_resizeWidth"),a=i.element.querySelector("#"+t+"_aspectratio"),n=i.img.destWidth,s=i.img.destHeight,l=parseFloat(o.value),p=l/(n/s),h=p%1>=.5||p%1<=-.5?Math.round(p):p<0?Math.ceil(p):Math.floor(p),u=F(r,"numerictextbox"),c=F(o,"numerictextbox");a&&(isNaN(h)?C(u.value)?(u.placeholder="0 px",r.placeholder="0 px",C(c.value)&&!C(c.placeholder)&&(u.placeholder=""+i.img.srcHeight,r.placeholder=""+i.img.srcHeight)):(u.value=0,r.value="0 px"):C(u.value)?(u.placeholder=h+" px",r.placeholder=h.toString()+" px"):(u.value=h,r.value=h.toString()+" px"))}},d.prototype.getResizeToolbarItem=function(){var e=this.parent,i=e.element.id,t=!!(e.aspectWidth&&e.aspectHeight),r=this.parent.transform.degree%90===0&&this.parent.transform.degree%180!==0?Math.ceil(this.parent.img.srcHeight).toString():Math.ceil(this.parent.img.srcWidth).toString(),o=this.parent.transform.degree%90===0&&this.parent.transform.degree%180!==0?Math.ceil(this.parent.img.srcWidth).toString():Math.ceil(this.parent.img.srcHeight).toString(),a=[],n=document.createElement("span");n.innerHTML=this.l10n.getConstant("W"),a.push({id:i+"_width",cssClass:"e-ie-resize-width",template:n,align:"Center"}),a.push({id:i+"_resizeWidth",prefixIcon:"e-icons e-anti-clock-wise",tooltipText:this.l10n.getConstant("Width"),align:"Center",type:"Input",template:new rt({width:75,htmlAttributes:{maxLength:"4"},showSpinButton:!1,value:t?e.aspectWidth:null,placeholder:t?null:r,format:"###.## px"})});var s=document.createElement("span");return s.innerHTML=this.l10n.getConstant("H"),a.push({id:i+"_height",cssClass:"e-ie-resize-height",template:s,align:"Center"}),a.push({id:i+"_resizeHeight",prefixIcon:"e-icons e-clock-wise",tooltipText:this.l10n.getConstant("Height"),align:"Center",type:"Input",template:new rt({width:75,htmlAttributes:{maxLength:"4"},showSpinButton:!1,value:t?e.aspectHeight:null,placeholder:t?null:o,format:"###.## px"})}),this.isAspectRatio?(a.push({id:i+"_nonaspectratio",prefixIcon:"e-icons e-unlock",align:"Center",tooltipText:this.l10n.getConstant("AspectRatio"),type:"Button"}),this.isAspectRatio=!1):(a.push({id:i+"_aspectratio",prefixIcon:"e-icons e-lock",align:"Center",tooltipText:this.l10n.getConstant("AspectRatio"),type:"Button",tabIndex:0}),this.isAspectRatio=!0),w.isDevice||(a.push({id:i+"_ok",prefixIcon:"e-icons e-check",cssClass:"top-icon e-tick",tooltipText:this.l10n.getConstant("OK"),align:"Right",tabIndex:0}),a.push({id:i+"_cancel",prefixIcon:"e-icons e-close",cssClass:"top-icon e-save",tooltipText:this.l10n.getConstant("Cancel"),align:"Right"})),a},d.prototype.initResizeToolbar=function(){var e=this,i=this.parent,t=i.element.id,r=this.getLeftToolbarItem(!1,!0),o=this.getRightToolbarItem(),a=this.getResizeToolbarItem(),n=this.getZoomToolbarItem();w.isDevice?this.defToolbarItems=a:this.defToolbarItems=r.concat(n,a,o);var s={toolbarType:"resize",toolbarItems:this.defToolbarItems};i.trigger("toolbarUpdating",s),this.defToolbarItems=s.toolbarItems;var l=new ie({width:"100%",items:this.defToolbarItems,clicked:this.defToolbarClicked.bind(this),created:function(){e.wireResizeBtnEvents(),i.trigger("toolbarCreated",{toolbarType:"shapes"}),w.isDevice?e.defToolbarItems.length>0&&!C(document.getElementById(t+"_bottomToolbar"))&&l.refreshOverflow():(e.createLeftToolbarControls(),e.defToolbarItems.length>0&&!C(document.getElementById(t+"_toolbar"))&&l.refreshOverflow())}});w.isDevice?l.appendTo("#"+t+"_bottomToolbar"):l.appendTo("#"+t+"_toolbar"),i.isResize=!1,this.enableDisableTbrBtn(),i.isResize=!0,i.notify("transform",{prop:"disableZoomOutBtn",value:{isZoomOut:!0}})},d.prototype.wireResizeBtnEvents=function(){var e=this.parent,i=e.element.id,t=e.element.querySelector("#"+i+"_resizeHeight"),r=e.element.querySelector("#"+i+"_resizeWidth");C(t)||(t.addEventListener("keydown",this.widthPress.bind(this)),r.addEventListener("keyup",this.heightAspectRatio.bind(this))),C(r)||(r.addEventListener("keydown",this.heightPress.bind(this)),t.addEventListener("keyup",this.widthAspectRatio.bind(this)))},d.prototype.enableDisableTbrBtn=function(){var e=this.parent,i=e.element.id;if(!this.preventEnableDisableUr){var t={appliedUndoRedoColl:[]};e.notify("undo-redo",{prop:"getAppliedUndoRedoColl",value:{obj:t}});var r={undoRedoStep:null};e.notify("undo-redo",{prop:"getUndoRedoStep",value:{obj:r}});var o=e.element.querySelector("#"+i+"_undo");o&&r.undoRedoStep===0?(o.classList.add("e-disabled"),o.parentElement.classList.add("e-overlay")):o&&r.undoRedoStep>0&&(o.classList.remove("e-disabled"),o.parentElement.classList.remove("e-overlay"));var a=e.element.querySelector("#"+i+"_redo");a&&r.undoRedoStep===t.appliedUndoRedoColl.length?(a.classList.add("e-disabled"),a.parentElement.classList.add("e-overlay")):(a&&r.undoRedoStep===0&&t.appliedUndoRedoColl.length>0||a&&r.undoRedoStep>0)&&(a.classList.remove("e-disabled"),a.parentElement.classList.remove("e-overlay"))}var n=document.querySelector("#"+i+"_zoomIn");n&&e.zoomSettings.zoomFactor>=e.zoomSettings.maxZoomFactor?(n.classList.add("e-disabled"),n.parentElement.classList.add("e-overlay")):n&&(n.classList.remove("e-disabled"),n.parentElement.classList.remove("e-overlay"));var s=document.querySelector("#"+i+"_zoomOut");s&&e.zoomSettings.zoomFactor<=e.zoomSettings.minZoomFactor?(s.classList.add("e-disabled"),s.parentElement.classList.add("e-overlay")):s&&(s.classList.remove("e-disabled"),s.parentElement.classList.remove("e-overlay"));var l=document.querySelector("#"+i+"_frame");l&&(e.currSelectionPoint&&e.currSelectionPoint.shape==="crop-circle"||e.isCircleCrop)?l.classList.add("e-overlay"):l&&l.classList.remove("e-overlay");var p=document.querySelector("#"+i+"_aspectratio");p&&(e.currSelectionPoint&&e.currSelectionPoint.shape==="crop-circle"||e.isCircleCrop)?p.classList.add("e-overlay"):p&&p.classList.remove("e-overlay")},d.prototype.createLeftToolbarControls=function(){var e=this.parent,i=e.element.id;if(this.defToolbarItems!==void 0&&this.defToolbarItems.length>0&&document.getElementById(i+"_toolbar")){var t=document.getElementById(i+"_toolbar").querySelector(".e-image-upload");if(t){var r=t.getElementsByTagName("input")[0],o=t.getElementsByTagName("button")[0];o.className="e-tbar-btn e-tbtn-txt top-icon",o.innerHTML="",o.title=this.l10n.getConstant("Browse"),o.appendChild(e.createElement("span",{className:"e-btn-icon e-icons e-upload-icon e-icon-left"})),r.onchange=this.fileSelect.bind(this,r)}}},d.prototype.fileSelect=function(e,i){var t=this.parent,r=e.files[0].type.split("/")[1],o=this.parent.getExtensionArray(),a=(r==="jpg"||r==="jpeg")&&(t.uploadSettings.allowedExtensions.indexOf("jpg")>-1||t.uploadSettings.allowedExtensions.indexOf("jpeg")>-1);this.fileName=e.files[0].name.split(".")[0];var n=e.files[0].size;this.parent.notify("toolbar",{prop:"setInitialSize",value:{value:e.files[0].size}}),(o.indexOf(r)>-1||a||r.indexOf("svg")>-1&&o.indexOf("svg")>-1)&&(!this.parent.uploadSettings.minFileSize||n>this.parent.uploadSettings.minFileSize)&&(!this.parent.uploadSettings.maxFileSize||n<this.parent.uploadSettings.maxFileSize)?this.parent.notify("draw",{prop:"fileSelect",value:{inputElement:e,args:i}}):(this.parent.isImageLoaded||(this.destroyTopToolbar(),this.createToolbar(),w.isDevice&&this.destroyBottomToolbar()),this.parent.showDialogPopup("unsupported",!(o.indexOf(r)>-1||a||r.indexOf("svg")>-1&&o.indexOf("svg")>-1)))},d.prototype.triggerTbarClickEvent=function(e){var i={item:e.item,originalEvent:e.event};this.parent.trigger("toolbarItemClicked",i)},d.prototype.renderAnnotationBtn=function(e){var i=this,t=this.parent,r=!1,o=[],a=t.element.id,n=["Ellipse","Arrow","Line","Rectangle","Pen","Path","Text","Image"];if(t.toolbar){for(var s=0;s<n.length;s++)if(t.toolbar.indexOf(n[s])!==-1){r=!0;break}}(C(t.toolbar)||!r||t.toolbar&&t.toolbar.indexOf("Pen")>-1)&&o.push({text:this.l10n.getConstant("Pen"),id:"pen",iconCss:"e-icons e-free-pen"}),(C(t.toolbar)||!r||t.toolbar&&t.toolbar.indexOf("Line")>-1)&&o.push({text:this.l10n.getConstant("Line"),id:"line",iconCss:"e-icons e-line"}),(C(t.toolbar)||!r||t.toolbar&&t.toolbar.indexOf("Rectangle")>-1)&&o.push({text:this.l10n.getConstant("Rectangle"),id:"rectangle",iconCss:"e-icons e-rectangle"}),(C(t.toolbar)||!r||t.toolbar&&t.toolbar.indexOf("Ellipse")>-1)&&o.push({text:this.l10n.getConstant("Ellipse"),id:"ellipse",iconCss:"e-icons e-circle"}),(C(t.toolbar)||!r||t.toolbar&&t.toolbar.indexOf("Arrow")>-1)&&o.push({text:this.l10n.getConstant("Arrow"),id:"arrow",iconCss:"e-icons e-arrow-right-up"}),(C(t.toolbar)||!r||t.toolbar&&t.toolbar.indexOf("Path")>-1)&&o.push({text:this.l10n.getConstant("Path"),id:"path",iconCss:"e-icons e-critical-path"}),(C(t.toolbar)||!r||t.toolbar&&t.toolbar.indexOf("Text")>-1)&&o.push({text:this.l10n.getConstant("Text"),id:"text",iconCss:"e-icons e-add-text"}),(C(t.toolbar)||!r||t.toolbar&&t.toolbar.indexOf("Image")>-1)&&o.push({text:this.l10n.getConstant("Image"),id:"image",iconCss:"e-icons e-image"});var l={freehandDrawSelectedId:null};t.notify("freehand-draw",{prop:"getFreehandDrawSelectedId",onPropertyChange:!1,value:{obj:l}});var p=w.isDevice?"#"+a+"_bottomToolbar #"+a:"#"+a;this.enableDisableCloneBtn(p,l);var h=e?this.getCurrentShapeIcon(t.activeObj.shape):"e-annotation",u=new q({items:o,iconCss:"e-icons "+h,cssClass:"e-image-popup",open:function(c){(t.currObjType.isFiltered||t.currObjType.isRedact)&&(t.okBtn(),t.element.querySelector("#"+a+"_annotationBtn").click()),w.isDevice&&(c.element.parentElement.style.top=u.element.getBoundingClientRect().top-c.element.parentElement.offsetHeight+"px"),t.activeObj.shape?document.getElementById(t.activeObj.shape).classList.add("e-selected"):t.togglePen&&document.getElementById("pen").classList.add("e-selected")},select:function(c){t.noPushUndo=!1,i.triggerTbarClickEvent(c),t.okBtn();var g=!1,v;t.activeObj.shape!==void 0&&(v=t.activeObj.shape.split("-")),(v===void 0&&t.currObjType.isCustomCrop||v!==void 0&&v[0]==="crop")&&(g=!0),t.currObjType.isCustomCrop=!1,(g||t.togglePan)&&(t.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),i.upperContext.clearRect(0,0,t.upperCanvas.width,t.upperCanvas.height),i.refreshToolbar("main"));var b={currentFreehandDrawIndex:null};t.notify("freehand-draw",{prop:"getCurrentFreehandDrawIndex",value:{obj:b}});var m={shapeSettingsObj:{}},y,P,S=["ellipse","rectangle","text","image"],O;u.iconCss="e-icons "+i.getCurrentShapeIcon(c.item.id),t.notify("draw",{prop:"updateTempObjColl"}),t.notify("draw",{prop:"updateTempPointColl"});var j={penStrokeWidth:2};switch(c.item.id){case"pen":t.notify("freehand-draw",{prop:"getPenStrokeWidth",onPropertyChange:!1,value:{obj:j}}),t.notify("draw",{prop:"setTempStrokeWidth",value:{strokeWidth:j.penStrokeWidth}}),t.drawingShape=null,t.notify("draw",{prop:"setTempFreehandCounter",value:{tempFreehandCounter:t.freehandCounter}}),t.notify("draw",{prop:"setTempCurrentFreehandDrawIndex",value:{tempCurrentFreehandDrawIndex:b.currentFreehandDrawIndex}}),i.currentToolbar="pen",t.freeHandDraw(!0),t.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:m}}),y=m.shapeSettingsObj,t.notify("freehand-draw",{prop:"getPenStrokeWidth",onPropertyChange:!1,value:{obj:j}}),y.strokeWidth=j.penStrokeWidth,y.type=se.FreehandDraw,P={cancel:!1,action:"insert",previousShapeSettings:y,currentShapeSettings:y},t.notify("freehand-draw",{prop:"triggerShapeChanging",value:{shapeChangingArgs:P}});break;case"text":i.currentToolbar="text",t.drawingShape=c.item.id,i.currentToolbar="text",i.setInitialShapeSettings(c),t.notify("selection",{prop:"annotate",value:{shape:c.item.id}}),t.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"text",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}});break;case"image":t.drawingShape=null,i.currentToolbar="shapes",t.element.querySelector("#"+a+"_fileUpload").click();break;case"ellipse":case"arrow":case"line":case"rectangle":case"path":t.drawingShape=c.item.id,i.currentToolbar="shapes",i.setInitialShapeSettings(c),t.notify("selection",{prop:"annotate",value:{shape:c.item.id}}),t.notify("toolbar",{prop:"refresh-toolbar",onPropertyChange:!1,value:{type:"shapes",isApplyBtn:null,isCropping:null,isZooming:null,cType:null}}),t.notify("selection",{prop:"updatePrevShapeSettings",onPropertyChange:!1,value:{obj:m}}),y=m.shapeSettingsObj,O=S.indexOf(i.parent.activeObj.shape)===-1,P={cancel:!1,action:"insert",previousShapeSettings:y,currentShapeSettings:y,allowShapeOverflow:O},t.trigger("shapeChanging",P),t.editCompleteArgs=P,t.notify("shape",{prop:"updateShapeChangeEventArgs",value:{shapeSettings:P.currentShapeSettings}});break}i.updateToolbarItems();var x=t.togglePen;c.item.id==="pen"&&(t.togglePen=!1),t.notify("draw",{prop:"redrawDownScale"}),t.togglePen=x}});u.appendTo("#"+a+"_annotationBtn")},d.prototype.enableDisableCloneBtn=function(e,i){var t=this.parent,r=!1,o=Math.floor(t.activeObj.activePoint.width);t.activeObj.shape&&t.activeObj.shape==="text"&&t.activeObj.textSettings.fontSize===11&&(o===55||t.activeObj.textSettings.bold&&o===58)&&Math.floor(t.activeObj.activePoint.height)===11&&(r=!0);var a=document.querySelector(e+"_duplicate"),n=document.querySelector(e+"_remove"),s=document.querySelector(e+"_editText"),l=document.querySelector(e+"_zOrderBtn");r||t.activeObj.activePoint.width===0&&t.activeObj.activePoint.height===0&&(C(t.activeObj.pointColl)||t.activeObj.pointColl&&t.activeObj.pointColl.length===0)&&C(i.freehandDrawSelectedId)?(a&&a.classList.add("e-overlay"),n&&n.classList.add("e-overlay"),s&&s.classList.add("e-overlay"),l&&l.classList.add("e-overlay")):(a&&a.classList.remove("e-overlay"),n&&n.classList.remove("e-overlay"),s&&s.classList.remove("e-overlay"),l&&l.classList.remove("e-overlay")),l&&(t.shapeColl.length===0||i.freehandDrawSelectedId&&t.shapeColl.length===1)&&l.classList.add("e-overlay")},d.prototype.renderStraightenSlider=function(){var e=this.parent,i=e.element.id;if((C(e.toolbar)||e.toolbar&&e.toolbar.indexOf("Straightening")>-1)&&e.element.querySelector("#"+i+"_straightenSlider")){var t=this.createSlider(-45,45,e.cropObj.straighten,"straighten");t.appendTo("#"+i+"_straightenSlider");var r=t.element.querySelector(".e-handle");r&&!w.isDevice&&(r.addEventListener("mousedown",function(o){o.preventDefault(),o.stopPropagation()}),r.addEventListener("touchstart",function(o){o.preventDefault(),o.stopPropagation()}))}},d.prototype.renderCropBtn=function(e){var i=this,t=this.parent,r=[],o=!1,a=["CustomSelection","CircleSelection","SquareSelection","RatioSelection"];if(t.toolbar){for(var n=0;n<a.length;n++)if(t.toolbar.indexOf(a[n])!==-1){o=!0;break}}(C(t.toolbar)||!o||t.toolbar&&t.toolbar.indexOf("CustomSelection")>-1)&&r.push({text:this.l10n.getConstant("Custom"),id:"custom",iconCss:"e-icons e-custom"}),(C(t.toolbar)||!o||t.toolbar&&t.toolbar.indexOf("CircleSelection")>-1)&&r.push({text:this.l10n.getConstant("Circle"),id:"circle",iconCss:"e-icons e-circle"}),(C(t.toolbar)||!o||t.toolbar&&t.toolbar.indexOf("SquareSelection")>-1)&&r.push({text:this.l10n.getConstant("Square"),id:"square",iconCss:"e-icons e-square"}),(C(t.toolbar)||!o||t.toolbar&&t.toolbar.indexOf("RatioSelection")>-1)&&(r.push({text:"2:3",id:"2:3",iconCss:"e-icons e-custom-f"}),r.push({text:"3:2",id:"3:2",iconCss:"e-icons e-custom-a"}),r.push({text:"3:4",id:"3:4",iconCss:"e-icons e-custom-g"}),r.push({text:"4:3",id:"4:3",iconCss:"e-icons e-custom-b"}),r.push({text:"4:5",id:"4:5",iconCss:"e-icons e-custom-h"}),r.push({text:"5:4",id:"5:4",iconCss:"e-icons e-custom-c"}),r.push({text:"5:7",id:"5:7",iconCss:"e-icons e-custom-i"}),r.push({text:"7:5",id:"7:5",iconCss:"e-icons e-custom-d"}),r.push({text:"9:16",id:"9:16",iconCss:"e-icons e-custom-j"}),r.push({text:"16:9",id:"16:9",iconCss:"e-icons e-custom-e"}));var s,l;e?(s=this.getCurrentShapeIcon(e),l=e):t.activeObj.shape&&(t.activeObj.activePoint.width!==0||t.activeObj.activePoint.height!==0)||t.activeObj.shape==="path"&&t.activeObj.pointColl.length>0?(s=this.getCurrentShapeIcon(t.activeObj.shape),l=t.activeObj.shape):t.currSelectionPoint?(s=this.getCurrentShapeIcon(t.currSelectionPoint.shape),l=t.currSelectionPoint.shape):(s=r[0].iconCss,l=r[0].id);var p=new q({open:function(h){if(t.togglePan&&i.cancelPan(),w.isDevice&&(h.element.parentElement.style.top=p.element.getBoundingClientRect().top-h.element.parentElement.offsetHeight+"px"),t.activeObj.shape&&t.activeObj.shape.split("-").length>1){var u=document.getElementById(t.activeObj.shape.split("-")[1]);u&&(u.classList.add("e-selected"),u.focus())}t.notify("transform",{prop:"disableZoomOutBtn",value:{isZoomOut:!0}})},items:r,select:function(h){i.triggerTbarClickEvent(h),i.cropSelect(h),p.iconCss="e-icons "+i.getCurrentShapeIcon("crop-"+h.item.id),p.content=w.isDevice?null:t.toPascalCase(h.item.id)},iconCss:"e-icons "+s,cssClass:"e-image-popup e-ie-crop-ddb-popup",content:w.isDevice?null:t.toPascalCase(l.replace("crop-",""))});p.appendTo("#"+t.element.id+"_cropBtn")},d.prototype.renderTransformBtn=function(){var e=this,i=this.parent,t=[];(C(i.toolbar)||i.toolbar&&i.toolbar.indexOf("RotateLeft")>-1)&&t.push({text:this.l10n.getConstant("RotateLeft"),id:"rotateleft",iconCss:"e-icons e-anti-clock-wise"}),(C(i.toolbar)||i.toolbar&&i.toolbar.indexOf("RotateRight")>-1)&&t.push({text:this.l10n.getConstant("RotateRight"),id:"rotateright",iconCss:"e-icons e-clock-wise"}),(C(i.toolbar)||i.toolbar&&i.toolbar.indexOf("FlipHorizontal")>-1)&&t.push({text:this.l10n.getConstant("HorizontalFlip"),id:"horizontalflip",iconCss:"e-icons e-horizontal-flip"}),(C(i.toolbar)||i.toolbar&&i.toolbar.indexOf("FlipVertical")>-1)&&t.push({text:this.l10n.getConstant("VerticalFlip"),id:"verticalflip",iconCss:"e-icons e-vertical-flip"});var r=new q({open:function(o){if(w.isDevice){var a=o.element.parentElement,n=a.offsetHeight;a.style.display="none",a.style.top=r.element.getBoundingClientRect().top-n+"px",a.style.display="block"}},items:t,select:function(o){e.triggerTbarClickEvent(o),i.transformSelect.bind(e)},iconCss:"e-icons e-transform",cssClass:"e-image-popup"});r.appendTo("#"+i.element.id+"_transformBtn")},d.prototype.saveDialogPopup=function(){var e=this,i=this.parent,t=i.element.id,r=["Good","Great","Highest"];i.element.appendChild(i.createElement("div",{id:t+"_saveDialog"}));var o=i.createElement("div",{id:t+"_dialogContent"});o.style.display="flex";var a=o.appendChild(i.createElement("div",{id:t+"_dialogImgContent",className:"e-ie-dlg-img-content"}));a.appendChild(i.createElement("canvas",{id:t+"_imgPic",className:"e-ie-img-dlg-canvas"}));var n=a.appendChild(i.createElement("div",{id:t+"_imageNameContainer",className:"e-ie-img-size"}));n.appendChild(i.createElement("span",{id:t+"_imageNameLabel",className:"e-ie-quality-info"}));var s=o.appendChild(i.createElement("div",{id:t+"_dialogRightContent",className:"e-ie-dlg-right-content"})),l=s.appendChild(i.createElement("div",{id:t+"_namediv",className:"e-ie-img-save-name"}));l.appendChild(i.createElement("span",{id:t+"_labelImgname",className:"e-ie-img-label-name",innerHTML:this.l10n.getConstant("ImageName")})),l.appendChild(i.createElement("input",{id:t+"_imgNametext",className:"e-ie-img-input",attrs:{type:"text"}}));var p=s.appendChild(i.createElement("div",{id:t+"_imgNamediv",className:"e-ie-img-save-dlg"}));p.appendChild(i.createElement("span",{id:t+"_labelname",className:"e-ie-img-label-name",innerHTML:this.l10n.getConstant("Format")})),p.appendChild(i.createElement("button",{id:t+"_saveDropdownbtn",attrs:{tabindex:"1"}}));var h=s.appendChild(i.createElement("div",{id:t+"_imgQualitydiv",className:"e-ie-img-quality-name"})),u=i.createElement("div",{id:t+"_qualityContainer"});u.appendChild(i.createElement("span",{id:t+"_qualityLabel",className:"e-ie-img-quality-label",innerHTML:this.l10n.getConstant("Quality")})),u.appendChild(i.createElement("span",{id:t+"_qualityInfo",className:"e-circle-info e-icons e-ie-quality-span",attrs:{title:this.l10n.getConstant("QualityInfo")}}));var c=u.appendChild(i.createElement("div",{id:t+"_imgsizeSpan",className:"e-ie-img-size-value-span"}));c.appendChild(i.createElement("span",{id:t+"_imgsizeValueSpan",className:""})),h.appendChild(u);var g=i.createElement("div",{id:t+"_qualityOptionContainer",className:"e-ie-quality-option-container"}),v=h.appendChild(i.createElement("div",{id:t+"_qualityButtonGroup",className:"e-btn-group"}));r.forEach(function(m){var y=document.createElement("input");y.type="radio",y.id=t+"_"+m.toLowerCase(),y.name="quality",y.value=m.toLowerCase();var P=document.createElement("label");P.className="e-btn",P.htmlFor=m.toLowerCase(),P.textContent=e.l10n.getConstant(m),v.appendChild(y),v.appendChild(P)}),g.appendChild(v),g.appendChild(i.createElement("div",{id:t+"_qualitySlider",className:"e-ie-img-quality-slider"})),g.appendChild(i.createElement("button",{id:t+"_qualitybuttonIcon",className:"e-ie-img-icon-button",attrs:{type:"button"}})),h.appendChild(g),w.isDevice&&s.appendChild(i.createElement("span",{id:t+"_qualitySize",className:"e-ie-img-quality-size"})),i.element.querySelector("#"+t+"_saveDialog").style.display="block",i.element.appendChild(o);var b=new Je({target:i.element,header:this.l10n.getConstant("SaveAs"),closeOnEscape:!0,content:document.getElementById(t+"_dialogContent"),width:w.isDevice?"345px":"570px",isModal:!0,animationSettings:{effect:"Zoom"},beforeOpen:this.onBeforeopen(),close:this.saveDialogClosed.bind(this,t),cssClass:"e-ie-save-dialog",buttons:[{click:function(){b.hide()},buttonModel:{content:this.l10n.getConstant("Close"),cssClass:"e-save-cancel-btn"}},{click:function(){e.download(),b.hide(),e.isSlider=!1},buttonModel:{isPrimary:!0,content:this.l10n.getConstant("Download"),cssClass:"e-flat e-save-download-btn"}}]});b.appendTo("#"+t+"_saveDialog")},d.prototype.saveDialogClosed=function(e){F(document.getElementById(e+"_saveDropdownbtn"),"dropdownbutton")&&F(document.getElementById(e+"_saveDropdownbtn"),"dropdownbutton").destroy(),this.isSlider=!1,document.querySelector("#"+e+"_qualityButtonGroup")&&document.querySelector("#"+e+"_qualitySlider")&&(document.querySelector("#"+e+"_qualityButtonGroup").remove(),document.querySelector("#"+e+"_qualitySlider").remove(),document.querySelector("#"+e+"_imgsizeValueSpan").remove(),document.querySelector("#"+e+"_imageNameLabel").remove(),document.querySelector("#"+e+"_imgsizeSpan").remove()),document.getElementById(e+"_dialogContent").remove(),F(document.getElementById(e+"_saveDialog"),"dialog").destroy(),document.getElementById(e+"_saveDialog").remove()},d.prototype.onBeforeopen=function(){var e=this,i=this.parent,t=i.element.id,r={canvas:null},o=[{id:"jpeg",text:"JPEG"},{id:"png",text:"PNG"},{id:"svg",text:"SVG"},{id:"webp",text:"WebP"}],a=new Rt({placeholder:this.l10n.getConstant("ImageName")});a.appendTo("#"+t+"_imgNametext");var n=document.getElementById(t+"_imgQualitydiv"),s=document.getElementById(t+"_qualitySlider"),l=document.querySelector("#"+t+"_qualityButtonGroup"),p=document.querySelector("#"+t+"_qualitybuttonIcon"),h=document.querySelector("#"+t+"_imgsizeSpan"),u;w.isDevice?u=document.getElementById(t+"_qualitySize"):u=document.getElementById(t+"_imageNameLabel");var c={fileName:"",fileType:""};i.notify("draw",{prop:"getFileName",onPropertyChange:!1,value:{obj:c}}),this.fileType=c.fileType?c.fileType:"JPEG",i.notify("export",{prop:"exportToCanvas",value:{object:r}});var g=r.canvas,v=document.getElementById(t+"_imgPic");v.width=g.width,v.height=g.height;var b=new Xt({iconCss:"e-icons e-settings"});b.appendTo("#"+t+"_qualitybuttonIcon");var m=document.getElementById(t+"_saveDropdownbtn");if(m){var y=document.createElement("span");y.innerHTML=this.fileType==="Webp"?"Webp":this.fileType.toUpperCase(),m&&m.appendChild(y);var P=new q({items:o,open:function(O){w.isDevice&&(O.element.parentElement.style.top=P.element.getBoundingClientRect().top-O.element.parentElement.offsetHeight+"px");var j=y.innerHTML;j!==""&&O.element.querySelector('[aria-label = "'+j+'"]').classList.add("e-selected-btn")},select:function(O){h.style.display="none",e.fileType=y.innerHTML=O.item.text,O.item.id!=="jpeg"?(n.style.display="none",u.style.display="block",e.updateImageSize(1,r.canvas,e.fileType),s&&(e.isSlider&&F(s,"slider").destroy(),s.style.display="none"),e.isSlider=!1):(n.style.display="block",je([l],"e-hide"),s.style.display="none",u.style.display="block",e.updateImageSize(C(e.currentQuality)?1:e.currentQuality,r.canvas,e.fileType),document.getElementById(t+"_"+e.imageQuality).checked=!0)}});P.appendTo("#"+t+"_saveDropdownbtn");var S=document.getElementById(t+"_imgNametext");S.value=this.fileName?this.fileName:c.fileName,c.fileType&&c.fileType.toUpperCase()!=="JPEG"&&(n.style.display="none",h.style.display="none"),w.isDevice?(document.getElementById(t+"_dialogImgContent").style.display="none",document.getElementById(t+"_dialogRightContent").style.width="100%",this.updateImageSize(1,r.canvas,this.fileType)):this.updateImageSize(1,r.canvas,this.fileType)}document.getElementById(t+"_"+this.imageQuality).checked=!0,l.addEventListener("click",this.qualityBtnClickHandler.bind(this)),p.addEventListener("click",this.qualityBtnClickHandler.bind(this))},d.prototype.qualityBtnClickHandler=function(e){var i=this,t=this.parent,r=t.element.id,o=e.target,a={fileName:""},n={canvas:null},s={Good:.8,Great:.9,Highest:1},l=document.querySelector("#"+r+"_qualityButtonGroup"),p=document.querySelector("#"+r+"_qualitySlider"),h=document.querySelector("#"+r+"_qualityOptionContainer"),u=document.querySelector("#"+r+"_imgsizeSpan"),c=document.querySelector("#"+r+"_imgsizeValueSpan");if(t.notify("draw",{prop:"getFileName",onPropertyChange:!1,value:{obj:a}}),t.notify("export",{prop:"exportToCanvas",value:{object:n}}),e.currentTarget.id===r+"_qualitybuttonIcon"&&!this.isSlider){we([l],"e-hide"),p.style.display="block",u.style.display="inline-block",h.style.display="flex";var g=new Me({tooltip:{placement:"Before",isVisible:!0,format:"P0",showOn:"Focus"},min:.01,max:1,step:.01,value:this.currentQuality,type:"MinRange",width:w.isDevice?"80%":"190px",created:function(){i.updateImageSize(i.currentQuality,n.canvas,"jpeg"),c.innerHTML=Math.round(i.currentQuality*100).toString()},changed:function(v){i.currentQuality=v.value,c.innerHTML=Math.round(i.currentQuality*100).toString(),t.notify("export",{prop:"setImageQuality",value:{value:v.value}}),i.updateImageSize(v.value,n.canvas,"jpeg")}});g.appendTo("#"+r+"_qualitySlider"),g.element.parentElement.classList.add("e-ie-quality-slider"),this.isSlider=!0}else e.currentTarget.id===r+"_qualitybuttonIcon"&&this.isSlider?(F(p,"slider").destroy(),p.style.display="none",u.style.display="none",je([l],"e-hide"),h.style.display="block",this.isSlider=!1):s.hasOwnProperty(o.textContent)&&!this.isSlider&&(e.target.previousElementSibling.checked=!0,this.currentQuality=s[o.textContent],this.imageQuality=o.textContent.toLowerCase(),this.updateImageSize(s[o.textContent],n.canvas,"jpeg"))},d.prototype.updateImageSize=function(e,i,t){var r,o=this.parent,a=o.element.id,n=document.getElementById(a+"_imgPic"),s=n.getContext("2d"),l;if(w.isDevice?l=document.getElementById(a+"_qualitySize"):l=document.getElementById(a+"_imageNameLabel"),t.toLowerCase()==="jpeg")i.toBlob((function(m){if(r=Math.floor(m.size/1024),r>1e3){var y=r/1024;l.innerHTML=this.l10n.getConstant("ImageSize")+": "+y.toFixed(2)+" MB",r=+y.toFixed(2)}else l.innerHTML=this.l10n.getConstant("ImageSize")+": "+r.toFixed(2)+" KB",r=+r.toFixed(2);if(w.isDevice)n.style.display="none";else{var P=new Image;P.src=URL.createObjectURL(m),P.onload=function(){s.drawImage(P,0,0),URL.revokeObjectURL(P.src)}}this.fileSize=r}).bind(this),"image/jpeg",e);else if(!C(t)&&(t.toLowerCase()==="png"||t.toLowerCase()==="webp")){var p="image/"+t.toLowerCase();s.drawImage(i,0,0),i.toBlob((function(m){if(r=Math.floor(m.size/1024),r>1e3){var y=r/1024;l.innerHTML=this.l10n.getConstant("ImageSize")+": "+y.toFixed(2)+" MB",r=+y.toFixed(2)}else l.innerHTML=this.l10n.getConstant("ImageSize")+": "+r.toFixed(2)+" KB",r=+r.toFixed(2);w.isDevice&&(n.style.display="none"),this.fileSize=r}).bind(this),p,1)}else if(!C(t)&&t.toLowerCase()==="svg"){s.drawImage(i,0,0);var h=i.toDataURL("image/svg+xml"),u=h.split(",")[1],c=u.length,g=c,v=Math.floor(g/1024);if(v>1e3){var b=v/1024;l.innerHTML=this.l10n.getConstant("ImageSize")+": "+b.toFixed(2)+" MB",v=+b.toFixed(2)}else l.innerHTML=this.l10n.getConstant("ImageSize")+": "+v.toFixed(2)+" KB",v=+v.toFixed(2);w.isDevice&&(n.style.display="none"),this.fileSize=v}else if(w.isDevice)n.style.display="none";else if(s.drawImage(i,0,0),this.initialSize>1e3){var b=this.initialSize/1048576;l.innerHTML=this.l10n.getConstant("ImageSize")+": "+b.toFixed(2)+" MB"}else l.innerHTML=this.l10n.getConstant("ImageSize")+": "+this.initialSize.toFixed(2)+" KB"},d.prototype.download=function(){var e=this.parent,i=e.element.id;if(this.fileType==="JPEG"&&this.isSlider){var t=F(document.getElementById(i+"_qualitySlider"),"slider").value;e.notify("export",{prop:"setImageQuality",value:{value:t}})}else e.notify("export",{prop:"setImageQuality",value:{value:this.currentQuality}});var r=document.getElementById(i+"_imgNametext").value;e.export(this.fileType,r)},d.prototype.getCropTransformToolbarItem=function(){var e=this.parent,i=e.element.id,t=[];if(t.push({id:i+"_crop",tooltipText:this.l10n.getConstant("CropSelection"),align:"Center",template:'<button id="'+i+'_cropBtn"></button>'}),t.push({align:"Center",type:"Separator"}),(C(e.toolbar)||e.toolbar&&(e.toolbar.indexOf("Transform")>-1||e.toolbar.indexOf("RotateLeft")>-1))&&t.push({id:i+"_rotateLeft",prefixIcon:"e-icons e-anti-clock-wise",tooltipText:this.l10n.getConstant("RotateLeft"),align:"Center"}),(C(e.toolbar)||e.toolbar&&(e.toolbar.indexOf("Transform")>-1||e.toolbar.indexOf("RotateRight")>-1))&&t.push({id:i+"_rotateRight",prefixIcon:"e-icons e-clock-wise",tooltipText:this.l10n.getConstant("RotateRight"),align:"Center"}),t.length>2&&t.push({align:"Center",type:"Separator"}),(C(e.toolbar)||e.toolbar&&(e.toolbar.indexOf("Transform")>-1||e.toolbar.indexOf("HorizontalFlip")>-1))&&t.push({id:i+"_horizontalFlip",prefixIcon:"e-icons e-horizontal-flip",tooltipText:this.l10n.getConstant("HorizontalFlip"),align:"Center"}),(C(e.toolbar)||e.toolbar&&(e.toolbar.indexOf("Transform")>-1||e.toolbar.indexOf("VerticalFlip")>-1))&&t.push({id:i+"_verticalFlip",prefixIcon:"e-icons e-vertical-flip",tooltipText:this.l10n.getConstant("VerticalFlip"),align:"Center"}),(C(e.toolbar)||e.toolbar&&e.toolbar.indexOf("Straightening")>-1)&&!w.isDevice&&(t.push({align:"Center",type:"Separator"}),C(e.toolbar)||e.toolbar&&e.toolbar.indexOf("Straightening")>-1)){var r=document.createElement("span");r.innerHTML=this.l10n.getConstant("Straighten"),t.push({id:i+"_straightenSpan",cssClass:"e-ie-straighten-span",template:r,align:"Center"}),t.push({id:i+"_straighten",cssClass:"top-icon e-straighten",tooltipText:this.l10n.getConstant("Straighten"),align:"Center",type:"Input",template:'<div id="'+i+'_straightenSlider"></div>'});var o=document.createElement("span");o.innerHTML=e.transform.straighten.toString()+"&#176",t.push({id:i+"_straightenSpan",cssClass:"e-ie-straighten-value-span",template:o,align:"Center"})}return w.isDevice||(t.push({id:i+"_ok",prefixIcon:"e-icons e-check",cssClass:"top-icon e-tick",tooltipText:this.l10n.getConstant("OK"),align:"Right",tabIndex:0}),t.push({id:i+"_cancel",prefixIcon:"e-icons e-close",cssClass:"top-icon e-save",tooltipText:this.l10n.getConstant("Cancel"),align:"Right"})),t},d.prototype.getShapesToolbarItem=function(e){var i=this.parent,t=i.element.id,r=[];(C(i.toolbar)||i.toolbar)&&r.push({id:t+"_annotation",tooltipText:this.l10n.getConstant("Annotation"),align:"Center",template:'<button id="'+t+'_annotationBtn"></button>'}),e.indexOf("fillColor")>-1&&r.push({prefixIcon:"e-icons e-copy",id:t+"_fillcolor",cssClass:"top-icon e-fill",tooltipText:this.l10n.getConstant("FillColor"),align:"Center",type:"Input",template:'<button id="'+t+'_fillColorBtn"></button>'}),e.indexOf("strokeColor")>-1&&r.push({prefixIcon:"e-icons e-copy",id:t+"_strokecolor",cssClass:"top-icon e-stroke",tooltipText:this.l10n.getConstant("StrokeColor"),align:"Center",type:"Input",template:'<button id="'+t+'_borderColorBtn"></button>'}),e.indexOf("strokeWidth")>-1&&r.push({id:t+"_strokeWidth",cssClass:"top-icon e-size",tooltipText:this.l10n.getConstant("StrokeWidth"),align:"Center",type:"Input",template:'<button id="'+t+'_borderWidthBtn"></button>'}),e.indexOf("start")>-1&&r.push({id:t+"_start",cssClass:"top-icon e-size",tooltipText:this.l10n.getConstant("Start"),align:"Center",type:"Input",template:'<button id="'+t+'_startBtn"></button>'}),e.indexOf("borderRadius")>-1&&r.push({id:t+"_rectangleRadius",cssClass:"top-icon e-size",tooltipText:this.l10n.getConstant("BorderRadius"),align:"Center",type:"Input",template:'<button id="'+t+'_rectangleRadiusBtn"></button>'}),e.indexOf("end")>-1&&r.push({id:t+"_end",cssClass:"top-icon e-size",tooltipText:this.l10n.getConstant("End"),align:"Center",type:"Input",template:'<button id="'+t+'_endBtn"></button>'}),e.indexOf("flip")>-1&&(r.push({id:t+"_rotLeft",prefixIcon:"e-anti-clock-wise",tooltipText:this.l10n.getConstant("RotateLeft"),align:"Center"}),r.push({id:t+"_rotRight",prefixIcon:"e-clock-wise",tooltipText:this.l10n.getConstant("RotateRight"),align:"Center"}),r.push({id:t+"_hFlip",prefixIcon:"e-horizontal-flip",tooltipText:this.l10n.getConstant("HorizontalFlip"),align:"Center"}),r.push({id:t+"_vFlip",prefixIcon:"e-vertical-flip",tooltipText:this.l10n.getConstant("VerticalFlip"),align:"Center"})),e.indexOf("transparency")>-1&&(r.push({align:"Center",type:"Separator"}),r.push({id:t+"_transparency",prefixIcon:"e-opacity",tooltipText:this.l10n.getConstant("Opacity"),align:"Center"})),r.push({align:"Center",type:"Separator"}),e.indexOf("z-order")>-1&&r.push({id:t+"_zOrder",cssClass:"top-icon e-list-unordered-3",tooltipText:this.l10n.getConstant("ZOrder"),align:"Center",type:"Input",template:'<button id="'+t+'_zOrderBtn"></button>'}),e.indexOf("duplicate")>-1&&r.push({id:t+"_duplicate",prefixIcon:"e-icons e-order",cssClass:"top-icon e-order",tooltipText:this.l10n.getConstant("Duplicate"),align:"Center"}),e.indexOf("remove")>-1&&r.push({id:t+"_remove",prefixIcon:"e-icons e-trash",cssClass:"top-icon e-trash",tooltipText:this.l10n.getConstant("Remove"),align:"Center"}),e.indexOf("text")>-1&&r.push({id:t+"_editText",prefixIcon:"e-icons e-annotation-edit",cssClass:"top-icon e-annotation-edit",tooltipText:this.l10n.getConstant("EditText"),align:"Center"});for(var o=this.processSubToolbar(e),a=0,n=o.length;a<n;a++)r.push(o[a]);if(!w.isDevice){var s={shape:null};i.notify("selection",{prop:"getCurrentDrawingShape",value:{obj:s}}),s.shape!=="path"&&(r.push({id:t+"_ok",prefixIcon:"e-icons e-check",cssClass:"top-icon e-tick",tooltipText:this.l10n.getConstant("OK"),align:"Right",tabIndex:0}),r.push({id:t+"_cancel",prefixIcon:"e-icons e-close",cssClass:"top-icon e-save",tooltipText:this.l10n.getConstant("Cancel"),align:"Right"}))}return r},d.prototype.initCropTransformToolbar=function(e,i){var t=this,r=this.parent,o=r.element.id,a=this.getLeftToolbarItem(),n=this.getRightToolbarItem(),s=this.getCropTransformToolbarItem(),l=this.getZoomToolbarItem();w.isDevice?this.defToolbarItems=s:this.defToolbarItems=a.concat(l,s,n);var p={toolbarType:"crop-transform",toolbarItems:this.defToolbarItems};r.trigger("toolbarUpdating",p),this.defToolbarItems=p.toolbarItems;var h=new ie({width:"100%",items:this.defToolbarItems,clicked:this.defToolbarClicked.bind(this),created:function(){t.renderCropBtn(e),t.renderStraightenSlider(),t.wireZoomBtnEvents(),r.trigger("toolbarCreated",{toolbarType:"shapes"}),w.isDevice?t.defToolbarItems.length>0&&document.getElementById(o+"_bottomToolbar")&&(h.refreshOverflow(),h.refreshOverflow(),h.refreshOverflow()):(t.createLeftToolbarControls(),t.defToolbarItems.length>0&&document.getElementById(o+"_toolbar")&&h.refreshOverflow()),document.getElementById(o+"_cropBtn")&&C(i)&&(w.isDevice||r.notify("draw",{prop:"select",onPropertyChange:!1,value:{type:t.getCropTextContent(document.getElementById(o+"_cropBtn")).toLowerCase(),startX:null,startY:null,width:null,height:null}}))}});w.isDevice?h.appendTo("#"+o+"_bottomToolbar"):h.appendTo("#"+o+"_toolbar");var u=r.element.querySelector("#"+o+"_straightenSlider");(C(r.toolbar)||r.toolbar&&r.toolbar.indexOf("Straightening")>-1)&&u&&u.parentElement.clientHeight>this.toolbarHeight&&(this.toolbarHeight=r.toolbarHeight=u.parentElement.clientHeight),this.enableDisableTbrBtn(),r.notify("transform",{prop:"disableZoomOutBtn",value:{isZoomOut:!0}})},d.prototype.getCropTextContent=function(e){if(e){var i={"e-custom":"Custom","e-circle":"Circle","e-square":"Square","e-custom-a":"3:2","e-custom-b":"4:3","e-custom-c":"5:4","e-custom-d":"7:5","e-custom-e":"16:9","e-custom-f":"2:3","e-custom-g":"3:4","e-custom-h":"4:5","e-custom-i":"5:7","e-custom-j":"9:16"},t=e.children[0].classList;for(var r in i)if(t.contains(r))return i[r]}return""},d.prototype.getCurrentShapeIcon=function(e){var i={rectangle:"e-rectangle",ellipse:"e-circle",line:"e-line",arrow:"e-arrow-right-up",path:"e-critical-path",text:"e-add-text",image:"e-image",pen:"e-free-pen","crop-custom":"e-custom","crop-circle":"e-circle","crop-square":"e-square","crop-3:2":"e-custom-a","crop-4:3":"e-custom-b","crop-5:4":"e-custom-c","crop-7:5":"e-custom-d","crop-16:9":"e-custom-e","crop-2:3":"e-custom-f","crop-3:4":"e-custom-g","crop-4:5":"e-custom-h","crop-5:7":"e-custom-i","crop-9:16":"e-custom-j"};return i[e]?i[e]:e&&e.indexOf("crop-")!==-1?"e-custom":"e-free-pen"},d.prototype.initShapesToolbarItem=function(e){var i=this,t=this.parent,r=t.element.id,o=this.getLeftToolbarItem(),a=this.getRightToolbarItem(),n=this.getShapesToolbarItem(e),s=this.getZoomToolbarItem();w.isDevice?this.defToolbarItems=n:this.defToolbarItems=o.concat(s,n,a);var l={toolbarType:t.activeObj.shape?t.activeObj.shape:"shapes",toolbarItems:this.defToolbarItems};t.trigger("toolbarUpdating",l),this.isToolbarString(l.toolbarItems)?(e=l.toolbarItems,this.excludeItems(l.toolbarItems)):this.defToolbarItems=l.toolbarItems;var p=new ie({width:"100%",items:this.defToolbarItems,clicked:this.defToolbarClicked.bind(this),created:function(){i.renderAnnotationBtn(!0),i.createRectangleRadius(e),i.createShapeColor(e),i.createShapeBtn(e),i.createZOrderBtn(e),t.activeObj.shape==="arrow"&&(e.some(function(h){return h.toLowerCase().indexOf("start")>-1})&&i.createStartBtn(),e.some(function(h){return h.toLowerCase().indexOf("end")>-1})&&i.createEndBtn()),i.wireZoomBtnEvents(),t.trigger("toolbarCreated",{toolbarType:"shapes"}),w.isDevice?i.defToolbarItems.length>0&&document.getElementById(r+"_bottomToolbar")&&(p.refreshOverflow(),p.refreshOverflow(),p.refreshOverflow()):(i.createLeftToolbarControls(),i.defToolbarItems.length>0&&document.getElementById(r+"_toolbar")&&p.refreshOverflow())}});w.isDevice?p.appendTo("#"+r+"_bottomToolbar"):p.appendTo("#"+r+"_toolbar"),this.enableDisableTbrBtn()},d.prototype.createRectangleRadius=function(e){var i=this,t=this.parent,r=t.element.id;if(e.indexOf("borderRadius")>-1){var o=[{id:"1",text:this.l10n.getConstant("0")},{id:"2",text:this.l10n.getConstant("20")},{id:"3",text:this.l10n.getConstant("40")},{id:"4",text:this.l10n.getConstant("60")},{id:"5",text:this.l10n.getConstant("80")},{id:"6",text:this.l10n.getConstant("100")}],a=document.getElementById(r+"_rectangleRadiusBtn"),n=document.createElement("span");n.innerHTML=this.l10n.getConstant(t.frameObj.radius.toString()),n.className="e-shape-rectangle-radius",a.appendChild(n);var s=new q({items:o,open:function(l){if(w.isDevice){var p=l.element.parentElement;p.style.top=s.element.getBoundingClientRect().top-p.offsetHeight+"px"}var h=s.element.childNodes[0].textContent;h!==""&&l.element.querySelector('[aria-label = "'+h+'"]').classList.add("e-selected-btn")},select:function(l){if(i.triggerTbarClickEvent(l),n.textContent=l.item.text,t.updateStrokeWidth(l.item.id,"radius"),w.isDevice){if(document.getElementById(r+"_bottomToolbar")){var p=F(r+"_bottomToolbar","toolbar");p.refreshOverflow()}}else if(document.getElementById(r+"_toolbar")){var h=F(r+"_toolbar","toolbar");h.refreshOverflow()}t.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1})}});s.appendTo("#"+r+"_rectangleRadiusBtn")}},d.prototype.beforeModeSwitch=function(e,i){this.popupLeft=e.element.offsetParent.style.left,e.mode==="Picker"?(i.showButtons=!0,i.dataBind(),e.element.querySelector(".e-apply").title=this.l10n.getConstant("Apply"),e.element.querySelector(".e-cancel").title=this.l10n.getConstant("Cancel"),e.element.querySelector(".e-mode-switch-btn").title=this.l10n.getConstant("StandardColors")):(i.showButtons=!1,i.dataBind(),e.element.querySelector(".e-mode-switch-btn").title=this.l10n.getConstant("MoreColors"))},d.prototype.createShapeColor=function(e){var i=this,t=this.parent,r=t.element.id;if(e.indexOf("fillColor")>-1){t.element.querySelector(".e-template.e-fill").appendChild(t.createElement("input",{id:r+"_shape_fill"}));var o=new ve({modeSwitcher:!0,noColor:!0,value:"",inline:!0,showButtons:!1,mode:"Palette",cssClass:"e-shape-fill-color",beforeModeSwitch:function(l){return i.beforeModeSwitch(l,o)},presetColors:{custom:["","#f44336","#e91e63","#9c27b0","#673ab7","#2196f3","#03a9f4","#00bcd4","#009688","#ffeb3b","#ffffff","#ffebee","#fce4ec","#f3e5f5","#ede7f6","#e3f2fd","#e1f5fe","#e0f7fa","#e0f2f1","#fffde7","#f2f2f2","#ffcdd2","#f8bbd0","#e1bee7","#d1c4e9","#bbdefb","#b3e5fc","#b2ebf2","#b2dfdb","#fff9c4","#e6e6e6","#ef9a9a","#f48fb1","#ce93d8","#b39ddb","#90caf9","#81d4fa","#80deea","#80cbc4","#fff59d","#cccccc","#e57373","#f06292","#ba68c8","#9575cd","#64b5f6","#4fc3f7","#4dd0e1","#4db6ac","#fff176","#b3b3b3","#ef5350","#ec407a","#ab47bc","#7e57c2","#42a5f5","#29b6f6","#26c6da","#26a69a","#ffee58","#999999","#e53935","#d81b60","#8e24aa","#5e35b1","#1e88e5","#039be5","#00acc1","#00897b","#fdd835","#808080","#d32f2f","#c2185b","#7b1fa2","#512da8","#1976d2","#0288d1","#0097a7","#00796b","#fbc02d","#666666","#c62828","#ad1457","#6a1b9a","#4527a0","#1565c0","#0277bd","#00838f","#00695c","#f9a825","#4d4d4d","#b71c1c","#880e4f","#4a148c","#311b92","#0d47a1","#01579b","#006064","#004d40","#f57f17"]},beforeTileRender:function(l){l.value===""&&l.element.classList.add("e-nocolor-item")},change:function(l){t.updateFillColor(l.value),l.currentValue.rgba===""?a.element.children[0].classList.add("e-nocolor-item"):(a.element.children[0].classList.remove("e-nocolor-item"),a.element.children[0].style.backgroundColor=l.currentValue.rgba),a.toggle(),t.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1})},onModeSwitch:function(l){w.isDevice&&(l.element.parentElement.parentElement.style.left=i.popupLeft,l.element.parentElement.parentElement.style.top=a.element.getBoundingClientRect().top-l.element.parentElement.parentElement.offsetHeight+"px")},beforeClose:function(){a.toggle()}},"#"+r+"_shape_fill"),a=new q({open:function(l){var p=l.element.parentElement;w.isDevice&&(p.style.top=a.element.getBoundingClientRect().top-p.offsetHeight+"px",window.innerWidth<=520&&(p.style.left=t.element.offsetLeft+"px"))},target:".e-shape-fill-color",iconCss:"e-dropdownbtn-preview",cssClass:"e-ie-ddb-popup"},"#"+r+"_fillColorBtn");o.inline=!0,o.value=o.getValue(o.value,"rgba"),t.element.querySelector(".e-fill.e-template .e-dropdownbtn-preview").classList.add("e-nocolor-item")}if(e.indexOf("strokeColor")>-1){t.element.querySelector(".e-template.e-stroke").appendChild(t.createElement("input",{id:r+"_shape_stroke"}));var n=new ve({modeSwitcher:!0,noColor:!1,value:"#fff",inline:!0,showButtons:!1,mode:"Palette",cssClass:"e-shape-stroke-color",beforeModeSwitch:function(l){i.popupLeft=l.element.offsetParent.style.left,n.value=t.activeObj.strokeSettings.strokeColor!=="#fff"?t.activeObj.strokeSettings.strokeColor:"#008000ff",i.beforeModeSwitch(l,n)},presetColors:this.presetColors,change:function(l){t.updateStrokeColor(l.value),s.element.children[0].style.backgroundColor=l.currentValue.rgba,s.toggle(),t.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1})},onModeSwitch:function(l){w.isDevice&&(l.element.parentElement.parentElement.style.left=i.popupLeft,l.element.parentElement.parentElement.style.top=s.element.getBoundingClientRect().top-l.element.parentElement.parentElement.offsetHeight+"px")},beforeClose:function(){s.toggle()}},"#"+r+"_shape_stroke"),s=new q({open:function(l){var p=l.element.parentElement;w.isDevice&&(p.style.top=s.element.getBoundingClientRect().top-p.offsetHeight+"px",window.innerWidth<=520&&(p.style.left=t.element.offsetLeft+"px"))},target:".e-shape-stroke-color",iconCss:"e-dropdownbtn-preview",cssClass:"e-ie-ddb-popup"},"#"+r+"_borderColorBtn");n.inline=!0,n.value=n.getValue(n.value,"rgba"),t.element.querySelector(".e-stroke.e-template .e-dropdownbtn-preview").style.background="#fff"}},d.prototype.createShapeBtn=function(e){var i=this,t=this.parent,r=t.element.id;if(e.indexOf("strokeWidth")>-1){var o=[{id:"1",text:this.l10n.getConstant("XSmall")},{id:"2",text:this.l10n.getConstant("Small")},{id:"3",text:this.l10n.getConstant("Medium")},{id:"4",text:this.l10n.getConstant("Large")},{id:"5",text:this.l10n.getConstant("XLarge")}];t.activeObj.shape&&(t.activeObj.shape==="rectangle"||t.activeObj.shape==="ellipse")&&(o=[{id:"1",text:this.l10n.getConstant("NoOutline")},{id:"2",text:this.l10n.getConstant("XSmall")},{id:"3",text:this.l10n.getConstant("Small")},{id:"4",text:this.l10n.getConstant("Medium")},{id:"5",text:this.l10n.getConstant("Large")},{id:"6",text:this.l10n.getConstant("XLarge")}]);var a=document.getElementById(r+"_borderWidthBtn"),n=document.createElement("span");n.innerHTML=this.l10n.getConstant("XSmall"),n.className="e-shape-stroke-width",a.appendChild(n);var s=new q({items:o,open:function(l){w.isDevice&&(l.element.parentElement.style.top=s.element.getBoundingClientRect().top-l.element.parentElement.offsetHeight+"px");var p=n.innerHTML;p!==""&&l.element.querySelector('[aria-label = "'+p+'"]').classList.add("e-selected-btn")},select:function(l){if(i.triggerTbarClickEvent(l),n.textContent=l.item.text,t.updateStrokeWidth(l.item.id,"width",t.activeObj.shape),w.isDevice){if(document.getElementById(r+"_bottomToolbar")){var p=F(r+"_bottomToolbar","toolbar");p.refreshOverflow()}}else if(document.getElementById(r+"_toolbar")){var h=F(r+"_toolbar","toolbar");h.refreshOverflow()}t.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1})}});s.appendTo("#"+r+"_borderWidthBtn")}},d.prototype.createZOrderBtn=function(e){var i=this,t=this.parent,r=t.element.id;if(e.indexOf("z-order")>-1){var o=[{text:this.l10n.getConstant("BringForward"),id:"bringForward",iconCss:"e-icons e-bring-forward"},{text:this.l10n.getConstant("SendBackward"),id:"sendBackward",iconCss:"e-icons e-send-backward"},{text:this.l10n.getConstant("BringToFront"),id:"bringToFront",iconCss:"e-icons e-bring-to-front"},{text:this.l10n.getConstant("SendToBack"),id:"sendToBack",iconCss:"e-icons e-send-to-back"}],a=new q({items:o,iconCss:"e-icons e-layers",beforeOpen:function(n){document.getElementById(t.element.id+"_zOrderBtn").classList.contains("e-disabled")&&(n.cancel=!0);var s={freehandSelectedIndex:-1};t.notify("freehand-draw",{prop:"getFreehandSelectedIndex",onPropertyChange:!1,value:{obj:s}});var l={order:null};t.notify("shape",{prop:"getHighestOrder",onPropertyChange:!1,value:{obj:l}});var p=t.activeObj.order?t.activeObj.order:t.getObjFromId(t.pointColl[s.freehandSelectedIndex].id).order;p&&p>=l.order?(n.items[0].disabled=!0,n.items[2].disabled=!0):(n.items[0].disabled=!1,n.items[2].disabled=!1),t.notify("shape",{prop:"getLowestOrder",onPropertyChange:!1,value:{obj:l}}),p&&p<=l.order?(n.items[1].disabled=!0,n.items[3].disabled=!0):(n.items[1].disabled=!1,n.items[3].disabled=!1)},open:function(n){w.isDevice&&(n.element.parentElement.style.top=a.element.getBoundingClientRect().top-n.element.parentElement.offsetHeight+"px")},select:function(n){i.triggerTbarClickEvent(n);var s={freehandDrawSelectedId:null};t.notify("freehand-draw",{prop:"getFreehandDrawSelectedId",onPropertyChange:!1,value:{obj:s}});var l=s.freehandDrawSelectedId?s.freehandDrawSelectedId:t.activeObj.currIndex;if(t.updateShapeOrder(l,n.item.id),w.isDevice){if(document.getElementById(r+"_bottomToolbar")){var p=F(r+"_bottomToolbar","toolbar");p.refreshOverflow()}}else if(document.getElementById(r+"_toolbar")){var h=F(r+"_toolbar","toolbar");h.refreshOverflow()}l.indexOf("shape")>-1?t.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1}):l.indexOf("pen")>-1&&t.notify("undo-redo",{prop:"updateUndoRedoStack",value:{isPenDraw:!0}})}});a.appendTo("#"+r+"_zOrderBtn")}},d.prototype.createStartBtn=function(){var e=this,i=this.parent,t=i.element.id,r=[{id:"1",text:this.l10n.getConstant("None")},{id:"2",text:this.l10n.getConstant("Bar")},{id:"3",text:this.l10n.getConstant("Arrow")},{id:"4",text:this.l10n.getConstant("ArrowSolid")},{id:"5",text:this.l10n.getConstant("Circle")},{id:"6",text:this.l10n.getConstant("CircleSolid")},{id:"7",text:this.l10n.getConstant("Square")},{id:"8",text:this.l10n.getConstant("SquareSolid")}],o=document.getElementById(t+"_startBtn"),a=document.createElement("span");C(i.activeObj.start)&&(i.activeObj.start="none"),a.innerHTML=i.pascalToSplitWords(i.activeObj.start),a.className="e-shape-start",o.appendChild(a);var n=new q({items:r,open:function(s){w.isDevice&&(s.element.parentElement.style.top=n.element.getBoundingClientRect().top-s.element.parentElement.offsetHeight+"px");var l=a.innerHTML;l!==""&&s.element.querySelector('[aria-label = "'+l+'"]').classList.add("e-selected-btn")},select:function(s){var l={1:"none",2:"bar",3:"arrow",4:"arrowSolid",5:"circle",6:"circleSolid",7:"square",8:"squareSolid"};i.notify("selection",{prop:"setArrowShape",value:{type:"initial",shape:l[""+s.item.id]}}),e.triggerTbarClickEvent(s),a.textContent=s.item.text,i.updateArrow("startArrow",s.item.id),i.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1})}});n.appendTo("#"+t+"_startBtn")},d.prototype.createEndBtn=function(){var e=this,i=this.parent,t=i.element.id,r=[{id:"1",text:this.l10n.getConstant("None")},{id:"2",text:this.l10n.getConstant("Bar")},{id:"3",text:this.l10n.getConstant("Arrow")},{id:"4",text:this.l10n.getConstant("ArrowSolid")},{id:"5",text:this.l10n.getConstant("Circle")},{id:"6",text:this.l10n.getConstant("CircleSolid")},{id:"7",text:this.l10n.getConstant("Square")},{id:"8",text:this.l10n.getConstant("SquareSolid")}],o=document.getElementById(t+"_endBtn"),a=document.createElement("span");C(i.activeObj.end)&&(i.activeObj.end="arrowSolid"),a.innerHTML=i.pascalToSplitWords(i.activeObj.end),a.className="e-shape-end",o.appendChild(a);var n=new q({items:r,open:function(s){w.isDevice&&(s.element.parentElement.style.top=n.element.getBoundingClientRect().top-s.element.parentElement.offsetHeight+"px");var l=a.innerHTML;l!==""&&s.element.querySelector('[aria-label = "'+l+'"]').classList.add("e-selected-btn")},select:function(s){var l={1:"none",2:"bar",3:"arrow",4:"arrowSolid",5:"circle",6:"circleSolid",7:"square",8:"squareSolid"};i.notify("selection",{prop:"setArrowShape",value:{type:"final",shape:l[""+s.item.id]}}),e.triggerTbarClickEvent(s),a.textContent=s.item.text,i.updateArrow("endArrow",s.item.id),i.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1})}});n.appendTo("#"+t+"_endBtn")},d.prototype.getTextToolbarItem=function(e){var i=this.parent,t=i.element.id,r=[];(C(i.toolbar)||i.toolbar)&&r.push({id:t+"_annotation",tooltipText:this.l10n.getConstant("Annotation"),align:"Center",template:'<button id="'+t+'_annotationBtn"></button>'}),e.indexOf("fontFamily")>-1&&r.push({id:t+"_fontFamily",cssClass:"top-icon e-img-font-family",tooltipText:this.l10n.getConstant("FontFamily"),align:"Center",template:'<button id="'+t+'_fontFamilyBtn"></button>'}),e.indexOf("fontSize")>-1&&r.push({id:t+"_fontSize",cssClass:"top-icon e-img-font-size",tooltipText:this.l10n.getConstant("FontSize"),align:"Center",template:'<button id="'+t+'_fontSizeBtn"></button>'}),e.indexOf("fontColor")>-1&&r.push({cssClass:"top-icon e-text-font-color",id:t+"_text_strokecolor",tooltipText:this.l10n.getConstant("FontColor"),align:"Center",type:"Input",template:'<button id="'+t+'_fontColorBtn"></button>'}),e.indexOf("strokeColor")>-1&&r.push({cssClass:"top-icon e-stroke-text-font-color",id:t+"_stroke_text_color",tooltipText:this.l10n.getConstant("TextOutlineColor"),align:"Center",type:"Input",template:'<button id="'+t+'_strokeTextColorBtn"></button>'}),e.indexOf("fillColor")>-1&&r.push({cssClass:"top-icon e-text-background-color",id:t+"_text_backgroundcolor",tooltipText:this.l10n.getConstant("FillColor"),align:"Center",type:"Input",template:'<button id="'+t+'_bgColorBtn"></button>'}),e.indexOf("bold")>-1&&r.push({id:t+"_bold",prefixIcon:"e-icons e-bold",cssClass:"top-icon e-bold",tooltipText:this.l10n.getConstant("Bold"),align:"Center"}),e.indexOf("italic")>-1&&r.push({id:t+"_italic",prefixIcon:"e-icons e-italic",cssClass:"top-icon e-italic",tooltipText:this.l10n.getConstant("Italic"),align:"Center"}),e.indexOf("strokeWidth")>-1&&r.push({id:t+"_strokeWidth",cssClass:"top-icon e-size",tooltipText:this.l10n.getConstant("TextOutlineWidth"),align:"Center",type:"Input",template:'<button id="'+t+'_borderWidthBtn"></button>'}),e.indexOf("transparency")>-1&&r.push({id:t+"_transparency",prefixIcon:"e-opacity",tooltipText:this.l10n.getConstant("Opacity"),align:"Center"}),r.push({align:"Center",type:"Separator"}),e.indexOf("z-order")>-1&&r.push({id:t+"_zOrder",cssClass:"top-icon e-list-unordered-3",tooltipText:this.l10n.getConstant("ZOrder"),align:"Center",type:"Input",template:'<button id="'+t+'_zOrderBtn"></button>'}),e.indexOf("duplicate")>-1&&r.push({id:t+"_duplicate",prefixIcon:"e-icons e-order",cssClass:"top-icon e-order",tooltipText:this.l10n.getConstant("Duplicate"),align:"Center",disabled:i.textArea.style.display==="block"||i.textArea.style.display==="inline-block"}),e.indexOf("remove")>-1&&r.push({id:t+"_remove",prefixIcon:"e-icons e-trash",cssClass:"top-icon e-trash",tooltipText:this.l10n.getConstant("Remove"),align:"Center",disabled:i.textArea.style.display==="block"||i.textArea.style.display==="inline-block"}),e.indexOf("text")>-1&&r.push({id:t+"_editText",prefixIcon:"e-icons e-annotation-edit",cssClass:"top-icon e-annotation-edit",tooltipText:this.l10n.getConstant("EditText"),align:"Center",disabled:i.textArea.style.display==="block"||i.textArea.style.display==="inline-block"});for(var o=this.processSubToolbar(e),a=0,n=o.length;a<n;a++)r.push(o[a]);return w.isDevice||(r.push({id:t+"_ok",prefixIcon:"e-icons e-check",cssClass:"top-icon e-tick",tooltipText:this.l10n.getConstant("OK"),align:"Right",tabIndex:0}),r.push({id:t+"_cancel",prefixIcon:"e-icons e-close",cssClass:"top-icon e-save",tooltipText:this.l10n.getConstant("Cancel"),align:"Right"})),r},d.prototype.getFontFamilyItems=function(){var e=this.parent,i=[];return e.fontFamily&&e.fontFamily.items&&e.fontFamily.items.length>0?i=e.fontFamily.items:w.isDevice?i=[{id:"arial",text:"ABC"},{id:"calibri",text:"ABC"},{id:"georgia",text:"ABC"},{id:"roboto",text:"ABC"},{id:"tahoma",text:"ABC"}]:i=[{id:"arial",text:"Arial"},{id:"calibri",text:"Calibri"},{id:"georgia",text:"Georgia"},{id:"roboto",text:"Roboto"},{id:"tahoma",text:"Tahoma"}],i},d.prototype.initTextToolbarItem=function(e){var i=this,t=this.parent,r=t.element.id,o=this.getLeftToolbarItem(),a=this.getRightToolbarItem(),n=this.getTextToolbarItem(e),s=this.getZoomToolbarItem();w.isDevice?this.defToolbarItems=n:this.defToolbarItems=o.concat(s,n,a);var l={toolbarType:"text",toolbarItems:this.defToolbarItems};t.trigger("toolbarUpdating",l),this.isToolbarString(l.toolbarItems)?(e=l.toolbarItems,this.excludeItems(l.toolbarItems)):this.defToolbarItems=l.toolbarItems;var p=new ie({width:"100%",items:this.defToolbarItems,clicked:this.defToolbarClicked.bind(this),created:function(){i.renderAnnotationBtn(!0),i.createTextColor(e),i.createStrokeTextColor(e),i.createShapeBtn(e),i.createBackgroundColor(e),i.createTextBtn(e),i.createZOrderBtn(e),i.wireZoomBtnEvents(),t.trigger("toolbarCreated",{toolbarType:"text"}),w.isDevice?i.defToolbarItems.length>0&&document.getElementById(r+"_bottomToolbar")&&(p.refreshOverflow(),p.refreshOverflow(),p.refreshOverflow()):(i.createLeftToolbarControls(),i.defToolbarItems.length>0&&document.getElementById(r+"_toolbar")&&p.refreshOverflow())}});w.isDevice?p.appendTo("#"+r+"_bottomToolbar"):p.appendTo("#"+r+"_toolbar"),this.enableDisableTbrBtn()},d.prototype.createTextColor=function(e){var i=this,t=this.parent,r=t.element.id;if(e.indexOf("fontColor")>-1&&t.element.querySelector(".e-template.e-text-font-color")){t.element.querySelector(".e-template.e-text-font-color").appendChild(t.createElement("input",{id:r+"_text_font"}));var o=new ve({modeSwitcher:!0,noColor:!1,value:"#fff",inline:!0,showButtons:!1,mode:"Palette",cssClass:"e-text-fontt-color",beforeModeSwitch:function(n){i.popupLeft=n.element.offsetParent.style.left,o.value=t.activeObj.strokeSettings.strokeColor!=="#fff"?t.activeObj.strokeSettings.strokeColor:"#008000ff",i.beforeModeSwitch(n,o)},presetColors:this.presetColors,change:function(n){t.updateFontColor(n.value,"Text"),a.element.children[0].style.backgroundColor=n.currentValue.rgba,a.toggle(),(t.activeObj.activePoint.width!==0||t.activeObj.activePoint.height!==0)&&t.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1})},onModeSwitch:function(n){w.isDevice&&(n.element.parentElement.parentElement.style.left=i.popupLeft,n.element.parentElement.parentElement.style.top=a.element.getBoundingClientRect().top-n.element.parentElement.parentElement.offsetHeight+"px")},beforeClose:function(){a.toggle()}},"#"+r+"_text_font"),a=new q({open:function(n){var s=n.element.parentElement;w.isDevice&&(s.style.top=a.element.getBoundingClientRect().top-s.offsetHeight+"px",window.innerWidth<=520&&(s.style.left=t.element.offsetLeft+"px"))},target:".e-text-fontt-color",iconCss:"e-dropdownbtn-preview",cssClass:"e-ie-ddb-popup"},"#"+r+"_fontColorBtn");o.inline=!0,o.value=o.getValue(o.value,"rgba"),t.element.querySelector(".e-text-font-color.e-template .e-dropdownbtn-preview").style.background="#fff"}},d.prototype.createBackgroundColor=function(e){var i=this,t=this.parent,r=t.element.id;if(e.indexOf("fillColor")>-1&&t.element.querySelector(".e-template.e-text-background-color")){t.element.querySelector(".e-template.e-text-background-color").appendChild(t.createElement("input",{id:r+"_text_bgColor"}));var o=new ve({modeSwitcher:!0,noColor:!0,value:"",inline:!0,showButtons:!1,mode:"Palette",cssClass:"e-text-fontt-color",beforeModeSwitch:function(n){i.popupLeft=n.element.offsetParent.style.left,i.beforeModeSwitch(n,o)},presetColors:{custom:["","#f44336","#e91e63","#9c27b0","#673ab7","#2196f3","#03a9f4","#00bcd4","#009688","#ffeb3b","#ffffff","#ffebee","#fce4ec","#f3e5f5","#ede7f6","#e3f2fd","#e1f5fe","#e0f7fa","#e0f2f1","#fffde7","#f2f2f2","#ffcdd2","#f8bbd0","#e1bee7","#d1c4e9","#bbdefb","#b3e5fc","#b2ebf2","#b2dfdb","#fff9c4","#e6e6e6","#ef9a9a","#f48fb1","#ce93d8","#b39ddb","#90caf9","#81d4fa","#80deea","#80cbc4","#fff59d","#cccccc","#e57373","#f06292","#ba68c8","#9575cd","#64b5f6","#4fc3f7","#4dd0e1","#4db6ac","#fff176","#b3b3b3","#ef5350","#ec407a","#ab47bc","#7e57c2","#42a5f5","#29b6f6","#26c6da","#26a69a","#ffee58","#999999","#e53935","#d81b60","#8e24aa","#5e35b1","#1e88e5","#039be5","#00acc1","#00897b","#fdd835","#808080","#d32f2f","#c2185b","#7b1fa2","#512da8","#1976d2","#0288d1","#0097a7","#00796b","#fbc02d","#666666","#c62828","#ad1457","#6a1b9a","#4527a0","#1565c0","#0277bd","#00838f","#00695c","#f9a825","#4d4d4d","#b71c1c","#880e4f","#4a148c","#311b92","#0d47a1","#01579b","#006064","#004d40","#f57f17"]},beforeTileRender:function(n){n.value===""&&n.element.classList.add("e-nocolor-item")},change:function(n){t.updateFontColor(n.value,"Background"),n.currentValue.rgba===""?a.element.children[0].classList.add("e-nocolor-item"):(a.element.children[0].classList.remove("e-nocolor-item"),a.element.children[0].style.backgroundColor=n.currentValue.rgba),a.toggle(),(t.activeObj.activePoint.width!==0||t.activeObj.activePoint.height!==0)&&t.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1})},onModeSwitch:function(n){w.isDevice&&(n.element.parentElement.parentElement.style.left=i.popupLeft,n.element.parentElement.parentElement.style.top=a.element.getBoundingClientRect().top-n.element.parentElement.parentElement.offsetHeight+"px")},beforeClose:function(){a.toggle()}},"#"+r+"_text_bgColor"),a=new q({open:function(n){var s=n.element.parentElement;w.isDevice&&(s.style.top=a.element.getBoundingClientRect().top-s.offsetHeight+"px",window.innerWidth<=520&&(s.style.left=t.element.offsetLeft+"px"))},target:".e-text-fontt-color",iconCss:"e-dropdownbtn-preview",cssClass:"e-ie-ddb-popup"},"#"+r+"_bgColorBtn");o.inline=!0,o.value=o.getValue(o.value,"rgba"),t.element.querySelector(".e-text-background-color.e-template .e-dropdownbtn-preview").style.background="#fff"}},d.prototype.createStrokeTextColor=function(e){var i=this,t=this.parent,r=t.element.id;if(e.indexOf("strokeColor")>-1&&t.element.querySelector(".e-template.e-stroke-text-font-color")){t.element.querySelector(".e-template.e-stroke-text-font-color").appendChild(t.createElement("input",{id:r+"_stroke_text"}));var o=new ve({modeSwitcher:!0,noColor:!0,value:"",inline:!0,showButtons:!1,mode:"Palette",cssClass:"e-text-fontt-color",beforeModeSwitch:function(n){i.popupLeft=n.element.offsetParent.style.left,i.beforeModeSwitch(n,o)},presetColors:{custom:["","#f44336","#e91e63","#9c27b0","#673ab7","#2196f3","#03a9f4","#00bcd4","#009688","#ffeb3b","#ffffff","#ffebee","#fce4ec","#f3e5f5","#ede7f6","#e3f2fd","#e1f5fe","#e0f7fa","#e0f2f1","#fffde7","#f2f2f2","#ffcdd2","#f8bbd0","#e1bee7","#d1c4e9","#bbdefb","#b3e5fc","#b2ebf2","#b2dfdb","#fff9c4","#e6e6e6","#ef9a9a","#f48fb1","#ce93d8","#b39ddb","#90caf9","#81d4fa","#80deea","#80cbc4","#fff59d","#cccccc","#e57373","#f06292","#ba68c8","#9575cd","#64b5f6","#4fc3f7","#4dd0e1","#4db6ac","#fff176","#b3b3b3","#ef5350","#ec407a","#ab47bc","#7e57c2","#42a5f5","#29b6f6","#26c6da","#26a69a","#ffee58","#999999","#e53935","#d81b60","#8e24aa","#5e35b1","#1e88e5","#039be5","#00acc1","#00897b","#fdd835","#808080","#d32f2f","#c2185b","#7b1fa2","#512da8","#1976d2","#0288d1","#0097a7","#00796b","#fbc02d","#666666","#c62828","#ad1457","#6a1b9a","#4527a0","#1565c0","#0277bd","#00838f","#00695c","#f9a825","#4d4d4d","#b71c1c","#880e4f","#4a148c","#311b92","#0d47a1","#01579b","#006064","#004d40","#f57f17"]},beforeTileRender:function(n){n.value===""&&n.element.classList.add("e-nocolor-item")},change:function(n){t.updateStrokeTextColor(n.value),n.currentValue.rgba===""?a.element.children[0].classList.add("e-nocolor-item"):(a.element.children[0].classList.remove("e-nocolor-item"),a.element.children[0].style.backgroundColor=n.currentValue.rgba),a.toggle(),(t.activeObj.activePoint.width!==0||t.activeObj.activePoint.height!==0)&&t.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1})},onModeSwitch:function(n){w.isDevice&&(n.element.parentElement.parentElement.style.left=i.popupLeft,n.element.parentElement.parentElement.style.top=a.element.getBoundingClientRect().top-n.element.parentElement.parentElement.offsetHeight+"px")},beforeClose:function(){a.toggle()}},"#"+r+"_stroke_text"),a=new q({open:function(n){var s=n.element.parentElement;w.isDevice&&(s.style.top=a.element.getBoundingClientRect().top-s.offsetHeight+"px",window.innerWidth<=520&&(s.style.left=t.element.offsetLeft+"px"))},target:".e-text-fontt-color",iconCss:"e-dropdownbtn-preview",cssClass:"e-ie-ddb-popup"},"#"+r+"_strokeTextColorBtn");o.inline=!0,o.value=o.getValue(o.value,"rgba"),t.element.querySelector(".e-stroke-text-font-color.e-template .e-dropdownbtn-preview").style.background="#fff"}},d.prototype.createTextBtn=function(e){var i=this,t=this.parent,r=t.element.id;if(e.indexOf("fontFamily")>-1){var o=document.getElementById(r+"_fontFamilyBtn"),a=document.createElement("span");w.isDevice?(a.innerHTML="ABC",a.setAttribute("style","font-family: "+t.fontFamily.default.toLowerCase()+"'")):a.innerHTML=t.fontFamily.default,a.className="e-text-font-family",o&&o.appendChild(a);var n=new q({items:this.getFontFamilyItems(),cssClass:"e-font-family",createPopupOnClick:!0,beforeItemRender:function(u){u.element.setAttribute("style","font-family:"+u.element.id)},open:function(u){w.isDevice&&(u.element.parentElement.style.top=n.element.getBoundingClientRect().top-u.element.parentElement.offsetHeight+"px");var c;t.textArea.style.display==="block"||t.textArea.style.display==="inline-block"?c=t.textArea.style.fontFamily:c=t.activeObj.textSettings.fontFamily;var g=u.element.querySelector('[id *= "'+c.toLowerCase()+'"]');g&&g.classList.add("e-selected-btn")},select:function(u){i.triggerTbarClickEvent(u),a.textContent=u.item.text,w.isDevice&&a.setAttribute("style","font-family:"+u.item.id),t.updateFontFamily(u.item.id),t.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1});var c=document.getElementById(t.element.id+"_toolbar");c&&c.classList.contains("e-control")&&F(c,"toolbar").refreshOverflow()}});n.appendTo("#"+r+"_fontFamilyBtn")}if(e.indexOf("fontSize")>-1){var s=document.getElementById(r+"_fontSizeBtn"),l=document.createElement("span"),p=t.getFontSizes();l.innerHTML=p[0].text,l.className="e-text-font-size",s.appendChild(l);var h=new q({cssClass:"e-font-size",items:p,open:function(u){w.isDevice&&(u.element.parentElement.style.top=h.element.getBoundingClientRect().top-u.element.parentElement.offsetHeight+"px");var c=l.innerHTML;u.element.querySelector('[aria-label *= "'+c+'"]').classList.add("e-selected-btn")},select:function(u){i.triggerTbarClickEvent(u),l.textContent=u.item.text,t.updateFontSize(u.item.text),t.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1})}});h.appendTo("#"+r+"_fontSizeBtn")}},d.prototype.refreshToolbar=function(e,i,t,r,o,a,n){var s=this.parent,l=s.element.id;if(!(!s.isImageLoaded||s.isCropToolbar)){var p={},h,u;if(e!=="filter"&&e!=="color"){var c=document.getElementById(l+"_toolbar"),g=document.getElementById(l+"_customizeWrapper"),v=document.getElementById(l+"_bottomToolbar");if(g&&F(g,"toolbar")&&this.defToolbarItems.length>0&&(F(g,"toolbar").destroy(),g.innerHTML=""),c&&c.classList.contains("e-control")&&this.defToolbarItems.length>0&&(F(c,"toolbar").destroy(),c.innerHTML=""),c&&(this.defToolbarItems.length>0||s.toolbar&&s.toolbar.length>0&&s.toolbar.indexOf("Open")===-1)){var b=F(c,"toolbar");C(b)||(b.destroy(),document.getElementById(s.element.id+"_toolbar").innerHTML="")}v&&this.defToolbarItems.length>0&&v.className.indexOf("e-control")>-1&&(F(v,"toolbar").destroy(),v.innerHTML="")}switch(this.refreshSlider(),document.querySelector(".e-slider-tooltip")&&document.querySelector(".e-slider-tooltip").remove(),this.isFrameToolbar=s.isCropTab=!1,e){case"main":w.isDevice?t?this.initMainToolbar(!1,!0,!0,!1,!1,!0):this.initMainToolbar(!1,!0,null,!1,!1,!0):(!w.isDevice||r)&&(r?this.initMainToolbar(i,w.isDevice,null):this.initMainToolbar(i,w.isDevice,null)),w.isDevice&&this.initBottomToolbar();break;case"shapes":if(s.isPublicMethod||(s.noPushUndo=!0),w.isDevice&&this.initMainToolbar(!1,!0,!0),s.activeObj.shape==="line"||s.activeObj.shape==="path"?p.toolbarItems=["strokeColor","strokeWidth","z-order","duplicate","remove"]:s.activeObj.shape==="arrow"?p.toolbarItems=["strokeColor","strokeWidth","start","end","z-order","duplicate","remove"]:s.activeObj.shape==="image"?p.toolbarItems=["flip","z-order","duplicate","remove","transparency"]:s.activeObj.shape==="rectangle"?p.toolbarItems=["fillColor","strokeColor","strokeWidth","borderRadius","z-order","duplicate","remove"]:p.toolbarItems=["fillColor","strokeColor","strokeWidth","z-order","duplicate","remove"],this.initShapesToolbarItem(p.toolbarItems),s.activeObj.shape==="image"){var m=f({},s.activeObj,{},!0);s.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),s.notify("draw",{prop:"render-image",value:{isMouseWheel:null,isPreventClearRect:null,isFrame:!0}}),s.activeObj=m,s.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:s.activeObj,isCropRatio:null,points:null,isPreventDrag:!0}}),this.renderQAT(!1)}break;case"text":w.isDevice&&this.initMainToolbar(!1,!0,!0),p.toolbarItems=["fontFamily","fontSize","fontColor","fillColor","strokeColor","strokeWidth","bold","italic","z-order","duplicate","remove","text"],this.initTextToolbarItem(p.toolbarItems);break;case"pen":w.isDevice&&this.initMainToolbar(!1,!0,!0),p.toolbarItems=["strokeColor","strokeWidth","z-order","remove","transparency"],this.initPenToolbarItem(p.toolbarItems);break;case"adjustment":w.isDevice&&this.initMainToolbar(!1,!0,!0),this.initAdjustmentToolbarItem();break;case"filter":this.updateContextualToolbar(e);break;case"resize":(s.isCircleCrop||s.currSelectionPoint&&s.currSelectionPoint.shape==="crop-circle")&&(s.aspectHeight=s.aspectWidth,this.isAspectRatio=!1),this.initResizeToolbar(),w.isDevice&&this.initMainToolbar(!1,!0,!0,!0),h=s.element.querySelector("#"+l+"_aspectratio"),u=s.element.querySelector("#"+l+"_nonaspectratio"),s.aspectWidth&&s.aspectHeight&&(u?s.notify("transform",{prop:"resize",value:{width:s.aspectWidth,height:s.aspectHeight,isAspectRatio:!1}}):h&&s.notify("transform",{prop:"resize",value:{width:s.aspectWidth,height:null,isAspectRatio:!0}}));break;case"color":this.updateContextualToolbar(e,o);break;case"croptransform":C(n)&&(s.allowDownScale=!1,s.isCropTab=!0),w.isDevice&&this.initMainToolbar(!1,!0,!0),C(n)&&s.updateCropTransformItems(),this.initCropTransformToolbar(a,n),w.isDevice&&this.isToolbar()&&this.updateContextualToolbar("color","straighten",!0),s.isMaskImage&&this.refreshToolbar("main");break;case"frame":this.isFrameToolbar=!0,w.isDevice?(this.initMainToolbar(!1,!0,!0),this.initMainToolbar(!1,!0,!0,!1,!0)):this.initMainToolbar(!0,null,null,!1,!0);var y=s.element.querySelector("#"+l+"_"+s.frameObj.type);y&&y.classList.add("e-selected-btn"),s.frameObj.type!=="none"&&this.updateContextualToolbar(e,o),s.notify("draw",{prop:"render-image",value:{isMouseWheel:null,isPreventClearRect:null,isFrame:!0}});break;case"redact":if(w.isDevice?(this.initMainToolbar(!1,!0,!0),this.initMainToolbar(!1,!0,!0,null,null,null,!0)):this.initMainToolbar(i,w.isDevice,null,null,null,null,!0),this.enableDisableTbrBtn(),s.activeObj.redactType==="blur"){var P=s.element.querySelector("#"+l+"_redactBlur");P&&P.classList.add("e-selected-btn")}else{var S=s.element.querySelector("#"+l+"_pixelate");S&&S.classList.add("e-selected-btn")}this.redactSlider(s.activeObj.redactType);break}this.refreshDropDownBtn(t),this.updateKBDNavigation(e),this.currToolbar=e}},d.prototype.updateRedactObj=function(){var e=this.parent,i=f([],e.objColl,[],!0);e.objColl=[];var t=f({},e.activeObj,{},!0);e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),e.notify("draw",{prop:"render-image",value:{isMouseWheel:null,isPreventClearRect:null,isFrame:!0}}),e.objColl=i;for(var r=0;r<e.objColl.length;r++){var o=e.objColl[r];o.shape==="redact"&&(o.redactImage=e.createElement("canvas"),o.redactImage.width=o.activePoint.width,o.redactImage.height=o.activePoint.height,o.redactImage.getContext("2d").drawImage(e.lowerCanvas,o.activePoint.startX,o.activePoint.startY,o.activePoint.width,o.activePoint.height,0,0,o.redactImage.width,o.redactImage.height))}e.isCropTab=!1,e.notify("draw",{prop:"render-image",value:{isMouseWheel:null,isPreventClearRect:null,isFrame:!0}}),e.isCropTab=!0,t&&e.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:t,isCropRatio:null,points:null,isPreventDrag:!0}});var a={panMove:null};e.notify("transform",{prop:"getPanMove",onPropertyChange:!1,value:{obj:a}}),a.panMove&&e.notify("transform",{prop:"drawPannedImage",onPropertyChange:!1,value:{xDiff:null,yDiff:null}})},d.prototype.updateKBDNavigation=function(e){var i=this.parent,t=i.element.id;if(!(!i.isKBDNavigation||this.currToolbar===e)&&this.isToolbar()){var r=i.element.querySelectorAll("#"+t+"_toolbar")[0],o=void 0,a;if(r){if(o=r.querySelector(".e-toolbar-center"),!o||!o.children[0])return;a=o.children[0].querySelector(".e-btn");var n=o.children[1];if(n&&(n=n.children[0]),n&&(n=n.children[0]),e==="resize"&&n&&(a=n),e==="filter"){var s=document.querySelector("#"+t+"_defaultCanvas");s&&setTimeout(function(){return s.focus()},50)}a&&(e==="main"?setTimeout(function(){return a.focus()},50):a.focus())}}},d.prototype.performCropTransformClick=function(e,i){var t=this.parent;C(i)&&(t.notify("draw",{prop:"setTempStraightenZoomDeg"}),t.tempStraighten=t.transform.straighten,(t.currObjType.isFiltered||t.currObjType.isRedact)&&t.okBtn(),t.isStraightening=!0),this.refreshToolbar("croptransform",null,null,null,null,e,i),C(i)&&(t.notify("draw",{prop:"setDestForStraighten"}),t.notify("draw",{prop:"setTempDestForStraighten"}))},d.prototype.getAdjustmentToolbarItem=function(){var e=[],i=this.parent,t=!1,r=i.element.id,o=["Brightness","Contrast","Hue","Saturation","Exposure","Opacity","Blur"];if(i.toolbar){for(var a=0;a<o.length;a++)if(i.toolbar.indexOf(o[a])!==-1){t=!0;break}}(C(i.toolbar)||!t||i.toolbar&&i.toolbar.indexOf("Brightness")>-1)&&e.push({id:r+"_brightness",prefixIcon:"e-icons e-brightness",cssClass:"top-icon e-brightness",tooltipText:this.l10n.getConstant("Brightness"),align:"Center"}),(C(i.toolbar)||!t||i.toolbar&&i.toolbar.indexOf("Contrast")>-1)&&e.push({id:r+"_contrast",prefixIcon:"e-icons e-contrast",cssClass:"top-icon e-contrast",tooltipText:this.l10n.getConstant("Contrast"),align:"Center"}),(C(i.toolbar)||!t||i.toolbar&&i.toolbar.indexOf("Hue")>-1)&&e.push({id:r+"_hue",prefixIcon:"e-icons e-fade",cssClass:"top-icon e-fade",tooltipText:this.l10n.getConstant("Hue"),align:"Center"}),(C(i.toolbar)||!t||i.toolbar&&i.toolbar.indexOf("Saturation")>-1)&&e.push({id:r+"_saturation",prefixIcon:"e-icons e-saturation",cssClass:"top-icon e-saturation",tooltipText:this.l10n.getConstant("Saturation"),align:"Center"}),(C(i.toolbar)||!t||i.toolbar&&i.toolbar.indexOf("Exposure")>-1)&&e.push({id:r+"_exposure",prefixIcon:"e-icons e-grain",cssClass:"top-icon e-grain",tooltipText:this.l10n.getConstant("Exposure"),align:"Center"}),(C(i.toolbar)||!t||i.toolbar&&i.toolbar.indexOf("Opacity")>-1)&&e.push({id:r+"_opacity",prefixIcon:"e-icons e-opacity",cssClass:"top-icon e-opacity",tooltipText:this.l10n.getConstant("Opacity"),align:"Center"}),(C(i.toolbar)||!t||i.toolbar&&i.toolbar.indexOf("Blur")>-1)&&e.push({id:r+"_blur",prefixIcon:"e-icons e-tint",cssClass:"top-icon e-tint",tooltipText:this.l10n.getConstant("Blur"),align:"Center"});for(var n=this.processToolbar("center"),a=0,s=n.length;a<s;a++)e.push(n[a]);return w.isDevice||(e.push({id:r+"_ok",prefixIcon:"e-icons e-check",cssClass:"top-icon e-tick",tooltipText:this.l10n.getConstant("OK"),align:"Right",tabIndex:0}),e.push({id:r+"_cancel",prefixIcon:"e-icons e-close",cssClass:"top-icon e-save",tooltipText:this.l10n.getConstant("Cancel"),align:"Right"})),e},d.prototype.getFrameToolbarItem=function(){var e=this.parent,i=e.element.id,t=[];return t.push({prefixIcon:"e-icons e-copy",id:i+"_frameColor",cssClass:"top-icon e-stroke",tooltipText:this.l10n.getConstant("Color"),align:"Center",type:"Input",template:"<span>"+this.l10n.getConstant("Color")+'</span><button id="'+i+'_frameColorBtn"></button>'}),t.push({prefixIcon:"e-icons e-copy",id:i+"_frameGradient",cssClass:"top-icon e-frame-stroke",tooltipText:this.l10n.getConstant("GradientColor"),align:"Center",type:"Input",template:"<span>"+this.l10n.getConstant("GradientColor")+'</span><button id="'+i+'_frameGradientColorBtn"></button>'}),t.push({id:i+"_frameSize",cssClass:"top-icon e-size",tooltipText:this.l10n.getConstant("Size"),align:"Center",type:"Input",template:"<span>"+this.l10n.getConstant("Size")+'</span><button id="'+i+'_frameSizeBtn"></button>'}),(e.frameObj.type==="line"||e.frameObj.type==="inset"||e.frameObj.type==="hook")&&t.push({id:i+"_frameInset",cssClass:"top-icon e-size",tooltipText:this.l10n.getConstant("Inset"),align:"Center",type:"Input",template:"<span>"+this.l10n.getConstant("Inset")+'</span><button id="'+i+'_frameInsetBtn"></button>'}),(e.frameObj.type==="line"||e.frameObj.type==="inset")&&t.push({id:i+"_frameOffset",cssClass:"top-icon e-size",tooltipText:this.l10n.getConstant("Offset"),align:"Center",type:"Input",template:"<span>"+this.l10n.getConstant("Offset")+'</span><button id="'+i+'_frameOffsetBtn"></button>'}),e.frameObj.type==="line"&&(t.push({id:i+"_frameRadius",cssClass:"top-icon e-size",tooltipText:this.l10n.getConstant("Radius"),align:"Center",type:"Input",template:"<span>"+this.l10n.getConstant("Radius")+'</span><button id="'+i+'_frameRadiusBtn"></button>'}),t.push({id:i+"_frameAmount",cssClass:"top-icon e-size",tooltipText:this.l10n.getConstant("Amount"),align:"Center",type:"Input",template:"<span>"+this.l10n.getConstant("Amount")+'</span><button id="'+i+'_frameAmountBtn"></button>'}),t.push({id:i+"_frameBorder",cssClass:"top-icon e-size",tooltipText:this.l10n.getConstant("Border"),align:"Center",type:"Input",template:"<span>"+this.l10n.getConstant("Border")+'</span><button id="'+i+'_frameBorderBtn"></button>'})),t},d.prototype.getFilterToolbarItem=function(){var e=[],i=this.parent,t=!1,r=i.element.id,o=["Default","Chrome","Cold","Warm","Grayscale","Sepia","Invert"];if(i.toolbar){for(var a=0;a<o.length;a++)if(i.toolbar.indexOf(o[a])!==-1){t=!0;break}}(C(i.toolbar)||!t||i.toolbar&&i.toolbar.indexOf("Default")>-1)&&e.push({id:r+"_default",prefixIcon:"e-icons e-none",cssClass:"top-icon e-none",tooltipText:this.l10n.getConstant("Default"),align:"Center",template:'<div class="filter-wrapper"><canvas id='+r+"_defaultCanvas tabindex=0></canvas><div><span>"+this.l10n.getConstant("Default")+"</span></div></div>"}),(C(i.toolbar)||!t||i.toolbar&&i.toolbar.indexOf("Chrome")>-1)&&e.push({id:r+"_chrome",prefixIcon:"e-icons e-none",cssClass:"top-icon e-none",tooltipText:this.l10n.getConstant("Chrome"),align:"Center",template:'<div class="filter-wrapper"><canvas id='+r+"_chromeCanvas></canvas><div><span>"+this.l10n.getConstant("Chrome")+"</span></div></div>"}),(C(i.toolbar)||!t||i.toolbar&&i.toolbar.indexOf("Cold")>-1)&&e.push({id:r+"_cold",prefixIcon:"e-icons e-none",cssClass:"top-icon e-none",tooltipText:this.l10n.getConstant("Cold"),align:"Center",template:'<div class="filter-wrapper"><canvas id='+r+"_coldCanvas></canvas><div><span>"+this.l10n.getConstant("Cold")+"</span></div></div>"}),(C(i.toolbar)||!t||i.toolbar&&i.toolbar.indexOf("Warm")>-1)&&e.push({id:r+"_warm",prefixIcon:"e-icons e-none",cssClass:"top-icon e-none",tooltipText:this.l10n.getConstant("Warm"),align:"Center",template:'<div class="filter-wrapper"><canvas id='+r+"_warmCanvas></canvas><div><span>"+this.l10n.getConstant("Warm")+"</span></div></div>"}),(C(i.toolbar)||!t||i.toolbar&&i.toolbar.indexOf("Grayscale")>-1)&&e.push({id:r+"_grayscale",prefixIcon:"e-icons e-none",cssClass:"top-icon e-none",tooltipText:this.l10n.getConstant("Grayscale"),align:"Center",template:'<div class="filter-wrapper"><canvas id='+r+"_grayscaleCanvas></canvas><div><span>"+this.l10n.getConstant("Grayscale")+"</span></div></div>"}),(C(i.toolbar)||!t||i.toolbar&&i.toolbar.indexOf("Sepia")>-1)&&e.push({id:r+"_sepia",prefixIcon:"e-icons e-none",cssClass:"top-icon e-none",tooltipText:this.l10n.getConstant("Sepia"),align:"Center",template:'<div class="filter-wrapper"><canvas id='+r+"_sepiaCanvas></canvas><div><span>"+this.l10n.getConstant("Sepia")+"</span></div></div>"}),(C(i.toolbar)||!t||i.toolbar&&i.toolbar.indexOf("Invert")>-1)&&e.push({id:r+"_invert",prefixIcon:"e-icons e-none",cssClass:"top-icon e-none",tooltipText:this.l10n.getConstant("Invert"),align:"Center",template:'<div class="filter-wrapper"><canvas id='+r+"_invertCanvas></canvas><div><span>"+this.l10n.getConstant("Invert")+"</span></div></div>"});for(var n=this.processToolbar("center"),a=0,s=n.length;a<s;a++)e.push(n[a]);return e},d.prototype.getPenToolbarItem=function(e){var i=this.parent,t=i.element.id,r=[];(C(i.toolbar)||i.toolbar)&&r.push({id:t+"_annotation",tooltipText:this.l10n.getConstant("Annotation"),align:"Center",template:'<button id="'+t+'_annotationBtn"></button>'}),e.indexOf("strokeColor")>-1&&r.push({prefixIcon:"e-icons e-copy",id:t+"_pen_strokecolor",cssClass:"top-icon e-pen-stroke-color",tooltipText:this.l10n.getConstant("StrokeColor"),align:"Center",type:"Input",template:'<button id="'+t+'_penColorBtn"></button>'}),e.indexOf("strokeWidth")>-1&&r.push({prefixIcon:"e-icons e-copy",id:t+"_pen_strokewidth",cssClass:"top-icon e-size",tooltipText:this.l10n.getConstant("StrokeWidth"),align:"Center",type:"Input",template:'<button id="'+t+'_penStrokeWidth"></button>'}),r.push({align:"Center",type:"Separator"}),e.indexOf("z-order")>-1&&r.push({id:t+"_zOrder",cssClass:"top-icon e-list-unordered-3",tooltipText:this.l10n.getConstant("ZOrder"),align:"Center",type:"Input",template:'<button id="'+t+'_zOrderBtn"></button>'}),e.indexOf("remove")>-1&&r.push({id:t+"_remove",prefixIcon:"e-icons e-trash",cssClass:"top-icon e-trash",tooltipText:this.l10n.getConstant("Remove"),align:"Center"});for(var o=this.processSubToolbar(e),a=0,n=o.length;a<n;a++)r.push(o[a]);return w.isDevice||(r.push({id:t+"_ok",prefixIcon:"e-icons e-check",cssClass:"top-icon e-tick",tooltipText:this.l10n.getConstant("OK"),align:"Right",tabIndex:0}),r.push({id:t+"_cancel",prefixIcon:"e-icons e-close",cssClass:"top-icon e-save",tooltipText:this.l10n.getConstant("Cancel"),align:"Right"})),r},d.prototype.initPenToolbarItem=function(e){var i=this,t=this.parent,r=t.element.id,o=this.getLeftToolbarItem(),a=this.getRightToolbarItem(),n=this.getPenToolbarItem(e),s=this.getZoomToolbarItem();w.isDevice?this.defToolbarItems=n:this.defToolbarItems=o.concat(s,n,a);var l={toolbarType:"pen",toolbarItems:this.defToolbarItems};t.trigger("toolbarUpdating",l),this.isToolbarString(l.toolbarItems)?(e=l.toolbarItems,this.excludeItems(l.toolbarItems)):this.defToolbarItems=l.toolbarItems;var p=new ie({width:"100%",items:this.defToolbarItems,clicked:this.defToolbarClicked.bind(this),created:function(){i.renderAnnotationBtn(!0),i.createPenColor(e),i.createPenBtn(e),i.createZOrderBtn(e),i.wireZoomBtnEvents(),t.trigger("toolbarCreated",{toolbarType:"pen"}),w.isDevice?i.defToolbarItems.length>0&&document.getElementById(r+"_toolbar")&&(p.refreshOverflow(),p.refreshOverflow()):(i.createLeftToolbarControls(),i.defToolbarItems.length>0&&document.getElementById(r+"_toolbar")&&p.refreshOverflow())}});w.isDevice?p.appendTo("#"+r+"_bottomToolbar"):p.appendTo("#"+r+"_toolbar"),this.enableDisableTbrBtn()},d.prototype.createPenColor=function(e){var i=this,t=this.parent,r=t.element.id;if(e.indexOf("strokeColor")>-1){t.element.querySelector(".e-template.e-pen-stroke-color").appendChild(t.createElement("input",{id:r+"_pen_stroke"}));var o=t.activeObj.strokeSettings.strokeColor,a=new ve({modeSwitcher:!1,value:"#fff",showButtons:!1,mode:"Palette",cssClass:"e-pen-color",change:function(p){t.updatePenStrokeColor(p.currentValue.hex),i.selFhdColor=p.currentValue.hex,n.element.children[0].style.backgroundColor=p.currentValue.rgba,n.toggle(),t.notify("undo-redo",{prop:"updateUndoRedoStack",value:{isPenDraw:!0}})}},"#"+r+"_pen_stroke"),n=new q({open:function(p){var h=p.element.parentElement;w.isDevice&&(h.style.top=n.element.getBoundingClientRect().top-h.offsetHeight+"px",window.innerWidth<=520&&(h.style.left=t.element.offsetLeft+"px"))},target:".e-pen-color",iconCss:"e-dropdownbtn-preview",cssClass:"e-ie-ddb-popup"},"#"+r+"_penColorBtn");a.inline=!0,a.value=a.getValue(t.activeObj.strokeSettings.strokeColor,"rgba"),a.value==="null"&&(a.value=o);var s={tempFreeHandDrawEditingStyles:null};t.notify("freehand-draw",{prop:"getTempFreeHandDrawEditingStyles",value:{obj:s}});var l={freehandSelectedIndex:null};t.notify("freehand-draw",{prop:"getFreehandSelectedIndex",onPropertyChange:!1,value:{obj:l}}),!C(l.freehandSelectedIndex)&&l.freehandSelectedIndex>-1?t.element.querySelector(".e-pen-stroke-color.e-template .e-dropdownbtn-preview").style.background=this.selFhdColor==="#42a5f5"?s.tempFreeHandDrawEditingStyles.strokeColor:t.pointColl[l.freehandSelectedIndex].strokeColor:t.element.querySelector(".e-pen-stroke-color.e-template .e-dropdownbtn-preview").style.background=a.value}},d.prototype.createPenBtn=function(e){var i=this,t=this.parent,r=t.element.id,o=[{id:"1",text:this.l10n.getConstant("XSmall")},{id:"2",text:this.l10n.getConstant("Small")},{id:"3",text:this.l10n.getConstant("Medium")},{id:"4",text:this.l10n.getConstant("Large")},{id:"5",text:this.l10n.getConstant("XLarge")}];if(e.indexOf("strokeWidth")>-1){var a=document.getElementById(r+"_penStrokeWidth"),n=document.createElement("span"),s={freehandSelectedIndex:null};if(t.notify("freehand-draw",{prop:"getFreehandSelectedIndex",onPropertyChange:!1,value:{obj:s}}),!C(s.freehandSelectedIndex)&&s.freehandSelectedIndex>-1)n.innerHTML=this.getPenStroke(t.pointColl[s.freehandSelectedIndex].strokeWidth);else{var l={penStrokeWidth:2};t.notify("freehand-draw",{prop:"getPenStrokeWidth",onPropertyChange:!1,value:{obj:l}}),l.penStrokeWidth?n.innerHTML=this.getPenStroke(l.penStrokeWidth):n.innerHTML=this.l10n.getConstant("Small")}n.className="e-pen-stroke-width",a.appendChild(n);var p=new q({items:o,open:function(h){w.isDevice&&(h.element.parentElement.style.top=p.element.getBoundingClientRect().top-h.element.parentElement.offsetHeight+"px");var u=n.innerHTML;h.element.querySelector('[aria-label = "'+u+'"]').classList.add("e-selected-btn")},select:function(h){if(i.triggerTbarClickEvent(h),n.textContent=h.item.text,t.updatePenStrokeWidth(h.item.id),w.isDevice){if(document.getElementById(r+"_bottomToolbar")){var u=F(r+"_bottomToolbar","toolbar");u.refreshOverflow()}}else if(document.getElementById(r+"_toolbar")){var c=F(r+"_toolbar","toolbar");c.refreshOverflow()}var g={penStrokeWidth:null};t.notify("freehand-draw",{prop:"getPenStrokeWidth",onPropertyChange:!1,value:{obj:g}}),t.notify("undo-redo",{prop:"updateUndoRedoStack",value:{isPenDraw:!0}}),t.notify("freehand-draw",{prop:"setPenStrokeWidth",onPropertyChange:!1,value:{value:g.penStrokeWidth}})}});p.appendTo("#"+r+"_penStrokeWidth")}},d.prototype.getPenStroke=function(e){var i="",t={1:this.l10n.getConstant("XSmall"),2:this.l10n.getConstant("Small"),3:this.l10n.getConstant("Medium"),4:this.l10n.getConstant("Large"),5:this.l10n.getConstant("XLarge")};return e>=1&&e<=5&&(i=t[e]),i},d.prototype.initAdjustmentToolbarItem=function(){var e=this,i=this.parent,t=i.element.id,r=this.getLeftToolbarItem(null),o=this.getRightToolbarItem(),a=this.getAdjustmentToolbarItem(),n=this.getZoomToolbarItem();w.isDevice?this.defToolbarItems=a:this.defToolbarItems=r.concat(n,a,o);var s={toolbarType:"finetune",toolbarItems:this.defToolbarItems};i.trigger("toolbarUpdating",s),this.defToolbarItems=s.toolbarItems;var l=new ie({width:"100%",items:this.defToolbarItems,clicked:this.defToolbarClicked.bind(this),created:function(){e.wireZoomBtnEvents(),w.isDevice||e.createLeftToolbarControls(),e.defToolbarItems.length>0&&document.getElementById(t+"_toolbar")&&l.refreshOverflow()}});w.isDevice?l.appendTo("#"+t+"_bottomToolbar"):l.appendTo("#"+t+"_toolbar"),this.enableDisableTbrBtn()},d.prototype.initFrameToolbarItem=function(){var e=this,i=this.parent,t=i.element.id,r=document.querySelector("#"+t+"_contextualToolbarArea"),o=document.querySelector("#"+t+"_frameWrapper");o?o.style.display="block":o=r.appendChild(i.createElement("div",{id:t+"_frameWrapper",className:"e-frame-wrapper",styles:"position: relative"})),o.appendChild(i.createElement("div",{id:t+"_customizeWrapper",styles:"position: absolute"}));var a=this.getFrameToolbarItem(),n={toolbarType:"frame",toolbarItems:a};i.trigger("toolbarUpdating",n),a=n.toolbarItems;var s=new ie({width:"100%",items:a,clicked:this.defToolbarClicked.bind(this),created:function(){e.createFrameColor(),e.createFrameSize();var l=i.frameObj.type;l==="line"&&e.createFrameRadius(),(l==="line"||l==="inset"||l==="hook")&&e.createFrameInset(),(l==="line"||l==="inset")&&e.createFrameOffset(),l==="line"&&(e.createFrameAmount(),e.createFrameBorder()),e.createFrameGradientColor(),w.isDevice?e.defToolbarItems.length>0&&document.getElementById(t+"_bottomToolbar")&&(s.refreshOverflow(),s.refreshOverflow(),s.refreshOverflow()):(e.createLeftToolbarControls(),e.defToolbarItems.length>0&&document.getElementById(t+"_toolbar")&&s.refreshOverflow()),i.element.querySelector("#"+t+"_"+l).focus()}});s.appendTo("#"+t+"_customizeWrapper")},d.prototype.createFrameGradientColor=function(){var e=this.parent,i,t={frameChangeEventArgs:null},r=e.element.id;e.element.querySelector(".e-template.e-frame-stroke").appendChild(e.createElement("input",{id:r+"_frame_gradient_fill"}));var o=new ve({modeSwitcher:!1,noColor:!0,value:e.frameObj.gradientColor,showButtons:!1,mode:"Palette",cssClass:"e-frame-gradient-fill-color",change:function(n){i={type:e.toPascalCase(e.frameObj.type),color:e.frameObj.color,gradientColor:e.frameObj.gradientColor,size:e.frameObj.size,inset:e.frameObj.inset,offset:e.frameObj.offset,borderRadius:e.frameObj.radius,frameLineStyle:e.toPascalCase(e.frameObj.border),lineCount:e.frameObj.amount};var s=e.frameObj.gradientColor,l={currObj:{}};e.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:l}}),e.frameObj.gradientColor=n.currentValue.hex,e.notify("draw",{prop:"triggerFrameChange",value:{prevFrameSettings:i,obj:t}}),t.frameChangeEventArgs&&!t.frameChangeEventArgs.cancel?(e.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"frame",previousObj:l.currObj,previousObjColl:l.currObj.objColl,previousPointColl:l.currObj.pointColl,previousSelPointColl:l.currObj.selPointColl,previousCropObj:f({},e.cropObj,{},!0),previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),e.notify("draw",{prop:"render-image",value:{isMouseWheel:null,isPreventClearRect:null,isFrame:!0}}),e.notify("draw",{prop:"redrawDownScale"}),n.currentValue.rgba===""?a.element.children[0].classList.add("e-nocolor-item"):(a.element.children[0].classList.remove("e-nocolor-item"),a.element.children[0].style.backgroundColor=n.currentValue.rgba),e.curFrameObjEvent={previousFrameSetting:t.frameChangeEventArgs.previousFrameSetting,currentFrameSetting:t.frameChangeEventArgs.currentFrameSetting},e.isFrameBtnClick=!0):e.frameObj.gradientColor=s,a.toggle()}},"#"+r+"_frame_gradient_fill"),a=new q({open:function(n){if(w.isDevice){var s=n.element.parentElement;s.style.top=a.element.getBoundingClientRect().top-s.offsetHeight+"px",window.innerWidth<=520&&(s.style.left=e.element.offsetLeft+"px")}},target:".e-frame-gradient-fill-color",iconCss:"e-dropdownbtn-preview",cssClass:"e-ie-ddb-popup"},"#"+r+"_frameGradientColorBtn");o.inline=!0,e.frameObj.gradientColor===""?e.element.querySelector(".e-frame-stroke.e-template .e-dropdownbtn-preview").classList.add("e-nocolor-item"):e.element.querySelector(".e-frame-stroke.e-template .e-dropdownbtn-preview").style.background=e.frameObj.gradientColor},d.prototype.createFrameColor=function(){var e=this.parent,i,t={frameChangeEventArgs:null},r=e.element.id;e.element.querySelector(".e-template.e-stroke").appendChild(e.createElement("input",{id:r+"_frame_fill"}));var o=new ve({modeSwitcher:!1,value:e.frameObj.color,showButtons:!1,mode:"Palette",cssClass:"e-frame-fill-color",change:function(n){i={type:e.toPascalCase(e.frameObj.type),color:e.frameObj.color,gradientColor:e.frameObj.gradientColor,size:e.frameObj.size,inset:e.frameObj.inset,offset:e.frameObj.offset,borderRadius:e.frameObj.radius,frameLineStyle:e.toPascalCase(e.frameObj.border),lineCount:e.frameObj.amount};var s=e.frameObj.color,l={currObj:{}};e.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:l}}),e.frameObj.color=n.currentValue.hex,e.notify("draw",{prop:"triggerFrameChange",value:{prevFrameSettings:i,obj:t}}),t.frameChangeEventArgs&&!t.frameChangeEventArgs.cancel?(e.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"frame",previousObj:l.currObj,previousObjColl:l.currObj.objColl,previousPointColl:l.currObj.pointColl,previousSelPointColl:l.currObj.selPointColl,previousCropObj:f({},e.cropObj,{},!0),previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),e.notify("draw",{prop:"render-image",value:{isMouseWheel:null,isPreventClearRect:null,isFrame:!0}}),e.notify("draw",{prop:"redrawDownScale"}),n.currentValue.rgba===""?a.element.children[0].classList.add("e-nocolor-item"):(a.element.children[0].classList.remove("e-nocolor-item"),a.element.children[0].style.backgroundColor=n.currentValue.rgba),e.curFrameObjEvent={previousFrameSetting:t.frameChangeEventArgs.previousFrameSetting,currentFrameSetting:t.frameChangeEventArgs.currentFrameSetting},e.isFrameBtnClick=!0):e.frameObj.color=s,a.toggle()}},"#"+r+"_frame_fill"),a=new q({open:function(n){if(w.isDevice){var s=n.element.parentElement;s.style.top=a.element.getBoundingClientRect().top-s.offsetHeight+"px",window.innerWidth<=520&&(s.style.left=e.element.offsetLeft+"px")}},target:".e-frame-fill-color",iconCss:"e-dropdownbtn-preview",cssClass:"e-ie-ddb-popup"},"#"+r+"_frameColorBtn");o.inline=!0,e.element.querySelector(".e-stroke.e-template .e-dropdownbtn-preview").style.background=e.frameObj.color},d.prototype.createFrameSize=function(){var e=this,i=this.parent,t,r={frameChangeEventArgs:null},o=i.element.id,a=[{id:"1",text:this.l10n.getConstant("20")},{id:"2",text:this.l10n.getConstant("40")},{id:"3",text:this.l10n.getConstant("60")},{id:"4",text:this.l10n.getConstant("80")},{id:"5",text:this.l10n.getConstant("100")}],n=document.getElementById(o+"_frameSizeBtn"),s=document.createElement("span");s.innerHTML=this.l10n.getConstant(i.frameObj.size.toString()),s.className="e-frame-stroke-width",n.appendChild(s);var l=new q({items:a,open:function(p){if(w.isDevice){var h=p.element.parentElement;h.style.top=l.element.getBoundingClientRect().top-h.offsetHeight+"px"}var u=l.element.childNodes[0].textContent;u!==""&&p.element.querySelector('[aria-label = "'+u+'"]').classList.add("e-selected-btn")},select:function(p){e.triggerTbarClickEvent(p),t={type:i.toPascalCase(i.frameObj.type),color:i.frameObj.color,gradientColor:i.frameObj.gradientColor,size:i.frameObj.size,inset:i.frameObj.inset,offset:i.frameObj.offset,borderRadius:i.frameObj.radius,frameLineStyle:i.toPascalCase(i.frameObj.border),lineCount:i.frameObj.amount};var h=i.frameObj.size,u={currObj:{}};if(i.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:u}}),i.frameObj.size=parseInt(p.item.text,10),i.notify("draw",{prop:"triggerFrameChange",value:{prevFrameSettings:t,obj:r}}),r.frameChangeEventArgs&&!r.frameChangeEventArgs.cancel?(i.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"frame",previousObj:u.currObj,previousObjColl:u.currObj.objColl,previousPointColl:u.currObj.pointColl,previousSelPointColl:u.currObj.selPointColl,previousCropObj:f({},i.cropObj,{},!0),previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),i.notify("draw",{prop:"render-image",value:{isMouseWheel:null,isPreventClearRect:null,isFrame:!0}}),i.notify("draw",{prop:"redrawDownScale"}),l.content=p.item.text,i.curFrameObjEvent={previousFrameSetting:r.frameChangeEventArgs.previousFrameSetting,currentFrameSetting:r.frameChangeEventArgs.currentFrameSetting},i.isFrameBtnClick=!0):i.frameObj.size=h,w.isDevice){if(document.getElementById(o+"_bottomToolbar")){var c=F(o+"_bottomToolbar","toolbar");c.refreshOverflow()}}else if(document.getElementById(o+"_toolbar")){var g=F(o+"_toolbar","toolbar");g.refreshOverflow()}}});l.appendTo("#"+o+"_frameSizeBtn")},d.prototype.createFrameInset=function(){var e=this,i=this.parent,t,r={frameChangeEventArgs:null},o=i.element.id,a=[{id:"1",text:this.l10n.getConstant("20")},{id:"2",text:this.l10n.getConstant("40")},{id:"3",text:this.l10n.getConstant("60")},{id:"4",text:this.l10n.getConstant("80")},{id:"5",text:this.l10n.getConstant("100")}],n=document.getElementById(o+"_frameInsetBtn"),s=document.createElement("span");s.innerHTML=this.l10n.getConstant(i.frameObj.inset.toString()),s.className="e-frame-inset",n.appendChild(s);var l=new q({items:a,open:function(p){if(w.isDevice){var h=p.element.parentElement;h.style.top=l.element.getBoundingClientRect().top-h.offsetHeight+"px"}var u=l.element.childNodes[0].textContent;u!==""&&p.element.querySelector('[aria-label = "'+u+'"]').classList.add("e-selected-btn")},select:function(p){e.triggerTbarClickEvent(p),t={type:i.toPascalCase(i.frameObj.type),color:i.frameObj.color,gradientColor:i.frameObj.gradientColor,size:i.frameObj.size,inset:i.frameObj.inset,offset:i.frameObj.offset,borderRadius:i.frameObj.radius,frameLineStyle:i.toPascalCase(i.frameObj.border),lineCount:i.frameObj.amount};var h=i.frameObj.inset,u={currObj:{}};if(i.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:u}}),i.frameObj.inset=parseInt(p.item.text,10),i.notify("draw",{prop:"triggerFrameChange",value:{prevFrameSettings:t,obj:r}}),r.frameChangeEventArgs&&!r.frameChangeEventArgs.cancel?(i.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"frame",previousObj:u.currObj,previousObjColl:u.currObj.objColl,previousPointColl:u.currObj.pointColl,previousSelPointColl:u.currObj.selPointColl,previousCropObj:f({},i.cropObj,{},!0),previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),i.notify("draw",{prop:"render-image",value:{isMouseWheel:null,isPreventClearRect:null,isFrame:!0}}),i.notify("draw",{prop:"redrawDownScale"}),l.content=p.item.text,i.curFrameObjEvent={previousFrameSetting:r.frameChangeEventArgs.previousFrameSetting,currentFrameSetting:r.frameChangeEventArgs.currentFrameSetting},i.isFrameBtnClick=!0):i.frameObj.inset=h,w.isDevice){if(document.getElementById(o+"_bottomToolbar")){var c=F(o+"_bottomToolbar","toolbar");c.refreshOverflow()}}else if(document.getElementById(o+"_toolbar")){var g=F(o+"_toolbar","toolbar");g.refreshOverflow()}}});l.appendTo("#"+o+"_frameInsetBtn")},d.prototype.createFrameOffset=function(){var e=this,i=this.parent,t,r={frameChangeEventArgs:null},o=i.element.id,a=[{id:"1",text:this.l10n.getConstant("20")},{id:"2",text:this.l10n.getConstant("40")},{id:"3",text:this.l10n.getConstant("60")},{id:"4",text:this.l10n.getConstant("80")},{id:"5",text:this.l10n.getConstant("100")}],n=document.getElementById(o+"_frameOffsetBtn"),s=document.createElement("span");s.innerHTML=this.l10n.getConstant(i.frameObj.offset.toString()),s.className="e-frame-offset",n.appendChild(s);var l=new q({items:a,open:function(p){if(w.isDevice){var h=p.element.parentElement;h.style.top=l.element.getBoundingClientRect().top-h.offsetHeight+"px"}var u=l.element.childNodes[0].textContent;u!==""&&p.element.querySelector('[aria-label = "'+u+'"]').classList.add("e-selected-btn")},select:function(p){e.triggerTbarClickEvent(p),t={type:i.toPascalCase(i.frameObj.type),color:i.frameObj.color,gradientColor:i.frameObj.gradientColor,size:i.frameObj.size,inset:i.frameObj.inset,offset:i.frameObj.offset,borderRadius:i.frameObj.radius,lineCount:i.frameObj.amount,frameLineStyle:i.toPascalCase(i.frameObj.border)};var h=i.frameObj.offset,u={currObj:{}};if(i.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:u}}),i.frameObj.offset=parseInt(p.item.text,10),i.notify("draw",{prop:"triggerFrameChange",value:{prevFrameSettings:t,obj:r}}),r.frameChangeEventArgs&&!r.frameChangeEventArgs.cancel?(i.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"frame",previousObj:u.currObj,previousObjColl:u.currObj.objColl,previousPointColl:u.currObj.pointColl,previousSelPointColl:u.currObj.selPointColl,previousCropObj:f({},i.cropObj,{},!0),previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),i.notify("draw",{prop:"render-image",value:{isMouseWheel:null,isPreventClearRect:null,isFrame:!0}}),i.notify("draw",{prop:"redrawDownScale"}),l.content=p.item.text,i.curFrameObjEvent={previousFrameSetting:r.frameChangeEventArgs.previousFrameSetting,currentFrameSetting:r.frameChangeEventArgs.currentFrameSetting},i.isFrameBtnClick=!0):i.frameObj.offset=h,w.isDevice){if(document.getElementById(o+"_bottomToolbar")){var c=F(o+"_bottomToolbar","toolbar");c.refreshOverflow()}}else if(document.getElementById(o+"_toolbar")){var g=F(o+"_toolbar","toolbar");g.refreshOverflow()}}});l.appendTo("#"+o+"_frameOffsetBtn")},d.prototype.createFrameRadius=function(){var e=this,i=this.parent,t,r={frameChangeEventArgs:null},o=i.element.id,a=[{id:"1",text:this.l10n.getConstant("0")},{id:"2",text:this.l10n.getConstant("20")},{id:"3",text:this.l10n.getConstant("40")},{id:"4",text:this.l10n.getConstant("60")},{id:"5",text:this.l10n.getConstant("80")},{id:"6",text:this.l10n.getConstant("100")}],n=document.getElementById(o+"_frameRadiusBtn"),s=document.createElement("span");s.innerHTML=this.l10n.getConstant(i.frameObj.radius.toString()),s.className="e-frame-radius",n.appendChild(s);var l=new q({items:a,open:function(p){if(w.isDevice){var h=p.element.parentElement;h.style.top=l.element.getBoundingClientRect().top-h.offsetHeight+"px"}var u=l.element.childNodes[0].textContent;u!==""&&p.element.querySelector('[aria-label = "'+u+'"]').classList.add("e-selected-btn")},select:function(p){e.triggerTbarClickEvent(p),t={type:i.toPascalCase(i.frameObj.type),color:i.frameObj.color,gradientColor:i.frameObj.gradientColor,size:i.frameObj.size,inset:i.frameObj.inset,offset:i.frameObj.offset,borderRadius:i.frameObj.radius,frameLineStyle:i.toPascalCase(i.frameObj.border),lineCount:i.frameObj.amount};var h=i.frameObj.radius,u={currObj:{}};if(i.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:u}}),i.frameObj.radius=parseInt(p.item.text,10),i.notify("draw",{prop:"triggerFrameChange",value:{prevFrameSettings:t,obj:r}}),r.frameChangeEventArgs&&!r.frameChangeEventArgs.cancel?(i.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"frame",previousObj:u.currObj,previousObjColl:u.currObj.objColl,previousPointColl:u.currObj.pointColl,previousSelPointColl:u.currObj.selPointColl,previousCropObj:f({},i.cropObj,{},!0),previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),i.notify("draw",{prop:"render-image",value:{isMouseWheel:null,isPreventClearRect:null,isFrame:!0}}),i.notify("draw",{prop:"redrawDownScale"}),l.content=p.item.text,i.curFrameObjEvent={previousFrameSetting:r.frameChangeEventArgs.previousFrameSetting,currentFrameSetting:r.frameChangeEventArgs.currentFrameSetting},i.isFrameBtnClick=!0):i.frameObj.radius=h,w.isDevice){if(document.getElementById(o+"_bottomToolbar")){var c=F(o+"_bottomToolbar","toolbar");c.refreshOverflow()}}else if(document.getElementById(o+"_toolbar")){var g=F(o+"_toolbar","toolbar");g.refreshOverflow()}}});l.appendTo("#"+o+"_frameRadiusBtn")},d.prototype.createFrameAmount=function(){var e=this,i=this.parent,t,r={frameChangeEventArgs:null},o=i.element.id,a=[{id:"1",text:this.l10n.getConstant("1")},{id:"2",text:this.l10n.getConstant("2")},{id:"3",text:this.l10n.getConstant("3")},{id:"4",text:this.l10n.getConstant("4")},{id:"5",text:this.l10n.getConstant("5")}],n=document.getElementById(o+"_frameAmountBtn"),s=document.createElement("span");s.innerHTML=this.l10n.getConstant(i.frameObj.amount.toString()),s.className="e-frame-amount",n.appendChild(s);var l=new q({items:a,open:function(p){if(w.isDevice){var h=p.element.parentElement;h.style.top=l.element.getBoundingClientRect().top-h.offsetHeight+"px"}var u=l.element.childNodes[0].textContent;u!==""&&p.element.querySelector('[aria-label = "'+u+'"]').classList.add("e-selected-btn")},select:function(p){e.triggerTbarClickEvent(p),t={type:i.toPascalCase(i.frameObj.type),color:i.frameObj.color,gradientColor:i.frameObj.gradientColor,size:i.frameObj.size,inset:i.frameObj.inset,offset:i.frameObj.offset,borderRadius:i.frameObj.radius,lineCount:i.frameObj.amount,frameLineStyle:i.toPascalCase(i.frameObj.border)};var h=i.frameObj.amount,u={currObj:{}};if(i.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:u}}),i.frameObj.amount=parseInt(p.item.text,10),i.notify("draw",{prop:"triggerFrameChange",value:{prevFrameSettings:t,obj:r}}),r.frameChangeEventArgs&&!r.frameChangeEventArgs.cancel?(i.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"frame",previousObj:u.currObj,previousObjColl:u.currObj.objColl,previousPointColl:u.currObj.pointColl,previousSelPointColl:u.currObj.selPointColl,previousCropObj:f({},i.cropObj,{},!0),previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),i.notify("draw",{prop:"render-image",value:{isMouseWheel:null,isPreventClearRect:null,isFrame:!0}}),i.notify("draw",{prop:"redrawDownScale"}),l.content=p.item.text,i.curFrameObjEvent={previousFrameSetting:r.frameChangeEventArgs.previousFrameSetting,currentFrameSetting:r.frameChangeEventArgs.currentFrameSetting},i.isFrameBtnClick=!0):i.frameObj.amount=h,w.isDevice){if(document.getElementById(o+"_bottomToolbar")){var c=F(o+"_bottomToolbar","toolbar");c.refreshOverflow()}}else if(document.getElementById(o+"_toolbar")){var g=F(o+"_toolbar","toolbar");g.refreshOverflow()}}});l.appendTo("#"+o+"_frameAmountBtn")},d.prototype.createFrameBorder=function(){var e=this,i=this.parent,t,r={frameChangeEventArgs:null},o=i.element.id,a=[{id:"1",text:this.l10n.getConstant("Solid")},{id:"2",text:this.l10n.getConstant("Dashed")},{id:"3",text:this.l10n.getConstant("Dotted")}],n=document.getElementById(o+"_frameBorderBtn"),s=document.createElement("span");s.innerHTML=this.l10n.getConstant(i.toPascalCase(i.frameObj.border)),s.className="e-frame-border",n.appendChild(s);var l=new q({items:a,open:function(p){if(w.isDevice){var h=p.element.parentElement;h.style.top=l.element.getBoundingClientRect().top-h.offsetHeight+"px"}var u=l.element.childNodes[0].textContent;u!==""&&p.element.querySelector('[aria-label = "'+u+'"]').classList.add("e-selected-btn")},select:function(p){e.triggerTbarClickEvent(p),t={lineCount:i.frameObj.amount,color:i.frameObj.color,borderRadius:i.frameObj.radius,gradientColor:i.frameObj.gradientColor,size:i.frameObj.size,inset:i.frameObj.inset,offset:i.frameObj.offset,frameLineStyle:i.toPascalCase(i.frameObj.border),type:i.toPascalCase(i.frameObj.type)};var h=i.frameObj.border,u={currObj:{}};if(i.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:u}}),i.frameObj.border=p.item.text.toLowerCase(),i.notify("draw",{prop:"triggerFrameChange",value:{prevFrameSettings:t,obj:r}}),r.frameChangeEventArgs&&!r.frameChangeEventArgs.cancel?(i.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"frame",previousObj:u.currObj,previousObjColl:u.currObj.objColl,previousPointColl:u.currObj.pointColl,previousSelPointColl:u.currObj.selPointColl,previousCropObj:f({},i.cropObj,{},!0),previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),i.notify("draw",{prop:"render-image",value:{isMouseWheel:null,isPreventClearRect:null,isFrame:!0}}),i.notify("draw",{prop:"redrawDownScale"}),l.content=p.item.text,i.curFrameObjEvent={previousFrameSetting:r.frameChangeEventArgs.previousFrameSetting,currentFrameSetting:r.frameChangeEventArgs.currentFrameSetting},i.isFrameBtnClick=!0):i.frameObj.border=h,w.isDevice){if(document.getElementById(o+"_bottomToolbar")){var c=F(o+"_bottomToolbar","toolbar");c.refreshOverflow()}}else if(document.getElementById(o+"_toolbar")){var g=F(o+"_toolbar","toolbar");g.refreshOverflow()}}});l.appendTo("#"+o+"_frameBorderBtn")},d.prototype.initFilterToolbarItem=function(){var e=this,i=this.parent,t=i.element.id,r=this.getFilterToolbarItem(),o={toolbarType:"filter",toolbarItems:r};i.trigger("toolbarUpdating",o),r=o.toolbarItems,document.querySelector("#"+t+"_contextualToolbar").classList.contains("e-control")&&F(document.getElementById(t+"_contextualToolbar"),"toolbar").destroy();var a=new ie({width:"100%",items:r,clicked:this.contextualToolbarClicked.bind(this),created:function(){e.updatePrivateVariables(),e.createCanvasFilter(),i.currentFilter===""&&(i.currentFilter=t+"_default");var n=document.querySelector("#"+t+"_headWrapper");n&&(n.style.display="none");var s=document.getElementById(i.currentFilter+"Canvas");s&&s.parentElement.parentElement.classList.add("e-selected"),e.enableDisableTbrBtn(),a.refreshOverflow()}});a.appendTo("#"+t+"_contextualToolbar")},d.prototype.drawDashedLine=function(e){e.beginPath(),e.setLineDash([5]),e.rect(10,10,280,130),e.stroke(),e.closePath()},d.prototype.createCanvasFilter=function(){var e=this.parent;ue(e.element),e.element.style.opacity="0.5";var i=e.getCurrentCanvasData();this.inMemoryCanvas.width=i.width,this.inMemoryCanvas.height=i.height,this.inMemoryContext.putImageData(i,0,0),this.updateFilterCanvas("_defaultCanvas","default"),this.updateFilterCanvas("_chromeCanvas","chrome"),this.updateFilterCanvas("_coldCanvas","cold"),this.updateFilterCanvas("_warmCanvas","warm"),this.updateFilterCanvas("_grayscaleCanvas","grayscale"),this.updateFilterCanvas("_sepiaCanvas","sepia"),this.updateFilterCanvas("_invertCanvas","invert"),re(e.element),e.element.style.opacity="1",e.initialAdjustmentValue=this.lowerContext.filter},d.prototype.updateFilterCanvas=function(e,i){var t=this.parent,r=t.element.querySelector("#"+t.element.id+e);if(r){var o=r.getContext("2d");o=r.getContext("2d"),r.style.width="100px",r.style.height="100px",t.notify("filter",{prop:"updateAdj",value:{type:i,value:null,isPreview:!0,ctx:o}}),o.drawImage(this.inMemoryCanvas,0,0,300,150),t.isSafari&&t.notify("filter",{prop:"apply-filter",onPropertyChange:!1,value:{context:o}})}},d.prototype.getQuickAccessToolbarItem=function(e){var i=this.parent,t=i.element.id,r={cancel:!1,toolbarItems:[]},o=[];C(e)?(i.activeObj.shape==="image"&&o.push("Flip"),i.activeObj.shape!=="redact"&&o.push("BringToFront"),o.push("Clone"),o.push("Delete"),i.activeObj.shape==="text"&&o.push("EditText"),r.shape=i.toPascalCase(i.activeObj.shape)):e&&(o.push("BringToFront"),o.push("Delete"),r.shape="Freehand draw"),r.toolbarItems=f([],o,null,!0),i.trigger("quickAccessToolbarOpen",r);var a=[];if(r.cancel)a=[];else for(var n=0;n<r.toolbarItems.length;n++)switch(r.toolbarItems[n]){case"BringToFront":a.push({id:t+"_bringToFront",prefixIcon:"e-icons e-bring-to-front",tooltipText:this.l10n.getConstant("BringToFront"),align:"Left"});break;case"Clone":a.push({id:t+"_duplicate",prefixIcon:"e-icons e-order",cssClass:"top-icon e-order",tooltipText:this.l10n.getConstant("Duplicate"),align:"Left"});break;case"Delete":a.push({id:t+"_remove",prefixIcon:"e-icons e-trash",cssClass:"top-icon e-trash",tooltipText:this.l10n.getConstant("Remove"),align:"Left"});break;case"EditText":a.push({id:t+"_editText",prefixIcon:"e-icons e-annotation-edit",cssClass:"top-icon e-annotation-edit",tooltipText:this.l10n.getConstant("EditText"),align:"Left"});break;case"Flip":a.push({id:t+"_hFlip",prefixIcon:"e-icons e-horizontal-flip",tooltipText:this.l10n.getConstant("HorizontalFlip"),align:"Left"}),a.push({id:t+"_vFlip",prefixIcon:"e-icons e-vertical-flip",tooltipText:this.l10n.getConstant("VerticalFlip"),align:"Left"});break;default:a.push(r.toolbarItems[n]);break}return a},d.prototype.renderQAT=function(e){var i=this.parent,t=i.element.id;if(i.activeObj&&i.showQuickAccessToolbar){var r=document.getElementById(t+"_quickAccessToolbarArea");r&&(this.destroyQuickAccessToolbar(),r.style.display="block");var o=this.getQuickAccessToolbarItem(e);if(o.length===0)return;if(C(i.quickAccessToolbarTemplate)){var a=new ie({items:o,clicked:this.quickAccessToolbarClicked.bind(this)});a.appendTo("#"+t+"_quickAccessToolbar")}var n=this.toolbarHeight&&this.toolbarHeight!==0?this.toolbarHeight:r.clientHeight,s=i.element.querySelector("#"+t+"_headWrapper");if(C(e)&&(i.activeObj.activePoint.width!==0||i.activeObj.activePoint.height!==0||i.activeObj.shape&&i.activeObj.shape==="path"&&i.activeObj.pointColl.length>0)){var l={order:null};i.notify("shape",{prop:"getHighestOrder",onPropertyChange:!1,value:{obj:l}}),i.activeObj.order>l.order&&document.getElementById(i.element.id+"_bringToFront")?document.getElementById(i.element.id+"_bringToFront").classList.add("e-overlay"):document.getElementById(i.element.id+"_bringToFront")&&document.getElementById(i.element.id+"_bringToFront").classList.remove("e-overlay"),r.style.width="auto",i.activeObj.activePoint.width=Math.abs(i.activeObj.activePoint.width),i.activeObj.activePoint.height=Math.abs(i.activeObj.activePoint.height);var p=i.activeObj.activePoint.startX<i.activeObj.activePoint.endX?i.activeObj.activePoint.startX:i.activeObj.activePoint.endX,h=i.activeObj.activePoint.startY<i.activeObj.activePoint.endY?i.activeObj.activePoint.startY:i.activeObj.activePoint.endY,u=i.activeObj.activePoint.width;if(i.activeObj.rotatedAngle!==0&&i.activeObj.shape!=="arrow"){var c={activePoint:null};i.notify("shape",{prop:"getSquarePointForRotatedShape",onPropertyChange:!1,value:{obj:i.activeObj,object:c}});var g=c.activePoint;p=g.startX,h=g.startY,u=g.width}else if(i.activeObj.shape==="path"){var v=i.getSquarePointForPath(i.activeObj);p=v.startX,h=v.startY,u=v.width}if(r.style.left=p+u/2-o.length*25+"px",parseFloat(r.style.left)+r.clientWidth/2!==p+u/2){var b=p+u/2-(parseFloat(r.style.left)+r.clientWidth/2);r.style.left=parseFloat(r.style.left)+b+"px"}s&&(n=s.offsetHeight+n),h-(n+n/1.5)<i.img.destTop?(r.style.top=i.img.destTop+"px",s&&(r.style.top=(i.img.destTop<0?0:i.img.destTop)+s.offsetHeight+"px")):(n=this.toolbarHeight,r.style.top=h-(n+n/1.5)+"px")}else if(e){var m={freehandSelectedIndex:-1};i.notify("freehand-draw",{prop:"getFreehandSelectedIndex",onPropertyChange:!1,value:{obj:m}});var l={order:null};i.notify("shape",{prop:"getHighestOrder",onPropertyChange:!1,value:{obj:l}}),i.getObjFromId(i.pointColl[m.freehandSelectedIndex].id).order>=l.order&&document.getElementById(i.element.id+"_bringToFront")?document.getElementById(i.element.id+"_bringToFront").classList.add("e-overlay"):document.getElementById(i.element.id+"_bringToFront")&&document.getElementById(i.element.id+"_bringToFront").classList.remove("e-overlay");var y={activePoint:null};i.notify("freehand-draw",{prop:"getSqPtFD",value:{idx:m.freehandSelectedIndex,obj:y}});var g=y.activePoint;r.style.width="auto",r.style.left=g.startX+g.width/2-o.length*24+"px",g.startY-(n+n/1.5)<i.img.destTop?r.style.top=i.img.destTop+"px":r.style.top=g.startY-(n+n/1.5)+"px"}else r.style.display="none";parseFloat(r.style.top)<0&&(r.style.top="0px")}},d.prototype.refreshDropDownBtn=function(e){if(!C(e)){var i=this.parent,t=i.element.id,r=document.querySelector("#"+t+"_annotationBtn");r&&(e?(r.classList.add("e-disabled"),r.parentElement.classList.add("e-overlay")):(r.classList.remove("e-disabled"),r.parentElement.classList.remove("e-overlay")),F(r,"dropdown-btn").disabled=e);var o=document.querySelector("#"+t+"_transformBtn");o&&(e?(o.classList.add("e-disabled"),o.parentElement.classList.add("e-overlay")):(o.classList.remove("e-disabled"),o.parentElement.classList.remove("e-overlay")),F(o,"dropdown-btn").disabled=e);var a=document.querySelector("#"+t+"_adjustment");a&&(e?(a.classList.add("e-disabled"),a.parentElement.classList.add("e-overlay")):(a.classList.remove("e-disabled"),a.parentElement.classList.remove("e-overlay")),F(a,"btn").disabled=e);var n=document.querySelector("#"+t+"_filter");n&&(e?(n.classList.add("e-disabled"),n.parentElement.classList.add("e-overlay")):(n.classList.remove("e-disabled"),n.parentElement.classList.remove("e-overlay")),F(n,"btn").disabled=e)}},d.prototype.cropSelect=function(e){var i=this.parent;i.isCropTab=!0,C(i.transform.cropZoomFactor)&&(i.transform.cropZoomFactor=i.transform.zoomFactor,i.notify("draw",{prop:"setTempZoomFactor",onPropertyChange:!1,value:{tempZoomFactor:i.transform.zoomFactor}})),i.transform.zoomFactor=i.transform.cropZoomFactor;var t=e.item.id;this.currentToolbar="crop",i.currSelectionPoint=null,i.notify("draw",{prop:"setIsCropSelect",value:{bool:!0}});var r={prevObj:null};i.notify("crop",{prop:"getPreviousCropCurrentObj",value:{obj:r}}),i.notify("draw",{prop:"select",onPropertyChange:!1,value:{type:t,startX:null,startY:null,width:null,height:null}}),i.notify("crop",{prop:"setPreviousCropCurrentObj",value:{obj:r.prevObj}}),this.enableDisableTbrBtn(),i.notify("transform",{prop:"disableZoomOutBtn",value:{isZoomOut:!0}})},d.prototype.quickAccessToolbarClicked=function(e,i){var t=this.parent,r=t.element.id;if(e.item){var o=null,a={prevActObj:null},n={tempObj:null};t.notify("draw",{prop:"getPrevActObj",onPropertyChange:!1,value:{obj:a}}),t.notify("selection",{prop:"getTempActObj",onPropertyChange:!1,value:{obj:n}}),n.tempObj.activePoint.height=Math.abs(n.tempObj.activePoint.height);var s={isNewPath:null},l=void 0;t.notify("draw",{prop:"getNewPath",value:{obj:s}});var p=e.item.id.replace(r+"_","").toLowerCase(),h=void 0,u=void 0,c={freehandSelectedIndex:null},g=void 0,v=void 0,b={order:null};switch(p){case"duplicate":t.element.querySelector("#"+r+"_duplicate").classList.contains("e-overlay")||(this.refreshSlider(),!s.isNewPath&&JSON.stringify(n.tempObj)===JSON.stringify(t.activeObj)&&(o=!0),this.duplicateShape(o));break;case"remove":t.element.querySelector("#"+r+"_remove").classList.contains("e-overlay")||(t.noPushUndo=!1,this.refreshSlider(),t.notify("selection",{prop:"deleteItem",onPropertyChange:!1}));break;case"edittext":t.element.querySelector("#"+r+"_editText").classList.contains("e-overlay")||this.editText();break;case"rotleft":case"rotright":h=t.element.querySelector("#"+r+"_rotLeft"),u=t.element.querySelector("#"+r+"_rotRight"),(h&&!h.classList.contains("e-disabled")||u&&!u.classList.contains("e-disabled"))&&t.rotateImage(e.item.id.replace(r+"_","").toLowerCase()),t.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1});break;case"hflip":t.element.querySelector("#"+r+"_hFlip").classList.contains("e-disabled")||(l=t.activeObj.imageCanvas.getContext("2d"),t.horizontalFlip(l)),t.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1});break;case"vflip":t.element.querySelector("#"+r+"_vFlip").classList.contains("e-disabled")||(l=t.activeObj.imageCanvas.getContext("2d"),t.verticalFlip(l)),t.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1});break;case"bringtofront":if(!t.element.querySelector("#"+r+"_bringToFront").classList.contains("e-overlay")){if(t.notify("freehand-draw",{prop:"getFreehandSelectedIndex",onPropertyChange:!1,value:{obj:c}}),g=c.freehandSelectedIndex!==null?t.pointColl[c.freehandSelectedIndex].id:t.activeObj.currIndex,t.updateShapeOrder(g,p),v=!1,t.notify("shape",{prop:"getHighestOrder",onPropertyChange:!1,value:{obj:b}}),g.indexOf("pen")>-1){t.notify("shape",{prop:"updateShapeColl",onPropertyChange:!1});var m=t.getObjFromId(g).order;v=m>=b.order}else{var m=t.getObjFromId(g).order;v=m>b.order}v?document.getElementById(t.element.id+"_bringToFront").classList.add("e-overlay"):document.getElementById(t.element.id+"_bringToFront").classList.remove("e-overlay"),t.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1})}break}(p==="duplicate"||p==="remove")&&t.notify("draw",{prop:"redrawDownScale"})}C(i)&&t.trigger("quickAccessToolbarItemClick",e)},d.prototype.editText=function(){var e=this.parent,i={x:e.activeObj.activePoint.startX,y:e.activeObj.activePoint.startY};if(this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),e.notify("selection",{prop:"setTempActObj",onPropertyChange:!1,value:{obj:f({},e.activeObj,{},!0)}}),e.notify("selection",{prop:"setInitialTextEdit",onPropertyChange:!1,value:{bool:!0}}),e.notify("draw",{prop:"setPrevActObj",onPropertyChange:!1,value:{prevActObj:f({},e.activeObj,{},!0)}}),e.activeObj.rotatedAngle!==0){var t={x:i.x,y:i.y};e.notify("shape",{prop:"getTextBoxPosition",onPropertyChange:!1,value:{obj:e.activeObj,object:t}}),i.x=t.x,i.y=t.y;var r={x:i.x,y:i.y};e.notify("shape",{prop:"setFlipState",onPropertyChange:!1,value:{x:i.x,y:i.y,obj:e.activeObj,object:r}}),i.x=r.x,i.y=r.y}var o=f({},e.activeObj,{},!0);e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),this.lowerContext.clearRect(0,0,e.upperCanvas.width,e.upperCanvas.height),e.notify("draw",{prop:"redrawImgWithObj",onPropertyChange:!1}),e.notify("draw",{prop:"redrawDownScale"}),e.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.lowerContext}}),e.notify("draw",{prop:"clearOuterCanvas",onPropertyChange:!1,value:{context:this.upperContext}}),e.activeObj=o,e.notify("shape",{prop:"renderTextArea",onPropertyChange:!1,value:{x:i.x,y:i.y,actObj:e.activeObj}}),C(e.activeObj.currIndex)&&e.notify("draw",{prop:"setShapeTextInsert",onPropertyChange:!1,value:{bool:!0}}),document.getElementById(e.element.id+"_quickAccessToolbarArea")&&(document.getElementById(e.element.id+"_quickAccessToolbarArea").style.display="none")},d.prototype.duplicateShape=function(e,i){var t=this.parent,r={activePoint:{startX:0,startY:0,endX:0,endY:0,width:0,height:0},flipObjColl:[],triangle:[],triangleRatio:[]};t.notify("selection",{prop:"setTempActObj",onPropertyChange:!1,value:{obj:r}});var o={prevActObj:null};t.notify("draw",{prop:"getPrevActObj",onPropertyChange:!1,value:{obj:o}});var a={isNewPath:null};t.notify("draw",{prop:"getNewPath",value:{obj:a}});var n,s=f({},t.activeObj,{},!0),l={order:null};t.notify("shape",{prop:"getHighestOrder",onPropertyChange:!1,value:{obj:l}}),s.order?(t.notify("shape",{prop:"updateShapeColl",onPropertyChange:!1}),s.order=l.order>s.order?l.order+1:s.order+1):(t.noPushUndo=!0,t.okBtn(),t.noPushUndo=!1,t.selectShape(s.currIndex),s.order=l.order>s.order?l.order+1:s.order+1),s.shape==="image"&&(n=f([],t.objColl,[],!0),t.notify("undo-redo",{prop:"updateUrObj",onPropertyChange:!1,value:{objColl:n}})),C(t.activeObj.currIndex)?t.notify("shape",{prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:e}}):o.prevActObj||i?(t.activeObj.currIndex=null,s.currIndex=null,t.notify("shape",{prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:e}})):t.notify("shape",{prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:!0}});var p=t.noPushUndo;if(t.noPushUndo=!1,t.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}}),t.noPushUndo=p,n=f([],t.objColl,[],!0),s.activePoint.startX+=10,s.activePoint.startY-=10,s.activePoint.endX+=10,s.activePoint.endY-=10,s.shape==="path")for(var h=0;h<s.pointColl.length;h++)s.pointColl[h].x+=10,s.pointColl[h].y-=10;else s.shape==="image"&&(s.imageCanvas=t.createElement("canvas"));var u={id:"shape_"+(t.objColl.length+1)};if(t.notify("shape",{prop:"getNewShapeId",onPropertyChange:!1,value:{obj:u}}),s.currIndex=u.id,t.activeObj=f({},s,{},!0),t.activeObj.shape==="image"){var c=f({},s.activePoint,{},!0),g={width:0,height:0};t.notify("transform",{prop:"calcMaxDimension",onPropertyChange:!1,value:{width:t.activeObj.imageElement.width,height:t.activeObj.imageElement.height,obj:g,isImgShape:null}}),t.activeObj.activePoint.width=g.width,t.activeObj.activePoint.height=g.height,t.activeObj.isHorImageFlip&&t.activeObj.isVerImageFlip?(t.activeObj.isHorImageFlip=t.activeObj.isVerImageFlip=!1,t.notify("draw",{prop:"downScaleImgCanvas",onPropertyChange:!1,value:{ctx:s.imageCanvas.getContext("2d"),isImgAnnotation:!0,isHFlip:!0,isVFlip:!0}}),t.activeObj.isHorImageFlip=t.activeObj.isVerImageFlip=!0):t.activeObj.isHorImageFlip?(t.activeObj.isHorImageFlip=!1,t.notify("draw",{prop:"downScaleImgCanvas",onPropertyChange:!1,value:{ctx:s.imageCanvas.getContext("2d"),isImgAnnotation:!0,isHFlip:!0,isVFlip:null}}),t.activeObj.isHorImageFlip=!0):t.activeObj.isVerImageFlip?(t.activeObj.isVerImageFlip=!1,t.notify("draw",{prop:"downScaleImgCanvas",onPropertyChange:!1,value:{ctx:s.imageCanvas.getContext("2d"),isImgAnnotation:!0,isHFlip:null,isVFlip:!0}}),t.activeObj.isVerImageFlip=!0):t.notify("draw",{prop:"downScaleImgCanvas",onPropertyChange:!1,value:{ctx:s.imageCanvas.getContext("2d"),isImgAnnotation:!0,isHFlip:null,isVFlip:null}}),t.activeObj.activePoint=c}(t.activeObj.shape==="line"||t.activeObj.shape==="arrow")&&t.notify("shape",{prop:"setPointCollForLineArrow",onPropertyChange:!1,value:{obj:t.activeObj}}),t.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:t.activeObj,isCropRatio:null,points:null,isPreventDrag:!0}}),t.notify("undo-redo",{prop:"updateUrObj",onPropertyChange:!1,value:{objColl:n}}),t.notify("shape",{prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:!0}}),t.noPushUndo=!1,t.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}}),t.noPushUndo=!0,t.notify("selection",{prop:"redrawShape",onPropertyChange:!1,value:{obj:t.objColl[t.objColl.length-1]}});var v=t.element.id,b=w.isDevice?"#"+v+"_bottomToolbar #"+v:"#"+v,m={freehandDrawSelectedId:null};t.notify("freehand-draw",{prop:"getFreehandDrawSelectedId",onPropertyChange:!1,value:{obj:m}}),this.enableDisableCloneBtn(b,m),this.renderQAT(),t.activeObj.shape&&t.activeObj.shape==="redact"&&this.redactSlider(t.activeObj.redactType)},d.prototype.defToolbarClicked=function(e){var i=this.parent,t=i.element.id,r=!1,o=!1;if(!this.isFrameToolbar&&i.element.querySelector(".e-contextual-toolbar-wrapper")){i.element.querySelector(".e-contextual-toolbar-wrapper").classList.contains("e-hide")||(r=o=!0);var a={bool:i.isStraightening};(!w.isDevice||w.isDevice&&!a.bool)&&i.element.querySelector(".e-contextual-toolbar-wrapper").classList.add("e-hide")}if(e.item){var n=e.item.id.replace(t+"_","").toLowerCase();if(n==="duplicate"||n==="remove"||n==="edittext"||n==="hflip"||n==="vflip"||n==="rotleft"||n==="rotright")this.quickAccessToolbarClicked(e,!0),i.trigger("toolbarItemClicked",e);else{var s=!1,l=!1,p=document.querySelector("#"+t+"_adjustment");p&&p.classList.contains("e-disabled")&&(l=!0);var h=document.querySelector("#"+t+"_filter");h&&h.classList.contains("e-disabled")&&(s=!0),this.enableDisableTbrBtn(),this.performDefTbrClick(n,r,l,s,o),i.trigger("toolbarItemClicked",e),i.isStraightening&&i.notify("transform",{prop:"disableZoomOutBtn",value:{isZoomOut:!0}});var u=["undo","redo","cancel","aspectratio","nonaspectratio","save","duplicate","filter","frame","none","mat","bevel","line","inset","hook","resize","remove"];u.indexOf(n)!==-1&&i.notify("draw",{prop:"redrawDownScale"})}}},d.prototype.performDefTbrClick=function(e,i,t,r,o){var a=this.parent,n=a.element.id,s=a.element.querySelector("#"+n+"_zoomIn"),l=a.element.querySelector("#"+n+"_resizeHeight"),p=a.element.querySelector("#"+n+"_resizeWidth"),h=!1,u,c,g,v,b=!1,m=0,y,P=!1;if(a.activeObj.shape!==void 0&&(c=a.activeObj.shape.split("-")),(c===void 0&&a.currObjType.isCustomCrop||c!==void 0&&c[0]==="crop")&&(h=!0),!a.disabled){switch(e){case"pan":a.currObjType.isCustomCrop=a.currObjType.isFiltered=!1,a.currObjType.isRedact=!1,a.currObjType.isUndoAction&&a.notify("undo-redo",{prop:"refreshUrc",value:{bool:null}}),h&&(a.currObjType.isCustomCrop=!1,a.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.upperContext.clearRect(0,0,a.upperCanvas.width,a.upperCanvas.height),this.refreshToolbar("main")),a.togglePan?(this.cancelPan(),a.notify("transform",{prop:"setDisablePan",onPropertyChange:!1,value:{bool:!0}}),this.currentToolbar==="pen"&&a.freeHandDraw(!0)):(u=a.element.querySelector(".e-img-pan .e-btn"),u&&u.classList.add("e-selected-btn"),a.pan(!0),a.notify("transform",{prop:"setDisablePan",onPropertyChange:!1,value:{bool:!1}})),s&&a.zoomSettings.zoomFactor>=a.zoomSettings.maxZoomFactor?(s.classList.add("e-disabled"),s.parentElement.classList.add("e-overlay")):s&&(s.classList.remove("e-disabled"),s.parentElement.classList.remove("e-overlay")),this.refreshToolbar("main");break;case"cancel":a.currObjType.isRedact&&(a.currObjType.isRedact=!1),this.isFrameToolbar&&a.element.querySelector(".e-contextual-toolbar-wrapper")&&!a.element.querySelector(".e-contextual-toolbar-wrapper").classList.contains("e-hide")&&a.element.querySelector(".e-contextual-toolbar-wrapper").classList.add("e-hide"),a.notify("draw",{prop:"performCancel",value:{isContextualToolbar:i,isFinalCancel:!0}});break;case"ok":w.isDevice&&this.isFrameToolbar&&a.element.querySelector(".e-contextual-toolbar-wrapper")&&!a.element.querySelector(".e-contextual-toolbar-wrapper").classList.contains("e-hide")&&a.element.querySelector(".e-contextual-toolbar-wrapper").classList.add("e-hide"),a.okBtn(null,!0),a.drawingShape=null,this.refreshDropDownBtn(!1),this.currentToolbar="main",a.isStraightening=!1,a.notify("draw",{prop:"resetTempObjColl"}),a.notify("draw",{prop:"resetTempPointColl"});break;case"crop":a.notify("transform",{prop:"disableZoomOutBtn",value:{isZoomOut:!0}}),w.isDevice&&this.updateContextualToolbar("color","straighten");break;case"reset":a.reset(),this.imageHeight=null,this.imageWidth=null,a.aspectHeight=null,a.aspectWidth=null,this.isAspectRatio=!0,this.currentToolbar="main";break;case"undo":a.noPushUndo=!1,(a.togglePen||a.drawingShape)&&(a.okBtn(),a.drawingShape=null),a.notify("undo-redo",{prop:"call-undo"});break;case"redo":a.noPushUndo=!1,(a.togglePen||a.drawingShape)&&(a.okBtn(),a.drawingShape=null),a.notify("undo-redo",{prop:"call-redo"});break;case"aspectratio":(!a.isCircleCrop&&C(a.currSelectionPoint)||a.currSelectionPoint&&a.currSelectionPoint.shape!=="crop-circle")&&(F(p,"numerictextbox").value?(a.aspectWidth=F(p,"numerictextbox").value,a.aspectHeight=F(l,"numerictextbox").value,a.notify("transform",{prop:"resize",value:{width:a.aspectWidth,height:null,isAspectRatio:!0}})):F(l,"numerictextbox").value&&(a.aspectWidth=parseFloat(F(p,"numerictextbox").placeholder),a.aspectHeight=F(l,"numerictextbox").value,a.notify("transform",{prop:"resize",value:{width:a.aspectWidth,height:a.aspectHeight,isAspectRatio:!0}})),a.resizeSrc={startX:a.img.srcLeft,startY:a.img.srcTop,width:a.img.srcWidth,height:a.img.srcHeight},this.refreshToolbar("resize"));break;case"nonaspectratio":(F(p,"numerictextbox").value||F(l,"numerictextbox").value)&&(a.aspectWidth=F(p,"numerictextbox").value?F(p,"numerictextbox").value:parseFloat(F(p,"numerictextbox").placeholder),a.aspectHeight=F(l,"numerictextbox").value?F(l,"numerictextbox").value:parseFloat(F(l,"numerictextbox").placeholder),a.notify("transform",{prop:"resize",value:{width:a.aspectWidth,height:a.aspectHeight,isAspectRatio:!1}})),a.resizeSrc={startX:a.img.srcLeft,startY:a.img.srcTop,width:a.img.srcWidth,height:a.img.srcHeight},this.refreshToolbar("resize");break;case"resize":(a.currObjType.isFiltered||a.currObjType.isRedact)&&a.okBtn(),this.resizeClick();break;case"adjustment":t||((a.currObjType.isFiltered||a.currObjType.isRedact)&&a.okBtn(),this.refreshToolbar("adjustment"),a.setTempFilterProperties(),a.notify("draw",{prop:"updateFinetune"}),a.notify("filter",{prop:"setTempAdjVal"}),this.openSlider("brightness"));break;case"brightness":case"contrast":case"hue":case"saturation":case"opacity":case"blur":case"exposure":this.openSlider(e);break;case"filter":r||(ue(a.element),this.refreshToolbar("filter"),a.setTempFilterProperties(),re(a.element));break;case"default":case"chrome":case"cold":case"warm":case"grayscale":case"blackandwhite":case"sepia":case"invert":case"sharpen":a.currObjType.isFiltered=!0,a.notify("filter",{prop:"applyImageFilter",value:{option:e}});break;case"upload":o&&a.element.querySelector(".e-contextual-toolbar-wrapper").classList.remove("e-hide");break;case"bold":a.notify("selection",{prop:"setInitialTextEdit",value:{bool:!1}}),a.activeObj.textSettings.bold&&a.activeObj.textSettings.italic?a.notify("shape",{prop:"applyFontStyle",onPropertyChange:!1,value:{item:"italic"}}):a.activeObj.textSettings.bold&&!a.activeObj.textSettings.italic?a.notify("shape",{prop:"applyFontStyle",onPropertyChange:!1,value:{item:"default"}}):!a.activeObj.textSettings.bold&&a.activeObj.textSettings.italic?a.notify("shape",{prop:"applyFontStyle",onPropertyChange:!1,value:{item:"bolditalic"}}):!a.activeObj.textSettings.bold&&!a.activeObj.textSettings.italic&&a.notify("shape",{prop:"applyFontStyle",onPropertyChange:!1,value:{item:"bold"}}),a.element.querySelector("#"+n+"_bold").classList.contains("e-selected-btn")?a.element.querySelector("#"+n+"_bold").classList.remove("e-selected-btn"):a.element.querySelector("#"+n+"_bold").classList.add("e-selected-btn"),(a.activeObj.activePoint.width!==0||a.activeObj.activePoint.height!==0)&&a.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1});break;case"italic":a.notify("selection",{prop:"setInitialTextEdit",value:{bool:!1}}),a.activeObj.textSettings.bold&&a.activeObj.textSettings.italic?a.notify("shape",{prop:"applyFontStyle",onPropertyChange:!1,value:{item:"bold"}}):a.activeObj.textSettings.bold&&!a.activeObj.textSettings.italic?a.notify("shape",{prop:"applyFontStyle",onPropertyChange:!1,value:{item:"bolditalic"}}):!a.activeObj.textSettings.bold&&a.activeObj.textSettings.italic?a.notify("shape",{prop:"applyFontStyle",onPropertyChange:!1,value:{item:"default"}}):!a.activeObj.textSettings.bold&&!a.activeObj.textSettings.italic&&a.notify("shape",{prop:"applyFontStyle",onPropertyChange:!1,value:{item:"italic"}}),a.element.querySelector("#"+n+"_italic").classList.contains("e-selected-btn")?a.element.querySelector("#"+n+"_italic").classList.remove("e-selected-btn"):a.element.querySelector("#"+n+"_italic").classList.add("e-selected-btn"),(a.activeObj.activePoint.width!==0||a.activeObj.activePoint.height!==0)&&a.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1});break;case"croptransform":this.performCropTransformClick();break;case"rotateleft":case"rotateright":case"horizontalflip":case"verticalflip":a.transformSelect(e);for(var S=0;S<a.objColl.length;S++)if(a.objColl[S].shape==="redact"){P=!0;break}if(P)for(a.notify("draw",{prop:"setRedactStraighten",value:{bool:!0}}),y=f({},a.activeObj,{},!0);a.img.destLeft<0||a.img.destTop<0;)a.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),a.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-.125,zoomPoint:null,isResize:!1}}),m+=1;if(this.updateRedactObj(),P){if(m>0){a.isCropTab=!0;for(var S=0;S<m;S++)a.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),a.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:.125,zoomPoint:null,isResize:!1}});a.activeObj=y,a.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}})}a.notify("draw",{prop:"setRedactStraighten",value:{bool:!1}})}(e==="rotateleft"||e==="rotateright")&&(a.notify("draw",{prop:"resetStraightenDestPoints"}),a.notify("draw",{prop:"setDestForStraighten"})),a.notify("transform",{prop:"disableZoomOutBtn",value:{isZoomOut:!0}}),w.isDevice&&this.updateContextualToolbar("color","straighten"),g=e==="rotateleft"||e==="rotateright"?"rotate":"flip",v={action:g,actionEventArgs:a.editCompleteArgs},a.triggerEditCompleteEvent(v);break;case"save":a.noPushUndo=!1,a.okBtn(),a.drawingShape=null,this.saveDialogPopup();break;case"transparency":this.updateContextualToolbar("transparency","transparency");break;case"frame":this.frameToolbarClick();break;case"none":case"mat":case"bevel":case"line":case"inset":case"hook":this.unselectFrameBtn(),a.element.querySelector("#"+n+"_"+e)&&a.element.querySelector("#"+n+"_"+e).classList.add("e-selected-btn"),a.frameObj.type=e,a.frameObj.size=20,a.frameObj.inset=20,a.frameObj.radius=0,a.frameObj.amount=1,e==="inset"?a.frameObj.offset=60:a.frameObj.offset=20,this.refreshToolbar("frame"),a.notify("draw",{prop:"render-image",value:{isMouseWheel:null,isPreventClearRect:null,isFrame:!0}}),a.isFrameBtnClick=!0,a.curFrameObjEvent={previousFrameSetting:a.tempFrameObj,currentFrameSetting:a.frameObj},a.notify("draw",{prop:"triggerFrameChange",value:{prevFrameSettings:a.tempFrameObj,obj:{frameChangeEventArgs:null}}});break;case"redact":a.currObjType.isRedact=b=!0,a.drawingShape="redact",C(a.activeObj.redactBlur)&&(a.activeObj.redactBlur=20),C(a.activeObj.redactPixelate)&&(a.activeObj.redactPixelate=20),a.notify("selection",{prop:"annotate",value:{shape:"redact"}}),this.refreshToolbar("redact"),this.redactSlider(a.activeObj.redactType);break;case"pixelate":if(a.currObjType.isRedact=b=!0,a.drawingShape="redact",a.notify("selection",{prop:"annotate",value:{shape:"redact"}}),a.activeObj.redactType==="blur"&&this.updateRedactType("pixelate"),a.notify("shape",{prop:"setRedactType",onPropertyChange:!1,value:{redactType:"pixelate"}}),a.activeObj.redactType==="pixelate"){var O=a.element.querySelector("#"+n+"_pixelate"),j=a.element.querySelector("#"+n+"_redactBlur");O&&O.classList.add("e-selected-btn"),j&&j.classList.contains("e-selected-btn")&&j.classList.remove("e-selected-btn")}else{var j=a.element.querySelector("#"+n+"_redactBlur");j&&j.classList.add("e-selected-btn")}this.redactSlider(a.activeObj.redactType),(a.activeObj.activePoint.width!==0||a.activeObj.activePoint.height!==0)&&a.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:null,previousObjColl:null,previousPointColl:null,previousSelPointColl:null,previousCropObj:null,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}});break;case"redactblur":if(a.currObjType.isRedact=b=!0,a.drawingShape="redact",a.notify("selection",{prop:"annotate",value:{shape:"redact"}}),a.notify("shape",{prop:"setRedactType",onPropertyChange:!1,value:{redactType:"blur"}}),a.activeObj.redactType==="pixelate"&&this.updateRedactType("blur"),a.notify("shape",{prop:"setRedactType",onPropertyChange:!1,value:{redactType:"blur"}}),a.activeObj.redactType==="blur"){var j=a.element.querySelector("#"+n+"_redactBlur"),O=a.element.querySelector("#"+n+"_pixelate");j&&j.classList.add("e-selected-btn"),O&&O.classList.contains("e-selected-btn")&&O.classList.remove("e-selected-btn")}else{var O=a.element.querySelector("#"+n+"_pixelate");O&&O.classList.add("e-selected-btn")}this.redactSlider(a.activeObj.redactType),(a.activeObj.activePoint.width!==0||a.activeObj.activePoint.height!==0)&&a.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:null,previousObjColl:null,previousPointColl:null,previousSelPointColl:null,previousCropObj:null,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}});break}b&&(a.notify("draw",{prop:"updateTempObjColl"}),a.notify("draw",{prop:"updateTempPointColl"}))}},d.prototype.updateRedactType=function(e){var i=this.parent;i.activeObj.redactType=e,i.notify("shape",{prop:"setRedactType",value:{type:e}}),this.parent.objColl.push(i.activeObj),i.notify("selection",{prop:"redrawShape",value:{obj:i.objColl[i.objColl.length-1]}})},d.prototype.frameToolbarClick=function(){var e=this.parent,i=e.element.id,t=document.querySelector("#"+i+"_frame"),r,o,a;e.notify("draw",{prop:"updateCropSelection",onPropertyChange:!1}),(e.currObjType.isFiltered||e.currObjType.isRedact)&&e.okBtn(),t&&!t.classList.contains("e-overlay")&&(r=e.transform.zoomFactor,e.frameDestPoints=f({},e.img,{},!0),C(e.cxtTbarHeight)&&(o=f({},e.frameObj,{},!0),a=f({},e.tempFrameObj,{},!0),this.callFrameToolbar(),e.frameObj.type="mat",this.callFrameToolbar(),e.cxtTbarHeight=e.element.querySelector("#"+i+"_customizeWrapper").scrollHeight,e.frameObj=o,e.tempFrameObj=a),this.zoomToFrameRange(),e.tempFrameZoomLevel=r,w.isDevice?e.img.destTop-=e.cxtTbarHeight/2:e.img.destTop+=e.cxtTbarHeight/2,this.callFrameToolbar(),e.notify("draw",{prop:"triggerFrameChange",value:{prevFrameSettings:e.frameObj,obj:{frameChangeEventArgs:null}}}))},d.prototype.zoomToFrameRange=function(){var e=this.parent;this.isFrameToolbar=!1,e.notify("transform",{prop:"resetZoom",onPropertyChange:!1});for(var i=!0;i;){if(this.toolbarHeight+e.img.destTop>=this.toolbarHeight+e.cxtTbarHeight){i=!1;break}e.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-.1,zoomPoint:null,isResize:!0}})}this.isFrameToolbar=!0},d.prototype.resizeClick=function(){var e=this.parent;e.notify("draw",{prop:"updateCropSelection",onPropertyChange:!1}),e.upperCanvas.style.cursor="default",e.notify("transform",{prop:"updateResize",value:{bool:!1}}),this.isAspectRatio?this.isAspectRatio=!1:this.isAspectRatio=!0,e.isResize=!0,this.refreshToolbar("resize")},d.prototype.callFrameToolbar=function(){var e=this.parent;f(e.tempFrameObj,e.frameObj);var i={appliedUndoRedoColl:[]};if(e.notify("undo-redo",{prop:"getAppliedUndoRedoColl",value:{obj:i}}),i.appliedUndoRedoColl.length===0){var t={currObj:{}};e.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:t}}),e.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"frame",previousObj:t.currObj,previousObjColl:t.currObj.objColl,previousPointColl:t.currObj.pointColl,previousSelPointColl:t.currObj.selPointColl,previousCropObj:f({},e.cropObj,{},!0),previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}})}this.refreshToolbar("frame")},d.prototype.contextualToolbarClicked=function(e){var i=this.parent,t=i.element.querySelector(".e-contextual-toolbar-wrapper .e-toolbar-item.e-selected");t&&t.classList.remove("e-selected");var r=e.item.id.replace(i.element.id,"").split("_")[1],o={filter:i.toPascalCase(r),cancel:!1};i.trigger("imageFiltering",o),i.editCompleteArgs=o,!o.cancel&&(document.getElementById(e.item.id+"Canvas").parentElement.parentElement.classList.add("e-selected"),i.currObjType.isFiltered=!0,i.notify("filter",{prop:"applyImageFilter",value:{option:r.toLowerCase()}}),i.notify("draw",{prop:"redrawDownScale"}),i.currentFilter=e.item.id,this.enableDisableTbrBtn(),i.isFilterCanvasClick=!0,i.curFilterObjEvent=o)},d.prototype.refreshShapeDrawing=function(){var e=this.parent,i={shape:""};e.notify("selection",{prop:"getCurrentDrawingShape",onPropertyChange:!1,value:{obj:i}}),i.shape!==""&&(e.notify("selection",{prop:"setCurrentDrawingShape",onPropertyChange:!1,value:{value:""}}),e.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),this.refreshToolbar("main",!1))},d.prototype.zoomInBtnClickHandler=function(e){if(e){var i=this.parent;if((i.zoomSettings.zoomTrigger&U.Toolbar)===U.Toolbar){i.noPushUndo=!1,i.currObjType.isFiltered&&i.okBtn();var t=i.drawingShape;if(i.drawingShape){var r=i.activeObj.currIndex;i.noPushUndo=!0,i.okBtn(),i.noPushUndo=!1,i.drawingShape=null,r&&i.selectShape(r)}if(this.refreshShapeDrawing(),w.isDevice&&e.type==="touchstart"){if(!e.returnValue)return;e.preventDefault()}var o=document.querySelector("#"+i.element.id+"_zoomIn");I.trigger(o,"click");var a={bool:!1};i.notify("selection",{prop:"getFreehandDrawEditing",onPropertyChange:!1,value:{obj:a}}),a.bool&&(i.notify("freehand-draw",{prop:"applyFhd",onPropertyChange:!1}),this.destroyQuickAccessToolbar()),i.isZoomBtnClick=!0,this.applyPreviewFilter(),i.currObjType.isFiltered=!1,i.currObjType.isRedact=!1,i.togglePen&&(i.currObjType.isZoomed=!0,i.freeHandDraw(!1),i.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}})),i.notify("draw",{prop:"resetCurrentSelectionPoint"}),i.drawingShape=t,i.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:.1,zoomPoint:null,isResize:null}}),i.notify("draw",{prop:"redrawDownScale"}),(i.isCropTab||i.activeObj.shape)&&(i.notify("draw",{prop:"setStraightenActObj",value:{activeObj:null}}),i.notify("freehand-draw",{prop:"resetStraightenPoint"})),i.isStraightening&&(i.notify("draw",{prop:"resetStraightenDestPoints"}),i.notify("draw",{prop:"setDestForStraighten"}));var n={action:"zoom-in",actionEventArgs:i.editCompleteArgs};i.triggerEditCompleteEvent(n),w.isDevice&&o.focus()}}},d.prototype.zoomOutBtnClickHandler=function(e){if(e){var i=this.parent;if((i.zoomSettings.zoomTrigger&U.Toolbar)===U.Toolbar){i.noPushUndo=!1,i.currObjType.isFiltered&&i.okBtn();var t=i.drawingShape;if(i.drawingShape){var r=i.activeObj.currIndex;i.noPushUndo=!0,i.okBtn(),i.noPushUndo=!1,i.drawingShape=null,r&&i.selectShape(r)}if(this.refreshShapeDrawing(),w.isDevice&&e.type==="touchstart"){if(!e.returnValue)return;e.preventDefault()}var o=document.querySelector("#"+i.element.id+"_zoomOut");I.trigger(o,"click");var a={bool:!1};i.notify("selection",{prop:"getFreehandDrawEditing",onPropertyChange:!1,value:{obj:a}}),a.bool&&(i.notify("freehand-draw",{prop:"applyFhd",onPropertyChange:!1}),this.destroyQuickAccessToolbar()),i.isZoomBtnClick=!0,this.applyPreviewFilter(),i.currObjType.isFiltered=!1,i.currObjType.isRedact=!1,i.togglePen&&(i.currObjType.isZoomed=!0,i.freeHandDraw(!1),i.notify("undo-redo",{prop:"updateCurrUrc",value:{type:"ok"}})),i.notify("draw",{prop:"resetCurrentSelectionPoint"}),i.drawingShape=t,i.notify("transform",{prop:"zoomAction",onPropertyChange:!1,value:{zoomFactor:-.1,zoomPoint:null,isResize:null}}),i.notify("draw",{prop:"redrawDownScale"}),(i.isCropTab||i.activeObj.shape)&&(i.notify("draw",{prop:"setStraightenActObj",value:{activeObj:null}}),i.notify("freehand-draw",{prop:"resetStraightenPoint"})),i.isStraightening&&(i.notify("draw",{prop:"resetStraightenDestPoints"}),i.notify("draw",{prop:"setDestForStraighten"}));var n={action:"zoom-out",actionEventArgs:i.editCompleteArgs};i.triggerEditCompleteEvent(n),w.isDevice&&o.focus()}}},d.prototype.zoomInBtnMouseDownHandler=function(e){e.preventDefault(),this.zoomBtnHold=setInterval(this.zoomInBtnClickHandler.bind(this),250)},d.prototype.zoomOutBtnMouseDownHandler=function(e){e.preventDefault(),this.zoomBtnHold=setInterval(this.zoomOutBtnClickHandler.bind(this),250)},d.prototype.zoomBtnMouseUpHandler=function(){clearInterval(this.zoomBtnHold),this.zoomBtnHold=0},d.prototype.closeContextualToolbar=function(){var e=this.parent,i=e.element.id,t=!1,r={bool:e.isStraightening};return(!w.isDevice||w.isDevice&&!r.bool)&&(e.element.querySelector("#"+i+"_contextualToolbar")&&!e.element.querySelector("#"+i+"_contextualToolbar").parentElement.classList.contains("e-hide")||e.element.querySelector("#"+i+"_headWrapper")&&!e.element.querySelector("#"+i+"_headWrapper").parentElement.classList.contains("e-hide"))&&(e.element.querySelector(".e-contextual-toolbar-wrapper").classList.add("e-hide"),e.okBtn(),this.refreshMainToolbar(),t=!0),t},d.prototype.destroyQuickAccessToolbar=function(){var e=this.parent,i=e.element.id,t=document.getElementById(i+"_quickAccessToolbar");t&&t.classList.contains("e-control")&&F(t,"toolbar").destroy();var r=document.getElementById(i+"_quickAccessToolbarArea");r&&(r.style.display="none")},d.prototype.renderSlider=function(e,i){var t=this.parent,r=t.element.id,o=document.querySelector("#"+r+"_contextualToolbarArea"),a=document.querySelector("#"+r+"_headWrapper"),n=document.querySelector("#"+r+"_labelWrapper");a&&(a.remove(),n.remove()),a=o.appendChild(t.createElement("div",{id:r+"_headWrapper",styles:"position: relative"})),e==="transparency"?n=a.appendChild(t.createElement("label",{id:r+"_labelWrapper",className:"e-ie-finetune-slider-label",styles:w.isDevice?"position: absolute; top: 31%; left: calc(50% - 150px); font-size: 15px; text-transform: capitalize; font-weight: 400;":"position: absolute; top: 31%; left: calc(50% - 220px); font-size: 15px; text-transform: capitalize; font-weight: 400;"})):n=a.appendChild(t.createElement("label",{id:r+"_labelWrapper",className:"e-ie-finetune-slider-label",styles:w.isDevice?"position: absolute; top: 31%; left: calc(50% - 160px); font-size: 15px; text-transform: capitalize; font-weight: 400;":"position: absolute; top: 25%; left: calc(50% - 226px); font-size: 15px; text-transform: capitalize; font-weight: 400;"})),n.textContent=this.l10n.getConstant(t.toPascalCase(e==="transparency"?"opacity":e));var s=a.appendChild(t.createElement("div",{id:r+"_sliderWrapper",className:"e-ie-finetune-slider-wrap",styles:"position: absolute"})),l=t.getCurrAdjustmentValue(e);i&&e==="straighten"&&w.isDevice&&(l=t.cropObj.straighten);var p,h,u;if(e==="brightness"||e==="contrast"||e==="saturation"||e==="exposure"?(t.finetuneSettings?e==="brightness"&&t.finetuneSettings.brightness?(p=t.finetuneSettings.brightness.min,h=t.finetuneSettings.brightness.max):e==="contrast"&&t.finetuneSettings.contrast?(p=t.finetuneSettings.contrast.min,h=t.finetuneSettings.contrast.max):e==="saturation"&&t.finetuneSettings.saturation?(p=t.finetuneSettings.saturation.min,h=t.finetuneSettings.saturation.max):e==="exposure"&&t.finetuneSettings.exposure?(p=t.finetuneSettings.exposure.min,h=t.finetuneSettings.exposure.max):(p=-100,h=100):(p=-100,h=100),u=this.createSlider(p,h,l,e)):e==="hue"||e==="blur"||e==="opacity"?(t.finetuneSettings?e==="hue"&&t.finetuneSettings.hue?(p=t.finetuneSettings.hue.min,h=t.finetuneSettings.hue.max):e==="blur"&&t.finetuneSettings.blur?(p=t.finetuneSettings.blur.min,h=t.finetuneSettings.blur.max):e==="opacity"&&t.finetuneSettings.opacity?(p=t.finetuneSettings.opacity.min,h=t.finetuneSettings.opacity.max):(p=0,h=100):(p=0,h=100),u=this.createSlider(p,h,l,e)):e==="transparency"?(p=0,h=100,u=this.createSlider(p,h,l,e)):e==="straighten"&&(p=-45,h=45,u=this.createSlider(p,h,l,e)),u.appendTo("#"+r+"_sliderWrapper"),s.style.left=(parseFloat(o.style.width)-parseFloat(u.width))/2+"px",e==="straighten"&&w.isDevice){var c=a.appendChild(t.createElement("label",{id:r+"_sLabelWrapper",className:"e-ie-straighten-value-span e-ie-finetune-value-span",styles:"position: absolute; top: 31%; margin-left: 20px; font-size: 15px; text-transform: capitalize; font-weight: 400;"}));c.innerHTML=t.transform.straighten.toString()+"&#176",s.parentElement.classList.add("e-straighten-slider")}e!=="straighten"&&(a.appendChild(t.createElement("label",{id:r+"_finetuneSpan",className:"e-ie-finetune-value-span",styles:w.isDevice?"position: absolute; top: 25%; margin-left: 20px; font-size: 15px; text-transform: capitalize; font-weight: 400;":"position: absolute; top: 25%; left: calc(50% + 190px); font-size: 15px; text-transform: capitalize; font-weight: 400;"})),s.parentElement.classList.add("e-finetune-slider"),e==="transparency"&&w.isDevice&&s.parentElement.classList.add("e-ie-device-transparency-slider"),this.updateFinetuneSpan(e))},d.prototype.createSlider=function(e,i,t,r){var o=this,a=this.parent,n=r==="straighten"?3:1;return new Me({value:t,type:"MinRange",min:e,max:i,step:n,width:w.isDevice?"180px":r==="straighten"?"200px":"300px",cssClass:"e-slider",change:function(s){if(a.notify("selection",{prop:"setSliderActive",onPropertyChange:!1,value:{bool:!0}}),r==="transparency"){if(a.activeObj.shape){C(a.activeObj.imageRatio)&&a.notify("shape",{prop:"updImgRatioForActObj",onPropertyChange:!1}),a.notify("shape",{prop:"pushActItemIntoObj"});var l=f({},a.cropObj,{},!0),p={currObj:{}};a.notify("filter",{prop:"getCurrentObj",onPropertyChange:!1,value:{object:p}});var h=p.currObj;h.objColl=f([],a.objColl,[],!0),h.pointColl=f([],a.pointColl,[],!0),h.afterCropActions=f([],a.afterCropActions,[],!0);var u={selPointColl:null};a.notify("freehand-draw",{prop:"getSelPointColl",onPropertyChange:!1,value:{obj:u}}),h.selPointColl=f([],u.selPointColl,[],!0),a.objColl.pop(),a.activeObj.opacity=s.value/100,o.upperContext.clearRect(0,0,a.upperCanvas.width,a.upperCanvas.height),a.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate"}}),a.objColl.push(a.activeObj),a.notify("undo-redo",{prop:"updateUndoRedoColl",onPropertyChange:!1,value:{operation:"shapeTransform",previousObj:h,previousObjColl:h.objColl,previousPointColl:h.pointColl,previousSelPointColl:h.selPointColl,previousCropObj:l,previousText:null,currentText:null,previousFilter:null,isCircleCrop:null}}),a.notify("selection",{prop:"redrawShape",value:{obj:a.objColl[a.objColl.length-1]}}),o.updateFinetuneSpan(r)}}else r==="straighten"?a.setStraighten(s.value):(a.transform.zoomFactor&&a.transform.zoomFactor<0&&(a.isFinetuning=!0),a.notify("selection",{prop:"setSliding",value:{bool:!0}}),a.setCurrAdjustmentValue(r,s.value),o.updateFinetuneSpan(r),o.enableDisableTbrBtn(),a.isFinetuning=!1)},changed:function(){r!=="transparency"&&r!=="straighten"&&(a.notify("selection",{prop:"setSliding",value:{bool:!1}}),a.notify("draw",{prop:"redrawDownScale"})),a.notify("selection",{prop:"setSliderActive",onPropertyChange:!1,value:{bool:!1}}),r==="transparency"&&setTimeout(function(){a.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1}),a.element.querySelector("#"+a.element.id+"_transparency").click()},50)}})},d.prototype.updateFinetuneSpan=function(e){var i=this.parent,t=i.element.querySelector(".e-ie-finetune-value-span");if(t){var r={adjustmentLevel:null};i.notify("filter",{prop:"getAdjustmentLevel",onPropertyChange:!1,value:{obj:r}}),t.innerHTML=Math.round(r.adjustmentLevel[e]).toString()}},d.prototype.applyPreviewFilter=function(){var e=this.parent;(document.querySelector("#"+e.element.id+"_sliderWrapper")||e.currObjType.isFiltered)&&(e.initialAdjustmentValue=this.lowerContext.filter,e.canvasFilter=this.lowerContext.filter,e.currObjType.isFiltered=!1)},d.prototype.unselectBtn=function(){for(var e=this.parent,i=e.element.id,t=["#"+i+"_brightness","#"+i+"_contrast","#"+i+"_hue","#"+i+"_saturation","#"+i+"_opacity","#"+i+"_blur","#"+i+"_exposure"],r=0,o=t;r<o.length;r++){var a=o[r],n=document.querySelector(a);if(n&&n.classList.contains("e-selected-btn")){n.classList.remove("e-selected-btn");break}}},d.prototype.openSlider=function(e){this.unselectBtn(),this.parent.currObjType.isFiltered=!0,this.refreshToolbar("color",null,null,null,e),document.getElementById(this.parent.element.id+"_"+e).classList.add("e-selected-btn")},d.prototype.refreshSlider=function(){var e=this.parent.element.id,i=document.querySelector("#"+e+"_sliderWrapper"),t=document.querySelector(".e-slider"),r=document.querySelector("#"+e+"_headWrapper");r&&(r.style.display="none"),i&&t&&(t.ej2_instances[0].destroy(),i.remove())},d.prototype.unselectFrameBtn=function(){for(var e=this.parent,i=e.element.id,t=["#"+i+"_none","#"+i+"_mat","#"+i+"_line","#"+i+"_inset","#"+i+"_bevel","#"+i+"_hook"],r=0,o=t;r<o.length;r++){var a=o[r],n=document.querySelector(a);if(n.classList.contains("e-selected-btn")){n.classList.remove("e-selected-btn");break}}},d.prototype.updateToolbarItems=function(){var e=this.parent,i=e.element.id;if(e.isImageLoaded&&this.isToolbar()){var t=e.element.querySelector(".e-fill.e-template .e-dropdownbtn-preview"),r=e.element.querySelector(".e-stroke.e-template .e-dropdownbtn-preview"),o=e.element.querySelector(".e-text-font-color.e-template .e-dropdownbtn-preview"),a=e.element.querySelector(".e-stroke-text-font-color.e-template .e-dropdownbtn-preview"),n=e.element.querySelector(".e-text-background-color.e-template .e-dropdownbtn-preview"),s=e.element.querySelector(".e-pen-stroke-color.e-template .e-dropdownbtn-preview"),l=e.element.querySelector(".e-shape-stroke-width"),p=e.element.querySelector(".e-shape-rectangle-radius"),h=e.element.querySelector(".e-text-font-family"),u=e.element.querySelector(".e-text-font-size"),c=e.element.querySelector("#"+i+"_bold"),g=e.element.querySelector("#"+i+"_italic");if(e.activeObj.strokeSettings&&e.activeObj.textSettings){if(C(e.activeObj.strokeSettings.strokeWidth)&&(e.activeObj.strokeSettings.strokeWidth=2),C(e.activeObj.strokeSettings.outlineWidth)&&(e.activeObj.strokeSettings.outlineWidth=2),t){var v=e.activeObj.strokeSettings.fillColor;e.activeObj.strokeSettings.fillColor===""?t.classList.add("e-nocolor-item"):(t.classList.remove("e-nocolor-item"),t.style.background=v),document.querySelector("#"+i+"_shape_fill")&&(F(i+"_shape_fill","colorpicker").value=v)}if(r){var v=e.activeObj.strokeSettings.strokeColor;r.style.background=v,document.querySelector("#"+i+"_shape_stroke")&&(F(i+"_shape_stroke","colorpicker").value=v)}if(o){var v=e.activeObj.strokeSettings.strokeColor;o.style.background=v,document.querySelector("#"+i+"_text_font")&&(F(i+"_text_font","colorpicker").value=v)}if(a){var v=e.activeObj.strokeSettings.outlineColor;/^#([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6}|[0-9A-Fa-f]{8})$|^[a-zA-Z]+$/.test(e.activeObj.strokeSettings.outlineColor)?(a.classList.remove("e-nocolor-item"),a.style.background=v):a.classList.add("e-nocolor-item"),document.querySelector("#"+i+"_stroke_text")&&(F(i+"_stroke_text","colorpicker").value=v)}if(n){var v=e.activeObj.strokeSettings.fillColor;e.activeObj.strokeSettings.fillColor===""||e.activeObj.strokeSettings.fillColor==="transparent"?n.classList.add("e-nocolor-item"):(n.classList.remove("e-nocolor-item"),n.style.background=v),document.querySelector("#"+i+"_text_bgColor")&&(F(i+"_text_bgColor","colorpicker").value=v)}if(s){var v=e.activeObj.strokeSettings.strokeColor;s.style.background=v,document.querySelector("#"+i+"_pen_stroke")&&(F(i+"_pen_stroke","colorpicker").value=v);var b={penOpacity:1};e.notify("freehand-draw",{prop:"getPenOpacity",onPropertyChange:!1,value:{obj:b}})}if(h&&(w.isDevice?h.setAttribute("style","font-family:"+e.activeObj.textSettings.fontFamily.toLowerCase()):h.textContent=e.activeObj.textSettings.fontFamily),u){for(var m=0;m<e.fontSizeColl.length;m++)if(parseInt(e.fontSizeColl[m].text,10)>=Math.round(e.activeObj.textSettings.fontSize)){u.textContent=(m+1).toString();break}else if(Math.round(e.activeObj.textSettings.fontSize)<parseInt(e.fontSizeColl[0].text,10)){u.textContent="1";break}else if(Math.round(e.activeObj.textSettings.fontSize)>parseInt(e.fontSizeColl[e.fontSizeColl.length-1].text,10)){u.textContent=(e.fontSizeColl.length-1+1).toString();break}}if(c&&(e.activeObj.textSettings.bold?c.classList.add("e-selected-btn"):c.classList.remove("e-selected-btn")),g&&(e.activeObj.textSettings.italic?g.classList.add("e-selected-btn"):g.classList.remove("e-selected-btn")),l){var y=e.activeObj.shape==="text"?e.activeObj.strokeSettings.outlineWidth:e.activeObj.strokeSettings.strokeWidth,P=Math.round(y).toString();l.textContent=this.getStrokeWidth(P)}if(p){var S=Math.round(e.activeObj.strokeSettings.radius).toString();p.textContent=this.getRectRadius(S)}}}},d.prototype.getStrokeWidth=function(e){var i,t=parseInt(e,10)/2;switch(t){case 0:i=this.l10n.getConstant("NoOutline");break;case 1:i=this.l10n.getConstant("XSmall");break;case 2:i=this.l10n.getConstant("Small");break;case 3:i=this.l10n.getConstant("Medium");break;case 4:i=this.l10n.getConstant("Large");break;case 5:i=this.l10n.getConstant("XLarge");break}return i},d.prototype.getRectRadius=function(e){var i,t=parseInt(e,10)/2;switch(t){case 0:i=this.l10n.getConstant("0");break;case 1:i=this.l10n.getConstant("20");break;case 2:i=this.l10n.getConstant("40");break;case 3:i=this.l10n.getConstant("60");break;case 4:i=this.l10n.getConstant("80");break;case 5:i=this.l10n.getConstant("100");break}return i},d.prototype.cancelPan=function(){var e=this.parent;e.notify("shape",{prop:"applyActObj",onPropertyChange:!1,value:{isMouseDown:!0}});var i=e.element.querySelector(".e-img-pan .e-btn");i&&i.classList.remove("e-selected-btn"),e.pan(!1)},d.prototype.refreshMainToolbar=function(){this.currToolbar!=="main"&&this.refreshToolbar("main")},d.prototype.destroySubComponents=function(){for(var e=this.parent,i=e.element.querySelectorAll("input.e-control"),t=e.element.querySelectorAll("button.e-control"),r=0,o=i.length;r<o;r++)i[r].classList.contains("e-color-picker")&&(F(i[r],"color-picker").destroy(),J(Ae("input#"+i[r].id,e.element)));for(var r=0,o=t.length;r<o;r++)t[r].classList.contains("e-dropdown-btn")?(F(t[r],"dropdown-btn").destroy(),J(Ae("button#"+t[r].id,e.element))):t[r].classList.contains("e-btn")&&(F(t[r],"btn").destroy(),J(Ae("button#"+t[r].id,e.element)))},d.prototype.setInitialShapeSettings=function(e){var i=this.parent;i.notify("shape",{prop:"refreshActiveObj",onPropertyChange:!1}),i.currObjType.shape=e.item.id,i.activeObj.shape=i.currObjType.shape.toLowerCase(),i.currObjType.isDragging=i.currObjType.isCustomCrop=!1,i.activeObj.shapeDegree=i.transform.degree,i.activeObj.shapeFlip=i.transform.currFlipState,i.activeObj.textFlip=i.transform.currFlipState,i.activeObj.flipObjColl=[];var t={order:null};i.notify("shape",{prop:"getNewOrder",onPropertyChange:!1,value:{obj:t}}),i.activeObj.order=t.order},d.prototype.isToolbarString=function(e){for(var i=!1,t=0;t<e.length;t++)if(typeof e[t]=="string"){i=!0;break}return i},d.prototype.excludeItems=function(e){for(var i=[],t=0;t<e.length;t++){var r=this.getIndex(e[t]);r!==-1&&i.push(r)}for(var o=[],t=0;t<this.defToolbarItems.length;t++)this.defToolbarItems[t].align==="Center"&&!this.isSameIndex(i,t)&&this.defToolbarItems[t].id!==this.parent.element.id+"_annotation"&&o.push(t);for(var t=o.length-1;t>=0;t--)this.defToolbarItems.splice(o[t],1)},d.prototype.isSameIndex=function(e,i){for(var t=0;t<e.length;t++)if(e[t]===i)return!0;return!1},d.prototype.getIndex=function(e){var i=-1,t=!1;e==="rotateLeft"&&(e="rotLeft"),e==="rotateRight"&&(e="rotRight"),e==="horizontalFlip"&&(e="hflip"),e==="verticalFlip"&&(e="vflip"),e==="arrowStart"&&(e="start"),e==="arrowEnd"&&(e="end"),e==="fontColor"&&(e="strokeColor",t=!0);for(var r=0;r<this.defToolbarItems.length;r++){var o=this.defToolbarItems[r].id;if(o&&o.toLowerCase().indexOf(e.toLowerCase())!==-1){i=r;break}}return t&&(e="fontColor"),i},d.prototype.getModuleName=function(){return"toolbar-module"},d.prototype.redactSlider=function(e){var i=this.parent,t=i.element.id,r=i.element.querySelector("#"+t+"_toolbarArea"),o=i.element.querySelector("#"+t+"_contextualToolbarArea");if(o){o.classList.remove("e-hide"),o.style.left=r.offsetLeft+"px";var a=document.querySelector("#"+t+"_contextualToolbarArea"),n=document.querySelector("#"+t+"_headWrapper"),s=document.querySelector("#"+t+"_labelWrapper"),l=document.querySelector("#"+t+"_contextualToolbar");n&&(n.remove(),s.remove()),l&&(l.remove(),this.createContextualToolbar()),n=a.appendChild(i.createElement("div",{id:t+"_headWrapper",styles:"position: relative"})),s=n.appendChild(i.createElement("label",{id:t+"_labelWrapper",className:"e-ie-finetune-slider-label",styles:w.isDevice?"position: absolute; top: 31%; left: calc(50% - 160px); font-size: 15px; text-transform: capitalize; font-weight: 400;":"position: absolute; top: 25%; left: calc(50% - 226px); font-size: 15px; text-transform: capitalize; font-weight: 400;"}));var p=e==="blur"?this.l10n.getConstant("Blur"):this.l10n.getConstant("PixelSize");s.textContent=p;var h=n.appendChild(i.createElement("div",{id:t+"_sliderWrapper",className:"e-ie-finetune-slider-wrap",styles:"position: absolute"}));n.appendChild(i.createElement("label",{id:t+"_redactSpan",className:"e-ie-redact-value-span",styles:w.isDevice?"position: absolute; top: 30%; margin-left: 20px; font-size: 15px; text-transform: capitalize; font-weight: 400;":"position: absolute; top: 30%; left: calc(50% + 190px); font-size: 15px; text-transform: capitalize; font-weight: 400;"})),h.parentElement.classList.add("e-finetune-slider");var u=i.activeObj.redactType==="blur"?i.activeObj.redactBlur:i.activeObj.redactPixelate,c=new Me({tooltip:{placement:"Before",isVisible:!0,showOn:"Focus"},min:10,max:100,step:1,value:u,type:"MinRange",width:w.isDevice?"130px":"300px",created:function(){i.element.querySelector(".e-ie-redact-value-span").innerText=u.toString()},change:function(m){i.element.querySelector(".e-ie-redact-value-span").innerText=m.value.toString(),i.activeObj.redactType==="blur"?i.activeObj.redactBlur=i.tempRedactBlur=m.value:i.activeObj.redactType==="pixelate"&&(i.activeObj.redactPixelate=i.tempRedactPixel=m.value),i.notify("draw",{prop:"drawObject",onPropertyChange:!1,value:{canvas:"duplicate",obj:i.activeObj,isCropRatio:null,points:null,isPreventDrag:!0,saveContext:null,isPreventSelection:!0}})},changed:function(){setTimeout(function(){i.notify("undo-redo",{prop:"updateUndoRedoStack",onPropertyChange:!1})},50)}});if(c.appendTo("#"+t+"_sliderWrapper"),w.isDevice){var g=o.offsetHeight+1,v=i.element.querySelector("#"+t+"_customizeWrapper");this.isFrameToolbar&&v&&(g=v.offsetHeight+2);var b=i.element.querySelector("#"+t+"_canvasWrapper").offsetHeight;o.style.top=this.toolbarHeight+1+b-g+"px"}}},d}(),Ot=["isLazyUpdate","plugins","allowUndoRedo","cssClass","disabled","enablePersistence","enableRtl","finetuneSettings","fontFamily","height","isReadOnly","locale","quickAccessToolbarTemplate","selectionSettings","showQuickAccessToolbar","theme","toolbar","toolbarTemplate","uploadSettings","width","zoomSettings","beforeSave","click","created","cropping","destroyed","editComplete","fileOpened","finetuneValueChanging","flipping","frameChange","imageFiltering","panning","quickAccessToolbarItemClick","quickAccessToolbarOpen","resizing","rotating","saved","selectionChanging","shapeChange","shapeChanging","toolbarCreated","toolbarItemClicked","toolbarUpdating","zooming"],Tt=[],kt=Yt({props:Ot}),Si=kt[0],Ft=kt[1],Qe=Object.keys(Ft);Qe.push("modelchanged","update:modelValue");for(var _e=0,yt=Tt;_e<yt.length;_e++){var wi=yt[_e];Qe.push("update:"+wi)}var xi=Et({name:"ImageEditorComponent",mixins:[Mt],props:Si,watch:Ft,emits:Qe,provide:function(){return{custom:this.custom}},data:function(){return{ej2Instances:new yi({}),propKeys:Ot,models:Tt,hasChildDirective:!1,hasInjectedModules:!1,tagMapper:{},tagNameMapper:{},isVue3:!De,templateCollection:{}}},created:function(){this.bindProperties(),this.ej2Instances._setProperties=this.ej2Instances.setProperties,this.ej2Instances.setProperties=this.setProperties,this.ej2Instances.clearTemplate=this.clearTemplate,this.updated=this.updated},render:function(d){var e=De?d:Dt,i=null;return C(this.$slots.default)||(i=De?this.$slots.default:this.$slots.default()),e("div",i)},methods:{clearTemplate:function(d){if(d||(d=Object.keys(this.templateCollection||{})),d.length&&this.templateCollection)for(var e=0,i=d;e<i.length;e++){var t=i[e],r=this.templateCollection[t];if(r&&r.length){for(var o=0,a=r;o<a.length;o++){var n=a[o];this.destroyPortals(n)}delete this.templateCollection[t]}}},setProperties:function(d,e){var i=this;this.isVue3&&(this.models=this.models?this.models:this.ej2Instances.referModels),this.ej2Instances&&this.ej2Instances._setProperties&&this.ej2Instances._setProperties(d,e),d&&this.models&&this.models.length&&Object.keys(d).map(function(t){i.models.map(function(r){t===r&&!/datasource/i.test(t)&&(i.isVue3?i.ej2Instances.vueInstance.$emit("update:"+t,d[t]):(i.$emit("update:"+t,d[t]),i.$emit("modelchanged",d[t])))})})},custom:function(){this.updated()},apply:function(){return this.ej2Instances.apply()},applyImageFilter:function(d){return this.ej2Instances.applyImageFilter(d)},bringForward:function(d){return this.ej2Instances.bringForward(d)},bringToFront:function(d){return this.ej2Instances.bringToFront(d)},canRedo:function(){return this.ej2Instances.canRedo()},canUndo:function(){return this.ej2Instances.canUndo()},clearImage:function(){return this.ej2Instances.clearImage()},clearSelection:function(d){return this.ej2Instances.clearSelection(d)},cloneShape:function(d){return this.ej2Instances.cloneShape(d)},crop:function(){return this.ej2Instances.crop()},deleteRedact:function(d){return this.ej2Instances.deleteRedact(d)},deleteShape:function(d){return this.ej2Instances.deleteShape(d)},destroy:function(){return this.ej2Instances.destroy()},discard:function(){return this.ej2Instances.discard()},drawArrow:function(d,e,i,t,r,o,a,n,s){return this.ej2Instances.drawArrow(d,e,i,t,r,o,a,n,s)},drawEllipse:function(d,e,i,t,r,o,a,n,s){return this.ej2Instances.drawEllipse(d,e,i,t,r,o,a,n,s)},drawFrame:function(d,e,i,t,r,o,a,n,s){return this.ej2Instances.drawFrame(d,e,i,t,r,o,a,n,s)},drawImage:function(d,e,i,t,r,o,a,n,s){return this.ej2Instances.drawImage(d,e,i,t,r,o,a,n,s)},drawLine:function(d,e,i,t,r,o,a){return this.ej2Instances.drawLine(d,e,i,t,r,o,a)},drawPath:function(d,e,i,t){return this.ej2Instances.drawPath(d,e,i,t)},drawRectangle:function(d,e,i,t,r,o,a,n,s,l){return this.ej2Instances.drawRectangle(d,e,i,t,r,o,a,n,s,l)},drawRedact:function(d,e,i,t,r,o){return this.ej2Instances.drawRedact(d,e,i,t,r,o)},drawText:function(d,e,i,t,r,o,a,n,s,l,p,h,u,c){return this.ej2Instances.drawText(d,e,i,t,r,o,a,n,s,l,p,h,u,c)},enableShapeDrawing:function(d,e){return this.ej2Instances.enableShapeDrawing(d,e)},enableTextEditing:function(){return this.ej2Instances.enableTextEditing()},export:function(d,e,i){return this.ej2Instances.export(d,e,i)},finetuneImage:function(d,e){return this.ej2Instances.finetuneImage(d,e)},flip:function(d){return this.ej2Instances.flip(d)},freehandDraw:function(d){return this.ej2Instances.freehandDraw(d)},getImageData:function(d){return this.ej2Instances.getImageData(d)},getImageDimension:function(){return this.ej2Instances.getImageDimension()},getImageFilter:function(d){return this.ej2Instances.getImageFilter(d)},getRedacts:function(){return this.ej2Instances.getRedacts()},getShapeSetting:function(d){return this.ej2Instances.getShapeSetting(d)},getShapeSettings:function(){return this.ej2Instances.getShapeSettings()},initialize:function(){return this.ej2Instances.initialize()},open:function(d,e,i){return this.ej2Instances.open(d,e,i)},pan:function(d,e,i){return this.ej2Instances.pan(d,e,i)},redo:function(){return this.ej2Instances.redo()},reset:function(){return this.ej2Instances.reset()},resize:function(d,e,i){return this.ej2Instances.resize(d,e,i)},rotate:function(d){return this.ej2Instances.rotate(d)},select:function(d,e,i,t,r){return this.ej2Instances.select(d,e,i,t,r)},selectRedact:function(d){return this.ej2Instances.selectRedact(d)},selectShape:function(d){return this.ej2Instances.selectShape(d)},sendBackward:function(d){return this.ej2Instances.sendBackward(d)},sendToBack:function(d){return this.ej2Instances.sendToBack(d)},straightenImage:function(d){return this.ej2Instances.straightenImage(d)},triggerEditCompleteEvent:function(d){return this.ej2Instances.triggerEditCompleteEvent(d)},undo:function(){return this.ej2Instances.undo()},update:function(){return this.ej2Instances.update()},updateRedact:function(d,e){return this.ej2Instances.updateRedact(d,e)},updateShape:function(d,e){return this.ej2Instances.updateShape(d,e)},zoom:function(d,e){return this.ej2Instances.zoom(d,e)}}});const ji={__name:"Teste",setup(d){const e=Ut();return Bt(`${e.public.docEditor}`),(i,t)=>(jt(),Ht("div",null,[Wt(qt(xi),{id:"image-editor",height:"350px",width:"550px"})]))}},Oi={};function Ti(d,e){const i=ji;return jt(),_t(i)}const Ii=Zt(Oi,[["render",Ti]]);export{Ii as default};
