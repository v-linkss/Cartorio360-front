import{_ as f,o as r,c as i,a as m,F as C,D as $,q as w,t as y,r as _,p as E,E as N,G as W,H as q,I,b as S,n as k,m as x,z as H,J as M,h as O,K as B,k as J,j as P}from"./CLT_7dC4.js";const R={class:"chat-sidebar"},D=["onClick"],L={class:"chat-name"},A={class:"chat-preview"},F={__name:"ChatSidebar",props:{chats:{type:Array,required:!0},activeChatId:{type:[String,Number],required:!0}},setup(l){return(c,o)=>(r(),i("aside",R,[o[0]||(o[0]=m("h2",{class:"sidebar-header"},"Cartório 360",-1)),(r(!0),i(C,null,$(l.chats,t=>(r(),i("button",{key:t.id,class:w(["chat-item",{active:t.id===l.activeChatId}]),onClick:n=>c.$emit("select",t.id)},[m("span",L,y(t.name),1),m("span",A,y(t.preview),1)],10,D))),128))]))}},K=f(F,[["__scopeId","data-v-e3721af5"]]),U={class:"chat-history"},V=["innerHTML"],j={__name:"ChatHistory",props:{messages:Array},setup(l){const c=/(https?:\/\/[^\s]+)/g;function o(t){return t.replace(c,n=>`<a href="${n}" target="_blank" class="chat-link">${n}</a>`)}return(t,n)=>(r(),i("div",U,[(r(!0),i(C,null,$(l.messages,(p,d)=>(r(),i("div",{key:d,class:w(["chat-bubble",p.from==="user"?"from-user":"from-server"]),innerHTML:o(p.text)},null,10,V))),128))]))}},z=f(j,[["__scopeId","data-v-067b9bdc"]]),G={class:"chat-input-area"},Q={__name:"ChatInput",emits:["send"],setup(l,{emit:c}){const o=c,t=_("");function n(){t.value.trim()&&(o("send",t.value.trim()),t.value="")}return(p,d)=>(r(),i("footer",G,[E(m("input",{"onUpdate:modelValue":d[0]||(d[0]=v=>t.value=v),class:"chat-input",placeholder:"Digite sua mensagem…",onKeyup:W(n,["enter"])},null,544),[[N,t.value]]),m("button",{class:"chat-send-button",onClick:n},"📤")]))}},X=f(Q,[["__scopeId","data-v-7b918800"]]),Y={class:"chat-window"},Z={class:"chat-header"},ee={class:"chat-title"},te={__name:"ChatWindow",props:{chat:{type:Object,required:!0},userName:{type:String,required:!0},cartorioToken:{type:String,required:!0}},setup(l){const c=l,o=_([]);let t=null;const n=x();function p(){t&&t.close();const s=`${n.public.chat_bot}?user_name=Ewerton&room_id=${c.chat.room}`;console.log("Conectando no chat:",s),t=new WebSocket(s),t.addEventListener("message",d)}function d(s){try{const e=JSON.parse(s.data);e.type==="chat_message"&&e.username!=="Ewerton"&&o.value.push({from:e.username==="Ewerton",text:e.message}),e.message.state==="MenuPrincipal"&&(console.log("📜 Carregando histórico..."),o.value=[],console.log("📜 Histórico carregado:",e.history),b(e.history))}catch{}k(()=>a())}function v(s){if(!t||t.readyState!==WebSocket.OPEN)return;const e={type:"chat_message",message:s,cartorio_token:c.cartorioToken};o.value.push({from:"user",text:s}),t.send(JSON.stringify(e)),k(()=>a())}function a(){var e;const s=((e=h.value)==null?void 0:e.$el)||h.value;s&&(s.scrollTop=s.scrollHeight)}const h=_(null);q(()=>c.chat.room,p,{immediate:!0}),I(()=>t&&t.close());function b(s){console.log("📜 Processando histórico:",s),s.forEach(e=>{if(e.type==="chat_message"){console.log("📜 Processando mensagem do chat_message:",e);const u=e.username===userName.value?"user":"server";o.value.push({from:u,text:e.message})}else e.type==="bot_message"?(console.log("📜 Processando mensagem do bot_message:",e),o.value.push({from:"server",text:e.message.message||e.message})):console.warn("⚠️ Tipo de mensagem desconhecido:",e.type)}),k(()=>{h.value&&(h.value.scrollTop=h.value.scrollHeight)})}return(s,e)=>(r(),i("section",Y,[m("header",Z,[m("h3",ee,y(l.chat.name),1),m("button",{class:"chat-close",onClick:e[0]||(e[0]=u=>s.$emit("close"))},"✖")]),S(z,{ref:"history",messages:o.value,class:"history"},null,8,["messages"]),S(X,{onSend:v})]))}},se=f(te,[["__scopeId","data-v-8dfe4863"]]),oe={class:"chat-app"},ae={key:1,class:"placeholder"},ne={__name:"index",setup(l){const c=x(),o=_([]),t=_(null),n=H(()=>o.value.find(e=>e.id===t.value)),d=M().query.cartorio_token??"",v=_("");let a=null;function h(e){t.value=e}function b(){a=new WebSocket(`${c.public.chat_bot}?user_name='Ewerton'&room_id=notifications`),a.onopen=()=>{console.log("🔌 WebSocket conectado"),s()},a.onmessage=e=>{console.log("Mensagem recebida:",JSON.parse(e.data));try{const u=JSON.parse(e.data);o.value=[],u.queue.forEach(g=>{const T={id:g.id,name:g.name,room:g.room,preview:g.preview};o.value.push(T)})}catch(u){console.error("Falha ao parsear mensagem:",u)}},a.onclose=()=>{console.warn("WebSocket desconectado — reconectando em 5 s…"),setTimeout(b,5e3)},a.onerror=e=>{console.error("Erro WebSocket:",e),a.close()}}function s(){if(a&&a.readyState===WebSocket.OPEN){const e={type:"accept_request",message:"1",id:"notifications"};a.send(JSON.stringify(e)),console.log("📤 Evento enviado ao WebSocket:",e)}else console.warn("⚠️ WebSocket não está conectado. Tentando novamente em 1 segundo..."),setTimeout(s,1e3)}return O(()=>{b()}),B(()=>a==null?void 0:a.close()),(e,u)=>(r(),i("div",oe,[S(K,{chats:o.value,"active-chat-id":t.value,onSelect:h},null,8,["chats","active-chat-id"]),n.value?(r(),J(se,{key:0,chat:n.value,"user-name":v.value,"cartorio-token":P(d),onClose:u[0]||(u[0]=g=>t.value=null)},null,8,["chat","user-name","cartorio-token"])):(r(),i("div",ae," Selecione um chat à esquerda "))]))}},re=f(ne,[["__scopeId","data-v-acac16cc"]]);export{re as default};
