import{_ as g,o as i,c as d,a as u,F as w,D as x,q as T,t as $,r as _,p as E,E as I,G as H,f as W,H as M,I as O,b as S,n as y,m as q,z as B,J,h as A,k as D,j as R}from"./Ce45N4nc.js";const j={class:"chat-sidebar"},L=["onClick"],P={class:"chat-name"},z={class:"chat-preview"},F={__name:"ChatSidebar",props:{chats:{type:Array,required:!0},activeChatId:{type:[String,Number],required:!0}},setup(m){return(h,l)=>(i(),d("aside",j,[l[0]||(l[0]=u("h2",{class:"sidebar-header"},"Cartório 360",-1)),(i(!0),d(w,null,x(m.chats,t=>(i(),d("button",{key:t.id,class:T(["chat-item",{active:t.id===m.activeChatId}]),onClick:n=>h.$emit("select",t.id)},[u("span",P,$(t.name.split("_").slice(1).join("_")),1),u("span",z,$(t.preview),1)],10,L))),128))]))}},V=g(F,[["__scopeId","data-v-2cb5d4ee"]]),K={class:"chat-history"},Q=["innerHTML"],U={__name:"ChatHistory",props:{messages:Array},setup(m){const h=/(https?:\/\/[^\s]+)/g;function l(t){return t.replace(h,n=>`<a href="${n}" target="_blank" class="chat-link">${n}</a>`)}return(t,n)=>(i(),d("div",K,[(i(!0),d(w,null,x(m.messages,(c,o)=>(i(),d("div",{key:o,class:T(["chat-bubble",c.from==="user"?"from-user":"from-server"]),innerHTML:l(c.text)},null,10,Q))),128))]))}},G=g(U,[["__scopeId","data-v-b4c672b6"]]),X={class:"chat-input-area"},Y={__name:"ChatInput",emits:["send"],setup(m,{emit:h}){const l=h,t=_("");function n(){t.value.trim()&&(l("send",t.value.trim()),t.value="")}return(c,o)=>(i(),d("footer",X,[E(u("input",{"onUpdate:modelValue":o[0]||(o[0]=v=>t.value=v),class:"chat-input",placeholder:"Digite sua mensagem…",onKeyup:H(n,["enter"])},null,544),[[I,t.value]]),u("button",{class:"chat-send-button",onClick:n},"📤")]))}},Z=g(Y,[["__scopeId","data-v-7b918800"]]),ee={class:"chat-window"},te={class:"chat-header"},se={class:"chat-title"},oe={__name:"ChatWindow",props:{chat:{type:Object,required:!0},userName:{type:String,required:!0},cartorioToken:{type:String,required:!0}},emits:["close","end"],setup(m,{emit:h}){const l=W("userName"),t=m,n=h,c=_([]);let o=null;const v=q();function b(){o&&o.close();const s=`${v.public.chat_bot}?user_name=${l.value}&room_id=${t.chat.room}`;console.log("Conectando no chat:",s),o=new WebSocket(s),o.addEventListener("message",r)}function r(s){try{const e=JSON.parse(s.data);e.type==="chat_message"&&e.username!=="${userNameCookie.value}"&&c.value.push({from:e.username==="${userNameCookie.value}",text:e.message}),e.message.state==="MenuPrincipal"&&(console.log("📜 Carregando histórico..."),c.value=[],console.log("📜 Histórico carregado:",e.history),p(e.history))}catch{}y(()=>f())}function C(s){if(!o||o.readyState!==WebSocket.OPEN)return;const e={type:"chat_message",message:s,cartorio_token:t.cartorioToken,isHumanized:!0};c.value.push({from:"user",text:s}),o.send(JSON.stringify(e)),y(()=>f())}function f(){var e;const s=((e=a.value)==null?void 0:e.$el)||a.value;s&&(s.scrollTop=s.scrollHeight)}function k(){o&&o.close(4001,"EncerraAtendimento"),o=null,c.value.push({from:"server",text:"🛑 Atendimento encerrado."}),n("end")}const a=_(null);M(()=>t.chat.room,b,{immediate:!0}),O(()=>o&&o.close());function p(s){console.log("📜 Processando histórico:",s),s.forEach(e=>{if(e.type==="chat_message"){var N=e.username==="${userNameCookie.value}"?"user":e.username;c.value.push({from:N,text:e.message})}else e.type==="bot_message"?c.value.push({from:"server",text:e.message.message||e.message}):console.warn("⚠️ Tipo de mensagem desconhecido:",e.type)}),y(()=>{a.value&&(a.value.scrollTop=a.value.scrollHeight)})}return(s,e)=>(i(),d("section",ee,[u("header",te,[u("h3",se,$(m.chat.name.split("_").slice(1).join("_")),1),u("div",null,[u("button",{class:"chat-button end",onClick:k},"Encerrar"),u("button",{class:"chat-close",onClick:e[0]||(e[0]=N=>s.$emit("close"))},"✖")])]),S(G,{ref:"history",messages:c.value,class:"history"},null,8,["messages"]),S(Z,{onSend:C})]))}},ae=g(oe,[["__scopeId","data-v-49f40d4c"]]),ne={class:"chat-app"},ce={key:1,class:"placeholder"},re={__name:"index",setup(m){const h=W("userName"),l=q(),t=_([]),n=_(null);_(!1);const c=B(()=>t.value.find(a=>a.id===n.value)),v=J().query.cartorio_token??"",b=_("");let r=null;function C(a){n.value=a}function f(){r=new WebSocket(`${l.public.chat_bot}?user_name='${h.value}'&room_id=notifications`),r.onopen=()=>{console.log("🔌 WebSocket conectado"),k()},r.onmessage=a=>{console.log("Mensagem recebida:",JSON.parse(a.data));try{const p=JSON.parse(a.data);console.log("Data Queue:",p),t.value=[],p.queue.forEach(s=>{const e={id:s.id,name:s.name,room:s.room,preview:s.preview};t.value.push(e)})}catch(p){console.error("Falha ao parsear mensagem:",p)}},r.onclose=()=>{console.warn("WebSocket desconectado — reconectando em 5 s…"),setTimeout(f,5e3)},r.onerror=a=>{console.error("Erro WebSocket:",a),r.close()}}function k(){if(r&&r.readyState===WebSocket.OPEN){const a={type:"queue_list",message:"1",id:"notifications"};r.send(JSON.stringify(a)),console.log("📤 Evento enviado ao WebSocket:",a)}else console.warn("⚠️ WebSocket não está conectado. Tentando novamente em 1 segundo..."),setTimeout(k,1e3)}return A(()=>{f()}),(a,p)=>(i(),d("div",ne,[S(V,{chats:t.value,"active-chat-id":n.value,onSelect:C},null,8,["chats","active-chat-id"]),c.value?(i(),D(ae,{key:0,chat:c.value,"user-name":b.value,"cartorio-token":R(v),onClose:p[0]||(p[0]=s=>n.value=null)},null,8,["chat","user-name","cartorio-token"])):(i(),d("div",ce," Selecione um chat à esquerda "))]))}},le=g(re,[["__scopeId","data-v-d5c7efe2"]]);export{le as default};
