import{_ as g,o as i,c as d,a as l,F as w,D as x,q as T,t as $,r as _,p as E,E as I,G as H,f as W,H as M,I as O,b as S,n as y,m as q,z as B,J,h as A,K as D,k as R,j as L}from"./0ASXu1I8.js";const P={class:"chat-sidebar"},z=["onClick"],F={class:"chat-name"},K={class:"chat-preview"},U={__name:"ChatSidebar",props:{chats:{type:Array,required:!0},activeChatId:{type:[String,Number],required:!0}},setup(m){return(h,u)=>(i(),d("aside",P,[u[0]||(u[0]=l("h2",{class:"sidebar-header"},"Cartório 360",-1)),(i(!0),d(w,null,x(m.chats,t=>(i(),d("button",{key:t.id,class:T(["chat-item",{active:t.id===m.activeChatId}]),onClick:n=>h.$emit("select",t.id)},[l("span",F,$(t.name),1),l("span",K,$(t.preview),1)],10,z))),128))]))}},V=g(U,[["__scopeId","data-v-3f4741c1"]]),j={class:"chat-history"},Q=["innerHTML"],G={__name:"ChatHistory",props:{messages:Array},setup(m){const h=/(https?:\/\/[^\s]+)/g;function u(t){return t.replace(h,n=>`<a href="${n}" target="_blank" class="chat-link">${n}</a>`)}return(t,n)=>(i(),d("div",j,[(i(!0),d(w,null,x(m.messages,(c,o)=>(i(),d("div",{key:o,class:T(["chat-bubble",c.from==="user"?"from-user":"from-server"]),innerHTML:u(c.text)},null,10,Q))),128))]))}},X=g(G,[["__scopeId","data-v-bfedfc79"]]),Y={class:"chat-input-area"},Z={__name:"ChatInput",emits:["send"],setup(m,{emit:h}){const u=h,t=_("");function n(){t.value.trim()&&(u("send",t.value.trim()),t.value="")}return(c,o)=>(i(),d("footer",Y,[E(l("input",{"onUpdate:modelValue":o[0]||(o[0]=v=>t.value=v),class:"chat-input",placeholder:"Digite sua mensagem…",onKeyup:H(n,["enter"])},null,544),[[I,t.value]]),l("button",{class:"chat-send-button",onClick:n},"📤")]))}},ee=g(Z,[["__scopeId","data-v-ba83fe0b"]]),te={class:"chat-window"},se={class:"chat-header"},oe={class:"chat-title"},ae={__name:"ChatWindow",props:{chat:{type:Object,required:!0},userName:{type:String,required:!0},cartorioToken:{type:String,required:!0}},emits:["close","end"],setup(m,{emit:h}){const u=W("userName"),t=m,n=h,c=_([]);let o=null;const v=q();function b(){o&&o.close();const s=`${v.public.chat_bot}?user_name=${u.value}&room_id=${t.chat.room}`;console.log("Conectando no chat:",s),o=new WebSocket(s),o.addEventListener("message",r)}function r(s){try{const e=JSON.parse(s.data);e.type==="chat_message"&&e.username!=="${userNameCookie.value}"&&c.value.push({from:e.username==="${userNameCookie.value}",text:e.message}),e.message.state==="MenuPrincipal"&&(console.log("📜 Carregando histórico..."),c.value=[],console.log("📜 Histórico carregado:",e.history),p(e.history))}catch{}y(()=>f())}function C(s){if(!o||o.readyState!==WebSocket.OPEN)return;const e={type:"chat_message",message:s,cartorio_token:t.cartorioToken,isHumanized:!0};c.value.push({from:"user",text:s}),o.send(JSON.stringify(e)),y(()=>f())}function f(){var e;const s=((e=a.value)==null?void 0:e.$el)||a.value;s&&(s.scrollTop=s.scrollHeight)}function k(){o&&o.close(4001,"EncerraAtendimento"),o=null,c.value.push({from:"server",text:"🛑 Atendimento encerrado."}),n("end")}const a=_(null);M(()=>t.chat.room,b,{immediate:!0}),O(()=>o&&o.close());function p(s){console.log("📜 Processando histórico:",s),s.forEach(e=>{if(e.type==="chat_message"){var N=e.username==="${userNameCookie.value}"?"user":e.username;c.value.push({from:N,text:e.message})}else e.type==="bot_message"?c.value.push({from:"server",text:e.message.message||e.message}):console.warn("⚠️ Tipo de mensagem desconhecido:",e.type)}),y(()=>{a.value&&(a.value.scrollTop=a.value.scrollHeight)})}return(s,e)=>(i(),d("section",te,[l("header",se,[l("h3",oe,$(m.chat.name),1),l("div",null,[l("button",{class:"chat-button end",onClick:k},"Encerrar"),l("button",{class:"chat-close",onClick:e[0]||(e[0]=N=>s.$emit("close"))},"✖")])]),S(X,{ref:"history",messages:c.value,class:"history"},null,8,["messages"]),S(ee,{onSend:C})]))}},ne=g(ae,[["__scopeId","data-v-1802e13a"]]),ce={class:"chat-app"},re={key:1,class:"placeholder"},ie={__name:"index",setup(m){const h=W("userName"),u=q(),t=_([]),n=_(null);_(!1);const c=B(()=>t.value.find(a=>a.id===n.value)),v=J().query.cartorio_token??"",b=_("");let r=null;function C(a){n.value=a}function f(){r=new WebSocket(`${u.public.chat_bot}?user_name='${h.value}'&room_id=notifications`),r.onopen=()=>{console.log("🔌 WebSocket conectado"),k()},r.onmessage=a=>{console.log("Mensagem recebida:",JSON.parse(a.data));try{const p=JSON.parse(a.data);console.log("Data Queue:",p),t.value=[],p.queue.forEach(s=>{const e={id:s.id,name:s.name,room:s.room,preview:s.preview};t.value.push(e)})}catch(p){console.error("Falha ao parsear mensagem:",p)}},r.onclose=()=>{console.warn("WebSocket desconectado — reconectando em 5 s…"),setTimeout(f,5e3)},r.onerror=a=>{console.error("Erro WebSocket:",a),r.close()}}function k(){if(r&&r.readyState===WebSocket.OPEN){const a={type:"queue_list",message:"1",id:"notifications"};r.send(JSON.stringify(a)),console.log("📤 Evento enviado ao WebSocket:",a)}else console.warn("⚠️ WebSocket não está conectado. Tentando novamente em 1 segundo..."),setTimeout(k,1e3)}return A(()=>{f()}),D(()=>r==null?void 0:r.close()),(a,p)=>(i(),d("div",ce,[S(V,{chats:t.value,"active-chat-id":n.value,onSelect:C},null,8,["chats","active-chat-id"]),c.value?(i(),R(ne,{key:0,chat:c.value,"user-name":b.value,"cartorio-token":L(v),onClose:p[0]||(p[0]=s=>n.value=null)},null,8,["chat","user-name","cartorio-token"])):(i(),d("div",re," Selecione um chat à esquerda "))]))}},le=g(ie,[["__scopeId","data-v-eb374982"]]);export{le as default};
