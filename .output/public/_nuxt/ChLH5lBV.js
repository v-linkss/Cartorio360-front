import{_ as g,o as u,c as d,a as l,F as x,H as T,v as W,t as S,e as N,i as q,r as v,q as E,I as H,J as M,g as O,G as A,b as $,n as C,k as I,A as B,K as J,l as R,h as D}from"./CTSKgcpy.js";const L={class:"chat-sidebar"},P=["onClick"],j={class:"chat-name"},F={class:"chat-preview"},K={__name:"ChatSidebar",props:{chats:{type:Array,required:!0},activeChatId:{type:[String,Number],required:!0}},setup(m){return(h,n)=>(u(),d("aside",L,[n[0]||(n[0]=l("h2",{class:"sidebar-header"},"CartÃ³rio 360",-1)),(u(!0),d(x,null,T(m.chats,t=>(u(),d("button",{key:t.id,class:W(["chat-item",{active:t.id===m.activeChatId}]),onClick:r=>h.$emit("select",t.id)},[l("span",j,S(t.name.split("_").slice(1).join("_")),1),l("span",F,S(t.preview),1)],10,P))),128))]))}},V=g(K,[["__scopeId","data-v-5ea6e85d"]]),z={class:"chat-history"},Q=["innerHTML"],U={__name:"ChatHistory",props:{messages:Array},setup(m){const h=/(https?:\/\/[^\s]+)/g,n=N("userName");function t(r){return r.replace(h,c=>`<a href="${c}" target="_blank" class="chat-link">${c}</a>`)}return(r,c)=>(u(),d("div",z,[(u(!0),d(x,null,T(m.messages,(a,_)=>(u(),d("div",{key:_,class:W(["chat-bubble",a.from===q(n)?"from-user":"from-server"]),innerHTML:t(a.text)},null,10,Q))),128))]))}},G=g(U,[["__scopeId","data-v-21f8e4e4"]]),X={class:"chat-input-area"},Y={__name:"ChatInput",emits:["send"],setup(m,{emit:h}){const n=h,t=v("");function r(){t.value.trim()&&(n("send",t.value.trim()),t.value="")}return(c,a)=>(u(),d("footer",X,[E(l("input",{"onUpdate:modelValue":a[0]||(a[0]=_=>t.value=_),class:"chat-input",placeholder:"Digite sua mensagemâ€¦",onKeyup:M(r,["enter"])},null,544),[[H,t.value]]),l("button",{class:"chat-send-button",onClick:r},"ðŸ“¤")]))}},Z=g(Y,[["__scopeId","data-v-ba83fe0b"]]),ee={class:"chat-window"},te={class:"chat-header"},se={class:"chat-title"},ae={__name:"ChatWindow",props:{chat:{type:Object,required:!0},userName:{type:String,required:!0},cartorioToken:{type:String,required:!0}},emits:["close","end"],setup(m,{emit:h}){const n=N("userName"),t=m,r=h,c=v([]);let a=null;const _=I();function b(){a&&a.close();const s=`${_.public.chat_bot}?user_name=${n.value}&room_id=${t.chat.room}`;a=new WebSocket(s),a.addEventListener("message",i)}function i(s){try{const e=JSON.parse(s.data);e.type==="chat_message"&&e.username!==n.value&&c.value.push({from:e.username===n.value,text:e.message}),e.message.state==="MenuPrincipal"&&(c.value=[],p(e.history))}catch{}C(()=>f())}function y(s){if(!a||a.readyState!==WebSocket.OPEN)return;const e={type:"chat_message",message:s,cartorio_token:t.cartorioToken,isHumanized:!0};c.value.push({from:n.value,text:s}),a.send(JSON.stringify(e)),C(()=>f())}function f(){var e;const s=((e=o.value)==null?void 0:e.$el)||o.value;s&&(s.scrollTop=s.scrollHeight)}function k(){a&&a.close(4001,"EncerraAtendimento"),a=null,c.value.push({from:"server",text:"ðŸ›‘ Atendimento encerrado."}),r("end")}const o=v(null);O(()=>t.chat.room,b,{immediate:!0}),A(()=>a&&a.close());function p(s){console.log("ðŸ“œ Processando histÃ³rico:",s),s.forEach(e=>{if(e.type==="chat_message"){var w=e.username===n.value?n.value:e.username;c.value.push({from:w,text:e.message})}else e.type==="bot_message"?c.value.push({from:"server",text:e.message.message||e.message}):console.warn("âš ï¸ Tipo de mensagem desconhecido:",e.type)}),C(()=>{o.value&&(o.value.scrollTop=o.value.scrollHeight)})}return(s,e)=>(u(),d("section",ee,[l("header",te,[l("h3",se,S(m.chat.name.split("_").slice(1).join("_")),1),l("div",null,[l("button",{class:"chat-button end",onClick:k},"Encerrar"),l("button",{class:"chat-close",onClick:e[0]||(e[0]=w=>s.$emit("close"))},"âœ–")])]),$(G,{ref:"history",messages:c.value,class:"history"},null,8,["messages"]),$(Z,{onSend:y})]))}},oe=g(ae,[["__scopeId","data-v-9103e90b"]]),ne={class:"chat-app"},ce={key:1,class:"placeholder"},re={__name:"index",setup(m){const h=N("userName"),n=I(),t=v([]),r=v(null);v(!1);const c=B(()=>t.value.find(o=>o.id===r.value)),_=J().query.cartorio_token??"",b=v("");let i=null;function y(o){r.value=o}function f(){i=new WebSocket(`${n.public.chat_bot}?user_name='${h.value}'&room_id=notifications`),i.onopen=()=>{console.log("ðŸ”Œ WebSocket conectado"),k()},i.onmessage=o=>{console.log("Mensagem recebida:",JSON.parse(o.data));try{const p=JSON.parse(o.data);console.log("Data Queue:",p),t.value=[],p.queue.forEach(s=>{const e={id:s.id,name:s.name,room:s.room,preview:s.preview};t.value.push(e)})}catch(p){console.error("Falha ao parsear mensagem:",p)}},i.onclose=()=>{console.warn("WebSocket desconectado â€” reconectando em 5 sâ€¦"),setTimeout(f,5e3)},i.onerror=o=>{console.error("Erro WebSocket:",o),i.close()}}function k(){if(i&&i.readyState===WebSocket.OPEN){const o={type:"queue_list",message:"1",id:"notifications"};i.send(JSON.stringify(o)),console.log("ðŸ“¤ Evento enviado ao WebSocket:",o)}else console.warn("âš ï¸ WebSocket nÃ£o estÃ¡ conectado. Tentando novamente em 1 segundo..."),setTimeout(k,1e3)}return R(()=>{f()}),(o,p)=>(u(),d("div",ne,[$(V,{chats:t.value,"active-chat-id":r.value,onSelect:y},null,8,["chats","active-chat-id"]),c.value?(u(),D(oe,{key:0,chat:c.value,"user-name":b.value,"cartorio-token":q(_),onClose:p[0]||(p[0]=s=>r.value=null)},null,8,["chat","user-name","cartorio-token"])):(u(),d("div",ce," Selecione um chat Ã  esquerda "))]))}},ue=g(re,[["__scopeId","data-v-41e67ff6"]]);export{ue as default};
